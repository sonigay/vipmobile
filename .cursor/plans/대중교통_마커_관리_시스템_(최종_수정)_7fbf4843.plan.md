---
name: 대중교통 마커 관리 시스템 (최종 수정)
overview: 기존 '직영점_매장사진' 시트를 활용하여 버스터미널과 지하철역 정보를 저장합니다. 버스터미널과 지하철역 모두 이름과 주소를 입력할 수 있으며, 여러 개를 추가/수정/삭제할 수 있습니다. 고객모드, 직영점모드, 직영점관리모드에서만 작동하며, 카카오 API로 위도/경도를 변환하여 지도에 마커로 표시합니다.
todos:
  - id: update_headers
    content: HEADERS_STORE_PHOTO에 버스터미널정보/지하철역정보 컬럼 2개 추가 (AI~AJ 열, JSON 형식)
    status: completed
  - id: update_existing_apis
    content: 기존 매장사진 저장/조회 API 수정하여 새 컬럼 보존 및 처리
    status: completed
    dependencies:
      - update_headers
  - id: server_save_api
    content: 대중교통 위치 저장 API 생성 (버스터미널/지하철역 배열 처리, 카카오 API 연동, JSON 변환 포함)
    status: completed
    dependencies:
      - update_headers
  - id: server_list_api
    content: 대중교통 위치 조회 API 생성 (JSON 파싱, 캐싱 포함)
    status: completed
    dependencies:
      - update_headers
  - id: client_api_functions
    content: 프론트엔드 API 클라이언트에 저장/조회 함수 추가
    status: completed
    dependencies:
      - server_save_api
      - server_list_api
  - id: preferred_store_ui
    content: 선호매장설정 탭 편집 다이얼로그에 버스터미널/지하철역(이름+주소) 입력 필드 추가 (추가/수정/삭제 기능 포함)
    status: completed
    dependencies:
      - client_api_functions
  - id: map_mode_check
    content: Map 컴포넌트에 모드 체크 로직 추가 (isAgentMode일 때 마커 표시 안 함)
    status: completed
  - id: map_transit_markers
    content: Map 컴포넌트에 대중교통 마커 렌더링 로직 추가 (버스터미널/지하철역 구분, 이름 표시, 모드 체크 포함)
    status: completed
    dependencies:
      - client_api_functions
      - map_mode_check
  - id: map_toggle_button
    content: Map 컴포넌트에 대중교통 마커 토글 버튼 추가 (localStorage 저장, 모드 체크 포함)
    status: completed
    dependencies:
      - map_transit_markers
  - id: customer_mode_integration
    content: 고객모드 지도에 대중교통 위치 데이터 연동
    status: completed
    dependencies:
      - map_transit_markers
      - map_toggle_button
  - id: direct_store_mode_integration
    content: 직영점모드 지도에 대중교통 위치 데이터 연동
    status: completed
    dependencies:
      - map_transit_markers
      - map_toggle_button
---

#대중교통 마커 관리 시스템 구현 계획 (최종 수정)

## 개요

기존 '직영점_매장사진' 시트를 활용하여 각 매장별로 버스터미널과 지하철역 정보를 저장합니다. 버스터미널과 지하철역 모두 이름(예: "평택터미널", "무선역 1번출구")과 주소를 입력할 수 있으며, 여러 개를 추가/수정/삭제할 수 있습니다. **고객모드, 직영점모드, 직영점관리모드에서만 작동**하며, 카카오 API를 통해 위도/경도를 자동 변환하여 지도에 마커로 표시합니다.

## 작동 모드

- ✅ 고객모드 (Customer Mode): 지도에 마커 표시
- ✅ 직영점모드 (Direct Store Mode): 지도에 마커 표시
- ✅ 직영점관리모드 (Direct Store Management Mode): 지도에 마커 표시 + 편집 기능
- ❌ 일반모드 (Agent Mode): 작동하지 않음
- ❌ 관리자모드 (Management Mode): 작동하지 않음
- ❌ 기타 모드: 작동하지 않음

## 데이터 구조

### 기존 시트 활용: "직영점_매장사진"

기존 컬럼 (A~AH, 34개):

- 업체명 (A열, 인덱스 0)
- 전면사진URL ~ 직원3사진Discord스레드ID (B~AH열, 인덱스 1~32)
- 수정일시 (AH열, 인덱스 33)

### 추가 컬럼 (AI~AJ 열, 2개만 추가)

- 버스터미널정보 (AI열, 인덱스 34) - JSON 문자열 형식
- 지하철역정보 (AJ열, 인덱스 35) - JSON 문자열 형식

#### 버스터미널정보 JSON 구조

```json
[
  {
    "name": "평택터미널",
    "address": "경기도 평택시 평택동 123",
    "lat": 36.9922,
    "lng": 127.1128
  },
  {
    "name": "송탄터미널",
    "address": "경기도 평택시 송탄동 456",
    "lat": 36.9933,
    "lng": 127.1139
  }
]
```



#### 지하철역정보 JSON 구조

```json
[
  {
    "name": "무선역 1번출구",
    "address": "경기도 평택시 무선동 123",
    "lat": 36.9922,
    "lng": 127.1128
  },
  {
    "name": "무선역 2번출구",
    "address": "경기도 평택시 무선동 124",
    "lat": 36.9923,
    "lng": 127.1129
  }
]
```

**참고**: JSON 형식으로 저장하면 버스터미널과 지하철역을 각각 여러 개 유연하게 관리할 수 있습니다.

## 구현 단계

### 1. 서버 헤더 업데이트 (`server/index.js`)

#### 1.1 HEADERS_STORE_PHOTO 확장

- 기존 34개 헤더에 다음 2개 추가:
- '버스터미널정보' (인덱스 34) - JSON 문자열
- '지하철역정보' (인덱스 35) - JSON 문자열

#### 1.2 기존 API 수정

- `POST /api/direct/store-image/save`: 새 컬럼 포함하여 저장
- `GET /api/direct/store-image/get`: 새 컬럼 포함하여 조회
- `POST /api/direct/store-image/upload`: 새 컬럼 보존

### 2. 대중교통 위치 저장 API (`server/index.js`)

#### 2.1 저장 API

- `POST /api/direct/transit-location/save`
- 요청:
  ```json
      {
        "storeName": "매장명",
        "busTerminals": [
          {
            "name": "평택터미널",
            "address": "경기도 평택시 평택동 123"
          }
        ],
        "subwayStations": [
          {
            "name": "무선역 1번출구",
            "address": "경기도 평택시 무선동 123"
          }
        ]
      }
  ```




- 처리:

1. 각 버스터미널 주소 → 카카오 API로 위도/경도 변환
2. 각 지하철역 주소 → 카카오 API로 위도/경도 변환
3. 버스터미널 정보를 JSON 문자열로 변환
4. 지하철역 정보를 JSON 문자열로 변환
5. 기존 시트의 해당 매장 행 업데이트 (AI~AJ 열)

#### 2.2 조회 API

- `GET /api/direct/transit-location/list`
- '직영점_매장사진' 시트에서 AI~AJ 열 데이터 조회
- JSON 파싱하여 반환
- 캐싱 적용 (메모리 캐시, 5분 TTL)

### 3. 프론트엔드 API 클라이언트 (`src/api/directStoreApiClient.js`)

#### 3.1 API 함수 추가

- `saveTransitLocation(storeName, busTerminals, subwayStations)`
- `getTransitLocations()`

### 4. 선호매장설정 탭 수정 (`src/components/direct/DirectStorePreferredStoreTab.js`)

#### 4.1 상태 추가

- `editBusTerminals`: 버스터미널 배열 `[{ name, address, lat?, lng? }]`
- `editSubwayStations`: 지하철역 배열 `[{ name, address, lat?, lng? }]`
- `transitLocations`: 조회한 대중교통 위치 데이터
- `isLoadingTransit`: 로딩 상태
- `editingBusTerminalIndex`: 수정 중인 버스터미널 인덱스 (null이면 추가 모드)
- `editingSubwayStationIndex`: 수정 중인 지하철역 인덱스 (null이면 추가 모드)

#### 4.2 편집 다이얼로그 수정

- 버스터미널 섹션:
- 버스터미널 추가 버튼
- 각 버스터미널별로:
    - 이름 입력 필드 (예: "평택터미널") - 수정 가능
    - 주소 입력 필드 - 수정 가능
    - 위도/경도 표시 (자동 계산, 읽기 전용)
    - 수정 버튼: 해당 항목을 수정 모드로 전환
    - 저장 버튼: 수정 내용 저장 (수정 모드일 때만 표시)
    - 취소 버튼: 수정 취소 (수정 모드일 때만 표시)
    - 삭제 버튼: 해당 항목 삭제
- 지하철역 섹션:
- 지하철역 추가 버튼
- 각 지하철역별로:
    - 이름 입력 필드 (예: "무선역 1번출구") - 수정 가능
    - 주소 입력 필드 - 수정 가능
    - 위도/경도 표시 (자동 계산, 읽기 전용)
    - 수정 버튼: 해당 항목을 수정 모드로 전환
    - 저장 버튼: 수정 내용 저장 (수정 모드일 때만 표시)
    - 취소 버튼: 수정 취소 (수정 모드일 때만 표시)
    - 삭제 버튼: 해당 항목 삭제
- "위도/경도 확인" 버튼: 카카오 API 호출하여 미리보기
- 저장 시 대중교통 위치도 함께 저장

#### 4.3 데이터 로드

- 컴포넌트 마운트 시 대중교통 위치 데이터 조회
- 매장별로 해당 데이터 매핑하여 편집 다이얼로그에 표시

### 5. 지도 컴포넌트 수정 (`src/components/Map.js`)

#### 5.1 Props 추가

- `transitLocations`: 대중교통 위치 데이터 배열
- `showTransitMarkers`: 대중교통 마커 표시 여부 (기본값: true)

#### 5.2 모드 체크

- `isAgentMode`가 `true`이면 대중교통 마커를 표시하지 않음
- 고객모드, 직영점모드, 직영점관리모드에서만 마커 표시

#### 5.3 마커 렌더링

- `transitLocations` 배열을 순회하며 마커 생성:
- 버스터미널: 파란색 마커 아이콘 (이름 표시)
- 지하철역: 빨간색 마커 아이콘 (이름 표시)
- 마커 클릭 시:
- 버스터미널: 이름과 주소 표시
- 지하철역: 이름과 주소 표시

#### 5.4 토글 버튼 추가

- 지도 우측 상단에 "대중교통 위치" 토글 버튼 추가
- 토글 상태는 localStorage에 저장하여 사용자 선호도 유지
- `isAgentMode`가 `true`이면 토글 버튼을 표시하지 않음

### 6. 고객모드/직영점모드 지도 연동

#### 6.1 CustomerPreferredStoreTab 수정

- 대중교통 위치 데이터 조회
- Map 컴포넌트에 `transitLocations` prop 전달
- `isCustomerMode={true}` prop 확인

#### 6.2 DirectStorePreferredStoreTab 수정 (직영점모드)

- 대중교통 위치 데이터 조회
- Map 컴포넌트에 `transitLocations` prop 전달
- `isAgentMode={false}` 확인

## 데이터 흐름

```javascript
사용자 입력 (선호매장설정 탭 - 직영점관리모드만)
  ↓
버스터미널(이름+주소) + 지하철역(이름+주소) 추가/수정/삭제
  ↓
저장 버튼 클릭
  ↓
서버 API 호출 (/api/direct/transit-location/save)
  ↓
카카오 API로 각 주소 → 위도/경도 변환
  ↓
기존 '직영점_매장사진' 시트의 해당 매장 행 업데이트 (AI~AJ 열)
  ↓
캐시 갱신
  ↓
지도에 마커 표시 (고객모드/직영점모드/직영점관리모드만)
```



## 기술 스택

- 카카오 API: 기존 `geocodeAddressWithKakao` 함수 활용
- 구글시트 API: 기존 시트에 컬럼 추가 (AI~AJ, 2개만)
- JSON 저장: 버스터미널/지하철역 정보는 각각 JSON 문자열로 저장
- 캐싱: 메모리 캐시 (5분 TTL)
- 마커 아이콘: Leaflet 기본 아이콘 또는 커스텀 아이콘

## 주의사항

1. 기존 시트 구조 유지: 기존 34개 컬럼은 그대로 유지
2. 카카오 API 호출 빈도 제한 고려 (재시도 로직 포함)
3. JSON 파싱 에러 처리: 잘못된 JSON 형식 시 빈 배열로 처리
4. 캐시 무효화: 저장 시 즉시 무효화
5. 에러 처리: 주소 변환 실패 시 사용자에게 알림
6. 토글 상태: localStorage에 저장하여 사용자 선호도 유지
7. 기존 API 호환성: 기존 매장사진 저장/조회 API는 새 컬럼을 무시하도록 처리
8. 버스터미널과 지하철역 모두 이름 필수 입력