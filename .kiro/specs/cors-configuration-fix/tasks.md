# 구현 계획: CORS 구성 수정

## 개요

이 구현 계획은 Node.js Express 서버의 CORS 구성을 정리하고 개선하여 Vercel에 호스팅된 React 프론트엔드와의 통신 문제를 해결합니다. 현재 여러 개의 중복된 CORS 구현이 존재하므로 이를 통합하고 표준화합니다.

## 현재 상태 분석

- ✅ 기본 CORS 미들웨어 존재 (`server/corsMiddleware.js`)
- ✅ 미들웨어 등록됨 (`server/index.js`)
- ✅ Jest 테스트 프레임워크 설정 완료
- ✅ fast-check 속성 기반 테스트 라이브러리 설정 완료
- ✅ 기본 단위 테스트 및 속성 테스트 구현됨
- ❌ 중복된 CORS 구현 (corsMiddleware + setCORSHeaders + cors 라이브러리)
- ❌ 일관성 없는 오리진 검증
- ❌ 적절한 오류 처리 및 로깅 부족

## 작업

- [x] 1. CORS 미들웨어 기본 구조 설정
  - ✅ Express.js 프로젝트에 CORS 미들웨어 파일 생성됨
  - ✅ 기본 CORS 헤더 설정 함수 구현됨
  - ✅ Express 앱에 미들웨어 등록됨
  - _요구사항: 1.1, 1.4, 1.5_

- [x] 2. 테스트 프레임워크 설정
  - [x] 2.1 Jest 테스트 환경 설정
    - ✅ 서버 프로젝트에 Jest 및 관련 의존성 추가
    - ✅ 테스트 스크립트 및 구성 파일 생성
    - ✅ 기본 테스트 구조 설정
    - _요구사항: 모든 속성 테스트를 위한 기반_

  - [x] 2.2 fast-check 속성 기반 테스트 라이브러리 설정
    - ✅ fast-check 라이브러리 추가 및 구성
    - ✅ 속성 기반 테스트 헬퍼 함수 생성
    - ✅ 테스트 실행 환경 검증
    - _요구사항: 설계 문서의 13개 속성 검증_

- [x] 3. CORS 구현 통합 및 정리
  - [x] 3.1 중복된 CORS 구현 제거 및 검증
    - `server/index.js`의 중복 CORS 설정 제거 (라인 571-593, 601-606) - 이미 제거됨, 검증 필요
    - `setCORSHeaders` 함수는 이미 `corsMiddleware.js`에서 통합 구현으로 제공됨 (하위 호환성)
    - 모든 파일에서 `setCORSHeaders` 사용이 올바르게 작동하는지 검증
    - 일관된 CORS 헤더 설정 보장
    - _요구사항: 1.1, 1.4, 1.5_
    - _참고: setCORSHeaders는 내부적으로 setBasicCORSHeaders를 호출하므로 별도 변경 불필요_

  - [x] 3.2 오리진 검증 시스템 개선
    - 허용된 오리진 목록 관리 기능 개선
    - 대소문자 무관 오리진 매칭 로직 구현
    - 오리진 검증 결과 캐싱 시스템 구현
    - _요구사항: 2.1, 2.2, 2.5, 6.3, 6.5_

  - [x] 3.3 프리플라이트 요청 처리 개선
    - OPTIONS 요청 핸들러 통합 및 개선
    - Access-Control-Max-Age 헤더 설정 (86400초) - 이미 구현됨, 검증 필요
    - 요청된 메서드 및 헤더 검증 기능 구현
    - _요구사항: 1.2, 6.1_

- [x] 4. 환경 기반 구성 관리 시스템 구현
  - [x] 4.1 구성 관리자 컴포넌트 생성
    - 환경 변수에서 CORS 설정 로드 (ALLOWED_ORIGINS, CORS_CREDENTIALS)
    - 안전한 기본값 설정 및 폴백 로직 구현
    - 구성 검증 및 오류 처리 기능 구현
    - 런타임 구성 업데이트 지원
    - _요구사항: 5.1, 5.2, 5.3, 5.4, 5.5_

- [x] 5. 로깅 및 모니터링 시스템 구현
  - [x] 5.1 CORS 로깅 시스템 구축
    - CORS 검증 실패 로깅 (오리진, 타임스탬프)
    - 디버그 모드에서 성공적인 검증 로깅
    - 누락된 CORS 헤더 감지 및 경고 로깅
    - 구조화된 로그 형식 및 로그 레벨 관리
    - _요구사항: 4.1, 4.4, 4.5_

- [x] 6. 오류 처리 및 복구 메커니즘 구현
  - [x] 6.1 포괄적인 오류 처리 시스템 구축
    - CORS 미들웨어 오류 캐치 및 로깅
    - 기본 CORS 헤더로 폴백 처리
    - 403 Forbidden 응답 처리 (허용되지 않은 오리진)
    - 400 Bad Request 응답 처리 (잘못된 프리플라이트)
    - _요구사항: 4.2, 4.3_

- [x] 7. 속성 기반 테스트 완성
  - [x] 7.1 CORS 헤더 포함 속성 테스트 작성
    - ✅ **속성 1: CORS 헤더 포함** - 구현됨
    - **검증: 요구사항 1.1, 1.4, 1.5**

  - [x] 7.2 프리플라이트 응답 완전성 속성 테스트 작성
    - ✅ **속성 2: 프리플라이트 응답 완전성** - 구현됨
    - **검증: 요구사항 1.2, 6.1**

  - [x] 7.3 자격 증명 헤더 설정 속성 테스트 작성
    - ✅ **속성 3: 자격 증명 헤더 설정** - 구현됨
    - **검증: 요구사항 1.3**

  - [x] 7.4 오리진 검증 정확성 속성 테스트 작성
    - ✅ **속성 4: 오리진 검증 정확성** - 구현됨
    - **검증: 요구사항 2.1, 2.2**

  - [x] 7.5 대소문자 무관 오리진 매칭 속성 테스트 작성
    - ✅ **속성 5: 대소문자 무관 오리진 매칭** - 부분 구현됨 (현재 동작 확인)
    - **검증: 요구사항 2.5**

  - [x] 7.6 API 경로 커버리지 속성 테스트 작성
    - ✅ **속성 6: API 경로 커버리지** - 구현됨
    - **검증: 요구사항 3.1**

  - [x] 7.7 오류 로깅 일관성 속성 테스트 작성
    - **속성 7: 오류 로깅 일관성**
    - **검증: 요구사항 4.1**

  - [x] 7.8 프리플라이트 오류 처리 속성 테스트 작성
    - **속성 8: 프리플라이트 오류 처리**
    - **검증: 요구사항 4.2**

  - [x] 7.9 미들웨어 오류 복구 속성 테스트 작성
    - **속성 9: 미들웨어 오류 복구**
    - **검증: 요구사항 4.3**

  - [x] 7.10 디버그 모드 로깅 속성 테스트 작성
    - **속성 10: 디버그 모드 로깅**
    - **검증: 요구사항 4.4**

  - [x] 7.11 누락 헤더 감지 속성 테스트 작성
    - **속성 11: 누락 헤더 감지**
    - **검증: 요구사항 4.5**

  - [x] 7.12 런타임 구성 업데이트 속성 테스트 작성
    - **속성 12: 런타임 구성 업데이트**
    - **검증: 요구사항 5.5**

  - [x] 7.13 오리진 검증 캐싱 속성 테스트 작성
    - **속성 13: 오리진 검증 캐싱**
    - **검증: 요구사항 6.3, 6.5**

- [x] 8. 단위 테스트 완성
  - [x] 8.1 기본 CORS 기능 테스트
    - ✅ 기본 CORS 헤더 설정 테스트 구현됨
    - ✅ OPTIONS 프리플라이트 요청 처리 테스트 구현됨
    - ✅ 구성 함수 테스트 구현됨

  - [x] 8.2 특정 도메인 구성 테스트 작성
    - 프로덕션 도메인 (https://vipmobile.vercel.app) 포함 확인
    - 개발 모드에서 localhost 오리진 포함 확인
    - _요구사항: 2.3, 2.4_

  - [x] 8.3 특정 엔드포인트 CORS 테스트 작성
    - /api/direct/store-image/upload 엔드포인트 테스트
    - /api/direct/mobiles-master 엔드포인트 테스트
    - /api/direct/policy-settings 엔드포인트 테스트
    - /api/direct/store-main-page-texts 엔드포인트 테스트
    - /api/direct/transit-location/all 엔드포인트 테스트
    - /api/direct/transit-location/list 엔드포인트 테스트
    - _요구사항: 3.2, 3.3, 3.4, 3.5, 3.6, 3.7_

- [x] 9. 성능 최적화 및 캐싱 구현
  - [x] 9.1 CORS 성능 최적화
    - 오리진 검증 결과 캐싱 시스템 구현
    - CORS 헤더 객체 재사용을 통한 메모리 최적화
    - 프리플라이트 응답 시간 최적화
    - 캐시 무효화 및 TTL 관리
    - _요구사항: 6.1, 6.3, 6.4, 6.5_

- [x] 10. 체크포인트 - 통합 테스트 및 검증
  - 모든 테스트가 통과하는지 확인하고, 질문이 있으면 사용자에게 문의하세요.

- [~] 11. 프로덕션 배포 준비
  - [x] 11.1 프로덕션 구성 설정
    - 프로덕션 환경 변수 설정 가이드 작성
    - 보안 검토 및 최종 구성 검증
    - 성능 모니터링 설정
    - 배포 전 체크리스트 작성
    - _요구사항: 2.3, 5.1, 5.2, 5.3_

## 참고사항

- 각 작업은 추적 가능성을 위해 특정 요구사항을 참조합니다
- 체크포인트는 점진적 검증을 보장합니다
- 속성 테스트는 범용 정확성 속성을 검증합니다 (fast-check 사용)
- 단위 테스트는 특정 예제와 엣지 케이스를 검증합니다 (Jest 사용)
- 현재 구현된 기능을 기반으로 개선 및 통합에 중점을 둡니다
- 기본 테스트 프레임워크와 6개의 속성 테스트가 이미 구현되어 있습니다