# OB 관리모드 구현 플랜 (정리본)

> 이 문서는 OB 관리모드 고도화를 위해 진행 상황을 기록하는 용도입니다.  
> 대화가 끊어진 뒤에도 이 문서를 이어서 업데이트하면서 작업을 계속 진행하세요.  
> 구현, 테스트, 회의 기록, 이슈 메모 등을 모두 여기에 정리합니다.

---

## 0. 빠른 안내
- 파일 위치: `OB_관리모드_구현_플랜_초안.md`
- 담당자: (작성 시점 기준) @assistant → 추후 실제 담당자 이름을 기입하세요.
- 최근 업데이트: 2025-11-12 (재약정 오퍼금액 계산 로직 변경, 영업팀/코드 통계 추가)
- 관련 모드: OB 관리모드
- 신규 탭: `투게더계산기`(현재 화면), `OB 정산 확인`, `OB 정산 관리`
- 진행 현황: **1차 핵심 기능 구현 완료 + 후정산 시트 데이터 연동 완료**
- 다음 액션:
  1. 남은 고도화 항목(팀/코드 통계, 재약정 상세 다운로드, 인건비 상세 등) 우선순위 확정
  2. 실제 운영 데이터로 통합 테스트 진행
  3. 추가 UX 개선 및 알림/이력 기능 여부 협의

### 0.1 현재 진행 상황 요약 (2025-11-12 기준)
- ✅ `OB 정산 확인` 탭 핵심 기능 완성: 맞춤제안/재약정 계산, 인건비·비용 시트 데이터 연동, 수기 입력 CRUD, XLSX 다운로드, 요약 카드/테이블
- ✅ 월별 메타데이터/수기 입력/제외 인원/정산 진행상황을 구글 시트에 저장·복원 (링크 관리, `기타` 시리즈, `제외인원`, `정산진행상황`)
- ✅ 최종 정산 카드 워크플로우 개선: 단계별 Step UI + 카드 재배치, 진행도에 따라 강조/완화 및 안내 문구 표시, 완료 배너 상단 노출, 카드 자동 접기
- ✅ `OB 정산 관리` 탭: 월별 링크 CRUD, 제외 인원 CRUD, 대상점 관리 CRUD, 진행상황 시트 저장 연동
- ✅ 후정산 시트 데이터 연동: `시트이름(후정산)` 시트에서 인건비/비용 데이터 자동 조회 및 계산, 대상점 필터링 적용
- ✅ 재약정 필터링 로직: 제외인원 AND 대상점 조건 적용, 등록직원별 상세 내역에 대상(출고처) 컬럼 표시
- ⚙️ 남은 TODO (고도화):
  - 맞춤제안 팀/코드 통계, 상세 패널/검색 필터
  - 재약정 다운로드 옵션 확장 (3:7 분배, 제외 인원 목록 포함)
  - 인건비/비용 추가 시각화, PDF/CSV 확장
  - 알림/이력/시뮬레이션 등 고도화 아이디어 검토

---

## 1. 기능 구조 개요

| 구분 | 설명 | 접근 권한 |
|------|------|-----------|
| 탭 1 | **투게더계산기** | 권한 `O`, `S`, `M` |
| 탭 2 | **OB 정산 확인** | 권한 `S`, `M` |
| 탭 3 | **OB 정산 관리** | 권한 `M` |

※ 추가 요구사항이 확정되면 위 표를 업데이트합니다.

### 1.1 데이터 흐름 개요
- `OB 정산 관리` 탭에서 월별로 구글시트 링크와 시트명(맞춤제안/재약정/후정산)을 등록
- 필요 시 프런트에서 입력한 추가 데이터는 `기타맞춤제안`, `기타재약정`, `기타후정산` 시트에 저장
- `OB 정산 확인` 탭은 선택한 월의 시트를 조회하여 정책·지표 계산 후 UI에 노출
- 최종 합산 금액은 `(주)브이아이피플러스 : (주)와이에이 = 3 : 7` 비율로 분배하여 함께 표기

---

## 2. UI / 디자인 가이드 (초안)
- 탭 헤더: Material-UI `Tabs` 또는 `ToggleButtonGroup`, 권한 미달 탭은 비활성화 + 툴팁 처리
- 요약 카드: 2열 Grid, 아이콘+타이틀+금액, `+/-`는 색상(초록/빨강) 구분
- 상세 테이블: Sticky header, 정렬/필터/CSV 다운로드 옵션 검토
- 월별 필터: 상단 우측 배치, 최근 월 자동 선택
- 모달: Drawer/Dialog, 필수값 `*` 표기 및 검증, 제외 인원 관리 섹션 포함
- 입력 폼: 다이나믹 행 추가(인건비/비용), Validation 메시지 제공
- 상태 피드백: 로딩 스피너, 빈 상태 안내, 에러 시 재시도 버튼
- 컬러/타이포: 기존 온세일/퀵서비스 관리 모드와 톤 앤 매너 일치

---

## 3. 상세 요구사항

### 3.1 투게더계산기 (현재 화면)
- [ ] 현재 화면 유지 (필요 변경 사항 발생 시 사용자와 협의 후 기록)
- [ ] 탭 구조 변경 시 영향 범위 확인 예정

### 3.2 OB 정산 확인
- [x] 하위 탭 구조: `맞춤제안`, `재약정`, `인건비`, `비용`
- [x] 월별 필터(최근 월 기본) + 요약 카드 섹션 구현 (상세 테이블/그래프는 향후 보강)
- [x] 맞춤제안/재약정 결과를 XLSX로 다운로드할 수 있는 버튼 제공 (CSV 제거)
- [x] 최종 정산 섹션을 맨 상단에 배치
- [x] 항목별 파스텔톤 배경색 적용 (맞춤제안: 연한 파랑, 재약정: 연한 주황, 인건비/비용: 연한 초록, 최종정산: 연한 보라)
- [x] 각 금액 카드에 건수 표기 추가
- [x] 맞춤제안/재약정 합계금액 표기 추가
- [x] 인건비/비용 합계금액 표기 추가 (시트 데이터 + 수기 입력 합산)
- [x] 연월 선택 필드 개선 (FormControl + InputLabel 사용, 넓이 확보)
- [x] 맞춤제안 보조설명: 본사 raw 데이터 (39인덱스) 유치자명 목록 및 건수 카운팅 표시
- [x] 재약정 보조설명: 폰클 홈데이터 (91인덱스) 등록직원 목록 및 건수 카운팅 표시
- [x] 맞춤제안/재약정 각각 유치자별/등록직원별 상세 금액 테이블 추가 (재약정은 등록직원+대상 조합으로 표시)
- [x] 맞춤제안 유치자별 상세 내역에 영업팀/코드 컬럼 추가 (30인덱스/31인덱스)
- [x] `기타후정산` 시트 연동 수기 입력 CRUD(API) 구현: 월별 항목 저장/조회/수정/삭제, 음수 처리, 합계 반영
- [x] 맞춤제안 유치자별 테이블: 건수, 정책① 기본 금액(11인덱스 기준), 정책② 테마 업셀 금액, 매출 합계(①+②) 표기
- [ ] 다운로드 파일에 3:7 분배 결과 및 제외 인원 목록 포함 여부 옵션 제공
- [ ] 그래프/차트는 주요 수치보다 하단에 배치(참고용), 필요 시 토글로 숨김 처리

#### 3.2.1 맞춤제안
- [x] 월별 필터로 선택한 데이터를 기준으로 아래 항목 자동 계산/표시
- [x] 정책별 요약 카드 및 설명 제공
- [x] 정책별 지급 조건/금액 표 구성
- [x] 단위 표기(만원/원) 명확화
- [x] 데이터 출처: 정산관리 탭에서 등록한 맞춤제안 시트 링크
- [x] 기본 데이터: `시트이름(맞춤제안)` 시트에서 조회
- [x] 추가 데이터: `기타맞춤제안` 시트에 입력/저장 후 함께 집계
- [x] 시트 구조/컬럼 정의 및 검증 로직 처리
- [ ] 월별 목록 테이블에서 특정 월 선택 시 정책①~③, 건수 구간별 지급 금액을 묶음으로 보여주는 상세 패널/카드 제공
- [x] 선택 월 변경 시 모든 계산 결과 즉시 갱신
- [x] 금액 컬럼은 쉼표가 포함될 수 있으므로 파싱 후 숫자형으로 변환
- [ ] 인건비 탭에서 등록된 직원 목록과 연동하여 동일 인원만 필터링해 표시
- [x] 아래 `제외 대상` 목록에 포함된 유치자는 계산 대상에서 제외 (시트 컬럼 38: 유치자마당ID, 39: 유치자명 기준)
- [x] 시트 컬럼 30(영업팀), 31(코드) 값을 유치자별 상세 내역 테이블에 표시 (영업팀/코드 컬럼 추가)

**제외 대상 (유치자마당ID / 유치자명)**
- a306891291 / 정다운
- a306891341 / 김보라
- rlatjddk901 / 김성아
- chldmswls520 / 최은진
- a315835213 / 주혜지
- a315835905 / 남혜원
- rlgpwls611 / 기혜진
- a306891917 / 김태희
- a306891345 / 주선영
- wkdalgus521 / 장미현

- **정책①_기본**  
- 설명: 업셀 금액 2배 지급  
- [x] `시트이름(맞춤제안)`의 11번 컬럼(`당월 맞춤제안 매출`) 데이터를 합산 후 2배하여 지급 금액 산출
- [x] 시트 헤더는 1~2행, 실제 데이터는 3행부터 시작하므로 합산 시 범위 주의
- [x] 계산 결과를 월별로 요약 카드/표에 표시
- [x] 산출식 및 데이터 범위 정의

**정책②_월별 테마 업셀**  
- 설명:  
  - 5G 슬림+ → 5G 라이트+ 이상 업셀 시 11,000원  
  - 5G 미니 → 5G 슬림+ 이상 업셀 시 11,000원  
- [x] 맞춤제안 시트에서 업셀 건수/금액 데이터를 읽어 조건에 맞는 합계 계산
- [ ] 요금제 매핑 기준/기간별 변경 여부 확인
- [x] 계산 결과를 월별로 요약 카드/표에 표시
- [ ] 산출 과정 로깅 또는 툴팁 제공
- [x] `시트이름(맞춤제안)`의 23번 컬럼(`테마 업셀`)이 "1"인 행만 필터링한 뒤 11번 컬럼(`당월 맞춤제안 매출`) 합산
- [x] 필터 조건 적용 시 헤더(1~2행)를 제외하고 3행부터 데이터 범위를 사용

**정책③_인건비 지원** *(단위: 만원)*  
- [x] 맞춤제안 시트의 매출 금액 데이터를 집계하여 대응되는 지급 금액 산출
- [x] 단위(만원) 변환 및 표 형태로 표시
- [x] 임계값 구간 정의 및 검증
- [x] 맞춤제안 시트의 건수 데이터를 기반으로 구간별 건당 금액 계산
- [x] VAT 포함 금액 및 구간 조건(이상/초과 등) 명확화
- [x] 결과를 표 형태로 출력하고 툴팁/설명 제공
- [x] `시트이름(맞춤제안)` 11번 컬럼(`당월 맞춤제안 매출`) 합계가 해당 매출 구간 이상인 경우 표에 기재된 지급 금액을 반환
- [x] 매출 구간은 내림차순으로 비교하여 최초로 조건을 만족하는 지급 금액을 선택
- [x] 결과 금액은 만원 단위로 표기(예: 700 → 700만원)

| 매출 금액 | 지급 금액 |
|-----------|-----------|
| 500 | 700 |
| 400 | 600 |
| 300 | 500 |
| 250 | 400 |
| 200 | 325 |
| 150 | 250 |
| 100 | 175 |

- [ ] 금액 단위(만원) 표시 및 툴팁 제공

**건수 구간별 지급 금액** *(VAT 포함, 단위: 원)*

| 건수 구간 | 건당 금액(원) |
|-----------|---------------|
| 500건 이상 | 23,100 |
| 400건 이상 | 19,800 |
| 300건 이상 | 16,500 |
| 200건 이상 | 13,200 |
| 100건 이상 | 9,900 |

- [x] 구간 정의(이상/초과 등) 명확화
- [x] 표/차트 표현 방식(요약 카드) 결정
- [x] `시트이름(맞춤제안)` 10번 컬럼(`맞춤제안인정여부`)이 "1" 또는 숫자형(예: 1.0)인 행 수를 계산 (헤더 제외, 제외 대상 필터 적용 후)
- [x] 계산된 건수에 해당 구간의 건당 금액을 곱하여 총 지급 금액 산출
- [x] 구간 판정은 상위 구간부터 비교하여 조건을 충족하는 첫 번째 금액을 사용
- [x] 결과 금액은 VAT 포함 금액으로 표기하고, 산출 내역 툴팁 제공 고려

### 3.2.2 재약정
- [x] 월별 데이터는 `시트이름(재약정)` 시트에서 조회
- [x] 추가/수기 입력 데이터는 `기타재약정` 시트에 저장 후 함께 집계
- [x] 월별 필터 선택 시 재약정 지표/금액 자동 계산
- [x] 계산 결과를 요약 카드/표 형태로 표시
- [x] 시트 구조/컬럼 검증 및 누락 데이터 처리 로직 필요
- [x] `시트이름(재약정)`에서 고객별 **수수료**와 **오퍼 금액(마이너스)** 컬럼을 구분 추출
- [x] 수수료 합계와 오퍼 금액 합계를 별도 표시 후, 순 재약정 금액(수수료 + 오퍼)을 산출
- [x] 마이너스 금액 표기 및 시각적 강조 (예: 빨간색, 괄호 등)
- [ ] 고객별 상세 내역 리스트/툴팁 제공 여부 검토
- [x] 수수료 산출 로직:
  - [x] 10번 컬럼(`출고처`)에 "OB" 문자열이 포함되고
  - [x] 11번 컬럼(`상태`)이 "완료"인 행만 필터링
  - [x] 해당 행의 20번 컬럼(`정산금액`)을 합산하여 수수료 금액으로 표시
  - [x] 시트에 -로 저장된 값을 *-1하여 +로 변환
- [x] 오퍼 금액 산출 로직:
  - [x] `출고처`에 "OB" 포함 & `상태`가 "완료"인 행을 기준으로
  - [x] 19번 컬럼(`오퍼금액`)에서 직접 금액 추출 (기존 비고 필드 추출 방식에서 변경)
  - [x] 추출된 금액에 *-1을 적용하여 마이너스로 표시
  - [x] 상품권/입금 구분 없이 전체 오퍼금액으로 통합 처리
- [x] 제외 인원 필터 시 유치자명 비교는 공백 제거 후 소문자로 정규화하여 일치 여부 판정 (예: "이은영 대리" vs "이은영대리")
- [x] 재약정 제외 필터는 유치자ID/등록직원(90/91 인덱스) 양쪽 값을 모두 비교하여 컬럼 위치 변동에도 대응
- [x] `정산관리` 탭에 재약정용 제외 인원 관리 UI 제공 (맞춤제안 제외 인원과 별도로 유지)
- [x] 재약정 제외 목록은 별도 저장소(예: `기타재약정` 내 서브 시트 또는 신규 시트)에 기록
- [x] 제외 대상은 `시트이름(재약정)` 91번 컬럼(`유치자마당ID`)과 비교하여 필터링
  - [x] **대상점 관리 기능 추가 (2025-11-11)**:
    - [x] `OB 정산 관리` 탭에 "대상점" 탭 추가 (제외인원 탭과 함께 표시)
    - [x] 대상점 CRUD UI 구현 (연월/구분(재약정/후정산)/대상점명/사유/비고 입력)
    - [x] 대상점 시트(`대상점`) 자동 생성 및 헤더 구조 설정 (1행 빈 행, 2행 헤더)
    - [x] 재약정 필터링 로직 수정: AND 조건 적용
      - 제외인원(91인덱스 등록직원)에 없고
      - 출고처(10인덱스)에 대상점 문자열이 포함된 경우만 포함
    - [x] 후정산 필터링 로직 적용: 대상(10인덱스)에 후정산 대상점이 포함된 경우만 포함
    - [x] 등록직원별 상세 내역에 대상(출고처) 컬럼 추가: 실제 출고처(10인덱스) 값 표시
    - [x] 대상점 시트 헤더 컬럼 (2행): `연월 | 구분(재약정/후정산) | 대상점명 | 사유 | ID | 비고 | 등록자 | 등록일시`

**재약정 제외 대상 (`유치자마당ID`)**
- VIP│김보라
- VIP│정다운
- VIP│김태희
- VIP│남예원
- VIP│주혜지
- 이은영 대리
- VIP│신유나
- MIN│최은진
- MIN│장미현
- MIN│기혜진
- MIN│김성아

### 3.2.3 인건비
- [x] 월별 데이터는 `시트이름(후정산)` 시트에서 조회 및 자동 계산
- [x] 시트 데이터 필터링: 항목(7인덱스)이 "인건비"인 행만 추출, 대상(10인덱스)에 후정산 대상점이 포함된 경우만 포함
- [x] 시트 데이터 상세 내역 표시: 항목, 대상, 내용, 상세내용(줄바꿈 지원), 금액 컬럼으로 테이블 제공
- [x] 추가/수기 입력 데이터는 `기타후정산` 시트에 저장 후 함께 집계
- [x] 인건비 관련 지표(월별 합계, 시트 합계, 수기 입력 합계)를 UI에서 즉시 반영
- [x] 입력 폼(항목/금액) + `+추가` 버튼 제공, 금액은 자동으로 음수(-) 처리
- [x] 입력값 검증(빈 값/0원/비숫자) 및 월 선택 연동
- [x] 기존 수기 데이터 수정/삭제 기능 구현(인라인 편집 + 확인/취소, 삭제 버튼)
- [x] `기타후정산` 시트 저장 형식: `연월 / 유형(labor) / 항목 / 금액 / ID / 비고 / 등록일시 / 수정일시`
- [x] 합산 로직: 시트 값(*-1 적용) + 수기 입력 금액을 합산하여 월별 인건비 합계에 반영
- [x] 합계 표시 형식: `인건비 합계: ₩X (시트 ₩Y / 수기 입력 ₩Z)`
- [x] 시트에서 읽은 금액에 *-1을 적용하여 음수 처리 (수기 입력과 동일하게)
- [x] API: `GET/POST/PUT/DELETE /api/ob/manual-adjustments` (파라미터: month, type='labor', label, amount, note, id)
- [ ] 직원별 상세 금액(고정/인센티브/합계)을 확인할 수 있는 목록 또는 툴팁 제공 검토 (현재는 항목 단위)

### 3.2.4 비용
- [x] 월별 데이터는 `시트이름(후정산)` 시트에서 조회 및 자동 계산
- [x] 시트 데이터 필터링: 항목(7인덱스)이 "비용"인 행만 추출, 대상(10인덱스)에 후정산 대상점이 포함된 경우만 포함
- [x] 시트 데이터 상세 내역 표시: 항목, 대상, 내용, 상세내용(줄바꿈 지원), 금액 컬럼으로 테이블 제공
- [x] 추가/수기 입력 데이터는 `기타후정산` 시트에 저장 후 함께 집계
- [x] 비용 항목별 수기 입력 UI 제공: 항목명/금액 입력 → `+추가`
- [x] 입력된 비용은 자동으로 음수(-) 처리되어 월별 합계에 반영
- [x] 입력값 검증(빈 값/0원/비숫자) 및 월 선택 연동
- [x] 기존 수기 데이터 수정/삭제 기능 구현(인라인 편집 + 확인/취소, 삭제 버튼)
- [x] `기타후정산` 시트 저장 형식: `연월 / 유형(cost) / 항목 / 금액 / ID / 비고 / 등록일시 / 수정일시`
- [x] 합산 로직: 시트 값(*-1 적용) + 수기 입력 금액을 합산하여 월별 비용 합계에 반영
- [x] 합계 표시 형식: `비용 합계: ₩X (시트 ₩Y / 수기 입력 ₩Z)`
- [x] 시트에서 읽은 금액에 *-1을 적용하여 음수 처리 (수기 입력과 동일하게)
- [x] API: `GET/POST/PUT/DELETE /api/ob/manual-adjustments` (파라미터: month, type='cost', label, amount, note, id)
- [ ] 필요 시 차트/테이블 이중 표현 고려 (현행: 리스트 + 합계 카드)
- [ ] 음수/양수 여부, VAT 포함 여부 등 표기 규칙 정의 (현행: 모든 수기 입력은 음수 처리)

- [x] **정산확인 최종 합산 로직**
  - [x] 월별 필터로 선택한 달에 대해 `맞춤제안`, `재약정`, `인건비(시트+수기)`, `비용(시트+수기)`을 합산
  - [x] 합산 결과를 최종 정산 금액으로 표시
  - [x] 각 항목별 금액과 최종 합계를 함께 보여주는 요약 카드 구성 (시트 값/수기 입력 구분 안내)
  - [x] 인건비/비용 항목 마이너스 금액을 자동 처리 및 카드에 반영
  - [x] 데이터 출처/계산 과정에 대한 툴팁(카드 설명) 제공
  - [x] 최종 합계 금액을 3:7 비율로 분배하여 `(주)브이아이피플러스`와 `(주)와이에이` 지분 금액을 별도 표기
  - [x] 맞춤제안/재약정 원본 데이터를 XLSX로 다운로드 가능
- [x] 최종 정산 카드 워크플로우: 입력중/입력완료 체크박스, 카드 활성화 애니메이션, 세금계산서 링크 활성화 조건 정의
- [x] 세금계산서 발행/승인 체크 → `(주)브이아이피플러스`, `(주)와이에이` 계좌 입력·저장·입금·확인 단계 관리
- [x] 계좌 상태별 스테이터스 칩/알림 메시지 제공, 양사 모두 확인완료 시 축하 애니메이션 메시지 출력
- [x] 최종 정산 섹션 UI 재배치: 총 정산 카드 단독 상단, 30%/70% 카드는 하단 열 배치 및 버튼·체크박스 여백 개선
- [x] 월별 진행상황(세금계산서/브이아이피/와이에이 단계)을 `정산진행상황` 시트에 저장·복원하도록 백엔드/프론트 연동
- [x] 입금완료/확인완료 버튼을 토글 방식으로 개선(완료↔해제 전환 가능)
- [x] 최종 정산 금액 카드를 완료 시 자동 접기 + 토글 버튼 제공(완료 배너만 남도록)

### 3.3 OB 정산 관리
- [x] 월별 맞춤제안 구글시트 링크/시트명 관리 기능 구현
- [x] "월별 링크 등록" 모달 버튼 추가
- [x] 모달 입력 필드: 연월(YYYY-MM), 구글시트 링크(URL), 시트 이름(맞춤제안), 시트 이름(재약정), 시트 이름(후정산)
- [x] 입력값 검증: URL/ID 파싱, 필수값 체크
- [x] 등록된 항목을 월별 목록 테이블로 표시
- [ ] 테이블 UX 고도화: 검색·필터 UI (현행은 최신 연월 자동 정렬, 수정/삭제 지원)
- [x] 권한 `M` 사용자만 `OB 정산 관리` 탭 접근/편집 가능하도록 제어
- [x] 데이터 저장 위치(시트/DB) 및 API 연동 방식 확정 (`/api/ob/settlement-links` → `OB정산관리링크관리`)
- [x] 월별 `정산진행상황` 시트에 정산 단계(세금계산서/브이아이피/와이에이) 저장·복원 로직 구현
- [x] **제외 인원 관리 UI**: 맞춤제안/재약정 제외 인원 CRUD UI 제공 (탭으로 구분)
- [x] 제외 인원 리스트는 등록자/등록일시를 함께 저장해 추적 가능하도록 구성
- [x] 제외 인원 데이터는 월별 링크된 구글 시트(`제외인원` 기본 시트)에 저장
- [ ] 추가 입력 데이터는 `기타맞춤제안`, `기타재약정` 시트에 저장하도록 분리 관리 (향후 구현)
- [x] 제외 인원 데이터는 월별 링크된 구글 시트(`제외인원` 기본 시트)에 저장하도록 백엔드 연동 (기존 공용 시트→월별 시트 전환)
- [ ] 링크/시트명 등록 이력(감사 로그) 관리 방안 검토
- [ ] `기타`/`제외인원` 시트 헤더 구조는 2행 헤더·3행 데이터 기준으로 고정(부록 템플릿 참고)
- [x] 모달에서 선택한 `연월` 값을 기반으로 각 시트 저장 시 `연월` 컬럼 자동 채우기
- [x] 백엔드(`server/index.js`)에서 OB 관리 모드 권한 값을 `O`, `M`, `S` 모두 인식하도록 확장 (대리점아이디관리 시트 Y열 기준)
- [x] 월별 링크 메타데이터를 `OB정산관리링크관리` 시트(시트 ID: `1scNwIN5ZgV_DGGQW7WKJW9mL33vMGnFfsASPHYxt-18`)에 저장/동기화 (`/api/ob/settlement-links` 연동)
- [x] 프론트엔드에서는 `REACT_APP_OB_LINK_SHEET_ID`(또는 `REACT_APP_SHEET_ID`) 환경변수를 통해 시트 ID를 주입받도록 구성하고, 없을 경우 기본값으로 백엔드와 동일 ID 사용

#### 3.3.1 시트 헤더 템플릿 (복사용)
> 1행은 비워두고, 아래 헤더를 2행에 붙여넣은 뒤 3행부터 데이터를 입력해주세요.

- **`기타맞춤제안`**
```
연월	유치자마당ID	유치자명	항목	금액	비고	작성자	작성일시
```
- **`기타재약정`**
```
연월	유치자마당ID	유치자명	수수료	오퍼금액	오퍼유형(상품권/입금 등)	비고	작성자	작성일시
```
- **`기타후정산`**
```
연월	구분(인건비/비용)	항목명	직원명	고정급여	인센티브/추가비용	총합(자동계산용)	비고	작성자	작성일시
```
- **`제외인원`** (맞춤제안/재약정 구분 컬럼 포함)
```
구분(맞춤제안/재약정)	유치자마당ID	유치자명	사유	등록자	등록일시	비고
```
- - 모든 템플릿에 포함된 `연월` 컬럼은 정산관리 모달에서 선택한 연월 값으로 자동 입력
- - 시트 복제 시 동일 헤더(2행) 구조를 유지하고, 과거 월 데이터도 같은 형식으로 누적 관리
- - 제외 인원 데이터는 월별로 등록한 정산 시트(예: `2025-10` 링크)의 `제외인원` 시트에 저장/조회
- **`정산진행상황`**
```
연월	카테고리	필드	값	등록자	등록일시
```
- - 카테고리: `invoice`, `vip`, `yai` (필드 예: issued, approved, completed, bankName, accountNumber, isSaved, depositDone, confirmDone)
- **`OB정산관리링크관리`** (월별 링크 메타데이터 관리)
```
연월	시트ID	시트URL	시트이름(맞춤제안)	시트이름(재약정)	시트이름(후정산)	기타시트(맞춤제안)	기타시트(재약정)	기타시트(후정산)	비고	등록자	등록일시
```

---

## 4. 권한 설계 (초안)

- 온세일관리 모드와 동일한 체계로 권한을 판별해 탭 접근을 제어
- 로그인 시 사용자 권한 코드를 확인하여 허용된 탭만 네비게이션에 노출
- 권한이 없는 탭으로 직접 접근 시 리디렉션 또는 안내 메시지 필요

| 권한 코드 | 설명 | 접근 가능 탭 |
|-----------|------|--------------|
| `M` | 마스터 권한 | `투게더계산기`, `OB 정산 확인`, `OB 정산 관리` |
| `S` | 정산 확인 권한 | `투게더계산기`, `OB 정산 확인` |
| `O` | 기본 권한 | `투게더계산기` |

> 향후 권한 코드가 추가되거나 변경될 수 있으므로 상수/맵 형태로 관리 예정

---

## 5. 기술 고려사항

> 세부 기술 선택 및 구조는 요구사항 확정 후 결정 예정  
> (필요 시 기존 퀵서비스 관리 모드 구조를 참고)

- 프론트엔드/백엔드/데이터/테스트 관련 기술 검토는 사용자 요구사항 수집 후 별도 섹션으로 상세화합니다.

### 5.1 성능 / 최적화 포인트
- [ ] 시트 조회 결과 캐싱 (월별 + 탭별) 및 무효화 정책 정의
- [ ] 대용량 시트 대비를 위한 pagination / chunk fetch 전략 검토
- [ ] 반복 계산(정책별 합산, 제외 필터) 메모이제이션 또는 Web Worker 활용
- [ ] 모달/테이블 Lazy Rendering, Suspense 기반 로딩 상태 적용
- [ ] 서버 측 계산 시 Promise 병렬 처리 및 재시도/백오프 로직
- [ ] 로컬 저장소에 최근 선택 월/필터 유지하여 UX 개선
- [ ] Lighthouse/React Profiler로 초기 구동/상호작용 성능 체크 계획 수립
- [ ] 쉼표 포함 금액 문자열 정규화 유틸리티 공통화 및 단위 테스트

### 5.2 신규 API / 데이터 흐름 (업데이트)
- [x] `/api/ob/manual-adjustments` (GET, POST, PUT, DELETE)  
  ↳ 파라미터: `month`, `type`(labor|cost), `label`, `amount`, `note`, `id`  
  ↳ 응답: 월별 labor/cost 목록 + 합계, 저장 시 `기타후정산` 시트(A1:헤더, A3 이후 데이터) 동기화
- [x] `기타후정산` 시트 구조 보정 로직: 시트 미존재 시 자동 생성, 헤더/빈 2행 초기화
- [x] `settlement-summary` 응답 구조 확장: `manual` 섹션(시트 합계, 수기 합계, 합산 결과, 사용 시트명) 포함
- [ ] 추후 `기타맞춤제안`, `기타재약정` 수기 입력 파이프라인도 동일 패턴으로 확장

---

## 6. 초기 일정/마일스톤 (초안)

| 단계 | 기간 | 주요 작업 |
|------|------|-----------|
| 요구사항 수집 | (미정) | 사용자와 협의하여 각 탭 기능 정의 |
| 기획/설계 | (미정) | 와이어프레임, API 명세 |
| 구현/테스트 | (미정) | 요구사항 확정 후 일정 산정 |
| 배포/안정화 | (미정) | QA, 사용자 교육 |

> 모든 일정은 요구사항 확정 이후 업데이트합니다.

---

## 7. 개발 체크리스트

### 7.1 공통 준비
- [ ] 요구사항 정리 (사용자 피드백 반영)
- [x] 관련 시트/데이터 구조 파악
- [x] 접근 권한/토큰 확인

### 7.2 프론트엔드
- [x] 탭 네비게이션 적용 (권한별 노출 제어 포함)
- [x] 각 탭 레이아웃/기능 요구사항 확정
- [x] 확정된 기능에 맞춰 상세 TODO 작성

### 7.3 백엔드
- [x] 수기 입력 CRUD API 정의/구현 (`/api/ob/manual-adjustments` → `기타후정산`)
- [x] 데이터 저장소/시트 구조 확인
- [x] 권한 정책 요구사항 파악

### 7.4 테스트
- [ ] 테스트 범위/시나리오 요구사항 확정
- [ ] QA 프로세스 정의 (요구사항 협의 후)

---

## 8. 추후 업데이트 메모
- 사용자로부터 상세 요구사항을 받는 즉시 해당 섹션에 반영
- 이후 API/데이터 구조, 테스트 계획 등을 순차 업데이트
- 진행 중 발생한 이슈/변경사항은 `최근 수정 내역` 섹션에 계속 기록

---

## 9. 최근 수정 내역 (로그 예시)

| 날짜 | 내용 | 작성자 |
|------|------|--------|
| 2025-11-10 | 문서 초안 작성 및 기본 구조 정의 | assistant |
| 2025-11-11 | `/api/ob/settlement-summary` 구현 및 시트 이름 검증(플레이스홀더 방지) 반영 | assistant |
| 2025-11-11 | OB 정산 확인 탭 UI 개선: 파스텔톤 배경색, 최종정산 상단 배치, 유치자별 상세 테이블 추가, 건수 표기 추가, 연월 선택 필드 개선 | assistant |
| 2025-11-11 | 재약정 수수료/오퍼금액 부호 처리 수정 (수수료: *-1로 +, 오퍼: *-1로 -) | assistant |
| 2025-11-11 | 맞춤제안/재약정 보조설명에 유치자명/등록직원 목록 및 건수 카운팅 추가 | assistant |
| 2025-11-11 | 컬럼 인덱스 오류 수정 (+1 조정) | assistant |
| 2025-11-11 | `기타후정산` 수기 입력 CRUD API 및 인건비/비용 UI 연동(추가/수정/삭제, 음수 처리, 합계 반영) | assistant |
| 2025-11-11 | 맞춤제안 유치자별 테이블 및 건수 구간별 지급 계산 로직 보완(숫자형 인정값 대응) | assistant |
| 2025-11-11 | **긴급 수정 필요**: 기타후정산 헤더가 1행에만 생성됨(2행 필요), 연월이 숫자로 잘못 저장됨, 건수 구간별 지급이 230건으로 잘못 계산됨(232건이어야 함) | assistant |
| 2025-11-11 | **수정 완료**: 기타후정산 헤더 1-2행 설정 강화, 연월 문자열 변환 명시적 처리, approvalFlag 정규화 로직 개선(1.0, 1.00 형식 인정) | assistant |
| 2025-11-11 | OB 관리모드 탭 접근 제어: O/S/M 권한에 따라 `투게더 계산기`, `OB 정산 확인`, `OB 정산 관리` 탭 노출 제한 로직 추가 | assistant |
| 2025-11-11 | 최종 정산 카드 워크플로우 구현: 입력중/입력완료 체크, 세금계산서 링크, 계좌 입력·입금·확인 단계 및 축하 애니메이션 적용 | assistant |
| 2025-11-11 | 제외 인원 저장 경로를 월별 정산 링크 시트(`제외인원`)로 변경 및 API/프론트 동기화 | assistant |
| 2025-11-11 | 제외 인원 필터 시 유치자명 공백 제거 정규화로 비교 로직 보완 (예: "이은영 대리" → "이은영대리") | assistant |
| 2025-11-11 | 재약정 제외 필터에 유치자ID/등록직원(90/91 인덱스) 양쪽 비교 로직 추가 | assistant |
| 2025-11-11 | 최종 정산 카드 섹션 재배치 및 CTA/체크박스 레이아웃 개선 (버튼 줄바꿈 방지) | assistant |
| 2025-11-11 | 정산 진행상황 시트 연동: 월별 진행 상태 저장/복원 및 단계별 안내 UI 개선 | assistant |
| 2025-11-12 | 재약정 필터링 로직을 OR에서 AND 조건으로 변경: 제외인원에 없고 대상점에 매칭되는 경우만 포함 | assistant |
| 2025-11-12 | 후정산 시트 데이터 연동 완료: `시트이름(후정산)` 시트에서 인건비/비용 데이터 자동 조회 및 계산, 대상점 필터링 적용 | assistant |
| 2025-11-12 | 인건비/비용 시트 데이터 상세 내역 표시: 항목/대상/내용/상세내용(줄바꿈 지원)/금액 테이블 추가 | assistant |
| 2025-11-12 | 재약정 등록직원별 상세 내역에 대상(출고처) 컬럼 추가: 실제 출고처(10인덱스) 값 표시 | assistant |
| 2025-11-12 | 플랜 문서 전체 정리 및 최신 구현 상태 반영 | assistant |
| 2025-11-12 | 재약정 오퍼금액 계산 로직 변경: 19인덱스(오퍼금액) 컬럼 사용, *-1 적용, 상품권/입금 구분 제거 | assistant |
| 2025-11-12 | 인건비/비용 시트 산출금액: *-1 적용하여 음수 처리 (수기 입력과 동일하게) | assistant |
| 2025-11-12 | 영업팀/코드 통계: 맞춤제안 유치자별 상세 내역에 영업팀/코드 컬럼 추가 (30인덱스/31인덱스) | assistant |

---

## 10. 참고 자료 & 추천 개선안
- 참고 자료는 요구사항 확정 후 추가 예정
- 추천 기능/고도화 아이디어:
  - [ ] 월별 결과 PDF/CSV 내보내기 (경영진 공유 용이)
  - [ ] 권한별 알림(정산 미입력/마감 임박) 슬랙 또는 메일 연동
  - [ ] 제외 인원 변경 시 승인/히스토리 로깅 기능
  - [ ] 계산 결과 시뮬레이션 모드 (시트 없이 임시 데이터 입력 후 검증)
  - [ ] 다크 모드 지원 및 접근성(색 대비) 검토

---

## 11. 다음 단계 (고도화 진행 계획)

### 단계 1. 제외 인원 & 맞춤제안 세부 분석
- [x] `정산관리` 탭에 맞춤제안/재약정 제외 인원 CRUD UI 추가 (맞춤제안·재약정 별도 관리)
- [x] 제외 인원 리스트를 `제외인원` 시트에 월별로 저장하고, 등록자/등록일시 기록
- [x] 최종 정산 카드 UX 고도화: 입력중/입력완료 체크, 세금계산서 발행/승인 연동, 계좌 입력→입금→확인 프로세스, 축하 메시지 애니메이션
- [ ] `시트이름(맞춤제안)` 30/31번 컬럼을 `UNIQUE` 처리하여 팀/코드 통계 제공
- [ ] 맞춤제안 월별 상세 패널(정책①~③, 건수 구간, 제외내역)을 카드/표 형태로 제공

### 단계 2. 재약정/다운로드 고도화
- [ ] 재약정 월별 상세 테이블/툴팁(고객별 수수료·오퍼 상세) 추가 여부 검토 및 구현
- [ ] 다운로드 엑셀에 3:7 분배 결과, 제외 인원 목록 포함 옵션 제공
- [ ] 재약정 제외 인원 목록 관리 UI 및 `기타재약정` 저장 구조 정비
- [ ] `기타맞춤제안`, `기타재약정` 수기 입력 파이프라인을 `기타후정산`과 동일 패턴으로 정비

### 단계 3. 인건비/비용 고도화
- [ ] 인건비 탭에서 등록된 직원 목록과 연동, 동일 인원만 필터링 표시
- [ ] 직원별 상세 금액(고정/인센티브/합계) 확인 UI 및 출력 서식 검토
- [ ] 비용 항목 차트/테이블 이중 표현 및 VAT/음수 표기 규칙 정리
- [ ] 차후 후정산 원시 데이터 연동 시 자동 합산 로직 설계

> 각 단계가 완료될 때마다 테스트 시나리오(12장)를 갱신하고 사용자와 공동 테스트를 진행합니다.

---

## 12. 테스트 시나리오 (Step-by-Step)

### 12.1 재배포 직후 필수 테스트
1. **OB 관리 모드 진입 확인**  
   - 로그인 후 OB 관리 모드로 전환 → 상단 탭(`투게더 계산기 / OB 정산 확인 / OB 정산 관리`)이 노출되는지 확인  
2. **OB 정산 관리 탭 초기 로딩**  
   - `OB 정산 관리` 탭 이동 → 기존 등록 목록이 정상 표시되는지, `OB정산관리링크관리 시트 열기` 버튼이 동작하는지 확인  
3. **OB 정산 확인 탭 요약 데이터 로딩**  
   - `OB 정산 확인` 탭 이동 → 월별 선택 드롭다운이 노출되고 기본 월이 자동 선택되는지 확인  
   - 선택된 월 기준 요약 카드(정책①~③, 건수 구간, 재약정 수수료/오퍼, 3:7 분배)가 정상 표시되는지 확인  
4. **OB 정산 확인 탭 에러/로딩 처리**  
   - 데이터 로딩 중 스피너 → 완료 후 카드 표시, 오류 발생 시 에러 메시지가 노출되는지 확인

### 12.2 월별 링크 등록/수정/삭제 테스트
1. `OB 정산 관리` 탭에서 **월별 링크 등록** 버튼 클릭 → 모달 표시 확인  
2. 연월/시트 링크/시트 이름 입력 후 저장 → 테이블에 신규 행 추가 및 스낵바 메시지 확인  
3. 테이블의 링크 버튼으로 구글 시트가 새 탭에서 열리는지 확인  
4. 기존 행 수정 후 저장 → 변경 내용 반영 및 스낵바 메시지 확인  
5. 행 삭제 기능 동작 여부 확인(확인 대화상자 및 삭제 후 목록 갱신)  
6. 페이지 새로고침 후에도 등록한 데이터가 유지되는지 확인 (로컬 스토리지/시트 반영 확인용)
7. `OB정산관리링크관리` 시트에 방금 등록/수정한 값이 반영됐는지 확인 (연월·시트ID·비고 등)
8. 권한 컬럼(Y열)을 `O`, `M`, `S` 각각으로 설정 후 재로그인했을 때 OB 관리 모드 탭이 정상 노출되는지 확인

### 12.3 탭 전환 및 UX
1. `투게더 계산기` 탭으로 복귀 → 기존 기능(계산, 저장)이 기존과 동일하게 동작하는지 간단 확인  
2. 탭 전환 시 상태가 적절히 유지되는지(예: 활성 탭 강조, 다른 탭 상태 영향 없음) 확인  

### 12.4 정산 계산 & 다운로드 검증
1. 월별 드롭다운에서 다른 월을 선택했을 때 모든 카드 값이 즉시 갱신되는지 확인  
2. `맞춤제안` 카드별 금액(정책①~③, 건수 구간)이 원본 시트 합산 결과와 일치하는지 표본 검증  
3. 제외 대상 ID가 포함된 행이 계산에서 제외되었는지(카드 하단 제외 카운트와 시트 행 비교) 확인  
4. `재약정` 수수료/오퍼 합계가 시트 기준과 일치하는지, 상품권/입금 금액이 각각 올바르게 분리되는지 확인  
5. 총 정산 금액과 3:7 분배 금액이 맞춤제안·재약정 합계로부터 올바르게 계산되는지 확인  
6. `맞춤제안 CSV/XLSX`, `재약정 CSV/XLSX` 다운로드 버튼을 눌러 실제 파일이 생성되는지, 엑셀/스프레드시트에서 열어볼 때 컬럼/데이터가 정상인지 확인  
7. 네트워크 탭에서 `/api/ob/settlement-summary` 호출이 월 변경에 맞춰 발생하는지, 응답 데이터 구조가 예상과 일치하는지 확인  

### 12.5 대상점 관리 기능 (2025-11-11 추가)
1. `OB 정산 관리` 탭에서 "대상점" 탭으로 전환 → 대상점 관리 UI가 표시되는지 확인
2. 대상점 추가 버튼 클릭 → 모달에서 연월/구분(재약정/후정산)/대상점명/사유/비고 입력 후 저장 → 테이블에 신규 행 추가 확인
3. 대상점 수정/삭제 기능이 정상 동작하는지 확인
4. 대상점 시트(`대상점`)가 대상월 링크 시트에 생성되고, 2행에 헤더가 올바르게 설정되는지 확인
5. 재약정 계산에서 대상점 필터링이 적용되는지 확인:
   - 제외인원(91인덱스 등록직원)에 없고
   - 출고처(10인덱스)에 대상점 문자열이 포함된 경우만 포함 (AND 조건)
6. 재약정 등록직원별 상세 내역에 대상(출고처) 컬럼이 표시되고 실제 출고처 값이 올바르게 표시되는지 확인
7. 후정산 계산에서 대상점 필터링이 적용되는지 확인:
   - 대상(10인덱스)에 후정산 대상점이 포함된 경우만 포함
8. 대상점 시트 헤더 컬럼 (2행):
   ```
   연월 | 구분(재약정/후정산) | 대상점명 | 사유 | ID | 비고 | 등록자 | 등록일시
   ```

### 12.6 후정산 시트 데이터 연동 (2025-11-12 추가)
1. `OB 정산 확인` 탭에서 인건비/비용 섹션 확인
2. `시트이름(후정산)` 시트에 데이터가 있는 경우:
   - 인건비 합계에 시트 금액이 반영되는지 확인
   - 비용 합계에 시트 금액이 반영되는지 확인
   - 합계 표시 형식: `인건비 합계: ₩X (시트 ₩Y / 수기 입력 ₩Z)` 확인
3. 시트 데이터 상세 내역 테이블 확인:
   - 항목, 대상, 내용, 상세내용(줄바꿈 지원), 금액 컬럼이 표시되는지 확인
   - 상세내용에 줄바꿈이 있는 경우 올바르게 표시되는지 확인
4. 후정산 대상점 필터링 확인:
   - 후정산 대상점에 등록된 대상점명이 대상(10인덱스)에 포함된 행만 표시되는지 확인
5. 수기 입력과 시트 데이터 합산이 올바르게 계산되는지 확인

> 각 단계별 테스트 완료 후 다음 단계로 진행해주세요. 추가 데이터 연동·다운로드 기능 구현 시 신규 시나리오를 여기에 확장합니다.

---

### 메모
- 문서 수정 시 “최근 수정 내역”과 “다음 액션”을 함께 갱신하세요.
- 실제 요구사항이 확정되면 각 탭별로 세부 체크리스트를 더욱 구체화해주세요.



