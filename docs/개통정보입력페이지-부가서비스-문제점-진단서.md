# 개통정보입력페이지 부가서비스/보험상품 문제점 진단 및 수정 계획서

## 📋 개요

커밋 `3916ff404134e0773924a3bbf49a569c83e508dc`에서 부가서비스/보험상품 UI를 체크박스 형태로 변경하면서 발생한 문제점을 진단하고 수정 계획을 수립합니다.

---

## 🔍 문제점 진단

### 1. UI 구조 문제

#### 현재 상태
- **"부가서비스/보험상품 개별 선택" 섹션** (1382-1519줄)
  - 체크박스 형태로 부가서비스/보험상품 선택
  - `selectedAddons` Set과 `selectedInsurances` Set으로 관리
  - 상세설명 및 URL 표시 기능 포함

- **"필수 부가서비스" 섹션** (1144-1157줄)
  - `requiredAddons` 배열을 단순 표시만 함
  - +/- 버튼 없음
  - 읽기 전용 상태

#### 문제점
1. **두 섹션이 분리되어 있음**
   - 필수부가서비스 섹션과 개별 선택 섹션이 별도로 존재
   - 사용자가 어디서 선택해야 하는지 혼란스러움

2. **의도와 다른 구현**
   - 사용자 의도: 필수부가서비스 섹션에서 +/- 버튼으로 추가/제거
   - 현재 구현: 별도 섹션에서 체크박스로 선택

---

### 2. 동적 계산 로직 문제

#### 현재 계산 구조

```javascript
// 1. requiredAddons: 정책설정에서 가져온 필수 부가서비스 (읽기 전용)
const [requiredAddons, setRequiredAddons] = useState([]);

// 2. selectedAddons: 체크박스로 선택한 부가서비스 Set
const [selectedAddons, setSelectedAddons] = useState(new Set());

// 3. 동적 대리점지원금 계산 (392-422줄)
const calculateDynamicStoreSupport = useMemo(() => {
    // selectedAddons와 selectedInsurances 기반으로 계산
    // requiredAddons는 사용하지 않음
}, [selectedAddons, selectedInsurances, ...]);

// 4. 필수 부가서비스 요금 계산 (457-458줄)
const addonsFeeResult = useMemo(() => {
    return calculateRequiredAddonsFee(requiredAddons);
    // requiredAddons만 사용, selectedAddons는 사용하지 않음
}, [requiredAddons]);
```

#### 문제점
1. **데이터 분리로 인한 계산 불일치**
   - `requiredAddons`: 필수 부가서비스 요금 계산에만 사용
   - `selectedAddons`: 대리점지원금 계산에만 사용
   - 두 개가 동기화되지 않음

2. **동적 계산이 제대로 작동하지 않을 수 있음**
   - 필수부가서비스 섹션에서 추가/제거할 수 없어서
   - `requiredAddons`가 변경되지 않으면 요금 계산이 업데이트되지 않음

3. **withAddon 플래그와의 연동 문제**
   - `formData.withAddon`이 true/false로 부가유치 여부를 결정
   - 하지만 실제 선택된 부가서비스와 연동이 명확하지 않음

---

### 3. 기존 동작과의 차이점

#### 기존에 잘 작동하던 부분 (추정)
- 필수부가서비스 섹션에서 +/- 버튼으로 추가/제거
- 추가/제거할 때마다 즉시 계산 업데이트
- `requiredAddons` 배열이 실제 선택된 부가서비스를 반영

#### 현재 상태
- 필수부가서비스 섹션은 읽기 전용
- 별도 섹션에서 체크박스로 선택
- 두 데이터가 분리되어 있어서 계산이 복잡함

---

## ❓ 확인이 필요한 사항

### 1. UI 구조 관련
**Q1**: 필수부가서비스 섹션에서 +/- 버튼으로 추가/제거하는 것이 맞나요?
- [x ] 예, 필수부가서비스 섹션에서만 관리
- [ ] 아니오, 별도 섹션도 유지하되 필수부가서비스 섹션에도 +/- 버튼 추가

**Q2**: "부가서비스/보험상품 개별 선택" 섹션은 어떻게 할까요?
- [x ] 제거 (필수부가서비스 섹션으로 통합)
- [ ] 유지하되 필수부가서비스 섹션과 동기화
- [ ] 다른 용도로 사용 (예: 상세설명 확인용)

**Q3**: 부가서비스와 보험상품을 같은 섹션에서 관리하나요, 아니면 분리하나요?
- [x ] 같은 섹션 (필수부가서비스 섹션에 모두 표시)
- [ ] 분리 (부가서비스 섹션, 보험상품 섹션 별도)

### 2. 계산 로직 관련

**Q4**: 현재 코드에 부가서비스를 저장하는 변수가 2개 있습니다. 이걸 하나로 합칠까요?

#### 현재 상황 설명:
1. **`requiredAddons`** (필수 부가서비스 배열)
   - 용도: "필수 부가서비스 요금" 계산에 사용
   - 내용: 정책설정에서 `deduction`(미유치시 차감금액)이 있는 부가서비스만 저장
   - 형태: 배열 `[{name: '부가서비스1', monthlyFee: 5000}, ...]`
   - 표시 위치: 요금정보 섹션의 "필수 부가서비스" 부분 (1144-1157줄)

2. **`selectedAddons`** (선택된 부가서비스 Set)
   - 용도: "대리점지원금" 계산에 사용
   - 내용: 체크박스로 사용자가 선택한 부가서비스 이름들
   - 형태: Set `Set(['부가서비스1', '부가서비스2', ...])`
   - 표시 위치: "부가서비스/보험상품 개별 선택" 섹션의 체크박스 (1398줄)

#### 문제점:
- 두 변수가 서로 다른 기준으로 관리됨
- `requiredAddons`는 deduction 있는 것만, `selectedAddons`는 incentive 있는 것들을 초기값으로 설정
- 사용자가 +/- 버튼으로 추가/제거할 때 어느 변수를 업데이트해야 할지 애매함

#### 선택지:
- [x] **예, 하나로 통합** - `requiredAddons` 배열 하나만 사용하고, 사용자가 +/- 버튼으로 추가/제거한 모든 부가서비스를 여기에 저장. `selectedAddons`는 제거. (복잡한 구조 제거하고 깔끔하게 재구성)
- [ ] **아니오, 각각 다른 용도로 사용** - `requiredAddons`는 필수 항목만, `selectedAddons`는 사용자가 선택한 항목으로 분리 관리. 하지만 두 개를 동기화하는 로직 필요.

**Q5**: 필수 부가서비스 요금 계산은 어떻게 해야 하나요?
- [ ] `requiredAddons` 배열의 모든 항목 요금 합계
- [x] 사용자가 선택한 항목만 요금 합계 (사용자가 +/- 버튼으로 추가/제거한 항목)
- [ ] 정책설정에서 지정한 필수 항목 + 사용자가 추가한 항목

**Q6**: 대리점지원금 계산은 어떻게 해야 하나요?
- [x] 선택된 부가서비스/보험상품의 incentive 합계 (유치시 금액에 더해짐)
- [x] 선택되지 않은 항목의 deduction 차감 (미유치시 금액에서 차감)
- [x] 둘 다 적용
  - **추가 시**: 대리점추가지원금(유치시)에 `incentive` 추가
  - **제거 시**: 대리점추가지원금(미유치시)에 `deduction` 차감

### 3. 초기값 관련
**Q7**: 페이지 진입 시 초기 선택 상태는 어떻게 해야 하나요?
- [x] 정책설정에서 지정한 필수 항목만 선택 (deduction > 0인 항목)
- [ ] incentive가 있는 항목 모두 선택 (현재 상태)
- [ ] 아무것도 선택하지 않음

**Q8**: `formData.withAddon` 플래그는 어떻게 결정하나요?
- [x] 부가서비스/보험상품이 하나라도 선택되면 true
- [ ] 사용자가 수동으로 선택
- [ ] 정책설정에 따라 자동 결정

---

## ✅ 사용자 의도 확인 완료

### 요구사항 정리
1. **섹션 이름 변경**: "필수 부가서비스" → "부가서비스 및 보험 적용시 금액 변경"
2. **UI 구조**: +/- 버튼으로 부가서비스/보험상품 추가/제거 (세로 구성)
3. **동적 계산 로직**:
   - **추가 시**: 대리점추가지원금(유치시)에 `incentive` 추가
   - **제거 시**: 대리점추가지원금(미유치시)에 `deduction` 차감
   - 대리점추가지원금 변동 시 할부원금 자동 재계산
4. **구조 단순화**: 복잡한 구조 제거하고 깔끔하게 재구성

---

## ✅ 사용자 의도 확인 완료

### 요구사항 정리
1. **섹션 이름 변경**: "필수 부가서비스" → "부가서비스 및 보험 적용시 금액 변경"
2. **UI 구조**: +/- 버튼으로 부가서비스/보험상품 추가/제거 (세로 구성)
3. **동적 계산 로직**:
   - **추가 시**: 대리점추가지원금(유치시)에 `incentive` 추가
   - **제거 시**: 대리점추가지원금(미유치시)에 `deduction` 차감
   - 대리점추가지원금 변동 시 할부원금 자동 재계산
4. **구조 단순화**: 복잡한 구조 제거하고 깔끔하게 재구성

---

## 🔧 수정 계획

### Phase 1: 데이터 구조 단순화

1. **변수 통합**
   - `selectedAddons`, `selectedInsurances` Set 제거
   - `requiredAddons`를 `selectedItems`로 변경하여 부가서비스와 보험상품 모두 포함
   - 하나의 배열로 통합 관리

2. **제거할 변수**
   - `selectedAddons` (Set)
   - `selectedInsurances` (Set)
   - `addonIncentiveList` (불필요)
   - `insuranceIncentiveList` (불필요)

3. **유지할 변수**
   - `availableAddons` (선택 가능한 모든 부가서비스)
   - `availableInsurances` (선택 가능한 모든 보험상품)
   - `selectedItems` (사용자가 선택한 부가서비스 + 보험상품 통합 배열)

### Phase 2: UI 구조 수정

1. **"부가서비스/보험상품 개별 선택" 섹션 제거** (1382-1519줄)
   - 체크박스 형태의 섹션 완전 제거

2. **"필수 부가서비스" 섹션 수정** (1144-1157줄)
   - 섹션 이름: "부가서비스 및 보험 적용시 금액 변경"
   - 세로 구성으로 변경
   - 각 항목에 +/- 버튼 추가
   - 부가서비스와 보험상품을 같은 섹션에 표시

3. **UI 구성**
   ```
   부가서비스 및 보험 적용시 금액 변경
   ┌─────────────────────────────────┐
   │ 부가서비스1  [+5000원]  [추가] │
   │ 부가서비스2  [+3000원]  [추가] │
   │ 보험상품1    [+2000원]  [추가] │
   └─────────────────────────────────┘
   
   선택된 항목:
   ┌─────────────────────────────────┐
   │ 부가서비스1  [+5000원]  [제거] │
   └─────────────────────────────────┘
   ```

### Phase 3: 계산 로직 재구성

1. **대리점추가지원금 계산**
   ```javascript
   // 유치시 = 기본값 + 선택된 항목들의 incentive 합계
   const storeSupportWithAddon = baseStoreSupport + 
     selectedItems.reduce((sum, item) => sum + (item.incentive || 0), 0);
   
   // 미유치시 = 기본값 - 선택되지 않은 항목들의 deduction 합계
   const storeSupportWithoutAddon = baseStoreSupport - 
     availableItems
       .filter(item => !selectedItems.includes(item))
       .reduce((sum, item) => sum + (item.deduction || 0), 0);
   ```

2. **필수 부가서비스 요금 계산**
   ```javascript
   // 선택된 항목들의 월 요금 합계
   const addonsFeeResult = selectedItems.reduce(
     (sum, item) => sum + (item.monthlyFee || 0), 
     0
   );
   ```

3. **할부원금 자동 재계산**
   - `calculateDynamicStoreSupport` 변경 시 자동으로 `getCurrentInstallmentPrincipal()` 재계산
   - `useMemo` 의존성에 포함

### Phase 4: 초기값 설정

1. **페이지 진입 시**
   - 정책설정에서 `deduction > 0`인 항목을 초기 선택 (필수 항목)
   - 또는 사용자가 수동으로 추가

2. **withAddon 플래그**
   - 선택된 항목이 하나라도 있으면 `true`
   - 없으면 `false`

---

## 📝 현재 코드 구조 분석

### 상태 변수
```javascript
// 필수 부가서비스 (정책설정에서 가져옴, 읽기 전용)
const [requiredAddons, setRequiredAddons] = useState([]);

// 선택 가능한 모든 부가서비스/보험상품
const [availableAddons, setAvailableAddons] = useState([]);
const [availableInsurances, setAvailableInsurances] = useState([]);

// 체크박스로 선택한 부가서비스/보험상품
const [selectedAddons, setSelectedAddons] = useState(new Set());
const [selectedInsurances, setSelectedInsurances] = useState(new Set());
```

### 계산 함수
```javascript
// 동적 대리점지원금 (selectedAddons/selectedInsurances 기반)
const calculateDynamicStoreSupport = useMemo(() => {...}, [selectedAddons, selectedInsurances, ...]);

// 필수 부가서비스 요금 (requiredAddons 기반)
const addonsFeeResult = useMemo(() => {
    return calculateRequiredAddonsFee(requiredAddons);
}, [requiredAddons]);
```

### 문제점 요약
1. **데이터 분리**: `requiredAddons`와 `selectedAddons`가 분리되어 있음
2. **UI 분리**: 필수부가서비스 섹션과 개별 선택 섹션이 분리되어 있음
3. **계산 불일치**: 두 데이터가 서로 다른 계산에 사용되어 동기화되지 않음

---

## ✅ 다음 단계

1. **사용자에게 위의 질문들에 대한 답변 요청**
2. **답변을 바탕으로 구체적인 수정 계획 수립**
3. **단계별로 수정 진행**
4. **테스트 및 검증**

---

## 📌 참고사항

- 커밋 `3916ff404134e0773924a3bbf49a569c83e508dc` 이전 상태로 완전히 롤백하지 않고, 문제점만 수정
- 기존에 잘 작동하던 동적 계산 기능 복구
- UI는 사용자 의도에 맞게 +/- 버튼 형태로 변경

