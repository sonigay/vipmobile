# 매장 마커 색상 설정 기능 구현 계획

## 📋 요구사항 분석

### 목표
관리자모드에서 지도상에 표시되는 매장 마커의 색상을 코드별로 구분하여 표시하고, 사용자가 각 코드별 색상을 자유롭게 설정할 수 있도록 함.

### 핵심 기능
1. **코드 정보 수집**: 폰클출고처데이터 시트의 H열(7인덱스)에서 코드 정보 가져오기
2. **유니크 코드 추출**: "VIP(경수)", "VIP(호남)" 등 유니크한 코드 값만 추출
3. **색상 설정 UI**: 메인헤더에 색상 설정 버튼 추가 및 모달 구현
4. **색상 저장**: 사용자별 색상 설정 저장
5. **마커 색상 적용**: 관리자모드에서 코드별 색상으로 마커 표시

---

## 🔍 현재 코드 구조 분석

### 1. 데이터 구조

#### 서버 측 (server/index.js)
- **시트명**: `폰클출고처데이터` (STORE_SHEET_NAME)
- **코드 위치**: H열 (인덱스 7)
- **현재 처리**: 
  ```javascript
  // server/index.js:4304
  code: (foundStoreRow[7] || '').toString().trim(),  // H열(7인덱스): 코드
  ```
- **store 객체에 포함**: `storeDetails`에 `code` 필드로 포함되어 클라이언트로 전달됨

#### 클라이언트 측 (src/components/Map.js)
- **마커 생성 함수**: `createMarkerIcon(store)`
- **현재 색상 로직**: 
  - 요청점: `#ff9800` (주황색)
  - 사무실: `#21f8fb` (청록색)
  - 선택된 매장: `#2196f3` (파란색)
  - 로그인한 매장: `#9c27b0` (보라색)
  - 일반 매장: 출고일 기준 색상 (초록/노랑/주황/빨강)
- **관리자모드 구분**: `isAgentMode` prop으로 확인

### 2. 헤더 구조 (src/components/Header.js)
- **위치**: `src/components/Header.js`
- **현재 버튼들**:
  - 모드 전환 버튼 (SwapHorizIcon)
  - 푸시 알림 설정 버튼 (NotificationsIcon)
  - 업데이트 확인 버튼
  - 지도 재고 노출 옵션 설정 버튼 (M 권한자만, MapIcon)
  - 관리자모드 메뉴 (MenuIcon)
- **버튼 추가 위치**: 기존 버튼들과 함께 `Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}` 내부

### 3. App.js 구조
- **관리자모드 상태**: `isAgentMode` state
- **Map 컴포넌트 전달**: `isAgentMode={isAgentMode}` prop 전달
- **Header 컴포넌트**: `isAgentMode={isAgentMode}` prop 전달

---

## ❓ 확인 필요 사항

### 1. 색상 저장 위치
**질문**: 색상 설정을 어디에 저장할까요?
- **옵션 A**: 로컬스토리지 (브라우저별, 사용자별)
  - 장점: 서버 부하 없음, 빠른 로딩
  - 단점: 다른 브라우저/기기에서 동기화 안됨
- **옵션 B**: 서버 (구글시트 또는 별도 API)
  - 장점: 모든 기기에서 동기화
  - 단점: 서버 부하, 구현 복잡도 증가
- **옵션 C**: 둘 다 (로컬스토리지 우선, 서버 백업)
  - 장점: 오프라인 지원 + 동기화
  - 단점: 구현 복잡도 높음

**권장**: 옵션 A (로컬스토리지) - 사용자별 설정이므로 브라우저별로 관리하는 것이 자연스러움

### 2. 기본 색상 설정
**질문**: 코드별 기본 색상을 어떻게 설정할까요?
- **옵션 A**: 랜덤 색상 자동 생성
- **옵션 B**: 미리 정의된 색상 팔레트에서 순차 할당
- **옵션 C**: 기본값 없음 (사용자가 처음 설정할 때까지 기본 색상 사용)

**권장**: 옵션 B - 미리 정의된 색상 팔레트 사용 (예: Material-UI 색상 팔레트)

### 3. 코드가 없는 매장 처리
**질문**: 코드가 없는 매장은 어떻게 표시할까요?
- **옵션 A**: 기존 색상 로직 유지 (출고일 기준 색상)
- **옵션 B**: 회색 또는 특정 기본 색상
- **옵션 C**: "기타" 또는 "미분류" 카테고리로 분류

**권장**: 옵션 A - 기존 로직 유지 (하위 호환성)

### 4. 색상 설정 권한
**질문**: 모든 관리자모드 사용자가 색상을 설정할 수 있나요?
- **옵션 A**: 모든 관리자모드 사용자
- **옵션 B**: 특정 권한 레벨만 (예: SS, M 등)

**권장**: 옵션 A - 모든 관리자모드 사용자 (개인 설정이므로)

---

## 📐 구현 계획

### Phase 1: 데이터 수집 및 유니크 코드 추출

#### 1.1 서버 측 수정 (server/index.js)
**목표**: 매장 목록 조회 시 코드 정보 포함 확인 및 유니크 코드 목록 제공 API 추가

**확인 사항**:
- ✅ 이미 `store.code` 필드가 포함되어 있음 (4304번째 줄)
- 추가 작업: 유니크 코드 목록을 반환하는 API 엔드포인트 추가

**구현 위치**:
```javascript
// server/index.js
// GET /api/stores/codes - 유니크 코드 목록 조회
```

**구현 내용**:
1. 폰클출고처데이터 시트에서 모든 매장의 H열(7인덱스) 데이터 조회
2. 빈 값 제외 및 trim 처리
3. 유니크 값만 추출하여 배열로 반환
4. 정렬 (가나다순 또는 알파벳순)

---

### Phase 2: 색상 설정 UI 구현

#### 2.1 헤더에 색상 설정 버튼 추가 (src/components/Header.js)

**위치**: 기존 버튼들과 함께 추가
```javascript
// src/components/Header.js
// 관리자모드일 때만 표시
{isAgentMode && (
  <Tooltip title="마커 색상 설정">
    <IconButton
      color="inherit"
      onClick={() => setMarkerColorDialogOpen(true)}
      sx={{ 
        border: '1px solid rgba(255,255,255,0.3)',
        borderRadius: 1
      }}
    >
      <PaletteIcon />
    </IconButton>
  </Tooltip>
)}
```

**필요한 import**:
```javascript
import PaletteIcon from '@mui/icons-material/Palette';
```

**상태 관리**:
```javascript
const [markerColorDialogOpen, setMarkerColorDialogOpen] = useState(false);
```

---

#### 2.2 색상 설정 모달 컴포넌트 생성

**파일**: `src/components/MarkerColorSettingsModal.js` (새로 생성)

**기능**:
1. 유니크 코드 목록 표시
2. 각 코드별 색상 선택기 (ColorPicker 또는 TextField)
3. 색상 미리보기
4. 저장/취소 버튼

**UI 구조**:
```
┌─────────────────────────────────────┐
│ 마커 색상 설정                      │
├─────────────────────────────────────┤
│ VIP(경수)    [색상선택] [미리보기] │
│ VIP(호남)    [색상선택] [미리보기] │
│ ...                                 │
│                                     │
│ [취소]  [저장]                     │
└─────────────────────────────────────┘
```

**상태 관리**:
```javascript
const [colorSettings, setColorSettings] = useState({});
const [uniqueCodes, setUniqueCodes] = useState([]);
```

**색상 저장 형식** (로컬스토리지):
```javascript
{
  "VIP(경수)": "#ff5722",
  "VIP(호남)": "#2196f3",
  ...
}
```

**로컬스토리지 키**: `markerColorSettings`

---

### Phase 3: 마커 색상 적용

#### 3.1 Map.js 수정 (src/components/Map.js)

**수정 위치**: `createMarkerIcon` 함수 내부

**로직 순서**:
1. 관리자모드 확인 (`isAgentMode`)
2. 코드별 색상 설정 확인 (로컬스토리지에서 읽기)
3. 코드별 색상이 있으면 해당 색상 사용
4. 코드별 색상이 없으면 기존 로직 유지

**우선순위** (기존 로직 유지):
1. 요청점 (최우선)
2. 사무실
3. 선택된 매장
4. 로그인한 매장
5. **코드별 색상** (새로 추가)
6. 기존 출고일 기준 색상 (fallback)

**구현 예시**:
```javascript
// createMarkerIcon 함수 내부
const getMarkerColorByCode = (code) => {
  if (!code || !isAgentMode) return null;
  
  const colorSettings = JSON.parse(
    localStorage.getItem('markerColorSettings') || '{}'
  );
  
  return colorSettings[code] || null;
};

// 일반 매장 색상 결정 부분 (818번째 줄 근처)
else {
  // 코드별 색상 확인
  const codeColor = getMarkerColorByCode(store.code);
  if (codeColor) {
    fillColor = codeColor;
    strokeColor = adjustBrightness(codeColor, -20); // 약간 어둡게
    radius = hasInventory ? 14 : 10;
    iconStyle = '';
  } else {
    // 기존 로직 (출고일 기준 색상)
    // ... 기존 코드 유지
  }
}
```

**색상 밝기 조정 함수** (strokeColor 계산용):
```javascript
const adjustBrightness = (hex, percent) => {
  // hex 색상을 RGB로 변환하고 밝기 조정
  // 간단한 구현 또는 라이브러리 사용
};
```

---

### Phase 4: 유니크 코드 목록 API 구현

#### 4.1 서버 API 추가 (server/index.js)

**엔드포인트**: `GET /api/stores/codes`

**구현 내용**:
```javascript
// server/index.js
app.get('/api/stores/codes', async (req, res) => {
  try {
    const { sheets, SPREADSHEET_ID } = createSheetsClient();
    
    const response = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: '폰클출고처데이터!H:H' // H열 전체
    });
    
    const rows = response.data.values || [];
    const codes = new Set();
    
    // 헤더 제외하고 데이터 처리
    rows.slice(1).forEach(row => {
      const code = (row[0] || '').toString().trim();
      if (code) {
        codes.add(code);
      }
    });
    
    // 배열로 변환 및 정렬
    const uniqueCodes = Array.from(codes).sort();
    
    res.json({ success: true, codes: uniqueCodes });
  } catch (error) {
    console.error('코드 목록 조회 오류:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});
```

---

## 📝 상세 구현 체크리스트

### ✅ Phase 1: 데이터 수집
- [ ] 서버에서 `store.code` 필드가 정상적으로 포함되는지 확인
- [ ] 폰클출고처데이터 시트의 H열(7인덱스) 데이터 형식 확인
- [ ] 빈 값 및 null 처리 확인
- [ ] 유니크 코드 추출 로직 테스트

### ✅ Phase 2: UI 구현
- [ ] `MarkerColorSettingsModal.js` 컴포넌트 생성
- [ ] Material-UI ColorPicker 또는 TextField with type="color" 사용
- [ ] 유니크 코드 목록 API 호출 및 표시
- [ ] 색상 미리보기 구현
- [ ] 로컬스토리지 읽기/쓰기 함수 구현
- [ ] Header.js에 색상 설정 버튼 추가
- [ ] 모달 열기/닫기 상태 관리
- [ ] 저장 시 로컬스토리지 업데이트
- [ ] 저장 후 지도 새로고침 또는 마커 재렌더링

### ✅ Phase 3: 마커 색상 적용
- [ ] `createMarkerIcon` 함수에 코드별 색상 로직 추가
- [ ] 로컬스토리지에서 색상 설정 읽기
- [ ] 색상 우선순위 로직 구현 (요청점 > 사무실 > 선택 > 로그인 > 코드별 > 기존)
- [ ] strokeColor 자동 계산 (fillColor 기반)
- [ ] 코드가 없는 매장 처리 (기존 로직 유지)
- [ ] 관리자모드에서만 코드별 색상 적용 확인

### ✅ Phase 4: API 구현
- [ ] `GET /api/stores/codes` 엔드포인트 구현
- [ ] 폰클출고처데이터 시트 H열 조회
- [ ] 유니크 값 추출 및 정렬
- [ ] 에러 처리
- [ ] 캐싱 고려 (선택사항)

### ✅ Phase 5: 통합 및 테스트
- [ ] 관리자모드에서 색상 설정 버튼 표시 확인
- [ ] 모달 열기/닫기 동작 확인
- [ ] 코드 목록 정상 로드 확인
- [ ] 색상 선택 및 저장 동작 확인
- [ ] 저장된 색상이 마커에 적용되는지 확인
- [ ] 코드가 없는 매장은 기존 색상 유지 확인
- [ ] 요청점/사무실/선택된 매장 등 우선순위 확인
- [ ] 브라우저 새로고침 후 색상 유지 확인
- [ ] 다른 브라우저에서 색상이 독립적으로 저장되는지 확인

---

## 🎨 UI/UX 상세 설계

### 색상 설정 모달

**레이아웃**:
```
┌──────────────────────────────────────────────┐
│ 마커 색상 설정                    [X]       │
├──────────────────────────────────────────────┤
│                                              │
│ 코드별 색상을 설정할 수 있습니다.            │
│                                              │
│ ┌────────────────────────────────────────┐ │
│ │ VIP(경수)                               │ │
│ │ [색상선택 버튼] [색상 미리보기 박스]   │ │
│ └────────────────────────────────────────┘ │
│                                              │
│ ┌────────────────────────────────────────┐ │
│ │ VIP(호남)                               │ │
│ │ [색상선택 버튼] [색상 미리보기 박스]   │ │
│ └────────────────────────────────────────┘ │
│                                              │
│ ... (스크롤 가능)                           │
│                                              │
│ [기본값으로 초기화]  [취소]  [저장]        │
└──────────────────────────────────────────────┘
```

**컴포넌트 구조**:
- `Dialog`: 모달 컨테이너
- `DialogTitle`: "마커 색상 설정"
- `DialogContent`: 
  - 설명 텍스트
  - 코드별 색상 설정 리스트 (List 또는 Table)
- `DialogActions`: 취소/저장 버튼

**색상 선택 방법**:
- **옵션 A**: Material-UI `TextField` with `type="color"` (간단)
- **옵션 B**: Material-UI `ColorPicker` (더 많은 옵션)
- **옵션 C**: 커스텀 색상 팔레트 (미리 정의된 색상 선택)

**권장**: 옵션 A - 브라우저 기본 color picker 사용 (구현 간단, 모든 색상 선택 가능)

---

## 🔧 기술적 세부사항

### 1. 로컬스토리지 구조

**키**: `markerColorSettings`

**값 형식**:
```json
{
  "VIP(경수)": "#ff5722",
  "VIP(호남)": "#2196f3",
  "일반": "#9e9e9e"
}
```

**유틸리티 함수**:
```javascript
// src/utils/markerColorUtils.js (새로 생성)
export const getMarkerColorSettings = () => {
  try {
    const settings = localStorage.getItem('markerColorSettings');
    return settings ? JSON.parse(settings) : {};
  } catch (error) {
    console.error('색상 설정 읽기 오류:', error);
    return {};
  }
};

export const saveMarkerColorSettings = (settings) => {
  try {
    localStorage.setItem('markerColorSettings', JSON.stringify(settings));
    return true;
  } catch (error) {
    console.error('색상 설정 저장 오류:', error);
    return false;
  }
};

export const getColorForCode = (code) => {
  if (!code) return null;
  const settings = getMarkerColorSettings();
  return settings[code] || null;
};
```

---

### 2. 색상 밝기 조정

**strokeColor 계산**:
```javascript
// src/utils/colorUtils.js (새로 생성 또는 기존 파일에 추가)
export const adjustBrightness = (hex, percent) => {
  // hex를 RGB로 변환
  const num = parseInt(hex.replace('#', ''), 16);
  const r = (num >> 16) + percent;
  const g = ((num >> 8) & 0x00FF) + percent;
  const b = (num & 0x0000FF) + percent;
  
  // 0-255 범위로 제한
  const clamp = (val) => Math.min(255, Math.max(0, val));
  
  return `#${((clamp(r) << 16) | (clamp(g) << 8) | clamp(b)).toString(16).padStart(6, '0')}`;
};

// 또는 더 정확한 방법: HSL 변환 후 밝기 조정
export const darkenColor = (hex, percent) => {
  // HSL 변환 후 L(밝기) 값 감소
  // 구현 생략 (필요시 추가)
};
```

---

### 3. 마커 색상 적용 로직

**createMarkerIcon 함수 수정 위치**:
```javascript
// src/components/Map.js
// 818번째 줄 근처의 "일반 매장" 색상 결정 부분

else {
  // 코드별 색상 확인 (관리자모드에서만)
  if (isAgentMode && store.code) {
    const codeColor = getColorForCode(store.code);
    if (codeColor) {
      fillColor = codeColor;
      strokeColor = adjustBrightness(codeColor, -30); // 30% 어둡게
      radius = hasInventory ? 14 : 10;
      iconStyle = '';
      // 기존 출고일 기준 로직 건너뛰기
      return L.divIcon({...});
    }
  }
  
  // 코드별 색상이 없으면 기존 로직 (출고일 기준 색상)
  const totalFilteredInventory = inventoryByAge.within30 + inventoryByAge.within60 + inventoryByAge.over60;
  // ... 기존 코드 유지
}
```

---

### 4. 색상 설정 모달 컴포넌트 상세

**파일**: `src/components/MarkerColorSettingsModal.js`

**전체 구조**:
```javascript
import React, { useState, useEffect } from 'react';
import {
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Button,
  TextField,
  Box,
  Typography,
  List,
  ListItem,
  ListItemText,
  IconButton,
  Tooltip
} from '@mui/material';
import { API_BASE_URL } from '../api';
import { getMarkerColorSettings, saveMarkerColorSettings } from '../utils/markerColorUtils';

const MarkerColorSettingsModal = ({ open, onClose }) => {
  const [uniqueCodes, setUniqueCodes] = useState([]);
  const [colorSettings, setColorSettings] = useState({});
  const [loading, setLoading] = useState(false);

  // 유니크 코드 목록 로드
  useEffect(() => {
    if (open) {
      loadUniqueCodes();
      loadColorSettings();
    }
  }, [open]);

  const loadUniqueCodes = async () => {
    try {
      setLoading(true);
      const response = await fetch(`${API_BASE_URL}/api/stores/codes`);
      if (response.ok) {
        const data = await response.json();
        setUniqueCodes(data.codes || []);
      }
    } catch (error) {
      console.error('코드 목록 로드 오류:', error);
    } finally {
      setLoading(false);
    }
  };

  const loadColorSettings = () => {
    const settings = getMarkerColorSettings();
    setColorSettings(settings);
  };

  const handleColorChange = (code, color) => {
    setColorSettings(prev => ({
      ...prev,
      [code]: color
    }));
  };

  const handleSave = () => {
    saveMarkerColorSettings(colorSettings);
    onClose();
    // 지도 새로고침 또는 마커 재렌더링 트리거
    window.location.reload(); // 또는 더 나은 방법: 상태 업데이트로 마커 재렌더링
  };

  const handleReset = () => {
    setColorSettings({});
    saveMarkerColorSettings({});
  };

  return (
    <Dialog open={open} onClose={onClose} maxWidth="sm" fullWidth>
      <DialogTitle>마커 색상 설정</DialogTitle>
      <DialogContent>
        <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
          코드별 마커 색상을 설정할 수 있습니다.
        </Typography>
        
        <List>
          {uniqueCodes.map((code) => (
            <ListItem key={code}>
              <ListItemText primary={code} />
              <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                <TextField
                  type="color"
                  value={colorSettings[code] || '#4caf50'}
                  onChange={(e) => handleColorChange(code, e.target.value)}
                  sx={{ width: 60, height: 40 }}
                />
                <Box
                  sx={{
                    width: 40,
                    height: 40,
                    backgroundColor: colorSettings[code] || '#4caf50',
                    border: '1px solid #ccc',
                    borderRadius: 1
                  }}
                />
              </Box>
            </ListItem>
          ))}
        </List>
      </DialogContent>
      <DialogActions>
        <Button onClick={handleReset}>기본값으로 초기화</Button>
        <Button onClick={onClose}>취소</Button>
        <Button onClick={handleSave} variant="contained">저장</Button>
      </DialogActions>
    </Dialog>
  );
};

export default MarkerColorSettingsModal;
```

---

## 🚨 주의사항 및 고려사항

### 1. 성능
- 유니크 코드 목록은 한 번만 로드하고 캐싱
- 로컬스토리지 읽기는 마커 생성 시마다 발생하므로 최적화 필요
- `useMemo` 또는 `useCallback` 활용

### 2. 호환성
- 기존 마커 색상 로직과의 호환성 유지
- 코드가 없는 매장은 기존 로직 사용
- 요청점/사무실/선택된 매장 등 우선순위 유지

### 3. 사용자 경험
- 색상 설정 후 즉시 반영 (새로고침 없이)
- 색상 미리보기 제공
- 기본값 초기화 기능

### 4. 에러 처리
- 로컬스토리지 용량 초과 처리
- API 호출 실패 처리
- 잘못된 색상 값 처리

---

## 📦 파일 변경 목록

### 새로 생성할 파일
1. `src/components/MarkerColorSettingsModal.js` - 색상 설정 모달
2. `src/utils/markerColorUtils.js` - 색상 설정 유틸리티
3. `src/utils/colorUtils.js` - 색상 조정 유틸리티 (또는 기존 파일에 추가)

### 수정할 파일
1. `src/components/Header.js` - 색상 설정 버튼 추가
2. `src/components/Map.js` - `createMarkerIcon` 함수 수정
3. `server/index.js` - 유니크 코드 목록 API 추가

---

## ✅ 최종 체크리스트

### 구현 전 확인
- [ ] 폰클출고처데이터 시트의 H열 데이터 형식 확인
- [ ] 유니크 코드 예시 확인 (예: "VIP(경수)", "VIP(호남)" 등)
- [ ] 색상 저장 위치 결정 (로컬스토리지 권장)
- [ ] 기본 색상 전략 결정

### 구현 중
- [ ] 유니크 코드 목록 API 구현
- [ ] 색상 설정 모달 컴포넌트 구현
- [ ] 헤더에 버튼 추가
- [ ] 마커 색상 적용 로직 구현
- [ ] 유틸리티 함수 구현

### 구현 후 테스트
- [ ] 관리자모드에서 버튼 표시 확인
- [ ] 모달 열기/닫기 확인
- [ ] 코드 목록 로드 확인
- [ ] 색상 선택 및 저장 확인
- [ ] 마커 색상 적용 확인
- [ ] 우선순위 로직 확인
- [ ] 코드 없는 매장 처리 확인
- [ ] 브라우저 새로고침 후 유지 확인

---

## 📌 추가 질문

위의 "확인 필요 사항" 섹션에서 질문한 내용들에 대한 답변을 주시면, 더 구체적인 구현 계획을 수정하겠습니다.

특히:
1. **색상 저장 위치**: 로컬스토리지 vs 서버
2. **기본 색상**: 자동 생성 vs 팔레트 vs 없음
3. **코드 없는 매장**: 기존 로직 유지 vs 특정 색상
4. **권한**: 모든 관리자 vs 특정 권한만

답변 주시면 바로 구현을 시작하겠습니다!
