# 이미지 업로드 데이터 흐름 분석

## ⚠️ 중요: 실제 사용 현황 확인 결과

### 실제 코드 확인 결과

#### 휴대폰목록 페이지 (MobileListTab)
- **초기 로딩**: `getMobilesMaster` 사용 → `직영점_단말마스터` 시트 참조
- **이미지 업로드 후 재로딩**: `getMobileList` 사용 → `직영점_모델이미지` 시트 참조

#### 오늘의휴대폰 페이지 (TodaysMobileTab)
- **항상**: `getMobilesMaster` 사용 → `직영점_단말마스터` 시트 참조

### 결론
**사용자의 이해가 정확합니다!**

- **이미지 업로드**: `직영점_모델이미지` 시트에 최초 저장
- **이미지 표시**: 
  - 휴대폰목록 페이지 (초기): `직영점_단말마스터` 시트에서 불러옴
  - 오늘의휴대폰 페이지: `직영점_단말마스터` 시트에서 불러옴
  - 휴대폰목록 페이지 (업로드 후 재로딩): `직영점_모델이미지` 시트에서 불러옴

**따라서 두 시트 동기화가 필요한 이유**:
- 대부분의 페이지가 `직영점_단말마스터`를 참조하므로, 이미지 업로드 시 `직영점_단말마스터`도 업데이트해야 즉시 반영됨

---

## 각 시트의 역할과 데이터 흐름

### 1. 시트 구조

#### `직영점_모델이미지` 시트
- **역할**: 이미지 업로드 시 즉시 저장되는 시트 (원본 데이터)
- **컬럼**: 통신사(A) | 모델ID(B) | 모델명(C) | 펫네임(D) | 제조사(E) | 이미지URL(F) | 비고(G)
- **업데이트 시점**: 이미지 업로드 시 즉시 업데이트
- **용도**: 이미지 URL의 단일 소스 (Single Source of Truth)

#### `직영점_단말마스터` 시트
- **역할**: 통합된 단말 정보 마스터 데이터 (ETL 결과물)
- **컬럼**: 통신사(0) | 모델ID(1) | 모델명(2) | 펫네임(3) | 제조사(4) | 출고가(5) | 기본요금제군(6) | isPremium(7) | isBudget(8) | isPopular(9) | isRecommended(10) | isCheap(11) | **이미지URL(12)** | 사용여부(13) | 비고(14)
- **업데이트 시점**: `rebuildDeviceMaster` 실행 시
- **용도**: 모든 단말 정보를 통합한 마스터 데이터

### 2. API별 데이터 소스

#### `getMobileList` API
- **위치**: `server/directRoutes.js` 라인 2550
- **이미지 소스**: `직영점_모델이미지` 시트 (라인 3392-3487)
- **데이터 흐름**:
  1. 정책표 시트에서 모델명/펫네임 읽기
  2. 이통사지원금 시트에서 출고가/지원금 읽기
  3. **`직영점_모델이미지` 시트에서 이미지 URL 읽기** ← 핵심
  4. 모든 데이터를 조합하여 반환
- **사용처**: `MobileListTab` (휴대폰목록 페이지) - **이미지 업로드 후 재로딩 시에만 사용**

#### `getMobilesMaster` API
- **위치**: `server/directRoutes.js` 라인 1749
- **이미지 소스**: `직영점_단말마스터` 시트의 `imageUrl` 컬럼 (index 12)
- **데이터 흐름**:
  1. **`직영점_단말마스터` 시트를 직접 읽기** (라인 1757-1760)
  2. 시트의 `imageUrl` 컬럼에서 이미지 URL 가져오기
  3. 그대로 반환
- **사용처**: 
  - `TodaysMobileTab` (오늘의휴대폰 페이지) - **항상 사용**
  - `MobileListTab` (휴대폰목록 페이지) - **초기 로딩 시 사용**
  - `OpeningInfoPage` (개통정보입력 페이지)

#### `rebuildDeviceMaster` 함수
- **위치**: `server/directRoutes.js` 라인 427
- **역할**: `직영점_단말마스터` 시트 재생성 (ETL)
- **데이터 흐름**:
  1. `직영점_모델이미지` 시트를 읽어서 `imageMap` 생성 (라인 438-449)
  2. 정책표, 이통사지원금 등 다른 시트에서 데이터 읽기
  3. 모든 데이터를 조합하여 `직영점_단말마스터` 시트에 저장
  4. **`imageMap`의 이미지 URL을 `직영점_단말마스터`의 `imageUrl` 컬럼에 복사**

### 3. 현재 문제점

#### 문제 상황
```
이미지 업로드
  ↓
직영점_모델이미지 시트에 저장 ✅
  ↓
직영점_단말마스터 시트는 업데이트 안 됨 ❌
  ↓
휴대폰목록 페이지 (초기 로딩)
  → getMobilesMaster → 직영점_단말마스터 참조 → 재빌드 필요 ❌
  
휴대폰목록 페이지 (업로드 후 재로딩)
  → getMobileList → 직영점_모델이미지 참조 → 즉시 반영 ✅
  
오늘의휴대폰 페이지
  → getMobilesMaster → 직영점_단말마스터 참조 → 재빌드 필요 ❌
```

**핵심**: 대부분의 페이지가 `직영점_단말마스터`를 참조하므로, 이미지 업로드 시 `직영점_단말마스터`도 업데이트해야 즉시 반영됨

#### 구체적 문제
1. **`MobileListTab` (휴대폰목록 페이지)**
   - **초기 로딩**: `getMobilesMaster` 사용 → `직영점_단말마스터` 참조
   - **이미지 업로드 후 재로딩**: `getMobileList` 사용 → `직영점_모델이미지` 참조
   - **문제**: 초기 로딩 시에는 `직영점_단말마스터`를 참조하므로, 이미지 업로드 후 재빌드해야 반영됨 ❌

2. **`TodaysMobileTab` (오늘의휴대폰 페이지)**
   - `getMobilesMaster` 사용 → `직영점_단말마스터` 참조
   - **이미지 업로드 후 재빌드해야 반영됨** ❌

3. **`OpeningInfoPage` (개통정보입력 페이지)**
   - `getMobilesMaster` 사용 → `직영점_단말마스터` 참조
   - **이미지 업로드 후 재빌드해야 반영됨** ❌

### 4. 해결 방안 비교

#### Option 1: `직영점_단말마스터` 직접 업데이트 (권장)

**구현**:
- 이미지 업로드 시 `직영점_모델이미지` 저장 후
- `직영점_단말마스터` 시트의 해당 모델 행을 찾아서
- `imageUrl` 컬럼(M 컬럼, index 12)을 직접 업데이트

**장점**:
- ✅ 두 시트 모두 즉시 반영
- ✅ `getMobileList`와 `getMobilesMaster` 모두에서 즉시 반영
- ✅ 재빌드 불필요
- ✅ 데이터 일관성 유지

**단점**:
- ⚠️ 추가 API 호출 (성능 영향 미미)
- ⚠️ 모델 매칭 실패 시 업데이트 안 됨 (경고 로그만)

**필요성**: ⭐⭐⭐⭐⭐ (매우 높음)
- 사용자 요구사항(즉시 반영) 완전 만족
- 두 API 모두에서 일관된 동작 보장

#### Option 2: `getMobilesMaster`가 `직영점_모델이미지` 우선 참조

**구현**:
- `getMobilesMaster`에서 `직영점_단말마스터` 읽기
- 이미지 URL이 없거나 비어있으면 `직영점_모델이미지`에서 조회
- 우선순위: `직영점_모델이미지` > `직영점_단말마스터`

**장점**:
- ✅ 서버 API 수정 최소화
- ✅ `직영점_모델이미지`가 항상 최신

**단점**:
- ⚠️ 매번 두 시트를 읽어야 함 (성능 저하)
- ⚠️ `직영점_단말마스터`의 `imageUrl` 컬럼이 의미 없어짐
- ⚠️ 데이터 일관성 문제 (두 시트 값이 다를 수 있음)

**필요성**: ⭐⭐ (낮음)
- 임시 방편일 뿐, 근본 해결책 아님

#### Option 3: 현재 상태 유지 (재빌드 필요)

**구현**: 변경 없음

**장점**:
- ✅ 추가 작업 없음

**단점**:
- ❌ 사용자 요구사항 미충족 (즉시 반영 불가)
- ❌ `TodaysMobileTab`에서 이미지 업로드 후 재빌드 필요
- ❌ 사용자 경험 저하

**필요성**: ⭐ (매우 낮음)
- 사용자 요구사항과 맞지 않음

## 결론: 왜 두 시트 동기화가 필요한가?

### 핵심 이유

1. **API별 다른 데이터 소스 사용**
   - `getMobileList` → `직영점_모델이미지` 참조
   - `getMobilesMaster` → `직영점_단말마스터` 참조
   - **두 API가 다른 시트를 참조하므로, 두 시트 모두 최신 상태여야 함**

2. **페이지별 다른 API 사용**
   - 휴대폰목록 페이지 → `getMobileList` → 즉시 반영 ✅
   - 오늘의휴대폰 페이지 → `getMobilesMaster` → 재빌드 필요 ❌
   - **일관된 사용자 경험을 위해 두 시트 동기화 필요**

3. **데이터 일관성 유지**
   - `직영점_단말마스터`는 ETL 결과물이지만, 이미지 URL은 실시간 업데이트 필요
   - 재빌드 전까지 두 시트의 이미지 URL이 다를 수 있음
   - **데이터 일관성을 위해 동기화 필요**

4. **사용자 요구사항**
   - "업로드하면 바로 표시되게 하고 싶다"
   - 재빌드 없이 모든 페이지에서 즉시 반영되어야 함
   - **두 시트 동기화로 모든 페이지에서 즉시 반영 가능**

### 최종 권장 사항

**Option 1 (직영점_단말마스터 직접 업데이트)를 권장합니다.**

**이유**:
1. 사용자 요구사항 완전 만족 (즉시 반영)
2. 모든 API에서 일관된 동작 보장
3. 데이터 일관성 유지
4. 재빌드 불필요로 사용자 경험 향상

**구현 비용**: 낮음 (약 50줄 코드 추가)
**효과**: 매우 높음 (사용자 경험 대폭 개선)

