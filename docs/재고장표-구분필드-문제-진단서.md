# 재고장표 구분 필드 문제 진단서

## 문제 상황

장표모드 > 재고장표에서 다음과 같은 문제가 발생하고 있습니다:

1. **구분 필드에 #N/A 에러 표시**
   - 정상: 삼성, 애플, 기타
   - 비정상: `#N/A (Did not find value 'C4920' in VLOOKUP evaluation.)`

2. **유심이 휴대폰과 함께 표시됨**
   - 휴대폰만 필터링되어야 하는데 유심도 함께 리스트에 존재

## 원인 분석

### 1. 데이터 흐름 추적

```
Google Sheets (폰클재고데이터) 
  ↓ E열: 종류 (휴대폰/유심/워치/TAB)
  ↓ F열: 구분 (VLOOKUP 함수 → 삼성/애플/기타)
  ↓
Backend API (/api/inventory/status)
  ↓ row[4]: modelType 추출 (E열)
  ↓ row[5]: category 추출 (F열)
  ↓
Frontend (InventoryStatusScreen)
  ↓ 구분별 정렬 및 표시
```

### 2. 코드 분석

**Backend (server/index.js:30154)**
```javascript
const category = (row[5] || '').toString().trim(); // F열: 구분
```

**Frontend (src/components/screens/InventoryStatusScreen.js:78)**
```javascript
const categoryOrder = { '삼성': 1, '애플': 2, '기타': 3, '2ND': 4 };
const aOrder = categoryOrder[a.category] || 5;
```

**필터링 로직 (server/index.js:30165)**
```javascript
if (modelName && category !== '#N/A') {
  validModels++;
  // ...
}
```

### 3. 문제의 근본 원인

#### 원인 1: Google Sheets VLOOKUP 실패
- **폰클재고데이터** 시트의 F열에 VLOOKUP 함수가 있음
- 일부 모델 코드(예: 'C4920')가 참조 시트(운영모델)에 존재하지 않음
- VLOOKUP 실패 시 `#N/A` 에러 반환

#### 원인 2: 유심 필터링 누락
- 현재 코드는 `category !== '#N/A'`만 체크
- E열(종류)을 사용하여 휴대폰/유심/워치/TAB을 구분해야 하는데 필터링 로직이 없음
- 유심, 워치, TAB 등이 모두 표시되고 있음

## 영향을 받는 데이터

### 코드 변경 이력 확인 결과

**최근 일주일 내 재고장표 API 코드 수정 없음**
- 재고장표 API (`/api/inventory/status`)는 2024년 8월 3일 생성 이후 수정되지 않음
- 코드는 처음부터 E열(종류) 필터링 로직이 없었음
- 코드는 처음부터 `category !== '#N/A'` 조건만 있었음 (제외 처리)

**결론: 문제는 Google Sheets 데이터 변경에서 발생**

### 의심되는 변경 사항 (일주일 이내)

1. **Google Sheets 변경**
   - 폰클재고데이터 시트의 F열 VLOOKUP 수식 변경 또는 삭제
   - 운영모델 시트에서 모델 데이터 삭제 또는 변경
   - VLOOKUP 참조 범위 변경 (예: `운영모델!$C:$D` → 다른 범위)
   - 새로운 모델 추가 시 참조 데이터 미업데이트

2. **재고관리모드에서 마스터재고검수 업로드**
   - 최근 업로드된 데이터에 새로운 모델 코드 포함
   - 해당 모델이 운영모델 시트에 없음
   - VLOOKUP 실패로 #N/A 에러 발생

3. **운영모델 시트 데이터 정리 작업**
   - 기존 모델 데이터가 삭제되거나 이동됨
   - 컬럼 구조 변경 (C열, D열 위치 변경)
   - 시트 이름 변경 또는 삭제

### Google Sheets 확인 방법

#### 1. 폰클재고데이터 시트 F열 수식 확인
```
1. 폰클재고데이터 시트 열기
2. F2 셀 클릭 (또는 #N/A 에러가 있는 셀)
3. 수식 확인:
   - 정상: =IFERROR(VLOOKUP(N2, 운영모델!$C:$D, 2, FALSE), "기타")
   - 또는: =VLOOKUP(N2, 운영모델!$C:$D, 2, FALSE)
4. 참조 범위가 올바른지 확인
```

#### 2. 운영모델 시트 데이터 확인
```
1. 운영모델 시트 열기
2. C열에 모델명이 있는지 확인
3. D열에 구분(삼성/애플/기타)이 있는지 확인
4. #N/A 에러가 발생한 모델명(예: C4920)이 C열에 있는지 검색
```

#### 3. 최근 변경 이력 확인
```
1. Google Sheets 메뉴 > 파일 > 버전 기록 > 버전 기록 보기
2. 최근 일주일 내 변경 사항 확인
3. 폰클재고데이터 시트와 운영모델 시트의 변경 사항 비교
```

## 해결 방안

### 즉시 조치 (Google Sheets)

#### 1. VLOOKUP 에러 수정

**폰클재고데이터 시트 F열 수식 확인:**
```excel
=IFERROR(VLOOKUP(N2, 운영모델!$C:$D, 2, FALSE), "기타")
```

현재 수식이 다음과 같다면:
```excel
=VLOOKUP(N2, 운영모델!$C:$D, 2, FALSE)
```

다음으로 변경:
```excel
=IFERROR(VLOOKUP(N2, 운영모델!$C:$D, 2, FALSE), "기타")
```

**설명:**
- `IFERROR` 함수로 VLOOKUP 실패 시 "기타"로 표시
- `#N/A` 에러 대신 유효한 값 반환

#### 2. 운영모델 시트 업데이트

**누락된 모델 추가:**
1. 폰클재고데이터에서 `#N/A` 에러가 있는 모델명 확인
2. 운영모델 시트에 해당 모델 추가
   - A열: 구분 (휴대폰/유심/워치/TAB)
   - C열: 모델명
   - D열: 구분 (삼성/애플/기타)

**예시:**
| A열(구분) | B열(순서) | C열(모델명) | D열(구분) |
|-----------|-----------|-------------|-----------|
| 휴대폰    | 1         | C4920       | 삼성      |
| 유심      | 999       | USIM-001    | 기타      |

### 백엔드 코드 개선

#### 1. 유심 필터링 추가

**현재 코드 (server/index.js:30150-30170):**
```javascript
const category = (row[5] || '').toString().trim(); // F열: 구분

if (modelName && category !== '#N/A') {
  validModels++;
  // ...
}
```

**개선된 코드:**
```javascript
const category = (row[5] || '').toString().trim(); // F열: 구분
const modelType = (row[4] || '').toString().trim(); // E열: 종류 (휴대폰/유심/워치)

// 휴대폰만 필터링 + #N/A 제외
if (modelName && category !== '#N/A' && modelType === '휴대폰') {
  validModels++;
  // ...
}
```

#### 2. 에러 처리 강화

```javascript
// #N/A 에러를 "기타"로 변환
const category = (() => {
  const rawCategory = (row[5] || '').toString().trim();
  if (rawCategory.includes('#N/A') || rawCategory.includes('ERROR')) {
    console.warn(`⚠️ [재고장표] VLOOKUP 에러 발견: 모델=${modelName}, 원본값=${rawCategory}`);
    return '기타';
  }
  return rawCategory;
})();
```

### 프론트엔드 코드 개선

#### 1. 에러 값 필터링

**현재 코드 (src/components/screens/InventoryStatusScreen.js:78):**
```javascript
const categoryOrder = { '삼성': 1, '애플': 2, '기타': 3, '2ND': 4 };
const aOrder = categoryOrder[a.category] || 5;
```

**개선된 코드:**
```javascript
// #N/A 에러 값을 "기타"로 정규화
const normalizeCategory = (cat) => {
  if (!cat || cat.includes('#N/A') || cat.includes('ERROR')) {
    return '기타';
  }
  return cat;
};

const categoryOrder = { '삼성': 1, '애플': 2, '기타': 3, '2ND': 4 };
const aOrder = categoryOrder[normalizeCategory(a.category)] || 5;
const bOrder = categoryOrder[normalizeCategory(b.category)] || 5;
```

## 구현 우선순위

### 1단계: 긴급 조치 (즉시)
- [ ] Google Sheets 전산마스터재고 F열 수식에 IFERROR 추가
- [ ] 운영모델 시트에 누락된 모델 추가

### 2단계: 백엔드 개선 (1-2일)
- [ ] 유심 필터링 로직 추가 (E열 종류 필드 활용)
- [ ] #N/A 에러 자동 변환 로직 추가
- [ ] 에러 로깅 강화

### 3단계: 프론트엔드 개선 (1-2일)
- [ ] 구분 값 정규화 함수 추가
- [ ] 에러 값 표시 개선
- [ ] 유심/워치 필터 옵션 추가

## 검증 방법

### 1. Google Sheets 수정 후 확인
```
1. 폰클재고데이터 시트 열기
2. F열 수식 확인 (IFERROR 포함 여부)
3. #N/A 에러가 있던 행 확인
4. "기타"로 표시되는지 확인
```

### 2. 백엔드 API 테스트
```bash
# 재고 데이터 조회
curl http://localhost:4000/api/inventory/status

# 응답에서 category 필드 확인
# - #N/A 값이 없어야 함
# - 유심이 포함되지 않아야 함
```

### 3. 프론트엔드 확인
```
1. 장표모드 > 재고장표 접속
2. 구분 컬럼 확인
   - 삼성, 애플, 기타, 2ND만 표시
   - #N/A 에러 없음
3. 모델 목록 확인
   - 휴대폰만 표시
   - 유심 미표시
```

## 예방 조치

### 1. 데이터 검증 자동화
- 마스터재고검수 업로드 시 모델 코드 검증
- 운영모델 시트에 없는 모델 자동 감지
- 관리자에게 알림 전송

### 2. VLOOKUP 대신 INDEX-MATCH 사용
```excel
=IFERROR(INDEX(운영모델!$D:$D, MATCH(N2, 운영모델!$C:$C, 0)), "기타")
```

### 3. 정기 점검
- 주 1회: 전산마스터재고 #N/A 에러 확인
- 월 1회: 운영모델 시트 업데이트 확인
- 분기 1회: 데이터 정합성 전체 점검

## 참고 자료

### 관련 파일
- Backend: `server/index.js` (라인 30116-30450)
- Frontend: `src/components/screens/InventoryStatusScreen.js`
- API: `src/api.js` (inventoryAPI)

### Google Sheets
- 폰클재고데이터 (E열: 종류, F열: 구분)
- 운영모델 (A열: 구분, C열: 모델명, D열: 구분)

### 관련 이슈
- 재고관리모드 마스터재고검수 업로드
- 운영모델 시트 데이터 동기화

---

**작성일:** 2026-01-24  
**작성자:** Kiro AI  
**문서 버전:** 1.0
