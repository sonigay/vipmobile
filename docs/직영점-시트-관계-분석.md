# 직영점_모델이미지 vs 직영점_단말마스터 시트 관계 분석

## 📊 두 시트의 역할

### 1. 직영점_모델이미지 (원본 저장소)
- **역할**: 이미지 데이터의 **원본 저장소**
- **용도**: 이미지 업로드 시 직접 저장되는 시트
- **컬럼 구조** (A:K):
  - 통신사(A) | 모델ID(B) | 모델명(C) | 펫네임(D) | 제조사(E) 
  - 이미지URL(F) | 비고(G) | 색상(H) 
  - Discord메시지ID(I) | Discord포스트ID(J) | Discord스레드ID(K)

### 2. 직영점_단말마스터 (통합 마스터 데이터)
- **역할**: 단말 마스터 데이터의 **통합 저장소**
- **용도**: 모든 단말 정보를 통합하여 저장 (이미지 URL 포함)
- **컬럼 구조** (A:R):
  - 통신사(A) | 모델ID(B) | 모델명(C) | 펫네임(D) | 제조사(E)
  - 출고가(F) | 기본요금제군(G) | isPremium(H) | isBudget(I) | isPopular(J) | isRecommended(K) | isCheap(L)
  - **이미지URL(M)** | 사용여부(N) | 비고(O)
  - **Discord메시지ID(P)** | **Discord포스트ID(Q)** | **Discord스레드ID(R)**

## 🔄 두 시트의 관계

### 관계 구조
```
직영점_모델이미지 (원본)
    ↓
직영점_단말마스터 (통합)
```

### 데이터 흐름

#### 1. 이미지 업로드 시 (즉시 동기화)
```
사용자가 이미지 업로드
    ↓
Discord에 업로드 ✅
    ↓
직영점_모델이미지 시트에 저장 ✅
    ↓
직영점_단말마스터 시트에도 즉시 업데이트 ✅
```

**코드 위치**: `server/index.js` (라인 6353-6530)
- 먼저 `직영점_모델이미지`에 저장
- 저장 성공 시 `직영점_단말마스터`에도 동시에 업데이트

#### 2. rebuildDeviceMaster 실행 시 (일괄 동기화)
```
rebuildDeviceMaster 함수 실행
    ↓
직영점_모델이미지 시트 읽기
    ↓
imageMap 생성 (Carrier+ModelCode → ImageURL)
    ↓
직영점_단말마스터 시트 재빌드
    ↓
imageMap의 이미지 URL을 단말마스터에 반영
```

**코드 위치**: `server/directRoutes.js` (라인 449-737)
- `rebuildDeviceMaster` 함수에서 `직영점_모델이미지` 시트를 읽어서
- `imageMap`을 생성하고
- 단말마스터 재빌드 시 이미지 URL을 매핑

## 💾 URL 저장 방식

### 직영점_모델이미지
- **저장 시점**: 이미지 업로드 시 **즉시 저장**
- **저장 방식**: 
  - 기존 행이 있으면 업데이트
  - 없으면 새 행 추가
- **데이터**: 이미지 관련 정보만 저장 (이미지 URL, Discord 정보, 색상 등)

### 직영점_단말마스터
- **저장 시점**: 
  1. 이미지 업로드 시 **즉시 동기화** (개선됨)
  2. `rebuildDeviceMaster` 실행 시 **일괄 동기화**
- **저장 방식**:
  - 이미지 업로드 시: 기존 행 찾아서 이미지 URL만 업데이트
  - rebuildDeviceMaster 시: 전체 시트 재빌드하며 이미지 URL 매핑
- **데이터**: 단말 전체 정보 + 이미지 URL 포함

## 🔍 코드 분석

### 이미지 업로드 시 (server/index.js)

```javascript
// 1. 직영점_모델이미지에 먼저 저장
await rateLimitedSheetsCall(() =>
  sheets.spreadsheets.values.update({
    range: `직영점_모델이미지!A${existingRowIndex + 2}:K${existingRowIndex + 2}`,
    ...
  })
);

// 2. 직영점_단말마스터에도 즉시 업데이트 (개선됨)
if (sheetSaveSuccess) {
  const updatedRow = [...existingMasterRow];
  updatedRow[12] = imageUrl;  // M: 이미지URL
  updatedRow[15] = discordResult.messageId || '';  // P: Discord메시지ID
  updatedRow[16] = discordResult.postId || '';     // Q: Discord포스트ID
  updatedRow[17] = discordResult.threadId || '';   // R: Discord스레드ID
  
  await rateLimitedSheetsCall(() =>
    sheets.spreadsheets.values.update({
      range: `직영점_단말마스터!A${targetRowNumber}:R${targetRowNumber}`,
      ...
    })
  );
}
```

### rebuildDeviceMaster 시 (server/directRoutes.js)

```javascript
// 1. 직영점_모델이미지 시트 읽기
const imagesRes = await withRetry(async () => {
  return await sheets.spreadsheets.values.get({ 
    range: `${SHEET_MOBILE_IMAGES}!A:K` 
  });
});

// 2. imageMap 생성
const imageMap = new Map(); // Key: Carrier+ModelCode -> ImageURL
for (const row of imageRows) {
  const c = (row[0] || '').toString().trim().toUpperCase();
  const code = normalizeModelCode(row[1] || row[2]);
  const url = (row[5] || '').toString().trim();
  if (c && code && url) {
    imageMap.set(`${c}:${code}`, url);
  }
}

// 3. 단말마스터 재빌드 시 imageMap에서 이미지 URL 매핑
const imageUrl = imageMap.get(`${carrier}:${normalizedCode}`) || '';
```

## 📋 데이터 조회 시

### getMobileList API (server/directRoutes.js)
- **이미지 URL 조회**: `직영점_모델이미지` 시트에서 조회
- **이유**: 이미지 전용 시트이므로 조회가 빠르고 효율적
- **코드**: 라인 3458-3551
  ```javascript
  const [imageRes, todaysRes] = await Promise.all([
    sheets.spreadsheets.values.get({
      range: '직영점_모델이미지!A:K'
    }),
    ...
  ]);
  ```

## 🎯 핵심 정리

### 두 시트의 관계
1. **직영점_모델이미지**: 이미지 데이터의 **원본 저장소**
   - 이미지 업로드 시 직접 저장
   - 이미지 관련 정보만 저장 (전문성)

2. **직영점_단말마스터**: 단말 정보의 **통합 마스터 데이터**
   - 단말 전체 정보 + 이미지 URL 포함
   - 이미지 업로드 시 즉시 동기화 (개선됨)
   - rebuildDeviceMaster 실행 시 일괄 동기화

### URL 저장 방식
- **직영점_모델이미지**: 이미지 업로드 시 즉시 저장 (원본)
- **직영점_단말마스터**: 
  - 이미지 업로드 시 즉시 동기화 (개선됨) ✅
  - rebuildDeviceMaster 실행 시 일괄 동기화

### 데이터 일관성
- **이미지 업로드 시**: 두 시트 모두 즉시 업데이트 (일관성 유지)
- **rebuildDeviceMaster 시**: 직영점_모델이미지 → 직영점_단말마스터로 동기화
- **데이터 조회 시**: 주로 직영점_모델이미지에서 조회 (효율성)

## ⚠️ 주의사항

1. **직영점_모델이미지가 원본**
   - 이미지 업로드 시 먼저 저장
   - rebuildDeviceMaster는 이 시트를 읽어서 동기화

2. **직영점_단말마스터는 통합 데이터**
   - 단말 전체 정보를 포함
   - 이미지 URL은 직영점_모델이미지에서 가져옴

3. **동기화 타이밍**
   - 이미지 업로드 시: 즉시 동기화 (개선됨)
   - rebuildDeviceMaster 실행 시: 일괄 동기화

