# 휴대폰 시세표 데이터 로딩 문제 해결 가이드

## 🔍 문제 증상
- 직영점 모드 > 휴대폰시세표 탭에서 데이터가 표시되지 않음
- "데이터를 불러오는 중 오류가 발생했습니다" 에러 메시지

## 🎯 즉시 해결 방법

### 1단계: 브라우저 캐시 삭제
1. 브라우저에서 `F12` 키를 눌러 개발자 도구 열기
2. `Application` 탭 > `Storage` > `Clear site data` 클릭
3. 페이지 새로고침 (`Ctrl + F5`)

### 2단계: 서버 캐시 초기화
서버 관리자 콘솔에서 다음 명령 실행:
```bash
# PM2로 실행 중인 경우
pm2 restart vipmobile-server

# 또는 직접 실행 중인 경우
# 서버를 중지하고 다시 시작
```

### 3단계: 마스터 데이터 재빌드
1. 직영점 관리 모드 접속
2. "링크설정" 탭 이동
3. 해당 통신사(SK/KT/LG) 선택
4. "시세표 갱신" 버튼 클릭

또는 API를 직접 호출:
```bash
# SK 통신사 마스터 데이터 재빌드
curl -X POST "https://your-server.com/api/direct/rebuild-master?carrier=SK"

# 모든 통신사 재빌드
curl -X POST "https://your-server.com/api/direct/rebuild-master"
```

## 🔧 근본 원인 진단

### 원인 1: 링크설정 시트 데이터 누락
**확인 방법:**
1. Google Sheets에서 "직영점_설정" 시트 열기
2. 해당 통신사의 `support` 설정 행 확인
3. "시트ID" 컬럼에 올바른 시트 ID가 입력되어 있는지 확인
4. "설정값JSON" 컬럼에 다음 형식의 JSON이 있는지 확인:
```json
{
  "modelRange": "전체!A5:A500",
  "factoryPriceRange": "전체!C5:C500",
  "planGroupRanges": {
    "115군": "전체!D5:D500",
    "33군": "전체!E5:E500"
  }
}
```

**해결 방법:**
- 시트 ID가 비어있으면 올바른 시트 ID 입력
- JSON 형식이 잘못되었으면 수정

### 원인 2: 외부 시트 접근 권한 문제
**확인 방법:**
1. 링크설정에서 참조하는 외부 시트(이통사 지원금 시트) 열기
2. 시트 공유 설정 확인
3. 서비스 계정 이메일이 "편집자" 또는 "뷰어" 권한으로 추가되어 있는지 확인

**해결 방법:**
- 시트 우측 상단 "공유" 버튼 클릭
- 서비스 계정 이메일 추가 (환경변수 `GOOGLE_SERVICE_ACCOUNT_EMAIL` 값)
- 권한을 "뷰어" 이상으로 설정

### 원인 3: 외부 시트 데이터 형식 문제
**확인 방법:**
1. 외부 시트에서 링크설정의 `modelRange`에 해당하는 범위 확인
2. 첫 번째 행이 헤더인지 확인
3. 모델명이 비어있는 행이 많은지 확인

**해결 방법:**
- 첫 번째 행을 헤더로 유지 (예: "모델명", "출고가" 등)
- 빈 행 제거 또는 최소화
- 모델명이 정확히 입력되어 있는지 확인

### 원인 4: Google Sheets API Rate Limit
**증상:**
- 여러 통신사 데이터를 동시에 로딩할 때 일부만 로딩됨
- 서버 로그에 "429" 또는 "RESOURCE_EXHAUSTED" 에러

**해결 방법:**
- 잠시 기다린 후 다시 시도 (1-2분)
- 한 번에 하나의 통신사만 로딩
- 서버 코드에서 이미 Rate Limit 방지 로직이 적용되어 있으므로, 시간이 지나면 자동으로 해결됨

## 📊 서버 로그 확인

서버 로그에서 다음 메시지를 확인:

### 정상 로딩 로그:
```
🔍 [getLinkSettings] SK 링크설정 읽기 시작
✅ [getLinkSettings] SK 링크설정 읽기 완료
🔍 [rebuildPricingMaster] SK 정책 설정 로딩 시작...
✅ [rebuildPricingMaster] SK 정책 설정 로딩 완료
```

### 에러 로그:
```
❌ [getSheetData] 시트 데이터 읽기 실패
❌ [rebuildPricingMaster] SK 정책 설정을 불러올 수 없습니다.
```

## 🚀 예방 조치

1. **정기적인 마스터 데이터 재빌드**
   - 매일 오전 한 번씩 자동으로 재빌드되도록 cron 설정
   - 또는 수동으로 주 1회 재빌드

2. **링크설정 백업**
   - 링크설정 시트를 정기적으로 백업
   - 설정값JSON을 별도 문서에 보관

3. **외부 시트 권한 관리**
   - 서비스 계정 권한이 유지되는지 정기 확인
   - 시트 소유자 변경 시 권한 재설정

## 📞 추가 지원

위 방법으로 해결되지 않는 경우:
1. 브라우저 개발자 도구 > Console 탭에서 에러 메시지 확인
2. 서버 로그 전체 내용 확인
3. 관리자에게 문의 (에러 메시지와 함께)
