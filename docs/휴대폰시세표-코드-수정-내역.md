# 휴대폰 시세표 데이터 로딩 개선 - 코드 수정 내역

## 📅 수정 일시
2025-01-24

## 🎯 수정 목적
직영점 모드에서 휴대폰 시세표 데이터를 불러오지 못하는 문제 해결

## 🔧 주요 수정 사항

### 1. `server/directRoutes.js` - `getSheetData` 함수 개선

**위치:** 약 2063번째 줄

**수정 내용:**
- 에러 핸들링 강화
- 사용자 친화적인 에러 메시지 추가
- 권한 오류, 시트 없음 등 구체적인 에러 처리
- 개발 환경에서 디버그 로그 추가

**주요 변경점:**
```javascript
// 이전: 단순 에러 throw
throw new Error(`시트 데이터 읽기 실패: ${error.message}`);

// 이후: 구체적인 에러 메시지
if (error.message && error.message.includes('Requested entity was not found')) {
  throw new Error(`시트를 찾을 수 없습니다. 링크설정에서 시트 ID를 확인해주세요: ${sheetId.substring(0, 15)}...`);
} else if (error.message && error.message.includes('The caller does not have permission')) {
  throw new Error(`시트 접근 권한이 없습니다. 시트 공유 설정을 확인해주세요: ${sheetId.substring(0, 15)}...`);
}
```

### 2. `server/directRoutes.js` - `getLinkSettings` 함수 로깅 추가

**위치:** 약 488번째 줄

**수정 내용:**
- 링크설정 읽기 시작/완료 로그 추가
- 통신사별 설정 개수 및 유형 확인 로그

**추가된 로그:**
```javascript
console.log(`🔍 [getLinkSettings] ${carrier} 링크설정 읽기 시작`, {
  SPREADSHEET_ID: SPREADSHEET_ID ? `${SPREADSHEET_ID.substring(0, 10)}...` : 'undefined',
  sheetName: SHEET_SETTINGS
});

console.log(`✅ [getLinkSettings] ${carrier} 링크설정 읽기 완료`, {
  전체행수: allRows.length,
  데이터행수: linkSettingsRows.length,
  해당통신사설정수: carrierSettings.length,
  설정유형: carrierSettings.map(row => row[1]).join(', ')
});
```

### 3. `server/directRoutes.js` - `rebuildPricingMaster` 함수 개선

**위치:** 약 1170번째 줄

**수정 내용:**
- 정책 설정 로딩 전후 상세 로그 추가
- `policySettings` null 체크 강화
- 안전한 정책 설정 객체 생성 및 로그

**추가된 로그:**
```javascript
console.log(`🔍 [rebuildPricingMaster] ${carrier} 정책 설정 로딩 시작...`);
const policySettings = await getPolicySettings(carrier);
console.log(`✅ [rebuildPricingMaster] ${carrier} 정책 설정 로딩 완료:`, {
  baseMargin: policySettings?.baseMargin,
  addonListLength: policySettings?.addonList?.length || 0,
  insuranceListLength: policySettings?.insuranceList?.length || 0,
  specialPoliciesLength: policySettings?.specialPolicies?.length || 0
});
```

### 4. `server/directRoutes.js` - `getPolicySettings` 함수 로깅 강화

**위치:** 약 390번째 줄

**수정 내용:**
- 정책 마진 읽기 시 상세 로그 추가
- 모든 통신사의 마진 데이터 확인 로그

**추가된 로그:**
```javascript
console.log(`[Direct][getPolicySettings] ${carrier} 정책마진 읽기:`, {
  sheetName: SHEET_POLICY_MARGIN,
  allRowsCount: allMarginRows.length,
  marginRowsCount: marginRows.length,
  foundRow: marginRow ? true : false,
  marginRowData: marginRow ? { /* 상세 정보 */ } : null,
  finalBaseMargin: baseMargin,
  allCarriers: marginRows.map((r, idx) => ({ /* 모든 통신사 정보 */ }))
});
```

## 🐛 버그 수정

### 버그 1: `getSheetData` 함수의 헤더 처리 불일치
**문제:** 외부 시트를 읽을 때 헤더가 있는지 없는지 불명확하여 데이터 인덱스가 밀리는 문제

**해결:** 
- `getSheetData` 함수는 항상 첫 번째 행(헤더)을 제거하고 반환
- 주석으로 명확히 표시
- 외부 시트는 반드시 첫 번째 행에 헤더가 있어야 함

### 버그 2: 에러 메시지가 사용자 친화적이지 않음
**문제:** "시트 데이터 읽기 실패" 같은 모호한 에러 메시지

**해결:**
- 에러 유형별로 구체적인 메시지 제공
- 시트 ID 일부를 포함하여 어떤 시트에서 문제가 발생했는지 명확히 표시
- 해결 방법 힌트 제공 (예: "링크설정에서 시트 ID를 확인해주세요")

## 📊 로그 출력 예시

### 정상 작동 시:
```
🔍 [getLinkSettings] SK 링크설정 읽기 시작 { SPREADSHEET_ID: '1abc2def3g...', sheetName: '직영점_설정' }
✅ [getLinkSettings] SK 링크설정 읽기 완료 { 전체행수: 10, 데이터행수: 9, 해당통신사설정수: 3, 설정유형: 'planGroup, support, policy' }
🔍 [rebuildPricingMaster] SK 정책 설정 로딩 시작...
[Direct][getPolicySettings] SK 정책마진 읽기: { sheetName: '직영점_정책_마진', allRowsCount: 4, marginRowsCount: 3, foundRow: true, finalBaseMargin: 50000 }
✅ [rebuildPricingMaster] SK 정책 설정 로딩 완료: { baseMargin: 50000, addonListLength: 5, insuranceListLength: 3, specialPoliciesLength: 2 }
📊 [rebuildPricingMaster] SK 안전한 정책 설정: { baseMargin: 50000, addonList: [Array], insuranceList: [Array], specialPolicies: [Array] }
```

### 에러 발생 시:
```
🔍 [getLinkSettings] SK 링크설정 읽기 시작 { SPREADSHEET_ID: '1abc2def3g...', sheetName: '직영점_설정' }
❌ [getSheetData] 시트 데이터 읽기 실패: { sheetId: '1xyz9876543...', range: '전체!A5:A500', error: 'Requested entity was not found', code: 404 }
❌ [rebuildPricingMaster] SK 정책 설정을 불러올 수 없습니다.
```

## 🧪 테스트 방법

### 1. 로컬 테스트
```bash
# 서버 디렉토리로 이동
cd server

# 개발 모드로 서버 실행
npm run dev

# 브라우저에서 직영점 모드 접속
# 휴대폰시세표 탭 클릭
# 서버 콘솔에서 로그 확인
```

### 2. API 직접 테스트
```bash
# 단말 마스터 조회
curl "http://localhost:4000/api/direct/mobiles-master?carrier=SK"

# 요금제 마스터 조회
curl "http://localhost:4000/api/direct/plans-master?carrier=SK"

# 단말 요금정책 조회
curl "http://localhost:4000/api/direct/mobiles-pricing?carrier=SK"

# 마스터 데이터 재빌드
curl -X POST "http://localhost:4000/api/direct/rebuild-master?carrier=SK"
```

## 🔄 배포 절차

### 1. 코드 커밋
```bash
git add server/directRoutes.js
git commit -m "fix: 휴대폰 시세표 데이터 로딩 개선 - 에러 핸들링 및 로깅 강화"
git push origin main
```

### 2. 서버 배포
- Cloudtype 자동 배포 대기 (약 2-3분)
- 또는 수동 배포 트리거

### 3. 배포 후 확인
- 서버 로그에서 에러 없이 시작되는지 확인
- 직영점 모드 접속하여 휴대폰시세표 데이터 로딩 확인
- 각 통신사(SK, KT, LG) 모두 테스트

## 📝 추가 개선 사항 (향후)

1. **캐시 무효화 API 추가**
   - 관리자가 수동으로 캐시를 삭제할 수 있는 API
   - 링크설정 변경 시 자동으로 관련 캐시 삭제

2. **헬스 체크 API 개선**
   - 링크설정 유효성 검사
   - 외부 시트 접근 가능 여부 확인
   - 정책 설정 로딩 상태 확인

3. **프론트엔드 에러 메시지 개선**
   - 서버에서 반환하는 구체적인 에러 메시지를 그대로 표시
   - 해결 방법 힌트 제공

4. **자동 재시도 로직**
   - Rate Limit 에러 발생 시 자동으로 재시도
   - 지수 백오프(Exponential Backoff) 적용

## 🔗 관련 문서
- [휴대폰시세표 데이터 로딩 문제 해결 가이드](./휴대폰시세표-데이터-로딩-문제-해결가이드.md)
- [개발자 가이드](./개발자가이드.md)
- [배포 가이드](./배포가이드.md)
