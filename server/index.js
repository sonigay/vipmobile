require('dotenv').config();
const express = require('express');
const cors = require('cors');
const multer = require('multer');
const fs = require('fs');
const path = require('path');
const { Readable } = require('stream');
const { google } = require('googleapis');
const NodeGeocoder = require('node-geocoder');
const webpush = require('web-push');
const ExcelJS = require('exceljs');
const cron = require('node-cron');
const monthlyAwardAPI = require('./monthlyAwardAPI');
const setupTeamRoutes = require('./teamRoutes');
const UserSheetManager = require('./UserSheetManager');
const PhoneklDataManager = require('./PhoneklDataManager');
const setupObRoutes = require('./obRoutes');
const meetingRoutes = require('./meetingRoutes');
const setupDirectRoutes = require('./directRoutes');

// ê¸°ë³¸ ì„¤ì •
const app = express();
const port = process.env.PORT || 4000;

// Google Sheets API í˜¸ì¶œ ë¹ˆë„ ì œí•œì„ ìœ„í•œ ë³€ìˆ˜
let lastSheetsApiCall = 0;
const SHEETS_API_COOLDOWN = 2000; // 2ì´ˆ ëŒ€ê¸° (Google Sheets API ë¶„ë‹¹ 60íšŒ ì œí•œ ê³ ë ¤)

// Google Sheets API í˜¸ì¶œ ë¹ˆë„ ì œí•œ í•¨ìˆ˜ (Rate Limit ì¬ì‹œë„ í¬í•¨)
const rateLimitedSheetsCall = async (apiCall, maxRetries = 5) => {
  // ê¸°ë³¸ Rate Limiting: ìµœì†Œ ê°„ê²© ìœ ì§€
  const now = Date.now();
  const timeSinceLastCall = now - lastSheetsApiCall;

  if (timeSinceLastCall < SHEETS_API_COOLDOWN) {
    const waitTime = SHEETS_API_COOLDOWN - timeSinceLastCall;
    console.log(`Google Sheets API í˜¸ì¶œ ë¹ˆë„ ì œí•œ: ${waitTime}ms ëŒ€ê¸°`);
    await new Promise(resolve => setTimeout(resolve, waitTime));
  }

  lastSheetsApiCall = Date.now();

  // Rate Limit ì˜¤ë¥˜ ì¬ì‹œë„ ë¡œì§
  for (let attempt = 0; attempt < maxRetries; attempt++) {
    try {
      return await apiCall();
    } catch (error) {
      // Rate Limit ì˜¤ë¥˜ ê°ì§€
      const isRateLimitError =
        error.code === 429 ||
        (error.response && error.response.status === 429) ||
        (error.response && error.response.data && error.response.data.error &&
          (error.response.data.error.status === 'RESOURCE_EXHAUSTED' ||
            (error.response.data.error.message && error.response.data.error.message.includes('Quota exceeded')))) ||
        (error.message && (
          error.message.includes('Quota exceeded') ||
          error.message.includes('RESOURCE_EXHAUSTED') ||
          error.message.includes('429') ||
          error.message.includes('rateLimitExceeded')
        ));

      if (isRateLimitError && attempt < maxRetries - 1) {
        // Exponential backoff with jitter (ëœë¤ ì§€ì—° ì¶”ê°€ë¡œ ë™ì‹œ ìš”ì²­ ë¶„ì‚°)
        const jitter = Math.random() * 2000; // 0~2ì´ˆ ëœë¤
        const baseDelay = 3000; // 3ì´ˆ ê¸°ë³¸ ì§€ì—°
        const delay = baseDelay * Math.pow(2, attempt) + jitter;
        const waitTime = Math.min(delay, 60000); // ìµœëŒ€ 60ì´ˆ

        console.warn(`âš ï¸ [Sheets API] Rate limit ì˜¤ë¥˜ ë°œìƒ, ${Math.round(waitTime)}ms í›„ ì¬ì‹œë„ (${attempt + 1}/${maxRetries})`);
        await new Promise(resolve => setTimeout(resolve, waitTime));
        continue;
      }

      // Rate Limit ì˜¤ë¥˜ê°€ ì•„ë‹ˆê±°ë‚˜ ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼
      throw error;
    }
  }
};

// ===== SMS API ìºì‹± ì‹œìŠ¤í…œ (API í˜¸ì¶œ ìµœì í™”) =====
const smsApiCache = {
  pendingForwards: new Map(), // ì „ë‹¬ ëŒ€ê¸° ëª©ë¡ ìºì‹œ (í°ë²ˆí˜¸ë³„)
  pendingReplies: new Map(),  // ìë™ì‘ë‹µ ëŒ€ê¸° ëª©ë¡ ìºì‹œ (í°ë²ˆí˜¸ë³„)
};

const SMS_CACHE_TTL = 10000; // 10ì´ˆê°„ ìºì‹œ ìœ ì§€

// ìºì‹œ ì¡°íšŒ í•¨ìˆ˜
const getCachedData = (cacheMap, key) => {
  const cached = cacheMap.get(key);
  if (cached && Date.now() - cached.timestamp < SMS_CACHE_TTL) {
    console.log(`  âœ… ìºì‹œ ì‚¬ìš© (${key})`);
    return cached.data;
  }
  return null;
};

// ìºì‹œ ì €ì¥ í•¨ìˆ˜
const setCachedData = (cacheMap, key, data) => {
  cacheMap.set(key, {
    data,
    timestamp: Date.now()
  });
  console.log(`  ğŸ’¾ ìºì‹œ ì €ì¥ (${key})`);
};

// ì„œë²„ íƒ€ì„ì•„ì›ƒ ì„¤ì • (5ë¶„)
app.use((req, res, next) => {
  req.setTimeout(300000); // 5ë¶„
  res.setTimeout(300000); // 5ë¶„
  next();
});

// CORS ì„¤ì • - í™˜ê²½ ë³€ìˆ˜ ê¸°ë°˜ ë™ì  ì„¤ì •
app.use(cors({
  origin: function (origin, callback) {
    // í™˜ê²½ ë³€ìˆ˜ì—ì„œ í—ˆìš©í•  ë„ë©”ì¸ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    const corsOrigins = process.env.CORS_ORIGIN?.split(',') || [];

    // ê¸°ë³¸ í—ˆìš© ë„ë©”ì¸ (ê°œë°œìš© ë° í”„ë¡œë•ì…˜)
    const defaultOrigins = [
      'https://vipmobile.vercel.app',
      'http://localhost:3000',
      'http://localhost:3001',
      'http://localhost:4000'
    ];

    // í™˜ê²½ ë³€ìˆ˜ ë„ë©”ì¸ê³¼ ê¸°ë³¸ ë„ë©”ì¸ í•©ì¹˜ê¸°
    const allowedOrigins = [...corsOrigins, ...defaultOrigins];

    // originì´ ì—†ê±°ë‚˜ í—ˆìš©ëœ ë„ë©”ì¸ì— í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ í—ˆìš©
    if (!origin || allowedOrigins.includes(origin)) {
      callback(null, true);
    } else {
      // ê°œë°œ í™˜ê²½ì—ì„œëŠ” ëª¨ë“  origin í—ˆìš© (ë””ë²„ê¹…ìš©)
      if (process.env.NODE_ENV !== 'production') {
        callback(null, true);
      } else {
        callback(new Error('Not allowed by CORS'));
      }
    }
  },
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS', 'PATCH'],
  allowedHeaders: ['Content-Type', 'Authorization', 'X-Requested-With', 'Origin', 'Accept', 'X-API-Key', 'x-user-id', 'x-user-role'],
  optionsSuccessStatus: 200,
  preflightContinue: false
}));

// OPTIONS ìš”ì²­ ëª…ì‹œì  ì²˜ë¦¬
app.options('*', (req, res) => {
  // í™˜ê²½ ë³€ìˆ˜ì—ì„œ í—ˆìš©í•  ë„ë©”ì¸ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
  const corsOrigins = process.env.CORS_ORIGIN?.split(',') || [];

  // ê¸°ë³¸ í—ˆìš© ë„ë©”ì¸ (ê°œë°œìš© ë° í”„ë¡œë•ì…˜)
  const defaultOrigins = [
    'https://vipmobile.vercel.app',
    'http://localhost:3000',
    'http://localhost:3001',
    'http://localhost:4000'
  ];

  // í™˜ê²½ ë³€ìˆ˜ ë„ë©”ì¸ê³¼ ê¸°ë³¸ ë„ë©”ì¸ í•©ì¹˜ê¸°
  const allowedOrigins = [...corsOrigins, ...defaultOrigins];

  const origin = req.headers.origin;
  if (origin && allowedOrigins.includes(origin)) {
    res.header('Access-Control-Allow-Origin', origin);
  } else if (origin) {
    // í™˜ê²½ ë³€ìˆ˜ì— ìˆëŠ” ê²½ìš°ë„ í—ˆìš©
    res.header('Access-Control-Allow-Origin', origin);
  }

  res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS, PATCH');
  res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With, Origin, Accept, X-API-Key, x-user-id, x-user-role');
  res.header('Access-Control-Allow-Credentials', 'true');
  res.header('Access-Control-Max-Age', '86400'); // 24ì‹œê°„ ìºì‹œ
  res.status(200).end();
});

// íŠ¹ì • API ì—”ë“œí¬ì¸íŠ¸ì— ëŒ€í•œ OPTIONS ìš”ì²­ ì²˜ë¦¬
app.options('/api/budget/user-sheets-v2', (req, res) => {
  res.header('Access-Control-Allow-Origin', 'https://vipmobile.vercel.app');
  res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
  res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With, Origin, Accept');
  res.header('Access-Control-Allow-Credentials', 'true');
  res.header('Access-Control-Max-Age', '86400'); // 24ì‹œê°„ ìºì‹œ
  res.status(200).end();
});

// íŒ€ ëª©ë¡ ì¡°íšŒ API
app.get('/api/teams', async (req, res) => {
  try {
    console.log('ğŸ” [íŒ€ëª©ë¡] íŒ€ ëª©ë¡ ì¡°íšŒ ì‹œì‘');

    // ëŒ€ë¦¬ì ì•„ì´ë””ê´€ë¦¬ ì‹œíŠ¸ì—ì„œ íŒ€ì¥ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    const sheetName = 'ëŒ€ë¦¬ì ì•„ì´ë””ê´€ë¦¬';
    console.log('ğŸ” [íŒ€ëª©ë¡] ì‹œíŠ¸ ì´ë¦„:', sheetName);

    const range = 'A:R'; // Aì—´(ì´ë¦„)ê³¼ Rì—´(ê¶Œí•œë ˆë²¨) í¬í•¨ (ê¸°ì¡´ Pì—´ â†’ Rì—´)
    const response = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${sheetName}!${range}`,
    });

    const rows = response.data.values || [];
    console.log('ğŸ” [íŒ€ëª©ë¡] ì´ í–‰ ìˆ˜:', rows.length);

    const teams = [];

    // í—¤ë” ì œì™¸í•˜ê³  ë°ì´í„° ì²˜ë¦¬
    for (let i = 1; i < rows.length; i++) {
      const row = rows[i];
      const name = row[0]; // Aì—´: ëŒ€ìƒ(ì´ë¦„)
      const permissionLevel = row[17]; // Rì—´: ì •ì±…ëª¨ë“œê¶Œí•œë ˆë²¨ (ê¸°ì¡´ Pì—´ â†’ Rì—´)

      console.log(`ğŸ” [íŒ€ëª©ë¡] í–‰ ${i}: ì´ë¦„=${name}, ê¶Œí•œë ˆë²¨=${permissionLevel}`);

      // ê¶Œí•œë ˆë²¨ì´ ì•ŒíŒŒë²³ ë‘ ê°œì¸ ê²½ìš° íŒ€ì¥ìœ¼ë¡œ ì¸ì‹ (AA, BB, CC, DD, EE, FF ë“±)
      if (permissionLevel && permissionLevel.length === 2 && /^[A-Z]{2}$/.test(permissionLevel)) {
        teams.push({
          code: permissionLevel,
          name: name
        });
        console.log(`âœ… [íŒ€ëª©ë¡] íŒ€ì¥ ì¶”ê°€: ${permissionLevel} - ${name}`);
      }
    }

    console.log('ğŸ” [íŒ€ëª©ë¡] ìµœì¢… íŒ€ ëª©ë¡:', teams);
    res.json(teams);
  } catch (error) {
    console.error('âŒ [íŒ€ëª©ë¡] íŒ€ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
    res.status(500).json({ error: 'íŒ€ ëª©ë¡ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', details: error.message });
  }
});

// VAPID í‚¤ ì„¤ì • (í™˜ê²½ë³€ìˆ˜ì—ì„œ ê°€ì ¸ì˜¤ê±°ë‚˜ ìƒì„±)
const vapidKeys = process.env.VAPID_PUBLIC_KEY && process.env.VAPID_PRIVATE_KEY
  ? {
    publicKey: process.env.VAPID_PUBLIC_KEY,
    privateKey: process.env.VAPID_PRIVATE_KEY
  }
  : webpush.generateVAPIDKeys();

// web-push ì„¤ì •
webpush.setVapidDetails(
  'mailto:admin@vipmap.com', // ê´€ë¦¬ì ì´ë©”ì¼ (ì‹¤ì œ ì´ë©”ì¼ë¡œ ë³€ê²½ í•„ìš”)
  vapidKeys.publicKey,
  vapidKeys.privateKey
);

// í‘¸ì‹œ êµ¬ë… ì €ì¥ì†Œ (ì‹¤ì œë¡œëŠ” ë°ì´í„°ë² ì´ìŠ¤ ì‚¬ìš© ê¶Œì¥)
const pushSubscriptions = new Map();

// ìºì‹± ì‹œìŠ¤í…œ ì„¤ì • (íŠ¸ë˜í”½ ìµœì í™”)
const cache = new Map();
const CACHE_TTL = 5 * 60 * 1000; // 5ë¶„ (5 * 60 * 1000ms)
const MAX_CACHE_SIZE = 200; // ìµœëŒ€ ìºì‹œ í•­ëª© ìˆ˜ ì¦ê°€ (100 â†’ 200)

// ë™ì‹œ ìš”ì²­ ì œí•œ ì„¤ì •
const concurrentRequestLimit = {
  maxConcurrent: 10, // ìµœëŒ€ ë™ì‹œ ìš”ì²­ ìˆ˜
  currentRequests: 0,
  queue: []
};

// API í˜¸ì¶œ ì œí•œ ì„¤ì • (íŠ¸ë˜í”½ ìµœì í™”)
const API_RATE_LIMIT = {
  maxRequestsPerMinute: 45, // Google Sheets API ë¬´ë£Œ í•œë„(60íšŒ)ë³´ë‹¤ ë‚®ê²Œ ì„¤ì •
  requests: [],
  isRateLimited: false
};

// ìš”ì²­ í ê´€ë¦¬ í•¨ìˆ˜
const processRequestQueue = async () => {
  if (concurrentRequestLimit.queue.length > 0 &&
    concurrentRequestLimit.currentRequests < concurrentRequestLimit.maxConcurrent) {
    const { resolve, reject, requestFunction } = concurrentRequestLimit.queue.shift();
    concurrentRequestLimit.currentRequests++;

    try {
      const result = await requestFunction();
      resolve(result);
    } catch (error) {
      reject(error);
    } finally {
      concurrentRequestLimit.currentRequests--;
      processRequestQueue(); // ë‹¤ìŒ ìš”ì²­ ì²˜ë¦¬
    }
  }
};

// ìš”ì²­ ì œí•œ ë˜í¼ í•¨ìˆ˜
const withConcurrencyLimit = (requestFunction) => {
  return new Promise((resolve, reject) => {
    if (concurrentRequestLimit.currentRequests < concurrentRequestLimit.maxConcurrent) {
      concurrentRequestLimit.currentRequests++;
      requestFunction()
        .then(resolve)
        .catch(reject)
        .finally(() => {
          concurrentRequestLimit.currentRequests--;
          processRequestQueue();
        });
    } else {
      concurrentRequestLimit.queue.push({ resolve, reject, requestFunction });
    }
  });
};

// ìºì‹œ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
const cacheUtils = {
  // ìºì‹œì— ë°ì´í„° ì €ì¥
  set: (key, data, ttl = CACHE_TTL) => {
    const now = Date.now();
    cache.set(key, {
      data,
      timestamp: now,
      ttl: now + ttl
    });

    // ìºì‹œ í¬ê¸° ì œí•œ í™•ì¸
    if (cache.size > MAX_CACHE_SIZE) {
      const firstKey = cache.keys().next().value;
      cache.delete(firstKey);
    }
  },

  // ìºì‹œì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
  get: (key) => {
    const item = cache.get(key);
    if (!item) {
      return null;
    }

    const now = Date.now();
    if (now > item.ttl) {
      cache.delete(key);
      return null;
    }

    return item.data;
  },

  // ìºì‹œ ì‚­ì œ
  delete: (key) => {
    cache.delete(key);
  },

  // ìºì‹œ ì „ì²´ ì •ë¦¬ (ë§Œë£Œëœ í•­ëª©ë“¤)
  cleanup: () => {
    const now = Date.now();

    for (const [key, item] of cache.entries()) {
      if (now > item.ttl) {
        cache.delete(key);
      }
    }
  },

  // ìºì‹œ ìƒíƒœ í™•ì¸
  status: () => {
    const now = Date.now();
    const validItems = Array.from(cache.entries()).filter(([key, item]) => now <= item.ttl);
    return {
      total: cache.size,
      valid: validItems.length,
      expired: cache.size - validItems.length
    };
  },

  // ìºì‹œ íŒ¨í„´ ì‚­ì œ
  deletePattern: (pattern) => {
    for (const key of cache.keys()) {
      if (key.startsWith(pattern)) {
        cache.delete(key);
      }
    }
  }
};

// API í˜¸ì¶œ ì œí•œ ìœ í‹¸ë¦¬í‹°
const rateLimitUtils = {
  // API í˜¸ì¶œ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
  canMakeRequest: () => {
    const now = Date.now();
    const oneMinuteAgo = now - 60 * 1000;

    // 1ë¶„ ì´ì „ì˜ ìš”ì²­ë“¤ ì œê±°
    API_RATE_LIMIT.requests = API_RATE_LIMIT.requests.filter(time => time > oneMinuteAgo);

    // í˜„ì¬ ìš”ì²­ ìˆ˜ê°€ ì œí•œì„ ì´ˆê³¼í–ˆëŠ”ì§€ í™•ì¸
    if (API_RATE_LIMIT.requests.length >= API_RATE_LIMIT.maxRequestsPerMinute) {
      API_RATE_LIMIT.isRateLimited = true;
      return false;
    }

    API_RATE_LIMIT.isRateLimited = false;
    return true;
  },

  // API í˜¸ì¶œ ê¸°ë¡
  recordRequest: () => {
    API_RATE_LIMIT.requests.push(Date.now());
  },

  // ëŒ€ê¸° ì‹œê°„ ê³„ì‚°
  getWaitTime: () => {
    if (API_RATE_LIMIT.requests.length === 0) return 0;

    const oldestRequest = Math.min(...API_RATE_LIMIT.requests);
    const timeSinceOldest = Date.now() - oldestRequest;
    return Math.max(0, 60000 - timeSinceOldest); // 1ë¶„ - ê²½ê³¼ ì‹œê°„
  }
};

// ì£¼ê¸°ì  ìºì‹œ ì •ë¦¬ (5ë¶„ë§ˆë‹¤)
setInterval(() => {
  cacheUtils.cleanup();
}, 5 * 60 * 1000);

// ì£¼ê¸°ì  ë°°ì • ì €ì¥ (10ë¶„ë§ˆë‹¤) - ê°œí†µì™„ë£Œ í™•ì¸ í›„ ë°°ì • ì €ì¥
setInterval(async () => {
  try {
    console.log('ğŸ”„ [ìë™ë°°ì •ì €ì¥] ì£¼ê¸°ì  ë°°ì • ì €ì¥ ì‹œì‘');

    // 1. ë¨¼ì € ê°œí†µì™„ë£Œ ìƒíƒœ í™•ì¸ ë° Fì—´ ì—…ë°ì´íŠ¸
    console.log('ğŸ“‹ [ìë™ë°°ì •ì €ì¥] 1ë‹¨ê³„: ê°œí†µì™„ë£Œ ìƒíƒœ í™•ì¸ ì‹œì‘');
    const activationResponse = await fetch(`${process.env.REACT_APP_API_URL || 'http://localhost:4000'}/api/inventory/activation-status`);

    if (activationResponse.ok) {
      const activationResult = await activationResponse.json();
      if (activationResult.success) {
        console.log(`âœ… [ìë™ë°°ì •ì €ì¥] ê°œí†µì™„ë£Œ ìƒíƒœ í™•ì¸ ì™„ë£Œ: ${activationResult.data?.length || 0}ê°œ ê³ ê° ì²˜ë¦¬`);
      } else {
        console.error('âŒ [ìë™ë°°ì •ì €ì¥] ê°œí†µì™„ë£Œ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', activationResult.error);
      }
    } else {
      console.error('âŒ [ìë™ë°°ì •ì €ì¥] ê°œí†µì™„ë£Œ ìƒíƒœ í™•ì¸ API í˜¸ì¶œ ì‹¤íŒ¨:', activationResponse.status);
    }

    // 2. ê°œí†µì™„ë£Œ ë°ì´í„° ì €ì¥ ì™„ë£Œë¥¼ ìœ„í•œ ëŒ€ê¸° (2ì´ˆ)
    console.log('â³ [ìë™ë°°ì •ì €ì¥] 2ë‹¨ê³„: ê°œí†µì™„ë£Œ ë°ì´í„° ì €ì¥ ì™„ë£Œ ëŒ€ê¸° (2ì´ˆ)');
    await new Promise(resolve => setTimeout(resolve, 2000));

    // 3. í°í´ì¬ê³ ë°ì´í„° ê¸°ì¤€ìœ¼ë¡œ í˜„ì¬ ë°°ì • ìƒíƒœ ê°€ì ¸ì˜¤ê¸°
    console.log('ğŸ“Š [ìë™ë°°ì •ì €ì¥] 3ë‹¨ê³„: ë°°ì • ìƒíƒœ í™•ì¸ ì‹œì‘');
    const response = await fetch(`${process.env.REACT_APP_API_URL || 'http://localhost:4000'}/api/inventory/assignment-status`);

    if (response.ok) {
      const result = await response.json();

      if (result.success) {
        // ë°°ì •ì™„ë£Œëœ ê³ ê°ë“¤ë§Œ í•„í„°ë§
        const assignments = result.data
          .filter(item => item.assignmentStatus === 'ë°°ì •ì™„ë£Œ' && item.assignedSerialNumber)
          .map(item => ({
            reservationNumber: item.reservationNumber,
            assignedSerialNumber: item.assignedSerialNumber
          }));

        if (assignments.length > 0) {
          // ë°°ì • ì €ì¥ API í˜¸ì¶œ (ê°œí†µì™„ë£Œ ê³ ê° ì œì™¸ ë¡œì§ í¬í•¨)
          console.log('ğŸ’¾ [ìë™ë°°ì •ì €ì¥] 4ë‹¨ê³„: ë°°ì • ì €ì¥ ì‹œì‘');
          const saveResponse = await fetch(`${process.env.REACT_APP_API_URL || 'http://localhost:4000'}/api/inventory/save-assignment`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ assignments })
          });

          if (saveResponse.ok) {
            const saveResult = await saveResponse.json();
            console.log(`âœ… [ìë™ë°°ì •ì €ì¥] ë°°ì • ì €ì¥ ì™„ë£Œ: ${saveResult.updated}ê°œ ì €ì¥, ${saveResult.skipped}ê°œ ìœ ì§€`);
          } else {
            console.error('âŒ [ìë™ë°°ì •ì €ì¥] ë°°ì • ì €ì¥ ì‹¤íŒ¨:', saveResponse.status);
          }
        } else {
          console.log('â„¹ï¸ [ìë™ë°°ì •ì €ì¥] ì €ì¥í•  ë°°ì •ì´ ì—†ìŠµë‹ˆë‹¤');
        }
      }
    }
  } catch (error) {
    console.error('âŒ [ìë™ë°°ì •ì €ì¥] ì£¼ê¸°ì  ë°°ì • ì €ì¥ ì˜¤ë¥˜:', error);
  }
}, 10 * 60 * 1000); // 10ë¶„ë§ˆë‹¤

// Discord ë´‡ ì„¤ì •
const DISCORD_BOT_TOKEN = process.env.DISCORD_BOT_TOKEN;
const DISCORD_CHANNEL_ID = process.env.DISCORD_CHANNEL_ID;
const DISCORD_AGENT_CHANNEL_ID = process.env.DISCORD_AGENT_CHANNEL_ID || DISCORD_CHANNEL_ID; // ê´€ë¦¬ì ì±„ë„ (ì—†ìœ¼ë©´ ê¸°ë³¸ ì±„ë„ ì‚¬ìš©)
const DISCORD_STORE_CHANNEL_ID = process.env.DISCORD_STORE_CHANNEL_ID || DISCORD_CHANNEL_ID; // ì¼ë°˜ ë§¤ì¥ ì±„ë„ (ì—†ìœ¼ë©´ ê¸°ë³¸ ì±„ë„ ì‚¬ìš©)
// ì§ì˜ì  ì´ë¯¸ì§€ ì—…ë¡œë“œìš© í¬ëŸ¼ ì±„ë„ (í”„ë¡¬í”„íŠ¸: 1445397081333174377)
const DISCORD_STORE_FORUM_CHANNEL_ID = process.env.DISCORD_STORE_FORUM_CHANNEL_ID || '1445397081333174377';
const DISCORD_LOGGING_ENABLED = process.env.DISCORD_LOGGING_ENABLED === 'true';

// ë””ìŠ¤ì½”ë“œ ë´‡ ë° ê´€ë ¨ ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” í•„ìš”í•œ ê²½ìš°ì—ë§Œ ì´ˆê¸°í™”
let discordBot = null;
let EmbedBuilder = null;

if (DISCORD_LOGGING_ENABLED && DISCORD_BOT_TOKEN) {
  try {
    const { Client, GatewayIntentBits } = require('discord.js');
    ({ EmbedBuilder } = require('discord.js'));

    // ë””ìŠ¤ì½”ë“œ ë´‡ ì´ˆê¸°í™”
    discordBot = new Client({
      intents: [
        GatewayIntentBits.Guilds,
        GatewayIntentBits.GuildMessages,
        GatewayIntentBits.MessageContent
      ]
    });

    // ë´‡ ì¤€ë¹„ ì´ë²¤íŠ¸
    discordBot.once('ready', () => {
      // console.log('ë´‡ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤: ${discordBot.user.tag}');
      console.log('ğŸ¤– Discord ë´‡ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤:', discordBot.user.tag);
    });

    // console.log('ë””ìŠ¤ì½”ë“œ ë´‡ ëª¨ë“ˆ ë¡œë”© ì„±ê³µ');
  } catch (error) {
    console.error('ë””ìŠ¤ì½”ë“œ ë´‡ ëª¨ë“ˆ ë¡œë”© ì‹¤íŒ¨:', error.message);
  }
}

// ì „ì—­ ì˜¤ë¥˜ ì²˜ë¦¬
process.on('uncaughtException', async (error) => {
  console.error('Uncaught Exception:', error);

  // Discordì— ì˜¤ë¥˜ ì•Œë¦¼ ì „ì†¡
  if (DISCORD_LOGGING_ENABLED && discordBot) {
    try {
      // ë´‡ì´ ì¤€ë¹„ë˜ì—ˆëŠ”ì§€ í™•ì¸
      if (discordBot.isReady()) {
        if (DISCORD_CHANNEL_ID) {
          try {
            const channel = await discordBot.channels.fetch(DISCORD_CHANNEL_ID);
            if (channel) {
              // ì—ëŸ¬ ì •ë³´ë¥¼ ê°„ê²°í•˜ê²Œ ì •ë¦¬
              const errorInfo = {
                message: error.message,
                stack: error.stack?.split('\n').slice(0, 5).join('\n') || 'ìŠ¤íƒ ì •ë³´ ì—†ìŒ',
                time: new Date().toISOString()
              };

              const crashEmbed = new EmbedBuilder()
                .setTitle('ğŸš¨ ì„œë²„ ì¶©ëŒ ì•Œë¦¼')
                .setColor(15548997) // ë¹¨ê°„ìƒ‰
                .setDescription('@everyone\nì„œë²„ì— ì¹˜ëª…ì ì¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì„œë¹„ìŠ¤ê°€ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.')
                .addFields({
                  name: 'ì˜¤ë¥˜ ì •ë³´',
                  value: `\`\`\`\n${errorInfo.message}\n${errorInfo.stack}\n\`\`\``
                })
                .setTimestamp()
                .setFooter({ text: '(ì£¼)ë¸Œì´ì•„ì´í”¼í”ŒëŸ¬ìŠ¤ ì„œë²„ ì˜¤ë¥˜ ì•Œë¦¼' });

              // console.log('ì¶©ëŒ ì•Œë¦¼ ì „ì†¡ ì‹œë„ ì¤‘...');
              await channel.send({ content: '@everyone', embeds: [crashEmbed] });
              // console.log('ì„œë²„ ì¶©ëŒ ì•Œë¦¼ ë©”ì‹œì§€ê°€ Discordë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
          } catch (discordError) {
            console.error('Discord ì¶©ëŒ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨:', discordError);
          }
        }
      }

      // Discord ë©”ì‹œì§€ ì „ì†¡ì„ ìœ„í•œ ëŒ€ê¸°
      await new Promise(resolve => setTimeout(resolve, 3000));
    } catch (discordError) {
      console.error('Discord ì˜¤ë¥˜ ì•Œë¦¼ ì²˜ë¦¬ ì¤‘ ì¶”ê°€ ì˜¤ë¥˜:', discordError);
    }
  }

  // 3ì´ˆ í›„ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ (Discord ë©”ì‹œì§€ ì „ì†¡ ì‹œê°„ í™•ë³´)
  setTimeout(() => {
    console.error('ì¹˜ëª…ì ì¸ ì˜¤ë¥˜ë¡œ ì¸í•œ ì„œë²„ ì¢…ë£Œ');
    process.exit(1);
  }, 3000);
});

process.on('unhandledRejection', async (reason, promise) => {
  console.error('Unhandled Rejection at:', promise, 'reason:', reason);

  // ì¹˜ëª…ì ì´ì§€ ì•Šì€ ê²½ìš° Discordì— ê²½ê³  ì•Œë¦¼ë§Œ ì „ì†¡
  if (DISCORD_LOGGING_ENABLED && discordBot && discordBot.isReady()) {
    try {
      if (DISCORD_CHANNEL_ID) {
        const channel = await discordBot.channels.fetch(DISCORD_CHANNEL_ID);
        if (channel) {
          // ì˜¤ë¥˜ ì •ë³´ ì •ë¦¬
          const errorInfo = {
            message: reason instanceof Error ? reason.message : String(reason),
            stack: reason instanceof Error && reason.stack
              ? reason.stack.split('\n').slice(0, 5).join('\n')
              : 'ìŠ¤íƒ ì •ë³´ ì—†ìŒ',
            time: new Date().toISOString()
          };

          const warningEmbed = new EmbedBuilder()
            .setTitle('âš ï¸ ì„œë²„ ê²½ê³  ì•Œë¦¼')
            .setColor(16776960) // ë…¸ë€ìƒ‰
            .setDescription('ì„œë²„ì—ì„œ ì²˜ë¦¬ë˜ì§€ ì•Šì€ Promise ê±°ë¶€ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.')
            .addFields({
              name: 'ì˜¤ë¥˜ ì •ë³´',
              value: `\`\`\`\n${errorInfo.message}\n${errorInfo.stack}\n\`\`\``
            })
            .setTimestamp()
            .setFooter({ text: '(ì£¼)ë¸Œì´ì•„ì´í”¼í”ŒëŸ¬ìŠ¤ ì„œë²„ ê²½ê³  ì•Œë¦¼' });

          await channel.send({ embeds: [warningEmbed] });
          // console.log('ì„œë²„ ê²½ê³  ì•Œë¦¼ ë©”ì‹œì§€ê°€ Discordë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
      }
    } catch (discordError) {
      console.error('Discord ê²½ê³  ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨:', discordError);
    }
  }

  // ì²˜ë¦¬ë˜ì§€ ì•Šì€ Promise ê±°ë¶€ë¥¼ ê¸°ë¡í•˜ì§€ë§Œ í”„ë¡œì„¸ìŠ¤ëŠ” ê³„ì† ì‹¤í–‰
});

// ëª¨ë“  ìš”ì²­ì— ëŒ€í•œ ë¡œê¹… ë¯¸ë“¤ì›¨ì–´
app.use((req, res, next) => {
  // OPTIONS ìš”ì²­ì€ ì¦‰ì‹œ ì²˜ë¦¬í•˜ë„ë¡ ì¡°ê¸° ë°˜í™˜
  if (req.method === 'OPTIONS') {
    const corsOrigins = process.env.CORS_ORIGIN?.split(',') || [];
    const defaultOrigins = [
      'https://vipmobile.vercel.app',
      'http://localhost:3000',
      'http://localhost:3001',
      'http://localhost:4000'
    ];
    const allowedOrigins = [...corsOrigins, ...defaultOrigins];
    const origin = req.headers.origin;

    if (origin && allowedOrigins.includes(origin)) {
      res.header('Access-Control-Allow-Origin', origin);
    } else if (allowedOrigins.length > 0) {
      res.header('Access-Control-Allow-Origin', allowedOrigins[0]);
    } else if (origin) {
      res.header('Access-Control-Allow-Origin', origin);
    }
    res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS, PATCH');
    res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With, Origin, Accept, X-API-Key');
    res.header('Access-Control-Allow-Credentials', 'true');
    res.header('Access-Control-Max-Age', '86400');
    return res.status(200).end();
  }

  // console.log(`${new Date().toISOString()} - ${req.method} ${req.url}`);
  next();
});

// CORS ì„¤ì • (ë” êµ¬ì²´ì ìœ¼ë¡œ) - ëª¨ë“  origin í—ˆìš© (ê°œë°œ í™˜ê²½)
// ì´ ì„¤ì •ì€ ì²« ë²ˆì§¸ CORS ì„¤ì •ì„ ë³´ì™„í•˜ì—¬ ëª¨ë“  ìš”ì²­ì— ëŒ€í•´ CORS í—¤ë”ë¥¼ ë³´ì¥í•©ë‹ˆë‹¤
app.use(cors({
  origin: true, // ëª¨ë“  origin í—ˆìš© (ê°œë°œ í™˜ê²½)
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS', 'PATCH'],
  allowedHeaders: ['Content-Type', 'Authorization', 'X-Requested-With', 'Origin', 'Accept', 'X-API-Key']
}));

// ëª¨ë“  ìš”ì²­ ë¡œê¹… ë¯¸ë“¤ì›¨ì–´
app.use((req, res, next) => {
  const timestamp = new Date().toISOString();
  const method = req.method;
  const url = req.url;
  const userAgent = req.get('User-Agent') || 'Unknown';
  const ip = req.ip || req.connection.remoteAddress;

  console.log(`ğŸ“¡ [${timestamp}] ${method} ${url} - IP: ${ip} - UA: ${userAgent.substring(0, 50)}...`);

  // ì‘ë‹µ ì™„ë£Œ ì‹œ ë¡œê¹…
  res.on('finish', () => {
    const statusCode = res.statusCode;
    const responseTime = Date.now() - req.startTime;
    console.log(`âœ… [${timestamp}] ${method} ${url} - ${statusCode} - ${responseTime}ms`);
  });

  req.startTime = Date.now();
  next();
});

app.use(express.json());

// í´ë¼ì´ì–¸íŠ¸ ì›ê²© ë¡œê·¸ ìˆ˜ì§‘ (ë¹„ì°¨ë‹¨, CORS ì ìš©)
app.post('/api/client-logs', (req, res) => {
  try {
    const origin = req.headers.origin;
    if (origin) {
      res.header('Access-Control-Allow-Origin', origin);
    }
    res.header('Access-Control-Allow-Methods', 'POST, OPTIONS');
    res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With, Origin, Accept, X-API-Key');
    res.header('Access-Control-Allow-Credentials', 'true');

    const { sessionId, userAgent, ts, logs } = req.body || {};
    if (Array.isArray(logs) && logs.length > 0) {
      console.log('ğŸ›°ï¸ [CLIENT LOGS]', {
        sessionId,
        userAgent,
        ts,
        count: logs.length
      });
      // ìƒì„¸ ë¡œê·¸ëŠ” ë„ˆë¬´ ë§ì„ ìˆ˜ ìˆìœ¼ë‹ˆ ì¼ë¶€ë§Œ ë¯¸ë¦¬ë³´ê¸°
      const preview = logs.slice(0, 5);
      preview.forEach((l, i) => {
        console.log(`ğŸ“ [${i + 1}/${logs.length}] ${l.lv} ${new Date(l.ts).toISOString()} ${l.path} :: ${l.msg}`);
      });
    }
    res.status(200).json({ success: true });
  } catch (e) {
    console.error('âŒ [CLIENT LOGS] ìˆ˜ì§‘ ì˜¤ë¥˜:', e?.message || e);
    res.status(200).json({ success: true }); // ë¡œê¹… ì‹¤íŒ¨ëŠ” ë¬´ì‹œ
  }
});

// ==================== API ë¼ìš°íŠ¸ë“¤ ====================
setupDirectRoutes(app);

// ì •ì±…í‘œ ìƒì„± ë¼ìš°íŠ¸ ì„¤ì •
try {
  app.use('/api', setupPolicyTableRoutes(app));
  console.log('âœ… [ì •ì±…í‘œ] Policy table routes mounted at /api');
} catch (e) {
  console.error('âŒ [ì •ì±…í‘œ] Failed to mount policy table routes:', e.message);
}

// í…ŒìŠ¤íŠ¸ API
app.get('/api/test', (req, res) => {
  console.log('ğŸ§ª [í…ŒìŠ¤íŠ¸] API í˜¸ì¶œë¨');
  res.json({ success: true, message: 'í…ŒìŠ¤íŠ¸ API ì‘ë™ ì¤‘' });
});

// ê°œí†µì™„ë£Œ API
app.post('/api/onsale/activation-info/:sheetId/:rowIndex/complete', async (req, res) => {
  try {
    const { sheetId, rowIndex } = req.params;
    const { completedBy } = req.body;
    console.log(`âœ… [ê°œí†µì™„ë£Œ] ì‹œíŠ¸: ${sheetId}, í–‰: ${rowIndex}, ì™„ë£Œì: ${completedBy}`);

    const sheetResponse = await sheets.spreadsheets.get({ spreadsheetId: sheetId });
    const sheetName = sheetResponse.data.sheets[0].properties.title;
    console.log(`âœ… [ê°œí†µì™„ë£Œ] ì‹œíŠ¸ëª…: ${sheetName}`);

    const now = new Date();
    const completedAt = now.toLocaleString('ko-KR', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    });

    // ê¸°ì¡´ ë°ì´í„°ë¥¼ ì½ì–´ì„œ ê°œí†µì‹œê°„ì„ í¬í•¨í•œ ìƒˆë¡œìš´ ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸
    const existingData = await sheets.spreadsheets.values.get({
      spreadsheetId: sheetId,
      range: `${sheetName}!A${rowIndex}:AL${rowIndex}`,
    });

    const existingRow = existingData.data.values?.[0] || [];

    // ìƒˆë¡œìš´ ë°ì´í„° êµ¬ì¡°: A=ê°œí†µì™„ë£Œ, B=ê°œí†µì, C=ê°œí†µì‹œê°„, D=ì·¨ì†Œì—¬ë¶€, E=ì·¨ì†Œì, F=ì·¨ì†Œì‹œê°„, G=ìˆ˜ì •ì, H=ìˆ˜ì •ì‹œê°„, I=ì œì¶œì¼ì‹œ, J=ë§¤ì¥ëª…, ...
    const newRowData = [
      'ê°œí†µì™„ë£Œ',           // Aì—´
      completedBy,          // Bì—´
      completedAt,          // Cì—´
      existingRow[3] || '', // Dì—´ (ê¸°ì¡´ Dì—´ ë°ì´í„° - ì·¨ì†Œì—¬ë¶€)
      existingRow[4] || '', // Eì—´ (ê¸°ì¡´ Eì—´ ë°ì´í„° - ì·¨ì†Œì)
      existingRow[5] || '', // Fì—´ (ê¸°ì¡´ Fì—´ ë°ì´í„° - ì·¨ì†Œì‹œê°„)
      existingRow[6] || '', // Gì—´ (ê¸°ì¡´ Gì—´ ë°ì´í„° - ìˆ˜ì •ì)
      existingRow[7] || '', // Hì—´ (ê¸°ì¡´ Hì—´ ë°ì´í„° - ìˆ˜ì •ì‹œê°„)
      existingRow[8] || '', // Iì—´ (ê¸°ì¡´ Iì—´ ë°ì´í„° - ì œì¶œì¼ì‹œ)
      existingRow[9] || '', // Jì—´ (ê¸°ì¡´ Jì—´ ë°ì´í„° - ë§¤ì¥ëª…)
      existingRow[10] || '', // Kì—´ (ê¸°ì¡´ Kì—´ ë°ì´í„° - Pì½”ë“œ)
      existingRow[11] || '', // Lì—´ (ê¸°ì¡´ Lì—´ ë°ì´í„° - ê°œí†µìœ í˜•)
      existingRow[12] || '', // Mì—´ (ê¸°ì¡´ Mì—´ ë°ì´í„° - ì „í†µì‹ ì‚¬)
      existingRow[13] || '', // Nì—´ (ê¸°ì¡´ Nì—´ ë°ì´í„° - ê³ ê°ëª…)
      existingRow[14] || '', // Oì—´ (ê¸°ì¡´ Oì—´ ë°ì´í„° - ìƒë…„ì›”ì¼)
      existingRow[15] || '', // Pì—´ (ê¸°ì¡´ Pì—´ ë°ì´í„° - ê°œí†µë²ˆí˜¸)
      existingRow[16] || '', // Qì—´ (ê¸°ì¡´ Qì—´ ë°ì´í„° - ëª¨ë¸ëª…)
      existingRow[17] || '', // Rì—´ (ê¸°ì¡´ Rì—´ ë°ì´í„° - ê¸°ê¸°ì¼ë ¨ë²ˆí˜¸)
      existingRow[18] || '', // Sì—´ (ê¸°ì¡´ Sì—´ ë°ì´í„° - ìƒ‰ìƒ)
      existingRow[19] || '', // Tì—´ (ê¸°ì¡´ Tì—´ ë°ì´í„° - ìœ ì‹¬ëª¨ë¸)
      existingRow[20] || '', // Uì—´ (ê¸°ì¡´ Uì—´ ë°ì´í„° - ìœ ì‹¬ì¼ë ¨ë²ˆí˜¸)
      existingRow[21] || '', // Vì—´ (ê¸°ì¡´ Vì—´ ë°ì´í„° - ì•½ì •ìœ í˜•)
      existingRow[22] || '', // Wì—´ (ê¸°ì¡´ Wì—´ ë°ì´í„° - ì „í™˜ì§€ì›ê¸ˆ)
      existingRow[23] || '', // Xì—´ (ê¸°ì¡´ Xì—´ ë°ì´í„° - ìœ í†µë§ì¶”ê°€ì§€ì›ê¸ˆ)
      existingRow[24] || '', // Yì—´ (ê¸°ì¡´ Yì—´ ë°ì´í„° - í• ë¶€ê°œì›”)
      existingRow[25] || '', // Zì—´ (ê¸°ì¡´ Zì—´ ë°ì´í„° - í• ë¶€ì›ê¸ˆ)
      existingRow[26] || '', // AAì—´ (ê¸°ì¡´ AAì—´ ë°ì´í„° - í”„ë¦¬)
      existingRow[27] || '', // ABì—´ (ê¸°ì¡´ ABì—´ ë°ì´í„° - ìš”ê¸ˆì œ)
      existingRow[28] || '', // ACì—´ (ê¸°ì¡´ ACì—´ ë°ì´í„° - ë¯¸ë””ì–´ì„œë¹„ìŠ¤)
      existingRow[29] || '', // ADì—´ (ê¸°ì¡´ ADì—´ ë°ì´í„° - ë¶€ê°€ì„œë¹„ìŠ¤)
      existingRow[30] || '', // AEì—´ (ê¸°ì¡´ AEì—´ ë°ì´í„° - í”„ë¦¬ë¯¸ì–´ì•½ì •)
      existingRow[31] || '', // AFì—´ (ê¸°ì¡´ AFì—´ ë°ì´í„° - ì˜ˆì•½ë²ˆí˜¸)
      existingRow[32] || '', // AGì—´ (ê¸°ì¡´ AGì—´ ë°ì´í„° - ê¸°íƒ€ìš”ì²­ì‚¬í•­)
      existingRow[33] || '', // AHì—´ (ê¸°ì¡´ AHì—´ ë°ì´í„° - U+ì œì¶œì¼ì‹œ)
      existingRow[34] || '', // AIì—´ (ê¸°ì¡´ AIì—´ ë°ì´í„° - U+ì œì¶œë°ì´í„°)
    ];

    // ì „ì²´ í–‰ì„ ìƒˆë¡œìš´ ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸
    await sheets.spreadsheets.values.update({
      spreadsheetId: sheetId,
      range: `${sheetName}!A${rowIndex}:AL${rowIndex}`,
      valueInputOption: 'RAW',
      requestBody: {
        values: [newRowData]
      }
    });

    console.log(`âœ… [ê°œí†µì™„ë£Œ] ì™„ë£Œ ì²˜ë¦¬ ì™„ë£Œ`);
    res.json({ success: true, message: 'ê°œí†µì •ë³´ê°€ ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.', completedAt });
  } catch (error) {
    console.error('âŒ [ê°œí†µì™„ë£Œ] ì™„ë£Œ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: 'ê°œí†µì •ë³´ ì™„ë£Œ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', message: error.message });
  }
});

console.log('ğŸ”§ [ì„œë²„ì‹œì‘] API ë¼ìš°íŠ¸ ë“±ë¡ ì™„ë£Œ: /api/test');

// ëª¨ë“  ë“±ë¡ëœ ë¼ìš°íŠ¸ í™•ì¸
app._router.stack.forEach((middleware) => {
  if (middleware.route) {
    console.log(`ğŸ”§ [ì„œë²„ì‹œì‘] ë“±ë¡ëœ ë¼ìš°íŠ¸: ${middleware.route.methods} ${middleware.route.path}`);
  }
});

// Google Sheets API configuration
const SPREADSHEET_ID = process.env.SHEET_ID;
const GOOGLE_PRIVATE_KEY = process.env.GOOGLE_PRIVATE_KEY;
const GOOGLE_SERVICE_ACCOUNT_EMAIL = process.env.GOOGLE_SERVICE_ACCOUNT_EMAIL;
// Google Drive "ì–´í”Œìë£Œ" í´ë” ID (í™˜ê²½ë³€ìˆ˜ë¡œ ì„¤ì • ê°€ëŠ¥, ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©)
const APP_DATA_FOLDER_ID = process.env.APP_DATA_FOLDER_ID || '1u2r9l7MHeWrU3mIeO74eGVuEjhTlzcC_';

// í•„ìˆ˜ í™˜ê²½ ë³€ìˆ˜ ê²€ì¦
if (!SPREADSHEET_ID) {
  console.error('SHEET_ID is not defined in environment variables');
  process.exit(1);
}

if (!GOOGLE_SERVICE_ACCOUNT_EMAIL) {
  console.error('GOOGLE_SERVICE_ACCOUNT_EMAIL is not defined in environment variables');
  process.exit(1);
}

if (!GOOGLE_PRIVATE_KEY) {
  console.error('GOOGLE_PRIVATE_KEY is not defined in environment variables');
  process.exit(1);
}

// ì‹œíŠ¸ ì´ë¦„ ì„¤ì •
const INVENTORY_SHEET_NAME = 'í°í´ì¬ê³ ë°ì´í„°';
const STORE_SHEET_NAME = 'í°í´ì¶œê³ ì²˜ë°ì´í„°';
const PLAN_SHEET_NAME = 'ë¬´ì„ ìš”ê¸ˆì œêµ°';  // ë¬´ì„ ìš”ê¸ˆì œêµ° ì‹œíŠ¸ ì¶”ê°€
const AGENT_SHEET_NAME = 'ëŒ€ë¦¬ì ì•„ì´ë””ê´€ë¦¬';  // ëŒ€ë¦¬ì  ì•„ì´ë”” ê´€ë¦¬ ì‹œíŠ¸ ì¶”ê°€
const CURRENT_MONTH_ACTIVATION_SHEET_NAME = 'í°í´ê°œí†µë°ì´í„°';  // ë‹¹ì›” ê°œí†µì‹¤ì  ë°ì´í„°
const PREVIOUS_MONTH_ACTIVATION_SHEET_NAME = 'í°í´ê°œí†µë°ì´í„°(ì „ì›”)';  // ì „ì›” ê°œí†µì‹¤ì  ë°ì´í„°
const UPDATE_SHEET_NAME = 'ì–´í”Œì—…ë°ì´íŠ¸';  // ì—…ë°ì´íŠ¸ ë‚´ìš© ê´€ë¦¬ ì‹œíŠ¸ ì¶”ê°€
const MANUAL_DATA_SHEET_NAME = 'ìˆ˜ê¸°ì´ˆ';  // ìˆ˜ê¸°ì´ˆ ë°ì´í„°
const INSPECTION_RESULT_SHEET_NAME = 'ê²€ìˆ˜ê²°ê³¼';  // ê²€ìˆ˜ ê²°ê³¼ ë°ì´í„°
const SMS_SHEET_NAME = 'SMSê´€ë¦¬';  // SMS ìˆ˜ì‹  ë°ì´í„°
const SMS_RULES_SHEET_NAME = 'SMSì „ë‹¬ê·œì¹™';  // SMS ì „ë‹¬ ê·œì¹™
const SMS_HISTORY_SHEET_NAME = 'SMSì „ë‹¬ì´ë ¥';  // SMS ì „ë‹¬ ì´ë ¥
const SMS_AUTO_REPLY_RULES_SHEET_NAME = 'SMSìë™ì‘ë‹µê·œì¹™';  // SMS ìë™ì‘ë‹µ ê·œì¹™
const SMS_AUTO_REPLY_CONTACTS_SHEET_NAME = 'SMSìë™ì‘ë‹µê±°ë˜ì²˜';  // SMS ìë™ì‘ë‹µ ê±°ë˜ì²˜
const SMS_AUTO_REPLY_HISTORY_SHEET_NAME = 'SMSìë™ì‘ë‹µì´ë ¥';  // SMS ìë™ì‘ë‹µ ì´ë ¥
const QUICK_COST_SHEET_NAME = 'í€µë¹„ìš©ê´€ë¦¬';  // í€µë¹„ìš© ê´€ë¦¬ ì‹œíŠ¸

// ë‹¨ê°€í‘œ ì‹œíŠ¸ ID (Phase 2ì—ì„œ ì‚¬ìš©)
const PRICE_SHEET_IDS = {
  SUPPORT: '12Jx-Y2EXGjsIulWvw9Cr4kVOZQwQPdBQtIRi90rUTJc',      // ì´í†µì‚¬ì§€ì›ê¸ˆ
  PLAN_GROUP: '1vw5BzmtS7vvDqbrWJcqvqwEW63NV2SzQgf9Bt9NExm0',   // ìš”ê¸ˆì œê·¸ë£¹í•‘
  MOBILE_PRICE: '1Vy8Qhce3B6_41TxRfVUs883ioLxiGTUjkbD_nKebgrs',  // ë¬´ì„ ê³µì§€ìš©ë‹¨ê°€í‘œ
  MOBILE_GSB: '1NrWlDCtvsm8szOwrn505L8f8rhMvAfoVhwwE-loWzqU',   // ë¬´ì„ (GSB)
  MOBILE_GSA: '1fFDdnmb_kROHzNnGqE6yIgBUkxipHdaFZPqO1_Lon8I',   // ë¬´ì„ (GSA)
  MOBILE_S: '1zqhmIn9_nyPr2Ar-S4EBjw3ojahcz9csObu9zDHoKgE',     // ë¬´ì„ (S)
  MOBILE_DIRECT: '1PZJTaVf9ezRHVYyEbIAvQZ-kpXKMJyexTMcWtcs7z2k', // ë¬´ì„ (ì§ì˜)
  MOBILE_L: '1aqz-Q3rwE_s0rMWEyeYNhIpEE3V1KXBj3Dw9USiTqAc',     // ë¬´ì„ (L)
  MOBILE_BK: '1I3Jzq0O5-8u8PzCmGvCuXUcqieSROOYUlZjxg8k0Uio',    // ë¬´ì„ (BK)
  WIRE_PRICE: '1d0DgeCBL80PCTBkdArFAbQpAe_oPGqkzOVQ-fp_oUTI'    // ìœ ì„ ê³µì§€ìš©ë‹¨ê°€í‘œ
};

const NORMALIZATION_HISTORY_SHEET_NAME = 'ì •ê·œí™”ì´ë ¥';  // ì •ê·œí™” ì´ë ¥ ë°ì´í„°
const INSPECTION_MEMO_SHEET_NAME = 'ì—¬ì§ì›ê²€ìˆ˜ë°ì´í„°ë©”ëª¨';  // ì—¬ì§ì› ê²€ìˆ˜ ë°ì´í„° ë©”ëª¨ ì‹œíŠ¸ ì¶”ê°€
const INSPECTION_SETTINGS_SHEET_NAME = 'ê²€ìˆ˜ì„¤ì •';  // ê²€ìˆ˜ ì„¤ì • ì‹œíŠ¸
const RESERVATION_SITE_SHEET_NAME = 'ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸';  // ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ì‹œíŠ¸
const YARD_RECEIPT_SHEET_NAME = 'ë§ˆë‹¹ì ‘ìˆ˜';  // ë§ˆë‹¹ì ‘ìˆ˜ ì‹œíŠ¸
const ON_SALE_SHEET_NAME = 'ì˜¨ì„¸ì¼';  // ì˜¨ì„¸ì¼ ì‹œíŠ¸
const POS_CODE_MAPPING_SHEET_NAME = 'POSì½”ë“œë³€ê²½ì„¤ì •';  // POSì½”ë“œë³€ê²½ì„¤ì • ì‹œíŠ¸
const NORMALIZATION_WORK_SHEET_NAME = 'ì •ê·œí™”ì‘ì—…';
const SUBSCRIBER_INCREASE_SHEET_NAME = 'ê°€ì…ìì¦ê°';  // ê°€ì…ìì¦ê° ì‹œíŠ¸  // ì •ê·œí™”ì‘ì—… ì‹œíŠ¸

// ì›”ê°„ì‹œìƒ ê´€ë ¨ ì‹œíŠ¸ ì´ë¦„ ì¶”ê°€
const PHONEKL_HOME_DATA_SHEET_NAME = 'í°í´í™ˆë°ì´í„°';  // í°í´í™ˆë°ì´í„° ì‹œíŠ¸
const MONTHLY_AWARD_SETTINGS_SHEET_NAME = 'ì¥í‘œëª¨ë“œì…‹íŒ…ë©”ë‰´';  // ì›”ê°„ì‹œìƒ ì…‹íŒ… ë©”ë‰´ ì‹œíŠ¸
const CUSTOMER_QUEUE_SHEET_NAME = 'ì§ì˜ì _êµ¬ë§¤ëŒ€ê¸°';
const CUSTOMER_PRE_APPROVAL_SHEET_NAME = 'ì§ì˜ì _ì‚¬ì „ìŠ¹ë‚™ì„œë§ˆí¬';
const CUSTOMER_STORE_PHOTO_SHEET_NAME = 'ì§ì˜ì _ë§¤ì¥ì‚¬ì§„';
const CUSTOMER_BOARD_SHEET_NAME = 'ì§ì˜ì _ê²Œì‹œíŒ';
const TRANSIT_LOCATION_SHEET_NAME = 'ì§ì˜ì _ëŒ€ì¤‘êµí†µìœ„ì¹˜';
const HEADERS_STORE_PHOTO = [
  'ì—…ì²´ëª…',                    // 0
  'ì „ë©´ì‚¬ì§„URL',               // 1
  'ì „ë©´ì‚¬ì§„Discordë©”ì‹œì§€ID',   // 2
  'ì „ë©´ì‚¬ì§„Discordí¬ìŠ¤íŠ¸ID',   // 3
  'ì „ë©´ì‚¬ì§„DiscordìŠ¤ë ˆë“œID',   // 4
  'ë‚´ë¶€ì‚¬ì§„URL',               // 5
  'ë‚´ë¶€ì‚¬ì§„Discordë©”ì‹œì§€ID',   // 6
  'ë‚´ë¶€ì‚¬ì§„Discordí¬ìŠ¤íŠ¸ID',   // 7
  'ë‚´ë¶€ì‚¬ì§„DiscordìŠ¤ë ˆë“œID',   // 8
  'ì™¸ë¶€ì‚¬ì§„URL',               // 9
  'ì™¸ë¶€ì‚¬ì§„Discordë©”ì‹œì§€ID',   // 10
  'ì™¸ë¶€ì‚¬ì§„Discordí¬ìŠ¤íŠ¸ID',   // 11
  'ì™¸ë¶€ì‚¬ì§„DiscordìŠ¤ë ˆë“œID',   // 12
  'ì™¸ë¶€2ì‚¬ì§„URL',              // 13
  'ì™¸ë¶€2ì‚¬ì§„Discordë©”ì‹œì§€ID',  // 14
  'ì™¸ë¶€2ì‚¬ì§„Discordí¬ìŠ¤íŠ¸ID',  // 15
  'ì™¸ë¶€2ì‚¬ì§„DiscordìŠ¤ë ˆë“œID',  // 16
  'ì ì¥ì‚¬ì§„URL',               // 17
  'ì ì¥ì‚¬ì§„Discordë©”ì‹œì§€ID',   // 18
  'ì ì¥ì‚¬ì§„Discordí¬ìŠ¤íŠ¸ID',   // 19
  'ì ì¥ì‚¬ì§„DiscordìŠ¤ë ˆë“œID',   // 20
  'ì§ì›1ì‚¬ì§„URL',              // 21
  'ì§ì›1ì‚¬ì§„Discordë©”ì‹œì§€ID',  // 22
  'ì§ì›1ì‚¬ì§„Discordí¬ìŠ¤íŠ¸ID',  // 23
  'ì§ì›1ì‚¬ì§„DiscordìŠ¤ë ˆë“œID',  // 24
  'ì§ì›2ì‚¬ì§„URL',              // 25
  'ì§ì›2ì‚¬ì§„Discordë©”ì‹œì§€ID',  // 26
  'ì§ì›2ì‚¬ì§„Discordí¬ìŠ¤íŠ¸ID',  // 27
  'ì§ì›2ì‚¬ì§„DiscordìŠ¤ë ˆë“œID',  // 28
  'ì§ì›3ì‚¬ì§„URL',              // 29
  'ì§ì›3ì‚¬ì§„Discordë©”ì‹œì§€ID',  // 30
  'ì§ì›3ì‚¬ì§„Discordí¬ìŠ¤íŠ¸ID',  // 31
  'ì§ì›3ì‚¬ì§„DiscordìŠ¤ë ˆë“œID',  // 32
  'ìˆ˜ì •ì¼ì‹œ',                  // 33
  'ë²„ìŠ¤í„°ë¯¸ë„IDëª©ë¡',          // 34 - JSON ë°°ì—´ ["ID1", "ID2"]
  'ì§€í•˜ì² ì—­IDëª©ë¡'             // 35 - JSON ë°°ì—´ ["ID1", "ID2"]
];
const HEADERS_TRANSIT_LOCATION = [
  'ID',                        // 0 - ê³ ìœ  ID (ìë™ ìƒì„±)
  'íƒ€ì…',                      // 1 - "ë²„ìŠ¤í„°ë¯¸ë„" ë˜ëŠ” "ì§€í•˜ì² ì—­"
  'ì´ë¦„',                      // 2
  'ì£¼ì†Œ',                      // 3
  'ìœ„ë„',                      // 4
  'ê²½ë„',                      // 5
  'ìˆ˜ì •ì¼ì‹œ'                   // 6
];
const CUSTOMER_QUEUE_HEADERS = [
  'ë²ˆí˜¸', 'ê³ ê°CTN', 'ê³ ê°ëª…', 'í†µì‹ ì‚¬', 'ë‹¨ë§ê¸°ëª¨ë¸ëª…', 'ìƒ‰ìƒ', 'ë‹¨ë§ì¼ë ¨ë²ˆí˜¸', 'ìœ ì‹¬ëª¨ë¸ëª…', 'ìœ ì‹¬ì¼ë ¨ë²ˆí˜¸', 'ê°œí†µìœ í˜•',
  'ì „í†µì‹ ì‚¬', 'í• ë¶€êµ¬ë¶„', 'í• ë¶€ê°œì›”', 'ì•½ì •', 'ìš”ê¸ˆì œ', 'ë¶€ê°€ì„œë¹„ìŠ¤', 'ì¶œê³ ê°€', 'ì´í†µì‚¬ì§€ì›ê¸ˆ', 'ëŒ€ë¦¬ì ì¶”ê°€ì§€ì›ê¸ˆ(ë¶€ê°€ìœ ì¹˜)',
  'ëŒ€ë¦¬ì ì¶”ê°€ì§€ì›ê¸ˆ(ë¶€ê°€ë¯¸ìœ ì¹˜)', 'ì„ íƒë§¤ì¥ì—…ì²´ëª…', 'ì„ íƒë§¤ì¥ì „í™”', 'ì„ íƒë§¤ì¥ì£¼ì†Œ', 'ì„ íƒë§¤ì¥ê³„ì¢Œì •ë³´', 'ë“±ë¡ì¼ì‹œ', 'ìƒíƒœ',
  'ì²˜ë¦¬ë§¤ì¥ì—…ì²´ëª…', 'ì²˜ë¦¬ì¼ì‹œ'
];
const CUSTOMER_BOARD_HEADERS = [
  'ë²ˆí˜¸', 'ì¹´í…Œê³ ë¦¬', 'ì œëª©', 'ë‚´ìš©', 'ê³ ê°ëª…', 'ê³ ê°CTN', 'ë§¤ì¥ëª…', 'ë§¤ì¥ì „í™”', 'ë§¤ì¥ì£¼ì†Œ', 'ë“±ë¡ì¼ì‹œ', 'ìˆ˜ì •ì¼ì‹œ', 'ìƒíƒœ'
];

// ì‚¬ìš©ì ê¶Œí•œ ì¡°íšŒ í•¨ìˆ˜
async function getUserRole(userId) {
  try {
    const sheets = google.sheets({ version: 'v4', auth });
    const response = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${AGENT_SHEET_NAME}!A:R`
    });

    const agentValues = response.data.values || [];
    if (agentValues.length > 1) {
      const agentRows = agentValues.slice(1);
      const match = agentRows.find(row => row[2] === userId); // Cì—´: ì—°ë½ì²˜(ì•„ì´ë””)
      if (match) {
        return (match[17] || '').trim(); // Rì—´: ê¶Œí•œë ˆë²¨
      }
    }
    return null;
  } catch (error) {
    console.error('ì‚¬ìš©ì ê¶Œí•œ ì¡°íšŒ ì‹¤íŒ¨:', error.message);
    return null;
  }
}

// Kakao geocoding í•¨ìˆ˜ (ê°œì„ ëœ ë²„ì „)
async function geocodeAddressWithKakao(address, retryCount = 0) {
  const apiKey = process.env.KAKAO_API_KEY;
  if (!apiKey) {
    console.error('âŒ [ì§€ì˜¤ì½”ë”©] KAKAO_API_KEY í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.');
    throw new Error('KAKAO_API_KEY í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.');
  }

  // ì£¼ì†Œ ì „ì²˜ë¦¬
  const cleanAddress = address.toString().trim();
  if (!cleanAddress) {
    return null;
  }

  // ì£¼ì†Œì— "ì‹œ" ë˜ëŠ” "êµ¬"ê°€ í¬í•¨ë˜ì–´ ìˆì§€ ì•Šìœ¼ë©´ ê¸°ë³¸ ì§€ì—­ ì¶”ê°€
  let processedAddress = cleanAddress;
  if (!cleanAddress.includes('ì‹œ') && !cleanAddress.includes('êµ¬') && !cleanAddress.includes('êµ°')) {
    processedAddress = `ê²½ê¸°ë„ ${cleanAddress}`;
  }

  const encodedAddress = encodeURIComponent(processedAddress);
  const url = `https://dapi.kakao.com/v2/local/search/address.json?query=${encodedAddress}`;

  try {
    const response = await fetch(url, {
      headers: {
        'Authorization': `KakaoAK ${apiKey}`
      },
      timeout: 10000 // 10ì´ˆ íƒ€ì„ì•„ì›ƒ
    });

    if (!response.ok) {
      if (response.status === 429) {
        // í• ë‹¹ëŸ‰ ì´ˆê³¼
        await new Promise(resolve => setTimeout(resolve, 5000));
        if (retryCount < 2) {
          return await geocodeAddressWithKakao(address, retryCount + 1);
        }
      }
      throw new Error(`Kakao geocoding API ì˜¤ë¥˜: ${response.status} - ${response.statusText}`);
    }

    const data = await response.json();

    if (data.documents && data.documents.length > 0) {
      const doc = data.documents[0];
      const result = {
        latitude: parseFloat(doc.y),
        longitude: parseFloat(doc.x)
      };
      return result;
    } else {
      return null;
    }
  } catch (error) {
    console.error(`Geocoding ì˜¤ë¥˜ (${retryCount + 1}/3): ${processedAddress}`, error.message);

    // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë‚˜ ì¼ì‹œì  ì˜¤ë¥˜ì¸ ê²½ìš° ì¬ì‹œë„
    if (retryCount < 2 && (error.message.includes('fetch') || error.message.includes('timeout'))) {
      await new Promise(resolve => setTimeout(resolve, 2000 * (retryCount + 1))); // ì§€ìˆ˜ ë°±ì˜¤í”„
      return await geocodeAddressWithKakao(address, retryCount + 1);
    }

    throw error;
  }
}

// ë©”ì¸ geocoding í•¨ìˆ˜ (Kakaoë§Œ ì‚¬ìš©)
async function geocodeAddress(address) {
  return await geocodeAddressWithKakao(address);
}

// Geocoder ì„¤ì • (ê¸°ì¡´ ì½”ë“œì™€ í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€)
const geocoder = {
  geocode: async (address) => {
    const result = await geocodeAddress(address);
    return result ? [result] : [];
  }
};

// Google API ì¸ì¦ ì„¤ì •
const auth = new google.auth.JWT({
  email: GOOGLE_SERVICE_ACCOUNT_EMAIL,
  key: GOOGLE_PRIVATE_KEY.includes('\\n') ? GOOGLE_PRIVATE_KEY.replace(/\\n/g, '\n') : GOOGLE_PRIVATE_KEY,
  scopes: [
    'https://www.googleapis.com/auth/spreadsheets',
    'https://www.googleapis.com/auth/drive.file' // Google Drive íŒŒì¼ ì—…ë¡œë“œ ê¶Œí•œ
  ]
});

// ì›ë³¸ Google Sheets API ì´ˆê¸°í™” (íƒ€ì„ì•„ì›ƒ ì„¤ì • í¬í•¨)
const originalSheets = google.sheets({
  version: 'v4',
  auth,
  timeout: 60000 // 60ì´ˆ íƒ€ì„ì•„ì›ƒ
});

// Google Drive API í´ë¼ì´ì–¸íŠ¸ ìƒì„±
const drive = google.drive({ version: 'v3', auth });

// ==================== Google Drive API ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ ====================
// ëª¨ë‹ˆí„°ë§ ë°ì´í„° ì €ì¥ (ë©”ëª¨ë¦¬ ê¸°ë°˜, ì„œë²„ ì¬ì‹œì‘ ì‹œ ì´ˆê¸°í™”ë¨)
const driveMonitoring = {
  // ì¼ì¼ í˜¸ì¶œëŸ‰ ì¶”ì  (ë‚ ì§œë³„)
  dailyCalls: new Map(), // key: YYYY-MM-DD, value: { count: number, errors: number }
  // ìµœê·¼ í˜¸ì¶œ ê¸°ë¡ (ìµœëŒ€ 1000ê°œ)
  recentCalls: [],
  // ì„ê³„ê°’ ì„¤ì •
  threshold: {
    dailyCalls: 10000, // ì¼ì¼ 10,000íšŒ ì´ìƒ ì‹œ ê²½ê³ 
    errorRate: 0.05 // ì—ëŸ¬ìœ¨ 5% ì´ìƒ ì‹œ ê²½ê³ 
  }
};

// Google Drive API í˜¸ì¶œ ë˜í¼ í•¨ìˆ˜ (ëª¨ë‹ˆí„°ë§ í¬í•¨)
async function monitoredDriveCall(operation, params) {
  const timestamp = new Date();
  const dateKey = timestamp.toISOString().split('T')[0]; // YYYY-MM-DD
  const operationName = operation; // 'files.list', 'files.create', 'permissions.create' ë“±
  
  // ì¼ì¼ í˜¸ì¶œëŸ‰ ì´ˆê¸°í™” (ì—†ìœ¼ë©´)
  if (!driveMonitoring.dailyCalls.has(dateKey)) {
    driveMonitoring.dailyCalls.set(dateKey, { count: 0, errors: 0, operations: {} });
  }
  const dailyStats = driveMonitoring.dailyCalls.get(dateKey);
  
  // í˜¸ì¶œ ì‹œì‘
  dailyStats.count++;
  if (!dailyStats.operations[operationName]) {
    dailyStats.operations[operationName] = 0;
  }
  dailyStats.operations[operationName]++;
  
  const callRecord = {
    timestamp: timestamp.toISOString(),
    operation: operationName,
    params: JSON.stringify(params).substring(0, 200), // íŒŒë¼ë¯¸í„° ì¼ë¶€ë§Œ ì €ì¥ (ë„ˆë¬´ ê¸¸ë©´ ì˜ë¦¼)
    success: false,
    error: null,
    duration: null
  };
  
  const startTime = Date.now();
  
  try {
    let result;
    
    // ì‹¤ì œ Drive API í˜¸ì¶œ
    switch (operation) {
      case 'files.list':
        result = await drive.files.list(params);
        break;
      case 'files.get':
        result = await drive.files.get(params);
        break;
      case 'files.create':
        result = await drive.files.create(params);
        break;
      case 'permissions.create':
        result = await drive.permissions.create(params);
        break;
      default:
        throw new Error(`Unknown operation: ${operation}`);
    }
    
    const duration = Date.now() - startTime;
    callRecord.success = true;
    callRecord.duration = duration;
    
    // ìµœê·¼ í˜¸ì¶œ ê¸°ë¡ì— ì¶”ê°€ (ìµœëŒ€ 1000ê°œ ìœ ì§€)
    driveMonitoring.recentCalls.push(callRecord);
    if (driveMonitoring.recentCalls.length > 1000) {
      driveMonitoring.recentCalls.shift(); // ì˜¤ë˜ëœ ê²ƒ ì œê±°
    }
    
    // ì„ê³„ê°’ ì²´í¬ ë° ê²½ê³ 
    checkThresholds(dateKey, dailyStats);
    
    return result;
  } catch (error) {
    const duration = Date.now() - startTime;
    callRecord.success = false;
    callRecord.error = error.message || error.toString();
    callRecord.duration = duration;
    
    // ì—ëŸ¬ ì¹´ìš´íŠ¸ ì¦ê°€
    dailyStats.errors++;
    
    // ìµœê·¼ í˜¸ì¶œ ê¸°ë¡ì— ì¶”ê°€
    driveMonitoring.recentCalls.push(callRecord);
    if (driveMonitoring.recentCalls.length > 1000) {
      driveMonitoring.recentCalls.shift();
    }
    
    // ì„ê³„ê°’ ì²´í¬ ë° ê²½ê³ 
    checkThresholds(dateKey, dailyStats);
    
    throw error;
  }
}

// ì„ê³„ê°’ ì²´í¬ ë° ê²½ê³  í•¨ìˆ˜
function checkThresholds(dateKey, dailyStats) {
  const { threshold } = driveMonitoring;
  const errorRate = dailyStats.count > 0 ? dailyStats.errors / dailyStats.count : 0;
  
  // ì¼ì¼ í˜¸ì¶œëŸ‰ ê²½ê³ 
  if (dailyStats.count >= threshold.dailyCalls) {
    console.warn(`âš ï¸ [Google Drive ëª¨ë‹ˆí„°ë§] ì¼ì¼ í˜¸ì¶œëŸ‰ ì„ê³„ê°’ ì´ˆê³¼: ${dailyStats.count}íšŒ (ì„ê³„ê°’: ${threshold.dailyCalls}íšŒ)`);
  }
  
  // ì—ëŸ¬ìœ¨ ê²½ê³ 
  if (errorRate >= threshold.errorRate) {
    console.warn(`âš ï¸ [Google Drive ëª¨ë‹ˆí„°ë§] ì—ëŸ¬ìœ¨ ì„ê³„ê°’ ì´ˆê³¼: ${(errorRate * 100).toFixed(2)}% (ì„ê³„ê°’: ${(threshold.errorRate * 100).toFixed(2)}%)`);
  }
}

// ëª¨ë‹ˆí„°ë§ ë°ì´í„° ì¡°íšŒ í•¨ìˆ˜
function getDriveMonitoringData(days = 7) {
  const now = new Date();
  const data = [];
  
  // ìµœê·¼ Nì¼ ë°ì´í„° ìˆ˜ì§‘
  for (let i = 0; i < days; i++) {
    const date = new Date(now);
    date.setDate(date.getDate() - i);
    const dateKey = date.toISOString().split('T')[0];
    
    const dailyStats = driveMonitoring.dailyCalls.get(dateKey) || { count: 0, errors: 0, operations: {} };
    const errorRate = dailyStats.count > 0 ? dailyStats.errors / dailyStats.count : 0;
    
    data.push({
      date: dateKey,
      totalCalls: dailyStats.count,
      errors: dailyStats.errors,
      errorRate: errorRate,
      operations: dailyStats.operations,
      thresholdExceeded: {
        dailyCalls: dailyStats.count >= driveMonitoring.threshold.dailyCalls,
        errorRate: errorRate >= driveMonitoring.threshold.errorRate
      }
    });
  }
  
  // ìµœê·¼ í˜¸ì¶œ ê¸°ë¡ (ìµœê·¼ 100ê°œ)
  const recentCalls = driveMonitoring.recentCalls.slice(-100).reverse();
  
  // ì „ì²´ í†µê³„
  const totalStats = {
    today: {
      date: now.toISOString().split('T')[0],
      ...(driveMonitoring.dailyCalls.get(now.toISOString().split('T')[0]) || { count: 0, errors: 0, operations: {} })
    },
    threshold: driveMonitoring.threshold,
    recentErrors: recentCalls.filter(call => !call.success).slice(0, 20)
  };
  
  return {
    dailyData: data.reverse(), // ì˜¤ë˜ëœ ê²ƒë¶€í„°
    recentCalls: recentCalls,
    totalStats: totalStats
  };
}

// ==================== ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ ë ====================

// UserSheetManager ë° PhoneklDataManager ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
const userSheetManager = new UserSheetManager(originalSheets, SPREADSHEET_ID);
const phoneklDataManager = new PhoneklDataManager(originalSheets, SPREADSHEET_ID);

// ëª¨ë“  API í˜¸ì¶œì„ ì¶”ì í•˜ëŠ” ë˜í¼ í•¨ìˆ˜ (ë¡œê·¸ ìµœì í™”)
function createTrackedSheets() {
  return {
    spreadsheets: {
      values: {
        get: async (params) => {
          // ë¡œê·¸ ìµœì†Œí™” - ì„±ëŠ¥ ìµœì í™”
          // const timestamp = new Date().toISOString();
          // console.log(`ğŸš¨ [API-TRACE] GET ì‹œì‘: ${timestamp} - Range: ${params.range}`);
          const result = await originalSheets.spreadsheets.values.get(params);
          // console.log(`ğŸš¨ [API-TRACE] GET ì™„ë£Œ: ${new Date().toISOString()} - Range: ${params.range}`);
          return result;
        },
        update: async (params) => {
          // ë¡œê·¸ ìµœì†Œí™” - ì„±ëŠ¥ ìµœì í™”
          // const timestamp = new Date().toISOString();
          // console.log(`ğŸš¨ [API-TRACE] UPDATE ì‹œì‘: ${timestamp} - Range: ${params.range}`);
          const result = await originalSheets.spreadsheets.values.update(params);
          // console.log(`ğŸš¨ [API-TRACE] UPDATE ì™„ë£Œ: ${new Date().toISOString()} - Range: ${params.range}`);
          return result;
        },
        append: async (params) => {
          // ë¡œê·¸ ìµœì†Œí™” - ì„±ëŠ¥ ìµœì í™”
          // const timestamp = new Date().toISOString();
          // console.log(`ğŸš¨ [API-TRACE] APPEND ì‹œì‘: ${timestamp} - Range: ${params.range}`);
          const result = await originalSheets.spreadsheets.values.append(params);
          // console.log(`ğŸš¨ [API-TRACE] APPEND ì™„ë£Œ: ${new Date().toISOString()} - Range: ${params.range}`);
          return result;
        },
        batchUpdate: async (params) => {
          // ë¡œê·¸ ìµœì†Œí™” - ì„±ëŠ¥ ìµœì í™”
          // const timestamp = new Date().toISOString();
          // console.log(`ğŸš¨ [API-TRACE] BATCH_UPDATE ì‹œì‘: ${timestamp} - SpreadsheetId: ${params.spreadsheetId}`);
          const result = await originalSheets.spreadsheets.values.batchUpdate(params);
          // console.log(`ğŸš¨ [API-TRACE] BATCH_UPDATE ì™„ë£Œ: ${new Date().toISOString()} - SpreadsheetId: ${params.spreadsheetId}`);
          return result;
        }
      },
      get: async (params) => {
        return await originalSheets.spreadsheets.get(params);
      },
      batchUpdate: async (params) => {
        // ë¡œê·¸ ìµœì†Œí™” - ì„±ëŠ¥ ìµœì í™”
        // const timestamp = new Date().toISOString();
        // console.log(`ğŸš¨ [API-TRACE] SPREADSHEET_BATCH_UPDATE ì‹œì‘: ${timestamp} - SpreadsheetId: ${params.spreadsheetId}`);
        const result = await originalSheets.spreadsheets.batchUpdate(params);
        // console.log(`ğŸš¨ [API-TRACE] SPREADSHEET_BATCH_UPDATE ì™„ë£Œ: ${new Date().toISOString()} - SpreadsheetId: ${params.spreadsheetId}`);
        return result;
      }
    }
  };
}

const sheets = createTrackedSheets();

// ë°ì´í„° ì‹œíŠ¸ì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸° (ìºì‹± ì ìš©)
async function getSheetValues(sheetName, spreadsheetId = SPREADSHEET_ID) {
  const cacheKey = `sheet_${sheetName}_${spreadsheetId}`;

  // ìºì‹œì—ì„œ ë¨¼ì € í™•ì¸
  const cachedData = cacheUtils.get(cacheKey);
  if (cachedData) {
    return cachedData;
  }

  return await fetchSheetValuesDirectly(sheetName, spreadsheetId);
}

// í°í´ê°œí†µë°ì´í„° ìºì‹œ ë¬´íš¨í™” í•¨ìˆ˜
function invalidatePhoneklActivationCache() {
  const cacheKey = `sheet_í°í´ê°œí†µë°ì´í„°_${SPREADSHEET_ID}`;
  cacheUtils.delete(cacheKey);
  console.log('ğŸ—‘ï¸ [ìºì‹œ ë¬´íš¨í™”] í°í´ê°œí†µë°ì´í„° ìºì‹œ ì‚­ì œë¨');
}

// ìºì‹œë¥¼ ë¬´ì‹œí•˜ê³  ì§ì ‘ ì‹œíŠ¸ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
async function getSheetValuesWithoutCache(sheetName) {
  try {
    // ì‹œíŠ¸ ì´ë¦„ì„ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
    const safeSheetName = `'${sheetName}'`; // ì‘ì€ë”°ì˜´í‘œë¡œ ê°ì‹¸ì„œ íŠ¹ìˆ˜ë¬¸ì ì²˜ë¦¬

    // rawë°ì´í„° ì‹œíŠ¸ëŠ” A:AB ë²”ìœ„ í•„ìš” (ABì—´ê¹Œì§€), í°í´ê°œí†µë°ì´í„°ëŠ” A:BZ ë²”ìœ„ í•„ìš” (BZì—´ê¹Œì§€), ì •ì±…_ê¸°ë³¸ì •ë³´ëŠ” A:AC ë²”ìœ„ í•„ìš” (ACì—´ê¹Œì§€), ëŒ€ë¦¬ì ì•„ì´ë””ê´€ë¦¬ëŠ” A:AF ë²”ìœ„ í•„ìš” (AFì—´ê¹Œì§€), ì •ì±…ëª¨ë“œê³µì§€ì‚¬í•­ì€ A:I ë²”ìœ„ í•„ìš” (Iì—´ê¹Œì§€), ì§ì˜ì _ë§¤ì¥ì‚¬ì§„ì€ A:AH ë²”ìœ„ í•„ìš” (AHì—´ê¹Œì§€), ë‚˜ë¨¸ì§€ëŠ” A:AA ë²”ìœ„
    let range;
    if (sheetName === 'rawë°ì´í„°') {
      range = `${safeSheetName}!A:AB`;
    } else if (sheetName === 'í°í´ê°œí†µë°ì´í„°') {
      range = `${safeSheetName}!A:BZ`;
    } else if (sheetName === 'í°í´í™ˆë°ì´í„°') {
      range = `${safeSheetName}!A:CN`;
    } else if (sheetName === 'ì •ì±…_ê¸°ë³¸ì •ë³´ ') {
      range = `${safeSheetName}!A:AX`;  // ë‹´ë‹¹ì AXì—´ê¹Œì§€ í™•ì¥
    } else if (sheetName === 'ëŒ€ë¦¬ì ì•„ì´ë””ê´€ë¦¬') {
      range = `${safeSheetName}!A:AF`;
    } else if (sheetName === 'ì–´í”Œì—…ë°ì´íŠ¸') {
      range = `${safeSheetName}!A:Y`;
    } else if (sheetName === 'ì •ì±…ëª¨ë“œê³µì§€ì‚¬í•­') {
      range = `${safeSheetName}!A:I`;
    } else if (sheetName === 'ì§ì˜ì _ë§¤ì¥ì‚¬ì§„') {
      range = `${safeSheetName}!A:AJ`;  // Discord ì •ë³´ ì»¬ëŸ¼ + ëŒ€ì¤‘êµí†µ ì •ë³´ ì»¬ëŸ¼ í¬í•¨ (A:AJ)
    } else {
      range = `${safeSheetName}!A:AA`;
    }

    const response = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: range
    });

    const data = response.data.values || [];

    // í°í´ê°œí†µë°ì´í„°ì˜ ê²½ìš° ìºì‹œì— ì €ì¥ (5ë¶„ TTL)
    if (sheetName === 'í°í´ê°œí†µë°ì´í„°') {
      const cacheKey = `sheet_${sheetName}_${SPREADSHEET_ID}`;
      cacheUtils.set(cacheKey, data, 5 * 60);
    }

    return data;
  } catch (error) {
    console.error(`Error fetching sheet ${sheetName} without cache:`, error);
    throw error;
  }
}

// ì‹œíŠ¸ì—ì„œ ì§ì ‘ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ê³µí†µ í•¨ìˆ˜
async function fetchSheetValuesDirectly(sheetName, spreadsheetId = SPREADSHEET_ID) {
  // ì‹œíŠ¸ ì´ë¦„ì„ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
  const safeSheetName = `'${sheetName}'`; // ì‘ì€ë”°ì˜´í‘œë¡œ ê°ì‹¸ì„œ íŠ¹ìˆ˜ë¬¸ì ì²˜ë¦¬

  // rawë°ì´í„° ì‹œíŠ¸ëŠ” A:AB ë²”ìœ„ í•„ìš” (ABì—´ê¹Œì§€), í°í´ê°œí†µë°ì´í„°ëŠ” A:BZ ë²”ìœ„ í•„ìš” (BZì—´ê¹Œì§€), ì–´í”Œì—…ë°ì´íŠ¸ëŠ” A:X ë²”ìœ„ í•„ìš” (Xì—´ê¹Œì§€), ëŒ€ë¦¬ì ì•„ì´ë””ê´€ë¦¬ëŠ” A:AF ë²”ìœ„ í•„ìš” (AFì—´ê¹Œì§€), í°í´ì¶œê³ ì²˜ë°ì´í„°ëŠ” A:AM ë²”ìœ„ í•„ìš” (AMì—´ê¹Œì§€), ë§ˆë‹¹ì ‘ìˆ˜ëŠ” A:AI ë²”ìœ„ í•„ìš” (AIì—´ê¹Œì§€), ì§ì˜ì _ë§¤ì¥ì‚¬ì§„ì€ A:AH ë²”ìœ„ í•„ìš” (AHì—´ê¹Œì§€), ë‚˜ë¨¸ì§€ëŠ” A:AA ë²”ìœ„
  let range;
  if (sheetName === 'rawë°ì´í„°') {
    range = `${safeSheetName}!A:AB`;
  } else if (sheetName === 'í°í´ê°œí†µë°ì´í„°') {
    range = `${safeSheetName}!A:BZ`;
  } else if (sheetName === 'í°í´í™ˆë°ì´í„°') {
    range = `${safeSheetName}!A:CN`;
  } else if (sheetName === 'ì–´í”Œì—…ë°ì´íŠ¸') {
    range = `${safeSheetName}!A:Y`;
  } else if (sheetName === 'ëŒ€ë¦¬ì ì•„ì´ë””ê´€ë¦¬') {
    range = `${safeSheetName}!A:AF`;
  } else if (sheetName === 'í°í´ì¶œê³ ì²˜ë°ì´í„°') {
    range = `${safeSheetName}!A:AM`;
  } else if (sheetName === 'ë§ˆë‹¹ì ‘ìˆ˜') {
    range = `${safeSheetName}!A:AI`;
  } else if (sheetName === 'ì§ì˜ì _ë§¤ì¥ì‚¬ì§„') {
    range = `${safeSheetName}!A:AJ`;  // Discord ì •ë³´ ì»¬ëŸ¼ + ëŒ€ì¤‘êµí†µ ì •ë³´ ì»¬ëŸ¼ í¬í•¨ (A:AJ)
  } else {
    range = `${safeSheetName}!A:AA`;
  }

  try {
    // API í˜¸ì¶œ ì œí•œ í™•ì¸
    if (!rateLimitUtils.canMakeRequest()) {
      const waitTime = rateLimitUtils.getWaitTime();
      console.log(`â³ [API-LIMIT] API í˜¸ì¶œ ì œí•œë¨. ${Math.ceil(waitTime / 1000)}ì´ˆ ëŒ€ê¸° ì¤‘...`);
      await new Promise(resolve => setTimeout(resolve, waitTime));
    }

    // API í˜¸ì¶œ ê¸°ë¡
    rateLimitUtils.recordRequest();

    const response = await sheets.spreadsheets.values.get({
      spreadsheetId: spreadsheetId,
      range: range
    });

    const data = response.data.values || [];

    return data;
  } catch (error) {
    // ì¬ì‹œë„ ëŒ€ìƒ ì—ëŸ¬: 429 (Rate Limit), 500 (Internal Server Error), 503 (Service Unavailable), íƒ€ì„ì•„ì›ƒ
    const isRetryableError = error.code === 429 ||
      error.response?.status === 429 ||
      error.response?.status === 500 ||
      error.response?.status === 503 ||
      error.message?.includes('rateLimitExceeded') ||
      error.message?.includes('Internal error encountered') ||
      error.type === 'request-timeout' ||
      error.message?.includes('network timeout');

    if (isRetryableError) {
      const maxRetries = 3;
      let retryCount = 0;

      while (retryCount < maxRetries) {
        const waitTime = Math.min(1000 * Math.pow(2, retryCount), 60000); // 1s â†’ 2s â†’ 4s (ìµœëŒ€ 60ì´ˆ)
        const errorType = error.code === 429 || error.response?.status === 429 ? 'API-LIMIT' :
          error.type === 'request-timeout' ? 'TIMEOUT' : 'SERVER-ERROR';
        console.log(`âš ï¸ [${errorType}] Google API ì—ëŸ¬. ${waitTime / 1000}ì´ˆ ëŒ€ê¸° í›„ ì¬ì‹œë„ (${retryCount + 1}/${maxRetries})...`);
        await new Promise(resolve => setTimeout(resolve, waitTime));

        try {
          const retryResponse = await sheets.spreadsheets.values.get({
            spreadsheetId: spreadsheetId,
            range: range
          });
          console.log(`âœ… [${errorType}] ì¬ì‹œë„ ì„±ê³µ (${retryCount + 1}/${maxRetries})`);
          return retryResponse.data.values || [];
        } catch (retryError) {
          retryCount++;
          if (retryCount >= maxRetries) {
            console.error(`âŒ [${errorType}] ì¬ì‹œë„ ëª¨ë‘ ì‹¤íŒ¨ (${maxRetries}íšŒ ì‹œë„)`);
            throw retryError;
          }
        }
      }
    }

    console.error(`Error fetching sheet ${sheetName}:`, error);

    // ì²« ë²ˆì§¸ ì‹œë„ê°€ ì‹¤íŒ¨í•˜ë©´ ì‹œíŠ¸ ëª©ë¡ì„ ê°€ì ¸ì™€ì„œ ì •í™•í•œ ì´ë¦„ í™•ì¸
    try {
      console.log(`ğŸ”„ [ì‹œíŠ¸ì¡°íšŒ] ì‹œíŠ¸ ëª©ë¡ í™•ì¸ ì¤‘...`);
      const spreadsheet = await sheets.spreadsheets.get({
        spreadsheetId: spreadsheetId
      });

      const sheetNames = spreadsheet.data.sheets.map(sheet => sheet.properties.title);
      console.log(`ğŸ“‹ [ì‹œíŠ¸ì¡°íšŒ] ì‚¬ìš© ê°€ëŠ¥í•œ ì‹œíŠ¸:`, sheetNames);

      // ì •í™•í•œ ì‹œíŠ¸ ì´ë¦„ ì°¾ê¸°
      const exactSheetName = sheetNames.find(name => name === sheetName);
      if (exactSheetName) {
        console.log(`âœ… [ì‹œíŠ¸ì¡°íšŒ] ì •í™•í•œ ì‹œíŠ¸ ì´ë¦„ ë°œê²¬: '${exactSheetName}'`);
        const safeSheetName = `'${exactSheetName}'`;

        // rawë°ì´í„° ì‹œíŠ¸ëŠ” A:AB ë²”ìœ„ í•„ìš” (ABì—´ê¹Œì§€), ëŒ€ë¦¬ì ì•„ì´ë””ê´€ë¦¬ëŠ” A:AF ë²”ìœ„ í•„ìš”, ë‚˜ë¨¸ì§€ëŠ” A:AA ë²”ìœ„
        const retryRange =
          sheetName === 'rawë°ì´í„°'
            ? `${safeSheetName}!A:AB`
            : sheetName === 'ëŒ€ë¦¬ì ì•„ì´ë””ê´€ë¦¬'
              ? `${safeSheetName}!A:AF`
              : `${safeSheetName}!A:AA`;

        const retryResponse = await sheets.spreadsheets.values.get({
          spreadsheetId: spreadsheetId,
          range: retryRange
        });

        const data = retryResponse.data.values || [];
        return data;
      } else {
        console.error(`âŒ [ì‹œíŠ¸ì¡°íšŒ] ì‹œíŠ¸ '${sheetName}'ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
        throw new Error(`Sheet '${sheetName}' not found. Available sheets: ${sheetNames.join(', ')}`);
      }
    } catch (retryError) {
      console.error(`âŒ [ì‹œíŠ¸ì¡°íšŒ] ì¬ì‹œë„ ì‹¤íŒ¨:`, retryError);
      throw error; // ì›ë˜ ì˜¤ë¥˜ë¥¼ ë‹¤ì‹œ ë˜ì§
    }
  }
}

// VLOOKUP í•¨ìˆ˜ (í°í´ì¶œê³ ì²˜ë°ì´í„°ì—ì„œ POSì½”ë“œë¡œ ì—…ì²´ëª… ì°¾ê¸°)
function vlookupPosCodeToStoreName(posCode, storeData) {
  if (!posCode || !storeData || storeData.length === 0) {
    return null;
  }

  const searchPosCode = posCode.toString().trim();

  // Pì—´(POSì½”ë“œ)ì—ì„œ ê²€ìƒ‰í•˜ì—¬ Oì—´(ì—…ì²´ëª…) ë°˜í™˜
  for (let i = 1; i < storeData.length; i++) { // í—¤ë” ì œì™¸í•˜ê³  ê²€ìƒ‰
    const row = storeData[i];
    if (row && row.length > 14) { // ìµœì†Œ Pì—´(14)ì€ ìˆì–´ì•¼ í•¨
      const storePosCode = (row[14] || '').toString().trim(); // Pì—´: POSì½”ë“œ
      if (storePosCode === searchPosCode) {
        return (row[13] || '').toString().trim(); // Oì—´: ì—…ì²´ëª…
      }
    }
  }

  return null;
}

// VLOOKUP í•¨ìˆ˜ (í°í´ì¶œê³ ì²˜ë°ì´í„°ì—ì„œ ì—…ì²´ëª…ìœ¼ë¡œ POSì½”ë“œ ì°¾ê¸°)
function vlookupStoreNameToPosCode(storeName, storeData) {
  if (!storeName || !storeData || storeData.length === 0) {
    return null;
  }

  const searchStoreName = storeName.toString().trim();

  // Oì—´(ì—…ì²´ëª…)ì—ì„œ ê²€ìƒ‰í•˜ì—¬ Pì—´(POSì½”ë“œ) ë°˜í™˜
  for (let i = 1; i < storeData.length; i++) { // í—¤ë” ì œì™¸í•˜ê³  ê²€ìƒ‰
    const row = storeData[i];
    if (row && row.length > 14) { // ìµœì†Œ Pì—´(14)ì€ ìˆì–´ì•¼ í•¨
      const rowStoreName = (row[13] || '').toString().trim(); // Oì—´: ì—…ì²´ëª…
      if (rowStoreName === searchStoreName) {
        return (row[14] || '').toString().trim(); // Pì—´: POSì½”ë“œ
      }
    }
  }

  return null;
}

// ì—¬ì§ì›ê²€ìˆ˜ë°ì´í„°ë©”ëª¨ ì‹œíŠ¸ ê´€ë¦¬ í•¨ìˆ˜ë“¤
async function loadInspectionMemoData() {
  try {
    const memoData = await getSheetValues(INSPECTION_MEMO_SHEET_NAME);
    if (!memoData || memoData.length <= 1) {
      return { completionStatus: new Map(), notes: new Map() };
    }

    const completionStatus = new Map();
    const notes = new Map();

    // í—¤ë” ì œì™¸í•˜ê³  ë°ì´í„° ì²˜ë¦¬ (ìƒˆë¡œìš´ êµ¬ì¡°: ê³ ìœ í‚¤, ê°€ì…ë²ˆí˜¸, ì‚¬ìš©ìID, ì™„ë£Œìƒíƒœ, ë©”ëª¨ë‚´ìš©, ì—…ë°ì´íŠ¸ì‹œê°„, í•„ë“œêµ¬ë¶„)
    for (let i = 1; i < memoData.length; i++) {
      const row = memoData[i];
      if (row && row.length >= 7) {
        const uniqueKey = (row[0] || '').toString().trim(); // Aì—´: ê³ ìœ í‚¤
        const subscriptionNumber = (row[1] || '').toString().trim(); // Bì—´: ê°€ì…ë²ˆí˜¸
        const userId = (row[2] || '').toString().trim(); // Cì—´: ì‚¬ìš©ìID
        const isCompleted = (row[3] || '').toString().trim() === 'ì™„ë£Œ'; // Dì—´: ì™„ë£Œìƒíƒœ
        const memoContent = (row[4] || '').toString().trim(); // Eì—´: ë©”ëª¨ë‚´ìš©
        const updateTime = (row[5] || '').toString().trim(); // Fì—´: ì—…ë°ì´íŠ¸ì‹œê°„
        const fieldType = (row[6] || '').toString().trim(); // Gì—´: í•„ë“œêµ¬ë¶„

        if (uniqueKey && userId) {
          // ì™„ë£Œìƒíƒœ ì €ì¥ (ì™„ë£Œì™€ ëŒ€ê¸° ëª¨ë‘ ì²˜ë¦¬)
          completionStatus.set(uniqueKey, {
            userId,
            isCompleted: isCompleted,  // true ë˜ëŠ” false
            timestamp: updateTime || new Date().toISOString()
          });

          // ë©”ëª¨ë‚´ìš© ì €ì¥ (ë¹ˆ ë¬¸ìì—´ë„ í¬í•¨)
          notes.set(uniqueKey, {
            userId,
            notes: memoContent || '',  // ë¹ˆ ë¬¸ìì—´ë„ ì €ì¥
            timestamp: updateTime || new Date().toISOString()
          });
        }
      }
    }

    return { completionStatus, notes };
  } catch (error) {
    console.error('ì—¬ì§ì›ê²€ìˆ˜ë°ì´í„°ë©”ëª¨ ì‹œíŠ¸ ë¡œë“œ ì‹¤íŒ¨:', error);
    return { completionStatus: new Map(), notes: new Map() };
  }
}

async function saveInspectionMemoData(completionStatus, notes) {
  try {
    const headerRow = ['ê³ ìœ í‚¤', 'ê°€ì…ë²ˆí˜¸', 'ì‚¬ìš©ìID', 'ì™„ë£Œìƒíƒœ', 'ë©”ëª¨ë‚´ìš©', 'ì—…ë°ì´íŠ¸ì‹œê°„', 'í•„ë“œêµ¬ë¶„'];

    // ìµœì¢… ë°ì´í„° í–‰ ìƒì„± (ì™„ë£Œ ìƒíƒœì™€ ëŒ€ê¸° ìƒíƒœ ëª¨ë‘ ì²˜ë¦¬)
    const finalDataRows = [];

    // ëª¨ë“  ìƒíƒœì˜ í•­ëª©ë“¤ ì²˜ë¦¬
    for (const [uniqueKey, status] of completionStatus) {
      // ë©”ëª¨ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
      const noteData = notes.get(uniqueKey);
      const memoContent = noteData ? noteData.notes : '';

      // ê³ ìœ í‚¤ì—ì„œ ê°€ì…ë²ˆí˜¸ ì¶”ì¶œ
      const subscriptionNumber = uniqueKey.split('_')[0];

      // ìƒíƒœì— ë”°ë¥¸ ì™„ë£Œìƒíƒœ í…ìŠ¤íŠ¸ ê²°ì •
      const statusText = status.isCompleted ? 'ì™„ë£Œ' : 'ëŒ€ê¸°';

      // í–‰ ë°ì´í„° ìƒì„±
      const rowData = [
        uniqueKey,                    // ê³ ìœ í‚¤
        subscriptionNumber,           // ê°€ì…ë²ˆí˜¸
        status.userId,               // ì‚¬ìš©ìID
        statusText,                   // ì™„ë£Œìƒíƒœ (ì™„ë£Œ/ëŒ€ê¸°)
        memoContent,                  // ë©”ëª¨ë‚´ìš©
        status.timestamp,             // ì—…ë°ì´íŠ¸ì‹œê°„
        'ì „ì²´'                        // í•„ë“œêµ¬ë¶„
      ];

      finalDataRows.push(rowData);
    }

    // ì‹œíŠ¸ ì—…ë°ì´íŠ¸ (ì™„ë£Œ ìƒíƒœì¸ í•­ëª©ë§Œ)
    if (finalDataRows.length > 0) {
      await sheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: `${INSPECTION_MEMO_SHEET_NAME}!A:G`,
        valueInputOption: 'USER_ENTERED',
        insertDataOption: 'INSERT_ROWS',
        resource: {
          values: [headerRow, ...finalDataRows]
        }
      });
      console.log(`ì—¬ì§ì›ê²€ìˆ˜ë°ì´í„°ë©”ëª¨ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì™„ë£Œ: ${finalDataRows.length}ê°œ í–‰`);
    } else {
      // ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° í—¤ë”ë§Œ ìœ ì§€
      await sheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: `${INSPECTION_MEMO_SHEET_NAME}!A:G`,
        valueInputOption: 'USER_ENTERED',
        insertDataOption: 'INSERT_ROWS',
        resource: {
          values: [headerRow]
        }
      });
      console.log('ì—¬ì§ì›ê²€ìˆ˜ë°ì´í„°ë©”ëª¨ ì‹œíŠ¸ í—¤ë”ë§Œ ìœ ì§€');
    }

    // ğŸ” ë””ë²„ê¹…: í˜„ì¬ ìƒíƒœ ë¡œê·¸
    console.log('ğŸ” [saveInspectionMemoData] í˜„ì¬ ìƒíƒœ:', {
      completionStatusSize: completionStatus.size,
      notesSize: notes.size,
      finalDataRowsCount: finalDataRows.length,
      completionStatusKeys: Array.from(completionStatus.keys()),
      notesKeys: Array.from(notes.keys())
    });

  } catch (error) {
    console.error('ì—¬ì§ì›ê²€ìˆ˜ë°ì´í„°ë©”ëª¨ ì‹œíŠ¸ ì €ì¥ ì‹¤íŒ¨:', error);
  }
}

async function cleanupInspectionMemoData(currentInspectionKeys) {
  try {
    const memoData = await getSheetValues(INSPECTION_MEMO_SHEET_NAME);
    if (!memoData || memoData.length <= 1) {
      return;
    }

    // í˜„ì¬ ê²€ìˆ˜ ëŒ€ìƒì— ìˆëŠ” ê³ ìœ í‚¤ë§Œ í•„í„°ë§
    const validRows = [memoData[0]]; // í—¤ë” ìœ ì§€

    for (let i = 1; i < memoData.length; i++) {
      const row = memoData[i];
      if (row && row.length > 0) {
        const uniqueKey = (row[0] || '').toString().trim();
        if (uniqueKey && currentInspectionKeys.has(uniqueKey)) {
          validRows.push(row);
        }
      }
    }

    // ì‹œíŠ¸ ì—…ë°ì´íŠ¸ (ìœ íš¨í•œ ë°ì´í„°ë§Œ ìœ ì§€)
    if (validRows.length > 1) { // í—¤ë” ì™¸ì— ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°
      await sheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: `${INSPECTION_MEMO_SHEET_NAME}!A:G`,
        valueInputOption: 'USER_ENTERED',
        resource: {
          values: validRows
        }
      });
    } else {
      // ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° í—¤ë”ë§Œ ìœ ì§€
      await sheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: `${INSPECTION_MEMO_SHEET_NAME}!A:G`,
        valueInputOption: 'USER_ENTERED',
        resource: {
          values: [memoData[0]]
        }
      });
    }

  } catch (error) {
    console.error('ì—¬ì§ì›ê²€ìˆ˜ë°ì´í„°ë©”ëª¨ ì‹œíŠ¸ ì •ë¦¬ ì‹¤íŒ¨:', error);
  }
}

// ìš”ê¸ˆì œ VLOOKUP í•¨ìˆ˜ë“¤
function vlookupPlanNameToPlanCode(planName, planData) {
  if (!planName || !planData || planData.length === 0) {
    return null;
  }

  const searchPlanName = planName.toString().trim();

  // Nì—´(ìš”ê¸ˆì œëª…)ì—ì„œ ê²€ìƒ‰í•˜ì—¬ Oì—´(ìš”ê¸ˆì œì½”ë“œ) ë°˜í™˜
  for (let i = 1; i < planData.length; i++) { // í—¤ë” ì œì™¸í•˜ê³  ê²€ìƒ‰
    const row = planData[i];
    if (row && row.length > 14) { // ìµœì†Œ Oì—´(14)ì€ ìˆì–´ì•¼ í•¨
      const rowPlanName = (row[13] || '').toString().trim(); // Nì—´: ìš”ê¸ˆì œëª…
      if (rowPlanName === searchPlanName) {
        return (row[14] || '').toString().trim(); // Oì—´: ìš”ê¸ˆì œì½”ë“œ
      }
    }
  }

  return null;
}

function vlookupPlanNameToPlanType(planName, planData) {
  if (!planName || !planData || planData.length === 0) {
    return null;
  }

  const searchPlanName = planName.toString().trim();

  // Nì—´(ìš”ê¸ˆì œëª…)ì—ì„œ ê²€ìƒ‰í•˜ì—¬ Uì—´(ìš”ê¸ˆì œêµ¬ë¶„) ë°˜í™˜
  for (let i = 1; i < planData.length; i++) { // í—¤ë” ì œì™¸í•˜ê³  ê²€ìƒ‰
    const row = planData[i];
    if (row && row.length > 20) { // ìµœì†Œ Uì—´(20)ì€ ìˆì–´ì•¼ í•¨
      const rowPlanName = (row[13] || '').toString().trim(); // Nì—´: ìš”ê¸ˆì œëª…
      if (rowPlanName === searchPlanName) {
        return (row[20] || '').toString().trim(); // Uì—´: ìš”ê¸ˆì œêµ¬ë¶„
      }
    }
  }

  return null;
}

function vlookupPlanCodeToPlanName(planCode, planData) {
  if (!planCode || !planData || planData.length === 0) {
    return null;
  }

  const searchPlanCode = planCode.toString().trim();

  // Oì—´(ìš”ê¸ˆì œì½”ë“œ)ì—ì„œ ê²€ìƒ‰í•˜ì—¬ Nì—´(ìš”ê¸ˆì œëª…) ë°˜í™˜
  for (let i = 1; i < planData.length; i++) { // í—¤ë” ì œì™¸í•˜ê³  ê²€ìƒ‰
    const row = planData[i];
    if (row && row.length > 14) { // ìµœì†Œ Oì—´(14)ì€ ìˆì–´ì•¼ í•¨
      const rowPlanCode = (row[14] || '').toString().trim(); // Oì—´: ìš”ê¸ˆì œì½”ë“œ
      if (rowPlanCode === searchPlanCode) {
        return (row[13] || '').toString().trim(); // Nì—´: ìš”ê¸ˆì œëª…
      }
    }
  }

  return null;
}

function vlookupPlanCodeToPlanType(planCode, planData) {
  if (!planCode || !planData || planData.length === 0) {
    return null;
  }

  const searchPlanCode = planCode.toString().trim();

  // Oì—´(ìš”ê¸ˆì œì½”ë“œ)ì—ì„œ ê²€ìƒ‰í•˜ì—¬ Uì—´(ìš”ê¸ˆì œêµ¬ë¶„) ë°˜í™˜
  for (let i = 1; i < planData.length; i++) { // í—¤ë” ì œì™¸í•˜ê³  ê²€ìƒ‰
    const row = planData[i];
    if (row && row.length > 20) { // ìµœì†Œ Uì—´(20)ì€ ìˆì–´ì•¼ í•¨
      const rowPlanCode = (row[14] || '').toString().trim(); // Oì—´: ìš”ê¸ˆì œì½”ë“œ
      if (rowPlanCode === searchPlanCode) {
        return (row[20] || '').toString().trim(); // Uì—´: ìš”ê¸ˆì œêµ¬ë¶„
      }
    }
  }

  return null;
}

// Discordë¡œ ë¡œê·¸ ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
async function sendLogToDiscord(embedData) {
  // í•„ìš”í•œ ì„¤ì •ì´ ì—†ìœ¼ë©´ ë¡œê¹… ì•ˆí•¨
  if (!DISCORD_LOGGING_ENABLED) {
    // console.log('Discord ë¡œê¹…ì´ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
    return;
  }

  // ë´‡ ê°ì²´ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì€ ê²½ìš°
  if (!discordBot || !EmbedBuilder) {
    // console.log('Discord ë´‡ì´ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ ì „ì†¡í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }

  try {
    // ë´‡ì´ ì—°ê²°ë˜ì—ˆëŠ”ì§€ í™•ì¸
    if (!discordBot.isReady()) {
      // console.log('Discord ë´‡ì´ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    // ì‚¬ìš©ì ìœ í˜•ì— ë”°ë¼ ì±„ë„ ID ê²°ì •
    const userType = embedData.userType || 'store'; // ê¸°ë³¸ê°’ì€ ì¼ë°˜ ë§¤ì¥
    let channelId = DISCORD_CHANNEL_ID; // ê¸°ë³¸ ì±„ë„

    if (userType === 'agent') {
      channelId = DISCORD_AGENT_CHANNEL_ID;
      // console.log('ê´€ë¦¬ì ë¡œê·¸ ì „ì†¡ - ì±„ë„ ID:', channelId);
    } else {
      channelId = DISCORD_STORE_CHANNEL_ID;
      // console.log('ì¼ë°˜ ë§¤ì¥ ë¡œê·¸ ì „ì†¡ - ì±„ë„ ID:', channelId);
    }

    // ì±„ë„ IDê°€ ì—†ìœ¼ë©´ ë¡œê¹… ì¤‘ë‹¨
    if (!channelId) {
      // console.log(`${userType} ìœ í˜•ì˜ Discord ì±„ë„ IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.`);
      return;
    }

    // console.log('Discord ì±„ë„ì— ë©”ì‹œì§€ ì „ì†¡ ì‹œë„...');
    // console.log('Discord ì±„ë„ ID:', channelId);

    // ì±„ë„ ê°€ì ¸ì˜¤ê¸° ì‹œë„
    let channel = null;
    try {
      channel = await discordBot.channels.fetch(channelId);
    } catch (channelError) {
      console.error(`ì±„ë„ ID ${channelId} ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:`, channelError.message);
      console.error('ì „ì²´ ì˜¤ë¥˜:', channelError);
      return;
    }

    if (!channel) {
      console.error(`ì±„ë„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${channelId}`);
      return;
    }

    // console.log(`ì±„ë„ ì°¾ìŒ: ${channel.name} (${channel.id}), ë©”ì‹œì§€ ì „ì†¡ ì¤‘...`);

    try {
      // EmbedBuilder ìƒì„±
      const embed = new EmbedBuilder()
        .setTitle(embedData.title || 'ì•Œë¦¼')
        .setColor(embedData.color || 0x0099FF);

      // Fields ì¶”ê°€
      if (embedData.fields && Array.isArray(embedData.fields)) {
        embed.addFields(...embedData.fields);
      }

      // íƒ€ì„ìŠ¤íƒ¬í”„ ì„¤ì •
      if (embedData.timestamp) {
        embed.setTimestamp(new Date(embedData.timestamp));
      } else {
        embed.setTimestamp();
      }

      // Footer ì„¤ì •
      if (embedData.footer && embedData.footer.text) {
        embed.setFooter({ text: embedData.footer.text });
      }

      // ë©”ì‹œì§€ ì „ì†¡ ì‹œë„
      const sentMessage = await channel.send({ embeds: [embed] });
      // console.log(`Discord ë©”ì‹œì§€ ì „ì†¡ ì„±ê³µ! ë©”ì‹œì§€ ID: ${sentMessage.id}`);
      return true;
    } catch (embedError) {
      console.error('Embed ìƒì„± ë˜ëŠ” ì „ì†¡ ì¤‘ ì˜¤ë¥˜:', embedError.message);
      console.error('ìì„¸í•œ ì˜¤ë¥˜ ì •ë³´:', embedError);
      return false;
    }
  } catch (error) {
    console.error('Discord ë¡œê·¸ ì „ì†¡ ì¤‘ ì˜¤ë¥˜:', error.message);
    console.error('ìì„¸í•œ ì˜¤ë¥˜ ì •ë³´:', error);
    return false;
  }
}

// ì„œë²„ ìƒíƒœ í™•ì¸ìš© ì—”ë“œí¬ì¸íŠ¸
app.get('/', (req, res) => {
  res.json({
    status: 'Server is running',
    timestamp: new Date().toISOString(),
    cache: cacheUtils.status(),
    env: {
      SHEET_ID: SPREADSHEET_ID ? 'SET' : 'NOT SET',
      GOOGLE_SERVICE_ACCOUNT_EMAIL: GOOGLE_SERVICE_ACCOUNT_EMAIL ? 'SET' : 'NOT SET',
      GOOGLE_PRIVATE_KEY: GOOGLE_PRIVATE_KEY ? 'SET' : 'NOT SET',
      PORT: process.env.PORT || 4000
    }
  });
});

// ì„œë²„ ë²„ì „ ì •ë³´ ì—”ë“œí¬ì¸íŠ¸
app.get('/api/version', (req, res) => {
  res.json({
    version: process.env.npm_package_version || '1.0.0',
    buildTime: Date.now().toString(),
    environment: process.env.NODE_ENV || 'development',
    timestamp: new Date().toISOString()
  });
});

// ìºì‹œ ìƒíƒœ í™•ì¸ìš© ì—”ë“œí¬ì¸íŠ¸
app.get('/api/cache-status', (req, res) => {
  res.json({
    status: 'success',
    cache: cacheUtils.status(),
    timestamp: new Date().toISOString()
  });
});

// ìºì‹œ ê°•ì œ ìƒˆë¡œê³ ì¹¨ ì—”ë“œí¬ì¸íŠ¸
app.post('/api/cache-refresh', (req, res) => {
  const { sheet } = req.body;

  if (sheet) {
    // íŠ¹ì • ì‹œíŠ¸ ìºì‹œë§Œ ì‚­ì œ
    cacheUtils.delete(`sheet_${sheet}`);
    res.json({
      status: 'success',
      message: `ìºì‹œ ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ: ${sheet}`,
      timestamp: new Date().toISOString()
    });
  } else {
    // ì „ì²´ ìºì‹œ ì •ë¦¬
    cacheUtils.cleanup();
    res.json({
      status: 'success',
      message: 'ì „ì²´ ìºì‹œ ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ',
      timestamp: new Date().toISOString()
    });
  }
});

// ì£¼ì†Œë¥¼ ìœ„ë„/ê²½ë„ë¡œ ë³€í™˜í•˜ì—¬ ì‹œíŠ¸ì— ì—…ë°ì´íŠ¸
app.post('/api/update-coordinates', async (req, res) => {
  try {
    // console.log('Updating coordinates...');

    const storeValues = await getSheetValues(STORE_SHEET_NAME);
    if (!storeValues) {
      throw new Error('Failed to fetch data from store sheet');
    }

    // í—¤ë” ì œê±°
    const storeRows = storeValues.slice(1);
    const updates = [];

    for (let i = 0; i < storeRows.length; i++) {
      const row = storeRows[i];
      const address = row[11];  // Lì—´: ì£¼ì†Œ (8ì¹¸ ë°€ë¦¼)
      const status = row[12];    // Mì—´: ê±°ë˜ìƒíƒœ (8ì¹¸ ë°€ë¦¼)

      if (status === "ì‚¬ìš©") {
        if (!address || address.toString().trim() === '') {
          // ì‚¬ìš© ìƒíƒœì´ì§€ë§Œ ì£¼ì†Œê°€ ì—†ëŠ” ê²½ìš° ì¢Œí‘œ ì‚­ì œ
          updates.push({
            range: `${STORE_SHEET_NAME}!I${i + 2}:J${i + 2}`,
            values: [["", ""]]
          });
          // console.log(`Cleared coordinates for store without address at row ${i + 2}`);
          continue;
        }

        // ì£¼ì†Œê°€ ìˆëŠ” ê²½ìš° geocoding ì‹¤í–‰
        try {
          // console.log(`\n=== ì¢Œí‘œ ì—…ë°ì´íŠ¸ ì‹œì‘: ${address} ===`);
          const result = await geocodeAddress(address);
          if (result) {
            const { latitude, longitude } = result;
            updates.push({
              range: `${STORE_SHEET_NAME}!I${i + 2}:J${i + 2}`,
              values: [[latitude, longitude]]
            });
            // console.log(`âœ… ì¢Œí‘œ ì—…ë°ì´íŠ¸ ì„±ê³µ: ${address}`);
            // console.log(`ğŸ“ ìœ„ë„: ${latitude}, ê²½ë„: ${longitude}`);
          } else {
            // console.log(`âŒ Geocoding ê²°ê³¼ ì—†ìŒ: ${address}`);
            // geocoding ì‹¤íŒ¨ ì‹œ ê¸°ì¡´ ì¢Œí‘œ ìœ ì§€ (ì‚­ì œí•˜ì§€ ì•ŠìŒ)
            // console.log(`âš ï¸ ê¸°ì¡´ ì¢Œí‘œ ìœ ì§€ (ì‚­ì œí•˜ì§€ ì•ŠìŒ): ${address}`);
          }
        } catch (error) {
          console.error(`âŒ Geocoding ì˜¤ë¥˜: ${address}`, error.message);
          // geocoding ì˜¤ë¥˜ ì‹œ ê¸°ì¡´ ì¢Œí‘œ ìœ ì§€ (ì‚­ì œí•˜ì§€ ì•ŠìŒ)
          // console.log(`âš ï¸ ê¸°ì¡´ ì¢Œí‘œ ìœ ì§€ (ì‚­ì œí•˜ì§€ ì•ŠìŒ): ${address}`);
        }
      } else {
        // ë¯¸ì‚¬ìš© ë§¤ì¥ì€ ìœ„ë„/ê²½ë„ ê°’ì„ ë¹ˆ ê°’ìœ¼ë¡œ ë¹„ì›€
        updates.push({
          range: `${STORE_SHEET_NAME}!I${i + 2}:J${i + 2}`,
          values: [["", ""]]
        });
        // console.log(`Cleared coordinates for unused store at row ${i + 2}`);
      }
      // API í• ë‹¹ëŸ‰ ì œí•œì„ í”¼í•˜ê¸° ìœ„í•œ ì§€ì—° (ì‚¬ìš© ë§¤ì¥ë§Œ)
      if (status === "ì‚¬ìš©") await new Promise(resolve => setTimeout(resolve, 1000));
    }

    // ì¼ê´„ ì—…ë°ì´íŠ¸ ì‹¤í–‰
    if (updates.length > 0) {
      await sheets.spreadsheets.values.batchUpdate({
        spreadsheetId: SPREADSHEET_ID,
        resource: {
          valueInputOption: 'USER_ENTERED',
          data: updates
        }
      });
      // console.log(`Successfully updated ${updates.length} coordinates`);
    } else {
      // console.log('No coordinates to update');
    }

    res.json({
      success: true,
      message: `Updated coordinates for ${updates.length} addresses`
    });
  } catch (error) {
    console.error('Error updating coordinates:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to update coordinates',
      message: error.message
    });
  }
});

// íŒë§¤ì ì •ë³´ ì‹œíŠ¸ì˜ ì£¼ì†Œë¥¼ ìœ„ë„/ê²½ë„ë¡œ ë³€í™˜í•˜ì—¬ ì—…ë°ì´íŠ¸
app.post('/api/update-sales-coordinates', async (req, res) => {
  try {
    console.log('Updating sales coordinates...');

    // ìƒˆë¡œìš´ êµ¬ê¸€ ì‹œíŠ¸ ID í™•ì¸
    const SALES_SPREADSHEET_ID = process.env.SALES_SHEET_ID;
    if (!SALES_SPREADSHEET_ID) {
      throw new Error('SALES_SHEET_ID í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.');
    }

    const SALES_SHEET_NAME = 'íŒë§¤ì ì •ë³´';
    const salesValues = await getSheetValues(SALES_SHEET_NAME, SALES_SPREADSHEET_ID);
    if (!salesValues) {
      throw new Error('Failed to fetch data from sales sheet');
    }

    // í—¤ë” ì œê±° (2í–‰ë¶€í„° ì‹œì‘)
    const salesRows = salesValues.slice(1);
    let processedCount = 0;
    let updatedCount = 0;
    let skippedCount = 0;

    for (let i = 0; i < salesRows.length; i++) {
      const row = salesRows[i];
      const address = row[7];  // Hì—´: ì£¼ì†Œ
      const existingLat = row[5]; // Fì—´: ê¸°ì¡´ ìœ„ë„
      const existingLng = row[6]; // Gì—´: ê¸°ì¡´ ê²½ë„

      // ì£¼ì†Œê°€ ì—†ê±°ë‚˜ 'ì£¼ì†Œí™•ì¸í•„ìš”'ì¸ ê²½ìš° ê±´ë„ˆë›°ê¸°
      if (!address || address.toString().trim() === '' || address.toString().trim() === 'ì£¼ì†Œí™•ì¸í•„ìš”') {
        continue;
      }

      processedCount++;

      // ê¸°ì¡´ ì¢Œí‘œê°€ ëª¨ë‘ ì¡´ì¬í•˜ë©´ ì§€ì˜¤ì½”ë”© ìƒëµ
      if (existingLat && existingLng) {
        skippedCount++;
        continue;
      }

      // ì£¼ì†Œ í•´ì‹œ ë¹„êµ (ë³€ê²½ ê°ì§€) - ì¢Œí‘œê°€ ì—†ì„ ê²½ìš°ì—ë§Œ ì ìš©
      const addressHash = createHash(address.toString().trim());
      const existingAddressHash = createHash('');

      // ì¢Œí‘œê°€ ì—†ëŠ” ê²½ìš°ì—ë§Œ ì§€ì˜¤ì½”ë”© ì‹¤í–‰
      if (addressHash !== existingAddressHash) {
        try {
          console.log(`\n=== ì¢Œí‘œ ì—…ë°ì´íŠ¸ ì‹œì‘: ${address} ===`);
          const result = await geocodeAddress(address);
          if (result) {
            const { latitude, longitude } = result;

            // ê°œë³„ ì—…ë°ì´íŠ¸ ì‹¤í–‰ (ì¦‰ì‹œ ì €ì¥)
            await sheets.spreadsheets.values.update({
              spreadsheetId: SALES_SPREADSHEET_ID,
              range: `${SALES_SHEET_NAME}!F${i + 2}:G${i + 2}`,
              valueInputOption: 'USER_ENTERED',
              resource: {
                values: [[latitude, longitude]]
              }
            });

            updatedCount++;
            console.log(`âœ… ì¢Œí‘œ ì—…ë°ì´íŠ¸ ì„±ê³µ: ${address}`);
            console.log(`ğŸ“ ìœ„ë„: ${latitude}, ê²½ë„: ${longitude}`);
          } else {
            console.log(`âŒ Geocoding ê²°ê³¼ ì—†ìŒ: ${address}`);
          }
        } catch (error) {
          console.error(`âŒ Geocoding ì˜¤ë¥˜: ${address}`, error.message);
        }

        // API í• ë‹¹ëŸ‰ ì œí•œì„ í”¼í•˜ê¸° ìœ„í•œ ì§€ì—° (0.2ì´ˆ)
        await new Promise(resolve => setTimeout(resolve, 200));
      } else {
        console.log(`â­ï¸ ì£¼ì†Œ ë³€ê²½ ì—†ìŒ, ê±´ë„ˆë›°ê¸°: ${address}`);
      }
    }

    console.log(`ğŸ“Š ì£¼ì†Œ ì—…ë°ì´íŠ¸ ì™„ë£Œ - ì²˜ë¦¬: ${processedCount}ê°œ, ì—…ë°ì´íŠ¸: ${updatedCount}ê°œ, ê±´ë„ˆëœ€: ${skippedCount}ê°œ`);

    res.json({
      success: true,
      message: `Processed ${processedCount} addresses, updated ${updatedCount} coordinates, skipped ${skippedCount}`,
      processed: processedCount,
      updated: updatedCount,
      skipped: skippedCount
    });
  } catch (error) {
    console.error('Error updating sales coordinates:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to update sales coordinates',
      message: error.message
    });
  }
});

// í•´ì‹œ í•¨ìˆ˜ (ì£¼ì†Œ ë³€ê²½ ê°ì§€ìš©)
function createHash(str) {
  let hash = 0;
  if (str.length === 0) return hash.toString();
  for (let i = 0; i < str.length; i++) {
    const char = str.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash; // 32bit ì •ìˆ˜ë¡œ ë³€í™˜
  }
  return hash.toString();
}

function calculateDistance(lat1, lon1, lat2, lon2) {
  if (
    typeof lat1 !== 'number' ||
    typeof lon1 !== 'number' ||
    typeof lat2 !== 'number' ||
    typeof lon2 !== 'number'
  ) {
    return null;
  }
  const toRad = (value) => (value * Math.PI) / 180;
  const R = 6371; // km
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a =
    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(toRad(lat1)) *
    Math.cos(toRad(lat2)) *
    Math.sin(dLon / 2) *
    Math.sin(dLon / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  const distance = R * c;
  if (!Number.isFinite(distance)) return null;
  return Math.round(distance * 10) / 10; // one decimal
}

// ìŠ¤í† ì–´ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ìºì‹± ì ìš©)
app.get('/api/stores', async (req, res) => {
  const { includeShipped = 'true' } = req.query; // ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ ì¶œê³  ì œì™¸ ì—¬ë¶€ ì œì–´
  const cacheKey = `processed_stores_data_${includeShipped}`;

  // ìºì‹œì—ì„œ ë¨¼ì € í™•ì¸
  const cachedStores = cacheUtils.get(cacheKey);
  if (cachedStores) {
    return res.json(cachedStores);
  }

  try {
    const startTime = Date.now();

    const [inventoryValues, storeValues] = await Promise.all([
      getSheetValues(INVENTORY_SHEET_NAME),
      getSheetValues(STORE_SHEET_NAME)
    ]);

    if (!inventoryValues || !storeValues) {
      throw new Error('Failed to fetch data from sheets');
    }

    // í—¤ë” ì œê±° (ì²« 3í–‰ì€ ì œì™¸)
    const inventoryRows = inventoryValues.slice(3);
    const storeRows = storeValues.slice(1);

    // ì¶œê³  ì œì™¸ ë¡œì§ (includeShippedê°€ 'false'ì¼ ë•Œë§Œ ì ìš©)
    let threeDaysAgo = null;
    if (includeShipped === 'false') {
      const today = new Date();
      threeDaysAgo = new Date(today);
      threeDaysAgo.setDate(today.getDate() - 3);
    }

    // ë§¤ì¥ë³„ ì¬ê³  ë°ì´í„° ë§¤í•‘
    const inventoryMap = {};
    let excludedCount = 0; // ì œì™¸ëœ ì¬ê³  ì¹´ìš´í„°

    inventoryRows.forEach((row, index) => {
      if (!row || row.length < 23) return; // ìµœì†Œ Oì—´ê¹Œì§€ ë°ì´í„°ê°€ ìˆì–´ì•¼ í•¨ (15+8)

      const storeName = (row[21] || '').toString().trim();  // Nì—´: ë§¤ì¥ëª… (13+8)
      let cleanStoreName = storeName;

      // ëª¨ë“  ë§¤ì¥(ì‚¬ë¬´ì‹¤ í¬í•¨)ì€ ì›ë˜ ì´ë¦„ ê·¸ëŒ€ë¡œ ìœ ì§€
      cleanStoreName = storeName;
      const model = (row[13] || '').toString().trim();      // Fì—´: ëª¨ë¸ (5+8)
      const color = (row[14] || '').toString().trim();      // Gì—´: ìƒ‰ìƒ (6+8)
      const status = (row[15] || '').toString().trim();     // Hì—´: ìƒíƒœ (7+8)
      const type = (row[12] || '').toString().trim();       // Eì—´: ì¢…ë¥˜ (4+8)
      const shippingDate = row[22] ? new Date(row[22]) : null;  // Oì—´: ì¶œê³ ì¼ (14+8)

      if (!storeName || !model || !color) return;

      // ì¶œê³ ì¼ì´ ìˆê³ , ìµœê·¼ 3ì¼ ì´ë‚´ì¸ ê²½ìš° ì¬ê³ ì—ì„œ ì œì™¸ (includeShippedê°€ 'false'ì¼ ë•Œë§Œ)
      if (includeShipped === 'false' && shippingDate && threeDaysAgo && shippingDate >= threeDaysAgo) {
        excludedCount++;
        return;
      }

      // ë§¤ì¥ë³„ ì¬ê³  ë°ì´í„° êµ¬ì¡° ìƒì„± (ì •ë¦¬ëœ ì´ë¦„ìœ¼ë¡œ ë§¤í•‘)
      if (!inventoryMap[cleanStoreName]) {
        inventoryMap[cleanStoreName] = {
          phones: {},    // ë‹¨ë§ê¸°
          sims: {},      // ìœ ì‹¬
          wearables: {}, // ì›¨ì–´ëŸ¬ë¸”
          smartDevices: {} // ìŠ¤ë§ˆíŠ¸ê¸°ê¸°
        };
      }

      // ì¢…ë¥˜ì— ë”°ë¼ ë¶„ë¥˜
      let category = 'phones'; // ê¸°ë³¸ê°’
      if (type === 'ìœ ì‹¬') {
        category = 'sims';
      } else if (type === 'ì›¨ì–´ëŸ¬ë¸”') {
        category = 'wearables';
      } else if (type === 'ìŠ¤ë§ˆíŠ¸ê¸°ê¸°') {
        category = 'smartDevices';
      }

      if (!inventoryMap[cleanStoreName][category][model]) {
        inventoryMap[cleanStoreName][category][model] = {};
      }

      // ìƒíƒœë³„ë¡œ ìˆ˜ëŸ‰ ê´€ë¦¬
      if (!inventoryMap[cleanStoreName][category][model][status]) {
        inventoryMap[cleanStoreName][category][model][status] = {};
      }

      // ê°™ì€ ëª¨ë¸/ìƒ‰ìƒ/ìƒíƒœ ì¡°í•©ì˜ ìˆ˜ëŸ‰ê³¼ ì¶œê³ ì¼ ì •ë³´ ê´€ë¦¬
      if (!inventoryMap[cleanStoreName][category][model][status][color]) {
        inventoryMap[cleanStoreName][category][model][status][color] = {
          quantity: 1,
          shippedDate: shippingDate ? shippingDate.toISOString() : null
        };
      } else {
        inventoryMap[cleanStoreName][category][model][status][color].quantity++;
        // ì¶œê³ ì¼ì´ ë” ì˜¤ë˜ëœ ê²ƒìœ¼ë¡œ ì—…ë°ì´íŠ¸ (ê°€ì¥ ì˜¤ë˜ëœ ì¬ê³  ê¸°ì¤€)
        if (shippingDate && (!inventoryMap[cleanStoreName][category][model][status][color].shippedDate ||
          shippingDate < new Date(inventoryMap[cleanStoreName][category][model][status][color].shippedDate))) {
          inventoryMap[cleanStoreName][category][model][status][color].shippedDate = shippingDate.toISOString();
        }
      }
    });

    // ë§¤ì¥ ì •ë³´ì™€ ì¬ê³  ì •ë³´ ê²°í•©
    const stores = storeRows
      .filter(row => {
        const name = (row[14] || '').toString().trim();  // Gì—´: ì—…ì²´ëª… (6+8)
        const status = row[12];                          // Mì—´: ê±°ë˜ìƒíƒœ (12ë²ˆì§¸ ì»¬ëŸ¼)
        return name && status === "ì‚¬ìš©";
      })
      .map(row => {
        const latitude = parseFloat(row[8] || '0');    // Iì—´: ìœ„ë„ (8ë²ˆì§¸ ì»¬ëŸ¼)
        const longitude = parseFloat(row[9] || '0');   // Jì—´: ê²½ë„ (9ë²ˆì§¸ ì»¬ëŸ¼)
        const status = row[12];                         // Mì—´: ê±°ë˜ìƒíƒœ (12ë²ˆì§¸ ì»¬ëŸ¼)
        const name = row[14].toString().trim();        // Gì—´: ì—…ì²´ëª… (6+8)
        const storeId = row[15];                        // Hì—´: ë§¤ì¥ ID (7+8)
        const phone = row[17] || '';                    // Rì—´: ì—°ë½ì²˜ (17ë²ˆì§¸ ì»¬ëŸ¼)
        const storePhone = row[22] || '';               // Wì—´: ë§¤ì¥ì—°ë½ì²˜ (22ë²ˆì§¸ ì»¬ëŸ¼)
        const manager = row[21] || '';                  // Vì—´: ë‹´ë‹¹ì (21ë²ˆì§¸ ì»¬ëŸ¼)
        const address = (row[11] || '').toString();    // Lì—´: ì£¼ì†Œ (11ë²ˆì§¸ ì»¬ëŸ¼)

        // ë¹ˆ ë§¤ì¥ ID ì œì™¸
        if (!storeId || storeId.toString().trim() === '') {
          return null;
        }

        const inventory = inventoryMap[name] || {};
        const vipStatus = (row[18] || '').toString().trim(); // Sì—´: êµ¬ë¶„ (18ë²ˆì§¸ ì»¬ëŸ¼)
        const businessNumber = (row[28] || '').toString().trim(); // ACì—´: ì‚¬ì—…ìë²ˆí˜¸ (28ë²ˆì§¸ ì»¬ëŸ¼)
        const managerName = (row[29] || '').toString().trim(); // ADì—´: ì ì¥ëª… (29ë²ˆì§¸ ì»¬ëŸ¼)
        const accountInfo = (row[35] || '').toString().trim(); // AJì—´: ê³„ì¢Œì •ë³´ (35ë²ˆì§¸ ì»¬ëŸ¼)

        return {
          id: storeId.toString(),
          name: name,
          address,
          phone,
          storePhone,
          manager, // ê¸°ì¡´ ë‹´ë‹¹ì í•„ë“œ ìœ ì§€
          managerName, // ì ì¥ëª… ì¶”ê°€
          businessNumber,
          accountInfo,
          vipStatus,
          latitude,
          longitude,
          uniqueId: `${storeId}_${name}`,
          inventory: inventory
        };
      })
      .filter(store => store !== null); // null ê°’ ì œê±°

    // ìºì‹œì— ì €ì¥ (5ë¶„ TTL)
    cacheUtils.set(cacheKey, stores);

    res.json(stores);
  } catch (error) {
    console.error('Error fetching store data:', error);
    res.status(500).json({
      error: 'Failed to fetch store data',
      message: error.message
    });
  }
});

// ì˜ì—… ëª¨ë“œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ìºì‹± ì ìš©)
app.get('/api/sales-data', async (req, res) => {
  // CORS í—¤ë” ëª…ì‹œì  ì„¤ì •
  const allowedOrigins = [
    'https://vipmobile.vercel.app',
    'http://localhost:3000',
    'http://localhost:3001'
  ];

  const origin = req.headers.origin;
  if (allowedOrigins.includes(origin)) {
    res.header('Access-Control-Allow-Origin', origin);
  }
  res.header('Access-Control-Allow-Credentials', 'true');

  const cacheKey = 'sales_data';

  // ìºì‹œì—ì„œ ë¨¼ì € í™•ì¸
  const cachedSalesData = cacheUtils.get(cacheKey);
  if (cachedSalesData) {
    // ë¡œê·¸ ìµœì†Œí™” (ì„±ëŠ¥ ìµœì í™”)
    // console.log('ğŸ“¦ [SALES] ìºì‹œì—ì„œ ë°ì´í„° ë°˜í™˜ (íŠ¸ë˜í”½ ì ˆì•½)');
    return res.json(cachedSalesData);
  }

  try {
    // ë™ì‹œ ìš”ì²­ ì œí•œ ì ìš©
    const result = await withConcurrencyLimit(async () => {
      // ë¡œê·¸ ìµœì†Œí™” (ì„±ëŠ¥ ìµœì í™”)
      // console.log(`ğŸ”„ [SALES] ë™ì‹œ ìš”ì²­ ì²˜ë¦¬ ì¤‘... (í˜„ì¬: ${concurrentRequestLimit.currentRequests}/${concurrentRequestLimit.maxConcurrent})`);
      return await processSalesData();
    });

    // ê²°ê³¼ ê²€ì¦
    if (!result || !result.success) {
      throw new Error('ì˜ì—… ë°ì´í„° ì²˜ë¦¬ ê²°ê³¼ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    }

    // ìºì‹œì— ì €ì¥ (6ì‹œê°„ TTL)
    cacheUtils.set(cacheKey, result, 6 * 60 * 60 * 1000);

    // ë¡œê·¸ ìµœì†Œí™” (ì„±ëŠ¥ ìµœì í™”)
    // console.log(`âœ… [SALES] ì˜ì—… ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${result.data.salesData.length}ê°œ ë ˆì½”ë“œ, ${result.data.summary.totalPosCodes}ê°œ POSì½”ë“œ (ì²˜ë¦¬ì‹œê°„: ${result.processingTime}ms)`);

    res.json(result);
  } catch (error) {
    console.error('Error fetching sales data:', error);

    // ë” ìì„¸í•œ ì˜¤ë¥˜ ì •ë³´ ì œê³µ
    const errorResponse = {
      success: false,
      error: 'Failed to fetch sales data',
      message: error.message,
      timestamp: new Date().toISOString(),
      details: {
        hasSalesSheetId: !!process.env.SALES_SHEET_ID,
        salesSheetId: process.env.SALES_SHEET_ID ? 'SET' : 'NOT_SET'
      }
    };

    res.status(500).json(errorResponse);
  }
});

// ì˜ì—… ë°ì´í„° ë¯¸ë¦¬ ë¡œë“œ í•¨ìˆ˜ (ê³µí†µ í•¨ìˆ˜ í™œìš© + ë©”ëª¨ë¦¬ ìµœì í™” + íŠ¸ë˜í”½ ìµœì í™” + ë¡œê·¸ ìµœì í™”)
async function preloadSalesData() {
  try {
    // ë¡œê·¸ ìµœì†Œí™” (ì„±ëŠ¥ ìµœì í™”)
    // console.log('ğŸ”„ [SALES] ì˜ì—… ë°ì´í„° ë¯¸ë¦¬ ë¡œë“œ ì‹œì‘...');

    // ë™ì‹œ ìš”ì²­ ì œí•œ ì ìš©
    const result = await withConcurrencyLimit(async () => {
      return await processSalesData();
    });

    // ìºì‹œì— ì €ì¥ (6ì‹œê°„ TTL)
    cacheUtils.set('sales_data', result, 6 * 60 * 60 * 1000);

    // ë¡œê·¸ ìµœì†Œí™” (ì„±ëŠ¥ ìµœì í™”)
    // console.log(`âœ… [SALES] ì˜ì—… ë°ì´í„° ë¯¸ë¦¬ ë¡œë“œ ì™„ë£Œ: ${result.data.salesData.length}ê°œ ë ˆì½”ë“œ, ${result.data.summary.totalPosCodes}ê°œ POSì½”ë“œ (íŠ¸ë˜í”½ ìµœì í™”ë¨)`);
  } catch (error) {
    console.error('âŒ [SALES] ì˜ì—… ë°ì´í„° ë¯¸ë¦¬ ë¡œë“œ ì‹¤íŒ¨:', error);
  }
}

// ì˜ì—… ë°ì´í„° ì²˜ë¦¬ ê³µí†µ í•¨ìˆ˜ (ì½”ë“œ ì¤‘ë³µ ì œê±°)
async function processSalesData(spreadsheetId = process.env.SALES_SHEET_ID) {
  try {
    const startTime = Date.now();

    if (!spreadsheetId) {
      throw new Error('SALES_SHEET_ID í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.');
    }

    const RAW_DATA_SHEET_NAME = 'rawë°ì´í„°';
    const rawDataValues = await getSheetValues(RAW_DATA_SHEET_NAME, spreadsheetId);

    if (!rawDataValues) {
      throw new Error('Failed to fetch data from raw data sheet');
    }

    // í—¤ë” ì œê±° (3í–‰ì´ í—¤ë”, 4í–‰ë¶€í„° ë°ì´í„°)
    const rawDataRows = rawDataValues.slice(3);

    console.log(`ğŸ” [SALES] rawë°ì´í„° ì²˜ë¦¬ ì‹œì‘: ${rawDataRows.length}ê°œ í–‰`);

    // í•„í„°ë§ëœ ë°ì´í„° ì²˜ë¦¬ (ì„±ëŠ¥ ìµœì í™”)
    const salesData = [];
    const posCodeMap = new Map(); // Map ì‚¬ìš©ìœ¼ë¡œ ì„±ëŠ¥ í–¥ìƒ
    const regionMap = new Map(); // Map ì‚¬ìš©ìœ¼ë¡œ ì„±ëŠ¥ í–¥ìƒ

    // ìœ íš¨í•œ ë°ì´í„°ë§Œ ë¨¼ì € í•„í„°ë§
    const validRows = rawDataRows.filter(row => {
      if (!row || row.length < 28) return false;

      const latitude = parseFloat(row[10]) || 0;
      const longitude = parseFloat(row[11]) || 0;
      const performance = parseInt(row[27]) || 0;

      return latitude && longitude && performance > 0;
    });

    console.log(`âœ… [SALES] ìœ íš¨í•œ ë°ì´í„°: ${validRows.length}ê°œ í–‰`);

    validRows.forEach((row, index) => {
      const latitude = parseFloat(row[10]);    // Kì—´: ìœ„ë„
      const longitude = parseFloat(row[11]);   // Lì—´: ê²½ë„
      const address = (row[12] || '').toString();   // Mì—´: ì£¼ì†Œ
      const agentCode = (row[16] || '').toString(); // Qì—´: ëŒ€ë¦¬ì ì½”ë“œ
      const agentName = (row[17] || '').toString(); // Rì—´: ëŒ€ë¦¬ì ëª…
      const posCode = (row[21] || '').toString();   // Vì—´: POSì½”ë“œ
      const storeName = (row[22] || '').toString(); // Wì—´: íŒë§¤ì ëª…
      const region = (row[24] || '').toString();    // Yì—´: ê´‘ì—­ìƒê¶Œ
      const subRegion = (row[25] || '').toString(); // Zì—´: ì„¸ë¶€ìƒê¶Œ
      const performance = parseInt(row[27]);   // ABì—´: ì‹¤ì 

      // ì¶”ê°€ í•„í„° ë°ì´í„°
      const manager = (row[14] || '').toString();   // Oì—´: ë‹´ë‹¹
      const branch = (row[15] || '').toString();    // Pì—´: ì§€ì 

      // ì£¼ì†Œ ê³„ì¸µ ë°ì´í„° (E, F, G, Hì—´)
      const province = (row[4] || '').toString();   // Eì—´: ë„/ê´‘ì—­ì‹œ
      const city = (row[5] || '').toString();       // Fì—´: ì‹œ/êµ¬
      const district = (row[6] || '').toString();   // Gì—´: êµ¬/ë™
      const detailArea = (row[7] || '').toString(); // Hì—´: ë™/ìƒì„¸

      // ê°œë³„ ë°ì´í„° ì¶”ê°€
      const salesItem = {
        latitude,
        longitude,
        address,
        agentCode,
        agentName,
        posCode,
        storeName,
        region,
        subRegion,
        performance,
        manager,
        branch,
        // ì£¼ì†Œ ê³„ì¸µ ë°ì´í„° ì¶”ê°€
        province,
        city,
        district,
        detailArea
      };

      salesData.push(salesItem);

      // POSì½”ë“œë³„ ì‹¤ì  í•©ê³„ (Map ì‚¬ìš©ìœ¼ë¡œ ì„±ëŠ¥ í–¥ìƒ)
      if (!posCodeMap.has(posCode)) {
        posCodeMap.set(posCode, {
          latitude,
          longitude,
          address,
          posCode,
          storeName,
          region,
          subRegion,
          manager,
          branch,
          // ì£¼ì†Œ ê³„ì¸µ ë°ì´í„° ì¶”ê°€
          province,
          city,
          district,
          detailArea,
          totalPerformance: 0,
          agents: new Map() // ëŒ€ë¦¬ì  ì •ë³´ë„ Mapìœ¼ë¡œ ê´€ë¦¬
        });
      }

      const posCodeData = posCodeMap.get(posCode);
      posCodeData.totalPerformance += performance;

      // ëŒ€ë¦¬ì  ì •ë³´ ì¶”ê°€ (Mapìœ¼ë¡œ ì¤‘ë³µ ë°©ì§€)
      if (!posCodeData.agents.has(agentCode)) {
        posCodeData.agents.set(agentCode, {
          agentCode,
          agentName,
          performance
        });
      } else {
        posCodeData.agents.get(agentCode).performance += performance;
      }

      // ì§€ì—­ë³„ ì‹¤ì  í•©ê³„
      const regionKey = `${region}_${subRegion}`;
      if (!regionMap.has(regionKey)) {
        regionMap.set(regionKey, {
          region,
          subRegion,
          totalPerformance: 0,
          posCodes: new Set()
        });
      }

      const regionData = regionMap.get(regionKey);
      regionData.totalPerformance += performance;
      regionData.posCodes.add(posCode);
    });

    // Mapì„ Objectë¡œ ë³€í™˜
    const posCodeMapObj = {};
    posCodeMap.forEach((value, key) => {
      posCodeMapObj[key] = {
        ...value,
        agents: Array.from(value.agents.values())
      };
    });

    const regionMapObj = {};
    regionMap.forEach((value, key) => {
      regionMapObj[key] = {
        ...value,
        posCodes: Array.from(value.posCodes)
      };
    });

    // ê²°ê³¼ ë°ì´í„° êµ¬ì„±
    const result = {
      success: true,
      data: {
        salesData,
        posCodeMap: posCodeMapObj,
        regionMap: regionMapObj,
        summary: {
          totalRecords: salesData.length,
          totalPosCodes: posCodeMap.size,
          totalRegions: regionMap.size,
          totalPerformance: Array.from(posCodeMap.values()).reduce((sum, item) => sum + item.totalPerformance, 0)
        }
      }
    };

    // ìºì‹œì— ì €ì¥ (24ì‹œê°„ TTL)
    cacheUtils.set('sales_data', result, 24 * 60 * 60 * 1000);

    console.log(`âœ… [SALES] ì˜ì—… ë°ì´í„° ë¯¸ë¦¬ ë¡œë“œ ì™„ë£Œ: ${salesData.length}ê°œ ë ˆì½”ë“œ, ${posCodeMap.size}ê°œ POSì½”ë“œ`);

    // ê²°ê³¼ ë°˜í™˜ ì¶”ê°€
    return result;
  } catch (error) {
    console.error('âŒ [SALES] ì˜ì—… ë°ì´í„° ë¯¸ë¦¬ ë¡œë“œ ì‹¤íŒ¨:', error);
    throw error; // ì˜¤ë¥˜ë¥¼ ë‹¤ì‹œ ë˜ì ¸ì„œ í˜¸ì¶œìê°€ ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡ í•¨
  }
}

// ì˜ì—… ëª¨ë“œ ì ‘ê·¼ ê¶Œí•œ í™•ì¸
app.get('/api/sales-mode-access', async (req, res) => {
  // CORS í—¤ë” ëª…ì‹œì  ì„¤ì •
  const allowedOrigins = [
    'https://vipmobile.vercel.app',
    'http://localhost:3000',
    'http://localhost:3001'
  ];

  const origin = req.headers.origin;
  if (allowedOrigins.includes(origin)) {
    res.header('Access-Control-Allow-Origin', origin);
  }
  res.header('Access-Control-Allow-Credentials', 'true');

  try {
    // ëŒ€ë¦¬ì ì•„ì´ë””ê´€ë¦¬ ì‹œíŠ¸ì—ì„œ Uì—´ ê¶Œí•œ í™•ì¸ (ê¸°ì¡´ Sì—´ â†’ Uì—´)
    const agentResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${AGENT_SHEET_NAME}!A:U`
    });

    if (!agentResponse.data.values || agentResponse.data.values.length === 0) {
      throw new Error('Failed to fetch agent data');
    }

    // í—¤ë” ì œê±°
    const agentRows = agentResponse.data.values.slice(1);

    // Uì—´ì—ì„œ "O" ê¶Œí•œì´ ìˆëŠ” ëŒ€ë¦¬ì  ì°¾ê¸° (ê¸°ì¡´ Sì—´ â†’ Uì—´)
    const authorizedAgents = agentRows
      .filter(row => row && row.length > 20 && row[20] === 'O') // Uì—´ (20ë²ˆ ì¸ë±ìŠ¤)
      .map(row => ({
        agentCode: row[0] || '', // Aì—´: ëŒ€ë¦¬ì ì½”ë“œ
        agentName: row[1] || '', // Bì—´: ëŒ€ë¦¬ì ëª…
        accessLevel: row[20] || '' // Uì—´: ì ‘ê·¼ê¶Œí•œ
      }));

    res.json({
      success: true,
      hasAccess: authorizedAgents.length > 0,
      authorizedAgents,
      totalAgents: agentRows.length,
      authorizedCount: authorizedAgents.length
    });
  } catch (error) {
    console.error('Error checking sales mode access:', error);
    res.status(500).json({
      success: false,
      hasAccess: false,
      error: 'Failed to check sales mode access',
      message: error.message
    });
  }
});

// ì¬ê³ íšŒìˆ˜ëª¨ë“œ ì ‘ê·¼ê¶Œí•œ í™•ì¸ API
app.get('/api/inventoryRecoveryAccess', async (req, res) => {
  res.header('Access-Control-Allow-Origin', '*');
  res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
  res.header('Access-Control-Allow-Headers', 'Origin, X-Requested-With, Content-Type, Accept, Authorization');

  if (req.method === 'OPTIONS') {
    res.sendStatus(200);
    return;
  }

  const origin = req.headers.origin;
  if (allowedOrigins.includes(origin)) {
    res.header('Access-Control-Allow-Origin', origin);
  }
  res.header('Access-Control-Allow-Credentials', 'true');

  try {
    // ëŒ€ë¦¬ì ì•„ì´ë””ê´€ë¦¬ ì‹œíŠ¸ì—ì„œ Vì—´ ê¶Œí•œ í™•ì¸ (ê¸°ì¡´ Tì—´ â†’ Vì—´)
    const agentResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${AGENT_SHEET_NAME}!A:V`
    });

    if (!agentResponse.data.values || agentResponse.data.values.length === 0) {
      throw new Error('Failed to fetch agent data');
    }

    // í—¤ë” ì œê±°
    const agentRows = agentResponse.data.values.slice(1);

    // Vì—´ì—ì„œ ì¬ê³ íšŒìˆ˜ëª¨ë“œ ê¶Œí•œì´ ìˆëŠ” ëŒ€ë¦¬ì  ì°¾ê¸° (ê¸°ì¡´ Tì—´ â†’ Vì—´)
    const authorizedAgents = agentRows
      .filter(row => row && row.length > 21 && row[21] === 'O') // Vì—´ (21ë²ˆ ì¸ë±ìŠ¤)
      .map(row => ({
        agentCode: row[0] || '', // Aì—´: ëŒ€ë¦¬ì ì½”ë“œ
        agentName: row[1] || '', // Bì—´: ëŒ€ë¦¬ì ëª…
        accessLevel: row[21] || '' // Vì—´: ì¬ê³ íšŒìˆ˜ëª¨ë“œ ì ‘ê·¼ê¶Œí•œ
      }));

    res.json({
      success: true,
      hasAccess: authorizedAgents.length > 0,
      authorizedAgents,
      totalAgents: agentRows.length,
      authorizedCount: authorizedAgents.length
    });
  } catch (error) {
    console.error('Error checking inventory recovery mode access:', error);
    res.status(500).json({
      success: false,
      hasAccess: false,
      error: 'Failed to check inventory recovery mode access',
      message: error.message
    });
  }
});

// ëª¨ë¸ê³¼ ìƒ‰ìƒ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ìºì‹± ì ìš©)
app.get('/api/models', async (req, res) => {
  const cacheKey = 'processed_models_data';

  // ìºì‹œì—ì„œ ë¨¼ì € í™•ì¸
  const cachedModels = cacheUtils.get(cacheKey);
  if (cachedModels) {
    return res.json(cachedModels);
  }

  try {
    const startTime = Date.now();

    const inventoryValues = await getSheetValues(INVENTORY_SHEET_NAME);

    if (!inventoryValues) {
      throw new Error('Failed to fetch data from inventory sheet');
    }

    // í—¤ë” ì œê±° (ì²« 3í–‰ì€ ì œì™¸)
    const inventoryRows = inventoryValues.slice(3);

    // ëª¨ë¸ê³¼ ìƒ‰ìƒ ë°ì´í„° ì¶”ì¶œ
    const modelColorMap = {};

    inventoryRows.forEach(row => {
      if (row.length < 16) return;

      const model = (row[13] || '').toString().trim();    // Fì—´: ëª¨ë¸ (5+8)
      const color = (row[14] || '').toString().trim();    // Gì—´: ìƒ‰ìƒ (6+8)
      const status = (row[15] || '').toString().trim();   // Hì—´: ìƒíƒœ (7+8)
      const type = (row[12] || '').toString().trim();     // Eì—´: ì¢…ë¥˜ (4+8)

      if (!model || !color) return;

      // ìƒíƒœê°€ 'ì •ìƒ'ì¸ ê²ƒë§Œ í¬í•¨ (í•„í„°ë§)
      if (status !== 'ì •ìƒ') return;

      if (!modelColorMap[model]) {
        modelColorMap[model] = new Set();
      }
      modelColorMap[model].add(color);
    });

    // Setì„ ë°°ì—´ë¡œ ë³€í™˜
    const result = Object.entries(modelColorMap).reduce((acc, [model, colors]) => {
      acc[model] = Array.from(colors).sort();
      return acc;
    }, {});

    // ìºì‹œì— ì €ì¥ (5ë¶„ TTL)
    cacheUtils.set(cacheKey, result);

    res.json(result);
  } catch (error) {
    console.error('Error fetching model and color data:', error);
    res.status(500).json({
      error: 'Failed to fetch model and color data',
      message: error.message
    });
  }
});



// ëŒ€ë¦¬ì  ID ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ìºì‹± ì ìš©)
app.get('/api/agents', async (req, res) => {
  // ìºì‹œ í‚¤ ë³€ê²½ (v2) - ì»¬ëŸ¼ ì¸ë±ìŠ¤ ìˆ˜ì • í›„ ìºì‹œ ë¬´íš¨í™”ë¥¼ ìœ„í•´
  const cacheKey = 'processed_agents_data_v2';

  // ìºì‹œì—ì„œ ë¨¼ì € í™•ì¸
  const cachedAgents = cacheUtils.get(cacheKey);
  if (cachedAgents) {
    console.log('âœ… [ìºì‹œ] ìˆ˜ì •ëœ agent ë°ì´í„° ë°˜í™˜');
    return res.json(cachedAgents);
  }

  try {
    console.log('ğŸ”„ [ë‹´ë‹¹ì] ë°ì´í„° ì²˜ë¦¬ ì‹œì‘...');
    const startTime = Date.now();

    const agentValues = await getSheetValues(AGENT_SHEET_NAME);

    if (!agentValues) {
      throw new Error('Failed to fetch data from agent sheet');
    }

    // í—¤ë” ì œê±° (3í–‰ê¹Œì§€ê°€ í—¤ë”ì´ë¯€ë¡œ 4í–‰ë¶€í„° ì‹œì‘)
    const agentRows = agentValues.slice(3);

    // ëŒ€ë¦¬ì  ë°ì´í„° êµ¬ì„± (Dì—´, Eì—´ ì¶”ê°€ë¡œ ì¸í•´ ì‚¬ë¬´ì‹¤/ì†Œì†ì´ +2 ì´ë™)
    // Fì—´(ì¸ë±ìŠ¤ 5) = ì‚¬ë¬´ì‹¤, Gì—´(ì¸ë±ìŠ¤ 6) = ì†Œì†
    const agents = agentRows.map((row, index) => {
      // ì •í™•íˆ Fì—´(row[5])ì—ì„œ ì‚¬ë¬´ì‹¤, Gì—´(row[6])ì—ì„œ ì†Œì†ë§Œ ì½ê¸°
      let office = (row[5] || '').toString().trim();        // Fì—´: ì‚¬ë¬´ì‹¤
      let department = (row[6] || '').toString().trim();     // Gì—´: ì†Œì†

      // ë³´ì•ˆ ê²€ì¦: Eì—´(íŒ¨ìŠ¤ì›Œë“œ) ê°’ í™•ì¸ (ë¹„êµìš©)
      const passwordValue = (row[4] || '').toString().trim(); // Eì—´: íŒ¨ìŠ¤ì›Œë“œ
      const passwordNotUsed = (row[3] || '').toString().trim(); // Dì—´: íŒ¨ìŠ¤ì›Œë“œ ë¯¸ì‚¬ìš©

      // ì¤‘ìš”: departmentê°€ Eì—´(íŒ¨ìŠ¤ì›Œë“œ) ê°’ê³¼ ê°™ìœ¼ë©´ ì•ˆ ë¨ (ì ˆëŒ€ ë¹„ë°€ë²ˆí˜¸ê°€ ì†Œì†ìœ¼ë¡œ í‘œì‹œë˜ë©´ ì•ˆ ë¨)
      if (department === passwordValue && passwordValue !== '') {
        console.error(`âŒ [ì¹˜ëª…ì  ì˜¤ë¥˜] ${row[2]}: Gì—´(ì†Œì†) ê°’ì´ Eì—´(íŒ¨ìŠ¤ì›Œë“œ) ê°’ê³¼ ë™ì¼! Gì—´="${department}", Eì—´="${passwordValue ? '***' : ''}" - department ì´ˆê¸°í™”`);
        department = '';
      }

      // departmentê°€ ì²´í¬ë°•ìŠ¤ ê°’ì¸ ê²½ìš° í•„í„°ë§
      if (department === passwordNotUsed || department === 'FALSE' || department === 'TRUE') {
        console.warn(`âš ï¸ [ë³´ì•ˆ] departmentê°€ ì²´í¬ë°•ìŠ¤ ê°’: ${row[2]}, department ì´ˆê¸°í™”`);
        department = '';
      }

      // ìˆ«ìë§Œ ìˆê³  4ì ì´ìƒì¸ ê²½ìš° (ë¹„ë°€ë²ˆí˜¸ì¼ ê°€ëŠ¥ì„±) í•„í„°ë§
      // ë‹¨, Eì—´(íŒ¨ìŠ¤ì›Œë“œ)ê³¼ ë¹„êµí•˜ì—¬ ë™ì¼í•œ ê°’ì´ë©´ í™•ì‹¤íˆ í•„í„°ë§
      if (/^\d+$/.test(department) && department.length >= 4) {
        if (department === passwordValue) {
          console.error(`âŒ [ì¹˜ëª…ì  ì˜¤ë¥˜] ${row[2]}: Gì—´(ì†Œì†)ì´ ë¹„ë°€ë²ˆí˜¸ í˜•ì‹ì´ê³  Eì—´(íŒ¨ìŠ¤ì›Œë“œ)ê³¼ ë™ì¼! - department ì´ˆê¸°í™”`);
          department = '';
        } else {
          console.warn(`âš ï¸ [ë³´ì•ˆ] departmentê°€ ë¹„ë°€ë²ˆí˜¸ í˜•ì‹ìœ¼ë¡œ ì˜ì‹¬ë¨: ${row[2]}, ê°’="${department}" - department ì´ˆê¸°í™”`);
          department = '';
        }
      }

      // officeë„ ì²´í¬ë°•ìŠ¤ ê°’ í•„í„°ë§
      if (office === 'FALSE' || office === 'TRUE') {
        console.warn(`âš ï¸ [ë³´ì•ˆ] officeê°€ ì²´í¬ë°•ìŠ¤ ê°’: ${row[2]}, office ì´ˆê¸°í™”`);
        office = '';
      }

      const agent = {
        target: row[0] || '',       // Aì—´: ëŒ€ìƒ
        qualification: row[1] || '', // Bì—´: ìê²©
        contactId: row[2] || '',     // Cì—´: ì—°ë½ì²˜(ì•„ì´ë””)
        office: office,
        department: department
      };

      // ë””ë²„ê¹…: ì²˜ìŒ 10ê°œ í–‰ ëª¨ë‘ ìƒì„¸ ë¡œê·¸ ì¶œë ¥
      if (index < 10) {
        console.log(`ğŸ“‹ [ë‹´ë‹¹ì ${index + 1}]`, {
          target: agent.target,
          contactId: agent.contactId,
          office: agent.office,
          department: agent.department,
          'ì „ì²´ row ê¸¸ì´': row.length,
          'row[0] (Aì—´-ëŒ€ìƒ)': row[0],
          'row[1] (Bì—´-ìê²©)': row[1],
          'row[2] (Cì—´-ì•„ì´ë””)': row[2],
          'row[3] (Dì—´-íŒ¨ìŠ¤ì›Œë“œë¯¸ì‚¬ìš©)': row[3],
          'row[4] (Eì—´-íŒ¨ìŠ¤ì›Œë“œ)': row[4] ? '***' : '',
          'row[5] (Fì—´-ì‚¬ë¬´ì‹¤)': row[5],
          'row[6] (Gì—´-ì†Œì†)': row[6],
          'ìµœì¢… office': office,
          'ìµœì¢… department': department,
          'í•„í„°ë§ ì „ row ì „ì²´': row.slice(0, 10) // ì²˜ìŒ 10ê°œ ì»¬ëŸ¼ë§Œ
        });
      }

      return agent;
    }).filter(agent => {
      // ì•„ì´ë””ê°€ ìˆê³ , officeì™€ departmentê°€ ëª¨ë‘ ìœ íš¨í•œ í•­ëª©ë§Œ ë°˜í™˜
      return agent.contactId &&
        agent.office && agent.office.trim() !== '' &&
        agent.department && agent.department.trim() !== '';
    });

    const processingTime = Date.now() - startTime;
    console.log(`âœ… [ë‹´ë‹¹ì] ë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ: ${agents.length}ê°œ ë‹´ë‹¹ì, ${processingTime}ms ì†Œìš”`);

    // ìºì‹œì— ì €ì¥ (5ë¶„ TTL)
    cacheUtils.set(cacheKey, agents);

    res.json(agents);
  } catch (error) {
    console.error('Error fetching agent data:', error);
    res.status(500).json({
      error: 'Failed to fetch agent data',
      message: error.message
    });
  }
});

// ë‹¹ì›” ê°œí†µì‹¤ì  ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
app.get('/api/activation-data/current-month', async (req, res) => {
  const cacheKey = 'current_month_activation_data';

  // ìºì‹œì—ì„œ ë¨¼ì € í™•ì¸
  const cachedData = cacheUtils.get(cacheKey);
  if (cachedData) {
    return res.json(cachedData);
  }

  try {
    const startTime = Date.now();

    const activationValues = await getSheetValues(CURRENT_MONTH_ACTIVATION_SHEET_NAME);

    if (!activationValues) {
      throw new Error('Failed to fetch data from current month activation sheet');
    }

    // í—¤ë” ì œê±°
    const activationRows = activationValues.slice(1);

    // ê°œí†µì‹¤ì  ë°ì´í„° êµ¬ì„± (ì„ ë¶ˆê°œí†µ ì œì™¸)
    const activationData = activationRows
      .filter(row => row[14] !== 'ì„ ë¶ˆê°œí†µ') // Oì—´: ê°œí†µ (ì„ ë¶ˆê°œí†µ ì œì™¸)
      .map(row => {
        return {
          'ë‹´ë‹¹ì': row[8] || '',        // Iì—´: ë‹´ë‹¹ì
          'ê°œí†µì¼': row[9] || '',        // Jì—´: ê°œí†µì¼
          'ê°œí†µì‹œ': row[10] || '',       // Kì—´: ê°œí†µì‹œ
          'ê°œí†µë¶„': row[11] || '',       // Lì—´: ê°œí†µë¶„
          'ì¶œê³ ì²˜': row[14] || '',       // Oì—´: ì¶œê³ ì²˜
          'ê°œí†µ': row[19] || '',         // Tì—´: ê°œí†µ
          'ëª¨ë¸ëª…': row[21] || '',       // Vì—´: ëª¨ë¸ëª…
          'ìƒ‰ìƒ': row[22] || '',         // Wì—´: ìƒ‰ìƒ
          'ì¼ë ¨ë²ˆí˜¸': row[23] || ''      // Xì—´: ì¼ë ¨ë²ˆí˜¸
        };
      });

    const processingTime = Date.now() - startTime;

    // ìºì‹œì— ì €ì¥ (5ë¶„ TTL)
    cacheUtils.set(cacheKey, activationData);

    res.json(activationData);
  } catch (error) {
    console.error('Error fetching current month activation data:', error);
    res.status(500).json({
      error: 'Failed to fetch current month activation data',
      message: error.message
    });
  }
});

// ì „ì›” ê°œí†µì‹¤ì  ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
app.get('/api/activation-data/previous-month', async (req, res) => {
  const cacheKey = 'previous_month_activation_data';

  // ìºì‹œì—ì„œ ë¨¼ì € í™•ì¸
  const cachedData = cacheUtils.get(cacheKey);
  if (cachedData) {
    return res.json(cachedData);
  }

  try {
    const startTime = Date.now();

    const activationValues = await getSheetValues(PREVIOUS_MONTH_ACTIVATION_SHEET_NAME);

    if (!activationValues) {
      throw new Error('Failed to fetch data from previous month activation sheet');
    }

    // í—¤ë” ì œê±°
    const activationRows = activationValues.slice(1);

    // ê°œí†µì‹¤ì  ë°ì´í„° êµ¬ì„± (ì„ ë¶ˆê°œí†µ ì œì™¸)
    const activationData = activationRows
      .filter(row => row[14] !== 'ì„ ë¶ˆê°œí†µ') // Oì—´: ê°œí†µ (ì„ ë¶ˆê°œí†µ ì œì™¸)
      .map(row => {
        return {
          'ë‹´ë‹¹ì': row[8] || '',        // Iì—´: ë‹´ë‹¹ì
          'ê°œí†µì¼': row[9] || '',        // Jì—´: ê°œí†µì¼
          'ê°œí†µì‹œ': row[10] || '',       // Kì—´: ê°œí†µì‹œ
          'ê°œí†µë¶„': row[11] || '',       // Lì—´: ê°œí†µë¶„
          'ì¶œê³ ì²˜': row[14] || '',       // Oì—´: ì¶œê³ ì²˜
          'ê°œí†µ': row[19] || '',         // Tì—´: ê°œí†µ
          'ëª¨ë¸ëª…': row[21] || '',       // Vì—´: ëª¨ë¸ëª…
          'ìƒ‰ìƒ': row[22] || '',         // Wì—´: ìƒ‰ìƒ
          'ì¼ë ¨ë²ˆí˜¸': row[23] || ''      // Xì—´: ì¼ë ¨ë²ˆí˜¸
        };
      });

    const processingTime = Date.now() - startTime;

    // ìºì‹œì— ì €ì¥ (5ë¶„ TTL)
    cacheUtils.set(cacheKey, activationData);

    res.json(activationData);
  } catch (error) {
    console.error('Error fetching previous month activation data:', error);
    res.status(500).json({
      error: 'Failed to fetch previous month activation data',
      message: error.message
    });
  }
});

// ë‚ ì§œë³„ ê°œí†µì‹¤ì  ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ìƒˆë¡œìš´ API)
app.get('/api/activation-data/by-date', async (req, res) => {
  const cacheKey = 'activation_data_by_date';

  // ìºì‹œì—ì„œ ë¨¼ì € í™•ì¸
  const cachedData = cacheUtils.get(cacheKey);
  if (cachedData) {
    return res.json(cachedData);
  }

  try {
    const startTime = Date.now();

    const activationValues = await getSheetValues(CURRENT_MONTH_ACTIVATION_SHEET_NAME);

    if (!activationValues) {
      throw new Error('Failed to fetch data from current month activation sheet');
    }

    // í—¤ë” ì œê±°
    const activationRows = activationValues.slice(1);

    // ë‚ ì§œë³„ ê°œí†µì‹¤ì  ë°ì´í„° êµ¬ì„±
    const dateStats = {};

    activationRows.forEach(row => {
      if (row[14] === 'ì„ ë¶ˆê°œí†µ') return; // Oì—´: ê°œí†µ (ì„ ë¶ˆê°œí†µ ì œì™¸)

      const store = row[14] || 'ë¯¸ì§€ì •'; // Oì—´: ì¶œê³ ì²˜
      const agent = row[8] || 'ë¯¸ì§€ì •'; // Iì—´: ë‹´ë‹¹ì
      const activationDate = row[9] || ''; // Jì—´: ê°œí†µì¼
      const model = row[21] || 'ë¯¸ì§€ì •'; // Vì—´: ëª¨ë¸ëª…
      const color = row[22] || 'ë¯¸ì§€ì •'; // Wì—´: ìƒ‰ìƒ

      if (!activationDate) return;

      // ë‚ ì§œ í˜•ì‹ ì •ê·œí™” (MM/DD -> MM/DD/YYYY -> toLocaleDateString í˜•ì‹)
      let normalizedDate = activationDate;
      if (activationDate.match(/^\d{1,2}\/\d{1,2}$/)) {
        const currentYear = new Date().getFullYear();
        normalizedDate = `${activationDate}/${currentYear}`;
      }

      // Date ê°ì²´ë¡œ ë³€í™˜í•˜ì—¬ ISO í˜•ì‹ìœ¼ë¡œ í†µì¼
      try {
        const dateObj = new Date(normalizedDate);
        if (!isNaN(dateObj.getTime())) {
          // ISO í˜•ì‹ìœ¼ë¡œ í†µì¼ (ì¬ê³  ë°ì´í„°ì™€ ë™ì¼)
          normalizedDate = dateObj.toISOString().split('T')[0]; // YYYY-MM-DD í˜•ì‹
        }
      } catch (error) {
        console.warn('ë‚ ì§œ ë³€í™˜ ì‹¤íŒ¨:', normalizedDate, error);
      }

      if (!dateStats[normalizedDate]) {
        dateStats[normalizedDate] = {};
      }

      if (!dateStats[normalizedDate][store]) {
        dateStats[normalizedDate][store] = {
          storeName: store,
          totalCount: 0,
          agents: new Set(),
          models: {}
        };
      }

      dateStats[normalizedDate][store].totalCount++;
      dateStats[normalizedDate][store].agents.add(agent);

      const modelKey = `${model} (${color})`;
      if (!dateStats[normalizedDate][store].models[modelKey]) {
        dateStats[normalizedDate][store].models[modelKey] = 0;
      }
      dateStats[normalizedDate][store].models[modelKey]++;
    });

    // Setì„ ë°°ì—´ë¡œ ë³€í™˜
    Object.keys(dateStats).forEach(date => {
      Object.keys(dateStats[date]).forEach(store => {
        dateStats[date][store].agents = Array.from(dateStats[date][store].agents);
      });
    });

    const processingTime = Date.now() - startTime;

    // ìºì‹œì— ì €ì¥ (5ë¶„ TTL)
    cacheUtils.set(cacheKey, dateStats);

    res.json(dateStats);
  } catch (error) {
    console.error('Error fetching activation data by date:', error);
    res.status(500).json({
      error: 'Failed to fetch activation data by date',
      message: error.message
    });
  }
});

// íŠ¹ì • ë‚ ì§œì˜ ë‹¹ì›”/ì „ì›” ê°œí†µì‹¤ì  ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ìƒˆë¡œìš´ API)
app.get('/api/activation-data/date-comparison/:date', async (req, res) => {
  const { date } = req.params;
  const cacheKey = `activation_date_comparison_${date}`;

  // ìºì‹œì—ì„œ ë¨¼ì € í™•ì¸
  const cachedData = cacheUtils.get(cacheKey);
  if (cachedData) {
    return res.json(cachedData);
  }

  try {
    const startTime = Date.now();

    // ë‹¹ì›”ê³¼ ì „ì›” ë°ì´í„° ëª¨ë‘ ê°€ì ¸ì˜¤ê¸°
    const [currentMonthValues, previousMonthValues] = await Promise.all([
      getSheetValues(CURRENT_MONTH_ACTIVATION_SHEET_NAME),
      getSheetValues(PREVIOUS_MONTH_ACTIVATION_SHEET_NAME)
    ]);

    if (!currentMonthValues || !previousMonthValues) {
      throw new Error('Failed to fetch activation data from sheets');
    }

    // í—¤ë” ì œê±°
    const currentMonthRows = currentMonthValues.slice(1);
    const previousMonthRows = previousMonthValues.slice(1);

    // ë‚ ì§œë³„ ë‹¹ì›”/ì „ì›” ë°ì´í„° êµ¬ì„±
    const comparisonData = {};

    // ë‹¹ì›” ë°ì´í„° ì²˜ë¦¬
    currentMonthRows.forEach(row => {
      if (row[14] === 'ì„ ë¶ˆê°œí†µ') return; // Oì—´: ê°œí†µ (ì„ ë¶ˆê°œí†µ ì œì™¸)

      const store = row[14] || 'ë¯¸ì§€ì •'; // Oì—´: ì¶œê³ ì²˜
      const agent = row[8] || 'ë¯¸ì§€ì •'; // Iì—´: ë‹´ë‹¹ì
      const activationDate = row[9] || ''; // Jì—´: ê°œí†µì¼
      const model = row[21] || 'ë¯¸ì§€ì •'; // Vì—´: ëª¨ë¸ëª…
      const color = row[22] || 'ë¯¸ì§€ì •'; // Wì—´: ìƒ‰ìƒ

      if (!activationDate) return;

      // ë‚ ì§œ í˜•ì‹ ì •ê·œí™”
      let normalizedDate = activationDate;
      if (activationDate.match(/^\d{1,2}\/\d{1,2}$/)) {
        const currentYear = new Date().getFullYear();
        normalizedDate = `${activationDate}/${currentYear}`;
      }

      // ISO í˜•ì‹ìœ¼ë¡œ ë³€í™˜
      try {
        const dateObj = new Date(normalizedDate);
        if (!isNaN(dateObj.getTime())) {
          normalizedDate = dateObj.toISOString().split('T')[0];
        }
      } catch (error) {
        console.warn('ë‚ ì§œ ë³€í™˜ ì‹¤íŒ¨:', normalizedDate, error);
        return;
      }

      // íŠ¹ì • ë‚ ì§œë§Œ ì²˜ë¦¬ (ì¼ìë§Œ ë¹„êµ)
      const currentDay = new Date(normalizedDate).getDate();
      const targetDay = new Date(date).getDate();
      if (currentDay !== targetDay) return;

      if (!comparisonData[store]) {
        comparisonData[store] = {
          storeName: store,
          currentMonth: 0,
          previousMonth: 0,
          agents: new Set(),
          models: {}
        };
      }

      comparisonData[store].currentMonth++;
      comparisonData[store].agents.add(agent);

      const modelKey = `${model} (${color})`;
      if (!comparisonData[store].models[modelKey]) {
        comparisonData[store].models[modelKey] = 0;
      }
      comparisonData[store].models[modelKey]++;
    });

    // ì „ì›” ë°ì´í„° ì²˜ë¦¬ (ê°™ì€ ì¼ì)
    // console.log(`ì „ì›” ë°ì´í„° ì²˜ë¦¬ ì‹œì‘ - ìš”ì²­ ë‚ ì§œ: ${date}`);
    // console.log(`ì „ì›” ë°ì´í„° í–‰ ìˆ˜: ${previousMonthRows.length}`);

    const targetDay = new Date(date).getDate();
    // console.log(`ì „ì›” ë¹„êµ ëŒ€ìƒ ì¼ì: ${targetDay}ì¼`);

    let processedPreviousCount = 0;

    previousMonthRows.forEach((row, index) => {
      if (row[14] === 'ì„ ë¶ˆê°œí†µ') return; // Oì—´: ê°œí†µ (ì„ ë¶ˆê°œí†µ ì œì™¸)

      const store = row[14] || 'ë¯¸ì§€ì •'; // Oì—´: ì¶œê³ ì²˜
      const agent = row[8] || 'ë¯¸ì§€ì •'; // Iì—´: ë‹´ë‹¹ì
      const activationDate = row[9] || ''; // Jì—´: ê°œí†µì¼
      const model = row[21] || 'ë¯¸ì§€ì •'; // Vì—´: ëª¨ë¸ëª…
      const color = row[22] || 'ë¯¸ì§€ì •'; // Wì—´: ìƒ‰ìƒ

      if (!activationDate) return;

      // ë‚ ì§œ í˜•ì‹ ì •ê·œí™”
      let normalizedDate = activationDate;
      if (activationDate.match(/^\d{1,2}\/\d{1,2}$/)) {
        const previousYear = new Date().getFullYear() - 1;
        normalizedDate = `${activationDate}/${previousYear}`;
      }

      // ISO í˜•ì‹ìœ¼ë¡œ ë³€í™˜
      try {
        const dateObj = new Date(normalizedDate);
        if (!isNaN(dateObj.getTime())) {
          normalizedDate = dateObj.toISOString().split('T')[0];
        }
      } catch (error) {
        console.warn('ë‚ ì§œ ë³€í™˜ ì‹¤íŒ¨:', normalizedDate, error);
        return;
      }

      // íŠ¹ì • ë‚ ì§œë§Œ ì²˜ë¦¬ (ì „ì›”ì˜ ê°™ì€ ì¼ì)
      const previousDay = new Date(normalizedDate).getDate();
      const targetDay = new Date(date).getDate();
      if (previousDay !== targetDay) return;

      processedPreviousCount++;
      if (processedPreviousCount <= 5) { // ì²˜ìŒ 5ê°œë§Œ ë¡œê·¸ ì¶œë ¥
        const day = new Date(normalizedDate).getDate();
        // console.log(`ì „ì›” ë°ì´í„° ë§¤ì¹­: ${store} - ${activationDate} -> ${day}ì¼`);
      }

      if (!comparisonData[store]) {
        comparisonData[store] = {
          storeName: store,
          currentMonth: 0,
          previousMonth: 0,
          agents: new Set(),
          models: {}
        };
      }

      comparisonData[store].previousMonth++;
      comparisonData[store].agents.add(agent);

      const modelKey = `${model} (${color})`;
      if (!comparisonData[store].models[modelKey]) {
        comparisonData[store].models[modelKey] = 0;
      }
      comparisonData[store].models[modelKey]++;
    });

    // Setì„ ë°°ì—´ë¡œ ë³€í™˜
    Object.keys(comparisonData).forEach(store => {
      comparisonData[store].agents = Array.from(comparisonData[store].agents);
    });

    const processingTime = Date.now() - startTime;
    // console.log(`ë‚ ì§œ ë¹„êµ ë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ: ${date}, ${Object.keys(comparisonData).length}ê°œ ë§¤ì¥, ${processingTime}ms ì†Œìš”`);

    // ì „ì›” ë°ì´í„° ìš”ì•½ ë¡œê·¸
    const storesWithPreviousData = Object.values(comparisonData).filter(store => store.previousMonth > 0);
    // console.log(`ì „ì›” ë°ì´í„°ê°€ ìˆëŠ” ë§¤ì¥ ìˆ˜: ${storesWithPreviousData.length}`);
    if (storesWithPreviousData.length > 0) {
      // console.log('ì „ì›” ë°ì´í„°ê°€ ìˆëŠ” ë§¤ì¥ë“¤:', storesWithPreviousData.map(store => ({
      //   storeName: store.storeName,
      //   previousMonth: store.previousMonth
      // })));
    }

    // ìºì‹œì— ì €ì¥ (5ë¶„ TTL)
    cacheUtils.set(cacheKey, comparisonData);

    res.json(comparisonData);
  } catch (error) {
    console.error('Error fetching activation date comparison data:', error);
    res.status(500).json({
      error: 'Failed to fetch activation date comparison data',
      message: error.message
    });
  }
});

// ì‚¬ìš©ì í™œë™ ë¡œê¹… API (ë¹„ë™ê¸° ì²˜ë¦¬)
app.post('/api/log-activity', async (req, res) => {
  // ì¦‰ì‹œ ì‘ë‹µ ë°˜í™˜
  res.json({ success: true });

  // ë¡œê¹… ì²˜ë¦¬ë¥¼ ë¹„ë™ê¸°ë¡œ ì‹¤í–‰
  setImmediate(async () => {
    try {
      const {
        userId,
        userType,
        targetName,
        ipAddress,
        location,
        deviceInfo,
        activity,
        model,
        colorName,
        callButton
      } = req.body;

      // í™œë™ ìœ í˜•ì— ë”°ë¥¸ ì œëª© ì„¤ì •
      let title = 'ì‚¬ìš©ì í™œë™';
      let embedColor = 3447003; // íŒŒë€ìƒ‰

      if (activity === 'login') {
        title = 'ì‚¬ìš©ì ë¡œê·¸ì¸';
        embedColor = 5763719; // ì´ˆë¡ìƒ‰
      } else if (activity === 'search') {
        title = 'ëª¨ë¸ ê²€ìƒ‰';
        embedColor = 16776960; // ë…¸ë€ìƒ‰
      } else if (activity === 'call_button') {
        title = 'ì „í™” ì—°ê²° ë²„íŠ¼ í´ë¦­';
        embedColor = 15548997; // ë¹¨ê°„ìƒ‰
      } else if (activity === 'kakao_button') {
        title = 'ì¹´í†¡ë¬¸êµ¬ ìƒì„±';
        embedColor = 16776960; // ë…¸ë€ìƒ‰ (ì¹´ì¹´ì˜¤í†¡ ìƒ‰ìƒ)
      }

      // Discordë¡œ ë¡œê·¸ ì „ì†¡ ì‹œë„
      if (DISCORD_LOGGING_ENABLED) {
        try {
          // Embed ë°ì´í„° êµ¬ì„±
          const embedData = {
            title: title,
            color: embedColor,
            timestamp: new Date().toISOString(),
            userType: userType || 'store',
            fields: [
              {
                name: 'ì‚¬ìš©ì ì •ë³´',
                value: `ID: ${userId}\nì¢…ë¥˜: ${userType === 'agent' ? 'ê´€ë¦¬ì' : 'ì¼ë°˜'}\nëŒ€ìƒ: ${targetName || 'ì—†ìŒ'}`
              },
              {
                name: 'ì ‘ì† ì •ë³´',
                value: `IP: ${ipAddress}\nìœ„ì¹˜: ${location || 'ì•Œ ìˆ˜ ì—†ìŒ'}\nê¸°ê¸°: ${deviceInfo || 'ì•Œ ìˆ˜ ì—†ìŒ'}`
              }
            ],
            footer: {
              text: userType === 'agent' ? '(ì£¼)ë¸Œì´ì•„ì´í”¼í”ŒëŸ¬ìŠ¤ ê´€ë¦¬ì í™œë™ ë¡œê·¸' : '(ì£¼)ë¸Œì´ì•„ì´í”¼í”ŒëŸ¬ìŠ¤ ë§¤ì¥ í™œë™ ë¡œê·¸'
            }
          };

          // ê²€ìƒ‰ ì •ë³´ê°€ ìˆëŠ” ê²½ìš° í•„ë“œ ì¶”ê°€
          if (model) {
            embedData.fields.push({
              name: 'ê²€ìƒ‰ ì •ë³´',
              value: `ëª¨ë¸: ${model}${colorName ? `\nìƒ‰ìƒ: ${colorName}` : ''}`
            });
          }

          // ì „í™” ì—°ê²° ë²„íŠ¼ í´ë¦­ ì •ë³´
          if (callButton) {
            embedData.fields.push({
              name: 'ì „í™” ì—°ê²°',
              value: `${callButton}`
            });
          }

          // ì¹´í†¡ë¬¸êµ¬ ìƒì„± ë²„íŠ¼ í´ë¦­ ì •ë³´
          if (req.body.kakaoButton) {
            embedData.fields.push({
              name: 'ì¹´í†¡ë¬¸êµ¬ ìƒì„±',
              value: `ì¹´ì¹´ì˜¤í†¡ ë©”ì‹œì§€ í…œí”Œë¦¿ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.`
            });
          }

          // Discordë¡œ ë¡œê·¸ ì „ì†¡
          await sendLogToDiscord(embedData);
        } catch (logError) {
          console.error('í™œë™ ë¡œê·¸ Discord ì „ì†¡ ì˜¤ë¥˜:', logError.message);
        }
      }
    } catch (error) {
      console.error('í™œë™ ë¡œê·¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
    }
  });
});

// ë¡œê·¸ì¸ ì „ìš© ìºì‹œ (ì„±ëŠ¥ ìµœì í™”)
const loginCache = new Map();
const LOGIN_CACHE_TTL = 5 * 60 * 1000; // 5ë¶„

// ë¡œê·¸ì¸ ê²€ì¦ API ì¶”ê°€
app.post('/api/login', async (req, res) => {
  try {
    const { storeId, deviceInfo, ipAddress, location } = req.body;

    if (!storeId) {
      return res.status(400).json({
        success: false,
        error: 'Store ID is required'
      });
    }

    // ë¡œê·¸ì¸ ìºì‹œ í™•ì¸ (ì„±ëŠ¥ ìµœì í™”)
    const cacheKey = `login_${storeId}`;
    const cachedLogin = loginCache.get(cacheKey);
    if (cachedLogin && Date.now() < cachedLogin.ttl) {
      console.log(`ğŸš€ [ë¡œê·¸ì¸ ìµœì í™”] ìºì‹œëœ ë¡œê·¸ì¸ ì •ë³´ ì‚¬ìš©: ${storeId}`);
      return res.json(cachedLogin.data);
    }

    // console.log(`Login attempt with ID: ${storeId}`);
    // console.log('Step 1: Starting login process...');

    // 1. ëŒ€ë¦¬ì  ê´€ë¦¬ìì™€ ì¼ë°˜ ë§¤ì¥ ë°ì´í„°ë¥¼ ë³‘ë ¬ë¡œ ê°€ì ¸ì˜¤ê¸° (ì„±ëŠ¥ ìµœì í™”)
    // console.log('Step 2: Fetching agent and store data in parallel...');
    const [agentValues, storeValues] = await Promise.all([
      getSheetValues(AGENT_SHEET_NAME),
      getSheetValues(STORE_SHEET_NAME)
    ]);
    // console.log('Step 3: Data fetched, agent rows:', agentValues ? agentValues.length : 0, 'store rows:', storeValues ? storeValues.length : 0);

    // 2. ë¨¼ì € ëŒ€ë¦¬ì  ê´€ë¦¬ì IDì¸ì§€ í™•ì¸
    if (agentValues) {
      const agentRows = agentValues.slice(1);
      // console.log('Step 4: Agent rows (excluding header):', agentRows.length);

      const agent = agentRows.find(row => row[2] === storeId); // Cì—´: ì—°ë½ì²˜(ì•„ì´ë””)
      // console.log('Step 5: Agent search result:', agent ? 'Found' : 'Not found');

      if (agent) {
        // console.log(`Found agent: ${agent[0]}, ${agent[1]}`);
        // console.log('Step 6: Processing agent login...');

        // ì‹ ê·œ ì¶”ê°€: íŒ¨ìŠ¤ì›Œë“œ ê´€ë ¨ ì •ë³´
        const passwordNotUsed = agent[3] === 'TRUE'; // Dì—´: íŒ¨ìŠ¤ì›Œë“œ ë¯¸ì‚¬ìš©
        const storedPassword = agent[4] || ''; // Eì—´: íŒ¨ìŠ¤ì›Œë“œ
        const isPasswordEmpty = (!agent[3] || agent[3] === '') && (!agent[4] || agent[4] === ''); // Dì—´ê³¼ Eì—´ì´ ëª¨ë‘ ë¹„ì–´ìˆìŒ

        console.log('ğŸ” [ë°±ì—”ë“œ íŒ¨ìŠ¤ì›Œë“œ ë””ë²„ê¹…] ì‚¬ìš©ì:', storeId);
        console.log('ğŸ” [ë°±ì—”ë“œ íŒ¨ìŠ¤ì›Œë“œ ë””ë²„ê¹…] agent[3] (Dì—´):', agent[3]);
        console.log('ğŸ” [ë°±ì—”ë“œ íŒ¨ìŠ¤ì›Œë“œ ë””ë²„ê¹…] agent[4] (Eì—´):', agent[4]);
        console.log('ğŸ” [ë°±ì—”ë“œ íŒ¨ìŠ¤ì›Œë“œ ë””ë²„ê¹…] passwordNotUsed:', passwordNotUsed);
        console.log('ğŸ” [ë°±ì—”ë“œ íŒ¨ìŠ¤ì›Œë“œ ë””ë²„ê¹…] storedPassword:', storedPassword);
        console.log('ğŸ” [ë°±ì—”ë“œ íŒ¨ìŠ¤ì›Œë“œ ë””ë²„ê¹…] hasPassword:', storedPassword !== '');
        console.log('ğŸ” [ë°±ì—”ë“œ íŒ¨ìŠ¤ì›Œë“œ ë””ë²„ê¹…] isPasswordEmpty:', isPasswordEmpty);

        // Hì—´: ì¬ê³ ëª¨ë“œ ê¶Œí•œ, Iì—´: ì •ì‚°ëª¨ë“œ ê¶Œí•œ, Jì—´: ê²€ìˆ˜ëª¨ë“œ ê¶Œí•œ, Kì—´: ì±„ê¶Œì¥í‘œ ë©”ë‰´ ê¶Œí•œ, Lì—´: ì •ì±…ëª¨ë“œ ê¶Œí•œ, Mì—´: ê²€ìˆ˜ì „ì²´í˜„í™© ê¶Œí•œ, Nì—´: íšŒì˜ëª¨ë“œ ê¶Œí•œ, Oì—´: ì‚¬ì „ì˜ˆì•½ëª¨ë“œ ê¶Œí•œ, Pì—´: ì¥í‘œëª¨ë“œ ê¶Œí•œ, Sì—´: ì˜ˆì‚°ëª¨ë“œ ê¶Œí•œ, Uì—´: ì˜ì—…ëª¨ë“œ ê¶Œí•œ, Vì—´: ì¬ê³ íšŒìˆ˜ëª¨ë“œ ê¶Œí•œ í™•ì¸
        // ì‚¬ë¬´ì‹¤ê³¼ ì†Œì† ì •ë³´ (Fì—´, Gì—´)
        const office = agent[5] || ''; // Fì—´: ì‚¬ë¬´ì‹¤
        const department = agent[6] || ''; // Gì—´: ì†Œì†

        const hasInventoryPermission = agent[7] === 'O'; // Hì—´ (ê¸°ì¡´ Fì—´)
        const hasSettlementPermission = agent[8] === 'O'; // Iì—´ (ê¸°ì¡´ Gì—´)
        const hasInspectionPermission = agent[9] === 'O'; // Jì—´ (ê¸°ì¡´ Hì—´)
        const hasBondChartPermission = agent[10] === 'O'; // Kì—´: ì±„ê¶Œì¥í‘œ ë©”ë‰´ ê¶Œí•œ (ê¸°ì¡´ Iì—´)
        const hasPolicyPermission = agent[11] === 'O'; // Lì—´ (ê¸°ì¡´ Jì—´)
        const hasInspectionOverviewPermission = agent[12] === 'O'; // Mì—´ (ê¸°ì¡´ Kì—´)
        const meetingPermissionRaw = (agent[13] || '').toString().trim().toUpperCase(); // Nì—´: íšŒì˜ëª¨ë“œ ê¶Œí•œ (M ë˜ëŠ” O)
        const hasMeetingPermission = ['M', 'O'].includes(meetingPermissionRaw); // Nì—´: íšŒì˜ëª¨ë“œ ê¶Œí•œ (M ë˜ëŠ” O)
        const hasReservationPermission = agent[14] === 'O'; // Oì—´ (ê¸°ì¡´ Mì—´)
        const hasChartPermission = agent[15] === 'O'; // Pì—´: ì¥í‘œëª¨ë“œ ê¶Œí•œ (ê¸°ì¡´ Nì—´)
        const teamCode = agent[16] || ''; // Qì—´: íŒ€ì½”ë“œ
        const userRole = agent[17] || ''; // Rì—´: ê¶Œí•œ
        const hasBudgetPermission = agent[18] === 'O'; // Sì—´: ì˜ˆì‚°ëª¨ë“œ ê¶Œí•œ (ê¸°ì¡´ Qì—´)
        const hasSalesPermission = agent[20] === 'O'; // Uì—´: ì˜ì—…ëª¨ë“œ ê¶Œí•œ (ê¸°ì¡´ Sì—´)
        const hasInventoryRecoveryPermission = agent[21] === 'O'; // Vì—´: ì¬ê³ íšŒìˆ˜ëª¨ë“œ ê¶Œí•œ (ê¸°ì¡´ Tì—´)
        const hasDataCollectionPermission = agent[22] === 'O'; // Wì—´: ì •ë³´ìˆ˜ì§‘ëª¨ë“œ ê¶Œí•œ (ê¸°ì¡´ Uì—´)
        const hasSmsManagementPermission = agent[23] === 'O'; // Xì—´: SMS ê´€ë¦¬ëª¨ë“œ ê¶Œí•œ (ê¸°ì¡´ Vì—´)
        const obManagementPermissionRaw = (agent[24] || '').toString().trim().toUpperCase();
        const hasObManagementPermission = ['O', 'M', 'S'].includes(obManagementPermissionRaw); // Yì—´: OB ê´€ë¦¬ëª¨ë“œ ê¶Œí•œ (ê¸°ì¡´ Wì—´)
        const hasAgentModePermission = agent[25] === 'O'; // Zì—´: ê´€ë¦¬ìëª¨ë“œ ê¶Œí•œ (ê¸°ì¡´ Xì—´)
        // AAì—´: ì˜¨ì„¸ì¼ê´€ë¦¬ëª¨ë“œ ì ‘ì† ê¶Œí•œ (O, S, M ëª¨ë‘ ì ‘ì† ê°€ëŠ¥)
        const hasOnSaleManagementPermission = agent[26] === 'O' || agent[26] === 'S' || agent[26] === 'M';
        const hasOnSaleLinkPermission = agent[26] === 'S'; // AAì—´: ì˜¨ì„¸ì¼ ë§í¬ê´€ë¦¬ ê¶Œí•œ
        const hasOnSalePolicyPermission = agent[26] === 'M'; // AAì—´: ì˜¨ì„¸ì¼ ì •ì±…ê²Œì‹œíŒ ê¶Œí•œ (M ê¶Œí•œì€ ë§í¬ê´€ë¦¬ + ì •ì±…ê²Œì‹œíŒ)
        const hasMealAllowancePermission = agent[27] === 'O'; // ABì—´: ì‹ëŒ€ ëª¨ë“œ ê¶Œí•œ
        const hasAttendancePermission = agent[28] === 'O'; // ACì—´: ê·¼í‡´ ëª¨ë“œ ê¶Œí•œ
        const hasRiskManagementPermission = agent[29] === 'O'; // ADì—´: ë¦¬ìŠ¤í¬ ê´€ë¦¬ ëª¨ë“œ ê¶Œí•œ
        const directStoreManagementPermissionRaw = (agent[30] || '').toString().trim().toUpperCase(); // AEì—´: ì§ì˜ì  ê´€ë¦¬ ëª¨ë“œ ê¶Œí•œ
        const hasDirectStoreManagementPermission = directStoreManagementPermissionRaw === 'M' || directStoreManagementPermissionRaw === 'S' || directStoreManagementPermissionRaw === 'O'; // M, S, O ëª¨ë‘ í—ˆìš©
        const hasQuickServiceManagementPermission = agent[31] === 'O'; // AFì—´: í€µì„œë¹„ìŠ¤ ê´€ë¦¬ ëª¨ë“œ ê¶Œí•œ

        // ì •ë³´ìˆ˜ì§‘ëª¨ë“œ ê¶Œí•œ ë””ë²„ê¹…
        console.log('ğŸ” [ê¶Œí•œì²´í¬] ì •ë³´ìˆ˜ì§‘ëª¨ë“œ ë””ë²„ê¹…:');
        console.log('  - agent[20] ê°’:', agent[20]);
        console.log('  - hasDataCollectionPermission:', hasDataCollectionPermission);
        console.log('  - agent ì „ì²´:', agent);

        // console.log('Step 6.5: Permission check:', {
        //   inventory: hasInventoryPermission,
        //   settlement: hasSettlementPermission,
        //   inspection: hasInspectionPermission,
        //   bondChart: hasBondChartPermission,
        //   chart: hasChartPermission,
        //   policy: hasPolicyPermission,
        //   inspectionOverview: hasInspectionOverviewPermission
        // });

        // ë‹¤ì¤‘ ê¶Œí•œì´ ìˆëŠ” ê²½ìš° ê¶Œí•œ ì •ë³´ í¬í•¨
        const modePermissions = {
          agent: hasAgentModePermission, // ê´€ë¦¬ì ëª¨ë“œë„ ê¶Œí•œ í™•ì¸
          inventory: hasInventoryPermission,
          settlement: hasSettlementPermission,
          inspection: hasInspectionPermission,
          bondChart: hasBondChartPermission, // ì±„ê¶Œì¥í‘œ ë©”ë‰´ ê¶Œí•œ
          chart: hasChartPermission, // ì¥í‘œëª¨ë“œ ê¶Œí•œ
          policy: hasPolicyPermission,
          inspectionOverview: hasInspectionOverviewPermission,
          meeting: hasMeetingPermission ? meetingPermissionRaw : false, // M ë˜ëŠ” O ê¶Œí•œ ê°’ ì €ì¥
          reservation: hasReservationPermission,
          budget: hasBudgetPermission, // ì˜ˆì‚°ëª¨ë“œ ê¶Œí•œ
          sales: hasSalesPermission, // ì˜ì—…ëª¨ë“œ ê¶Œí•œ
          inventoryRecovery: hasInventoryRecoveryPermission, // ì¬ê³ íšŒìˆ˜ëª¨ë“œ ê¶Œí•œ
          dataCollection: hasDataCollectionPermission, // ì •ë³´ìˆ˜ì§‘ëª¨ë“œ ê¶Œí•œ
          smsManagement: hasSmsManagementPermission, // SMS ê´€ë¦¬ëª¨ë“œ ê¶Œí•œ
          obManagement: hasObManagementPermission, // OB ê´€ë¦¬ëª¨ë“œ ê¶Œí•œ
          onSaleManagement: hasOnSaleManagementPermission, // ì˜¨ì„¸ì¼ê´€ë¦¬ëª¨ë“œ ê¶Œí•œ
          onSaleLink: hasOnSaleLinkPermission || hasOnSalePolicyPermission, // ì˜¨ì„¸ì¼ ë§í¬ê´€ë¦¬ ê¶Œí•œ (S ë˜ëŠ” M)
          onSalePolicy: hasOnSalePolicyPermission, // ì˜¨ì„¸ì¼ ì •ì±…ê²Œì‹œíŒ ê¶Œí•œ (M ê¶Œí•œë§Œ)
          mealAllowance: hasMealAllowancePermission, // ì‹ëŒ€ ëª¨ë“œ ê¶Œí•œ
          attendance: hasAttendancePermission, // ê·¼í‡´ ëª¨ë“œ ê¶Œí•œ
          riskManagement: hasRiskManagementPermission, // ë¦¬ìŠ¤í¬ ê´€ë¦¬ ëª¨ë“œ ê¶Œí•œ
          quickServiceManagement: hasQuickServiceManagementPermission, // í€µì„œë¹„ìŠ¤ ê´€ë¦¬ ëª¨ë“œ ê¶Œí•œ
          directStoreManagement: hasDirectStoreManagementPermission ? directStoreManagementPermissionRaw : false // ì§ì˜ì  ê´€ë¦¬ ëª¨ë“œ ê¶Œí•œ (M, S, O ëª¨ë‘ í—ˆìš©)
        };

        // ë””ìŠ¤ì½”ë“œë¡œ ë¡œê·¸ì¸ ë¡œê·¸ ì „ì†¡ (ë¹„ë™ê¸° ì²˜ë¦¬ë¡œ ì„±ëŠ¥ ìµœì í™”)
        if (DISCORD_LOGGING_ENABLED) {
          const embedData = {
            title: 'ê´€ë¦¬ì ë¡œê·¸ì¸',
            color: 15844367, // ë³´ë¼ìƒ‰
            timestamp: new Date().toISOString(),
            userType: 'agent', // ê´€ë¦¬ì íƒ€ì… ì§€ì •
            fields: [
              {
                name: 'ê´€ë¦¬ì ì •ë³´',
                value: `ID: ${agent[2]}\nëŒ€ìƒ: ${agent[0]}\nìê²©: ${agent[1]}\nê´€ë¦¬ìê¶Œí•œ: ${hasAgentModePermission ? 'O' : 'X'}\nì¬ê³ ê¶Œí•œ: ${hasInventoryPermission ? 'O' : 'X'}\nì •ì‚°ê¶Œí•œ: ${hasSettlementPermission ? 'O' : 'X'}\nê²€ìˆ˜ê¶Œí•œ: ${hasInspectionPermission ? 'O' : 'X'}\nì±„ê¶Œì¥í‘œê¶Œí•œ: ${hasBondChartPermission ? 'O' : 'X'}\nì¥í‘œê¶Œí•œ: ${hasChartPermission ? 'O' : 'X'}\nì •ì±…ê¶Œí•œ: ${hasPolicyPermission ? 'O' : 'X'}\nê²€ìˆ˜ì „ì²´í˜„í™©ê¶Œí•œ: ${hasInspectionOverviewPermission ? 'O' : 'X'}\níšŒì˜ê¶Œí•œ: ${hasMeetingPermission ? 'O' : 'X'}\nì‚¬ì „ì˜ˆì•½ê¶Œí•œ: ${hasReservationPermission ? 'O' : 'X'}\nì˜ˆì‚°ê¶Œí•œ: ${hasBudgetPermission ? 'O' : 'X'}\nì˜ì—…ê¶Œí•œ: ${hasSalesPermission ? 'O' : 'X'}\nì¬ê³ íšŒìˆ˜ê¶Œí•œ: ${hasInventoryRecoveryPermission ? 'O' : 'X'}\nSMSê´€ë¦¬ê¶Œí•œ: ${hasSmsManagementPermission ? 'O' : 'X'}\nOBê´€ë¦¬ê¶Œí•œ: ${hasObManagementPermission ? 'O' : 'X'}\nì˜¨ì„¸ì¼ê´€ë¦¬ê¶Œí•œ: ${hasOnSaleManagementPermission ? 'O' : 'X'}`
              },
              {
                name: 'ì ‘ì† ì •ë³´',
                value: `IP: ${ipAddress || 'ì•Œ ìˆ˜ ì—†ìŒ'}\nìœ„ì¹˜: ${location || 'ì•Œ ìˆ˜ ì—†ìŒ'}\nê¸°ê¸°: ${deviceInfo || 'ì•Œ ìˆ˜ ì—†ìŒ'}`
              }
            ],
            footer: {
              text: '(ì£¼)ë¸Œì´ì•„ì´í”¼í”ŒëŸ¬ìŠ¤ ê´€ë¦¬ì ë¡œê·¸ì¸'
            }
          };

          // ë¹„ë™ê¸°ë¡œ ë¡œê·¸ ì „ì†¡ (ì‘ë‹µ ì§€ì—° ë°©ì§€)
          sendLogToDiscord(embedData).catch(logError => {
            console.error('ë¡œê·¸ì¸ ë¡œê·¸ ì „ì†¡ ì‹¤íŒ¨:', logError.message);
          });
        }

        const loginResult = {
          success: true,
          isAgent: true,
          modePermissions: modePermissions,
          obManagementRole: obManagementPermissionRaw || '',
          meetingRole: meetingPermissionRaw || '', // íšŒì˜ ëª¨ë“œ ê¶Œí•œ ì¶”ê°€
          agentInfo: {
            target: agent[0] || '',       // Aì—´: ëŒ€ìƒ
            qualification: agent[1] || '', // Bì—´: ìê²©
            contactId: agent[2] || '',     // Cì—´: ì—°ë½ì²˜(ì•„ì´ë””)
            passwordNotUsed: passwordNotUsed, // Dì—´: íŒ¨ìŠ¤ì›Œë“œ ë¯¸ì‚¬ìš©
            hasPassword: storedPassword !== '', // íŒ¨ìŠ¤ì›Œë“œ ì¡´ì¬ ì—¬ë¶€
            isPasswordEmpty: isPasswordEmpty, // íŒ¨ìŠ¤ì›Œë“œ ì„¤ì •ì´ í•„ìš”í•œì§€ ì—¬ë¶€
            office: agent[5] || '',        // Fì—´: ì‚¬ë¬´ì‹¤ (ê¸°ì¡´ Dì—´)
            department: agent[6] || '',    // Gì—´: ì†Œì† (ê¸°ì¡´ Eì—´)
            userRole: agent[17] || '',     // Rì—´: ê¶Œí•œ (ê¸°ì¡´ Pì—´)
            obManagementRole: obManagementPermissionRaw || '',
            meetingRole: meetingPermissionRaw || '', // íšŒì˜ ëª¨ë“œ ê¶Œí•œ ì¶”ê°€
            onSaleLink: hasOnSaleLinkPermission || hasOnSalePolicyPermission, // AAì—´: ì˜¨ì„¸ì¼ ë§í¬ê´€ë¦¬ ê¶Œí•œ (S ë˜ëŠ” M)
            onSalePolicy: hasOnSalePolicyPermission // AAì—´: ì˜¨ì„¸ì¼ ì •ì±…ê²Œì‹œíŒ ê¶Œí•œ (M ê¶Œí•œë§Œ)
          }
        };

        // ë¡œê·¸ì¸ ê²°ê³¼ ìºì‹œ ì €ì¥ (ì„±ëŠ¥ ìµœì í™”)
        loginCache.set(cacheKey, {
          data: loginResult,
          ttl: Date.now() + LOGIN_CACHE_TTL
        });

        return res.json(loginResult);
      }
    }

    // 3. ëŒ€ë¦¬ì  ê´€ë¦¬ìê°€ ì•„ë‹Œ ê²½ìš° ì¼ë°˜ëª¨ë“œê¶Œí•œê´€ë¦¬ ì‹œíŠ¸ì—ì„œ ê²€ìƒ‰
    console.log('Step 3: ì¼ë°˜ëª¨ë“œê¶Œí•œê´€ë¦¬ ì‹œíŠ¸ì—ì„œ ê²€ìƒ‰ ì‹œì‘');

    const generalModeSheetName = 'ì¼ë°˜ëª¨ë“œê¶Œí•œê´€ë¦¬';
    const generalModeRange = 'A:H'; // A~Hì—´

    const generalModeResponse = await rateLimitedSheetsCall(() =>
      sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: `${generalModeSheetName}!${generalModeRange}`,
      })
    );

    const generalModeValues = generalModeResponse.data.values || [];
    console.log(`ì¼ë°˜ëª¨ë“œê¶Œí•œê´€ë¦¬ ì‹œíŠ¸ í–‰ ìˆ˜: ${generalModeValues.length}`);

    // í—¤ë”ëŠ” 3í–‰(ì¸ë±ìŠ¤ 2), ë°ì´í„°ëŠ” 4í–‰(ì¸ë±ìŠ¤ 3)ë¶€í„°
    if (generalModeValues.length > 3) {
      const generalModeRows = generalModeValues.slice(3); // 4í–‰ë¶€í„° ë°ì´í„°

      const foundGeneralUser = generalModeRows.find(row => {
        const rowId = row[0]; // Aì—´: ì‚¬ìš©ìID(POSì½”ë“œ)
        return rowId === storeId;
      });

      if (foundGeneralUser) {
        console.log('ì¼ë°˜ëª¨ë“œ ì‚¬ìš©ì ë°œê²¬:', foundGeneralUser[0]);

        // ê¶Œí•œ í™•ì¸
        const hasBasicMode = foundGeneralUser[3] === 'O'; // Dì—´: ê¸°ë³¸ ëª¨ë“œ
        // Eì—´: ì˜¨ì„¸ì¼ì ‘ìˆ˜ ëª¨ë“œ - 'O' ë˜ëŠ” 'M' ëª¨ë‘ í—ˆìš©
        const eColumnValue = (foundGeneralUser[4] || '').toString().trim().toUpperCase();
        const hasOnSaleMode = eColumnValue === 'O' || eColumnValue === 'M';
        const directStoreColumnValue = (foundGeneralUser[6] || '').toString().trim().toUpperCase(); // Gì—´: ì§ì˜ì  ëª¨ë“œ ê¶Œí•œ
        const hasDirectStoreMode = directStoreColumnValue === 'O';
        const directStorePassword = (foundGeneralUser[7] || '').toString().trim(); // Hì—´: ì§ì˜ì  ëª¨ë“œ ë¹„ë°€ë²ˆí˜¸
        const requiresDirectStorePassword = hasDirectStoreMode && directStorePassword !== '';

        console.log('ê¶Œí•œ í™•ì¸:', {
          basicMode: hasBasicMode,
          onSaleMode: hasOnSaleMode,
          directStoreMode: hasDirectStoreMode
        });

        // ê¶Œí•œì´ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ ë¡œê·¸ì¸ ê±°ë¶€
        if (!hasBasicMode && !hasOnSaleMode && !hasDirectStoreMode) {
          console.log('ê¶Œí•œ ì—†ìŒ: ë¡œê·¸ì¸ ê±°ë¶€');
          return res.status(403).json({
            success: false,
            error: 'ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.'
          });
        }

        // í°í´ì¶œê³ ì²˜ë°ì´í„°ì—ì„œ ì¶”ê°€ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ìœ„ë„, ê²½ë„ ë“±)
        let storeDetails = {
          latitude: 0,
          longitude: 0,
          address: '',
          phone: ''
        };

        if (storeValues) {
          const storeRows = storeValues.slice(1);
          const foundStoreRow = storeRows.find(row => row[15] === storeId);

          if (foundStoreRow) {
            storeDetails = {
              address: foundStoreRow[11] || '',
              latitude: parseFloat(foundStoreRow[8] || '0'),
              longitude: parseFloat(foundStoreRow[9] || '0'),
              phone: foundStoreRow[19] || ''
            };
          }
        }

        // ì¼ë°˜ëª¨ë“œê¶Œí•œê´€ë¦¬ ì‹œíŠ¸ êµ¬ì¡° í™•ì¸ í•„ìš”
        // Aì—´(0): ì•„ì´ë””, Bì—´(1): ì—…ì²´ëª…, Cì—´(2): ê·¸ë£¹ (ì‚¬ìš©ì ìš”êµ¬ì‚¬í•­ ê¸°ì¤€)
        // Eì—´ ê°’: 'O' ë˜ëŠ” 'M' - ì˜¨ì„¸ì¼ì ‘ìˆ˜ëª¨ë“œ ê¶Œí•œ
        // 'M'ì¸ ê²½ìš° ì •ì±…ê²Œì‹œíŒ ì ‘ê·¼ ê¶Œí•œë„ ìˆìŒ (onSalePolicy: true)
        const store = {
          id: foundGeneralUser[0],           // Aì—´: ì‚¬ìš©ìID(POSì½”ë“œ)
          name: foundGeneralUser[1] || '',   // Bì—´: ì—…ì²´ëª…
          group: (foundGeneralUser[2] || '').trim(),  // Cì—´: ê·¸ë£¹
          manager: foundGeneralUser[2] || '', // Cì—´: ì˜ì—…ë‹´ë‹¹ (ê¸°ì¡´ ì½”ë“œ í˜¸í™˜ì„±)
          userRole: eColumnValue,              // Eì—´ ê°’: 'O' ë˜ëŠ” 'M'ì„ userRoleë¡œ ì„¤ì •
          ...storeDetails,
          modePermissions: {
            basicMode: hasBasicMode,         // Dì—´: ê¸°ë³¸ ëª¨ë“œ
            onSaleReception: hasOnSaleMode,  // Eì—´: ì˜¨ì„¸ì¼ì ‘ìˆ˜ ëª¨ë“œ
            onSalePolicy: eColumnValue === 'M', // Eì—´ì´ 'M'ì¸ ê²½ìš° ì •ì±…ê²Œì‹œíŒ ê¶Œí•œ
            directStore: hasDirectStoreMode     // Gì—´: ì§ì˜ì  ëª¨ë“œ
          },
          directStoreSecurity: {
            requiresPassword: requiresDirectStorePassword
          }
        };

        // ë””ìŠ¤ì½”ë“œë¡œ ë¡œê·¸ì¸ ë¡œê·¸ ì „ì†¡ (ë¹„ë™ê¸° ì²˜ë¦¬ë¡œ ì„±ëŠ¥ ìµœì í™”)
        if (DISCORD_LOGGING_ENABLED) {
          const embedData = {
            title: 'ì¼ë°˜ëª¨ë“œ ë¡œê·¸ì¸',
            color: 5763719, // ì´ˆë¡ìƒ‰
            timestamp: new Date().toISOString(),
            userType: 'general', // ì¼ë°˜ëª¨ë“œ íƒ€ì… ì§€ì •
            fields: [
              {
                name: 'ì‚¬ìš©ì ì •ë³´',
                value: `ID: ${store.id}\nì—…ì²´ëª…: ${store.name}\në‹´ë‹¹ì: ${store.manager || 'ì—†ìŒ'}\nê¸°ë³¸ëª¨ë“œ: ${hasBasicMode ? 'O' : 'X'}\nì˜¨ì„¸ì¼ì ‘ìˆ˜: ${hasOnSaleMode ? 'O' : 'X'}`
              },
              {
                name: 'ì ‘ì† ì •ë³´',
                value: `IP: ${ipAddress || 'ì•Œ ìˆ˜ ì—†ìŒ'}\nìœ„ì¹˜: ${location || 'ì•Œ ìˆ˜ ì—†ìŒ'}\nê¸°ê¸°: ${deviceInfo || 'ì•Œ ìˆ˜ ì—†ìŒ'}`
              }
            ],
            footer: {
              text: '(ì£¼)ë¸Œì´ì•„ì´í”¼í”ŒëŸ¬ìŠ¤ ì¼ë°˜ëª¨ë“œ ë¡œê·¸ì¸'
            }
          };

          // ë¹„ë™ê¸°ë¡œ ë¡œê·¸ ì „ì†¡ (ì‘ë‹µ ì§€ì—° ë°©ì§€)
          sendLogToDiscord(embedData).catch(logError => {
            console.error('ë¡œê·¸ì¸ ë¡œê·¸ ì „ì†¡ ì‹¤íŒ¨:', logError.message);
          });
        }

        const loginResult = {
          success: true,
          isAgent: false,
          storeInfo: store,
          modePermissions: store.modePermissions
        };

        // ë¡œê·¸ì¸ ê²°ê³¼ ìºì‹œ ì €ì¥ (ì„±ëŠ¥ ìµœì í™”)
        loginCache.set(cacheKey, {
          data: loginResult,
          ttl: Date.now() + LOGIN_CACHE_TTL
        });

        return res.json(loginResult);
      }
    }

    // 3. ë§¤ì¥ IDë„ ì•„ë‹Œ ê²½ìš°
    return res.status(404).json({
      success: false,
      error: 'Store not found'
    });

  } catch (error) {
    console.error('Error in login:', error);
    console.error('Login error stack:', error.stack);
    res.status(500).json({
      success: false,
      error: 'Login failed',
      message: error.message
    });
  }
});

// ê³ ê° ë¡œê·¸ì¸ API ì¶”ê°€
app.post('/api/member/login', async (req, res) => {
  try {
    const { ctn, password } = req.body;

    if (!ctn || !password) {
      return res.status(400).json({
        success: false,
        error: 'ì „í™”ë²ˆí˜¸ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'
      });
    }

    // í•˜ì´í”ˆ ì œê±°ëœ CTN
    const cleanCtn = ctn.replace(/[^0-9]/g, '');

    // íŒë§¤ì¼ë³´ ë°ì´í„° ì¡°íšŒ
    const response = await rateLimitedSheetsCall(() =>
      sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ì§ì˜ì _íŒë§¤ì¼ë³´!A:Z'
      })
    );

    const values = response.data.values || [];
    if (values.length <= 1) {
      return res.status(401).json({
        success: false,
        error: 'ì¼ì¹˜í•˜ëŠ” ê°€ì… ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }

    // í—¤ë” í–‰ ì œì™¸
    const rows = values.slice(1);

    // CTN ê¸°ì¤€ ê²€ìƒ‰ (ê°€ì¥ ìµœê·¼ ë°ì´í„° ìš°ì„ )
    // row[6]ì´ CTN ì»¬ëŸ¼ (Gì—´)
    const recentRows = [...rows].reverse();
    const customerRow = recentRows.find(row => {
      const rowCtn = (row[6] || '').replace(/[^0-9]/g, '');
      return rowCtn === cleanCtn;
    });

    if (!customerRow) {
      return res.status(401).json({
        success: false,
        error: 'ì¼ì¹˜í•˜ëŠ” ê°€ì… ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }

    // ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ (010 ë‹¤ìŒ 4ìë¦¬)
    // 010-1234-5678 -> 1234
    let expectedPassword = '';
    if (cleanCtn.startsWith('010') && cleanCtn.length >= 7) {
      expectedPassword = cleanCtn.substring(3, 7);
    } else if (cleanCtn.length >= 4) {
      // 010ì´ ì•„ë‹Œ ê²½ìš° ì²« 4ìë¦¬ë¥¼ ì‚¬ìš©
      expectedPassword = cleanCtn.substring(0, 4);
    }

    if (password !== expectedPassword) {
      return res.status(401).json({
        success: false,
        error: 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'
      });
    }

    // ë¡œê·¸ì¸ ì„±ê³µ - ìµœê·¼ ê°œí†µ ì •ë³´ ë°˜í™˜
    const customerInfo = {
      id: customerRow[0],       // ë²ˆí˜¸
      posCode: customerRow[1],  // POSì½”ë“œ
      storeName: customerRow[2] || customerRow[1], // ì—…ì²´ëª…
      storeId: customerRow[3],  // ë§¤ì¥ID
      soldAt: customerRow[4],   // íŒë§¤ì¼ì‹œ
      name: customerRow[5],     // ê³ ê°ëª…
      ctn: customerRow[6],      // CTN
      carrier: customerRow[7],  // í†µì‹ ì‚¬
      model: customerRow[8],    // ë‹¨ë§ê¸°ëª¨ë¸ëª…
      status: customerRow[25] || 'ê°œí†µì™„ë£Œ' // ìƒíƒœ
    };

    res.json({
      success: true,
      customer: customerInfo
    });

  } catch (error) {
    console.error('ê³ ê° ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: 'ë¡œê·¸ì¸ ë„ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
    });
  }
});

// GET /api/member/queue/all: ëª¨ë“  ê³ ê° êµ¬ë§¤ ëŒ€ê¸° ëª©ë¡ ì¡°íšŒ (ê´€ë¦¬ììš© ë˜ëŠ” POSì½”ë“œ í•„í„°ë§)
app.get('/api/member/queue/all', async (req, res) => {
  const { posCode } = req.query; // POSì½”ë“œ í•„í„°ë§ (ì§ì˜ì ëª¨ë“œìš©)
  
  try {
    const response = await rateLimitedSheetsCall(() =>
      sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: `${CUSTOMER_QUEUE_SHEET_NAME}!A:AB`
      })
    );

    const values = response.data.values || [];
    if (values.length <= 1) return res.json([]);

    const rows = values.slice(1);
    
    // POSì½”ë“œ í•„í„°ë§ì´ í•„ìš”í•œ ê²½ìš°, í°í´ì¶œê³ ì²˜ë°ì´í„°ì—ì„œ ë§¤ì¥ëª…->POSì½”ë“œ ë§¤í•‘ ìƒì„±
    let storeNameToPosCodeMap = null;
    if (posCode) {
      try {
        const storeDataResponse = await rateLimitedSheetsCall(() =>
          sheets.spreadsheets.values.get({
            spreadsheetId: SPREADSHEET_ID,
            range: 'í°í´ì¶œê³ ì²˜ë°ì´í„°!A:AM'
          })
        );
        const storeData = storeDataResponse.data.values || [];
        storeNameToPosCodeMap = new Map();
        if (storeData && storeData.length > 1) {
          storeData.slice(1).forEach(row => {
            if (row && row.length > 15) {
              const storeName = (row[14] || '').toString().trim(); // 14ë²ˆ ì¸ë±ìŠ¤: ì—…ì²´ëª…
              const storePosCode = (row[15] || '').toString().trim(); // 15ë²ˆ ì¸ë±ìŠ¤: POSì½”ë“œ
              if (storeName && storePosCode) {
                storeNameToPosCodeMap.set(storeName, storePosCode);
              }
            }
          });
        }
      } catch (err) {
        console.error('í°í´ì¶œê³ ì²˜ë°ì´í„° ì¡°íšŒ ì˜¤ë¥˜:', err);
      }
    }
    
    let filteredRows = rows;
    if (posCode && storeNameToPosCodeMap) {
      // ì„ íƒë§¤ì¥ì—…ì²´ëª…(storeName)ìœ¼ë¡œ POSì½”ë“œë¥¼ ì°¾ì•„ì„œ í•„í„°ë§
      filteredRows = rows.filter(row => {
        const storeName = (row[20] || '').toString().trim(); // Uì—´: ì„ íƒë§¤ì¥ì—…ì²´ëª…
        const itemPosCode = storeNameToPosCodeMap.get(storeName);
        return itemPosCode === posCode;
      });
    }
    
    const queue = filteredRows.map(row => ({
      id: row[0],
      ctn: row[1],
      name: row[2],
      carrier: row[3],
      model: row[4],
      color: row[5],
      deviceSerial: row[6],
      usimModel: row[7],
      usimSerial: row[8],
      activationType: row[9],
      oldCarrier: row[10],
      installmentType: row[11],
      installmentMonths: row[12],
      contractType: row[13],
      plan: row[14],
      additionalServices: row[15],
      factoryPrice: row[16],
      carrierSupport: row[17],
      dealerSupportWithAdd: row[18],
      dealerSupportWithoutAdd: row[19],
      storeName: row[20],
      storePhone: row[21],
      storeAddress: row[22],
      storeBankInfo: row[23],
      createdAt: row[24],
      status: row[25],
      processedBy: row[26],
      processedAt: row[27]
    }));

    // ìµœì‹ ìˆœ ì •ë ¬
    queue.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));

    res.json(queue);
  } catch (error) {
    console.error('ì „ì²´ êµ¬ë§¤ ëŒ€ê¸° ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' });
  }
});

// GET /api/member/queue: ê³ ê° êµ¬ë§¤ ëŒ€ê¸° ëª©ë¡ ì¡°íšŒ
app.get('/api/member/queue', async (req, res) => {
  const { ctn } = req.query;
  if (!ctn) return res.status(400).json({ error: 'CTNì´ í•„ìš”í•©ë‹ˆë‹¤.' });

  try {
    // í•˜ì´í”ˆ ì œê±°ëœ CTN
    const cleanCtn = ctn.replace(/[^0-9]/g, '');

    const response = await rateLimitedSheetsCall(() =>
      sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: `${CUSTOMER_QUEUE_SHEET_NAME}!A:AB`
      })
    );

    const values = response.data.values || [];
    if (values.length <= 1) return res.json([]);

    const rows = values.slice(1);
    const queue = rows
      .filter(row => {
        const rowCtn = (row[1] || '').replace(/[^0-9]/g, '');
        return rowCtn === cleanCtn;
      })
      .map(row => ({
        id: row[0],
        ctn: row[1],
        name: row[2],
        carrier: row[3],
        model: row[4],
        color: row[5],
        deviceSerial: row[6],
        usimModel: row[7],
        usimSerial: row[8],
        activationType: row[9],
        oldCarrier: row[10],
        installmentType: row[11],
        installmentMonths: row[12],
        contractType: row[13],
        plan: row[14],
        additionalServices: row[15],
        factoryPrice: row[16],
        carrierSupport: row[17],
        dealerSupportWithAdd: row[18],
        dealerSupportWithoutAdd: row[19],
        storeName: row[20],
        storePhone: row[21],
        storeAddress: row[22],
        storeBankInfo: row[23],
        createdAt: row[24],
        status: row[25],
        processedBy: row[26],
        processedAt: row[27]
      }));

    res.json(queue);
  } catch (error) {
    console.error('êµ¬ë§¤ ëŒ€ê¸° ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' });
  }
});

// POST /api/member/queue: êµ¬ë§¤ ëŒ€ê¸° ë“±ë¡
app.post('/api/member/queue', async (req, res) => {
  const data = req.body;

  try {
    // ì‹œíŠ¸ ì¡´ì¬ ë° í—¤ë” í™•ì¸
    const checkResponse = await rateLimitedSheetsCall(() =>
      sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: `${CUSTOMER_QUEUE_SHEET_NAME}!A1:AB1`
      })
    ).catch(() => null);

    if (!checkResponse || !checkResponse.data.values) {
      await rateLimitedSheetsCall(() =>
        sheets.spreadsheets.values.update({
          spreadsheetId: SPREADSHEET_ID,
          range: `${CUSTOMER_QUEUE_SHEET_NAME}!A1:AB1`,
          valueInputOption: 'RAW',
          resource: { values: [CUSTOMER_QUEUE_HEADERS] }
        })
      );
    }

    const id = `pending-${Date.now()}`;
    const createdAt = new Date().toISOString().replace('T', ' ').substring(0, 19);

    // í—¤ë” ìˆœì„œì— ë§ì¶° ë°ì´í„° ë°°ì—´ ìƒì„±
    const newRow = new Array(28).fill('');
    newRow[0] = id;
    newRow[1] = data.ctn || '';
    newRow[2] = data.name || '';
    newRow[3] = data.carrier || '';
    newRow[4] = data.model || '';
    newRow[5] = data.color || '';
    newRow[6] = data.deviceSerial || '';
    newRow[7] = data.usimModel || '';
    newRow[8] = data.usimSerial || '';
    newRow[9] = data.activationType || '';
    newRow[10] = data.oldCarrier || '';
    newRow[11] = data.installmentType || '';
    newRow[12] = data.installmentMonths || '';
    newRow[13] = data.contractType || '';
    newRow[14] = data.plan || '';
    newRow[15] = data.additionalServices || '';
    newRow[16] = data.factoryPrice || '';
    newRow[17] = data.carrierSupport || '';
    newRow[18] = data.dealerSupportWithAdd || '';
    newRow[19] = data.dealerSupportWithoutAdd || '';
    newRow[20] = data.storeName || '';
    newRow[21] = data.storePhone || '';
    newRow[22] = data.storeAddress || '';
    newRow[23] = data.storeBankInfo || '';
    newRow[24] = createdAt;
    newRow[25] = 'êµ¬ë§¤ëŒ€ê¸°';

    await rateLimitedSheetsCall(() =>
      sheets.spreadsheets.values.append({
        spreadsheetId: SPREADSHEET_ID,
        range: `${CUSTOMER_QUEUE_SHEET_NAME}!A:AB`,
        valueInputOption: 'USER_ENTERED',
        resource: { values: [newRow] }
      })
    );

    res.json({ success: true, id });
  } catch (error) {
    console.error('êµ¬ë§¤ ëŒ€ê¸° ë“±ë¡ ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' });
  }
});

// PUT /api/member/queue/:id: êµ¬ë§¤ ëŒ€ê¸° ìˆ˜ì •
app.put('/api/member/queue/:id', async (req, res) => {
  const { id } = req.params;
  const data = req.body;

  try {
    const response = await rateLimitedSheetsCall(() =>
      sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: `${CUSTOMER_QUEUE_SHEET_NAME}!A:AB`
      })
    );

    const values = response.data.values || [];
    const rowIndex = values.findIndex(row => row[0] === id);

    if (rowIndex === -1) return res.status(404).json({ error: 'ëŒ€ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });

    const updatedRow = [...values[rowIndex]];
    // ë§¤í•‘ëœ í•„ë“œ ì—…ë°ì´íŠ¸
    if (data.name !== undefined) updatedRow[2] = data.name;
    if (data.carrier !== undefined) updatedRow[3] = data.carrier;
    if (data.model !== undefined) updatedRow[4] = data.model;
    if (data.color !== undefined) updatedRow[5] = data.color;
    if (data.deviceSerial !== undefined) updatedRow[6] = data.deviceSerial;
    if (data.usimModel !== undefined) updatedRow[7] = data.usimModel;
    if (data.usimSerial !== undefined) updatedRow[8] = data.usimSerial;
    if (data.activationType !== undefined) updatedRow[9] = data.activationType;
    if (data.oldCarrier !== undefined) updatedRow[10] = data.oldCarrier;
    if (data.installmentType !== undefined) updatedRow[11] = data.installmentType;
    if (data.installmentMonths !== undefined) updatedRow[12] = data.installmentMonths;
    if (data.contractType !== undefined) updatedRow[13] = data.contractType;
    if (data.plan !== undefined) updatedRow[14] = data.plan;
    if (data.additionalServices !== undefined) updatedRow[15] = data.additionalServices;
    if (data.factoryPrice !== undefined) updatedRow[16] = data.factoryPrice;
    if (data.carrierSupport !== undefined) updatedRow[17] = data.carrierSupport;
    if (data.dealerSupportWithAdd !== undefined) updatedRow[18] = data.dealerSupportWithAdd;
    if (data.dealerSupportWithoutAdd !== undefined) updatedRow[19] = data.dealerSupportWithoutAdd;
    if (data.storeName !== undefined) updatedRow[20] = data.storeName;
    if (data.storePhone !== undefined) updatedRow[21] = data.storePhone;
    if (data.storeAddress !== undefined) updatedRow[22] = data.storeAddress;
    if (data.storeBankInfo !== undefined) updatedRow[23] = data.storeBankInfo;
    if (data.status !== undefined) updatedRow[25] = data.status;
    if (data.processedBy !== undefined) updatedRow[26] = data.processedBy;
    if (data.processedAt !== undefined) updatedRow[27] = data.processedAt;

    await rateLimitedSheetsCall(() =>
      sheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: `${CUSTOMER_QUEUE_SHEET_NAME}!A${rowIndex + 1}:AB${rowIndex + 1}`,
        valueInputOption: 'USER_ENTERED',
        resource: { values: [updatedRow] }
      })
    );

    res.json({ success: true });
  } catch (error) {
    console.error('êµ¬ë§¤ ëŒ€ê¸° ìˆ˜ì • ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' });
  }
});

// DELETE /api/member/queue/:id: êµ¬ë§¤ ëŒ€ê¸° ì‚­ì œ
app.delete('/api/member/queue/:id', async (req, res) => {
  const { id } = req.params;

  try {
    const response = await rateLimitedSheetsCall(() =>
      sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: `${CUSTOMER_QUEUE_SHEET_NAME}!A:AB`
      })
    );

    const values = response.data.values || [];
    const rowIndex = values.findIndex(row => row[0] === id);

    if (rowIndex === -1) return res.status(404).json({ error: 'ëŒ€ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });

    // ìƒíƒœë¥¼ 'ì‚­ì œë¨'ìœ¼ë¡œ ë³€ê²½ (Zì—´ = 25ë²ˆ ì¸ë±ìŠ¤ = ìƒíƒœ)
    await rateLimitedSheetsCall(() =>
      sheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: `${CUSTOMER_QUEUE_SHEET_NAME}!Z${rowIndex + 1}`,
        valueInputOption: 'RAW',
        resource: { values: [['ì‚­ì œë¨']] }
      })
    );

    res.json({ success: true });
  } catch (error) {
    console.error('êµ¬ë§¤ ëŒ€ê¸° ì‚­ì œ ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' });
  }
});

// ========== ê²Œì‹œíŒ API ==========

// GET /api/member/board: ê²Œì‹œíŒ ëª©ë¡ ì¡°íšŒ
app.get('/api/member/board', async (req, res) => {
  const { storeName, posCode } = req.query; // ë§¤ì¥ëª… í•„í„°ë§ (ì§ì˜ì ëª¨ë“œìš©)
  
  try {
    // ì‹œíŠ¸ ì¡´ì¬ í™•ì¸ ë° ìƒì„±
    let response;
    try {
      response = await rateLimitedSheetsCall(() =>
        sheets.spreadsheets.values.get({
          spreadsheetId: SPREADSHEET_ID,
          range: `${CUSTOMER_BOARD_SHEET_NAME}!A:L`
        })
      );
    } catch (error) {
      // ì‹œíŠ¸ê°€ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ í—¤ë”ë§Œ ìƒì„±í•˜ê³  ë¹ˆ ë°°ì—´ ë°˜í™˜
      if (error.code === 400 || error.message?.includes('Unable to parse range')) {
        console.log('ê²Œì‹œíŒ ì‹œíŠ¸ê°€ ì¡´ì¬í•˜ì§€ ì•Šì•„ í—¤ë”ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.');
        try {
          await rateLimitedSheetsCall(() =>
            sheets.spreadsheets.values.update({
              spreadsheetId: SPREADSHEET_ID,
              range: `${CUSTOMER_BOARD_SHEET_NAME}!A1:L1`,
              valueInputOption: 'RAW',
              resource: { values: [CUSTOMER_BOARD_HEADERS] }
            })
          );
        } catch (createError) {
          // ì‹œíŠ¸ ìì²´ê°€ ì—†ìœ¼ë©´ ì‹œíŠ¸ ìƒì„± ì‹œë„
          try {
            await rateLimitedSheetsCall(() =>
              sheets.spreadsheets.batchUpdate({
                spreadsheetId: SPREADSHEET_ID,
                resource: {
                  requests: [{
                    addSheet: {
                      properties: {
                        title: CUSTOMER_BOARD_SHEET_NAME,
                        gridProperties: {
                          rowCount: 1000,
                          columnCount: 12
                        }
                      }
                    }
                  }]
                }
              })
            );
            // ì‹œíŠ¸ ìƒì„± í›„ í—¤ë” ì¶”ê°€
            await rateLimitedSheetsCall(() =>
              sheets.spreadsheets.values.update({
                spreadsheetId: SPREADSHEET_ID,
                range: `${CUSTOMER_BOARD_SHEET_NAME}!A1:L1`,
                valueInputOption: 'RAW',
                resource: { values: [CUSTOMER_BOARD_HEADERS] }
              })
            );
          } catch (sheetCreateError) {
            console.error('ê²Œì‹œíŒ ì‹œíŠ¸ ìƒì„± ì˜¤ë¥˜:', sheetCreateError);
            // ì‹œíŠ¸ ìƒì„± ì‹¤íŒ¨í•´ë„ ë¹ˆ ë°°ì—´ ë°˜í™˜
          }
        }
        return res.json([]);
      }
      throw error;
    }

    const values = response.data.values || [];
    if (values.length <= 1) return res.json([]);

    const rows = values.slice(1);
    
    // POSì½”ë“œ í•„í„°ë§ì´ í•„ìš”í•œ ê²½ìš°, í°í´ì¶œê³ ì²˜ë°ì´í„°ì—ì„œ ë§¤ì¥ëª…->POSì½”ë“œ ë§¤í•‘ ìƒì„±
    let storeNameToPosCodeMap = null;
    if (posCode) {
      try {
        const storeDataResponse = await rateLimitedSheetsCall(() =>
          sheets.spreadsheets.values.get({
            spreadsheetId: SPREADSHEET_ID,
            range: 'í°í´ì¶œê³ ì²˜ë°ì´í„°!A:AM'
          })
        );
        const storeData = storeDataResponse.data.values || [];
        storeNameToPosCodeMap = new Map();
        if (storeData && storeData.length > 1) {
          storeData.slice(1).forEach(row => {
            if (row && row.length > 15) {
              const storeNameFromData = (row[14] || '').toString().trim(); // 14ë²ˆ ì¸ë±ìŠ¤: ì—…ì²´ëª…
              const storePosCode = (row[15] || '').toString().trim(); // 15ë²ˆ ì¸ë±ìŠ¤: POSì½”ë“œ
              if (storeNameFromData && storePosCode) {
                storeNameToPosCodeMap.set(storeNameFromData, storePosCode);
              }
            }
          });
        }
      } catch (err) {
        console.error('ë§¤ì¥ ë°ì´í„° ì¡°íšŒ ì˜¤ë¥˜:', err);
      }
    }

    let queue = rows
      .filter(row => {
        // ì‚­ì œëœ í•­ëª© ì œì™¸
        const status = (row[11] || '').toString().trim();
        if (status === 'ì‚­ì œë¨') return false;
        
        // ë§¤ì¥ëª… í•„í„°ë§
        if (storeName) {
          const rowStoreName = (row[6] || '').toString().trim();
          return rowStoreName === storeName;
        }
        
        // POSì½”ë“œ í•„í„°ë§
        if (posCode && storeNameToPosCodeMap) {
          const rowStoreName = (row[6] || '').toString().trim();
          const itemPosCode = storeNameToPosCodeMap.get(rowStoreName);
          return itemPosCode === posCode;
        }
        
        return true;
      })
      .map(row => ({
        id: row[0],
        category: row[1] || '',
        title: row[2] || '',
        content: row[3] || '',
        customerName: row[4] || '',
        customerCtn: row[5] || '',
        storeName: row[6] || '',
        storePhone: row[7] || '',
        storeAddress: row[8] || '',
        createdAt: row[9] || '',
        updatedAt: row[10] || '',
        status: row[11] || 'í™œì„±'
      }));

    // ìµœì‹ ìˆœ ì •ë ¬
    queue.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));

    res.json(queue);
  } catch (error) {
    console.error('ê²Œì‹œíŒ ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' });
  }
});

// GET /api/member/board/:id: ê²Œì‹œíŒ ìƒì„¸ ì¡°íšŒ
app.get('/api/member/board/:id', async (req, res) => {
  const { id } = req.params;
  
  try {
    let response;
    try {
      response = await rateLimitedSheetsCall(() =>
        sheets.spreadsheets.values.get({
          spreadsheetId: SPREADSHEET_ID,
          range: `${CUSTOMER_BOARD_SHEET_NAME}!A:L`
        })
      );
    } catch (error) {
      // ì‹œíŠ¸ê°€ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ 404 ë°˜í™˜
      if (error.code === 400 || error.message?.includes('Unable to parse range')) {
        return res.status(404).json({ error: 'ê²Œì‹œê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
      }
      throw error;
    }

    const values = response.data.values || [];
    const row = values.find(r => r[0] === id);
    
    if (!row) {
      return res.status(404).json({ error: 'ê²Œì‹œê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
    }

    const post = {
      id: row[0],
      category: row[1] || '',
      title: row[2] || '',
      content: row[3] || '',
      customerName: row[4] || '',
      customerCtn: row[5] || '',
      storeName: row[6] || '',
      storePhone: row[7] || '',
      storeAddress: row[8] || '',
      createdAt: row[9] || '',
      updatedAt: row[10] || '',
      status: row[11] || 'í™œì„±'
    };

    res.json(post);
  } catch (error) {
    console.error('ê²Œì‹œíŒ ìƒì„¸ ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' });
  }
});

// POST /api/member/board: ê²Œì‹œíŒ ê¸€ ì‘ì„±
app.post('/api/member/board', async (req, res) => {
  const data = req.body;

  try {
    // ì‹œíŠ¸ ì¡´ì¬ ë° í—¤ë” í™•ì¸
    let checkResponse;
    try {
      checkResponse = await rateLimitedSheetsCall(() =>
        sheets.spreadsheets.values.get({
          spreadsheetId: SPREADSHEET_ID,
          range: `${CUSTOMER_BOARD_SHEET_NAME}!A1:L1`
        })
      );
    } catch (error) {
      // ì‹œíŠ¸ê°€ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ì‹œíŠ¸ ìƒì„±
      if (error.code === 400 || error.message?.includes('Unable to parse range')) {
        console.log('ê²Œì‹œíŒ ì‹œíŠ¸ê°€ ì¡´ì¬í•˜ì§€ ì•Šì•„ ìƒˆë¡œ ìƒì„±í•©ë‹ˆë‹¤.');
        try {
          await rateLimitedSheetsCall(() =>
            sheets.spreadsheets.batchUpdate({
              spreadsheetId: SPREADSHEET_ID,
              resource: {
                requests: [{
                  addSheet: {
                    properties: {
                      title: CUSTOMER_BOARD_SHEET_NAME,
                      gridProperties: {
                        rowCount: 1000,
                        columnCount: 12
                      }
                    }
                  }
                }]
              }
            })
          );
        } catch (sheetCreateError) {
          // ì‹œíŠ¸ê°€ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê²½ìš° ë¬´ì‹œ
          if (!sheetCreateError.message?.includes('already exists')) {
            console.error('ê²Œì‹œíŒ ì‹œíŠ¸ ìƒì„± ì˜¤ë¥˜:', sheetCreateError);
            throw sheetCreateError;
          }
        }
      } else {
        throw error;
      }
    }

    // í—¤ë”ê°€ ì—†ìœ¼ë©´ í—¤ë” ì¶”ê°€
    if (!checkResponse || !checkResponse.data.values) {
      try {
        await rateLimitedSheetsCall(() =>
          sheets.spreadsheets.values.update({
            spreadsheetId: SPREADSHEET_ID,
            range: `${CUSTOMER_BOARD_SHEET_NAME}!A1:L1`,
            valueInputOption: 'RAW',
            resource: { values: [CUSTOMER_BOARD_HEADERS] }
          })
        );
      } catch (headerError) {
        console.error('ê²Œì‹œíŒ í—¤ë” ìƒì„± ì˜¤ë¥˜:', headerError);
        // í—¤ë” ìƒì„± ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰ (ì´ë¯¸ ì¡´ì¬í•  ìˆ˜ ìˆìŒ)
      }
    }

    const id = `board-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    const createdAt = new Date().toISOString().replace('T', ' ').substring(0, 19);
    const updatedAt = createdAt;

    // í—¤ë” ìˆœì„œì— ë§ì¶° ë°ì´í„° ë°°ì—´ ìƒì„±
    const newRow = [
      id,
      data.category || 'ì‚¬ìš©í›„ê¸°',
      data.title || '',
      data.content || '',
      data.customerName || '',
      data.customerCtn || '',
      data.storeName || '',
      data.storePhone || '',
      data.storeAddress || '',
      createdAt,
      updatedAt,
      'í™œì„±'
    ];

    await rateLimitedSheetsCall(() =>
      sheets.spreadsheets.values.append({
        spreadsheetId: SPREADSHEET_ID,
        range: `${CUSTOMER_BOARD_SHEET_NAME}!A:L`,
        valueInputOption: 'RAW',
        resource: { values: [newRow] }
      })
    );

    res.json({ success: true, id });
  } catch (error) {
    console.error('ê²Œì‹œíŒ ê¸€ ì‘ì„± ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' });
  }
});

// PUT /api/member/board/:id: ê²Œì‹œíŒ ê¸€ ìˆ˜ì •
app.put('/api/member/board/:id', async (req, res) => {
  const { id } = req.params;
  const data = req.body;

  try {
    let response;
    try {
      response = await rateLimitedSheetsCall(() =>
        sheets.spreadsheets.values.get({
          spreadsheetId: SPREADSHEET_ID,
          range: `${CUSTOMER_BOARD_SHEET_NAME}!A:L`
        })
      );
    } catch (error) {
      // ì‹œíŠ¸ê°€ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ 404 ë°˜í™˜
      if (error.code === 400 || error.message?.includes('Unable to parse range')) {
        return res.status(404).json({ error: 'ê²Œì‹œê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
      }
      throw error;
    }

    const values = response.data.values || [];
    const rowIndex = values.findIndex(row => row[0] === id);

    if (rowIndex === -1) return res.status(404).json({ error: 'ê²Œì‹œê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });

    const updatedRow = [...values[rowIndex]];
    const updatedAt = new Date().toISOString().replace('T', ' ').substring(0, 19);
    
    // ë§¤í•‘ëœ í•„ë“œ ì—…ë°ì´íŠ¸
    if (data.category !== undefined) updatedRow[1] = data.category;
    if (data.title !== undefined) updatedRow[2] = data.title;
    if (data.content !== undefined) updatedRow[3] = data.content;
    if (data.storeName !== undefined) updatedRow[6] = data.storeName;
    if (data.storePhone !== undefined) updatedRow[7] = data.storePhone;
    if (data.storeAddress !== undefined) updatedRow[8] = data.storeAddress;
    updatedRow[10] = updatedAt; // ìˆ˜ì •ì¼ì‹œ

    await rateLimitedSheetsCall(() =>
      sheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: `${CUSTOMER_BOARD_SHEET_NAME}!A${rowIndex + 1}:L${rowIndex + 1}`,
        valueInputOption: 'RAW',
        resource: { values: [updatedRow] }
      })
    );

    res.json({ success: true });
  } catch (error) {
    console.error('ê²Œì‹œíŒ ê¸€ ìˆ˜ì • ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'ê¸€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' });
  }
});

// DELETE /api/member/board/:id: ê²Œì‹œíŒ ê¸€ ì‚­ì œ
app.delete('/api/member/board/:id', async (req, res) => {
  const { id } = req.params;

  try {
    let response;
    try {
      response = await rateLimitedSheetsCall(() =>
        sheets.spreadsheets.values.get({
          spreadsheetId: SPREADSHEET_ID,
          range: `${CUSTOMER_BOARD_SHEET_NAME}!A:L`
        })
      );
    } catch (error) {
      // ì‹œíŠ¸ê°€ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ 404 ë°˜í™˜
      if (error.code === 400 || error.message?.includes('Unable to parse range')) {
        return res.status(404).json({ error: 'ê²Œì‹œê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
      }
      throw error;
    }

    const values = response.data.values || [];
    const rowIndex = values.findIndex(row => row[0] === id);

    if (rowIndex === -1) return res.status(404).json({ error: 'ê²Œì‹œê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });

    // ìƒíƒœë¥¼ 'ì‚­ì œë¨'ìœ¼ë¡œ ë³€ê²½ (Lì—´ = 11ë²ˆ ì¸ë±ìŠ¤ = ìƒíƒœ)
    await rateLimitedSheetsCall(() =>
      sheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: `${CUSTOMER_BOARD_SHEET_NAME}!L${rowIndex + 1}`,
        valueInputOption: 'RAW',
        resource: { values: [['ì‚­ì œë¨']] }
      })
    );

    res.json({ success: true });
  } catch (error) {
    console.error('ê²Œì‹œíŒ ê¸€ ì‚­ì œ ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'ê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' });
  }
});

// ì¤‘ë³µ ì œê±°ë¨ - ìœ„ì˜ getAllQueue API ì‚¬ìš©

// GET /api/direct/drive-monitoring: Google Drive API ëª¨ë‹ˆí„°ë§ ë°ì´í„° ì¡°íšŒ
app.get('/api/direct/drive-monitoring', async (req, res) => {
  try {
    const days = parseInt(req.query.days) || 7; // ê¸°ë³¸ 7ì¼
    const data = getDriveMonitoringData(days);
    
    res.json({
      success: true,
      data: data
    });
  } catch (error) {
    console.error('âŒ [ëª¨ë‹ˆí„°ë§] ë°ì´í„° ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: 'ëª¨ë‹ˆí„°ë§ ë°ì´í„° ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message
    });
  }
});

// GET /api/direct/pre-approval-mark/:storeName: ì‚¬ì „ìŠ¹ë‚™ì„œë§ˆí¬ ì¡°íšŒ
app.get('/api/direct/pre-approval-mark/:storeName', async (req, res) => {
  const { storeName } = req.params;
  try {
    const values = await getSheetValues(CUSTOMER_PRE_APPROVAL_SHEET_NAME);
    if (!values || values.length <= 1) return res.json({ url: '' });

    const rows = values.slice(1);
    const mark = rows.find(row => row[0] === storeName);
    res.json({ url: mark ? mark[1] : '' });
  } catch (error) {
    console.error('ì‚¬ì „ìŠ¹ë‚™ì„œë§ˆí¬ ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' });
  }
});

// POST /api/direct/pre-approval-mark: ì‚¬ì „ìŠ¹ë‚™ì„œë§ˆí¬ ì €ì¥
app.post('/api/direct/pre-approval-mark', async (req, res) => {
  const { storeName, url } = req.body;
  try {
    const values = await getSheetValues(CUSTOMER_PRE_APPROVAL_SHEET_NAME);
    const updatedAt = new Date().toISOString().replace('T', ' ').substring(0, 19);

    if (!values || values.length === 0) {
      await rateLimitedSheetsCall(() =>
        sheets.spreadsheets.values.update({
          spreadsheetId: SPREADSHEET_ID,
          range: `${CUSTOMER_PRE_APPROVAL_SHEET_NAME}!A1:C1`,
          valueInputOption: 'RAW',
          resource: { values: [['ì—…ì²´ëª…', 'ì‚¬ì „ìŠ¹ë‚™ì„œë§ˆí¬URL', 'ìˆ˜ì •ì¼ì‹œ']] }
        })
      );
    }

    const rowIndex = values ? values.findIndex(row => row[0] === storeName) : -1;

    if (rowIndex === -1) {
      await rateLimitedSheetsCall(() =>
        sheets.spreadsheets.values.append({
          spreadsheetId: SPREADSHEET_ID,
          range: `${CUSTOMER_PRE_APPROVAL_SHEET_NAME}!A:C`,
          valueInputOption: 'USER_ENTERED',
          resource: { values: [[storeName, url, updatedAt]] }
        })
      );
    } else {
      await rateLimitedSheetsCall(() =>
        sheets.spreadsheets.values.update({
          spreadsheetId: SPREADSHEET_ID,
          range: `${CUSTOMER_PRE_APPROVAL_SHEET_NAME}!A${rowIndex + 1}:C${rowIndex + 1}`,
          valueInputOption: 'USER_ENTERED',
          resource: { values: [[storeName, url, updatedAt]] }
        })
      );
    }

    res.json({ success: true });
  } catch (error) {
    console.error('ì‚¬ì „ìŠ¹ë‚™ì„œë§ˆí¬ ì €ì¥ ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' });
  }
});

// GET /api/direct/store-image/:storeName: ë§¤ì¥ ì‚¬ì§„ ì¡°íšŒ
app.get('/api/direct/store-image/:storeName', async (req, res) => {
  const { storeName } = req.params;
  try {
    const values = await getSheetValues(CUSTOMER_STORE_PHOTO_SHEET_NAME);
    if (!values || values.length <= 1) return res.json(null);

    const rows = values.slice(1);
    const photoRow = rows.find(row => row[0] === storeName);

    if (!photoRow) return res.json(null);

    // ìƒˆë¡œìš´ ì»¬ëŸ¼ êµ¬ì¡°ì— ë§ê²Œ ì¸ë±ìŠ¤ ìˆ˜ì •
    // ê° URLë§ˆë‹¤ Discord ì •ë³´ ì»¬ëŸ¼ì´ ì¶”ê°€ë˜ì–´ ì¸ë±ìŠ¤ê°€ ë³€ê²½ë¨
    res.json({
      storeName: photoRow[0],           // 0: ì—…ì²´ëª…
      frontUrl: photoRow[1] || '',      // 1: ì „ë©´ì‚¬ì§„URL
      insideUrl: photoRow[5] || '',     // 5: ë‚´ë¶€ì‚¬ì§„URL
      outsideUrl: photoRow[9] || '',    // 9: ì™¸ë¶€ì‚¬ì§„URL
      outside2Url: photoRow[13] || '',  // 13: ì™¸ë¶€2ì‚¬ì§„URL
      managerUrl: photoRow[17] || '',   // 17: ì ì¥ì‚¬ì§„URL
      staff1Url: photoRow[21] || '',    // 21: ì§ì›1ì‚¬ì§„URL
      staff2Url: photoRow[25] || '',    // 25: ì§ì›2ì‚¬ì§„URL
      staff3Url: photoRow[29] || '',    // 29: ì§ì›3ì‚¬ì§„URL
      updatedAt: photoRow[33] || ''     // 33: ìˆ˜ì •ì¼ì‹œ
    });
  } catch (error) {
    console.error('ë§¤ì¥ ì‚¬ì§„ ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' });
  }
});

// POST /api/direct/store-image: ë§¤ì¥ ì‚¬ì§„ ì •ë³´ ì €ì¥
app.post('/api/direct/store-image', async (req, res) => {
  const data = req.body;
  const storeName = data.storeName;
  try {
    const values = await getSheetValues(CUSTOMER_STORE_PHOTO_SHEET_NAME);
    const updatedAt = new Date().toISOString().replace('T', ' ').substring(0, 19);

    // í—¤ë” í™•ì¸ ë° ìƒì„±
    const { ensureSheetHeaders } = require('./directRoutes');
    await ensureSheetHeaders(sheets, SPREADSHEET_ID, CUSTOMER_STORE_PHOTO_SHEET_NAME, HEADERS_STORE_PHOTO);

    const rowIndex = values ? values.findIndex(row => row[0] === storeName) : -1;
    
    // ê¸°ì¡´ í–‰ì´ ìˆìœ¼ë©´ ê¸°ì¡´ Discord ì •ë³´ ë³´ì¡´
    const existingRow = rowIndex !== -1 && values ? values[rowIndex] : null;
    
    // ê° URLì— ëŒ€ì‘í•˜ëŠ” Discord ì •ë³´ ë§¤í•‘ í•¨ìˆ˜
    const getDiscordInfo = (urlType, url) => {
      if (!url) return ['', '', '']; // URLì´ ì—†ìœ¼ë©´ Discord ì •ë³´ë„ ì—†ìŒ
      
      // ê¸°ì¡´ í–‰ì—ì„œ í•´ë‹¹ URL íƒ€ì…ì˜ Discord ì •ë³´ ì°¾ê¸°
      if (existingRow) {
        const urlIndexMap = {
          front: { url: 1, msgId: 2, postId: 3, threadId: 4 },
          inside: { url: 5, msgId: 6, postId: 7, threadId: 8 },
          outside: { url: 9, msgId: 10, postId: 11, threadId: 12 },
          outside2: { url: 13, msgId: 14, postId: 15, threadId: 16 },
          manager: { url: 17, msgId: 18, postId: 19, threadId: 20 },
          staff1: { url: 21, msgId: 22, postId: 23, threadId: 24 },
          staff2: { url: 25, msgId: 26, postId: 27, threadId: 28 },
          staff3: { url: 29, msgId: 30, postId: 31, threadId: 32 }
        };
        
        const map = urlIndexMap[urlType];
        if (map && existingRow[map.url] === url) {
          // ê¸°ì¡´ URLê³¼ ë™ì¼í•˜ë©´ Discord ì •ë³´ ë³´ì¡´
          return [
            existingRow[map.msgId] || '',
            existingRow[map.postId] || '',
            existingRow[map.threadId] || ''
          ];
        }
      }
      
      // ìƒˆ URLì´ê±°ë‚˜ ê¸°ì¡´ URLê³¼ ë‹¤ë¥´ë©´ Discord ì •ë³´ ì—†ìŒ (ë‚˜ì¤‘ì— ì—…ë¡œë“œ ì‹œ ì±„ì›Œì§)
      return ['', '', ''];
    };
    
    // ê¸°ì¡´ í–‰ì—ì„œ ëŒ€ì¤‘êµí†µ ì •ë³´ ë³´ì¡´ (ìˆëŠ” ê²½ìš°)
    const existingBusTerminals = existingRow && existingRow[34] ? existingRow[34] : '';
    const existingSubwayStations = existingRow && existingRow[35] ? existingRow[35] : '';
    
    const newRow = [
      storeName,  // 0: ì—…ì²´ëª…
      data.frontUrl || '',  // 1: ì „ë©´ì‚¬ì§„URL
      ...getDiscordInfo('front', data.frontUrl),  // 2-4: ì „ë©´ì‚¬ì§„Discordì •ë³´
      data.insideUrl || '',  // 5: ë‚´ë¶€ì‚¬ì§„URL
      ...getDiscordInfo('inside', data.insideUrl),  // 6-8: ë‚´ë¶€ì‚¬ì§„Discordì •ë³´
      data.outsideUrl || '',  // 9: ì™¸ë¶€ì‚¬ì§„URL
      ...getDiscordInfo('outside', data.outsideUrl),  // 10-12: ì™¸ë¶€ì‚¬ì§„Discordì •ë³´
      data.outside2Url || '',  // 13: ì™¸ë¶€2ì‚¬ì§„URL
      ...getDiscordInfo('outside2', data.outside2Url),  // 14-16: ì™¸ë¶€2ì‚¬ì§„Discordì •ë³´
      data.managerUrl || '',  // 17: ì ì¥ì‚¬ì§„URL
      ...getDiscordInfo('manager', data.managerUrl),  // 18-20: ì ì¥ì‚¬ì§„Discordì •ë³´
      data.staff1Url || '',  // 21: ì§ì›1ì‚¬ì§„URL
      ...getDiscordInfo('staff1', data.staff1Url),  // 22-24: ì§ì›1ì‚¬ì§„Discordì •ë³´
      data.staff2Url || '',  // 25: ì§ì›2ì‚¬ì§„URL
      ...getDiscordInfo('staff2', data.staff2Url),  // 26-28: ì§ì›2ì‚¬ì§„Discordì •ë³´
      data.staff3Url || '',  // 29: ì§ì›3ì‚¬ì§„URL
      ...getDiscordInfo('staff3', data.staff3Url),  // 30-32: ì§ì›3ì‚¬ì§„Discordì •ë³´
      updatedAt,  // 33: ìˆ˜ì •ì¼ì‹œ
      existingBusTerminals,  // 34: ë²„ìŠ¤í„°ë¯¸ë„ì •ë³´ (ê¸°ì¡´ ê°’ ë³´ì¡´)
      existingSubwayStations  // 35: ì§€í•˜ì² ì—­ì •ë³´ (ê¸°ì¡´ ê°’ ë³´ì¡´)
    ];

    if (rowIndex === -1) {
      await rateLimitedSheetsCall(() =>
        sheets.spreadsheets.values.append({
          spreadsheetId: SPREADSHEET_ID,
          range: `${CUSTOMER_STORE_PHOTO_SHEET_NAME}!A:AJ`,
          valueInputOption: 'USER_ENTERED',
          insertDataOption: 'INSERT_ROWS',
          resource: { values: [newRow] }
        })
      );
    } else {
      await rateLimitedSheetsCall(() =>
        sheets.spreadsheets.values.update({
          spreadsheetId: SPREADSHEET_ID,
          range: `${CUSTOMER_STORE_PHOTO_SHEET_NAME}!A${rowIndex + 1}:AJ${rowIndex + 1}`,
          valueInputOption: 'USER_ENTERED',
          resource: { values: [newRow] }
        })
      );
    }

    res.json({ success: true });
  } catch (error) {
    console.error('ë§¤ì¥ ì‚¬ì§„ ì €ì¥ ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' });
  }
});

// ë§¤ì¥ ì‚¬ì§„ íŒŒì¼ ì—…ë¡œë“œë¥¼ ìœ„í•œ multer ì„¤ì • (ë””ìŠ¤í¬ ì €ì¥)
const storeImageUpload = multer({
  storage: multer.diskStorage({
    destination: (req, file, cb) => {
      const uploadDir = path.join(__dirname, 'public', 'uploads', 'store-images');
      // ë””ë ‰í† ë¦¬ê°€ ì—†ìœ¼ë©´ ìƒì„±
      if (!fs.existsSync(uploadDir)) {
        fs.mkdirSync(uploadDir, { recursive: true });
      }
      cb(null, uploadDir);
    },
    filename: (req, file, cb) => {
      const storeName = req.body.storeName || 'unknown';
      const photoType = req.body.photoType || 'unknown'; // front, inside, outside, outside2, manager, staff1, staff2, staff3
      const timestamp = Date.now();
      const ext = path.extname(file.originalname);
      const safeStoreName = storeName.replace(/[^a-zA-Z0-9ê°€-í£]/g, '_');
      const filename = `${safeStoreName}_${photoType}_${timestamp}${ext}`;
      cb(null, filename);
    }
  }),
  limits: { fileSize: 10 * 1024 * 1024 }, // 10MB ì œí•œ
  fileFilter: (req, file, cb) => {
    // ì´ë¯¸ì§€ íŒŒì¼ë§Œ í—ˆìš©
    if (file.mimetype.startsWith('image/')) {
      cb(null, true);
    } else {
      cb(new Error('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.'), false);
    }
  }
});

// Google Sheets íŒŒì¼ì˜ ë¶€ëª¨ í´ë” ID ê°€ì ¸ì˜¤ê¸°
async function getSpreadsheetParentFolder() {
  try {
    const sheetFile = await monitoredDriveCall('files.get', {
      fileId: SPREADSHEET_ID,
      fields: 'parents, driveId',
      supportsAllDrives: true
    });
    
    // Google Sheets íŒŒì¼ì€ í•­ìƒ í•˜ë‚˜ì˜ ë¶€ëª¨ í´ë”ë¥¼ ê°€ì§
    if (sheetFile.data.parents && sheetFile.data.parents.length > 0) {
      return {
        folderId: sheetFile.data.parents[0],
        driveId: sheetFile.data.driveId || null
      };
    }
    return null;
  } catch (error) {
    console.error('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ë¶€ëª¨ í´ë” ì¡°íšŒ ì˜¤ë¥˜:', error);
    return null;
  }
}

// Google Drive í´ë” ìƒì„± ë˜ëŠ” ì¡°íšŒ í—¬í¼ í•¨ìˆ˜
async function getOrCreateFolder(folderName, parentFolderId = null, driveId = null) {
  try {
    // "ì–´í”Œìë£Œ" í´ë”ì¸ ê²½ìš° í™˜ê²½ë³€ìˆ˜ë¡œ ì§€ì •ëœ í´ë” ID ì§ì ‘ ì‚¬ìš©
    if (!parentFolderId && folderName === 'ì–´í”Œìë£Œ' && APP_DATA_FOLDER_ID) {
      try {
        // í´ë” ì¡´ì¬ í™•ì¸
        const folderInfo = await monitoredDriveCall('files.get', {
          fileId: APP_DATA_FOLDER_ID,
          fields: 'id, name, driveId',
          supportsAllDrives: true
        });
        
        const folderDriveId = folderInfo.data.driveId || null;
        
        // Shared Driveê°€ ì•„ë‹Œ ê²½ìš° ê²½ê³ 
        if (!folderDriveId) {
          console.warn(`âš ï¸ [í´ë” í™•ì¸] "ì–´í”Œìë£Œ" í´ë”ê°€ ê°œì¸ ë“œë¼ì´ë¸Œì— ìˆìŠµë‹ˆë‹¤. Shared Driveì— ìˆì–´ì•¼ Service Accountê°€ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
          console.warn(`âš ï¸ [í´ë” í™•ì¸] í´ë” ID: ${APP_DATA_FOLDER_ID}, Drive ID: null (ê°œì¸ ë“œë¼ì´ë¸Œ)`);
          console.warn(`âš ï¸ [í´ë” í™•ì¸] í•´ê²° ë°©ë²•: ì´ í´ë”ë¥¼ Shared Driveë¡œ ì´ë™í•˜ê±°ë‚˜, Shared Driveì— ìƒˆ í´ë”ë¥¼ ë§Œë“¤ì–´ ê³µìœ í•˜ì„¸ìš”.`);
        } else {
          console.log(`âœ… [í´ë” í™•ì¸] "ì–´í”Œìë£Œ" í´ë” ì§ì ‘ ì‚¬ìš©: ${APP_DATA_FOLDER_ID}, Drive ID: ${folderDriveId} (Shared Drive)`);
        }
        
        return {
          folderId: folderInfo.data.id,
          driveId: folderDriveId
        };
      } catch (error) {
        console.error(`âŒ [í´ë” í™•ì¸] ì§€ì •ëœ "ì–´í”Œìë£Œ" í´ë” ì ‘ê·¼ ì‹¤íŒ¨:`, error.message);
        console.error(`âŒ [í´ë” í™•ì¸] í´ë” ID: ${APP_DATA_FOLDER_ID}`);
        console.error(`âŒ [í´ë” í™•ì¸] ì—ëŸ¬ ì½”ë“œ: ${error.code || 'N/A'}`);
        
        if (error.code === 404) {
          console.error(`âŒ [í´ë” í™•ì¸] 404 ì—ëŸ¬ - í´ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
          console.error(`âŒ [í´ë” í™•ì¸] í™•ì¸ ì‚¬í•­:`);
          console.error(`   1. í´ë” IDê°€ ì •í™•í•œì§€ í™•ì¸ (URLì—ì„œ /folders/ ë’¤ì˜ ê°’)`);
          console.error(`   2. Service Account(${GOOGLE_SERVICE_ACCOUNT_EMAIL})ê°€ í´ë”ì— ê³µìœ ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸`);
          console.error(`   3. ê³µìœ  ê¶Œí•œ: "í¸ì§‘ì" ë˜ëŠ” "ë·°ì–´" ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤`);
          console.error(`   4. í´ë”ê°€ ì‚­ì œë˜ì§€ ì•Šì•˜ëŠ”ì§€ í™•ì¸`);
          console.error(`âŒ [í´ë” í™•ì¸] ì¤‘ìš”: ê³µìœ  í´ë”ë¼ë„ Service Accountê°€ ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ê³µìœ ë˜ì–´ì•¼ í•©ë‹ˆë‹¤!`);
        } else if (error.code === 403) {
          console.error(`âŒ [í´ë” í™•ì¸] 403 ì—ëŸ¬ - ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.`);
          console.error(`âŒ [í´ë” í™•ì¸] Service Account(${GOOGLE_SERVICE_ACCOUNT_EMAIL})ë¥¼ í´ë”ì— ê³µìœ í•´ì£¼ì„¸ìš”.`);
        }
        
        console.warn(`âš ï¸ [í´ë” í™•ì¸] ê²€ìƒ‰ìœ¼ë¡œ ëŒ€ì²´ ì‹œë„...`);
        // í´ë” ì ‘ê·¼ ì‹¤íŒ¨ ì‹œ ê¸°ì¡´ ë¡œì§ìœ¼ë¡œ í´ë” ê²€ìƒ‰
      }
    }
    
    // root í´ë”ì¸ ê²½ìš° Google Sheetsì™€ ê°™ì€ í´ë” ì‚¬ìš©
    // ë‹¨, "ì–´í”Œìë£Œ" í´ë”ëŠ” ì´ë¯¸ ìœ„ì—ì„œ ì²˜ë¦¬í–ˆìœ¼ë¯€ë¡œ ìŠ¤í‚µ
    if (!parentFolderId && folderName !== 'ì–´í”Œìë£Œ') {
      const spreadsheetParent = await getSpreadsheetParentFolder();
      if (spreadsheetParent) {
        parentFolderId = spreadsheetParent.folderId;
        driveId = spreadsheetParent.driveId || driveId;
      }
    }

    // ê¸°ì¡´ í´ë” ê²€ìƒ‰
    let query = `name='${folderName}' and mimeType='application/vnd.google-apps.folder' and trashed=false`;
    if (parentFolderId) {
      query += ` and '${parentFolderId}' in parents`;
    } else {
      query += ` and 'root' in parents`;
    }

    const searchResponse = await monitoredDriveCall('files.list', {
      q: query,
      fields: 'files(id, name, driveId)',
      corpora: parentFolderId ? 'allDrives' : 'user',
      includeItemsFromAllDrives: true,
      supportsAllDrives: true
    });

    if (searchResponse.data.files && searchResponse.data.files.length > 0) {
      const foundFolder = searchResponse.data.files[0];
      const foundDriveId = foundFolder.driveId || null;
      
      // "ì–´í”Œìë£Œ" í´ë”ì¸ ê²½ìš° Shared Drive í™•ì¸
      if (folderName === 'ì–´í”Œìë£Œ' && !foundDriveId) {
        console.warn(`âš ï¸ [í´ë” í™•ì¸] ê²€ìƒ‰ìœ¼ë¡œ ì°¾ì€ "ì–´í”Œìë£Œ" í´ë”ê°€ ê°œì¸ ë“œë¼ì´ë¸Œì— ìˆìŠµë‹ˆë‹¤.`);
        console.warn(`âš ï¸ [í´ë” í™•ì¸] í´ë” ID: ${foundFolder.id}, Drive ID: null (ê°œì¸ ë“œë¼ì´ë¸Œ)`);
        console.warn(`âš ï¸ [í´ë” í™•ì¸] Service AccountëŠ” ê°œì¸ ë“œë¼ì´ë¸Œì— ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
        console.warn(`âš ï¸ [í´ë” í™•ì¸] í•´ê²° ë°©ë²•:`);
        console.warn(`   1. ì´ í´ë”ë¥¼ Shared Driveë¡œ ì´ë™`);
        console.warn(`   2. ë˜ëŠ” Shared Driveì— ìƒˆ "ì–´í”Œìë£Œ" í´ë”ë¥¼ ë§Œë“¤ê³  Service Accountì™€ ê³µìœ `);
        console.warn(`   3. Service Account ì´ë©”ì¼: ${GOOGLE_SERVICE_ACCOUNT_EMAIL}`);
      }
      
      return {
        folderId: foundFolder.id,
        driveId: foundDriveId
      };
    }

    // í´ë” ìƒì„±
    const folderMetadata = {
      name: folderName,
      mimeType: 'application/vnd.google-apps.folder'
    };

    if (parentFolderId) {
      folderMetadata.parents = [parentFolderId];
    }

    const createParams = {
      requestBody: folderMetadata,
      fields: 'id, name',
      supportsAllDrives: true
    };
    
    // Shared Driveì— ìˆëŠ” ê²½ìš° driveId ì§€ì •
    if (driveId) {
      createParams.requestBody.driveId = driveId;
    }
    
    const folderResponse = await monitoredDriveCall('files.create', createParams);

    // í´ë”ë¥¼ ê³µê°œë¡œ ì„¤ì • (ì„ íƒì‚¬í•­ - í•„ìš”ì‹œ ì£¼ì„ í•´ì œ)
    // await drive.permissions.create({
    //   fileId: folderResponse.data.id,
    //   requestBody: {
    //     role: 'reader',
    //     type: 'anyone'
    //   }
    // });

    const createdFolderId = folderResponse.data.id;
    return { folderId: createdFolderId, driveId: driveId || null };
  } catch (error) {
    console.error(`í´ë” ìƒì„±/ì¡°íšŒ ì˜¤ë¥˜ (${folderName}):`, error);
    throw error;
  }
}

// ë§¤ì¥ ì‚¬ì§„ìš© Discord ì—…ë¡œë“œ í•¨ìˆ˜
async function uploadStorePhotoToDiscord(imageBuffer, filename, storeName, photoType) {
  if (!DISCORD_LOGGING_ENABLED || !discordBot) {
    throw new Error('Discord ë´‡ì´ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
  }

  // ë´‡ì´ ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸°
  if (!discordBot.isReady()) {
    for (let i = 0; i < 10; i++) {
      if (discordBot.isReady()) break;
      await new Promise(resolve => setTimeout(resolve, 1000));
    }
  }

  if (!discordBot.isReady()) {
    throw new Error('Discord ë´‡ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
  }

  try {
    // í¬ëŸ¼ ì±„ë„ ê°€ì ¸ì˜¤ê¸°
    const forumChannelId = DISCORD_STORE_FORUM_CHANNEL_ID;
    if (!forumChannelId) {
      throw new Error('Discord í¬ëŸ¼ ì±„ë„ IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
    }

    const forumChannel = await discordBot.channels.fetch(forumChannelId);
    if (!forumChannel) {
      throw new Error(`Discord í¬ëŸ¼ ì±„ë„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${forumChannelId}`);
    }

    // ë§¤ì¥ëª… í¬ìŠ¤íŠ¸ ì°¾ê¸° ë˜ëŠ” ìƒì„±
    const postName = `${storeName} ë§¤ì¥`;
    let storePost;

    try {
      // í™œì„± ìŠ¤ë ˆë“œì—ì„œ ì°¾ê¸°
      const activeThreads = await forumChannel.threads.fetchActive();
      storePost = Array.from(activeThreads.threads.values()).find(
        thread => thread.name === postName
      );

      if (!storePost) {
        // ì•„ì¹´ì´ë¸Œëœ ìŠ¤ë ˆë“œì—ì„œ ì°¾ê¸°
        try {
          const archivedThreads = await forumChannel.threads.fetchArchived({ limit: 100 });
          storePost = Array.from(archivedThreads.threads.values()).find(
            thread => thread.name === postName
          );
        } catch (archivedError) {
          console.warn('ì•„ì¹´ì´ë¸Œëœ ìŠ¤ë ˆë“œ ì¡°íšŒ ì‹¤íŒ¨:', archivedError);
        }
      }

      if (!storePost) {
        // í¬ìŠ¤íŠ¸ ìƒì„±
        console.log(`ğŸ“Œ [ë§¤ì¥ ì‚¬ì§„ ì—…ë¡œë“œ] ìƒˆ í¬ìŠ¤íŠ¸ ìƒì„±: ${postName}`);
        storePost = await forumChannel.threads.create({
          name: postName,
          message: {
            content: `${storeName} ë§¤ì¥ ì‚¬ì§„ ì €ì¥`
          },
          appliedTags: []
        });
        console.log(`âœ… [ë§¤ì¥ ì‚¬ì§„ ì—…ë¡œë“œ] ìƒˆ í¬ìŠ¤íŠ¸ ìƒì„± ì™„ë£Œ: ${postName} (ID: ${storePost.id})`);
      }
    } catch (postError) {
      console.error('âŒ [ë§¤ì¥ ì‚¬ì§„ ì—…ë¡œë“œ] ë§¤ì¥ í¬ìŠ¤íŠ¸ ì°¾ê¸°/ìƒì„± ì‹¤íŒ¨:', postError);
      throw postError;
    }

    // ì´ë¯¸ì§€ ì—…ë¡œë“œ
    const { AttachmentBuilder } = require('discord.js');
    const attachment = new AttachmentBuilder(imageBuffer, { name: filename });
    const message = await storePost.send({ files: [attachment] });

    const result = {
      imageUrl: message.attachments.first().url,
      messageId: message.id,  // Discord ë©”ì‹œì§€ ID ì¶”ê°€ (URL ê°±ì‹ ìš©)
      postId: storePost.id,
      threadId: storePost.id  // í¬ëŸ¼ì—ì„œëŠ” í¬ìŠ¤íŠ¸ = ìŠ¤ë ˆë“œ
    };

    return result;
  } catch (error) {
    console.error('Discord ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
    throw error;
  }
}

// POST /api/direct/store-image/upload: ë§¤ì¥ ì‚¬ì§„ íŒŒì¼ ì—…ë¡œë“œ (Discord)
app.post('/api/direct/store-image/upload', storeImageUpload.single('image'), async (req, res) => {
  let localFilePath = null;
  
  try {
    if (!req.file) {
      return res.status(400).json({ error: 'ì´ë¯¸ì§€ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.' });
    }

    const storeName = req.body.storeName;
    const photoType = req.body.photoType; // front, inside, outside, outside2, manager, staff1, staff2, staff3

    if (!storeName || !photoType) {
      // ì—…ë¡œë“œëœ íŒŒì¼ ì‚­ì œ
      if (req.file && req.file.path) {
        fs.unlinkSync(req.file.path);
      }
      return res.status(400).json({ error: 'ë§¤ì¥ëª…ê³¼ ì‚¬ì§„ íƒ€ì…ì´ í•„ìš”í•©ë‹ˆë‹¤.' });
    }

    localFilePath = req.file.path;
    const safeStoreName = storeName.replace(/[^a-zA-Z0-9ê°€-í£]/g, '_');
    const timestamp = Date.now();
    const ext = path.extname(req.file.originalname);
    const fileName = `${safeStoreName}_${photoType}_${timestamp}${ext}`;

    console.log(`ğŸ“¤ [ë§¤ì¥ ì‚¬ì§„ ì—…ë¡œë“œ] Discord ì—…ë¡œë“œ ì‹œì‘: ${storeName} - ${photoType}`);

    // íŒŒì¼ ì½ê¸°
    const fileBuffer = fs.readFileSync(localFilePath);
    
    // Discordì— ì´ë¯¸ì§€ ì—…ë¡œë“œ
    const discordResult = await uploadStorePhotoToDiscord(fileBuffer, fileName, storeName, photoType);
    const fileUrl = discordResult.imageUrl;

    console.log(`âœ… [ë§¤ì¥ ì‚¬ì§„ ì—…ë¡œë“œ] Discord ì—…ë¡œë“œ ì„±ê³µ: ${storeName} - ${photoType} - ${fileUrl}`);

    // ë¡œì»¬ íŒŒì¼ ì‚­ì œ
    try {
      fs.unlinkSync(localFilePath);
      localFilePath = null;
    } catch (unlinkError) {
      console.warn('âš ï¸ ë¡œì»¬ íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨ (ë¬´ì‹œ ê°€ëŠ¥):', unlinkError);
    }

    // Google Sheetsì— ì €ì¥ (Discord ì •ë³´ í¬í•¨)
    try {
      const values = await getSheetValues(CUSTOMER_STORE_PHOTO_SHEET_NAME);
      const updatedAt = new Date().toISOString().replace('T', ' ').substring(0, 19);
      
      // í—¤ë” í™•ì¸ ë° ìƒì„±
      const { ensureSheetHeaders } = require('./directRoutes');
      await ensureSheetHeaders(sheets, SPREADSHEET_ID, CUSTOMER_STORE_PHOTO_SHEET_NAME, HEADERS_STORE_PHOTO);

      const rowIndex = values ? values.findIndex(row => row[0] === storeName) : -1;
      const existingRow = rowIndex !== -1 && values ? values[rowIndex] : null;
      
      // photoTypeì— ë”°ë¥¸ ì»¬ëŸ¼ ì¸ë±ìŠ¤ ë§¤í•‘
      const photoTypeMap = {
        front: { url: 1, msgId: 2, postId: 3, threadId: 4 },
        inside: { url: 5, msgId: 6, postId: 7, threadId: 8 },
        outside: { url: 9, msgId: 10, postId: 11, threadId: 12 },
        outside2: { url: 13, msgId: 14, postId: 15, threadId: 16 },
        manager: { url: 17, msgId: 18, postId: 19, threadId: 20 },
        staff1: { url: 21, msgId: 22, postId: 23, threadId: 24 },
        staff2: { url: 25, msgId: 26, postId: 27, threadId: 28 },
        staff3: { url: 29, msgId: 30, postId: 31, threadId: 32 }
      };
      
      const photoMap = photoTypeMap[photoType];
      if (!photoMap) {
        console.warn(`âš ï¸ [ë§¤ì¥ ì‚¬ì§„ ì—…ë¡œë“œ] ì•Œ ìˆ˜ ì—†ëŠ” photoType: ${photoType}`);
      } else {
        if (rowIndex === -1) {
          // ìƒˆ í–‰ ìƒì„± (ëª¨ë“  ì»¬ëŸ¼ ì´ˆê¸°í™”)
          const newRow = new Array(34).fill('');
          newRow[0] = storeName;
          newRow[photoMap.url] = fileUrl;
          newRow[photoMap.msgId] = discordResult.messageId || '';
          newRow[photoMap.postId] = discordResult.postId || '';
          newRow[photoMap.threadId] = discordResult.threadId || '';
          newRow[33] = updatedAt;
          
          await rateLimitedSheetsCall(() =>
            sheets.spreadsheets.values.append({
              spreadsheetId: SPREADSHEET_ID,
              range: `${CUSTOMER_STORE_PHOTO_SHEET_NAME}!A:AJ`,
              valueInputOption: 'USER_ENTERED',
              insertDataOption: 'INSERT_ROWS',
              resource: { values: [newRow] }
            })
          );
          console.log(`âœ… [ë§¤ì¥ ì‚¬ì§„ ì—…ë¡œë“œ] Google Sheets ìƒˆ í–‰ ì¶”ê°€ ì„±ê³µ`);
        } else {
          // ê¸°ì¡´ í–‰ ì—…ë°ì´íŠ¸ (í•´ë‹¹ photoTypeì˜ URLê³¼ Discord ì •ë³´ë§Œ ì—…ë°ì´íŠ¸)
          const updatedRow = [...existingRow];
          // ë°°ì—´ ê¸¸ì´ê°€ ë¶€ì¡±í•˜ë©´ í™•ì¥ (36ê°œ ì»¬ëŸ¼: ê¸°ì¡´ 34ê°œ + ëŒ€ì¤‘êµí†µ 2ê°œ)
          while (updatedRow.length < 36) {
            updatedRow.push('');
          }
          updatedRow[photoMap.url] = fileUrl;
          updatedRow[photoMap.msgId] = discordResult.messageId || '';
          updatedRow[photoMap.postId] = discordResult.postId || '';
          updatedRow[photoMap.threadId] = discordResult.threadId || '';
          updatedRow[33] = updatedAt;
          
          await rateLimitedSheetsCall(() =>
            sheets.spreadsheets.values.update({
              spreadsheetId: SPREADSHEET_ID,
              range: `${CUSTOMER_STORE_PHOTO_SHEET_NAME}!A${rowIndex + 1}:AJ${rowIndex + 1}`,
              valueInputOption: 'USER_ENTERED',
              resource: { values: [updatedRow] }
            })
          );
          console.log(`âœ… [ë§¤ì¥ ì‚¬ì§„ ì—…ë¡œë“œ] Google Sheets ì—…ë°ì´íŠ¸ ì„±ê³µ`);
        }
      }
    } catch (sheetError) {
      console.error('âŒ [ë§¤ì¥ ì‚¬ì§„ ì—…ë¡œë“œ] Google Sheets ì €ì¥ ì˜¤ë¥˜:', sheetError);
      // Discord ì—…ë¡œë“œëŠ” ì„±ê³µí–ˆìœ¼ë¯€ë¡œ ê³„ì† ì§„í–‰
    }

    res.json({
      success: true,
      url: fileUrl,
      messageId: discordResult.messageId,
      postId: discordResult.postId,
      threadId: discordResult.threadId,
      filename: fileName
    });
  } catch (error) {
    console.error('âŒ [ë§¤ì¥ ì‚¬ì§„ ì—…ë¡œë“œ] Discord ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
    
    // ë¡œì»¬ íŒŒì¼ ì‚­ì œ
    if (localFilePath && fs.existsSync(localFilePath)) {
      try {
        fs.unlinkSync(localFilePath);
      } catch (unlinkError) {
        console.error('íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨:', unlinkError);
      }
    }

    res.status(500).json({ 
      error: 'ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'),
      details: process.env.NODE_ENV === 'development' ? error.stack : undefined
    });
  }
});

// íŒ¨ìŠ¤ì›Œë“œ ê²€ì¦ API
app.post('/api/verify-password', async (req, res) => {
  try {
    const { storeId, password } = req.body;

    if (!storeId || !password) {
      return res.status(400).json({
        success: false,
        error: 'ì•„ì´ë””ì™€ íŒ¨ìŠ¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'
      });
    }

    // ëŒ€ë¦¬ì ì•„ì´ë””ê´€ë¦¬ ì‹œíŠ¸ì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const agentValues = await getSheetValues(AGENT_SHEET_NAME);
    if (!agentValues) {
      return res.status(500).json({
        success: false,
        error: 'ì‹œíŠ¸ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'
      });
    }

    const agentRows = agentValues.slice(1);
    const agent = agentRows.find(row => row[2] === storeId); // Cì—´: ì•„ì´ë””

    if (!agent) {
      return res.status(404).json({
        success: false,
        error: 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'
      });
    }

    const passwordNotUsed = agent[3] === 'TRUE'; // Dì—´: íŒ¨ìŠ¤ì›Œë“œ ë¯¸ì‚¬ìš©
    const storedPassword = agent[4] || ''; // Eì—´: íŒ¨ìŠ¤ì›Œë“œ

    console.log(`ğŸ” [íŒ¨ìŠ¤ì›Œë“œ ê²€ì¦] ì‚¬ìš©ì: ${storeId}, íŒ¨ìŠ¤ì›Œë“œ ë¯¸ì‚¬ìš©: ${passwordNotUsed}`);

    // íŒ¨ìŠ¤ì›Œë“œ ë¯¸ì‚¬ìš©ì¸ ê²½ìš°, ì ‘ì† í—ˆìš©
    if (passwordNotUsed) {
      console.log(`âœ… [íŒ¨ìŠ¤ì›Œë“œ ê²€ì¦] íŒ¨ìŠ¤ì›Œë“œ ë¯¸ì‚¬ìš© - ì ‘ì† í—ˆìš©`);
      return res.json({
        success: true,
        verified: true,
        message: 'íŒ¨ìŠ¤ì›Œë“œ ë¯¸ì‚¬ìš© - ì ‘ì† í—ˆìš©'
      });
    }

    // íŒ¨ìŠ¤ì›Œë“œê°€ ì„¤ì •ë˜ì§€ ì•Šì€ ê²½ìš° - ì ‘ì† ê±°ë¶€
    if (!storedPassword) {
      console.log(`âŒ [íŒ¨ìŠ¤ì›Œë“œ ê²€ì¦] íŒ¨ìŠ¤ì›Œë“œê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ - ì ‘ì† ê±°ë¶€`);
      return res.json({
        success: false,
        verified: false,
        error: 'íŒ¨ìŠ¤ì›Œë“œê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.'
      });
    }

    // íŒ¨ìŠ¤ì›Œë“œ ê²€ì¦
    if (storedPassword === password) {
      console.log(`âœ… [íŒ¨ìŠ¤ì›Œë“œ ê²€ì¦] íŒ¨ìŠ¤ì›Œë“œ ì¼ì¹˜ - ì ‘ì† í—ˆìš©`);
      return res.json({
        success: true,
        verified: true,
        message: 'íŒ¨ìŠ¤ì›Œë“œ ì¼ì¹˜'
      });
    } else {
      console.log(`âŒ [íŒ¨ìŠ¤ì›Œë“œ ê²€ì¦] íŒ¨ìŠ¤ì›Œë“œ ë¶ˆì¼ì¹˜`);

      // ë””ìŠ¤ì½”ë“œ ë¡œê·¸ ì „ì†¡
      if (DISCORD_LOGGING_ENABLED) {
        const embedData = {
          title: 'âš ï¸ íŒ¨ìŠ¤ì›Œë“œ ê²€ì¦ ì‹¤íŒ¨',
          color: 15158332, // ë¹¨ê°„ìƒ‰
          timestamp: new Date().toISOString(),
          fields: [
            {
              name: 'ì‚¬ìš©ì ì •ë³´',
              value: `ID: ${storeId}\nëŒ€ìƒ: ${agent[0]}\nìê²©: ${agent[1]}`
            },
            {
              name: 'ì ‘ì† ì •ë³´',
              value: `ì‹œë„ ì‹œê°„: ${new Date().toLocaleString('ko-KR')}`
            }
          ],
          footer: {
            text: 'íŒ¨ìŠ¤ì›Œë“œ ê²€ì¦ ì‹¤íŒ¨ ì•Œë¦¼'
          }
        };

        sendLogToDiscord(embedData).catch(logError => {
          console.error('ë””ìŠ¤ì½”ë“œ ë¡œê·¸ ì „ì†¡ ì‹¤íŒ¨:', logError.message);
        });
      }

      return res.json({
        success: false,
        verified: false,
        error: 'íŒ¨ìŠ¤ì›Œë“œê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤'
      });
    }
  } catch (error) {
    console.error('âŒ [íŒ¨ìŠ¤ì›Œë“œ ê²€ì¦] ì˜¤ë¥˜:', error);
    return res.status(500).json({
      success: false,
      error: 'íŒ¨ìŠ¤ì›Œë“œ ê²€ì¦ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤',
      message: error.message
    });
  }
});

// ì¼ë°˜ ëª¨ë“œ ì§ì˜ì  ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ API
app.post('/api/verify-direct-store-password', async (req, res) => {
  try {
    const { storeId, password } = req.body;

    if (!storeId || !password) {
      return res.status(400).json({
        success: false,
        error: 'ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'
      });
    }

    const response = await rateLimitedSheetsCall(() =>
      sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: `ì¼ë°˜ëª¨ë“œê¶Œí•œê´€ë¦¬!A:H`
      })
    );

    const values = response.data.values || [];

    if (values.length <= 3) {
      return res.status(404).json({
        success: false,
        error: 'ì§ì˜ì  ê¶Œí•œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }

    const generalRows = values.slice(3); // 4í–‰ë¶€í„° ë°ì´í„°
    const targetRow = generalRows.find(row => row[0] === storeId);

    if (!targetRow) {
      return res.status(404).json({
        success: false,
        error: 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }

    const storedPassword = (targetRow[7] || '').toString().trim(); // Hì—´

    if (!storedPassword) {
      return res.status(400).json({
        success: false,
        error: 'ì´ ëª¨ë“œëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'
      });
    }

    if (storedPassword === password.toString().trim()) {
      return res.json({
        success: true,
        verified: true,
        message: 'ë¹„ë°€ë²ˆí˜¸ ì¼ì¹˜'
      });
    }

    return res.status(401).json({
      success: false,
      verified: false,
      error: 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'
    });
  } catch (error) {
    console.error('ì§ì˜ì  ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ ì˜¤ë¥˜:', error);
    return res.status(500).json({
      success: false,
      error: 'ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
    });
  }
});

// ========== ì§ì˜ì  ëª¨ë“œ API ==========

// Google Sheets URLì—ì„œ spreadsheetId ì¶”ì¶œ í—¬í¼ í•¨ìˆ˜
function extractSpreadsheetId(url) {
  if (!url) return null;
  const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
  return match ? match[1] : null;
}

// ì™¸ë¶€ ì‹œíŠ¸ì—ì„œ ë°ì´í„° ì½ê¸° í—¬í¼ í•¨ìˆ˜
async function readExternalSheet(spreadsheetId, range) {
  try {
    const response = await rateLimitedSheetsCall(() =>
      sheets.spreadsheets.values.get({
        spreadsheetId: spreadsheetId,
        range: range
      })
    );
    return response.data.values || [];
  } catch (error) {
    console.error('ì™¸ë¶€ ì‹œíŠ¸ ì½ê¸° ì˜¤ë¥˜:', error);
    throw error;
  }
}

// GET /api/direct/todays-mobiles: ì˜¤ëŠ˜ì˜ íœ´ëŒ€í° ì¡°íšŒ
// ì£¼ì„ ì²˜ë¦¬: directRoutes.jsì˜ ë¼ìš°í„°ë¡œ ì´ë™
/*
app.get('/api/direct/todays-mobiles', async (req, res) => {
  try {
    const response = await rateLimitedSheetsCall(() =>
      sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ì§ì˜ì _ì˜¤ëŠ˜ì˜íœ´ëŒ€í°!A:Z'
      })
    );

    const values = response.data.values || [];
    if (values.length <= 1) {
      return res.json({ premium: [], budget: [] });
    }

    // í—¤ë” í–‰ ì œì™¸
    const rows = values.slice(1);
    const premium = [];
    const budget = [];

    rows.forEach((row, index) => {
      if (!row[0]) return; // ë¹ˆ í–‰ ìŠ¤í‚µ

      const product = {
        id: `todays-${index}`,
        model: row[0] || '',
        petName: row[1] || row[0] || '',
        carrier: row[2] || 'SK',
        factoryPrice: parseInt(row[3] || 0),
        support: parseInt(row[4] || 0),
        storeSupport: parseInt(row[5] || 0),
        storeSupportNoAddon: parseInt(row[6] || 0),
        image: row[7] || '',
        addons: row[8] || '',
        isPremium: row[9] === 'Y' || row[9] === 'TRUE' || row[9] === true
      };

      if (product.isPremium) {
        premium.push(product);
      } else {
        budget.push(product);
      }
    });

    return res.json({ premium, budget });
  } catch (error) {
    console.error('ì˜¤ëŠ˜ì˜ íœ´ëŒ€í° ì¡°íšŒ ì˜¤ë¥˜:', error);
    return res.status(500).json({
      success: false,
      error: 'ì˜¤ëŠ˜ì˜ íœ´ëŒ€í° ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
    });
  }
});
*/

// GET /api/direct/mobiles: íœ´ëŒ€í° ëª©ë¡ ì¡°íšŒ (í†µì‹ ì‚¬ë³„)
// ì£¼ì„ ì²˜ë¦¬: directRoutes.jsì˜ ë¼ìš°í„°ë¡œ ì´ë™
/*
app.get('/api/direct/mobiles', async (req, res) => {
  try {
    const carrier = req.query.carrier || 'SK';

    // 1. ì§ì˜ì _ì„¤ì • ì‹œíŠ¸ì—ì„œ í•´ë‹¹ í†µì‹ ì‚¬ì˜ ì´í†µì‚¬ ì§€ì›ê¸ˆ ë§í¬/ë²”ìœ„ ì¡°íšŒ
    const settingsResponse = await rateLimitedSheetsCall(() =>
      sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ì§ì˜ì _ì„¤ì •!A:Z'
      })
    );

    const settingsValues = settingsResponse.data.values || [];
    let supportLink = null;
    let supportRange = null;

    // ì„¤ì • ì‹œíŠ¸ì—ì„œ í•´ë‹¹ í†µì‹ ì‚¬ì˜ ì´í†µì‚¬ ì§€ì›ê¸ˆ ë§í¬ ì°¾ê¸°
    // í˜•ì‹: [í†µì‹ ì‚¬, ì„¤ì •íƒ€ì…, ë§í¬, ë²”ìœ„, ...]
    for (const row of settingsValues) {
      if (row[0] === carrier && row[1] === 'ì´í†µì‚¬ì§€ì›ê¸ˆ') {
        supportLink = row[2];
        supportRange = row[3];
        break;
      }
    }

    if (!supportLink || !supportRange) {
      return res.status(404).json({
        success: false,
        error: 'ì´í†µì‚¬ ì§€ì›ê¸ˆ ì„¤ì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }

    // 2. ì™¸ë¶€ ì‹œíŠ¸ì—ì„œ ëª¨ë¸ëª…/ì¶œê³ ê°€/ì§€ì›ê¸ˆ ë°ì´í„° ì½ê¸°
    const externalSpreadsheetId = extractSpreadsheetId(supportLink);
    if (!externalSpreadsheetId) {
      return res.status(400).json({
        success: false,
        error: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì‹œíŠ¸ ë§í¬ì…ë‹ˆë‹¤.'
      });
    }

    const externalData = await readExternalSheet(externalSpreadsheetId, supportRange);

    // 3. ì§ì˜ì _ëª¨ë¸ì´ë¯¸ì§€ ì‹œíŠ¸ì—ì„œ ì´ë¯¸ì§€ URL ì¡°íšŒ
    // ì»¬ëŸ¼ êµ¬ì¡°: í†µì‹ ì‚¬(A) | ëª¨ë¸ID(B) | ëª¨ë¸ëª…(C) | í«ë„¤ì„(D) | ì œì¡°ì‚¬(E) | ì´ë¯¸ì§€URL(F) | ë¹„ê³ (G)
    const imageResponse = await rateLimitedSheetsCall(() =>
      sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ì§ì˜ì _ëª¨ë¸ì´ë¯¸ì§€!A:K'
      })
    );

    const imageValues = imageResponse.data.values || [];
    const imageMap = new Map();
    
    // í—¤ë” ì œì™¸í•˜ê³  ì´ë¯¸ì§€ ë§¤í•‘ ìƒì„±
    // í†µì‹ ì‚¬(Aì—´, ì¸ë±ìŠ¤ 0), ëª¨ë¸ID(Bì—´, ì¸ë±ìŠ¤ 1), ëª¨ë¸ëª…(Cì—´, ì¸ë±ìŠ¤ 2), ì´ë¯¸ì§€URL(Fì—´, ì¸ë±ìŠ¤ 5) ë§¤í•‘
    // ëª¨ë¸ID = ëª¨ë¸ëª… (ì‹¤ì œ ëª¨ë¸ ì½”ë“œ)ë¡œ í†µì¼ë˜ì–´ ìˆìŒ
    imageValues.slice(1).forEach(row => {
      const rowCarrier = (row[0] || '').trim();
      const modelId = (row[1] || '').trim(); // ëª¨ë¸ID (ì‹¤ì œ ëª¨ë¸ ì½”ë“œ)
      const modelName = (row[2] || '').trim(); // ëª¨ë¸ëª… (ëª¨ë¸IDì™€ ë™ì¼)
      const imageUrl = (row[5] || '').trim();
      
      // ì´ë¯¸ì§€ URLì´ ì—†ìœ¼ë©´ ê±´ë„ˆë›°ê¸°
      if (!imageUrl) {
        return;
      }
      
      // í†µì‹ ì‚¬ í•„í„°ë§: í˜„ì¬ ì¡°íšŒ ì¤‘ì¸ í†µì‹ ì‚¬ì™€ ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ê²½ìš°ë§Œ ë§¤í•‘
      // í†µì‹ ì‚¬ê°€ ë¹„ì–´ìˆìœ¼ë©´ í•´ë‹¹ í–‰ì„ ê±´ë„ˆë›°ì–´ ì˜ëª»ëœ ë§¤í•‘ ë°©ì§€
      if (!rowCarrier) {
        console.log(`[Direct] âš ï¸ ì˜¤ëŠ˜ì˜íœ´ëŒ€í°: í†µì‹ ì‚¬ê°€ ë¹„ì–´ìˆëŠ” ì´ë¯¸ì§€ í–‰ ê±´ë„ˆë›°ê¸°: ëª¨ë¸ID=${modelId}, ëª¨ë¸ëª…=${modelName}`);
        return;
      }
      
      // í†µì‹ ì‚¬ê°€ ì¼ì¹˜í•˜ëŠ” ê²½ìš°ë§Œ ë§¤í•‘
      if (rowCarrier === carrier) {
        // ëª¨ë¸IDì™€ ëª¨ë¸ëª… ì¤‘ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ì‚¬ìš© (ë‘˜ ë‹¤ ì‹¤ì œ ëª¨ë¸ ì½”ë“œì™€ ë™ì¼)
        const actualModelCode = modelId || modelName;
        
        if (actualModelCode) {
          // ì›ë³¸ ëª¨ë¸ ì½”ë“œë¡œ í‚¤ ìƒì„± (ì •í™•í•œ ë§¤ì¹­)
          const key = `${carrier}:${actualModelCode}`;
          imageMap.set(key, imageUrl);
          imageMap.set(actualModelCode, imageUrl);
          
          // ì •ê·œí™”ëœ ëª¨ë¸ ì½”ë“œë¡œë„ í‚¤ ìƒì„± (í˜•ì‹ ì°¨ì´ ë¬´ì‹œ)
          const normalizedCode = normalizeModelCode(actualModelCode);
          if (normalizedCode && normalizedCode !== actualModelCode.toLowerCase()) {
            const normalizedKey = `${carrier}:${normalizedCode}`;
            imageMap.set(normalizedKey, imageUrl);
            imageMap.set(normalizedCode, imageUrl);
          }
        } else {
          console.log(`[Direct] âš ï¸ ì˜¤ëŠ˜ì˜íœ´ëŒ€í°: ëª¨ë¸ì½”ë“œê°€ ì—†ëŠ” ì´ë¯¸ì§€ í–‰ ê±´ë„ˆë›°ê¸°: í†µì‹ ì‚¬=${rowCarrier}`);
        }
      }
    });

    // 4. ë°ì´í„° ì¡°í•©
    const mobileList = [];
    externalData.forEach((row, index) => {
      if (!row[0]) return; // ë¹ˆ í–‰ ìŠ¤í‚µ

      const modelId = row[0] || `model-${index}`;
      const mobile = {
        id: modelId,
        model: row[0] || '',
        petName: row[1] || row[0] || '',
        carrier: carrier,
        factoryPrice: parseInt(row[2] || 0),
        support: parseInt(row[3] || 0),
        storeSupport: parseInt(row[4] || 0),
        storeSupportNoAddon: parseInt(row[5] || 0),
        image: (() => {
          const modelCode = row[0] || modelId;
          // 1. í†µì‹ ì‚¬+ëª¨ë¸ì½”ë“œ ì¡°í•©ìœ¼ë¡œ ë¨¼ì € ì¡°íšŒ (ê°€ì¥ ì •í™•)
          const key = `${carrier}:${modelCode}`;
          let imgUrl = imageMap.get(key);
          
          // 2. ì—†ìœ¼ë©´ ëª¨ë¸ì½”ë“œë§Œìœ¼ë¡œ ì¡°íšŒ (í•˜ìœ„ í˜¸í™˜)
          if (!imgUrl) {
            imgUrl = imageMap.get(modelCode);
          }
          
          // 3. ì •ê·œí™”ëœ í‚¤ë¡œ ì¡°íšŒ (í˜•ì‹ ì°¨ì´ ë¬´ì‹œ)
          if (!imgUrl) {
            const normalizedModel = normalizeModelCode(modelCode);
            if (normalizedModel) {
              const normalizedKey = `${carrier}:${normalizedModel}`;
              imgUrl = imageMap.get(normalizedKey);
              if (!imgUrl) {
                imgUrl = imageMap.get(normalizedModel);
              }
            }
          }
          
          // 4. ì—¬ì „íˆ ì—†ìœ¼ë©´ ìœ ì‚¬í•œ í‚¤ ì°¾ê¸° (ê³µë°±, í•˜ì´í”ˆ ë“± ì°¨ì´ ë¬´ì‹œ)
          if (!imgUrl && imageMap.size > 0) {
            const modelNormalized = normalizeModelCode(modelCode);
            const mapKeys = Array.from(imageMap.keys());
            
            for (const mapKey of mapKeys) {
              const keyWithoutCarrier = mapKey.includes(':') ? mapKey.split(':')[1] : mapKey;
              const keyNormalized = normalizeModelCode(keyWithoutCarrier);
              
              if (keyNormalized === modelNormalized || 
                  keyNormalized.includes(modelNormalized) || 
                  modelNormalized.includes(keyNormalized)) {
                imgUrl = imageMap.get(mapKey);
                console.log(`[Direct] âœ… ì˜¤ëŠ˜ì˜íœ´ëŒ€í° ìœ ì‚¬ í‚¤ë¡œ ì´ë¯¸ì§€ ì°¾ìŒ: ëª¨ë¸ì½”ë“œ=${modelCode}, ë§µí‚¤=${mapKey}`);
                break;
              }
            }
          }
          
          // ë””ë²„ê¹…: ì´ë¯¸ì§€ë¥¼ ì°¾ì§€ ëª»í•œ ê²½ìš°
          if (!imgUrl && imageMap.size > 0) {
            const mapKeys = Array.from(imageMap.keys());
            const matchingKeys = mapKeys.filter(k => {
              const kLower = k.toLowerCase();
              const modelLower = modelCode.toLowerCase();
              return kLower.includes(modelLower) || modelLower.includes(kLower);
            });
            console.log(`[Direct] âš ï¸ ì˜¤ëŠ˜ì˜íœ´ëŒ€í° ì´ë¯¸ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:`, {
              í†µì‹ ì‚¬: carrier,
              ëª¨ë¸ì½”ë“œ: modelCode,
              ì¡°íšŒí‚¤: key,
              ë§µí¬ê¸°: imageMap.size,
              ìœ ì‚¬í‚¤: matchingKeys
            });
          }
          
          return imgUrl || '';
        })(),
        isRecommended: row[6] === 'Y' || row[6] === 'TRUE',
        isPopular: row[7] === 'Y' || row[7] === 'TRUE'
      };

      mobileList.push(mobile);
    });

    return res.json(mobileList);
  } catch (error) {
    console.error('íœ´ëŒ€í° ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜:', error);
    return res.status(500).json({
      success: false,
      error: 'íœ´ëŒ€í° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
    });
  }
});
*/

// ì§ì˜ì  íŒë§¤ì¼ë³´ ì»¬ëŸ¼ ì •ì˜ (A~Z)
const DIRECT_SALES_HEADERS = [
  'ë²ˆí˜¸', 'POSì½”ë“œ', 'ì—…ì²´ëª…', 'ë§¤ì¥ID', 'íŒë§¤ì¼ì‹œ', 'ê³ ê°ëª…', 'CTN', 'í†µì‹ ì‚¬',
  'ë‹¨ë§ê¸°ëª¨ë¸ëª…', 'ìƒ‰ìƒ', 'ë‹¨ë§ì¼ë ¨ë²ˆí˜¸', 'ìœ ì‹¬ëª¨ë¸ëª…', 'ìœ ì‹¬ì¼ë ¨ë²ˆí˜¸',
  'ê°œí†µìœ í˜•', 'ì „í†µì‹ ì‚¬', 'í• ë¶€êµ¬ë¶„', 'í• ë¶€ê°œì›”', 'ì•½ì •', 'ìš”ê¸ˆì œ', 'ë¶€ê°€ì„œë¹„ìŠ¤',
  'ì¶œê³ ê°€', 'ì´í†µì‚¬ì§€ì›ê¸ˆ', 'ëŒ€ë¦¬ì ì¶”ê°€ì§€ì›ê¸ˆ(ë¶€ê°€ìœ ì¹˜)', 'ëŒ€ë¦¬ì ì¶”ê°€ì§€ì›ê¸ˆ(ë¶€ê°€ë¯¸ìœ ì¹˜)', 'ë§ˆì§„', 'ìƒíƒœ'
];

// GET /api/direct/sales: íŒë§¤ì¼ë³´ ëª©ë¡ ì¡°íšŒ
app.get('/api/direct/sales', async (req, res) => {
  try {
    // í—¤ë” ë³´ì •
    await rateLimitedSheetsCall(() =>
      sheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ì§ì˜ì _íŒë§¤ì¼ë³´!A1:Z1',
        valueInputOption: 'RAW',
        resource: { values: [DIRECT_SALES_HEADERS] }
      })
    );

    const response = await rateLimitedSheetsCall(() =>
      sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ì§ì˜ì _íŒë§¤ì¼ë³´!A:Z'
      })
    );

    const values = response.data.values || [];
    if (values.length <= 1) {
      return res.json([]);
    }

    // ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ì—ì„œ storeId í•„í„° ê°€ì ¸ì˜¤ê¸°
    const requestedStoreId = req.query.storeId;

    // í—¤ë” í–‰ ì œì™¸
    const rows = values.slice(1);
    const salesReports = rows
      .map((row, index) => ({
        id: row[0] || `sales-${index}`,
        ë²ˆí˜¸: row[0] || `sales-${index}`,
        posCode: row[1] || '',
        POSì½”ë“œ: row[1] || '',
        company: row[2] || '',
        ì—…ì²´ëª…: row[2] || '',
        storeName: row[2] || '',
        storeId: row[3] || '',
        ë§¤ì¥ID: row[3] || '',
        saleDateTime: row[4] || '',
        íŒë§¤ì¼ì‹œ: row[4] || '',
        soldAt: row[4] || '',
        customerName: row[5] || '',
        ê³ ê°ëª…: row[5] || '',
        customerContact: row[6] || '',
        CTN: row[6] || '',
        ctn: row[6] || '',
        ì—°ë½ì²˜: row[6] || '',
        carrier: row[7] || '',
        í†µì‹ ì‚¬: row[7] || '',
        model: row[8] || '',
        ë‹¨ë§ê¸°ëª¨ë¸ëª…: row[8] || '',
        deviceModel: row[8] || '',
        color: row[9] || '',
        ìƒ‰ìƒ: row[9] || '',
        deviceColor: row[9] || '',
        deviceSerial: row[10] || '',
        ë‹¨ë§ì¼ë ¨ë²ˆí˜¸: row[10] || '',
        usimModel: row[11] || '',
        ìœ ì‹¬ëª¨ë¸ëª…: row[11] || '',
        simModel: row[11] || '',
        usimSerial: row[12] || '',
        ìœ ì‹¬ì¼ë ¨ë²ˆí˜¸: row[12] || '',
        simSerial: row[12] || '',
        openingType: row[13] || '',
        ê°œí†µìœ í˜•: row[13] || '',
        // ê°œí†µìœ í˜•ì„ ì˜ë¬¸ìœ¼ë¡œë„ ë³€í™˜ (í•˜ìœ„ í˜¸í™˜)
        type: row[13] === 'ì‹ ê·œ' ? 'NEW' : row[13] === 'ë²ˆí˜¸ì´ë™' ? 'MNP' : row[13] === 'ê¸°ê¸°ë³€ê²½' ? 'CHANGE' : '',
        prevCarrier: row[14] || '',
        ì „í†µì‹ ì‚¬: row[14] || '',
        installmentType: row[15] || '',
        í• ë¶€êµ¬ë¶„: row[15] || '',
        paymentType: row[15] || '',
        installmentPeriod: row[16] || '',
        í• ë¶€ê°œì›”: row[16] || '',
        contract: row[17] || '',
        ì•½ì •: row[17] || '',
        contractType: row[17] || '',
        plan: row[18] || '',
        ìš”ê¸ˆì œ: row[18] || '',
        addons: row[19] || '',
        ë¶€ê°€ì„œë¹„ìŠ¤: row[19] || '',
        factoryPrice: Number(row[20] || 0),
        ì¶œê³ ê°€: Number(row[20] || 0),
        publicSupport: Number(row[21] || 0),
        ì´í†µì‚¬ì§€ì›ê¸ˆ: Number(row[21] || 0),
        storeSupportWithAddon: Number(row[22] || 0),
        'ëŒ€ë¦¬ì ì¶”ê°€ì§€ì›ê¸ˆ(ë¶€ê°€ìœ ì¹˜)': Number(row[22] || 0),
        storeSupportNoAddon: Number(row[23] || 0),
        'ëŒ€ë¦¬ì ì¶”ê°€ì§€ì›ê¸ˆ(ë¶€ê°€ë¯¸ìœ ì¹˜)': Number(row[23] || 0),
        margin: Number(row[24] || 0),
        ë§ˆì§„: Number(row[24] || 0),
        status: row[25] || '',
        ìƒíƒœ: row[25] || ''
      }))
      .filter(report => {
        // ë¹ˆ í–‰ ì œì™¸
        if (!report.id) return false;
        // storeId í•„í„°ê°€ ìˆìœ¼ë©´ í•´ë‹¹ ë§¤ì¥ ë°ì´í„°ë§Œ ë°˜í™˜
        if (requestedStoreId) {
          return report.storeId === requestedStoreId || report.posCode === requestedStoreId;
        }
        // í•„í„°ê°€ ì—†ìœ¼ë©´ ëª¨ë“  ë°ì´í„° ë°˜í™˜ (ê´€ë¦¬ ëª¨ë“œ)
        return true;
      });

    return res.json(salesReports);
  } catch (error) {
    console.error('íŒë§¤ì¼ë³´ ì¡°íšŒ ì˜¤ë¥˜:', error);
    return res.status(500).json({
      success: false,
      error: 'íŒë§¤ì¼ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
    });
  }
});

// POST /api/direct/sales: íŒë§¤ì¼ë³´ ìƒì„± (ê°œí†µì •ë³´ ì €ì¥)
app.post('/api/direct/sales', async (req, res) => {
  try {
    const data = req.body;

    // í•„ìˆ˜ í•„ë“œ ê²€ì¦
    if (!data.customerName || !data.customerContact) {
      return res.status(400).json({
        success: false,
        error: 'ê³ ê°ëª…ê³¼ ì—°ë½ì²˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'
      });
    }

    // ID ìƒì„± (íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ë°˜)
    const id = `sales-${Date.now()}`;
    const soldAt = data.soldAt || new Date().toISOString();

    const openingTypeKor =
      data.openingType === 'NEW' ? 'ì‹ ê·œ' :
        data.openingType === 'MNP' ? 'ë²ˆí˜¸ì´ë™' :
          data.openingType === 'CHANGE' ? 'ê¸°ê¸°ë³€ê²½' :
            data.openingType || '';

    const addonsText = Array.isArray(data.addons)
      ? data.addons.join(', ')
      : (typeof data.addons === 'string' ? data.addons : JSON.stringify(data.addons || {}));

    // ì•½ì • ìœ í˜• í•œê¸€ ë³€í™˜ (í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì´ë¯¸ ë³€í™˜í–ˆì„ ìˆ˜ë„ ìˆì§€ë§Œ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬)
    const contractTypeKor = data.contractType === 'selected' || data.contract === 'selected'
      ? 'ì„ íƒì•½ì •'
      : data.contractType === 'standard' || data.contract === 'standard'
        ? 'ì¼ë°˜ì•½ì •'
        : (data.contractType || data.contract || '');

    const row = [
      id,                                       // ë²ˆí˜¸
      data.posCode || '',                       // POSì½”ë“œ
      data.company || data.storeName || '',     // ì—…ì²´ëª…
      data.storeId || '',                       // ë§¤ì¥ID
      soldAt,                                   // íŒë§¤ì¼ì‹œ
      data.customerName || '',                  // ê³ ê°ëª…
      data.customerContact || '',               // CTN
      data.carrier || '',                       // í†µì‹ ì‚¬
      data.model || '',                         // ë‹¨ë§ê¸°ëª¨ë¸ëª…
      data.color || '',                         // ìƒ‰ìƒ
      data.deviceSerial || '',                  // ë‹¨ë§ì¼ë ¨ë²ˆí˜¸
      data.usimModel || '',                     // ìœ ì‹¬ëª¨ë¸ëª…
      data.usimSerial || '',                    // ìœ ì‹¬ì¼ë ¨ë²ˆí˜¸
      openingTypeKor,                           // ê°œí†µìœ í˜•
      data.prevCarrier || '',                   // ì „í†µì‹ ì‚¬
      data.installmentType || '',               // í• ë¶€êµ¬ë¶„
      data.installmentPeriod || '',             // í• ë¶€ê°œì›”
      contractTypeKor,                         // ì•½ì • (í•œê¸€ë¡œ ë³€í™˜)
      data.plan || '',                          // ìš”ê¸ˆì œ
      addonsText || '',                         // ë¶€ê°€ì„œë¹„ìŠ¤
      data.factoryPrice || 0,                   // ì¶œê³ ê°€
      data.publicSupport || 0,                  // ì´í†µì‚¬ì§€ì›ê¸ˆ
      data.storeSupportWithAddon || 0,          // ëŒ€ë¦¬ì ì¶”ê°€ì§€ì›ê¸ˆ(ë¶€ê°€ìœ ì¹˜)
      data.storeSupportNoAddon || 0,            // ëŒ€ë¦¬ì ì¶”ê°€ì§€ì›ê¸ˆ(ë¶€ê°€ë¯¸ìœ ì¹˜)
      data.margin || 0,                         // ë§ˆì§„
      data.status || 'ê°œí†µëŒ€ê¸°'                  // ìƒíƒœ
    ];

    // í—¤ë” ë³´ì • í›„ ì§ì˜ì _íŒë§¤ì¼ë³´ ì‹œíŠ¸ì— ì¶”ê°€
    await rateLimitedSheetsCall(() =>
      sheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ì§ì˜ì _íŒë§¤ì¼ë³´!A1:Z1',
        valueInputOption: 'RAW',
        resource: { values: [DIRECT_SALES_HEADERS] }
      })
    );

    await rateLimitedSheetsCall(() =>
      sheets.spreadsheets.values.append({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ì§ì˜ì _íŒë§¤ì¼ë³´!A2',
        valueInputOption: 'USER_ENTERED',
        insertDataOption: 'INSERT_ROWS',
        resource: {
          values: [row]
        }
      })
    );

    return res.json({
      success: true,
      id: id,
      message: 'íŒë§¤ì¼ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'
    });
  } catch (error) {
    console.error('íŒë§¤ì¼ë³´ ì €ì¥ ì˜¤ë¥˜:', error);
    return res.status(500).json({
      success: false,
      error: 'íŒë§¤ì¼ë³´ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
    });
  }
});

// PUT /api/direct/sales/:id: íŒë§¤ì¼ë³´ ìˆ˜ì •
app.put('/api/direct/sales/:id', async (req, res) => {
  try {
    const { id } = req.params;
    const data = req.body;

    // ê¸°ì¡´ ë°ì´í„° ì¡°íšŒ
    const response = await rateLimitedSheetsCall(() =>
      sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ì§ì˜ì _íŒë§¤ì¼ë³´!A:Z'
      })
    );

    const values = response.data.values || [];
    if (values.length <= 1) {
      return res.status(404).json({
        success: false,
        error: 'íŒë§¤ì¼ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }

    // í•´ë‹¹ IDì˜ í–‰ ì°¾ê¸°
    const rows = values.slice(1);
    const rowIndex = rows.findIndex(row => row[0] === id);

    if (rowIndex === -1) {
      return res.status(404).json({
        success: false,
        error: 'íŒë§¤ì¼ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }

    const existingRow = rows[rowIndex];
    const openingTypeKor =
      data.openingType === 'NEW' ? 'ì‹ ê·œ' :
        data.openingType === 'MNP' ? 'ë²ˆí˜¸ì´ë™' :
          data.openingType === 'CHANGE' ? 'ê¸°ê¸°ë³€ê²½' :
            data.openingType || existingRow[13] || '';

    const addonsText = Array.isArray(data.addons)
      ? data.addons.join(', ')
      : (typeof data.addons === 'string' ? data.addons : data.addons ? JSON.stringify(data.addons) : existingRow[19] || '');

    const updatedRow = [
      existingRow[0] || id,                      // ë²ˆí˜¸
      data.posCode || existingRow[1] || '',      // POSì½”ë“œ
      data.company || data.storeName || existingRow[2] || '', // ì—…ì²´ëª…
      data.storeId || existingRow[3] || '',      // ë§¤ì¥ID
      data.soldAt || existingRow[4] || '',       // íŒë§¤ì¼ì‹œ
      data.customerName || existingRow[5] || '', // ê³ ê°ëª…
      data.customerContact || existingRow[6] || '', // CTN
      data.carrier || existingRow[7] || '',      // í†µì‹ ì‚¬
      data.model || existingRow[8] || '',        // ë‹¨ë§ê¸°ëª¨ë¸ëª…
      data.color || existingRow[9] || '',        // ìƒ‰ìƒ
      data.deviceSerial || existingRow[10] || '',// ë‹¨ë§ì¼ë ¨ë²ˆí˜¸
      data.usimModel || existingRow[11] || '',   // ìœ ì‹¬ëª¨ë¸ëª…
      data.usimSerial || existingRow[12] || '',  // ìœ ì‹¬ì¼ë ¨ë²ˆí˜¸
      openingTypeKor,                            // ê°œí†µìœ í˜•
      data.prevCarrier || existingRow[14] || '', // ì „í†µì‹ ì‚¬
      data.installmentType || existingRow[15] || '', // í• ë¶€êµ¬ë¶„
      data.installmentPeriod || existingRow[16] || '', // í• ë¶€ê°œì›”
      data.contractType || data.contract || existingRow[17] || '', // ì•½ì •
      data.plan || existingRow[18] || '',        // ìš”ê¸ˆì œ
      addonsText,                                // ë¶€ê°€ì„œë¹„ìŠ¤
      data.factoryPrice || existingRow[20] || 0, // ì¶œê³ ê°€
      data.publicSupport || existingRow[21] || 0,// ì´í†µì‚¬ì§€ì›ê¸ˆ
      data.storeSupportWithAddon || existingRow[22] || 0, // ëŒ€ë¦¬ì ì¶”ê°€ì§€ì›ê¸ˆ(ë¶€ê°€ìœ ì¹˜)
      data.storeSupportNoAddon || existingRow[23] || 0,   // ëŒ€ë¦¬ì ì¶”ê°€ì§€ì›ê¸ˆ(ë¶€ê°€ë¯¸ìœ ì¹˜)
      data.margin || existingRow[24] || 0,       // ë§ˆì§„
      data.status || existingRow[25] || 'ê°œí†µëŒ€ê¸°' // ìƒíƒœ
    ];

    // í–‰ ì—…ë°ì´íŠ¸ (í–‰ ë²ˆí˜¸ëŠ” 2ë¶€í„° ì‹œì‘, í—¤ë” ì œì™¸)
    await rateLimitedSheetsCall(() =>
      sheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: `ì§ì˜ì _íŒë§¤ì¼ë³´!A${rowIndex + 2}`,
        valueInputOption: 'USER_ENTERED',
        resource: {
          values: [updatedRow]
        }
      })
    );

    return res.json({
      success: true,
      id: id,
      message: 'íŒë§¤ì¼ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.'
    });
  } catch (error) {
    console.error('íŒë§¤ì¼ë³´ ìˆ˜ì • ì˜¤ë¥˜:', error);
    return res.status(500).json({
      success: false,
      error: 'íŒë§¤ì¼ë³´ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
    });
  }
});

// ì§ì˜ì  ì´ë¯¸ì§€ ì—…ë¡œë“œë¥¼ ìœ„í•œ multer ì„¤ì •
const directStoreUpload = multer({
  storage: multer.memoryStorage(),
  limits: { fileSize: 10 * 1024 * 1024 } // 10MB ì œí•œ
});

// ëª¨ë¸ ì½”ë“œ ì •ê·œí™” í•¨ìˆ˜ (ê³µë°±, í•˜ì´í”ˆ, ì–¸ë”ìŠ¤ì½”ì–´ ì œê±°, ì†Œë¬¸ì ë³€í™˜)
function normalizeModelCode(modelCode) {
  if (!modelCode) return '';
  return modelCode.replace(/[\s\-_]/g, '').toLowerCase();
}

// ëª¨ë¸ëª…ê³¼ í«ë„¤ì„ì—ì„œ ì œì¡°ì‚¬ ì¶”ì¶œ í•¨ìˆ˜ (ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ìŒ)
function extractManufacturer(modelName, petName = '') {
  if (!modelName && !petName) return 'ê¸°íƒ€';

  // ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ì´ ì²´í¬í•˜ê¸° ìœ„í•´ ëª¨ë‘ ëŒ€ë¬¸ìë¡œ ë³€í™˜
  const model = (modelName || '').toUpperCase().trim();
  const pet = (petName || '').toUpperCase().trim();
  const combined = `${model} ${pet}`.trim();

  // ì›ë³¸ í…ìŠ¤íŠ¸ë„ ë³´ê´€ (ì •ê·œì‹ ë§¤ì¹­ìš©)
  const modelOriginal = (modelName || '').trim();
  const petOriginal = (petName || '').trim();
  const combinedOriginal = `${modelOriginal} ${petOriginal}`.trim();

  // ğŸ”¥ ë””ë²„ê·¸: ì œì¡°ì‚¬ ì¶”ì¶œ ê³¼ì • ë¡œê¹… (SM-F766N256 ê°™ì€ ë¬¸ì œ ëª¨ë¸)
  const isDebugTarget = modelOriginal && (
    modelOriginal.includes('SM-F766N256') ||
    modelOriginal.includes('UIP17PR-256') ||
    modelOriginal.startsWith('SM-')
  );
  if (isDebugTarget) {
    console.log(`ğŸ” [extractManufacturer] ë””ë²„ê·¸:`, {
      modelName,
      petName,
      modelOriginal,
      petOriginal,
      model,
      pet,
      combinedOriginal
    });
  }

  // ì‚¼ì„±: SM-ë¡œ ì‹œì‘í•˜ê±°ë‚˜ SAMSUNG, ê°¤ëŸ­ì‹œ í¬í•¨ (ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ìŒ)
  const isSamsung = (
    /^SM-/i.test(modelOriginal) || // SM-ë¡œ ì‹œì‘ (ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ìŒ)
    /samsung/i.test(combinedOriginal) ||
    /ê°¤ëŸ­ì‹œ/i.test(combinedOriginal) ||
    /galaxy/i.test(combinedOriginal) ||
    model.startsWith('SM-') ||
    model.includes('SAMSUNG') ||
    model.includes('ê°¤ëŸ­ì‹œ') ||
    model.includes('GALAXY') ||
    pet.includes('ê°¤ëŸ­ì‹œ') ||
    pet.includes('GALAXY') ||
    combined.includes('ê°¤ëŸ­ì‹œ') ||
    combined.includes('GALAXY')
  );

  if (isSamsung) {
    if (isDebugTarget) {
      console.log(`âœ… [extractManufacturer] ì‚¼ì„±ìœ¼ë¡œ ì¸ì‹:`, { modelOriginal, petOriginal });
    }
    return 'ì‚¼ì„±';
  }
  // ì• í”Œ: iPhone, iPad, Apple í¬í•¨ (ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ìŒ)
  // ë˜ëŠ” ëª¨ë¸ëª…ì´ Aë¡œ ì‹œì‘í•˜ëŠ” ìˆ«ì (ì• í”Œ ì œí’ˆ ì½”ë“œ: A2847 ë“±)
  // ë˜ëŠ” í•œê¸€ "ì•„ì´í°", "ì•„ì´íŒ¨ë“œ" í¬í•¨
  else if (
    /iphone/i.test(combinedOriginal) ||
    /ipad/i.test(combinedOriginal) ||
    /apple/i.test(combinedOriginal) ||
    /ì•„ì´í°/i.test(combinedOriginal) ||
    /ì•„ì´íŒ¨ë“œ/i.test(combinedOriginal) ||
    /^A\d+/i.test(modelOriginal) || // Aë¡œ ì‹œì‘í•˜ëŠ” ìˆ«ì (ì• í”Œ ì œí’ˆ ì½”ë“œ, ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ìŒ)
    model.includes('IPHONE') ||
    model.includes('IPAD') ||
    model.includes('APPLE') ||
    model.includes('ì•„ì´í°') ||
    model.includes('ì•„ì´íŒ¨ë“œ') ||
    pet.includes('ì•„ì´í°') ||
    pet.includes('ì•„ì´íŒ¨ë“œ') ||
    pet.includes('IPHONE') ||
    pet.includes('IPAD') ||
    combined.includes('ì•„ì´í°') ||
    combined.includes('ì•„ì´íŒ¨ë“œ') ||
    combined.includes('IPHONE') ||
    combined.includes('IPAD')
  ) {
    return 'ì• í”Œ';
  }
  // LG: LG í¬í•¨ ë˜ëŠ” UIP/UIPAë¡œ ì‹œì‘í•˜ëŠ” ëª¨ë¸ (LG ë²¨ë²³ ì‹œë¦¬ì¦ˆ, ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ìŒ)
  else if (
    /^UIP/i.test(modelOriginal) || // UIP, UIPA, UIP17 ë“±ìœ¼ë¡œ ì‹œì‘
    /^UIPA/i.test(modelOriginal) ||
    (/^lg\s/i.test(modelOriginal) || /lg\s/i.test(petOriginal) || /lg\s/i.test(combinedOriginal)) && // LGë¡œ ì‹œì‘
    !/galaxy/i.test(combinedOriginal) && // ê°¤ëŸ­ì‹œê°€ ì•„ë‹Œ ê²½ìš°
    (model.includes('LG') || model.includes('VELVET') || pet.includes('LG') || pet.includes('VELVET')) &&
    !combined.includes('GALAXY')
  ) {
    return 'LG';
  }
  // ìƒ¤ì˜¤ë¯¸: XIAOMI, ìƒ¤ì˜¤ë¯¸, MI í¬í•¨ (ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ìŒ)
  else if (
    /xiaomi/i.test(combinedOriginal) ||
    /ìƒ¤ì˜¤ë¯¸/i.test(combinedOriginal) ||
    /\bmi\s/i.test(combinedOriginal) || // MIë¡œ ì‹œì‘í•˜ëŠ” ë‹¨ì–´ (ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ìŒ)
    model.includes('XIAOMI') ||
    model.includes('ìƒ¤ì˜¤ë¯¸') ||
    model.includes('MI ') ||
    pet.includes('ìƒ¤ì˜¤ë¯¸') ||
    pet.includes('XIAOMI') ||
    combined.includes('ìƒ¤ì˜¤ë¯¸') ||
    combined.includes('XIAOMI')
  ) {
    return 'ìƒ¤ì˜¤ë¯¸';
  }
  // OPPO: OPPO, ì›í”ŒëŸ¬ìŠ¤ í¬í•¨ (ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ìŒ)
  else if (
    /oppo/i.test(combinedOriginal) ||
    /ì›í”ŒëŸ¬ìŠ¤/i.test(combinedOriginal) ||
    /oneplus/i.test(combinedOriginal) ||
    model.includes('OPPO') ||
    model.includes('ì›í”ŒëŸ¬ìŠ¤') ||
    model.includes('ONEPLUS') ||
    pet.includes('OPPO') ||
    pet.includes('ì›í”ŒëŸ¬ìŠ¤') ||
    combined.includes('OPPO') ||
    combined.includes('ì›í”ŒëŸ¬ìŠ¤')
  ) {
    return 'OPPO';
  }
  else {
    if (isDebugTarget) {
      console.log(`âš ï¸ [extractManufacturer] ì œì¡°ì‚¬ ì¸ì‹ ì‹¤íŒ¨, 'ê¸°íƒ€' ë°˜í™˜:`, { modelOriginal, petOriginal });
    }
    return 'ê¸°íƒ€';
  }
}

// í¬ëŸ¼ ì±„ë„ì—ì„œ í†µì‹ ì‚¬ë³„ í¬ìŠ¤íŠ¸ ì°¾ê¸° ë˜ëŠ” ìƒì„±
async function findOrCreateCarrierPost(forumChannel, carrier) {
  try {
    const postName = `${carrier} í†µì‹ ì‚¬`;
    console.log(`ğŸ” [findOrCreateCarrierPost] í¬ìŠ¤íŠ¸ ì°¾ê¸°: ${postName}`);

    // í™œì„± ìŠ¤ë ˆë“œì—ì„œ ì°¾ê¸°
    const activeThreads = await forumChannel.threads.fetchActive();
    let post = Array.from(activeThreads.threads.values()).find(
      thread => thread.name === postName
    );

    if (post) {
      console.log(`âœ… [findOrCreateCarrierPost] ê¸°ì¡´ í¬ìŠ¤íŠ¸ ì°¾ìŒ: ${postName} (ID: ${post.id})`);
      return post;
    }

    // ì•„ì¹´ì´ë¸Œëœ ìŠ¤ë ˆë“œì—ì„œ ì°¾ê¸°
    try {
      const archivedThreads = await forumChannel.threads.fetchArchived({ limit: 100 });
      post = Array.from(archivedThreads.threads.values()).find(
        thread => thread.name === postName
      );

      if (post) {
        console.log(`âœ… [findOrCreateCarrierPost] ì•„ì¹´ì´ë¸Œëœ í¬ìŠ¤íŠ¸ ì°¾ìŒ: ${postName} (ID: ${post.id})`);
        return post;
      }
    } catch (archivedError) {
      console.warn('ì•„ì¹´ì´ë¸Œëœ ìŠ¤ë ˆë“œ ì¡°íšŒ ì‹¤íŒ¨:', archivedError);
    }

    // í¬ìŠ¤íŠ¸ ìƒì„±
    console.log(`ğŸ“Œ [findOrCreateCarrierPost] ìƒˆ í¬ìŠ¤íŠ¸ ìƒì„±: ${postName}`);
    const newPost = await forumChannel.threads.create({
      name: postName,
      message: {
        content: `${carrier} í†µì‹ ì‚¬ ì´ë¯¸ì§€ ì €ì¥`
      },
      appliedTags: []
    });

    console.log(`âœ… [findOrCreateCarrierPost] ìƒˆ í¬ìŠ¤íŠ¸ ìƒì„± ì™„ë£Œ: ${postName} (ID: ${newPost.id})`);
    return newPost;
  } catch (error) {
    console.error('í†µì‹ ì‚¬ë³„ í¬ìŠ¤íŠ¸ ì°¾ê¸°/ìƒì„± ì˜¤ë¥˜:', error);
    throw error;
  }
}

// í¬ìŠ¤íŠ¸ì—ì„œ ì œì¡°ì‚¬ë³„ ìŠ¤ë ˆë“œ ì°¾ê¸° ë˜ëŠ” ìƒì„±
// Discord í¬ëŸ¼ êµ¬ì¡°ìƒ í¬ìŠ¤íŠ¸ ìì²´ê°€ ìŠ¤ë ˆë“œì´ë¯€ë¡œ, ì œì¡°ì‚¬ë³„ë¡œ ë³„ë„ í¬ìŠ¤íŠ¸ë¥¼ ìƒì„±
async function findOrCreateManufacturerThread(forumChannel, carrier, manufacturer) {
  try {
    const postName = `${carrier} ${manufacturer}`;
    console.log(`ğŸ” [findOrCreateManufacturerThread] í¬ìŠ¤íŠ¸ ì°¾ê¸°: ${postName}`);

    // í™œì„± ìŠ¤ë ˆë“œì—ì„œ ì°¾ê¸°
    const activeThreads = await forumChannel.threads.fetchActive();
    let post = Array.from(activeThreads.threads.values()).find(
      thread => thread.name === postName
    );

    if (post) {
      console.log(`âœ… [findOrCreateManufacturerThread] ê¸°ì¡´ í¬ìŠ¤íŠ¸ ì°¾ìŒ: ${postName} (ID: ${post.id})`);
      return post;
    }

    // ì•„ì¹´ì´ë¸Œëœ ìŠ¤ë ˆë“œì—ì„œ ì°¾ê¸°
    try {
      const archivedThreads = await forumChannel.threads.fetchArchived({ limit: 100 });
      post = Array.from(archivedThreads.threads.values()).find(
        thread => thread.name === postName
      );

      if (post) {
        console.log(`âœ… [findOrCreateManufacturerThread] ì•„ì¹´ì´ë¸Œëœ í¬ìŠ¤íŠ¸ ì°¾ìŒ: ${postName} (ID: ${post.id})`);
        return post;
      }
    } catch (archivedError) {
      console.warn('ì•„ì¹´ì´ë¸Œëœ ìŠ¤ë ˆë“œ ì¡°íšŒ ì‹¤íŒ¨:', archivedError);
    }

    // í¬ìŠ¤íŠ¸ ìƒì„±
    console.log(`ğŸ“Œ [findOrCreateManufacturerThread] ìƒˆ í¬ìŠ¤íŠ¸ ìƒì„±: ${postName}`);
    const newPost = await forumChannel.threads.create({
      name: postName,
      message: {
        content: `${carrier} ${manufacturer} ì´ë¯¸ì§€ ì €ì¥`
      },
      appliedTags: []
    });

    console.log(`âœ… [findOrCreateManufacturerThread] ìƒˆ í¬ìŠ¤íŠ¸ ìƒì„± ì™„ë£Œ: ${postName} (ID: ${newPost.id})`);
    return newPost;
  } catch (error) {
    console.error('ì œì¡°ì‚¬ë³„ ìŠ¤ë ˆë“œ ì°¾ê¸°/ìƒì„± ì˜¤ë¥˜:', error);
    throw error;
  }
}

// ì§ì˜ì  ëª¨ë“œìš© Discord ì´ë¯¸ì§€ ì—…ë¡œë“œ í•¨ìˆ˜
async function uploadImageToDiscordForStore(imageBuffer, filename, carrier, manufacturer) {
  if (!DISCORD_LOGGING_ENABLED || !discordBot) {
    throw new Error('Discord ë´‡ì´ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
  }

  // ë´‡ì´ ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸°
  if (!discordBot.isReady()) {
    for (let i = 0; i < 10; i++) {
      if (discordBot.isReady()) break;
      await new Promise(resolve => setTimeout(resolve, 1000));
    }
  }

  if (!discordBot.isReady()) {
    throw new Error('Discord ë´‡ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
  }

  try {
    // í¬ëŸ¼ ì±„ë„ ê°€ì ¸ì˜¤ê¸°
    const forumChannelId = DISCORD_STORE_FORUM_CHANNEL_ID;
    if (!forumChannelId) {
      throw new Error('Discord í¬ëŸ¼ ì±„ë„ IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
    }

    const forumChannel = await discordBot.channels.fetch(forumChannelId);
    if (!forumChannel) {
      throw new Error(`Discord í¬ëŸ¼ ì±„ë„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${forumChannelId}`);
    }

    // ì œì¡°ì‚¬ë³„ í¬ìŠ¤íŠ¸ ì°¾ê¸° ë˜ëŠ” ìƒì„± (í†µì‹ ì‚¬+ì œì¡°ì‚¬ ì¡°í•©)
    const thread = await findOrCreateManufacturerThread(forumChannel, carrier, manufacturer);

    // ì´ë¯¸ì§€ ì—…ë¡œë“œ
    const { AttachmentBuilder } = require('discord.js');
    const attachment = new AttachmentBuilder(imageBuffer, { name: filename });
    const message = await thread.send({ files: [attachment] });

    const result = {
      imageUrl: message.attachments.first().url,
      messageId: message.id,  // Discord ë©”ì‹œì§€ ID ì¶”ê°€ (URL ê°±ì‹ ìš©)
      postId: thread.id,  // í¬ëŸ¼ êµ¬ì¡°ìƒ í¬ìŠ¤íŠ¸ = ìŠ¤ë ˆë“œ
      threadId: thread.id
    };

    return result;
  } catch (error) {
    console.error('Discord ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
    throw error;
  }
}

// POST /api/direct/upload-image: ì´ë¯¸ì§€ ì—…ë¡œë“œ (Discord)
app.post('/api/direct/upload-image', directStoreUpload.single('image'), async (req, res) => {
  const startTime = Date.now();
  let imageUrl = null;
  let discordResult = null;

  try {
    console.log('ğŸ“¤ [ìƒí’ˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ] ìš”ì²­ ì‹œì‘');

    if (!req.file) {
      console.error('âŒ [ìƒí’ˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ] íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
      return res.status(400).json({
        success: false,
        error: 'ì´ë¯¸ì§€ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.'
      });
    }

    const file = req.file;
    const clientModelId = req.body.modelId || 'unknown'; // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì „ì†¡í•œ ID (mobile-SK-0 í˜•ì‹)
    const carrier = req.body.carrier || 'SK'; // í†µì‹ ì‚¬ ì •ë³´ (í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì „ì†¡)
    const modelName = req.body.modelName || clientModelId; // ëª¨ë¸ëª… (ì‹¤ì œ ëª¨ë¸ ì½”ë“œ, ì˜ˆ: SM-S918N)
    const petName = req.body.petName || modelName; // í«ë„¤ì„ (í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì „ì†¡)

    // ëª¨ë¸ID = ëª¨ë¸ëª…ìœ¼ë¡œ í†µì¼ (ì•ˆì •ì ì¸ ì‹ë³„ì)
    // ëª¨ë¸ëª…ì´ ì‹¤ì œ ëª¨ë¸ ì½”ë“œì´ë¯€ë¡œ ì´ë¥¼ ëª¨ë¸IDë¡œ ì‚¬ìš©
    const modelId = modelName; // ëª¨ë¸IDëŠ” ì‹¤ì œ ëª¨ë¸ ì½”ë“œì™€ ë™ì¼í•˜ê²Œ ì„¤ì •

    console.log(`ğŸ“¤ [ìƒí’ˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ] í´ë¼ì´ì–¸íŠ¸ ID: ${clientModelId}, ëª¨ë¸ID(ëª¨ë¸ëª…): ${modelId}, í†µì‹ ì‚¬: ${carrier}, í«ë„¤ì„: ${petName}, íŒŒì¼ëª…: ${file.originalname}, í¬ê¸°: ${file.size} bytes`);

    // ì œì¡°ì‚¬ ì¶”ì¶œ (ëª¨ë¸ëª…ê³¼ í«ë„¤ì„ ëª¨ë‘ ì²´í¬)
    const manufacturer = extractManufacturer(modelName, petName);
    console.log(`ğŸ“¤ [ìƒí’ˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ] ì¶”ì¶œëœ ì œì¡°ì‚¬: ${manufacturer} (ëª¨ë¸ëª…: ${modelName}, í«ë„¤ì„: ${petName})`);

    // ğŸ”¥ ë””ë²„ê·¸: ì œì¡°ì‚¬ ì¶”ì¶œ ì‹¤íŒ¨ ì‹œ ìƒì„¸ ë¡œê·¸
    if (!manufacturer || manufacturer.trim() === '' || manufacturer === 'ê¸°íƒ€') {
      console.warn(`âš ï¸ [ìƒí’ˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ] ì œì¡°ì‚¬ ì¶”ì¶œ ì‹¤íŒ¨ ë˜ëŠ” 'ê¸°íƒ€': ëª¨ë¸ëª…=${modelName}, í«ë„¤ì„=${petName}, ì¶”ì¶œëœì œì¡°ì‚¬=${manufacturer}`);
    }

    const safeModelId = modelId.replace(/[^a-zA-Z0-9ê°€-í£]/g, '_');
    const timestamp = Date.now();
    const ext = path.extname(req.file.originalname);
    const fileName = `${safeModelId}_${timestamp}${ext}`;

    console.log(`ğŸ“¤ [ìƒí’ˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ] Discord ì—…ë¡œë“œ ì‹œì‘: ${carrier} - ${modelId}`);

    // Discordì— ì´ë¯¸ì§€ ì—…ë¡œë“œ
    const fileBuffer = req.file.buffer;
    
    if (!fileBuffer) {
      console.error('âŒ [ìƒí’ˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ] íŒŒì¼ ë²„í¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return res.status(400).json({
        success: false,
        error: 'íŒŒì¼ ë°ì´í„°ë¥¼ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }

    discordResult = await uploadImageToDiscordForStore(fileBuffer, fileName, carrier, manufacturer);
    imageUrl = discordResult.imageUrl;

    console.log(`âœ… [ìƒí’ˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ] Discord ì—…ë¡œë“œ ì„±ê³µ: ${carrier} - ${modelId} - ${imageUrl}`);

    // memoryStorageë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ ë¡œì»¬ íŒŒì¼ ì‚­ì œ ë¶ˆí•„ìš”

    // imageUrlì´ ì—†ìœ¼ë©´ ì—ëŸ¬ ë°˜í™˜
    if (!imageUrl) {
      console.error('âŒ [ìƒí’ˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ] ì´ë¯¸ì§€ URLì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return res.status(500).json({
        success: false,
        error: 'ì´ë¯¸ì§€ URLì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }

    // ì§ì˜ì _ëª¨ë¸ì´ë¯¸ì§€ ì‹œíŠ¸ì— ì €ì¥/ì—…ë°ì´íŠ¸
    // ì»¬ëŸ¼ êµ¬ì¡°: í†µì‹ ì‚¬(A) | ëª¨ë¸ID(B) | ëª¨ë¸ëª…(C) | í«ë„¤ì„(D) | ì œì¡°ì‚¬(E) | ì´ë¯¸ì§€URL(F) | ë¹„ê³ (G) | ìƒ‰ìƒ(H) | Discordë©”ì‹œì§€ID(I) | Discordí¬ìŠ¤íŠ¸ID(J) | DiscordìŠ¤ë ˆë“œID(K)
    let sheetSaveSuccess = false;
    try {
      console.log(`ğŸ“ [ìƒí’ˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ] Google Sheetsì— ì €ì¥ ì‹œì‘: ${modelId}`);

      // í—¤ë” í™•ì¸ ë° ìƒì„±
      const directRoutes = require('./directRoutes');
      const { ensureSheetHeaders } = directRoutes;
      const { HEADERS_MOBILE_IMAGES } = require('./directRoutes');
      await ensureSheetHeaders(sheets, SPREADSHEET_ID, 'ì§ì˜ì _ëª¨ë¸ì´ë¯¸ì§€', HEADERS_MOBILE_IMAGES);

      // ê¸°ì¡´ ë°ì´í„° ì¡°íšŒ (A:K ë²”ìœ„)
      const imageResponse = await rateLimitedSheetsCall(() =>
        sheets.spreadsheets.values.get({
          spreadsheetId: SPREADSHEET_ID,
          range: 'ì§ì˜ì _ëª¨ë¸ì´ë¯¸ì§€!A:K'
        })
      );

      const imageValues = imageResponse.data.values || [];
      const rows = imageValues.slice(1); // í—¤ë” ì œì™¸

      // ê¸°ì¡´ í–‰ ì°¾ê¸°: í†µì‹ ì‚¬ + ëª¨ë¸ID(ëª¨ë¸ëª…) ì¡°í•©ìœ¼ë¡œ ì°¾ê¸°
      // ëª¨ë¸ID = ëª¨ë¸ëª…ìœ¼ë¡œ í†µì¼ë˜ì–´ ìˆìœ¼ë¯€ë¡œ, í†µì‹ ì‚¬ì™€ ëª¨ë¸ID ì¡°í•©ìœ¼ë¡œ ì°¾ìŒ
      // ğŸ”¥ ê°œì„ : ëª¨ë¸ëª… ì •ê·œí™” í•¨ìˆ˜ ì‚¬ìš©í•˜ì—¬ ë§¤ì¹­ ê°œì„ 
      const normalizeModelCode = (code) => {
        if (!code) return '';
        return code.trim()
          .replace(/\s+/g, '')
          .replace(/-/g, '')
          .toUpperCase();
      };

      const normalizedModelId = normalizeModelCode(modelId);
      const normalizedModelName = normalizeModelCode(modelName);

      const existingRowIndex = rows.findIndex(row => {
        const rowCarrier = (row[0] || '').trim();
        const rowModelId = (row[1] || '').trim(); // ëª¨ë¸ID (ì‹¤ì œ ëª¨ë¸ ì½”ë“œ)
        const rowModelName = (row[2] || '').trim(); // ëª¨ë¸ëª… (ë™ì¼)

        // í†µì‹ ì‚¬ê°€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
        if (rowCarrier !== carrier) return false;

        // ì •ê·œí™”ëœ ëª¨ë¸ ì½”ë“œë¡œ ë§¤ì¹­
        const normalizedRowModelId = normalizeModelCode(rowModelId);
        const normalizedRowModelName = normalizeModelCode(rowModelName);

        // ëª¨ë¸ID ë˜ëŠ” ëª¨ë¸ëª…ìœ¼ë¡œ ë§¤ì¹­ (ì •ê·œí™”ëœ ê°’ìœ¼ë¡œ ë¹„êµ)
        return (normalizedRowModelId === normalizedModelId || normalizedRowModelId === normalizedModelName ||
          normalizedRowModelName === normalizedModelId || normalizedRowModelName === normalizedModelName ||
          rowModelId === modelId || rowModelName === modelName);
      });

      // ê¸°ì¡´ í–‰ì´ ìˆìœ¼ë©´ ê¸°ì¡´ ìƒ‰ìƒ ê°’ ë³´ì¡´
      const existingRow = existingRowIndex !== -1 ? rows[existingRowIndex] : null;
      const existingColor = existingRow && existingRow[7] ? existingRow[7] : '';

      // 11ê°œ ì»¬ëŸ¼ ë°ì´í„° êµ¬ì„±: í†µì‹ ì‚¬ | ëª¨ë¸ID | ëª¨ë¸ëª… | í«ë„¤ì„ | ì œì¡°ì‚¬ | ì´ë¯¸ì§€URL | ë¹„ê³  | ìƒ‰ìƒ | Discordë©”ì‹œì§€ID | Discordí¬ìŠ¤íŠ¸ID | DiscordìŠ¤ë ˆë“œID
      const newRow = [
        carrier,                    // A: í†µì‹ ì‚¬
        modelId,                   // B: ëª¨ë¸ID (ì°¸ê³ ìš©, ë™ì ìœ¼ë¡œ ë³€í•  ìˆ˜ ìˆìŒ)
        modelName,                 // C: ëª¨ë¸ëª… (ì‹¤ì œ ì¡°íšŒ í‚¤)
        petName,                   // D: í«ë„¤ì„
        manufacturer,              // E: ì œì¡°ì‚¬
        imageUrl,                  // F: ì´ë¯¸ì§€URL
        '',                        // G: ë¹„ê³  (ë¹ˆ ê°’)
        existingColor,             // H: ìƒ‰ìƒ (ê¸°ì¡´ ê°’ ë³´ì¡´)
        discordResult.messageId || '',  // I: Discordë©”ì‹œì§€ID
        discordResult.postId || '',     // J: Discordí¬ìŠ¤íŠ¸ID
        discordResult.threadId || ''    // K: DiscordìŠ¤ë ˆë“œID
      ];

      if (existingRowIndex !== -1) {
        // ê¸°ì¡´ í–‰ ì—…ë°ì´íŠ¸
        console.log(`ğŸ“ [ìƒí’ˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ] ê¸°ì¡´ í–‰ ì—…ë°ì´íŠ¸: í–‰ ${existingRowIndex + 2}`);
        await rateLimitedSheetsCall(() =>
          sheets.spreadsheets.values.update({
            spreadsheetId: SPREADSHEET_ID,
            range: `ì§ì˜ì _ëª¨ë¸ì´ë¯¸ì§€!A${existingRowIndex + 2}:K${existingRowIndex + 2}`,
            valueInputOption: 'USER_ENTERED',
            resource: {
              values: [newRow]
            }
          })
        );
        sheetSaveSuccess = true;
        console.log(`âœ… [ìƒí’ˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ] Google Sheets ì—…ë°ì´íŠ¸ ì„±ê³µ`);
      } else {
        // ìƒˆ í–‰ ì¶”ê°€
        console.log(`ğŸ“ [ìƒí’ˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ] ìƒˆ í–‰ ì¶”ê°€`);
        await rateLimitedSheetsCall(() =>
          sheets.spreadsheets.values.append({
            spreadsheetId: SPREADSHEET_ID,
            range: 'ì§ì˜ì _ëª¨ë¸ì´ë¯¸ì§€!A:K',
            valueInputOption: 'USER_ENTERED',
            insertDataOption: 'INSERT_ROWS',
            resource: {
              values: [newRow]
            }
          })
        );
        sheetSaveSuccess = true;
        console.log(`âœ… [ìƒí’ˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ] Google Sheets ì¶”ê°€ ì„±ê³µ`);
      }

      // ğŸ”¥ í•µì‹¬ ê°œì„ : ì§ì˜ì _ë‹¨ë§ë§ˆìŠ¤í„° ì‹œíŠ¸ì—ë„ ì´ë¯¸ì§€ URL ì—…ë°ì´íŠ¸ (ì¬ë¹Œë“œ ì—†ì´ ì¦‰ì‹œ ë°˜ì˜)
      if (sheetSaveSuccess) {
        try {
          console.log(`ğŸ“ [ìƒí’ˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ] ì§ì˜ì _ë‹¨ë§ë§ˆìŠ¤í„° ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì‹œì‘: ${modelId}`);

          // ì§ì˜ì _ë‹¨ë§ë§ˆìŠ¤í„° ì‹œíŠ¸ì—ì„œ í•´ë‹¹ ëª¨ë¸ ì°¾ê¸°
          // í—¤ë” í™•ì¸ ë° ìƒì„±
          const { HEADERS_MOBILE_MASTER } = require('./directRoutes');
          await ensureSheetHeaders(sheets, SPREADSHEET_ID, 'ì§ì˜ì _ë‹¨ë§ë§ˆìŠ¤í„°', HEADERS_MOBILE_MASTER);

          const masterResponse = await rateLimitedSheetsCall(() =>
            sheets.spreadsheets.values.get({
              spreadsheetId: SPREADSHEET_ID,
              range: 'ì§ì˜ì _ë‹¨ë§ë§ˆìŠ¤í„°!A:R'
            })
          );

          const masterValues = masterResponse.data.values || [];
          const masterRows = masterValues.slice(1); // í—¤ë” ì œì™¸

          // ê¸°ì¡´ í–‰ ì°¾ê¸°: í†µì‹ ì‚¬ + ëª¨ë¸ID ë˜ëŠ” ëª¨ë¸ëª… ì¡°í•©ìœ¼ë¡œ ì°¾ê¸°
          // normalizeModelCode í•¨ìˆ˜ëŠ” ì´ë¯¸ ì „ì—­ìœ¼ë¡œ ì •ì˜ë˜ì–´ ìˆìŒ (ë¼ì¸ 4250)
          const normalizedModelId = normalizeModelCode(modelId);
          const normalizedModelName = normalizeModelCode(modelName);

          const existingMasterRowIndex = masterRows.findIndex(row => {
            const rowCarrier = (row[0] || '').trim();
            const rowModelId = (row[1] || '').trim(); // ëª¨ë¸ID
            const rowModelName = (row[2] || '').trim(); // ëª¨ë¸ëª…

            // í†µì‹ ì‚¬ê°€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
            if (rowCarrier !== carrier) return false;

            // ì •ê·œí™”ëœ ëª¨ë¸ ì½”ë“œë¡œ ë§¤ì¹­
            const normalizedRowModelId = normalizeModelCode(rowModelId);
            const normalizedRowModelName = normalizeModelCode(rowModelName);

            // ëª¨ë¸ID ë˜ëŠ” ëª¨ë¸ëª…ìœ¼ë¡œ ë§¤ì¹­ (ì •ê·œí™”ëœ ê°’ìœ¼ë¡œ ë¹„êµ)
            return (normalizedRowModelId === normalizedModelId || normalizedRowModelId === normalizedModelName ||
              normalizedRowModelName === normalizedModelId || normalizedRowModelName === normalizedModelName ||
              rowModelId === modelId || rowModelName === modelName);
          });

          if (existingMasterRowIndex !== -1) {
            // ì´ë¯¸ì§€URLì€ 13ë²ˆì§¸ ì»¬ëŸ¼(M) â†’ zero-based index 12
            // Discord ì •ë³´ëŠ” P, Q, R ì»¬ëŸ¼ (ì¸ë±ìŠ¤ 15, 16, 17)
            const targetRowNumber = existingMasterRowIndex + 2; // ë°ì´í„° ì‹œì‘ì´ 2í–‰
            const existingMasterRow = masterRows[existingMasterRowIndex];
            
            // ê¸°ì¡´ í–‰ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì´ë¯¸ì§€URLê³¼ Discord ì •ë³´ë§Œ ì—…ë°ì´íŠ¸)
            const updatedRow = [...existingMasterRow];
            updatedRow[12] = imageUrl;  // M: ì´ë¯¸ì§€URL
            updatedRow[15] = discordResult.messageId || '';  // P: Discordë©”ì‹œì§€ID
            updatedRow[16] = discordResult.postId || '';     // Q: Discordí¬ìŠ¤íŠ¸ID
            updatedRow[17] = discordResult.threadId || '';   // R: DiscordìŠ¤ë ˆë“œID
            
            await rateLimitedSheetsCall(() =>
              sheets.spreadsheets.values.update({
                spreadsheetId: SPREADSHEET_ID,
                range: `ì§ì˜ì _ë‹¨ë§ë§ˆìŠ¤í„°!A${targetRowNumber}:R${targetRowNumber}`,
                valueInputOption: 'USER_ENTERED',
                resource: { values: [updatedRow] }
              })
            );
            console.log(`âœ… [ìƒí’ˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ] ì§ì˜ì _ë‹¨ë§ë§ˆìŠ¤í„° ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì„±ê³µ: í–‰ ${targetRowNumber} (ì´ë¯¸ì§€URL + Discord ì •ë³´)`);
          } else {
            console.warn(`âš ï¸ [ìƒí’ˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ] ì§ì˜ì _ë‹¨ë§ë§ˆìŠ¤í„° ì‹œíŠ¸ì—ì„œ ëª¨ë¸ ${modelId} (${carrier})ì„(ë¥¼) ì°¾ì„ ìˆ˜ ì—†ì–´ ì´ë¯¸ì§€URLì„ ì—…ë°ì´íŠ¸í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.`);
          }
        } catch (masterSheetError) {
          console.error('âŒ [ìƒí’ˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ] ì§ì˜ì _ë‹¨ë§ë§ˆìŠ¤í„° ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', masterSheetError);
          // ì—ëŸ¬ê°€ ë°œìƒí•´ë„ ì´ë¯¸ì§€ ì—…ë¡œë“œëŠ” ì„±ê³µí–ˆìœ¼ë¯€ë¡œ ê³„ì† ì§„í–‰
        }
      }

      // êµ¬ê¸€ì‹œíŠ¸ ì €ì¥ ì™„ë£Œ í™•ì¸ í›„ ìºì‹œ ë¬´íš¨í™” (ì§ì˜ì  ëª¨ë“œ ìºì‹œ)
      // ì €ì¥ì´ ì™„ë£Œëœ í›„ì—ë§Œ ìºì‹œë¥¼ ë¬´íš¨í™”í•˜ì—¬ ìµœì‹  ë°ì´í„°ê°€ ë°˜ì˜ë˜ë„ë¡ í•¨
      if (sheetSaveSuccess) {
        try {
          const { invalidateDirectStoreCache } = require('./directRoutes');
          invalidateDirectStoreCache(carrier);
          console.log(`ğŸ”„ [ìƒí’ˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ] ìºì‹œ ë¬´íš¨í™” ì™„ë£Œ: í†µì‹ ì‚¬=${carrier} (êµ¬ê¸€ì‹œíŠ¸ ì €ì¥ ì™„ë£Œ í›„)`);
        } catch (cacheError) {
          console.warn('âš ï¸ [ìƒí’ˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ] ìºì‹œ ë¬´íš¨í™” ì‹¤íŒ¨ (ë¬´ì‹œ):', cacheError.message);
        }
      } else {
        console.warn('âš ï¸ [ìƒí’ˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ] êµ¬ê¸€ì‹œíŠ¸ ì €ì¥ ì‹¤íŒ¨ë¡œ ì¸í•´ ìºì‹œ ë¬´íš¨í™” ê±´ë„ˆëœ€');
      }
    } catch (sheetError) {
      console.error('âŒ [ìƒí’ˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ] Google Sheets ì €ì¥ ì˜¤ë¥˜:', sheetError);
      console.error('âŒ [ìƒí’ˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ] ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤:', sheetError.stack);

      // Discord ì—…ë¡œë“œëŠ” ì„±ê³µí–ˆì§€ë§Œ Google Sheets ì €ì¥ ì‹¤íŒ¨
      // ìµœì‹  ë°ì´í„° ë°˜ì˜ì„ ìœ„í•´ ìºì‹œëŠ” ë¬´íš¨í™” (ë‹¤ìŒ ìš”ì²­ ì‹œ êµ¬ê¸€ì‹œíŠ¸ì—ì„œ ë‹¤ì‹œ ì½ìŒ)
      try {
        const { invalidateDirectStoreCache } = require('./directRoutes');
        invalidateDirectStoreCache(carrier);
        console.log(`ğŸ”„ [ìƒí’ˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ] ìºì‹œ ë¬´íš¨í™” ì™„ë£Œ: í†µì‹ ì‚¬=${carrier} (êµ¬ê¸€ì‹œíŠ¸ ì €ì¥ ì‹¤íŒ¨ í›„ì—ë„ ë¬´íš¨í™”)`);
      } catch (cacheError) {
        console.warn('âš ï¸ [ìƒí’ˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ] ìºì‹œ ë¬´íš¨í™” ì‹¤íŒ¨ (ë¬´ì‹œ):', cacheError.message);
      }

      // ì‚¬ìš©ìì—ê²Œ ê²½ê³ ì™€ í•¨ê»˜ ì„±ê³µ ì‘ë‹µ ë°˜í™˜ (ì´ë¯¸ì§€ URLì€ ì‚¬ìš© ê°€ëŠ¥)
      const elapsedTime = Date.now() - startTime;
      console.warn(`âš ï¸ [ìƒí’ˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ] Discord ì—…ë¡œë“œëŠ” ì„±ê³µí–ˆì§€ë§Œ Google Sheets ì €ì¥ ì‹¤íŒ¨ (${elapsedTime}ms)`);

      return res.status(200).json({
        success: true,
        imageUrl: imageUrl,
        modelId: modelId,
        warning: 'Discordì—ëŠ” ì—…ë¡œë“œë˜ì—ˆì§€ë§Œ Google Sheets ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì´ë¯¸ì§€ URLì€ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.'
      });
    }

    const elapsedTime = Date.now() - startTime;
    console.log(`âœ… [ìƒí’ˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ] ì™„ë£Œ (${elapsedTime}ms) - Discord: ì„±ê³µ, Sheets: ${sheetSaveSuccess}`);

    return res.json({
      success: true,
      imageUrl: imageUrl,
      modelId: modelId
    });
  } catch (error) {
    const elapsedTime = Date.now() - startTime;
    console.error(`âŒ [ìƒí’ˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ] ì „ì²´ í”„ë¡œì„¸ìŠ¤ ì˜¤ë¥˜ (${elapsedTime}ms):`, error);
    console.error('âŒ [ìƒí’ˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ] ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤:', error.stack);

    // ë¡œì»¬ íŒŒì¼ ì‚­ì œ
    if (localFilePath && fs.existsSync(localFilePath)) {
      try {
        fs.unlinkSync(localFilePath);
      } catch (unlinkError) {
        console.error('íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨:', unlinkError);
      }
    }

    return res.status(500).json({
      success: false,
      error: `ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`,
      details: process.env.NODE_ENV === 'development' ? error.stack : undefined
    });
  }
});

// Discord ì´ë¯¸ì§€ URL ìœ íš¨ì„± ê²€ì¦ í•¨ìˆ˜
async function validateImageUrl(imageUrl, timeoutMs = 5000) {
  if (!imageUrl || !imageUrl.trim()) {
    return { valid: false, status: 'empty', error: 'URLì´ ì—†ìŠµë‹ˆë‹¤.' };
  }

  const https = require('https');
  const http = require('http');
  const url = require('url');

  return new Promise((resolve) => {
    try {
      const parsedUrl = new URL(imageUrl);
      const isHttps = parsedUrl.protocol === 'https:';
      const client = isHttps ? https : http;

      const options = {
        method: 'HEAD',
        timeout: timeoutMs,
        headers: {
          'User-Agent': 'Mozilla/5.0 (compatible; ImageValidator/1.0)'
        }
      };

      const req = client.request(imageUrl, options, (res) => {
        const statusCode = res.statusCode;
        if (statusCode >= 200 && statusCode < 400) {
          resolve({ valid: true, status: 'valid', statusCode });
        } else if (statusCode === 404) {
          resolve({ valid: false, status: 'expired', error: 'ì´ë¯¸ì§€ê°€ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤ (404)', statusCode });
        } else {
          resolve({ valid: false, status: 'error', error: `HTTP ${statusCode}`, statusCode });
        }
        res.destroy();
      });

      req.on('error', (error) => {
        if (error.code === 'ENOTFOUND' || error.code === 'ECONNREFUSED') {
          resolve({ valid: false, status: 'error', error: 'ì—°ê²° ì‹¤íŒ¨', code: error.code });
        } else if (error.code === 'ETIMEDOUT') {
          resolve({ valid: false, status: 'timeout', error: 'ìš”ì²­ ì‹œê°„ ì´ˆê³¼', code: error.code });
        } else {
          resolve({ valid: false, status: 'error', error: error.message, code: error.code });
        }
      });

      req.on('timeout', () => {
        req.destroy();
        resolve({ valid: false, status: 'timeout', error: 'ìš”ì²­ ì‹œê°„ ì´ˆê³¼' });
      });

      req.setTimeout(timeoutMs);
      req.end();
    } catch (error) {
      resolve({ valid: false, status: 'error', error: error.message });
    }
  });
}

// Discord ì´ë¯¸ì§€ URL ê°±ì‹  ê³µí†µ í•¨ìˆ˜
async function refreshDiscordImageUrl(threadId, messageId) {
  if (!DISCORD_LOGGING_ENABLED || !discordBot) {
    throw new Error('Discord ë´‡ì´ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
  }
  
  if (!discordBot.isReady()) {
    throw new Error('Discord ë´‡ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
  }
  
  if (!threadId || !messageId) {
    throw new Error('threadIdì™€ messageIdê°€ í•„ìš”í•©ë‹ˆë‹¤.');
  }
  
  const thread = await discordBot.channels.fetch(threadId);
  if (!thread) {
    throw new Error('í•´ë‹¹ ìŠ¤ë ˆë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  }
  
  const message = await thread.messages.fetch(messageId);
  if (!message) {
    throw new Error('í•´ë‹¹ ë©”ì‹œì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  }
  
  const attachment = message.attachments.first();
  if (!attachment) {
    throw new Error('ì²¨ë¶€íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  }
  
  return {
    imageUrl: attachment.url,
    messageId: message.id,
    threadId: thread.id
  };
}

// GET /api/discord/refresh-image-url: Discord ì´ë¯¸ì§€ URL ê°±ì‹  API
app.get('/api/discord/refresh-image-url', async (req, res) => {
  try {
    const { threadId, messageId } = req.query;
    const result = await refreshDiscordImageUrl(threadId, messageId);
    
    return res.json({
      success: true,
      ...result
    });
  } catch (error) {
    console.error('Discord URL ê°±ì‹  ì˜¤ë¥˜:', error);
    return res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

// POST /api/direct/refresh-mobile-image-url: ì§ì˜ì _ëª¨ë¸ì´ë¯¸ì§€ URL ê°±ì‹  ë° ì €ì¥
app.post('/api/direct/refresh-mobile-image-url', express.json(), async (req, res) => {
  try {
    const { carrier, modelId, modelName, threadId, messageId } = req.body;
    
    if (!carrier || !modelId || !threadId || !messageId) {
      return res.status(400).json({
        success: false,
        error: 'carrier, modelId, threadId, messageIdê°€ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }
    
    // Discordì—ì„œ ìµœì‹  URL ê°€ì ¸ì˜¤ê¸°
    const refreshResult = await refreshDiscordImageUrl(threadId, messageId);
    const newImageUrl = refreshResult.imageUrl;
    
    // ì§ì˜ì _ëª¨ë¸ì´ë¯¸ì§€ ì‹œíŠ¸ì—ì„œ í•´ë‹¹ í–‰ ì°¾ê¸° ë° ì—…ë°ì´íŠ¸
    const { HEADERS_MOBILE_IMAGES } = require('./directRoutes');
    const { ensureSheetHeaders } = require('./directRoutes');
    await ensureSheetHeaders(originalSheets, SPREADSHEET_ID, 'ì§ì˜ì _ëª¨ë¸ì´ë¯¸ì§€', HEADERS_MOBILE_IMAGES);
    
    const imageResponse = await rateLimitedSheetsCall(() =>
      originalSheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ì§ì˜ì _ëª¨ë¸ì´ë¯¸ì§€!A:K'
      })
    );
    
    const imageValues = imageResponse.data.values || [];
    const rows = imageValues.slice(1);
    
    // ëª¨ë¸ëª… ì •ê·œí™” í•¨ìˆ˜
    const normalizeModelCode = (code) => {
      if (!code) return '';
      return code.trim().replace(/\s+/g, '').replace(/-/g, '').toUpperCase();
    };
    
    const normalizedModelId = normalizeModelCode(modelId);
    const normalizedModelName = normalizeModelCode(modelName);
    
    const existingRowIndex = rows.findIndex(row => {
      const rowCarrier = (row[0] || '').trim();
      const rowModelId = (row[1] || '').trim();
      const rowModelName = (row[2] || '').trim();
      
      if (rowCarrier !== carrier) return false;
      
      const normalizedRowModelId = normalizeModelCode(rowModelId);
      const normalizedRowModelName = normalizeModelCode(rowModelName);
      
      return (normalizedRowModelId === normalizedModelId || normalizedRowModelId === normalizedModelName ||
        normalizedRowModelName === normalizedModelId || normalizedRowModelName === normalizedModelName ||
        rowModelId === modelId || rowModelName === modelName);
    });
    
    if (existingRowIndex === -1) {
      return res.status(404).json({
        success: false,
        error: 'í•´ë‹¹ ëª¨ë¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }
    
    // ê¸°ì¡´ í–‰ ì—…ë°ì´íŠ¸ (ì´ë¯¸ì§€ URLë§Œ ê°±ì‹ )
    const existingRow = rows[existingRowIndex];
    const updatedRow = [...existingRow];
    while (updatedRow.length < 11) {
      updatedRow.push('');
    }
    updatedRow[5] = newImageUrl; // F: ì´ë¯¸ì§€URL
    
    await rateLimitedSheetsCall(() =>
      originalSheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: `ì§ì˜ì _ëª¨ë¸ì´ë¯¸ì§€!A${existingRowIndex + 2}:K${existingRowIndex + 2}`,
        valueInputOption: 'USER_ENTERED',
        resource: { values: [updatedRow] }
      })
    );
    
    console.log(`âœ… [URL ê°±ì‹ ] ì§ì˜ì _ëª¨ë¸ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ ì™„ë£Œ: ${carrier} - ${modelId}`);
    
    return res.json({
      success: true,
      imageUrl: newImageUrl,
      messageId: refreshResult.messageId,
      threadId: refreshResult.threadId
    });
  } catch (error) {
    console.error('âŒ [URL ê°±ì‹ ] ì§ì˜ì _ëª¨ë¸ì´ë¯¸ì§€ ê°±ì‹  ì˜¤ë¥˜:', error);
    return res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

// POST /api/direct/refresh-master-image-url: ì§ì˜ì _ë‹¨ë§ë§ˆìŠ¤í„° URL ê°±ì‹  ë° ì €ì¥
app.post('/api/direct/refresh-master-image-url', express.json(), async (req, res) => {
  try {
    const { carrier, modelId, modelName, threadId, messageId } = req.body;
    
    if (!carrier || !modelId || !threadId || !messageId) {
      return res.status(400).json({
        success: false,
        error: 'carrier, modelId, threadId, messageIdê°€ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }
    
    // Discordì—ì„œ ìµœì‹  URL ê°€ì ¸ì˜¤ê¸°
    const refreshResult = await refreshDiscordImageUrl(threadId, messageId);
    const newImageUrl = refreshResult.imageUrl;
    
    // ì§ì˜ì _ë‹¨ë§ë§ˆìŠ¤í„° ì‹œíŠ¸ì—ì„œ í•´ë‹¹ í–‰ ì°¾ê¸° ë° ì—…ë°ì´íŠ¸
    const { HEADERS_MOBILE_MASTER } = require('./directRoutes');
    const { ensureSheetHeaders } = require('./directRoutes');
    await ensureSheetHeaders(originalSheets, SPREADSHEET_ID, 'ì§ì˜ì _ë‹¨ë§ë§ˆìŠ¤í„°', HEADERS_MOBILE_MASTER);
    
    const masterResponse = await rateLimitedSheetsCall(() =>
      originalSheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ì§ì˜ì _ë‹¨ë§ë§ˆìŠ¤í„°!A:R'
      })
    );
    
    const masterValues = masterResponse.data.values || [];
    const masterRows = masterValues.slice(1);
    
    // ëª¨ë¸ëª… ì •ê·œí™” í•¨ìˆ˜
    const normalizeModelCode = (code) => {
      if (!code) return '';
      return code.trim().replace(/\s+/g, '').replace(/-/g, '').toUpperCase();
    };
    
    const normalizedModelId = normalizeModelCode(modelId);
    const normalizedModelName = normalizeModelCode(modelName);
    
    const existingRowIndex = masterRows.findIndex(row => {
      const rowCarrier = (row[0] || '').trim();
      const rowModelId = (row[1] || '').trim();
      const rowModelName = (row[2] || '').trim();
      
      if (rowCarrier !== carrier) return false;
      
      const normalizedRowModelId = normalizeModelCode(rowModelId);
      const normalizedRowModelName = normalizeModelCode(rowModelName);
      
      return (normalizedRowModelId === normalizedModelId || normalizedRowModelId === normalizedModelName ||
        normalizedRowModelName === normalizedModelId || normalizedRowModelName === normalizedModelName ||
        rowModelId === modelId || rowModelName === modelName);
    });
    
    if (existingRowIndex === -1) {
      return res.status(404).json({
        success: false,
        error: 'í•´ë‹¹ ëª¨ë¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }
    
    // ê¸°ì¡´ í–‰ ì—…ë°ì´íŠ¸ (ì´ë¯¸ì§€ URLë§Œ ê°±ì‹ )
    const existingRow = masterRows[existingRowIndex];
    const updatedRow = [...existingRow];
    while (updatedRow.length < 18) {
      updatedRow.push('');
    }
    updatedRow[12] = newImageUrl; // M: ì´ë¯¸ì§€URL
    
    await rateLimitedSheetsCall(() =>
      originalSheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: `ì§ì˜ì _ë‹¨ë§ë§ˆìŠ¤í„°!A${existingRowIndex + 2}:R${existingRowIndex + 2}`,
        valueInputOption: 'USER_ENTERED',
        resource: { values: [updatedRow] }
      })
    );
    
    console.log(`âœ… [URL ê°±ì‹ ] ì§ì˜ì _ë‹¨ë§ë§ˆìŠ¤í„° ì—…ë°ì´íŠ¸ ì™„ë£Œ: ${carrier} - ${modelId}`);
    
    return res.json({
      success: true,
      imageUrl: newImageUrl,
      messageId: refreshResult.messageId,
      threadId: refreshResult.threadId
    });
  } catch (error) {
    console.error('âŒ [URL ê°±ì‹ ] ì§ì˜ì _ë‹¨ë§ë§ˆìŠ¤í„° ê°±ì‹  ì˜¤ë¥˜:', error);
    return res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

// POST /api/direct/refresh-store-photo-url: ì§ì˜ì _ë§¤ì¥ì‚¬ì§„ URL ê°±ì‹  ë° ì €ì¥
app.post('/api/direct/refresh-store-photo-url', express.json(), async (req, res) => {
  try {
    const { storeName, photoType, threadId, messageId } = req.body;
    
    if (!storeName || !photoType || !threadId || !messageId) {
      return res.status(400).json({
        success: false,
        error: 'storeName, photoType, threadId, messageIdê°€ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }
    
    // Discordì—ì„œ ìµœì‹  URL ê°€ì ¸ì˜¤ê¸°
    const refreshResult = await refreshDiscordImageUrl(threadId, messageId);
    const newImageUrl = refreshResult.imageUrl;
    
    // ì§ì˜ì _ë§¤ì¥ì‚¬ì§„ ì‹œíŠ¸ì—ì„œ í•´ë‹¹ í–‰ ì°¾ê¸° ë° ì—…ë°ì´íŠ¸
    const { ensureSheetHeaders } = require('./directRoutes');
    await ensureSheetHeaders(originalSheets, SPREADSHEET_ID, CUSTOMER_STORE_PHOTO_SHEET_NAME, HEADERS_STORE_PHOTO);
    
    const values = await getSheetValues(CUSTOMER_STORE_PHOTO_SHEET_NAME);
    const rowIndex = values ? values.findIndex(row => row[0] === storeName) : -1;
    
    if (rowIndex === -1) {
      return res.status(404).json({
        success: false,
        error: 'í•´ë‹¹ ë§¤ì¥ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }
    
    // photoTypeì— ë”°ë¥¸ ì»¬ëŸ¼ ì¸ë±ìŠ¤ ë§¤í•‘
    const photoTypeMap = {
      front: { url: 1, msgId: 2, postId: 3, threadId: 4 },
      inside: { url: 5, msgId: 6, postId: 7, threadId: 8 },
      outside: { url: 9, msgId: 10, postId: 11, threadId: 12 },
      outside2: { url: 13, msgId: 14, postId: 15, threadId: 16 },
      manager: { url: 17, msgId: 18, postId: 19, threadId: 20 },
      staff1: { url: 21, msgId: 22, postId: 23, threadId: 24 },
      staff2: { url: 25, msgId: 26, postId: 27, threadId: 28 },
      staff3: { url: 29, msgId: 30, postId: 31, threadId: 32 }
    };
    
    const photoMap = photoTypeMap[photoType];
    if (!photoMap) {
      return res.status(400).json({
        success: false,
        error: 'ì•Œ ìˆ˜ ì—†ëŠ” photoTypeì…ë‹ˆë‹¤.'
      });
    }
    
    // ê¸°ì¡´ í–‰ ì—…ë°ì´íŠ¸
    const existingRow = values[rowIndex];
    const updatedRow = [...existingRow];
    while (updatedRow.length < 34) {
      updatedRow.push('');
    }
    updatedRow[photoMap.url] = newImageUrl;
    updatedRow[photoMap.msgId] = refreshResult.messageId || '';
    updatedRow[photoMap.postId] = refreshResult.postId || '';
    updatedRow[photoMap.threadId] = refreshResult.threadId || '';
    updatedRow[33] = new Date().toISOString().replace('T', ' ').substring(0, 19);
    
    await rateLimitedSheetsCall(() =>
      originalSheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: `${CUSTOMER_STORE_PHOTO_SHEET_NAME}!A${rowIndex + 1}:AJ${rowIndex + 1}`,
        valueInputOption: 'USER_ENTERED',
        resource: { values: [updatedRow] }
      })
    );
    
    console.log(`âœ… [URL ê°±ì‹ ] ì§ì˜ì _ë§¤ì¥ì‚¬ì§„ ì—…ë°ì´íŠ¸ ì™„ë£Œ: ${storeName} - ${photoType}`);
    
    return res.json({
      success: true,
      imageUrl: newImageUrl,
      messageId: refreshResult.messageId,
      threadId: refreshResult.threadId
    });
  } catch (error) {
    console.error('âŒ [URL ê°±ì‹ ] ì§ì˜ì _ë§¤ì¥ì‚¬ì§„ ê°±ì‹  ì˜¤ë¥˜:', error);
    return res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

// GET /api/discord/image-monitoring: Discord ì´ë¯¸ì§€ URL ëª¨ë‹ˆí„°ë§ ë°ì´í„° ì¡°íšŒ
app.get('/api/discord/image-monitoring', async (req, res) => {
  try {
    // index.jsì—ì„œ ì‚¬ìš©í•˜ëŠ” ì „ì—­ sheetsì™€ SPREADSHEET_ID ì‚¬ìš©
    const sheets = originalSheets;
    const { type, validate } = req.query; // 'direct' ë˜ëŠ” 'meeting', validate: 'true'ë©´ URL ìœ íš¨ì„± ê²€ì¦ ìˆ˜í–‰
    const shouldValidate = validate === 'true';
    
    const monitoringData = {
      direct: {
        mobileImages: [],
        masterImages: [],
        storePhotos: []
      },
      meeting: {
        slides: []
      }
    };
    
    // URL ìœ íš¨ì„± ê²€ì¦ í—¬í¼ í•¨ìˆ˜ (ë³‘ë ¬ ì²˜ë¦¬)
    async function validateImageUrls(items, maxConcurrent = 10) {
      if (!shouldValidate || items.length === 0) {
        return items.map(item => ({ ...item, urlStatus: 'unknown' }));
      }

      const results = [];
      for (let i = 0; i < items.length; i += maxConcurrent) {
        const batch = items.slice(i, i + maxConcurrent);
        const batchResults = await Promise.all(
          batch.map(async (item) => {
            if (!item.imageUrl) {
              return { ...item, urlStatus: 'empty', urlValid: false };
            }
            const validation = await validateImageUrl(item.imageUrl);
            return {
              ...item,
              urlStatus: validation.status,
              urlValid: validation.valid,
              urlError: validation.error
            };
          })
        );
        results.push(...batchResults);
      }
      return results;
    }
    
    if (!type || type === 'direct') {
      // ì§ì˜ì _ëª¨ë¸ì´ë¯¸ì§€ ì¡°íšŒ
      const { HEADERS_MOBILE_IMAGES } = require('./directRoutes');
      const { ensureSheetHeaders } = require('./directRoutes');
      await ensureSheetHeaders(sheets, SPREADSHEET_ID, 'ì§ì˜ì _ëª¨ë¸ì´ë¯¸ì§€', HEADERS_MOBILE_IMAGES);
      
      const imageResponse = await rateLimitedSheetsCall(() =>
        sheets.spreadsheets.values.get({
          spreadsheetId: SPREADSHEET_ID,
          range: 'ì§ì˜ì _ëª¨ë¸ì´ë¯¸ì§€!A:K'
        })
      );
      
      const imageRows = (imageResponse.data.values || []).slice(1);
      const mobileImages = imageRows
        .filter(row => {
          const messageId = (row[8] || '').trim(); // I: Discordë©”ì‹œì§€ID
          const threadId = (row[10] || '').trim(); // K: DiscordìŠ¤ë ˆë“œID
          return messageId && threadId;
        })
        .map(row => ({
          carrier: (row[0] || '').trim(),
          modelId: (row[1] || '').trim(),
          modelName: (row[2] || '').trim(),
          petName: (row[3] || '').trim(),
          imageUrl: (row[5] || '').trim(),
          messageId: (row[8] || '').trim(),
          postId: (row[9] || '').trim(),
          threadId: (row[10] || '').trim()
        }));
      
      monitoringData.direct.mobileImages = await validateImageUrls(mobileImages);
      
      // ì§ì˜ì _ë‹¨ë§ë§ˆìŠ¤í„° ì¡°íšŒ
      const { HEADERS_MOBILE_MASTER } = require('./directRoutes');
      await ensureSheetHeaders(sheets, SPREADSHEET_ID, 'ì§ì˜ì _ë‹¨ë§ë§ˆìŠ¤í„°', HEADERS_MOBILE_MASTER);
      
      const masterResponse = await rateLimitedSheetsCall(() =>
        sheets.spreadsheets.values.get({
          spreadsheetId: SPREADSHEET_ID,
          range: 'ì§ì˜ì _ë‹¨ë§ë§ˆìŠ¤í„°!A:R'
        })
      );
      
      const masterRows = (masterResponse.data.values || []).slice(1);
      const masterImages = masterRows
        .filter(row => {
          const messageId = (row[15] || '').trim(); // P: Discordë©”ì‹œì§€ID
          const threadId = (row[17] || '').trim(); // R: DiscordìŠ¤ë ˆë“œID
          return messageId && threadId;
        })
        .map(row => ({
          carrier: (row[0] || '').trim(),
          modelId: (row[1] || '').trim(),
          modelName: (row[2] || '').trim(),
          petName: (row[3] || '').trim(),
          imageUrl: (row[12] || '').trim(),
          messageId: (row[15] || '').trim(),
          postId: (row[16] || '').trim(),
          threadId: (row[17] || '').trim()
        }));
      
      monitoringData.direct.masterImages = await validateImageUrls(masterImages);
      
      // ì§ì˜ì _ë§¤ì¥ì‚¬ì§„ ì¡°íšŒ
      const { ensureSheetHeaders: ensureHeaders } = require('./directRoutes');
      await ensureHeaders(sheets, SPREADSHEET_ID, CUSTOMER_STORE_PHOTO_SHEET_NAME, HEADERS_STORE_PHOTO);
      
      const storePhotoResponse = await rateLimitedSheetsCall(() =>
        sheets.spreadsheets.values.get({
          spreadsheetId: SPREADSHEET_ID,
          range: `${CUSTOMER_STORE_PHOTO_SHEET_NAME}!A:AH`
        })
      );
      
      const storePhotoRows = (storePhotoResponse.data.values || []).slice(1);
      const photoTypes = ['front', 'inside', 'outside', 'outside2', 'manager', 'staff1', 'staff2', 'staff3'];
      const photoTypeMap = {
        front: { url: 1, msgId: 2, postId: 3, threadId: 4 },
        inside: { url: 5, msgId: 6, postId: 7, threadId: 8 },
        outside: { url: 9, msgId: 10, postId: 11, threadId: 12 },
        outside2: { url: 13, msgId: 14, postId: 15, threadId: 16 },
        manager: { url: 17, msgId: 18, postId: 19, threadId: 20 },
        staff1: { url: 21, msgId: 22, postId: 23, threadId: 24 },
        staff2: { url: 25, msgId: 26, postId: 27, threadId: 28 },
        staff3: { url: 29, msgId: 30, postId: 31, threadId: 32 }
      };
      
      const storePhotos = [];
      storePhotoRows.forEach(row => {
        const storeName = (row[0] || '').trim();
        photoTypes.forEach(photoType => {
          const map = photoTypeMap[photoType];
          const messageId = (row[map.msgId] || '').trim();
          const threadId = (row[map.threadId] || '').trim();
          if (messageId && threadId) {
            storePhotos.push({
              storeName,
              photoType,
              imageUrl: (row[map.url] || '').trim(),
              messageId,
              postId: (row[map.postId] || '').trim(),
              threadId
            });
          }
        });
      });
      
      monitoringData.direct.storePhotos = await validateImageUrls(storePhotos);
    }
    
    if (!type || type === 'meeting') {
      // íšŒì˜ëª©ë¡ ì¡°íšŒ
      const meetingResponse = await rateLimitedSheetsCall(() =>
        sheets.spreadsheets.values.get({
          spreadsheetId: SPREADSHEET_ID,
          range: 'íšŒì˜ëª©ë¡!A:W'
        })
      );
      
      const meetingRows = (meetingResponse.data.values || []).slice(1);
      const slides = meetingRows
        .filter(row => {
          const messageId = (row[14] || '').trim(); // O: Discordë©”ì‹œì§€ID
          const threadId = (row[13] || '').trim(); // N: DiscordìŠ¤ë ˆë“œID
          return messageId && threadId && (row[9] || '').trim(); // ì´ë¯¸ì§€URLì´ ìˆëŠ” ê²½ìš°ë§Œ
        })
        .map(row => ({
          meetingId: (row[0] || '').trim(),
          slideId: (row[1] || '').trim(),
          title: (row[6] || '').trim(),
          imageUrl: (row[9] || '').trim(),
          messageId: (row[14] || '').trim(),
          postId: (row[12] || '').trim(),
          threadId: (row[13] || '').trim(),
          meetingDate: (row[18] || '').trim(),
          meetingNumber: (row[19] || '').trim()
        }));
      
      monitoringData.meeting.slides = await validateImageUrls(slides);
    }
    
    return res.json({
      success: true,
      data: monitoringData
    });
  } catch (error) {
    console.error('Discord ì´ë¯¸ì§€ ëª¨ë‹ˆí„°ë§ ë°ì´í„° ì¡°íšŒ ì˜¤ë¥˜:', error);
    return res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

// ë°°ì¹˜ ê°±ì‹  ë¡œì§ì„ ì¬ì‚¬ìš© ê°€ëŠ¥í•œ í•¨ìˆ˜ë¡œ ë¶„ë¦¬
async function processBatchRefreshItems(items) {
  const results = [];
  
  // ë°°ì¹˜ í¬ê¸° ì œí•œ: í•œ ë²ˆì— 5ê°œì”© ì²˜ë¦¬ (Rate Limit ê³ ë ¤)
  const BATCH_SIZE = 5;
  const ITEM_DELAY_MS = 2000; // í•­ëª© ê°„ ì§€ì—° (2ì´ˆ) - API í˜¸ì¶œ ê°„ê²© ê³ ë ¤
  const BATCH_DELAY_MS = 5000; // ë°°ì¹˜ ê°„ ì§€ì—° (5ì´ˆ) - Rate Limit íšŒë³µ ì‹œê°„ ê³ ë ¤
  
  // ì „ì²´ í•­ëª©ì„ ë°°ì¹˜ë¡œ ë‚˜ëˆ„ê¸°
  for (let i = 0; i < items.length; i += BATCH_SIZE) {
    const batch = items.slice(i, i + BATCH_SIZE);
    const batchNumber = Math.floor(i / BATCH_SIZE) + 1;
    const totalBatches = Math.ceil(items.length / BATCH_SIZE);
    
    console.log(`ğŸ”„ [ë°°ì¹˜ ê°±ì‹ ] ë°°ì¹˜ ${batchNumber}/${totalBatches} ì²˜ë¦¬ ì‹œì‘ (${batch.length}ê°œ í•­ëª©)`);
    
    // ë°°ì¹˜ ë‚´ í•­ëª© ì²˜ë¦¬
    for (let j = 0; j < batch.length; j++) {
      const item = batch[j];
      
      // ì²« ë²ˆì§¸ í•­ëª©ì´ ì•„ë‹ˆë©´ ì§€ì—° ì¶”ê°€
      if (j > 0) {
        await new Promise(resolve => setTimeout(resolve, ITEM_DELAY_MS));
      }
      
      try {
        const { type, threadId, messageId } = item;
        
        // Discord snowflake í˜•ì‹ ê²€ì¦ í•¨ìˆ˜
        const isValidSnowflake = (value) => {
          if (!value) return false;
          const str = value.toString().trim();
          return /^\d{17,19}$/.test(str);
        };
        
        if (!type || !threadId || !messageId) {
          results.push({
            success: false,
            error: 'type, threadId, messageIdê°€ í•„ìš”í•©ë‹ˆë‹¤.',
            item
          });
          continue;
        }
        
        // threadIdì™€ messageIdê°€ ìœ íš¨í•œ snowflake í˜•ì‹ì¸ì§€ ê²€ì¦
        if (!isValidSnowflake(threadId) || !isValidSnowflake(messageId)) {
          console.warn(`âš ï¸ [ë°°ì¹˜ ê°±ì‹ ] ì˜ëª»ëœ Discord ID í˜•ì‹: threadId=${threadId}, messageId=${messageId}, type=${type}`);
          results.push({
            success: false,
            error: `ì˜ëª»ëœ Discord ID í˜•ì‹: threadIdë‚˜ messageIdê°€ snowflake í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.`,
            type,
            item
          });
          continue;
        }
        
        // íƒ€ì…ì— ë”°ë¼ ì§ì ‘ ë¡œì§ í˜¸ì¶œ (ë‚´ë¶€ fetch ëŒ€ì‹ )
        if (type === 'mobile-image') {
          const { carrier, modelId, modelName } = item;
          try {
            // Discordì—ì„œ ìµœì‹  URL ê°€ì ¸ì˜¤ê¸°
            const refreshResult = await refreshDiscordImageUrl(threadId, messageId);
            const newImageUrl = refreshResult.imageUrl;
            
            // ì§ì˜ì _ëª¨ë¸ì´ë¯¸ì§€ ì‹œíŠ¸ì—ì„œ í•´ë‹¹ í–‰ ì°¾ê¸° ë° ì—…ë°ì´íŠ¸
            const { HEADERS_MOBILE_IMAGES } = require('./directRoutes');
            const { ensureSheetHeaders } = require('./directRoutes');
            await ensureSheetHeaders(originalSheets, SPREADSHEET_ID, 'ì§ì˜ì _ëª¨ë¸ì´ë¯¸ì§€', HEADERS_MOBILE_IMAGES);
            
            const imageResponse = await rateLimitedSheetsCall(() =>
              originalSheets.spreadsheets.values.get({
                spreadsheetId: SPREADSHEET_ID,
                range: 'ì§ì˜ì _ëª¨ë¸ì´ë¯¸ì§€!A:K'
              })
            );
            
            const imageValues = imageResponse.data.values || [];
            const rows = imageValues.slice(1);
            
            // ëª¨ë¸ëª… ì •ê·œí™” í•¨ìˆ˜
            const normalizeModelCode = (code) => {
              if (!code) return '';
              return code.trim().replace(/\s+/g, '').replace(/-/g, '').toUpperCase();
            };
            
            const normalizedModelId = normalizeModelCode(modelId);
            const normalizedModelName = normalizeModelCode(modelName);
            
            const existingRowIndex = rows.findIndex(row => {
              const rowCarrier = (row[0] || '').trim();
              const rowModelId = (row[1] || '').trim();
              const rowModelName = (row[2] || '').trim();
              
              if (rowCarrier !== carrier) return false;
              
              const normalizedRowModelId = normalizeModelCode(rowModelId);
              const normalizedRowModelName = normalizeModelCode(rowModelName);
              
              return (normalizedRowModelId === normalizedModelId || normalizedRowModelId === normalizedModelName ||
                normalizedRowModelName === normalizedModelId || normalizedRowModelName === normalizedModelName ||
                rowModelId === modelId || rowModelName === modelName);
            });
            
            if (existingRowIndex === -1) {
              throw new Error('í•´ë‹¹ ëª¨ë¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
            
            // ê¸°ì¡´ í–‰ ì—…ë°ì´íŠ¸ (ì´ë¯¸ì§€ URLë§Œ ê°±ì‹ )
            const existingRow = rows[existingRowIndex];
            const updatedRow = [...existingRow];
            while (updatedRow.length < 11) {
              updatedRow.push('');
            }
            updatedRow[5] = newImageUrl; // F: ì´ë¯¸ì§€URL
            
            await rateLimitedSheetsCall(() =>
              originalSheets.spreadsheets.values.update({
                spreadsheetId: SPREADSHEET_ID,
                range: `ì§ì˜ì _ëª¨ë¸ì´ë¯¸ì§€!A${existingRowIndex + 2}:K${existingRowIndex + 2}`,
                valueInputOption: 'USER_ENTERED',
                resource: { values: [updatedRow] }
              })
            );
            
            console.log(`âœ… [ë°°ì¹˜ ê°±ì‹ ] ì§ì˜ì _ëª¨ë¸ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ ì™„ë£Œ: ${carrier} - ${modelId}`);
            
            results.push({
              success: true,
              imageUrl: newImageUrl,
              messageId: refreshResult.messageId,
              threadId: refreshResult.threadId,
              type,
              item
            });
          } catch (err) {
            console.error(`âŒ [ë°°ì¹˜ ê°±ì‹ ] ì§ì˜ì _ëª¨ë¸ì´ë¯¸ì§€ ê°±ì‹  ì˜¤ë¥˜: ${carrier} - ${modelId}`, err);
            results.push({
              success: false,
              error: err.message,
              type,
              item
            });
          }
        } else if (type === 'master-image') {
          const { carrier, modelId, modelName } = item;
          try {
            // Discordì—ì„œ ìµœì‹  URL ê°€ì ¸ì˜¤ê¸°
            const refreshResult = await refreshDiscordImageUrl(threadId, messageId);
            const newImageUrl = refreshResult.imageUrl;
            
            // ì§ì˜ì _ë‹¨ë§ë§ˆìŠ¤í„° ì‹œíŠ¸ì—ì„œ í•´ë‹¹ í–‰ ì°¾ê¸° ë° ì—…ë°ì´íŠ¸
            const { HEADERS_MOBILE_MASTER } = require('./directRoutes');
            const { ensureSheetHeaders } = require('./directRoutes');
            await ensureSheetHeaders(originalSheets, SPREADSHEET_ID, 'ì§ì˜ì _ë‹¨ë§ë§ˆìŠ¤í„°', HEADERS_MOBILE_MASTER);
            
            const masterResponse = await rateLimitedSheetsCall(() =>
              originalSheets.spreadsheets.values.get({
                spreadsheetId: SPREADSHEET_ID,
                range: 'ì§ì˜ì _ë‹¨ë§ë§ˆìŠ¤í„°!A:R'
              })
            );
            
            const masterValues = masterResponse.data.values || [];
            const masterRows = masterValues.slice(1);
            
            // ëª¨ë¸ëª… ì •ê·œí™” í•¨ìˆ˜
            const normalizeModelCode = (code) => {
              if (!code) return '';
              return code.trim().replace(/\s+/g, '').replace(/-/g, '').toUpperCase();
            };
            
            const normalizedModelId = normalizeModelCode(modelId);
            const normalizedModelName = normalizeModelCode(modelName);
            
            const existingRowIndex = masterRows.findIndex(row => {
              const rowCarrier = (row[0] || '').trim();
              const rowModelId = (row[1] || '').trim();
              const rowModelName = (row[2] || '').trim();
              
              if (rowCarrier !== carrier) return false;
              
              const normalizedRowModelId = normalizeModelCode(rowModelId);
              const normalizedRowModelName = normalizeModelCode(rowModelName);
              
              return (normalizedRowModelId === normalizedModelId || normalizedRowModelId === normalizedModelName ||
                normalizedRowModelName === normalizedModelId || normalizedRowModelName === normalizedModelName ||
                rowModelId === modelId || rowModelName === modelName);
            });
            
            if (existingRowIndex === -1) {
              throw new Error('í•´ë‹¹ ëª¨ë¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
            
            // ê¸°ì¡´ í–‰ ì—…ë°ì´íŠ¸ (ì´ë¯¸ì§€ URLë§Œ ê°±ì‹ )
            const existingRow = masterRows[existingRowIndex];
            const updatedRow = [...existingRow];
            while (updatedRow.length < 18) {
              updatedRow.push('');
            }
            updatedRow[12] = newImageUrl; // M: ì´ë¯¸ì§€URL
            
            await rateLimitedSheetsCall(() =>
              originalSheets.spreadsheets.values.update({
                spreadsheetId: SPREADSHEET_ID,
                range: `ì§ì˜ì _ë‹¨ë§ë§ˆìŠ¤í„°!A${existingRowIndex + 2}:R${existingRowIndex + 2}`,
                valueInputOption: 'USER_ENTERED',
                resource: { values: [updatedRow] }
              })
            );
            
            console.log(`âœ… [ë°°ì¹˜ ê°±ì‹ ] ì§ì˜ì _ë‹¨ë§ë§ˆìŠ¤í„° ì—…ë°ì´íŠ¸ ì™„ë£Œ: ${carrier} - ${modelId}`);
            
            results.push({
              success: true,
              imageUrl: newImageUrl,
              messageId: refreshResult.messageId,
              threadId: refreshResult.threadId,
              type,
              item
            });
          } catch (err) {
            console.error(`âŒ [ë°°ì¹˜ ê°±ì‹ ] ì§ì˜ì _ë‹¨ë§ë§ˆìŠ¤í„° ê°±ì‹  ì˜¤ë¥˜: ${carrier} - ${modelId}`, err);
            results.push({
              success: false,
              error: err.message,
              type,
              item
            });
          }
        } else if (type === 'store-photo') {
          const { storeName, photoType } = item;
          try {
            // Discordì—ì„œ ìµœì‹  URL ê°€ì ¸ì˜¤ê¸°
            const refreshResult = await refreshDiscordImageUrl(threadId, messageId);
            const newImageUrl = refreshResult.imageUrl;
            
            // ì§ì˜ì _ë§¤ì¥ì‚¬ì§„ ì‹œíŠ¸ì—ì„œ í•´ë‹¹ í–‰ ì°¾ê¸° ë° ì—…ë°ì´íŠ¸
            const { ensureSheetHeaders } = require('./directRoutes');
            await ensureSheetHeaders(originalSheets, SPREADSHEET_ID, CUSTOMER_STORE_PHOTO_SHEET_NAME, HEADERS_STORE_PHOTO);
            
            const values = await getSheetValues(CUSTOMER_STORE_PHOTO_SHEET_NAME);
            const rowIndex = values ? values.findIndex(row => row[0] === storeName) : -1;
            
            if (rowIndex === -1) {
              throw new Error('í•´ë‹¹ ë§¤ì¥ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
            
            // photoTypeì— ë”°ë¥¸ ì»¬ëŸ¼ ì¸ë±ìŠ¤ ë§¤í•‘
            const photoTypeMap = {
              front: { url: 1, msgId: 2, postId: 3, threadId: 4 },
              inside: { url: 5, msgId: 6, postId: 7, threadId: 8 },
              outside: { url: 9, msgId: 10, postId: 11, threadId: 12 },
              outside2: { url: 13, msgId: 14, postId: 15, threadId: 16 },
              manager: { url: 17, msgId: 18, postId: 19, threadId: 20 },
              staff1: { url: 21, msgId: 22, postId: 23, threadId: 24 },
              staff2: { url: 25, msgId: 26, postId: 27, threadId: 28 },
              staff3: { url: 29, msgId: 30, postId: 31, threadId: 32 }
            };
            
            const photoMap = photoTypeMap[photoType];
            if (!photoMap) {
              throw new Error('ì•Œ ìˆ˜ ì—†ëŠ” photoTypeì…ë‹ˆë‹¤.');
            }
            
            // ê¸°ì¡´ í–‰ ì—…ë°ì´íŠ¸
            const existingRow = values[rowIndex];
            const updatedRow = [...existingRow];
            while (updatedRow.length < 34) {
              updatedRow.push('');
            }
            updatedRow[photoMap.url] = newImageUrl;
            updatedRow[photoMap.msgId] = refreshResult.messageId || '';
            updatedRow[photoMap.postId] = refreshResult.postId || '';
            updatedRow[photoMap.threadId] = refreshResult.threadId || '';
            updatedRow[33] = new Date().toISOString().replace('T', ' ').substring(0, 19);
            
            await rateLimitedSheetsCall(() =>
              originalSheets.spreadsheets.values.update({
                spreadsheetId: SPREADSHEET_ID,
                range: `${CUSTOMER_STORE_PHOTO_SHEET_NAME}!A${rowIndex + 1}:AJ${rowIndex + 1}`,
                valueInputOption: 'USER_ENTERED',
                resource: { values: [updatedRow] }
              })
            );
            
            console.log(`âœ… [ë°°ì¹˜ ê°±ì‹ ] ì§ì˜ì _ë§¤ì¥ì‚¬ì§„ ì—…ë°ì´íŠ¸ ì™„ë£Œ: ${storeName} - ${photoType}`);
            
            results.push({
              success: true,
              imageUrl: newImageUrl,
              messageId: refreshResult.messageId,
              threadId: refreshResult.threadId,
              type,
              item
            });
          } catch (err) {
            console.error(`âŒ [ë°°ì¹˜ ê°±ì‹ ] ì§ì˜ì _ë§¤ì¥ì‚¬ì§„ ê°±ì‹  ì˜¤ë¥˜: ${storeName} - ${photoType}`, err);
            results.push({
              success: false,
              error: err.message,
              type,
              item
            });
          }
        } else if (type === 'meeting-slide') {
          // íšŒì˜ ìŠ¬ë¼ì´ë“œ URL ê°±ì‹ 
          const { meetingId, slideId } = item;
          if (!meetingId || !slideId) {
            results.push({
              success: false,
              error: 'meetingId, slideIdê°€ í•„ìš”í•©ë‹ˆë‹¤.',
              type,
              item
            });
            continue;
          }
          
          try {
            // Discordì—ì„œ ìµœì‹  URL ê°€ì ¸ì˜¤ê¸°
            const refreshResult = await refreshDiscordImageUrl(threadId, messageId);
            const newImageUrl = refreshResult.imageUrl;
            
            // íšŒì˜ëª©ë¡ ì‹œíŠ¸ì—ì„œ í•´ë‹¹ ìŠ¬ë¼ì´ë“œ ì°¾ê¸° ë° ì—…ë°ì´íŠ¸
            // ensureSheetHeadersëŠ” directRoutesì— ìˆì§€ë§Œ, meetingRoutesì—ë„ ìˆì„ ìˆ˜ ìˆìŒ
            // ì¼ë‹¨ ì§ì ‘ ì‹œíŠ¸ë¥¼ ì½ì–´ì„œ í™•ì¸
            const meetingResponse = await rateLimitedSheetsCall(() =>
              originalSheets.spreadsheets.values.get({
                spreadsheetId: SPREADSHEET_ID,
                range: 'íšŒì˜ëª©ë¡!A:W'
              })
            );
            
            const meetingRows = (meetingResponse.data.values || []).slice(1);
            const rowIndex = meetingRows.findIndex(row => 
              (row[0] || '').trim() === meetingId && 
              (row[1] || '').trim() === slideId
            );
            
            if (rowIndex === -1) {
              results.push({
                success: false,
                error: 'í•´ë‹¹ ìŠ¬ë¼ì´ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
                type,
                item
              });
              continue;
            }
            
            // ê¸°ì¡´ í–‰ ì—…ë°ì´íŠ¸ (ì´ë¯¸ì§€ URLë§Œ ê°±ì‹ )
            const existingRow = meetingRows[rowIndex];
            const updatedRow = [...existingRow];
            while (updatedRow.length < 23) {
              updatedRow.push('');
            }
            updatedRow[9] = newImageUrl; // J: ì´ë¯¸ì§€URL
            updatedRow[14] = refreshResult.messageId || ''; // O: Discordë©”ì‹œì§€ID
            updatedRow[13] = refreshResult.threadId || ''; // N: DiscordìŠ¤ë ˆë“œID
            updatedRow[12] = refreshResult.postId || refreshResult.threadId || ''; // M: Discordí¬ìŠ¤íŠ¸ID
          
          await rateLimitedSheetsCall(() =>
            originalSheets.spreadsheets.values.update({
              spreadsheetId: SPREADSHEET_ID,
              range: `íšŒì˜ëª©ë¡!A${rowIndex + 2}:W${rowIndex + 2}`,
              valueInputOption: 'USER_ENTERED',
              resource: { values: [updatedRow] }
            })
          );
          
            console.log(`âœ… [URL ê°±ì‹ ] íšŒì˜ ìŠ¬ë¼ì´ë“œ ì—…ë°ì´íŠ¸ ì™„ë£Œ: ${meetingId} - ${slideId}`);
            
            results.push({
              success: true,
              imageUrl: newImageUrl,
              messageId: refreshResult.messageId,
              threadId: refreshResult.threadId,
              type,
              item
            });
          } catch (err) {
            console.error(`âŒ [ë°°ì¹˜ ê°±ì‹ ] íšŒì˜ ìŠ¬ë¼ì´ë“œ ê°±ì‹  ì˜¤ë¥˜: ${meetingId} - ${slideId}`, err);
            results.push({
              success: false,
              error: err.message,
              type,
              item
            });
          }
        } else {
          results.push({
            success: false,
            error: `ì•Œ ìˆ˜ ì—†ëŠ” íƒ€ì…: ${type}`,
            type,
            item
          });
        }
      } catch (error) {
        results.push({
          success: false,
          error: error.message,
          item
        });
      }
    }
    
    // ë°°ì¹˜ ê°„ ì§€ì—° (ë§ˆì§€ë§‰ ë°°ì¹˜ê°€ ì•„ë‹ˆë©´)
    if (i + BATCH_SIZE < items.length) {
      console.log(`â³ [ë°°ì¹˜ ê°±ì‹ ] ë°°ì¹˜ ${batchNumber} ì™„ë£Œ, ${BATCH_DELAY_MS}ms ëŒ€ê¸° í›„ ë‹¤ìŒ ë°°ì¹˜ ì§„í–‰...`);
      await new Promise(resolve => setTimeout(resolve, BATCH_DELAY_MS));
    } else {
      console.log(`âœ… [ë°°ì¹˜ ê°±ì‹ ] ë°°ì¹˜ ${batchNumber} ì™„ë£Œ (ë§ˆì§€ë§‰ ë°°ì¹˜)`);
    }
  }
  
  return results;
}

// POST /api/discord/batch-refresh-urls: ì—¬ëŸ¬ ì´ë¯¸ì§€ URL ì¼ê´„ ê°±ì‹ 
app.post('/api/discord/batch-refresh-urls', express.json(), async (req, res) => {
  try {
    const { items } = req.body; // [{ type, ...params }]
    
    if (!Array.isArray(items) || items.length === 0) {
      return res.status(400).json({
        success: false,
        error: 'items ë°°ì—´ì´ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }
    
    const results = await processBatchRefreshItems(items);
    const successCount = results.filter(r => r.success).length;
    const failCount = results.length - successCount;
    
    return res.json({
      success: true,
      total: results.length,
      successCount,
      failCount,
      results
    });
  } catch (error) {
    console.error('ì¼ê´„ URL ê°±ì‹  ì˜¤ë¥˜:', error);
    return res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

// POST /api/direct/upload-transition-page-image: ì—°ê²°í˜ì´ì§€ ì´ë¯¸ì§€ ì—…ë¡œë“œ (Discord)
app.post('/api/direct/upload-transition-page-image', directStoreUpload.single('image'), async (req, res) => {
  const startTime = Date.now();
  let imageUrl = null;
  let discordUploadSuccess = false;

  try {
    console.log('ğŸ“¤ [ì—°ê²°í˜ì´ì§€ ì´ë¯¸ì§€ ì—…ë¡œë“œ] ìš”ì²­ ì‹œì‘');

    if (!req.file) {
      console.error('âŒ [ì—°ê²°í˜ì´ì§€ ì´ë¯¸ì§€ ì—…ë¡œë“œ] íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
      return res.status(400).json({
        success: false,
        error: 'ì´ë¯¸ì§€ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.'
      });
    }

    const file = req.file;
    const carrier = req.body.carrier || 'SK';
    const category = req.body.category || 'premium';

    console.log(`ğŸ“¤ [ì—°ê²°í˜ì´ì§€ ì´ë¯¸ì§€ ì—…ë¡œë“œ] í†µì‹ ì‚¬: ${carrier}, ì¹´í…Œê³ ë¦¬: ${category}, íŒŒì¼ëª…: ${file.originalname}, í¬ê¸°: ${file.size} bytes`);

    // Discord ë´‡ ì´ˆê¸°í™” í™•ì¸
    if (!DISCORD_LOGGING_ENABLED || !discordBot) {
      console.error('âŒ [ì—°ê²°í˜ì´ì§€ ì´ë¯¸ì§€ ì—…ë¡œë“œ] Discord ë´‡ì´ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
      return res.status(500).json({
        success: false,
        error: 'Discord ë´‡ì´ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'
      });
    }

    // Discord ë´‡ì´ ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸°
    if (!discordBot.isReady()) {
      console.log('â³ [ì—°ê²°í˜ì´ì§€ ì´ë¯¸ì§€ ì—…ë¡œë“œ] Discord ë´‡ ì¤€ë¹„ ëŒ€ê¸° ì¤‘...');
      for (let i = 0; i < 10; i++) {
        if (discordBot.isReady()) break;
        await new Promise(resolve => setTimeout(resolve, 1000));
      }
    }

    if (!discordBot.isReady()) {
      console.error('âŒ [ì—°ê²°í˜ì´ì§€ ì´ë¯¸ì§€ ì—…ë¡œë“œ] Discord ë´‡ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
      return res.status(500).json({
        success: false,
        error: 'Discord ë´‡ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'
      });
    }

    // í¬ëŸ¼ ì±„ë„ ê°€ì ¸ì˜¤ê¸°
    const forumChannelId = DISCORD_STORE_FORUM_CHANNEL_ID;

    if (!forumChannelId) {
      console.error('âŒ [ì—°ê²°í˜ì´ì§€ ì´ë¯¸ì§€ ì—…ë¡œë“œ] Discord í¬ëŸ¼ ì±„ë„ IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
      return res.status(500).json({
        success: false,
        error: 'Discord í¬ëŸ¼ ì±„ë„ IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'
      });
    }

    let forumChannel;
    try {
      forumChannel = await discordBot.channels.fetch(forumChannelId);
    } catch (fetchError) {
      console.error(`âŒ [ì—°ê²°í˜ì´ì§€ ì´ë¯¸ì§€ ì—…ë¡œë“œ] Discord í¬ëŸ¼ ì±„ë„ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:`, fetchError);
      return res.status(500).json({
        success: false,
        error: `Discord í¬ëŸ¼ ì±„ë„ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${fetchError.message}`
      });
    }

    if (!forumChannel) {
      console.error(`âŒ [ì—°ê²°í˜ì´ì§€ ì´ë¯¸ì§€ ì—…ë¡œë“œ] Discord í¬ëŸ¼ ì±„ë„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${forumChannelId}`);
      return res.status(500).json({
        success: false,
        error: `Discord í¬ëŸ¼ ì±„ë„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${forumChannelId}`
      });
    }

    // "ì—°ê²°í˜ì´ì§€" í¬ìŠ¤íŠ¸ ì°¾ê¸° ë˜ëŠ” ìƒì„±
    const postName = 'ì—°ê²°í˜ì´ì§€';
    let transitionPost;

    try {
      // í™œì„± ìŠ¤ë ˆë“œì—ì„œ ì°¾ê¸°
      const activeThreads = await forumChannel.threads.fetchActive();
      transitionPost = Array.from(activeThreads.threads.values()).find(
        thread => thread.name === postName
      );

      if (!transitionPost) {
        // ì•„ì¹´ì´ë¸Œëœ ìŠ¤ë ˆë“œì—ì„œ ì°¾ê¸°
        try {
          const archivedThreads = await forumChannel.threads.fetchArchived({ limit: 100 });
          transitionPost = Array.from(archivedThreads.threads.values()).find(
            thread => thread.name === postName
          );
        } catch (archivedError) {
          console.warn('ì•„ì¹´ì´ë¸Œëœ ìŠ¤ë ˆë“œ ì¡°íšŒ ì‹¤íŒ¨:', archivedError);
        }
      }

      if (!transitionPost) {
        // í¬ìŠ¤íŠ¸ ìƒì„±
        console.log(`ğŸ“Œ [ì—°ê²°í˜ì´ì§€ ì´ë¯¸ì§€ ì—…ë¡œë“œ] ìƒˆ í¬ìŠ¤íŠ¸ ìƒì„±: ${postName}`);
        transitionPost = await forumChannel.threads.create({
          name: postName,
          message: {
            content: 'ì—°ê²°í˜ì´ì§€ ì´ë¯¸ì§€ ì €ì¥'
          },
          appliedTags: []
        });
        console.log(`âœ… [ì—°ê²°í˜ì´ì§€ ì´ë¯¸ì§€ ì—…ë¡œë“œ] ìƒˆ í¬ìŠ¤íŠ¸ ìƒì„± ì™„ë£Œ: ${postName} (ID: ${transitionPost.id})`);
      }
    } catch (postError) {
      console.error('âŒ [ì—°ê²°í˜ì´ì§€ ì´ë¯¸ì§€ ì—…ë¡œë“œ] ì—°ê²°í˜ì´ì§€ í¬ìŠ¤íŠ¸ ì°¾ê¸°/ìƒì„± ì‹¤íŒ¨:', postError);
      return res.status(500).json({
        success: false,
        error: `ì—°ê²°í˜ì´ì§€ í¬ìŠ¤íŠ¸ ì°¾ê¸°/ìƒì„± ì‹¤íŒ¨: ${postError.message}`
      });
    }

    // ì´ë¯¸ì§€ ì—…ë¡œë“œ
    const filename = `transition-page-${carrier}-${category}-${Date.now()}.${file.originalname.split('.').pop()}`;
    console.log(`ğŸ“¤ [ì—°ê²°í˜ì´ì§€ ì´ë¯¸ì§€ ì—…ë¡œë“œ] Discordì— ì—…ë¡œë“œ ì‹œì‘: ${filename}`);

    try {
      const attachment = {
        attachment: file.buffer,
        name: filename
      };

      const message = await transitionPost.send({ files: [attachment] });
      imageUrl = message.attachments.first().url;
      discordUploadSuccess = true;
      console.log(`âœ… [ì—°ê²°í˜ì´ì§€ ì´ë¯¸ì§€ ì—…ë¡œë“œ] Discord ì—…ë¡œë“œ ì„±ê³µ: ${imageUrl}`);
    } catch (uploadError) {
      console.error('âŒ [ì—°ê²°í˜ì´ì§€ ì´ë¯¸ì§€ ì—…ë¡œë“œ] Discord ì—…ë¡œë“œ ì‹¤íŒ¨:', uploadError);
      return res.status(500).json({
        success: false,
        error: `Discord ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: ${uploadError.message}`
      });
    }

    const elapsedTime = Date.now() - startTime;
    console.log(`âœ… [ì—°ê²°í˜ì´ì§€ ì´ë¯¸ì§€ ì—…ë¡œë“œ] ì™„ë£Œ (${elapsedTime}ms)`);

    return res.json({
      success: true,
      imageUrl: imageUrl
    });
  } catch (error) {
    const elapsedTime = Date.now() - startTime;
    console.error(`âŒ [ì—°ê²°í˜ì´ì§€ ì´ë¯¸ì§€ ì—…ë¡œë“œ] ì „ì²´ í”„ë¡œì„¸ìŠ¤ ì˜¤ë¥˜ (${elapsedTime}ms):`, error);
    console.error('âŒ [ì—°ê²°í˜ì´ì§€ ì´ë¯¸ì§€ ì—…ë¡œë“œ] ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤:', error.stack);

    return res.status(500).json({
      success: false,
      error: `ì—°ê²°í˜ì´ì§€ ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`,
      details: process.env.NODE_ENV === 'development' ? error.stack : undefined
    });
  }
});

// ========== ì§ì˜ì  ê´€ë¦¬ ëª¨ë“œ API ==========

// GET /api/direct/management/policy: ì •ì±… ì„¤ì • ì¡°íšŒ
app.get('/api/direct/management/policy', async (req, res) => {
  try {
    const carrier = req.query.carrier || 'SK';

    // ë§ˆì§„ ì„¤ì • ì¡°íšŒ
    const marginResponse = await rateLimitedSheetsCall(() =>
      sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ì§ì˜ì _ì •ì±…_ë§ˆì§„!A:Z'
      })
    );

    // ë¶€ê°€ì„œë¹„ìŠ¤ ì„¤ì • ì¡°íšŒ
    const addonResponse = await rateLimitedSheetsCall(() =>
      sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ì§ì˜ì _ì •ì±…_ë¶€ê°€ì„œë¹„ìŠ¤!A:Z'
      })
    );

    // ë³„ë„ ì •ì±… ì„¤ì • ì¡°íšŒ
    const specialResponse = await rateLimitedSheetsCall(() =>
      sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ì§ì˜ì _ì •ì±…_ë³„ë„!A:Z'
      })
    );

    const marginValues = marginResponse.data.values || [];
    const addonValues = addonResponse.data.values || [];
    const specialValues = specialResponse.data.values || [];

    // í•´ë‹¹ í†µì‹ ì‚¬ì˜ ì„¤ì • ì°¾ê¸°
    const marginRow = marginValues.slice(1).find(row => row[0] === carrier);
    const addonRow = addonValues.slice(1).find(row => row[0] === carrier);
    const specialRow = specialValues.slice(1).find(row => row[0] === carrier);

    return res.json({
      success: true,
      carrier: carrier,
      margin: {
        baseMargin: parseInt(marginRow?.[1] || 0),
        mnpMargin: parseInt(marginRow?.[2] || 0),
        changeMargin: parseInt(marginRow?.[3] || 0)
      },
      addon: {
        welfareDeduction: parseInt(addonRow?.[1] || 0),
        insuranceDeduction: parseInt(addonRow?.[2] || 0)
      },
      special: {
        policyDeduction: parseInt(specialRow?.[1] || 0),
        specialPolicy: parseInt(specialRow?.[2] || 0)
      }
    });
  } catch (error) {
    console.error('ì •ì±… ì„¤ì • ì¡°íšŒ ì˜¤ë¥˜:', error);
    return res.status(500).json({
      success: false,
      error: 'ì •ì±… ì„¤ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
    });
  }
});

// POST /api/direct/management/policy: ì •ì±… ì„¤ì • ì €ì¥
app.post('/api/direct/management/policy', async (req, res) => {
  try {
    const { carrier, margin, addon, special } = req.body;

    if (!carrier) {
      return res.status(400).json({
        success: false,
        error: 'í†µì‹ ì‚¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'
      });
    }

    // ë§ˆì§„ ì„¤ì • ì €ì¥
    if (margin) {
      const marginResponse = await rateLimitedSheetsCall(() =>
        sheets.spreadsheets.values.get({
          spreadsheetId: SPREADSHEET_ID,
          range: 'ì§ì˜ì _ì •ì±…_ë§ˆì§„!A:Z'
        })
      );

      const marginValues = marginResponse.data.values || [];
      const rows = marginValues.slice(1);
      const existingRowIndex = rows.findIndex(row => row[0] === carrier);

      const marginRow = [
        carrier,
        margin.baseMargin || 0,
        margin.mnpMargin || 0,
        margin.changeMargin || 0
      ];

      if (existingRowIndex !== -1) {
        await rateLimitedSheetsCall(() =>
          sheets.spreadsheets.values.update({
            spreadsheetId: SPREADSHEET_ID,
            range: `ì§ì˜ì _ì •ì±…_ë§ˆì§„!A${existingRowIndex + 2}`,
            valueInputOption: 'USER_ENTERED',
            resource: { values: [marginRow] }
          })
        );
      } else {
        await rateLimitedSheetsCall(() =>
          sheets.spreadsheets.values.append({
            spreadsheetId: SPREADSHEET_ID,
            range: 'ì§ì˜ì _ì •ì±…_ë§ˆì§„!A2',
            valueInputOption: 'USER_ENTERED',
            insertDataOption: 'INSERT_ROWS',
            resource: { values: [marginRow] }
          })
        );
      }
    }

    // ë¶€ê°€ì„œë¹„ìŠ¤ ì„¤ì • ì €ì¥
    if (addon) {
      const addonResponse = await rateLimitedSheetsCall(() =>
        sheets.spreadsheets.values.get({
          spreadsheetId: SPREADSHEET_ID,
          range: 'ì§ì˜ì _ì •ì±…_ë¶€ê°€ì„œë¹„ìŠ¤!A:Z'
        })
      );

      const addonValues = addonResponse.data.values || [];
      const rows = addonValues.slice(1);
      const existingRowIndex = rows.findIndex(row => row[0] === carrier);

      const addonRow = [
        carrier,
        addon.welfareDeduction || 0,
        addon.insuranceDeduction || 0
      ];

      if (existingRowIndex !== -1) {
        await rateLimitedSheetsCall(() =>
          sheets.spreadsheets.values.update({
            spreadsheetId: SPREADSHEET_ID,
            range: `ì§ì˜ì _ì •ì±…_ë¶€ê°€ì„œë¹„ìŠ¤!A${existingRowIndex + 2}`,
            valueInputOption: 'USER_ENTERED',
            resource: { values: [addonRow] }
          })
        );
      } else {
        await rateLimitedSheetsCall(() =>
          sheets.spreadsheets.values.append({
            spreadsheetId: SPREADSHEET_ID,
            range: 'ì§ì˜ì _ì •ì±…_ë¶€ê°€ì„œë¹„ìŠ¤!A2',
            valueInputOption: 'USER_ENTERED',
            insertDataOption: 'INSERT_ROWS',
            resource: { values: [addonRow] }
          })
        );
      }
    }

    // ë³„ë„ ì •ì±… ì„¤ì • ì €ì¥
    if (special) {
      const specialResponse = await rateLimitedSheetsCall(() =>
        sheets.spreadsheets.values.get({
          spreadsheetId: SPREADSHEET_ID,
          range: 'ì§ì˜ì _ì •ì±…_ë³„ë„!A:Z'
        })
      );

      const specialValues = specialResponse.data.values || [];
      const rows = specialValues.slice(1);
      const existingRowIndex = rows.findIndex(row => row[0] === carrier);

      const specialRow = [
        carrier,
        special.policyDeduction || 0,
        special.specialPolicy || 0
      ];

      if (existingRowIndex !== -1) {
        await rateLimitedSheetsCall(() =>
          sheets.spreadsheets.values.update({
            spreadsheetId: SPREADSHEET_ID,
            range: `ì§ì˜ì _ì •ì±…_ë³„ë„!A${existingRowIndex + 2}`,
            valueInputOption: 'USER_ENTERED',
            resource: { values: [specialRow] }
          })
        );
      } else {
        await rateLimitedSheetsCall(() =>
          sheets.spreadsheets.values.append({
            spreadsheetId: SPREADSHEET_ID,
            range: 'ì§ì˜ì _ì •ì±…_ë³„ë„!A2',
            valueInputOption: 'USER_ENTERED',
            insertDataOption: 'INSERT_ROWS',
            resource: { values: [specialRow] }
          })
        );
      }
    }

    return res.json({
      success: true,
      message: 'ì •ì±… ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'
    });
  } catch (error) {
    console.error('ì •ì±… ì„¤ì • ì €ì¥ ì˜¤ë¥˜:', error);
    return res.status(500).json({
      success: false,
      error: 'ì •ì±… ì„¤ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
    });
  }
});

// GET /api/direct/management/links: ë§í¬ ì„¤ì • ì¡°íšŒ
app.get('/api/direct/management/links', async (req, res) => {
  try {
    const carrier = req.query.carrier || 'SK';

    const response = await rateLimitedSheetsCall(() =>
      sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ì§ì˜ì _ì„¤ì •!A:Z'
      })
    );

    const values = response.data.values || [];
    const rows = values.slice(1); // í—¤ë” ì œì™¸

    // í•´ë‹¹ í†µì‹ ì‚¬ì˜ ì„¤ì • ì°¾ê¸°
    const planGroupRow = rows.find(row => row[0] === carrier && row[1] === 'ìš”ê¸ˆì œê·¸ë£¹');
    const supportRow = rows.find(row => row[0] === carrier && row[1] === 'ì´í†µì‚¬ì§€ì›ê¸ˆ');
    const policyRow = rows.find(row => row[0] === carrier && row[1] === 'ì •ì±…í‘œ');

    return res.json({
      success: true,
      carrier: carrier,
      planGroup: {
        link: planGroupRow?.[2] || '',
        range: planGroupRow?.[3] || ''
      },
      support: {
        link: supportRow?.[2] || '',
        range: supportRow?.[3] || ''
      },
      policy: {
        link: policyRow?.[2] || '',
        range: policyRow?.[3] || ''
      }
    });
  } catch (error) {
    console.error('ë§í¬ ì„¤ì • ì¡°íšŒ ì˜¤ë¥˜:', error);
    return res.status(500).json({
      success: false,
      error: 'ë§í¬ ì„¤ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
    });
  }
});

// POST /api/direct/management/links: ë§í¬ ì„¤ì • ì €ì¥
app.post('/api/direct/management/links', async (req, res) => {
  try {
    const { carrier, planGroup, support, policy } = req.body;

    if (!carrier) {
      return res.status(400).json({
        success: false,
        error: 'í†µì‹ ì‚¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'
      });
    }

    // ê¸°ì¡´ ì„¤ì • ì¡°íšŒ
    const response = await rateLimitedSheetsCall(() =>
      sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ì§ì˜ì _ì„¤ì •!A:Z'
      })
    );

    const values = response.data.values || [];
    const rows = values.slice(1);

    // ê° ì„¤ì • íƒ€ì…ë³„ë¡œ ì €ì¥
    const settingsToSave = [
      { type: 'ìš”ê¸ˆì œê·¸ë£¹', data: planGroup },
      { type: 'ì´í†µì‚¬ì§€ì›ê¸ˆ', data: support },
      { type: 'ì •ì±…í‘œ', data: policy }
    ];

    for (const setting of settingsToSave) {
      if (!setting.data) continue;

      const existingRowIndex = rows.findIndex(
        row => row[0] === carrier && row[1] === setting.type
      );

      const settingRow = [
        carrier,
        setting.type,
        setting.data.link || '',
        setting.data.range || ''
      ];

      if (existingRowIndex !== -1) {
        await rateLimitedSheetsCall(() =>
          sheets.spreadsheets.values.update({
            spreadsheetId: SPREADSHEET_ID,
            range: `ì§ì˜ì _ì„¤ì •!A${existingRowIndex + 2}`,
            valueInputOption: 'USER_ENTERED',
            resource: { values: [settingRow] }
          })
        );
      } else {
        await rateLimitedSheetsCall(() =>
          sheets.spreadsheets.values.append({
            spreadsheetId: SPREADSHEET_ID,
            range: 'ì§ì˜ì _ì„¤ì •!A2',
            valueInputOption: 'USER_ENTERED',
            insertDataOption: 'INSERT_ROWS',
            resource: { values: [settingRow] }
          })
        );
      }
    }

    return res.json({
      success: true,
      message: 'ë§í¬ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'
    });
  } catch (error) {
    console.error('ë§í¬ ì„¤ì • ì €ì¥ ì˜¤ë¥˜:', error);
    return res.status(500).json({
      success: false,
      error: 'ë§í¬ ì„¤ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
    });
  }
});

// íŒ¨ìŠ¤ì›Œë“œ ì„¤ì • API
app.post('/api/set-password', async (req, res) => {
  try {
    const { storeId, password, confirmPassword, usePassword } = req.body;

    if (!storeId) {
      return res.status(400).json({
        success: false,
        error: 'ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'
      });
    }

    // íŒ¨ìŠ¤ì›Œë“œ ì‚¬ìš© ì—¬ë¶€ í™•ì¸
    if (usePassword === true) {
      if (!password || !confirmPassword) {
        return res.status(400).json({
          success: false,
          error: 'íŒ¨ìŠ¤ì›Œë“œì™€ í™•ì¸ íŒ¨ìŠ¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'
        });
      }

      if (password !== confirmPassword) {
        return res.status(400).json({
          success: false,
          error: 'íŒ¨ìŠ¤ì›Œë“œê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤'
        });
      }

      if (password.length < 4) {
        return res.status(400).json({
          success: false,
          error: 'íŒ¨ìŠ¤ì›Œë“œëŠ” ìµœì†Œ 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤'
        });
      }
    }

    // ëŒ€ë¦¬ì ì•„ì´ë””ê´€ë¦¬ ì‹œíŠ¸ì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const agentValues = await getSheetValues(AGENT_SHEET_NAME);
    if (!agentValues) {
      return res.status(500).json({
        success: false,
        error: 'ì‹œíŠ¸ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'
      });
    }

    const agentRows = agentValues.slice(1);
    const agentIndex = agentRows.findIndex(row => row[2] === storeId); // Cì—´: ì•„ì´ë””

    if (agentIndex === -1) {
      return res.status(404).json({
        success: false,
        error: 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'
      });
    }

    const actualRowIndex = agentIndex + 2; // í—¤ë” 1í–‰ + ë°°ì—´ ì¸ë±ìŠ¤ 0ë¶€í„° ì‹œì‘

    console.log(`ğŸ” [íŒ¨ìŠ¤ì›Œë“œ ì„¤ì •] ì‚¬ìš©ì: ${storeId}, íŒ¨ìŠ¤ì›Œë“œ ì‚¬ìš©: ${usePassword}`);

    // Google Sheets ì—…ë°ì´íŠ¸
    const updates = [];

    if (usePassword === true) {
      // íŒ¨ìŠ¤ì›Œë“œ ì‚¬ìš© - Dì—´ì— FALSE, Eì—´ì— íŒ¨ìŠ¤ì›Œë“œ ì €ì¥
      updates.push({
        range: `${AGENT_SHEET_NAME}!D${actualRowIndex}`,
        values: [['FALSE']]
      });
      updates.push({
        range: `${AGENT_SHEET_NAME}!E${actualRowIndex}`,
        values: [[password]]
      });
    } else {
      // íŒ¨ìŠ¤ì›Œë“œ ë¯¸ì‚¬ìš© - Dì—´ì— TRUE, Eì—´ì€ ë¹„ì›Œë‘ 
      updates.push({
        range: `${AGENT_SHEET_NAME}!D${actualRowIndex}`,
        values: [['TRUE']]
      });
      updates.push({
        range: `${AGENT_SHEET_NAME}!E${actualRowIndex}`,
        values: [['']]
      });
    }

    // ë°°ì¹˜ ì—…ë°ì´íŠ¸ ì‹¤í–‰
    await sheets.spreadsheets.values.batchUpdate({
      spreadsheetId: SPREADSHEET_ID,
      valueInputOption: 'RAW',
      requestBody: {
        valueInputOption: 'RAW',
        data: updates
      }
    });

    console.log(`âœ… [íŒ¨ìŠ¤ì›Œë“œ ì„¤ì •] ì™„ë£Œ: ${storeId}, íŒ¨ìŠ¤ì›Œë“œ ì‚¬ìš©: ${usePassword}`);

    return res.json({
      success: true,
      message: usePassword ? 'íŒ¨ìŠ¤ì›Œë“œê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤' : 'íŒ¨ìŠ¤ì›Œë“œ ë¯¸ì‚¬ìš©ìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤'
    });

  } catch (error) {
    console.error('âŒ [íŒ¨ìŠ¤ì›Œë“œ ì„¤ì •] ì˜¤ë¥˜:', error);
    return res.status(500).json({
      success: false,
      error: 'íŒ¨ìŠ¤ì›Œë“œ ì„¤ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤',
      message: error.message
    });
  }
});

// ì£¼ê¸°ì ìœ¼ë¡œ ì£¼ì†Œ ì—…ë°ì´íŠ¸ë¥¼ í™•ì¸í•˜ê³  ì‹¤í–‰í•˜ëŠ” í•¨ìˆ˜
async function checkAndUpdateAddresses() {
  try {
    console.log('ğŸ” [ì£¼ì†Œì—…ë°ì´íŠ¸] í°í´ì¶œê³ ì²˜ë°ì´í„° ì‹œíŠ¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹œì‘');
    const storeValues = await getSheetValues(STORE_SHEET_NAME);
    if (!storeValues) {
      throw new Error('Failed to fetch data from store sheet');
    }
    console.log(`ğŸ” [ì£¼ì†Œì—…ë°ì´íŠ¸] í°í´ì¶œê³ ì²˜ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${storeValues.length}ê°œ í–‰`);

    // í—¤ë” ì œê±°
    const storeRows = storeValues.slice(1);
    const updates = [];
    console.log(`ğŸ” [ì£¼ì†Œì—…ë°ì´íŠ¸] ì²˜ë¦¬í•  ë°ì´í„° í–‰ ìˆ˜: ${storeRows.length}ê°œ`);

    // ëª¨ë“  ì£¼ì†Œì— ëŒ€í•´ ì¢Œí‘œ ì—…ë°ì´íŠ¸ (í–‰ ìœ„ì¹˜ê°€ ë³€ê²½ë˜ì–´ë„ í•­ìƒ ì²˜ë¦¬)
    for (let i = 0; i < storeRows.length; i++) {
      const row = storeRows[i];
      const address = row[11];  // Lì—´: ì£¼ì†Œ (8ì¹¸ ë°€ë¦¼)
      const status = row[12];    // Mì—´: ê±°ë˜ìƒíƒœ (8ì¹¸ ë°€ë¦¼)

      if (status === "ì‚¬ìš©") {
        if (!address || address.toString().trim() === '') {
          // ì‚¬ìš© ìƒíƒœì´ì§€ë§Œ ì£¼ì†Œê°€ ì—†ëŠ” ê²½ìš° ì¢Œí‘œ ì‚­ì œ
          updates.push({
            range: `${STORE_SHEET_NAME}!I${i + 2}:J${i + 2}`,
            values: [["", ""]]
          });
          continue;
        }

        // ì£¼ì†Œê°€ ìˆëŠ” ê²½ìš° geocoding ì‹¤í–‰
        try {
          const result = await geocodeAddress(address);
          if (result) {
            const { latitude, longitude } = result;
            updates.push({
              range: `${STORE_SHEET_NAME}!I${i + 2}:J${i + 2}`,
              values: [[latitude, longitude]]
            });
          }
        } catch (error) {
          console.error(`Geocoding ì˜¤ë¥˜: ${address}`, error.message);
        }
      } else {
        // ë¯¸ì‚¬ìš© ë§¤ì¥ì€ ìœ„ë„/ê²½ë„ ê°’ì„ ë¹ˆ ê°’ìœ¼ë¡œ ë¹„ì›€
        updates.push({
          range: `${STORE_SHEET_NAME}!I${i + 2}:J${i + 2}`,
          values: [["", ""]]
        });
      }
      // API í• ë‹¹ëŸ‰ ì œí•œì„ í”¼í•˜ê¸° ìœ„í•œ ì§€ì—° (ì‚¬ìš© ë§¤ì¥ë§Œ)
      if (status === "ì‚¬ìš©") await new Promise(resolve => setTimeout(resolve, 1000));
    }

    // ì¼ê´„ ì—…ë°ì´íŠ¸ ì‹¤í–‰ (ë°°ì¹˜ í¬ê¸° ì œí•œìœ¼ë¡œ ë¶„í• )
    console.log(`ğŸ” [ì£¼ì†Œì—…ë°ì´íŠ¸] ì—…ë°ì´íŠ¸í•  ì¢Œí‘œ ìˆ˜: ${updates.length}ê°œ`);
    if (updates.length > 0) {
      console.log('ğŸ” [ì£¼ì†Œì—…ë°ì´íŠ¸] Google Sheets ì¼ê´„ ì—…ë°ì´íŠ¸ ì‹œì‘');

      // ë°°ì¹˜ë¥¼ 50ê°œì”© ë¶„í• í•˜ì—¬ API ì œí•œ í”¼í•˜ê¸°
      const BATCH_SIZE = 50;
      const batches = [];
      for (let i = 0; i < updates.length; i += BATCH_SIZE) {
        batches.push(updates.slice(i, i + BATCH_SIZE));
      }

      console.log(`ğŸ” [ì£¼ì†Œì—…ë°ì´íŠ¸] ${batches.length}ê°œ ë°°ì¹˜ë¡œ ë¶„í• í•˜ì—¬ ì—…ë°ì´íŠ¸ ì§„í–‰`);

      for (let batchIndex = 0; batchIndex < batches.length; batchIndex++) {
        const batch = batches[batchIndex];
        console.log(`ğŸ”„ [ì£¼ì†Œì—…ë°ì´íŠ¸] ë°°ì¹˜ ${batchIndex + 1}/${batches.length} ì—…ë°ì´íŠ¸ ì¤‘ (${batch.length}ê°œ í•­ëª©)`);

        await updateBatchWithRetry(batch, batchIndex + 1, batches.length);

        // ë°°ì¹˜ ê°„ ê°„ê²© ì¶”ê°€ (API ì œí•œ ë°©ì§€)
        if (batchIndex < batches.length - 1) {
          await new Promise(resolve => setTimeout(resolve, 2000));
        }
      }

      console.log('âœ… [ì£¼ì†Œì—…ë°ì´íŠ¸] Google Sheets ì¼ê´„ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
    } else {
      console.log('â­ï¸ [ì£¼ì†Œì—…ë°ì´íŠ¸] ì—…ë°ì´íŠ¸í•  ì¢Œí‘œê°€ ì—†ìŒ');
    }
    console.log('âœ… [ì£¼ì†Œì—…ë°ì´íŠ¸] ì£¼ì†Œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ì™„ë£Œ');
  } catch (error) {
    console.error('âŒ [ì£¼ì†Œì—…ë°ì´íŠ¸] Error in checkAndUpdateAddresses:', error);
  }
}

// ë°°ì¹˜ ì—…ë°ì´íŠ¸ë¥¼ ì¬ì‹œë„ ë¡œì§ê³¼ í•¨ê»˜ ì‹¤í–‰í•˜ëŠ” í•¨ìˆ˜
async function updateBatchWithRetry(batch, batchIndex, totalBatches, retryCount = 0) {
  const maxRetries = 3;

  try {
    await sheets.spreadsheets.values.batchUpdate({
      spreadsheetId: SPREADSHEET_ID,
      resource: {
        valueInputOption: 'USER_ENTERED',
        data: batch
      }
    });
  } catch (error) {
    console.error(`âŒ [ì£¼ì†Œì—…ë°ì´íŠ¸] ë°°ì¹˜ ${batchIndex}/${totalBatches} ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:`, error.message);

    // 429 ì—ëŸ¬ (Rate Limit) ë˜ëŠ” 500/503 ì—ëŸ¬ì˜ ê²½ìš° ì¬ì‹œë„
    if ((error.code === 429 || error.response?.status === 429 ||
      error.response?.status === 500 || error.response?.status === 503 ||
      error.message?.includes('Internal error encountered') ||
      error.message?.includes('rateLimitExceeded')) && retryCount < maxRetries) {

      const waitTime = Math.min(2000 * Math.pow(2, retryCount), 30000); // 2s â†’ 4s â†’ 8s (ìµœëŒ€ 30ì´ˆ)
      console.log(`â³ [ì£¼ì†Œì—…ë°ì´íŠ¸] ì¬ì‹œë„ ëŒ€ê¸° ì¤‘... (${waitTime / 1000}ì´ˆ, ì‹œë„ ${retryCount + 1}/${maxRetries})`);

      await new Promise(resolve => setTimeout(resolve, waitTime));
      return updateBatchWithRetry(batch, batchIndex, totalBatches, retryCount + 1);
    }

    // ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼ ë˜ëŠ” ë‹¤ë¥¸ ì—ëŸ¬ì˜ ê²½ìš°
    throw error;
  }
}

// SALES_SHEET_ID ì£¼ì†Œ ì—…ë°ì´íŠ¸ë¥¼ í™•ì¸í•˜ê³  ì‹¤í–‰í•˜ëŠ” í•¨ìˆ˜ (ë¡œê·¸ ìµœì í™”)
async function checkAndUpdateSalesAddresses() {
  try {
    // SALES_SHEET_ID í™˜ê²½ë³€ìˆ˜ í™•ì¸
    const SALES_SPREADSHEET_ID = process.env.SALES_SHEET_ID;
    if (!SALES_SPREADSHEET_ID) {
      console.log('SALES_SHEET_ID í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•„ ì£¼ì†Œ ì—…ë°ì´íŠ¸ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.');
      return;
    }

    const SALES_SHEET_NAME = 'íŒë§¤ì ì •ë³´';
    const salesValues = await getSheetValues(SALES_SHEET_NAME, SALES_SPREADSHEET_ID);
    if (!salesValues) {
      throw new Error('Failed to fetch data from sales sheet');
    }

    // í—¤ë” ì œê±° (2í–‰ë¶€í„° ì‹œì‘)
    const salesRows = salesValues.slice(1);
    let processedCount = 0;
    let updatedCount = 0;
    let skippedCount = 0;
    let errorCount = 0;

    console.log(`ğŸ” [SALES] íŒë§¤ì ì •ë³´ ì‹œíŠ¸ ë°ì´í„° ë¡œë“œ: ${salesRows.length}ê°œ í–‰`);

    // ëª¨ë“  ì£¼ì†Œì— ëŒ€í•´ ì¢Œí‘œ ì—…ë°ì´íŠ¸ (ê°œë³„ ì—…ë°ì´íŠ¸ ë°©ì‹)
    for (let i = 0; i < salesRows.length; i++) {
      const row = salesRows[i];
      const address = row[7];  // Hì—´: ì£¼ì†Œ
      const existingLat = row[5]; // Fì—´: ê¸°ì¡´ ìœ„ë„
      const existingLng = row[6]; // Gì—´: ê¸°ì¡´ ê²½ë„

      // ì£¼ì†Œê°€ ì—†ê±°ë‚˜ 'ì£¼ì†Œí™•ì¸í•„ìš”'ì¸ ê²½ìš° ê±´ë„ˆë›°ê¸°
      if (!address || address.toString().trim() === '' || address.toString().trim() === 'ì£¼ì†Œí™•ì¸í•„ìš”') {
        continue;
      }

      processedCount++;

      // ê¸°ì¡´ ì¢Œí‘œê°€ ëª¨ë‘ ì¡´ì¬í•˜ë©´ ì§€ì˜¤ì½”ë”© ìƒëµ
      if (existingLat && existingLng) {
        skippedCount++;
        continue;
      }

      // ì£¼ì†Œ í•´ì‹œ ë¹„êµ (ë³€ê²½ ê°ì§€) - ì¢Œí‘œê°€ ì—†ì„ ê²½ìš°ì—ë§Œ ì ìš©
      const addressHash = createHash(address.toString().trim());
      const existingAddressHash = createHash('');

      // ì¢Œí‘œê°€ ì—†ëŠ” ê²½ìš°ì—ë§Œ ì§€ì˜¤ì½”ë”© ì‹¤í–‰
      if (addressHash !== existingAddressHash) {
        try {
          // ê°œë³„ ì£¼ì†Œ ë¡œê·¸ ì œê±° (ì„±ëŠ¥ ìµœì í™”)
          const result = await geocodeAddress(address);
          if (result) {
            const { latitude, longitude } = result;

            // ê°œë³„ ì—…ë°ì´íŠ¸ ì‹¤í–‰ (ì¦‰ì‹œ ì €ì¥)
            await sheets.spreadsheets.values.update({
              spreadsheetId: SALES_SPREADSHEET_ID,
              range: `${SALES_SHEET_NAME}!F${i + 2}:G${i + 2}`,
              valueInputOption: 'USER_ENTERED',
              resource: {
                values: [[latitude, longitude]]
              }
            });

            updatedCount++;

            // 100ê°œë§ˆë‹¤ ì§„í–‰ìƒí™© ë¡œê·¸ (ë¡œê·¸ ìµœì í™”)
            if (updatedCount % 100 === 0) {
              console.log(`ğŸ“Š [SALES] ì§„í–‰ìƒí™©: ${updatedCount}ê°œ ì—…ë°ì´íŠ¸ ì™„ë£Œ`);
            }
          } else {
            errorCount++;
          }
        } catch (error) {
          errorCount++;
          // ì—ëŸ¬ ë¡œê·¸ë„ ìµœì†Œí™” (ì„±ëŠ¥ ìµœì í™”)
          if (errorCount <= 5) {
            console.error(`âŒ [SALES] Geocoding ì˜¤ë¥˜: ${address}`, error.message);
          }
        }

        // API í• ë‹¹ëŸ‰ ì œí•œì„ í”¼í•˜ê¸° ìœ„í•œ ì§€ì—° (0.2ì´ˆ)
        await new Promise(resolve => setTimeout(resolve, 200));
      }
    }

    console.log(`ğŸ“Š [SALES] ì£¼ì†Œ ì—…ë°ì´íŠ¸ ì™„ë£Œ - ì²˜ë¦¬: ${processedCount}ê°œ, ì—…ë°ì´íŠ¸: ${updatedCount}ê°œ, ê±´ë„ˆëœ€: ${skippedCount}ê°œ, ì˜¤ë¥˜: ${errorCount}ê°œ`);
  } catch (error) {
    console.error('Error in checkAndUpdateSalesAddresses:', error);
  }
}

// ì¬ê³ ë°°ì • ìƒíƒœ ê³„ì‚° API
app.get('/api/inventory/assignment-status', async (req, res) => {
  try {
    // ìºì‹œ í‚¤ ìƒì„±
    const cacheKey = 'inventory_assignment_status';

    // ìºì‹œì—ì„œ ë¨¼ì € í™•ì¸ (30ë¶„ TTL)
    const cachedData = cacheUtils.get(cacheKey);
    if (cachedData) {
      return res.json(cachedData);
    }

    // 1. í•„ìš”í•œ ì‹œíŠ¸ ë°ì´í„° ë³‘ë ¬ë¡œ ê°€ì ¸ì˜¤ê¸°
    const [reservationSiteValues, phoneklInventoryValues, phoneklStoreValues, phoneklActivationValues, normalizationValues] = await Promise.all([
      getSheetValues('ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸'),
      getSheetValues('í°í´ì¬ê³ ë°ì´í„°'),
      getSheetValues('í°í´ì¶œê³ ì²˜ë°ì´í„°'),
      getSheetValues('í°í´ê°œí†µë°ì´í„°'),
      getSheetValues('ì •ê·œí™”ì‘ì—…')
    ]);

    if (!reservationSiteValues || reservationSiteValues.length < 2) {
      throw new Error('ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    if (!phoneklInventoryValues || phoneklInventoryValues.length < 2) {
      throw new Error('í°í´ì¬ê³ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    if (!phoneklStoreValues || phoneklStoreValues.length < 2) {
      throw new Error('í°í´ì¶œê³ ì²˜ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    // 2. ì •ê·œí™” ê·œì¹™ ë¡œë“œ
    const normalizationRules = new Map();
    if (normalizationValues && normalizationValues.length > 1) {
      normalizationValues.slice(1).forEach(row => {
        if (row.length >= 3) {
          const reservationSite = (row[1] || '').toString().trim(); // Cì—´: ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ í˜•ì‹
          const phoneklModel = (row[2] || '').toString().trim(); // Dì—´: í°í´
          const phoneklColor = (row[3] || '').toString().trim(); // Eì—´: ìƒ‰ìƒ

          if (reservationSite && phoneklModel && phoneklColor) {
            // ì •ê·œí™” ê·œì¹™ì˜ í‚¤ë¥¼ ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ í˜•ì‹ìœ¼ë¡œ ìƒì„± (íŒŒì´í”„ ì œê±°)
            const key = reservationSite.replace(/\s*\|\s*/g, ' ').trim();
            normalizationRules.set(key, { phoneklModel, phoneklColor });
          }
        }
      });
    }

    // 3. í°í´ì¶œê³ ì²˜ë°ì´í„°ì—ì„œ POSì½”ë“œ ë§¤í•‘ ìƒì„±
    const storePosCodeMapping = new Map();
    phoneklStoreValues.slice(1).forEach(row => {
      if (row.length >= 16) {
        const storeName = (row[14] || '').toString().trim(); // Gì—´: ì¶œê³ ì²˜ëª… (6+8)
        const posCode = (row[15] || '').toString().trim(); // Hì—´: POSì½”ë“œ (7+8)

        if (storeName && posCode) {
          storePosCodeMapping.set(storeName, posCode);
        }
      }
    });

    // 4. í°í´ì¬ê³ ë°ì´í„°ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ì¬ê³  ì •ë³´ ìƒì„±
    const availableInventory = new Map(); // key: "ëª¨ë¸ëª…_ìƒ‰ìƒ_POSì½”ë“œ", value: [ì¼ë ¨ë²ˆí˜¸ë“¤]
    const serialNumberToStore = new Map(); // key: ì¼ë ¨ë²ˆí˜¸, value: ì¶œê³ ì²˜ëª…

    phoneklInventoryValues.slice(1).forEach(row => {
      if (row.length >= 22) {
        const serialNumber = (row[11] || '').toString().trim(); // Dì—´: ì¼ë ¨ë²ˆí˜¸ (3+8)
        const modelCapacity = (row[13] || '').toString().trim(); // Fì—´: ëª¨ë¸ëª…&ìš©ëŸ‰ (5+8)
        const color = (row[14] || '').toString().trim(); // Gì—´: ìƒ‰ìƒ (6+8)
        const storeName = (row[21] || '').toString().trim(); // Nì—´: ì¶œê³ ì²˜ (13+8)

        if (serialNumber && modelCapacity && color && storeName) {
          const posCode = storePosCodeMapping.get(storeName);
          if (posCode) {
            // ëª¨ë¸ëª…ì— ìƒ‰ìƒ ì •ë³´ê°€ ì—†ìœ¼ë©´ ì¶”ê°€
            let modelWithColor = modelCapacity;
            if (!modelCapacity.includes('|') && color) {
              modelWithColor = `${modelCapacity} | ${color}`;
            }
            const key = `${modelWithColor}_${posCode}`;

            if (!availableInventory.has(key)) {
              availableInventory.set(key, []);
            }
            availableInventory.get(key).push(serialNumber);

            serialNumberToStore.set(serialNumber, storeName);
          }
        }
      }
    });

    // 5. í°í´ê°œí†µë°ì´í„°ì—ì„œ ê°œí†µ ì™„ë£Œëœ ì¼ë ¨ë²ˆí˜¸ ìˆ˜ì§‘
    const activatedSerialNumbers = new Set();
    if (phoneklActivationValues && phoneklActivationValues.length > 1) {
      phoneklActivationValues.slice(1).forEach(row => {
        if (row.length >= 24) {
          const serialNumber = (row[23] || '').toString().trim(); // Pì—´: ì¼ë ¨ë²ˆí˜¸ (15+8)
          const storeName = (row[14] || '').toString().trim(); // Gì—´: ì¶œê³ ì²˜ (6+8)

          if (serialNumber && storeName) {
            activatedSerialNumbers.add(serialNumber);
          }
        }
      });
    }

    // 6. ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ë°ì´í„° ì²˜ë¦¬ ë° ë°°ì • ìƒíƒœ ê³„ì‚°
    const reservationSiteRows = reservationSiteValues.slice(1);
    const assignmentResults = [];

    // ì´ë¯¸ ë°°ì •ëœ ì¼ë ¨ë²ˆí˜¸ ì¶”ì  (ì„œë²„ ì‹œì‘ ì‹œ Google Sheetsì—ì„œ ë™ê¸°í™”)
    const assignedSerialNumbers = new Set();

    // ì„œë²„ ì‹œì‘ ì‹œ Google Sheetsì—ì„œ ì´ë¯¸ ë°°ì •ëœ ì¼ë ¨ë²ˆí˜¸ë“¤ì„ ì½ì–´ì™€ì„œ ë™ê¸°í™”
    reservationSiteRows.forEach(row => {
      if (row.length >= 22) {
        const assignedSerialNumber = (row[6] || '').toString().trim(); // Gì—´: ë°°ì •ì¼ë ¨ë²ˆí˜¸
        if (assignedSerialNumber && assignedSerialNumber.trim() !== '') {
          assignedSerialNumbers.add(assignedSerialNumber);
        }
      }
    });

    let processedCount = 0;
    let skippedCount = 0;
    let normalizationFailedCount = 0;
    let successfulAssignmentCount = 0;
    let waitingAssignmentCount = 0;

    reservationSiteRows.forEach((row, index) => {
      // í•„ìš”í•œ ì—´ë“¤ì´ ìˆëŠ”ì§€ í™•ì¸ (Vì—´ê¹Œì§€ = 22ê°œ ì—´ í•„ìš”)
      if (row.length < 22) {
        skippedCount++;
        if (index < 10) {
          console.log(`âŒ [ê±´ë„ˆë›´ ê³ ê° ë””ë²„ê¹…] í–‰ ${index + 1}: ì—´ ê°œìˆ˜ ë¶€ì¡± (${row.length}/22)`);
        }
        return;
      }

      const reservationNumber = (row[8] || '').toString().trim(); // Iì—´: ì˜ˆì•½ë²ˆí˜¸
      const customerName = (row[7] || '').toString().trim(); // Hì—´: ê³ ê°ëª…
      const reservationDateTime = (row[14] || '').toString().trim(); // Oì—´: ì˜ˆì•½ì¼ì‹œ
      const model = (row[15] || '').toString().trim(); // Pì—´: ëª¨ë¸
      const capacity = (row[16] || '').toString().trim(); // Qì—´: ìš©ëŸ‰
      const color = (row[17] || '').toString().trim(); // Rì—´: ìƒ‰ìƒ
      const posCode = (row[21] || '').toString().trim(); // Vì—´: POSì½”ë“œ
      const yardReceivedDate = (row[11] || '').toString().trim(); // Lì—´: ë§ˆë‹¹ì ‘ìˆ˜ì¼ (ì„ì‹œ)
      const onSaleReceivedDate = (row[12] || '').toString().trim(); // Mì—´: ì˜¨ì„¸ì¼ì ‘ìˆ˜ì¼ (ì„ì‹œ)
      const assignedSerialNumber = (row[6] || '').toString().trim(); // Gì—´: ë°°ì •ì¼ë ¨ë²ˆí˜¸
      const activationStatusFromSheet = (row[5] || '').toString().trim(); // Fì—´: ê°œí†µì™„ë£Œ ìƒíƒœ

      // ë””ë²„ê¹…: ì²˜ìŒ ëª‡ ê°œ í–‰ì˜ ê°œí†µì™„ë£Œ ìƒíƒœ í™•ì¸
      if (index < 5) {
        console.log(`ğŸ” [ê°œí†µì™„ë£Œ ë””ë²„ê¹…] í–‰ ${index + 1}: ì˜ˆì•½ë²ˆí˜¸=${reservationNumber}, Fì—´ê°’="${activationStatusFromSheet}"`);
      }

      if (!reservationNumber || !customerName || !model || !capacity || !color || !posCode) {
        skippedCount++;
        return;
      }

      // ì •ê·œí™”ëœ ëª¨ë¸ëª… ìƒì„± (ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ í˜•ì‹)
      const reservationSiteModel = `${model} ${capacity} ${color}`.trim();
      const normalizedRule = normalizationRules.get(reservationSiteModel);



      // ë°°ì • ìƒíƒœ ê³„ì‚° (ì •ê·œí™” ê·œì¹™ê³¼ ê´€ê³„ì—†ì´ ê°œí†µì™„ë£Œ ìƒíƒœëŠ” ë¨¼ì € ì„¤ì •)
      let assignmentStatus = 'ë¯¸ë°°ì •';
      let activationStatus = activationStatusFromSheet || 'ë¯¸ê°œí†µ'; // ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ Fì—´ ê°’ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©
      let assignedSerial = '';
      let waitingOrder = 0;

      if (!normalizedRule) {
        normalizationFailedCount++;
        // ì •ê·œí™” ê·œì¹™ì´ ì—†ì–´ë„ ê°œí†µì™„ë£Œ ìƒíƒœëŠ” í‘œì‹œ
        assignmentResults.push({
          reservationNumber,
          customerName,
          reservationDateTime,
          model: reservationSiteModel,
          posCode,
          yardReceivedDate,
          onSaleReceivedDate,
          assignmentStatus,
          activationStatus,
          assignedSerialNumber: assignedSerial,
          waitingOrder
        });
        processedCount++;
        return;
      }

      const phoneklModel = normalizedRule.phoneklModel;
      const phoneklColor = normalizedRule.phoneklColor;

      // ì¬ê³  í‚¤ ìƒì„±
      const inventoryKey = `${phoneklModel}_${posCode}`;

      // í•´ë‹¹ ì¬ê³  í™•ì¸
      const availableSerials = availableInventory.get(inventoryKey) || [];

      // ì´ë¯¸ ë°°ì •ëœ ì¼ë ¨ë²ˆí˜¸ê°€ ìˆëŠ” ê²½ìš°
      if (assignedSerialNumber && assignedSerialNumber.trim() !== '') {
        assignedSerial = assignedSerialNumber;
        assignmentStatus = 'ë°°ì •ì™„ë£Œ';
        successfulAssignmentCount++;

      } else {
        // ìƒˆë¡œìš´ ë°°ì •ì´ í•„ìš”í•œ ê²½ìš°
        const unassignedSerials = availableSerials.filter(serial => !assignedSerialNumbers.has(serial));

        if (unassignedSerials.length > 0) {
          // ë°°ì • ê°€ëŠ¥í•œ ì¬ê³ ê°€ ìˆìŒ
          assignedSerial = unassignedSerials[0];
          assignmentStatus = 'ë°°ì •ì™„ë£Œ';
          assignedSerialNumbers.add(assignedSerial);
          successfulAssignmentCount++;

        } else {
          // ë°°ì • ëŒ€ê¸° ì¤‘ - ìˆœë²ˆ ê³„ì‚°
          const allCustomersForModel = reservationSiteRows.filter(r => {
            if (r.length < 22) return false;
            const rModel = (r[15] || '').toString().trim();
            const rCapacity = (r[16] || '').toString().trim();
            const rColor = (r[17] || '').toString().trim();
            const rPosCode = (r[21] || '').toString().trim();
            return `${rModel} ${rCapacity} ${rColor}`.trim() === reservationSiteModel && rPosCode === posCode;
          });

          // ê°œì„ ëœ ìš°ì„ ìˆœìœ„ë³„ë¡œ ì •ë ¬ (ì˜ˆì•½ë²ˆí˜¸ â†’ ì˜¨ì„¸ì¼ì¼ì‹œ â†’ ë§ˆë‹¹ì ‘ìˆ˜ì¼ â†’ ì‚¬ì´íŠ¸ì˜ˆì•½ì¼)
          allCustomersForModel.sort((a, b) => {
            const aReservationNumber = (a[8] || '').toString().trim(); // Iì—´: ì˜ˆì•½ë²ˆí˜¸
            const bReservationNumber = (b[8] || '').toString().trim();
            const aOnSale = (a[12] || '').toString().trim(); // Mì—´: ì˜¨ì„¸ì¼ì ‘ìˆ˜ì¼
            const bOnSale = (b[12] || '').toString().trim();
            const aYard = (a[11] || '').toString().trim(); // Lì—´: ë§ˆë‹¹ì ‘ìˆ˜ì¼
            const bYard = (b[11] || '').toString().trim();
            const aDateTime = (a[14] || '').toString().trim(); // Oì—´: ì‚¬ì´íŠ¸ì˜ˆì•½ì¼
            const bDateTime = (b[14] || '').toString().trim();

            // 1ìˆœìœ„: ì˜ˆì•½ë²ˆí˜¸ (ê³ ìœ ë¬¸ì, ìˆœë²ˆì´ ì•„ë‹˜)
            if (aReservationNumber !== bReservationNumber) {
              return aReservationNumber.localeCompare(bReservationNumber);
            }

            // 2ìˆœìœ„: ì˜¨ì„¸ì¼ì¼ì‹œ ë‚®ì€ìˆœ (ì˜¤ë˜ëœ ê²ƒ ìš°ì„ )
            if (aOnSale && !bOnSale) return -1;
            if (!aOnSale && bOnSale) return 1;
            if (aOnSale && bOnSale) {
              return new Date(aOnSale) - new Date(bOnSale);
            }

            // 3ìˆœìœ„: ë§ˆë‹¹ì ‘ìˆ˜ì¼ ë‚®ì€ìˆœ (ì˜¤ë˜ëœ ê²ƒ ìš°ì„ )
            if (aYard && !bYard) return -1;
            if (!aYard && bYard) return 1;
            if (aYard && bYard) {
              return new Date(aYard) - new Date(bYard);
            }

            // 4ìˆœìœ„: ì‚¬ì´íŠ¸ì˜ˆì•½ì¼ ë‚®ì€ìˆœ (ì˜¤ë˜ëœ ê²ƒ ìš°ì„ )
            return new Date(aDateTime) - new Date(bDateTime);
          });

          // í˜„ì¬ ê³ ê°ì˜ ìˆœë²ˆ ì°¾ê¸°
          const currentIndex = allCustomersForModel.findIndex(r =>
            (r[8] || '').toString().trim() === reservationNumber
          );

          if (currentIndex !== -1) {
            waitingOrder = currentIndex + 1;
            assignmentStatus = 'ë¯¸ë°°ì •';
            waitingAssignmentCount++;
          }
        }
      }

      assignmentResults.push({
        reservationNumber,
        customerName,
        reservationDateTime,
        model: reservationSiteModel,
        posCode,
        yardReceivedDate,
        onSaleReceivedDate,
        assignmentStatus,
        activationStatus,
        assignedSerialNumber: assignedSerial,
        waitingOrder
      });

      processedCount++;
    });

    // í†µê³„ ê³„ì‚°
    const assignedCount = assignmentResults.filter(item => item.assignmentStatus === 'ë°°ì •ì™„ë£Œ').length;
    const unassignedCount = assignmentResults.filter(item => item.assignmentStatus === 'ë¯¸ë°°ì •').length;
    const activatedCount = assignmentResults.filter(item => item.activationStatus === 'ê°œí†µì™„ë£Œ').length;
    const notActivatedCount = assignmentResults.filter(item => item.activationStatus === 'ë¯¸ê°œí†µ').length;

    const result = {
      success: true,
      data: assignmentResults,
      total: assignmentResults.length,
      stats: {
        assigned: assignedCount,
        unassigned: unassignedCount,
        activated: activatedCount,
        notActivated: notActivatedCount
      }
    };

    // ê²°ê³¼ ìºì‹± (30ë¶„ TTL)
    cacheUtils.set(cacheKey, result, 30 * 60);
    console.log('âœ… [ì„œë²„ ë””ë²„ê¹…] ê²°ê³¼ ìºì‹± ì™„ë£Œ');

    // ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
    const activatedFromSheetCount = assignmentResults.filter(item => item.activationStatus === 'ê°œí†µì™„ë£Œ').length;
    console.log(`ğŸ“Š [ê°œí†µì™„ë£Œ í‘œì‹œ] ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ Fì—´ ê°’ ê·¸ëŒ€ë¡œ í‘œì‹œ: ${activatedFromSheetCount}ê±´`);

    console.log('ğŸ‰ [ì„œë²„ ë””ë²„ê¹…] API ì‘ë‹µ ì „ì†¡ ì™„ë£Œ');
    res.json(result);

  } catch (error) {
    console.error('âŒ [ì„œë²„ ë””ë²„ê¹…] ì¬ê³ ë°°ì • ìƒíƒœ ê³„ì‚° ì˜¤ë¥˜:', error);
    console.error('âŒ [ì„œë²„ ë””ë²„ê¹…] ì˜¤ë¥˜ ìŠ¤íƒ:', error.stack);
    res.status(500).json({
      success: false,
      error: 'Failed to calculate inventory assignment status',
      message: error.message
    });
  }
});

// ë°°ì • ì €ì¥ API
app.post('/api/inventory/save-assignment', async (req, res) => {
  try {
    console.log('ğŸ’¾ [ë°°ì •ì €ì¥ ë””ë²„ê¹…] ë°°ì • ì €ì¥ ì‹œì‘');

    const { assignments } = req.body; // [{ reservationNumber, assignedSerialNumber }]

    if (!assignments || !Array.isArray(assignments)) {
      return res.status(400).json({
        success: false,
        error: 'Invalid assignments data'
      });
    }

    console.log(`ğŸ“Š [ë°°ì •ì €ì¥ ë””ë²„ê¹…] ì €ì¥í•  ë°°ì • ìˆ˜: ${assignments.length}ê°œ`);

    // ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ì‹œíŠ¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const reservationSiteValues = await getSheetValues('ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸');

    if (!reservationSiteValues || reservationSiteValues.length < 2) {
      throw new Error('ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    // ë°°ì • ë°ì´í„°ë¥¼ ì˜ˆì•½ë²ˆí˜¸ë¡œ ë§¤í•‘
    const assignmentMap = new Map();
    assignments.forEach(assignment => {
      assignmentMap.set(assignment.reservationNumber, assignment.assignedSerialNumber);
    });

    // ì¤‘ë³µ ë°°ì • ìë™ ì •ë¦¬ ë¡œì§
    console.log('ğŸ§¹ [ì¤‘ë³µì •ë¦¬] ì¤‘ë³µ ë°°ì • ë°ì´í„° ìë™ ì •ë¦¬ ì‹œì‘');
    const serialToReservations = new Map(); // ì¼ë ¨ë²ˆí˜¸ë³„ ì˜ˆì•½ë²ˆí˜¸ ë§¤í•‘
    const reservationToSerial = new Map(); // ì˜ˆì•½ë²ˆí˜¸ë³„ ì¼ë ¨ë²ˆí˜¸ ë§¤í•‘

    // ê¸°ì¡´ ë°°ì • ë°ì´í„° ìˆ˜ì§‘ (ê°œí†µì™„ë£Œ ê³ ê° ì œì™¸ - ì¼ë ¨ë²ˆí˜¸ë¥¼ ë‹¤ë¥¸ ê³ ê°ì—ê²Œ ë°°ì •í•˜ê¸° ìœ„í•´)
    for (let i = 1; i < reservationSiteValues.length; i++) {
      const row = reservationSiteValues[i];
      if (row.length < 22) continue;

      const reservationNumber = (row[8] || '').toString().trim(); // Iì—´: ì˜ˆì•½ë²ˆí˜¸
      const existingSerial = (row[6] || '').toString().trim(); // Gì—´: ê¸°ì¡´ ë°°ì •ì¼ë ¨ë²ˆí˜¸
      const activationStatus = (row[5] || '').toString().trim(); // Fì—´: ê°œí†µìƒíƒœ

      // ê°œí†µì™„ë£Œëœ ê³ ê°ì€ ì¤‘ë³µ ì •ë¦¬ì—ì„œ ì œì™¸ (ì¼ë ¨ë²ˆí˜¸ë¥¼ ë‹¤ë¥¸ ê³ ê°ì—ê²Œ ë°°ì •í•˜ê¸° ìœ„í•´)
      if (existingSerial && existingSerial.trim() !== '' && activationStatus !== 'ê°œí†µì™„ë£Œ') {
        if (!serialToReservations.has(existingSerial)) {
          serialToReservations.set(existingSerial, []);
        }
        serialToReservations.get(existingSerial).push(reservationNumber);
        reservationToSerial.set(reservationNumber, existingSerial);
      }
    }

    // ì¤‘ë³µ ë°°ì •ëœ ì¼ë ¨ë²ˆí˜¸ë“¤ ì •ë¦¬
    let cleanedCount = 0;
    for (const [serialNumber, reservationNumbers] of serialToReservations.entries()) {
      if (reservationNumbers.length > 1) {
        console.log(`âš ï¸ [ì¤‘ë³µì •ë¦¬] ì¼ë ¨ë²ˆí˜¸ ${serialNumber}ì— ${reservationNumbers.length}ê°œ ê³ ê° ë°°ì •ë¨: ${reservationNumbers.join(', ')}`);

        // ìš°ì„ ìˆœìœ„ì— ë”°ë¼ ì²« ë²ˆì§¸ ê³ ê°ë§Œ ë‚¨ê¸°ê³  ë‚˜ë¨¸ì§€ëŠ” ë°°ì • í•´ì œ
        const sortedReservations = reservationNumbers.sort((a, b) => {
          // ì˜ˆì•½ë²ˆí˜¸ ìˆœì„œë¡œ ì •ë ¬ (ê³ ìœ ë¬¸ì)
          return a.localeCompare(b);
        });

        // ì²« ë²ˆì§¸ ê³ ê°ë§Œ ìœ ì§€í•˜ê³  ë‚˜ë¨¸ì§€ëŠ” ë°°ì • í•´ì œ
        for (let i = 1; i < sortedReservations.length; i++) {
          const reservationToRemove = sortedReservations[i];

          // í•´ë‹¹ í–‰ì—ì„œ ë°°ì • í•´ì œ
          for (let j = 1; j < reservationSiteValues.length; j++) {
            const row = reservationSiteValues[j];
            if (row.length < 22) continue;

            const reservationNumber = (row[8] || '').toString().trim();
            if (reservationNumber === reservationToRemove) {
              row[6] = ''; // Gì—´ ë°°ì • í•´ì œ
              cleanedCount++;
              console.log(`ğŸ§¹ [ì¤‘ë³µì •ë¦¬] ë°°ì • í•´ì œ: ${reservationToRemove} (ì¼ë ¨ë²ˆí˜¸: ${serialNumber})`);
              break;
            }
          }
        }
      }
    }

    console.log(`âœ… [ì¤‘ë³µì •ë¦¬] ì¤‘ë³µ ë°°ì • ì •ë¦¬ ì™„ë£Œ: ${cleanedCount}ê°œ ë°°ì • í•´ì œ`);

    // ì‹œíŠ¸ ë°ì´í„° ì—…ë°ì´íŠ¸ (Gì—´ì— ì¼ë ¨ë²ˆí˜¸ ì €ì¥)
    let updatedCount = 0;
    let skippedCount = 0;

    // ì´ë¯¸ ë°°ì •ëœ ì¼ë ¨ë²ˆí˜¸ ì¶”ì  (ì¤‘ë³µ ë°°ì • ë°©ì§€)
    const assignedSerials = new Set();

    // ê¸°ì¡´ ë°°ì •ëœ ì¼ë ¨ë²ˆí˜¸ë“¤ì„ ë¨¼ì € ìˆ˜ì§‘
    for (let i = 1; i < reservationSiteValues.length; i++) {
      const row = reservationSiteValues[i];
      if (row.length < 22) continue;

      const existingSerial = (row[6] || '').toString().trim(); // Gì—´: ê¸°ì¡´ ë°°ì •ì¼ë ¨ë²ˆí˜¸
      if (existingSerial && existingSerial.trim() !== '') {
        assignedSerials.add(existingSerial);
      }
    }

    console.log(`ğŸ“Š [ë°°ì •ì €ì¥ ë””ë²„ê¹…] ê¸°ì¡´ ë°°ì •ëœ ì¼ë ¨ë²ˆí˜¸ ${assignedSerials.size}ê°œ í™•ì¸`);

    // 1ë‹¨ê³„: ëª¨ë“  ê³ ê°ì— ëŒ€í•´ ê°œí†µì™„ë£Œ ì²´í¬ (ë°°ì • ëŒ€ìƒ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´)
    for (let i = 1; i < reservationSiteValues.length; i++) {
      const row = reservationSiteValues[i];
      if (row.length < 22) continue;

      const reservationNumber = (row[8] || '').toString().trim(); // Iì—´: ì˜ˆì•½ë²ˆí˜¸
      const existingSerial = (row[6] || '').toString().trim(); // Gì—´: ê¸°ì¡´ ë°°ì •ì¼ë ¨ë²ˆí˜¸
      const activationStatus = (row[5] || '').toString().trim(); // Fì—´: ê°œí†µìƒíƒœ

      // ê°œí†µì™„ë£Œëœ ê³ ê°ì€ ìƒˆë¡œìš´ ë°°ì •ì—ì„œë§Œ ì œì™¸ (ê¸°ì¡´ ì¼ë ¨ë²ˆí˜¸ëŠ” ìœ ì§€)
      if (activationStatus === 'ê°œí†µì™„ë£Œ') {
        console.log(`âš ï¸ [ë°°ì •ì €ì¥ ë””ë²„ê¹…] ê°œí†µì™„ë£Œ ê³ ê° ë°°ì • ê±´ë„ˆëœ€: ${reservationNumber}`);
        skippedCount++;
        continue; // ìƒˆë¡œìš´ ë°°ì •ë§Œ ê±´ë„ˆëœ€, ê¸°ì¡´ ì¼ë ¨ë²ˆí˜¸ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€
      }
    }

    // 2ë‹¨ê³„: ë°°ì • ëŒ€ìƒ ê³ ê°ë“¤ì— ëŒ€í•´ ë°°ì • ë¡œì§ ì‹¤í–‰
    for (let i = 1; i < reservationSiteValues.length; i++) {
      const row = reservationSiteValues[i];
      if (row.length < 22) continue;

      const reservationNumber = (row[8] || '').toString().trim(); // Iì—´: ì˜ˆì•½ë²ˆí˜¸
      const existingSerial = (row[6] || '').toString().trim(); // Gì—´: ê¸°ì¡´ ë°°ì •ì¼ë ¨ë²ˆí˜¸
      const activationStatus = (row[5] || '').toString().trim(); // Fì—´: ê°œí†µìƒíƒœ

      if (assignmentMap.has(reservationNumber)) {
        const newSerial = assignmentMap.get(reservationNumber);

        // ê°œí†µì™„ë£Œëœ ê³ ê°ì€ ìƒˆë¡œìš´ ë°°ì •ì—ì„œë§Œ ì œì™¸ (ê¸°ì¡´ ì¼ë ¨ë²ˆí˜¸ëŠ” ìœ ì§€)
        if (activationStatus === 'ê°œí†µì™„ë£Œ') {
          console.log(`âš ï¸ [ë°°ì •ì €ì¥ ë””ë²„ê¹…] ê°œí†µì™„ë£Œ ê³ ê° ë°°ì • ê±´ë„ˆëœ€: ${reservationNumber}`);
          skippedCount++;
          continue; // ìƒˆë¡œìš´ ë°°ì •ë§Œ ê±´ë„ˆëœ€, ê¸°ì¡´ ì¼ë ¨ë²ˆí˜¸ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€
        }

        // ê¸°ì¡´ ë°°ì •ëœ ì¼ë ¨ë²ˆí˜¸ê°€ ìˆìœ¼ë©´ ìœ ì§€
        if (existingSerial && existingSerial.trim() !== '') {
          console.log(`âš ï¸ [ë°°ì •ì €ì¥ ë””ë²„ê¹…] ê¸°ì¡´ ë°°ì • ìœ ì§€: ${reservationNumber} (${existingSerial})`);
          skippedCount++;
          continue;
        }

        // ìƒˆë¡œìš´ ë°°ì • ì‹œ ì¼ë ¨ë²ˆí˜¸ ì¤‘ë³µ ì²´í¬
        if (assignedSerials.has(newSerial)) {
          console.log(`âŒ [ë°°ì •ì €ì¥ ë””ë²„ê¹…] ì¼ë ¨ë²ˆí˜¸ ì¤‘ë³µìœ¼ë¡œ ë°°ì • ì‹¤íŒ¨: ${reservationNumber} â†’ ${newSerial} (ì´ë¯¸ ë°°ì •ë¨)`);
          skippedCount++;
          continue;
        }

        // ìƒˆë¡œìš´ ë°°ì • ì €ì¥
        row[6] = newSerial; // Gì—´ì— ì¼ë ¨ë²ˆí˜¸ ì €ì¥
        assignedSerials.add(newSerial); // ë°°ì •ëœ ì¼ë ¨ë²ˆí˜¸ ì¶”ì ì— ì¶”ê°€
        updatedCount++;
        console.log(`âœ… [ë°°ì •ì €ì¥ ë””ë²„ê¹…] ë°°ì • ì €ì¥: ${reservationNumber} â†’ ${newSerial}`);
      }
    }

    // ì—…ë°ì´íŠ¸ëœ ë°ì´í„°ë¥¼ ì‹œíŠ¸ì— ì €ì¥
    if (updatedCount > 0) {
      try {
        const sheets = google.sheets({ version: 'v4', auth });
        const spreadsheetId = process.env.GOOGLE_SHEET_ID || process.env.SHEET_ID;

        // spreadsheetId ê²€ì¦
        if (!spreadsheetId) {
          throw new Error('GOOGLE_SHEET_ID ë˜ëŠ” SHEET_ID í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        }

        console.log(`ğŸ”§ [ë°°ì •ì €ì¥ ë””ë²„ê¹…] Google Sheets ì—…ë°ì´íŠ¸ ì‹œì‘ - Spreadsheet ID: ${spreadsheetId.substring(0, 10)}...`);

        // Gì—´ë§Œ ì—…ë°ì´íŠ¸ (ë°°ì •ì¼ë ¨ë²ˆí˜¸) - ì¤‘ë³µ ì •ë¦¬ëœ ë°ì´í„° í¬í•¨
        const range = 'ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸!G2:G' + (reservationSiteValues.length);
        const values = reservationSiteValues.slice(1).map(row => [row[6] || '']); // Gì—´ ë°ì´í„°ë§Œ ì¶”ì¶œ

        await sheets.spreadsheets.values.update({
          spreadsheetId,
          range,
          valueInputOption: 'RAW',
          resource: { values }
        });

        console.log(`ğŸ’¾ [ë°°ì •ì €ì¥ ë””ë²„ê¹…] Google Sheets ì—…ë°ì´íŠ¸ ì™„ë£Œ: ${updatedCount}ê°œ ì €ì¥`);
      } catch (error) {
        console.error('âŒ [ë°°ì •ì €ì¥ ë””ë²„ê¹…] Google Sheets ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error.message);
        console.error('âŒ [ë°°ì •ì €ì¥ ë””ë²„ê¹…] í™˜ê²½ë³€ìˆ˜ í™•ì¸ í•„ìš”: GOOGLE_SHEET_ID');
        throw error;
      }
    }

    console.log(`ğŸ“ˆ [ë°°ì •ì €ì¥ ë””ë²„ê¹…] ì €ì¥ ì™„ë£Œ: ${updatedCount}ê°œ ì €ì¥, ${skippedCount}ê°œ ìœ ì§€, ${cleanedCount}ê°œ ì¤‘ë³µì •ë¦¬`);

    res.json({
      success: true,
      updated: updatedCount,
      skipped: skippedCount,
      cleaned: cleanedCount,
      total: assignments.length
    });

  } catch (error) {
    console.error('âŒ [ë°°ì •ì €ì¥ ë””ë²„ê¹…] ë°°ì • ì €ì¥ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to save assignment',
      message: error.message
    });
  }
});

// ëŒ€ë¦¬ì ì•„ì´ë””ê´€ë¦¬ ì‹œíŠ¸ì—ì„œ ì‚¬ë¬´ì‹¤ë³„, ì†Œì†ë³„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° API
app.get('/api/agent-office-department', async (req, res) => {
  try {
    console.log('ğŸ“Š [ëŒ€ë¦¬ì ê´€ë¦¬ ë””ë²„ê¹…] ì‚¬ë¬´ì‹¤ë³„, ì†Œì†ë³„ ë°ì´í„° ë¡œë“œ ì‹œì‘');

    // ìºì‹œ í‚¤ ìƒì„±
    const cacheKey = 'agent_office_department';

    // ìºì‹œì—ì„œ ë¨¼ì € í™•ì¸ (30ë¶„ TTL)
    const cachedData = cacheUtils.get(cacheKey);
    if (cachedData) {
      return res.json(cachedData);
    }

    // ëŒ€ë¦¬ì ì•„ì´ë””ê´€ë¦¬ ì‹œíŠ¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const agentValues = await getSheetValues(AGENT_SHEET_NAME);

    if (!agentValues || agentValues.length < 2) {
      throw new Error('ëŒ€ë¦¬ì ì•„ì´ë””ê´€ë¦¬ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    console.log(`ğŸ“Š [ëŒ€ë¦¬ì ê´€ë¦¬ ë””ë²„ê¹…] ëŒ€ë¦¬ì ì•„ì´ë””ê´€ë¦¬ ë°ì´í„°: ${agentValues.length}í–‰`);

    // ì‚¬ë¬´ì‹¤ë³„, ì†Œì†ë³„ ë°ì´í„° ì¶”ì¶œ
    const offices = new Set();
    const departments = new Map(); // key: ì‚¬ë¬´ì‹¤, value: Set of ì†Œì†ë“¤
    const agentInfo = new Map(); // key: ë‹´ë‹¹ìëª…, value: { office, department }

    agentValues.slice(1).forEach(row => {
      if (row.length >= 5) {
        const agentName = (row[0] || '').toString().trim(); // Aì—´: ë‹´ë‹¹ìëª…
        const office = (row[5] || '').toString().trim(); // Fì—´: ì‚¬ë¬´ì‹¤ (ê¸°ì¡´ Dì—´)
        const department = (row[6] || '').toString().trim(); // Gì—´: ì†Œì† (ê¸°ì¡´ Eì—´)

        if (agentName && office) {
          offices.add(office);

          if (!departments.has(office)) {
            departments.set(office, new Set());
          }
          departments.get(office).add(department);

          agentInfo.set(agentName, { office, department });
        }
      }
    });

    // ê²°ê³¼ ë°ì´í„° êµ¬ì„±
    const result = {
      offices: Array.from(offices).sort(),
      departments: {},
      agentInfo: Object.fromEntries(agentInfo)
    };

    // ì‚¬ë¬´ì‹¤ë³„ ì†Œì† ëª©ë¡ êµ¬ì„±
    departments.forEach((deptSet, office) => {
      result.departments[office] = Array.from(deptSet).filter(Boolean).sort();
    });

    console.log(`ğŸ“Š [ëŒ€ë¦¬ì ê´€ë¦¬ ë””ë²„ê¹…] ì‚¬ë¬´ì‹¤: ${result.offices.length}ê°œ, ë‹´ë‹¹ì: ${Object.keys(result.agentInfo).length}ëª…`);

    const responseData = {
      success: true,
      data: result,
      timestamp: new Date().toISOString()
    };

    // ìºì‹œì— ì €ì¥ (30ë¶„ TTL)
    cacheUtils.set(cacheKey, responseData, 30 * 60 * 1000);

    res.json(responseData);

  } catch (error) {
    console.error('âŒ [ëŒ€ë¦¬ì ê´€ë¦¬ ë””ë²„ê¹…] ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to load agent office department data',
      message: error.message
    });
  }
});

// ì •ê·œí™”ì‘ì—…ì‹œíŠ¸ Cì—´ ê¸°ì¤€ ì‚¬ë¬´ì‹¤ë³„ ì¬ê³  í˜„í™© API
app.get('/api/inventory/normalized-status', async (req, res) => {
  try {
    console.log('ğŸ“Š [ì¬ê³ í˜„í™© ë””ë²„ê¹…] ì •ê·œí™”ì‘ì—…ì‹œíŠ¸ Cì—´ ê¸°ì¤€ ì‚¬ë¬´ì‹¤ë³„ ì¬ê³  í˜„í™© ë¡œë“œ ì‹œì‘');

    // ìºì‹œ í‚¤ ìƒì„±
    const cacheKey = 'inventory_normalized_status';

    // ìºì‹œì—ì„œ ë¨¼ì € í™•ì¸ (10ë¶„ TTL)
    const cachedData = cacheUtils.get(cacheKey);
    if (cachedData) {
      console.log('ğŸ“Š [ì¬ê³ í˜„í™© ë””ë²„ê¹…] ìºì‹œì—ì„œ ë°ì´í„° ë°˜í™˜');
      return res.json(cachedData);
    }

    console.log('ğŸ“Š [ì¬ê³ í˜„í™© ë””ë²„ê¹…] ì‹œíŠ¸ ë°ì´í„° ë¡œë“œ ì‹œì‘');

    // í•„ìš”í•œ ì‹œíŠ¸ ë°ì´í„° ë³‘ë ¬ë¡œ ê°€ì ¸ì˜¤ê¸°
    const [normalizationValues, phoneklInventoryValues] = await Promise.all([
      getSheetValues('ì •ê·œí™”ì‘ì—…'),
      getSheetValues('í°í´ì¬ê³ ë°ì´í„°')
    ]);

    console.log('ğŸ“Š [ì¬ê³ í˜„í™© ë””ë²„ê¹…] ì‹œíŠ¸ ë°ì´í„° ë¡œë“œ ì™„ë£Œ');

    if (!normalizationValues || normalizationValues.length < 2) {
      throw new Error('ì •ê·œí™”ì‘ì—… ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    if (!phoneklInventoryValues || phoneklInventoryValues.length < 2) {
      throw new Error('í°í´ì¬ê³ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    console.log(`ğŸ“Š [ì¬ê³ í˜„í™© ë””ë²„ê¹…] ì •ê·œí™”ì‘ì—… ë°ì´í„°: ${normalizationValues.length}í–‰, í°í´ì¬ê³ ë°ì´í„°: ${phoneklInventoryValues.length}í–‰`);

    // ì •ê·œí™”ì‘ì—… Cì—´ì— ìˆëŠ” ëª¨ë¸ë“¤ë§Œ ì¶”ì¶œ
    const validModels = new Set();
    normalizationValues.slice(1).forEach(row => {
      if (row.length >= 2) {
        const reservationSiteModel = (row[1] || '').toString().trim(); // Cì—´: ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ í˜•ì‹
        if (reservationSiteModel) {
          validModels.add(reservationSiteModel);
          console.log(`ğŸ“Š [ì¬ê³ í˜„í™© ë””ë²„ê¹…] ìœ íš¨í•œ ëª¨ë¸ ì¶”ê°€: ${reservationSiteModel}`);
        }
      }
    });

    console.log(`ğŸ“Š [ì¬ê³ í˜„í™© ë””ë²„ê¹…] ìœ íš¨í•œ ëª¨ë¸ ê°œìˆ˜: ${validModels.size}`);

    // í°í´ì¬ê³ ë°ì´í„°ì—ì„œ ì‚¬ë¬´ì‹¤ë³„ ëª¨ë¸ë³„ ì¬ê³  ìˆ˜ëŸ‰ ì§‘ê³„
    const officeInventory = {
      'í‰íƒì‚¬ë¬´ì‹¤': new Map(), // key: "ëª¨ë¸ëª…|ìƒ‰ìƒ", value: ìˆ˜ëŸ‰
      'ì¸ì²œì‚¬ë¬´ì‹¤': new Map(),
      'êµ°ì‚°ì‚¬ë¬´ì‹¤': new Map(),
      'ì•ˆì‚°ì‚¬ë¬´ì‹¤': new Map()
    };

    let processedRows = 0;
    let matchedOffices = 0;
    let matchedModels = 0;

    phoneklInventoryValues.slice(1).forEach(row => {
      if (row.length >= 22) {
        const modelCapacity = (row[13] || '').toString().trim(); // Fì—´: ëª¨ë¸ëª…&ìš©ëŸ‰ (5+8)
        const color = (row[14] || '').toString().trim(); // Gì—´: ìƒ‰ìƒ (6+8)
        const storeName = (row[21] || '').toString().trim(); // Nì—´: ì¶œê³ ì²˜ (13+8)

        if (modelCapacity && color && storeName) {
          processedRows++;

          // ì‚¬ë¬´ì‹¤ëª…ì€ ì›ë˜ ì´ë¦„ ê·¸ëŒ€ë¡œ ì‚¬ìš©
          let officeName = '';

          if (storeName.includes('í‰íƒì‚¬ë¬´ì‹¤')) {
            officeName = 'í‰íƒì‚¬ë¬´ì‹¤';
          } else if (storeName.includes('ì¸ì²œì‚¬ë¬´ì‹¤')) {
            officeName = 'ì¸ì²œì‚¬ë¬´ì‹¤';
          } else if (storeName.includes('êµ°ì‚°ì‚¬ë¬´ì‹¤')) {
            officeName = 'êµ°ì‚°ì‚¬ë¬´ì‹¤';
          } else if (storeName.includes('ì•ˆì‚°ì‚¬ë¬´ì‹¤')) {
            officeName = 'ì•ˆì‚°ì‚¬ë¬´ì‹¤';
          }

          if (officeName && officeInventory[officeName]) {
            // Fì—´ + "|" + Gì—´ ì¡°í•© ìƒì„±
            const modelWithColor = `${modelCapacity} | ${color}`;

            // ì •ê·œí™”ì‘ì—… Cì—´ì— ìˆëŠ” ëª¨ë¸ì¸ì§€ í™•ì¸
            if (validModels.has(modelWithColor)) {
              matchedModels++;

              // ì‚¬ë¬´ì‹¤ë³„ë¡œ ì¹´ìš´íŒ…
              if (!officeInventory[officeName].has(modelWithColor)) {
                officeInventory[officeName].set(modelWithColor, 0);
              }
              officeInventory[officeName].set(modelWithColor, officeInventory[officeName].get(modelWithColor) + 1);

              matchedOffices++;
            }
          }
        }
      }
    });

    console.log(`ğŸ“Š [ì¬ê³ í˜„í™© ë””ë²„ê¹…] ì²˜ë¦¬ëœ í–‰: ${processedRows}, ë§¤ì¹­ëœ ì‚¬ë¬´ì‹¤: ${matchedOffices}, ë§¤ì¹­ëœ ëª¨ë¸: ${matchedModels}`);

    // ì •ê·œí™” ê·œì¹™ì„ í†µí•´ ì‚¬ë¬´ì‹¤ë³„ ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
    const result = {
      'í‰íƒì‚¬ë¬´ì‹¤': {},
      'ì¸ì²œì‚¬ë¬´ì‹¤': {},
      'êµ°ì‚°ì‚¬ë¬´ì‹¤': {},
      'ì•ˆì‚°ì‚¬ë¬´ì‹¤': {}
    };

    Object.keys(officeInventory).forEach(officeName => {
      const officeData = officeInventory[officeName];
      officeData.forEach((count, reservationSiteModel) => {
        if (count > 0) {
          result[officeName][reservationSiteModel] = count;
        }
      });
    });

    // ê° ì‚¬ë¬´ì‹¤ë³„ ëª¨ë¸ ê°œìˆ˜ ë¡œê·¸
    Object.keys(result).forEach(officeName => {
      const modelCount = Object.keys(result[officeName]).length;
      console.log(`ğŸ“Š [ì¬ê³ í˜„í™© ë””ë²„ê¹…] ${officeName}: ${modelCount}ê°œ ëª¨ë¸`);
    });

    const responseData = {
      success: true,
      data: result,
      timestamp: new Date().toISOString()
    };

    // ìºì‹œì— ì €ì¥ (10ë¶„ TTL)
    cacheUtils.set(cacheKey, responseData, 10 * 60 * 1000);

    res.json(responseData);

  } catch (error) {
    console.error('âŒ [ì¬ê³ í˜„í™© ë””ë²„ê¹…] ì¬ê³  í˜„í™© ë¡œë“œ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to load normalized inventory status',
      message: error.message
    });
  }
});

// ìˆ˜ë™ ë°°ì • ì‹¤í–‰ API
app.post('/api/inventory/manual-assignment', async (req, res) => {
  try {
    console.log('ğŸ”§ [ìˆ˜ë™ë°°ì • ë””ë²„ê¹…] ìˆ˜ë™ ë°°ì • ì‹¤í–‰ ì‹œì‘');

    // í•„ìš”í•œ ì‹œíŠ¸ ë°ì´í„° ë³‘ë ¬ë¡œ ê°€ì ¸ì˜¤ê¸°
    const [reservationSiteValues, phoneklInventoryValues, phoneklStoreValues, normalizationValues] = await Promise.all([
      getSheetValues('ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸'),
      getSheetValues('í°í´ì¬ê³ ë°ì´í„°'),
      getSheetValues('í°í´ì¶œê³ ì²˜ë°ì´í„°'),
      getSheetValues('ì •ê·œí™”ì‘ì—…')
    ]);

    if (!reservationSiteValues || reservationSiteValues.length < 2) {
      throw new Error('ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    if (!phoneklInventoryValues || phoneklInventoryValues.length < 2) {
      throw new Error('í°í´ì¬ê³ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    if (!phoneklStoreValues || phoneklStoreValues.length < 2) {
      throw new Error('í°í´ì¶œê³ ì²˜ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    // ì •ê·œí™” ê·œì¹™ ë¡œë“œ
    const normalizationRules = new Map();
    if (normalizationValues && normalizationValues.length > 1) {
      normalizationValues.slice(1).forEach(row => {
        if (row.length >= 3) {
          const reservationSite = (row[1] || '').toString().trim(); // Cì—´: ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ í˜•ì‹
          const phoneklModel = (row[2] || '').toString().trim(); // Dì—´: í°í´
          const phoneklColor = (row[3] || '').toString().trim(); // Eì—´: ìƒ‰ìƒ

          if (reservationSite && phoneklModel && phoneklColor) {
            const key = reservationSite.replace(/\s*\|\s*/g, ' ').trim();
            normalizationRules.set(key, { phoneklModel, phoneklColor });
          }
        }
      });
    }

    // í°í´ì¶œê³ ì²˜ë°ì´í„°ì—ì„œ POSì½”ë“œ ë§¤í•‘ ìƒì„±
    const storePosCodeMapping = new Map();
    phoneklStoreValues.slice(1).forEach(row => {
      if (row.length >= 8) {
        const storeName = (row[6] || '').toString().trim(); // Gì—´: ì¶œê³ ì²˜ëª…
        const posCode = (row[7] || '').toString().trim(); // Hì—´: POSì½”ë“œ

        if (storeName && posCode) {
          storePosCodeMapping.set(storeName, posCode);
        }
      }
    });

    // í°í´ì¬ê³ ë°ì´í„°ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ì¬ê³  ì •ë³´ ìƒì„±
    const availableInventory = new Map(); // key: "ëª¨ë¸ëª…_ìƒ‰ìƒ_POSì½”ë“œ", value: [ì¼ë ¨ë²ˆí˜¸ë“¤]
    const serialNumberToStore = new Map(); // key: ì¼ë ¨ë²ˆí˜¸, value: ì¶œê³ ì²˜ëª…

    phoneklInventoryValues.slice(1).forEach(row => {
      if (row.length >= 22) {
        const serialNumber = (row[11] || '').toString().trim(); // Dì—´: ì¼ë ¨ë²ˆí˜¸ (3+8)
        const modelCapacity = (row[13] || '').toString().trim(); // Fì—´: ëª¨ë¸ëª…&ìš©ëŸ‰ (5+8)
        const color = (row[14] || '').toString().trim(); // Gì—´: ìƒ‰ìƒ (6+8)
        const storeName = (row[21] || '').toString().trim(); // Nì—´: ì¶œê³ ì²˜ (13+8)

        if (serialNumber && modelCapacity && color && storeName) {
          const posCode = storePosCodeMapping.get(storeName);
          if (posCode) {
            let modelWithColor = modelCapacity;
            if (!modelCapacity.includes('|') && color) {
              modelWithColor = `${modelCapacity} | ${color}`;
            }
            const key = `${modelWithColor}_${posCode}`;

            if (!availableInventory.has(key)) {
              availableInventory.set(key, []);
            }
            availableInventory.get(key).push(serialNumber);

            serialNumberToStore.set(serialNumber, storeName);
          }
        }
      }
    });

    // ì´ë¯¸ ë°°ì •ëœ ì¼ë ¨ë²ˆí˜¸ ì¶”ì 
    const assignedSerialNumbers = new Set();
    reservationSiteValues.slice(1).forEach(row => {
      if (row.length >= 22) {
        const assignedSerialNumber = (row[6] || '').toString().trim(); // Gì—´: ë°°ì •ì¼ë ¨ë²ˆí˜¸
        if (assignedSerialNumber && assignedSerialNumber.trim() !== '') {
          assignedSerialNumbers.add(assignedSerialNumber);
        }
      }
    });

    // ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ë°ì´í„° ì²˜ë¦¬ ë° ë°°ì •
    const reservationSiteRows = reservationSiteValues.slice(1);
    const assignments = [];
    let processedCount = 0;
    let assignedCount = 0;
    let skippedCount = 0;

    reservationSiteRows.forEach((row, index) => {
      if (row.length < 22) {
        skippedCount++;
        return;
      }

      const reservationNumber = (row[8] || '').toString().trim(); // Iì—´: ì˜ˆì•½ë²ˆí˜¸
      const customerName = (row[7] || '').toString().trim(); // Hì—´: ê³ ê°ëª…
      const model = (row[15] || '').toString().trim(); // Pì—´: ëª¨ë¸
      const capacity = (row[16] || '').toString().trim(); // Qì—´: ìš©ëŸ‰
      const color = (row[17] || '').toString().trim(); // Rì—´: ìƒ‰ìƒ
      const posCode = (row[21] || '').toString().trim(); // Vì—´: POSì½”ë“œ
      const assignedSerialNumber = (row[6] || '').toString().trim(); // Gì—´: ë°°ì •ì¼ë ¨ë²ˆí˜¸

      if (!reservationNumber || !customerName || !model || !capacity || !color || !posCode) {
        skippedCount++;
        return;
      }

      // ì´ë¯¸ ë°°ì •ëœ ê²½ìš° ê±´ë„ˆë›°ê¸°
      if (assignedSerialNumber && assignedSerialNumber.trim() !== '') {
        skippedCount++;
        return;
      }

      // ì •ê·œí™”ëœ ëª¨ë¸ëª… ìƒì„±
      const reservationSiteModel = `${model} ${capacity} ${color}`.trim();
      const normalizedRule = normalizationRules.get(reservationSiteModel);

      if (!normalizedRule) {
        skippedCount++;
        return;
      }

      const phoneklModel = normalizedRule.phoneklModel;
      const phoneklColor = normalizedRule.phoneklColor;

      // ì¬ê³  í‚¤ ìƒì„±
      const inventoryKey = `${phoneklModel}_${posCode}`;
      const availableSerials = availableInventory.get(inventoryKey) || [];

      // ì‚¬ìš© ê°€ëŠ¥í•œ ì¼ë ¨ë²ˆí˜¸ ì¤‘ ë°°ì •ë˜ì§€ ì•Šì€ ê²ƒ ì°¾ê¸°
      const availableSerial = availableSerials.find(serial => !assignedSerialNumbers.has(serial));

      if (availableSerial) {
        assignments.push({
          reservationNumber,
          assignedSerialNumber: availableSerial
        });
        assignedSerialNumbers.add(availableSerial);
        assignedCount++;
      }

      processedCount++;
    });

    console.log(`ğŸ“Š [ìˆ˜ë™ë°°ì • ë””ë²„ê¹…] ìˆ˜ë™ ë°°ì • ì™„ë£Œ: ${assignedCount}ê°œ ë°°ì •, ${skippedCount}ê°œ ê±´ë„ˆëœ€, ${processedCount}ê°œ ì²˜ë¦¬`);

    // ë°°ì • ê²°ê³¼ ì €ì¥
    if (assignments.length > 0) {
      const saveResponse = await fetch(`${process.env.REACT_APP_API_URL || 'http://localhost:4000'}/api/inventory/save-assignment`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ assignments })
      });

      if (saveResponse.ok) {
        const saveResult = await saveResponse.json();
        console.log(`ğŸ’¾ [ìˆ˜ë™ë°°ì • ë””ë²„ê¹…] ë°°ì • ì €ì¥ ì™„ë£Œ: ${saveResult.updated}ê°œ ì €ì¥`);
      }
    }

    res.json({
      success: true,
      assigned: assignedCount,
      skipped: skippedCount,
      processed: processedCount,
      total: assignments.length
    });

  } catch (error) {
    console.error('âŒ [ìˆ˜ë™ë°°ì • ë””ë²„ê¹…] ìˆ˜ë™ ë°°ì • ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to execute manual assignment',
      message: error.message
    });
  }
});

// ì‹¤ì‹œê°„ ê°œí†µ ìƒíƒœ í™•ì¸ API
app.get('/api/inventory/activation-status', async (req, res) => {
  try {


    // ìºì‹œ í‚¤ ìƒì„±
    const cacheKey = 'inventory_activation_status';

    // ìºì‹œì—ì„œ ë¨¼ì € í™•ì¸ (1ë¶„ TTLë¡œ ë‹¨ì¶•)
    const cachedData = cacheUtils.get(cacheKey);
    if (cachedData) {
      console.log('âœ… [ê°œí†µìƒíƒœ ë””ë²„ê¹…] ìºì‹œëœ ê°œí†µ ìƒíƒœ ë°˜í™˜');
      return res.json(cachedData);
    }

    // ê³ ê°ëª… ì •ê·œí™” í•¨ìˆ˜
    const cleanCustomerName = (name) => {
      return name.replace(/\([^)]*\)/g, '').trim(); // ê´„í˜¸ ì œê±°
    };

    // í°í´ê°œí†µë°ì´í„°ì—ì„œ ê°œí†µ ì™„ë£Œëœ ê³ ê° ìˆ˜ì§‘ (ê³ ê°ëª… + ê°œí†µë²ˆí˜¸ ë 4ìë¦¬)
    const phoneklActivationValues = await getSheetValues('í°í´ê°œí†µë°ì´í„°');

    if (!phoneklActivationValues || phoneklActivationValues.length < 2) {
      throw new Error('í°í´ê°œí†µë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    // ë””ë²„ê¹…: í°í´ê°œí†µë°ì´í„° í—¤ë” í™•ì¸
    console.log('ğŸ” [ê°œí†µë§¤ì¹­ ë””ë²„ê¹…] í°í´ê°œí†µë°ì´í„° í—¤ë”:', phoneklActivationValues[0]);
    console.log('ğŸ” [ê°œí†µë§¤ì¹­ ë””ë²„ê¹…] í°í´ê°œí†µë°ì´í„° ì´ í–‰ ìˆ˜:', phoneklActivationValues.length);

    // ì²˜ìŒ 3ê°œ ë°ì´í„° í–‰ì˜ êµ¬ì¡° í™•ì¸
    for (let i = 1; i <= Math.min(3, phoneklActivationValues.length - 1); i++) {
      console.log(`ğŸ” [ê°œí†µë§¤ì¹­ ë””ë²„ê¹…] í°í´ê°œí†µë°ì´í„° í–‰ ${i}:`, phoneklActivationValues[i]);
    }

    const activatedCustomers = new Set();
    let activationCount = 0;

    phoneklActivationValues.slice(1).forEach((row, index) => {
      if (row.length >= 18) {
        const customerName = cleanCustomerName((row[16] || '').toString().trim()); // Qì—´: ê³ ê°ëª…
        const activationNumber = (row[17] || '').toString().trim(); // Rì—´: ê°œí†µë²ˆí˜¸

        // ë””ë²„ê¹…: ì²˜ìŒ 5ê°œ ê°œí†µ ë°ì´í„° í™•ì¸
        if (index < 5) {
          console.log(`ğŸ” [ê°œí†µë§¤ì¹­ ë””ë²„ê¹…] í°í´ê°œí†µë°ì´í„° í–‰ ${index + 1}: ê³ ê°ëª…="${customerName}", ê°œí†µë²ˆí˜¸="${activationNumber}"`);
        }

        if (customerName && activationNumber && activationNumber.length >= 4) {
          const lastFourDigits = activationNumber.slice(-4); // ë 4ìë¦¬
          const activationKey = `${customerName}_${lastFourDigits}`;

          activatedCustomers.add(activationKey);
          activationCount++;

          // ë””ë²„ê¹…: ë§¤ì¹­ í‚¤ í™•ì¸
          if (index < 5) {
            console.log(`ğŸ” [ê°œí†µë§¤ì¹­ ë””ë²„ê¹…] ë§¤ì¹­í‚¤ ìƒì„±: "${activationKey}"`);
          }
        }
      }
    });

    console.log(`ğŸ“Š [ê°œí†µë§¤ì¹­ ë””ë²„ê¹…] í°í´ê°œí†µë°ì´í„°ì—ì„œ ìˆ˜ì§‘ëœ ê°œí†µ ê³ ê°: ${activationCount}ëª…`);



    // ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ì—ì„œ ê³ ê°ëª… + ì „í™”ë²ˆí˜¸ ë 4ìë¦¬ë¡œ ë§¤ì¹­
    const reservationSiteValues = await getSheetValues('ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸');

    if (!reservationSiteValues || reservationSiteValues.length < 2) {
      throw new Error('ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    const activationResults = [];
    let matchedCount = 0;

    reservationSiteValues.slice(1).forEach((row, index) => {
      if (row.length < 10) return;

      const reservationNumber = (row[8] || '').toString().trim(); // Iì—´: ì˜ˆì•½ë²ˆí˜¸
      const customerName = cleanCustomerName((row[7] || '').toString().trim()); // Hì—´: ê³ ê°ëª…
      const phoneNumber = (row[9] || '').toString().trim(); // Jì—´: ê³ ê°ì „í™”ë²ˆí˜¸

      // ë””ë²„ê¹…: ì²˜ìŒ 5ê°œ ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ë°ì´í„° í™•ì¸
      if (index < 5) {
        console.log(`ğŸ” [ê°œí†µë§¤ì¹­ ë””ë²„ê¹…] ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ í–‰ ${index + 1}: ì˜ˆì•½ë²ˆí˜¸="${reservationNumber}", ê³ ê°ëª…="${customerName}", ì „í™”ë²ˆí˜¸="${phoneNumber}"`);
      }

      if (reservationNumber && customerName && phoneNumber && phoneNumber.length >= 4) {
        const lastFourDigits = phoneNumber.slice(-4); // ë 4ìë¦¬
        const reservationKey = `${customerName}_${lastFourDigits}`;
        const isActivated = activatedCustomers.has(reservationKey);

        // ë””ë²„ê¹…: ë§¤ì¹­ í‚¤ì™€ ê²°ê³¼ í™•ì¸
        if (index < 5) {
          console.log(`ğŸ” [ê°œí†µë§¤ì¹­ ë””ë²„ê¹…] ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ë§¤ì¹­í‚¤: "${reservationKey}", ê°œí†µì—¬ë¶€: ${isActivated}`);
        }

        activationResults.push({
          reservationNumber,
          customerName,
          phoneNumber: lastFourDigits, // ë 4ìë¦¬ë§Œ ì €ì¥
          activationStatus: isActivated ? 'ê°œí†µì™„ë£Œ' : 'ë¯¸ê°œí†µ'
        });

        if (isActivated) {
          matchedCount++;
        }
      }
    });

    console.log(`ğŸ“ˆ [ê°œí†µìƒíƒœ ë””ë²„ê¹…] ê°œí†µ ìƒíƒœ ë§¤ì¹­ ì™„ë£Œ: ${matchedCount}ê°œ ê°œí†µì™„ë£Œ, ${activationResults.length - matchedCount}ê°œ ë¯¸ê°œí†µ`);

    // ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ì‹œíŠ¸ì— ê°œí†µ ìƒíƒœ ì €ì¥ (Fì—´)
    try {
      console.log('ğŸ’¾ [ê°œí†µìƒíƒœ ë””ë²„ê¹…] ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ì‹œíŠ¸ì— ê°œí†µ ìƒíƒœ ì €ì¥ ì‹œì‘');

      // ì˜ˆì•½ë²ˆí˜¸ë¥¼ í‚¤ë¡œ í•˜ëŠ” ê°œí†µ ìƒíƒœ ë§µ ìƒì„±
      const activationStatusMap = new Map();
      activationResults.forEach(item => {
        activationStatusMap.set(item.reservationNumber, item.activationStatus);
      });

      // ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ë°ì´í„° ì—…ë°ì´íŠ¸
      let updatedCount = 0;
      const updatedRows = reservationSiteValues.map((row, index) => {
        if (index === 0) return row; // í—¤ë”ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€

        if (row.length < 10) return row;

        const reservationNumber = (row[8] || '').toString().trim(); // Iì—´: ì˜ˆì•½ë²ˆí˜¸
        const activationStatus = activationStatusMap.get(reservationNumber);

        if (activationStatus) {
          // Fì—´(5ë²ˆì§¸)ì— ê°œí†µ ìƒíƒœ ì €ì¥
          const newRow = [...row];
          newRow[5] = activationStatus; // Fì—´: ê°œí†µì™„ë£Œ ë˜ëŠ” ë¯¸ê°œí†µ
          updatedCount++;
          return newRow;
        }

        return row;
      });

      // Google Sheetsì— ì—…ë°ì´íŠ¸ëœ ë°ì´í„° ì €ì¥
      if (updatedCount > 0) {
        const sheets = google.sheets({ version: 'v4', auth });
        const spreadsheetId = process.env.GOOGLE_SHEET_ID || process.env.SHEET_ID;

        if (!spreadsheetId) {
          throw new Error('GOOGLE_SHEET_ID ë˜ëŠ” SHEET_ID í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        }

        // Fì—´ë§Œ ì—…ë°ì´íŠ¸ (ê°œí†µìƒíƒœ)
        const range = 'ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸!F2:F' + (updatedRows.length);
        const values = updatedRows.slice(1).map(row => [row[5] || '']); // Fì—´ ë°ì´í„°ë§Œ ì¶”ì¶œ

        await sheets.spreadsheets.values.update({
          spreadsheetId,
          range,
          valueInputOption: 'RAW',
          resource: { values }
        });

        console.log(`ğŸ’¾ [ê°œí†µìƒíƒœ ë””ë²„ê¹…] ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì™„ë£Œ: ${updatedCount}ê°œ ê³ ê°ì˜ ê°œí†µ ìƒíƒœ ì €ì¥`);
      } else {
        console.log('ğŸ’¾ [ê°œí†µìƒíƒœ ë””ë²„ê¹…] ì—…ë°ì´íŠ¸í•  ê°œí†µ ìƒíƒœê°€ ì—†ìŠµë‹ˆë‹¤.');
      }

    } catch (error) {
      console.error('âŒ [ê°œí†µìƒíƒœ ë””ë²„ê¹…] ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error.message);
      // ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨í•´ë„ API ì‘ë‹µì€ ì •ìƒ ë°˜í™˜
    }

    const result = {
      success: true,
      data: activationResults,
      total: activationResults.length,
      activated: matchedCount,
      notActivated: activationResults.length - matchedCount
    };

    // ê²°ê³¼ ìºì‹± (1ë¶„ TTLë¡œ ë‹¨ì¶•)
    cacheUtils.set(cacheKey, result, 1 * 60);

    console.log('âœ… [ê°œí†µìƒíƒœ ë””ë²„ê¹…] ê°œí†µ ìƒíƒœ í™•ì¸ ì™„ë£Œ');
    res.json(result);

  } catch (error) {
    console.error('âŒ [ê°œí†µìƒíƒœ ë””ë²„ê¹…] ê°œí†µ ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to check activation status',
      message: error.message
    });
  }
});

// íŒ€ ë¼ìš°íŠ¸ ì„¤ì •
setupTeamRoutes(app, getSheetValuesWithoutCache);

// OB ê´€ë¦¬ëª¨ë“œ ë¼ìš°íŠ¸ ì„¤ì •
try {
  setupObRoutes(app);
  console.log('âœ… [OB] OB routes mounted at /api/ob');
} catch (e) {
  console.error('âŒ [OB] Failed to mount OB routes:', e.message);
}

// íšŒì˜ ëª¨ë“œ ë¼ìš°íŠ¸ ì„¤ì •
try {
  app.get('/api/meetings', meetingRoutes.getMeetings);
  app.post('/api/meetings', meetingRoutes.createMeeting);

  // PUT /api/meetings/:meetingId OPTIONS ìš”ì²­ ì²˜ë¦¬
  app.options('/api/meetings/:meetingId', (req, res) => {
    const corsOrigins = process.env.CORS_ORIGIN?.split(',') || [];
    const defaultOrigins = [
      'https://vipmobile.vercel.app',
      'http://localhost:3000',
      'http://localhost:3001',
      'http://localhost:4000'
    ];
    const allowedOrigins = [...corsOrigins, ...defaultOrigins];
    const origin = req.headers.origin;

    if (origin && allowedOrigins.includes(origin)) {
      res.header('Access-Control-Allow-Origin', origin);
    } else if (allowedOrigins.length > 0) {
      res.header('Access-Control-Allow-Origin', allowedOrigins[0]);
    }
    res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS, PATCH');
    res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With, Origin, Accept, X-API-Key');
    res.header('Access-Control-Allow-Credentials', 'true');
    res.header('Access-Control-Max-Age', '86400'); // 24ì‹œê°„ ìºì‹œ
    res.status(200).end();
  });

  app.put('/api/meetings/:meetingId', meetingRoutes.updateMeeting);
  app.delete('/api/meetings/:meetingId', meetingRoutes.deleteMeeting);

  // GET /api/meetings OPTIONS ìš”ì²­ ì²˜ë¦¬
  app.options('/api/meetings', (req, res) => {
    const corsOrigins = process.env.CORS_ORIGIN?.split(',') || [];
    const defaultOrigins = [
      'https://vipmobile.vercel.app',
      'http://localhost:3000',
      'http://localhost:3001',
      'http://localhost:4000'
    ];
    const allowedOrigins = [...corsOrigins, ...defaultOrigins];
    const origin = req.headers.origin;

    if (origin && allowedOrigins.includes(origin)) {
      res.header('Access-Control-Allow-Origin', origin);
    } else if (allowedOrigins.length > 0) {
      res.header('Access-Control-Allow-Origin', allowedOrigins[0]);
    }
    res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS, PATCH');
    res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With, Origin, Accept, X-API-Key');
    res.header('Access-Control-Allow-Credentials', 'true');
    res.header('Access-Control-Max-Age', '86400');
    res.status(200).end();
  });

  // íšŒì˜ ì„¤ì • API OPTIONS ìš”ì²­ ì²˜ë¦¬ (ë¼ìš°íŠ¸ ë“±ë¡ ì „ì— ë¨¼ì € ì²˜ë¦¬)
  app.options('/api/meetings/:meetingId/config', (req, res) => {
    console.log('ğŸ” [OPTIONS] config preflight ìš”ì²­');
    const corsOrigins = process.env.CORS_ORIGIN?.split(',') || [];
    const defaultOrigins = [
      'https://vipmobile.vercel.app',
      'http://localhost:3000',
      'http://localhost:3001',
      'http://localhost:4000'
    ];
    const allowedOrigins = [...corsOrigins, ...defaultOrigins];
    const origin = req.headers.origin;

    if (origin && allowedOrigins.includes(origin)) {
      res.header('Access-Control-Allow-Origin', origin);
    } else if (allowedOrigins.length > 0) {
      res.header('Access-Control-Allow-Origin', allowedOrigins[0]);
    } else if (origin) {
      res.header('Access-Control-Allow-Origin', origin);
    }
    res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS, PATCH');
    res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With, Origin, Accept, X-API-Key');
    res.header('Access-Control-Allow-Credentials', 'true');
    res.header('Access-Control-Max-Age', '86400'); // 24ì‹œê°„ ìºì‹œ
    console.log('âœ… [OPTIONS] config CORS í—¤ë” ì„¤ì • ì™„ë£Œ');
    return res.status(200).end();
  });

  app.get('/api/meetings/:meetingId/config', meetingRoutes.getMeetingConfig);
  app.post('/api/meetings/:meetingId/config', meetingRoutes.saveMeetingConfig);

  // íšŒì˜ ì´ë¯¸ì§€ ì—…ë¡œë“œ API OPTIONS ìš”ì²­ ì²˜ë¦¬ (ë¼ìš°íŠ¸ ë“±ë¡ ì „ì— ë¨¼ì € ì²˜ë¦¬)
  app.options('/api/meetings/:meetingId/upload-image', (req, res) => {
    console.log('ğŸ” [OPTIONS] upload-image preflight ìš”ì²­');
    const corsOrigins = process.env.CORS_ORIGIN?.split(',') || [];
    const defaultOrigins = [
      'https://vipmobile.vercel.app',
      'http://localhost:3000',
      'http://localhost:3001',
      'http://localhost:4000'
    ];
    const allowedOrigins = [...corsOrigins, ...defaultOrigins];
    const origin = req.headers.origin;

    if (origin && allowedOrigins.includes(origin)) {
      res.header('Access-Control-Allow-Origin', origin);
    } else if (allowedOrigins.length > 0) {
      res.header('Access-Control-Allow-Origin', allowedOrigins[0]);
    } else if (origin) {
      res.header('Access-Control-Allow-Origin', origin);
    }
    res.header('Access-Control-Allow-Methods', 'POST, OPTIONS');
    res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With, Origin, Accept, X-API-Key');
    res.header('Access-Control-Allow-Credentials', 'true');
    res.header('Access-Control-Max-Age', '86400'); // 24ì‹œê°„ ìºì‹œ
    console.log('âœ… [OPTIONS] upload-image CORS í—¤ë” ì„¤ì • ì™„ë£Œ');
    return res.status(200).end();
  });

  // multer ì—ëŸ¬ ì²˜ë¦¬ ë¯¸ë“¤ì›¨ì–´
  const handleMulterError = (err, req, res, next) => {
    // CORS í—¤ë” ì„¤ì • (ì—ëŸ¬ê°€ ë°œìƒí–ˆì„ ë•Œ í•­ìƒ ì„¤ì •)
    const corsOrigins = process.env.CORS_ORIGIN?.split(',') || [];
    const defaultOrigins = [
      'https://vipmobile.vercel.app',
      'http://localhost:3000',
      'http://localhost:3001',
      'http://localhost:4000'
    ];
    const allowedOrigins = [...corsOrigins, ...defaultOrigins];
    const origin = req.headers.origin;

    if (origin && allowedOrigins.includes(origin)) {
      res.header('Access-Control-Allow-Origin', origin);
    } else if (allowedOrigins.length > 0) {
      res.header('Access-Control-Allow-Origin', allowedOrigins[0]);
    }
    res.header('Access-Control-Allow-Methods', 'POST, OPTIONS');
    res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With, Origin, Accept, X-API-Key');
    res.header('Access-Control-Allow-Credentials', 'true');

    if (err instanceof multer.MulterError) {
      console.error('ğŸš¨ [Multer ì—ëŸ¬]', err.code, err.message);
      if (err.code === 'LIMIT_FILE_SIZE') {
        return res.status(400).json({
          success: false,
          error: 'íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. ìµœëŒ€ 25MBê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.',
          code: err.code
        });
      }
      return res.status(400).json({
        success: false,
        error: `íŒŒì¼ ì—…ë¡œë“œ ì˜¤ë¥˜: ${err.message}`,
        code: err.code
      });
    }

    // multer ì—ëŸ¬ê°€ ì•„ë‹Œ ê²½ìš°ë„ CORS í—¤ë”ë¥¼ ì„¤ì •í•œ í›„ ë‹¤ìŒ ì—ëŸ¬ í•¸ë“¤ëŸ¬ë¡œ ì „ë‹¬
    next(err);
  };

  // upload-image ë¼ìš°íŠ¸ì— íƒ€ì„ì•„ì›ƒ ë° ì—ëŸ¬ ì²˜ë¦¬ ì¶”ê°€
  app.post('/api/meetings/:meetingId/upload-image',
    (req, res, next) => {
      // ìš”ì²­ íƒ€ì„ì•„ì›ƒ ì„¤ì • (2ë¶„)
      req.setTimeout(120000);
      res.setTimeout(120000);

      // íƒ€ì„ì•„ì›ƒ ì—ëŸ¬ í•¸ë“¤ëŸ¬
      req.on('timeout', () => {
        console.error('âš ï¸ [upload-image] ìš”ì²­ íƒ€ì„ì•„ì›ƒ');
        if (!res.headersSent) {
          const corsOrigins = process.env.CORS_ORIGIN?.split(',') || [];
          const defaultOrigins = [
            'https://vipmobile.vercel.app',
            'http://localhost:3000',
            'http://localhost:3001',
            'http://localhost:4000'
          ];
          const allowedOrigins = [...corsOrigins, ...defaultOrigins];
          const origin = req.headers.origin;

          if (origin && allowedOrigins.includes(origin)) {
            res.header('Access-Control-Allow-Origin', origin);
          } else if (allowedOrigins.length > 0) {
            res.header('Access-Control-Allow-Origin', allowedOrigins[0]);
          }
          res.header('Access-Control-Allow-Methods', 'POST, OPTIONS');
          res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With, Origin, Accept, X-API-Key');
          res.header('Access-Control-Allow-Credentials', 'true');

          res.status(504).json({
            success: false,
            error: 'ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'
          });
        }
      });

      next();
    },
    meetingRoutes.upload.single('image'),
    handleMulterError,
    meetingRoutes.uploadMeetingImage
  );

  // ì»¤ìŠ¤í…€ íŒŒì¼ ì—…ë¡œë“œ API OPTIONS ìš”ì²­ ì²˜ë¦¬
  app.options('/api/meetings/:meetingId/upload-file', (req, res) => {
    const corsOrigins = process.env.CORS_ORIGIN?.split(',') || [];
    const defaultOrigins = [
      'https://vipmobile.vercel.app',
      'http://localhost:3000',
      'http://localhost:3001',
      'http://localhost:4000'
    ];
    const allowedOrigins = [...corsOrigins, ...defaultOrigins];
    const origin = req.headers.origin;

    if (origin && allowedOrigins.includes(origin)) {
      res.header('Access-Control-Allow-Origin', origin);
    } else if (allowedOrigins.length > 0) {
      res.header('Access-Control-Allow-Origin', allowedOrigins[0]);
    }
    res.header('Access-Control-Allow-Methods', 'POST, OPTIONS');
    res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With, Origin, Accept, X-API-Key');
    res.header('Access-Control-Allow-Credentials', 'true');
    res.header('Access-Control-Max-Age', '86400');
    res.status(200).end();
  });

  app.post('/api/meetings/:meetingId/upload-file', meetingRoutes.upload.single('file'), meetingRoutes.uploadCustomSlideFile);
  app.get('/api/meetings/proxy-image', meetingRoutes.proxyDiscordImage);
  // Discord thread title APIs
  app.get('/api/meetings/discord-thread/:threadId', express.json(), meetingRoutes.getDiscordThreadInfo);
  app.patch('/api/meetings/discord-thread/:threadId', express.json(), meetingRoutes.renameDiscordThread);
  // ë‹¨ì¼ ìŠ¬ë¼ì´ë“œ ì´ë¯¸ì§€ ë§í¬ ì—…ë°ì´íŠ¸
  app.patch('/api/meetings/:meetingId/slide-image', express.json(), meetingRoutes.updateSlideImageUrl);
  console.log('âœ… [íšŒì˜] Meeting routes mounted at /api/meetings');
} catch (e) {
  console.error('âŒ [íšŒì˜] Failed to mount meeting routes:', e.message);
}

// ì •ì±…ê·¸ë£¹ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° API
app.get('/api/budget/policy-groups', async (req, res) => {
  try {
    const sheets = google.sheets({ version: 'v4', auth });

    // í°í´ì¶œê³ ì²˜ë°ì´í„° ì‹œíŠ¸ì—ì„œ Sì—´ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const response = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: 'í°í´ì¶œê³ ì²˜ë°ì´í„°!S:S',
    });

    const values = response.data.values || [];

    // Sì—´ì—ì„œ ì •ì±…ê·¸ë£¹ ë°ì´í„° ì¶”ì¶œ ë° ì •ë¦¬
    const policyGroups = new Set();
    values.forEach(row => {
      if (row[0] && row[0].trim()) {
        // ê´„í˜¸ì™€ ê´„í˜¸ ì•ˆ ë‚´ìš© ì œê±° (ì˜ˆ: "í™ê¸°í˜„(2/2)" -> "í™ê¸°í˜„")
        const cleanGroup = row[0].replace(/\([^)]*\)/g, '').trim();
        if (cleanGroup) {
          policyGroups.add(cleanGroup);
        }
      }
    });

    // Setì„ ë°°ì—´ë¡œ ë³€í™˜í•˜ê³  ì •ë ¬
    const sortedPolicyGroups = Array.from(policyGroups).sort();

    res.json({ policyGroups: sortedPolicyGroups });
  } catch (error) {
    console.error('ì •ì±…ê·¸ë£¹ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'ì •ì±…ê·¸ë£¹ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
  }
});

// ì •ì±…ê·¸ë£¹ ì„¤ì • ì €ì¥ API
app.post('/api/budget/policy-group-settings', async (req, res) => {
  try {
    const { name, selectedGroups } = req.body;

    if (!name || !selectedGroups || !Array.isArray(selectedGroups)) {
      return res.status(400).json({ error: 'ì €ì¥ì´ë¦„ê³¼ ì„ íƒëœ ì •ì±…ê·¸ë£¹ì´ í•„ìš”í•©ë‹ˆë‹¤.' });
    }

    const sheets = google.sheets({ version: 'v4', auth });

    // ê¸°ì¡´ ì„¤ì • ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    const existingData = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: 'ì˜ˆì‚°_ì •ì±…ê·¸ë£¹ê´€ë¦¬!A:B',
    });

    const existingRows = existingData.data.values || [];

    // ì‹œíŠ¸ê°€ ë¹„ì–´ìˆê±°ë‚˜ í—¤ë”ê°€ ì—†ëŠ” ê²½ìš° í—¤ë” ì¶”ê°€
    if (existingRows.length === 0 || !existingRows[0] || existingRows[0][0] !== 'ì €ì¥ì´ë¦„') {
      await sheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ì˜ˆì‚°_ì •ì±…ê·¸ë£¹ê´€ë¦¬!A1:B1',
        valueInputOption: 'RAW',
        resource: {
          values: [['ì €ì¥ì´ë¦„', 'ì„ íƒëœì •ì±…ê·¸ë£¹']]
        }
      });
      existingRows = [['ì €ì¥ì´ë¦„', 'ì„ íƒëœì •ì±…ê·¸ë£¹']];
    }

    // ì¤‘ë³µ ì´ë¦„ ì²´í¬ (í—¤ë” ì œì™¸)
    const isDuplicate = existingRows.slice(1).some(row => row[0] === name);
    if (isDuplicate) {
      return res.status(400).json({ error: 'ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì €ì¥ì´ë¦„ì…ë‹ˆë‹¤.' });
    }

    // ìƒˆ ì„¤ì • ì¶”ê°€
    const newRow = [name, selectedGroups.join(',')];

    await sheets.spreadsheets.values.append({
      spreadsheetId: SPREADSHEET_ID,
      range: 'ì˜ˆì‚°_ì •ì±…ê·¸ë£¹ê´€ë¦¬!A:B',
      valueInputOption: 'RAW',
      resource: {
        values: [newRow]
      }
    });

    res.json({ message: 'ì •ì±…ê·¸ë£¹ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.' });
  } catch (error) {
    console.error('ì •ì±…ê·¸ë£¹ ì„¤ì • ì €ì¥ ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'ì •ì±…ê·¸ë£¹ ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
  }
});

// ì •ì±…ê·¸ë£¹ ì„¤ì • ëª©ë¡ ê°€ì ¸ì˜¤ê¸° API
app.get('/api/budget/policy-group-settings', async (req, res) => {
  try {
    const sheets = google.sheets({ version: 'v4', auth });

    const response = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: 'ì˜ˆì‚°_ì •ì±…ê·¸ë£¹ê´€ë¦¬!A:B',
    });

    const rows = response.data.values || [];

    // ì‹œíŠ¸ê°€ ë¹„ì–´ìˆê±°ë‚˜ í—¤ë”ê°€ ì—†ê±°ë‚˜ í—¤ë”ë§Œ ìˆëŠ” ê²½ìš° ë¹ˆ ë°°ì—´ ë°˜í™˜
    if (rows.length === 0 || rows.length === 1 || !rows[0] || rows[0][0] !== 'ì €ì¥ì´ë¦„') {
      return res.json({ settings: [] });
    }

    // í—¤ë” ì œì™¸í•˜ê³  ë°ì´í„°ë§Œ ë°˜í™˜
    const settings = rows.slice(1).map(row => ({
      name: row[0] || '',
      groups: row[1] ? row[1].split(',').filter(group => group.trim()) : []
    })).filter(setting => setting.name.trim()); // ë¹ˆ ì´ë¦„ ì œê±°

    res.json({ settings });
  } catch (error) {
    console.error('ì •ì±…ê·¸ë£¹ ì„¤ì • ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'ì •ì±…ê·¸ë£¹ ì„¤ì • ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
  }
});

// ì •ì±…ê·¸ë£¹ ì„¤ì • ì‚­ì œ API
app.delete('/api/budget/policy-group-settings/:name', async (req, res) => {
  try {
    const { name } = req.params;
    const sheets = google.sheets({ version: 'v4', auth });

    // ê¸°ì¡´ ì„¤ì • ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    const existingData = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: 'ì˜ˆì‚°_ì •ì±…ê·¸ë£¹ê´€ë¦¬!A:B',
    });

    const existingRows = existingData.data.values || [];

    // ì‚­ì œí•  í–‰ ì°¾ê¸°
    const rowIndex = existingRows.findIndex(row => row[0] === name);
    if (rowIndex === -1) {
      return res.status(404).json({ error: 'í•´ë‹¹ ì„¤ì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
    }

    // í–‰ ì‚­ì œ (í—¤ë” ì œì™¸í•˜ê³  ì‹¤ì œ ë°ì´í„° í–‰ ë²ˆí˜¸ ê³„ì‚°)
    const actualRowNumber = rowIndex + 1;
    await sheets.spreadsheets.batchUpdate({
      spreadsheetId: SPREADSHEET_ID,
      resource: {
        requests: [
          {
            deleteDimension: {
              range: {
                sheetId: await getSheetIdByName('ì˜ˆì‚°_ì •ì±…ê·¸ë£¹ê´€ë¦¬'),
                dimension: 'ROWS',
                startIndex: actualRowNumber,
                endIndex: actualRowNumber + 1
              }
            }
          }
        ]
      }
    });

    res.json({ message: 'ì •ì±…ê·¸ë£¹ ì„¤ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.' });
  } catch (error) {
    console.error('ì •ì±…ê·¸ë£¹ ì„¤ì • ì‚­ì œ ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'ì •ì±…ê·¸ë£¹ ì„¤ì • ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
  }
});

// ë‚ ì§œ ì •ê·œí™” í•¨ìˆ˜ë“¤
function normalizeReceptionDate(receptionDateStr) {
  if (!receptionDateStr || receptionDateStr === '#N/A' || receptionDateStr.trim() === '') return null;

  // "2025. 6. 30 ì˜¤í›„ 2:45:00" í˜•ì‹ì„ Date ê°ì²´ë¡œ ë³€í™˜
  try {
    // í•œêµ­ì–´ ì‹œê°„ í˜•ì‹ì„ ì˜ì–´ë¡œ ë³€í™˜í•˜ê³  ê³µë°± ì •ë¦¬
    let normalizedStr = receptionDateStr.trim()
      .replace(/ì˜¤ì „/g, 'AM')
      .replace(/ì˜¤í›„/g, 'PM')
      .replace(/\./g, '/')
      .replace(/\s+/g, ' '); // ì—¬ëŸ¬ ê³µë°±ì„ í•˜ë‚˜ë¡œ

    // "2025/ 6/ 13 PM 12:48:00" -> "2025/6/13 PM 12:48:00" í˜•íƒœë¡œ ì •ë¦¬
    normalizedStr = normalizedStr.replace(/\s*\//g, '/').replace(/\/\s*/g, '/');

    const date = new Date(normalizedStr);

    // ìœ íš¨í•œ ë‚ ì§œì¸ì§€ í™•ì¸
    if (isNaN(date.getTime())) {
      // ìœ íš¨í•˜ì§€ ì•Šì€ ì ‘ìˆ˜ì¼ í˜•ì‹
      return null;
    }

    return date;
  } catch (error) {
    console.error('ì ‘ìˆ˜ì¼ ì •ê·œí™” ì˜¤ë¥˜:', error, 'ì›ë³¸ê°’:', receptionDateStr);
    return null;
  }
}

function normalizeActivationDate(dateStr, hourStr, minuteStr) {
  if (!dateStr) return null;

  try {
    // "2025-06-30" í˜•ì‹ì˜ ë‚ ì§œ
    const date = new Date(dateStr);

    // ìœ íš¨í•œ ë‚ ì§œì¸ì§€ í™•ì¸
    if (isNaN(date.getTime())) {
      console.warn('ìœ íš¨í•˜ì§€ ì•Šì€ ê°œí†µì¼ í˜•ì‹:', dateStr);
      return null;
    }

    // ì‹œê°„ê³¼ ë¶„ì´ ìˆìœ¼ë©´ ì¶”ê°€
    if (hourStr && minuteStr) {
      const hour = parseInt(hourStr.replace(/ì‹œ/g, '')) || 0;
      const minute = parseInt(minuteStr.replace(/ë¶„/g, '')) || 0;
      date.setHours(hour, minute, 0, 0);
    }

    return date;
  } catch (error) {
    console.error('ê°œí†µì¼ ì •ê·œí™” ì˜¤ë¥˜:', error, 'ì›ë³¸ê°’:', dateStr, hourStr, minuteStr);
    return null;
  }
}

function isDateInRange(date, startDate, endDate) {
  if (!date || !startDate || !endDate) return false;

  const targetDate = new Date(date);
  const start = new Date(startDate);
  const end = new Date(endDate);

  // ì‹œê°„ì„ 00:00:00ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ë‚ ì§œë§Œ ë¹„êµ
  targetDate.setHours(0, 0, 0, 0);
  start.setHours(0, 0, 0, 0);
  end.setHours(23, 59, 59, 999); // ì¢…ë£Œì¼ì€ 23:59:59ë¡œ ì„¤ì •

  return targetDate >= start && targetDate <= end;
}

// ì‚¬ìš©ì ì‹œíŠ¸ëª… ê°€ì ¸ì˜¤ê¸° í—¬í¼ í•¨ìˆ˜
async function getUserSheetName(userName, budgetType) {
  try {
    // ì‹¤ì œ ìƒì„±ëœ ì‹œíŠ¸ëª…ì„ ì˜ˆì‚°_ì‚¬ìš©ìì‹œíŠ¸ê´€ë¦¬ì—ì„œ ì¡°íšŒ (1ìˆœìœ„)
    const userSheetManagementResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: 'ì˜ˆì‚°_ì‚¬ìš©ìì‹œíŠ¸ê´€ë¦¬!A:G'
    });

    const userSheetManagementData = userSheetManagementResponse.data.values || [];
    if (userSheetManagementData.length > 1) {
      // ì‚¬ìš©ìëª…ì—ì„œ ê´„í˜¸ì™€ ê³µë°±ì„ ì™„ì „íˆ ì œê±°
      const actualSheetOwner = userName.replace(/\([^)]+\)/g, '').trim();
      // í—¤ë” ì œì™¸í•˜ê³  í•´ë‹¹ ì‚¬ìš©ìì˜ ì˜ˆì‚°íƒ€ì…ë³„ ì‹œíŠ¸ëª… ì°¾ê¸°
      for (let i = 1; i < userSheetManagementData.length; i++) {
        const row = userSheetManagementData[i];
        if (row.length >= 3) {
          const sheetName = row[2]; // Cì—´: ì‹œíŠ¸ëª…
          // ì‹œíŠ¸ëª… íŒ¨í„´ ë§¤ì¹­: ì•¡ë©´_ê¹€ê¸°ì†¡(â… )(ì´ì‚¬) - ê³µë°± ì œê±°ë¡œ ì¼ê´€ì„± í™•ë³´
          const pattern = new RegExp(`^ì•¡ë©´_${actualSheetOwner.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\(${budgetType}\\)\\([^)]+\\)$`);
          console.log(`ğŸ” [getUserSheetName] íŒ¨í„´ ë§¤ì¹­ ì‹œë„: ì‹œíŠ¸ëª…="${sheetName}", íŒ¨í„´="${pattern.source}", actualSheetOwner="${actualSheetOwner}"`);
          if (pattern.test(sheetName)) {
            console.log(`ğŸ¯ [getUserSheetName] ì‹¤ì œ ì‹œíŠ¸ëª… ë°œê²¬: ${sheetName}`);
            return sheetName;
          }
        }
      }
    }
  } catch (error) {
    console.error('[getUserSheetName] ì˜ˆì‚°_ì‚¬ìš©ìì‹œíŠ¸ê´€ë¦¬ ì¡°íšŒ ì‹¤íŒ¨:', error);
  }

  // Fallback: í˜„ì¬ ì§ê¸‰ìœ¼ë¡œ ì‹œíŠ¸ëª… ìƒì„± (2ìˆœìœ„)
  try {
    const agentResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${AGENT_SHEET_NAME}!A:R`
    });

    const agentValues = agentResponse.data.values || [];
    // ì‚¬ìš©ìëª…ì—ì„œ ê´„í˜¸ì™€ ê³µë°±ì„ ì™„ì „íˆ ì œê±°
    const actualSheetOwner = userName.replace(/\([^)]+\)/g, '').trim();
    const agentRow = agentValues.find(row => row[0] === actualSheetOwner); // Aì—´ì—ì„œ ì´ë¦„ ì°¾ê¸° (ìˆ˜ì •ë¨)
    const userQualification = agentRow ? agentRow[1] : 'ì´ì‚¬'; // Bì—´ì˜ qualification

    const fallbackSheetName = `ì•¡ë©´_${actualSheetOwner}(${budgetType}) (${userQualification})`;
    console.log(`ğŸ¯ [getUserSheetName] Fallback ì‹œíŠ¸ëª…: ${fallbackSheetName}`);
    return fallbackSheetName;
  } catch (error) {
    console.error('[getUserSheetName] ëŒ€ë¦¬ì ì•„ì´ë””ê´€ë¦¬ ì¡°íšŒ ì‹¤íŒ¨:', error);
    // ì‚¬ìš©ìëª…ì—ì„œ ê´„í˜¸ì™€ ê³µë°±ì„ ì™„ì „íˆ ì œê±°
    const actualSheetOwner = userName.replace(/\([^)]+\)/g, '').trim();
    return `ì•¡ë©´_${actualSheetOwner}(${budgetType}) (ì´ì‚¬)`;
  }
}

// ì˜ˆì‚° ë§¤ì¹­ ê³„ì‚° í•¨ìˆ˜ (VLOOKUP ë°©ì‹ìœ¼ë¡œ ì™„ì „íˆ ìƒˆë¡œ ì‘ì„±)
async function performBudgetMatching(userSheetData, phoneklData, selectedPolicyGroups, dateRange, budgetType) {
  console.log(`ğŸ§® [performBudgetMatching] VLOOKUP ë°©ì‹ ì‹œì‘: ì •ì±…ê·¸ë£¹=${selectedPolicyGroups.join(',')}, ì˜ˆì‚°íƒ€ì…=${budgetType}`);

  // ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§
  const startMemory = process.memoryUsage();
  console.log(`ğŸ§  [ë©”ëª¨ë¦¬] ì‹œì‘: RSS=${Math.round(startMemory.rss / 1024 / 1024)}MB, Heap=${Math.round(startMemory.heapUsed / 1024 / 1024)}MB`);

  const calculationResults = [];
  const dataMapping = {};

  let totalSecuredBudget = 0;
  let totalUsedBudget = 0;
  let totalRemainingBudget = 0;
  let processedRows = 0;
  let matchedItems = 0;
  let policyGroupFiltered = 0;
  let dateRangeFiltered = 0;
  let modelMismatch = 0;

  // ë°°ì¹˜ ì²˜ë¦¬ ì„¤ì •
  const BATCH_SIZE = 50;
  let batchCount = 0;

  // í—¤ë” í™•ì¸ (5í–‰ë¶€í„° ì‹œì‘)
  const dataStartRow = 4; // 0-based index (ì‹¤ì œ 5í–‰)

  // ì‚¬ìš©ìì‹œíŠ¸ ë°ì´í„°ë¥¼ ë³µí•© í‚¤ë¡œ ì¸ë±ì‹± (VLOOKUP ê²€ìƒ‰ìš©)
  const userSheetIndex = new Map();

  console.log(`ğŸ” [ì¸ë±ì‹±] ì‚¬ìš©ìì‹œíŠ¸ ë°ì´í„° ë³µí•© í‚¤ ì¸ë±ìŠ¤ ìƒì„± ì‹œì‘...`);

  // ì‚¬ìš©ìì‹œíŠ¸ ë°ì´í„° ì¸ë±ì‹± (í—¤ë” ì œì™¸)
  if (userSheetData.length > 1) {
    for (let i = 1; i < userSheetData.length; i++) {
      const userRow = userSheetData[i];
      if (userRow.length >= 12) {
        const userModelName = (userRow[5] || '').toString().trim(); // Fì—´: ëª¨ë¸ëª…
        const userArmyType = (userRow[6] || '').toString().trim(); // Gì—´: êµ° (Sêµ°, Aêµ°, Bêµ° ë“±)
        const userCategoryType = (userRow[7] || '').toString().trim(); // Hì—´: ìœ í˜•
        const userSecuredAmount = parseFloat((userRow[8] || '').toString().replace(/,/g, '')) || 0; // Iì—´: í™•ë³´ì˜ˆì‚°
        const userUsedAmount = parseFloat((userRow[9] || '').toString().replace(/,/g, '')) || 0; // Jì—´: ì‚¬ìš©ì˜ˆì‚°
        const userRemainingAmount = parseFloat((userRow[10] || '').toString().replace(/,/g, '')) || 0; // Kì—´: ì˜ˆì‚°ì”ì•¡

        // í•„ìˆ˜ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°ë§Œ ì¸ë±ì‹±
        if (userModelName && userArmyType && userCategoryType) {
          // ì •ì±…êµ° ë§¤í•‘: Sêµ° â†’ S, Aêµ° â†’ A ë“±
          let mappedUserArmyType = '';
          if (userArmyType === 'Sêµ°') mappedUserArmyType = 'S';
          else if (userArmyType === 'Aêµ°') mappedUserArmyType = 'A';
          else if (userArmyType === 'Bêµ°') mappedUserArmyType = 'B';
          else if (userArmyType === 'Cêµ°') mappedUserArmyType = 'C';
          else if (userArmyType === 'Dêµ°') mappedUserArmyType = 'D';
          else if (userArmyType === 'Eêµ°') mappedUserArmyType = 'E';
          else mappedUserArmyType = userArmyType;

          // ë³µí•© í‚¤ ìƒì„±: ëª¨ë¸ëª…&ì •ì±…êµ°&ìœ í˜• (ì•¡ë©´ì˜ˆì‚°ê³¼ ë™ì¼í•œ í˜•ì‹)
          const compositeKey = `${userModelName}&${mappedUserArmyType}&${userCategoryType}`;

          userSheetIndex.set(compositeKey, {
            securedBudget: userSecuredAmount,
            usedBudget: userUsedAmount,
            remainingBudget: userRemainingAmount,
            rowIndex: i,
            modelName: userModelName,
            armyType: userArmyType,
            categoryType: userCategoryType
          });
        }
      }
    }
  }

  console.log(`ğŸ” [ì¸ë±ì‹±] ì‚¬ìš©ìì‹œíŠ¸ ì™„ë£Œ: ${userSheetIndex.size}ê°œ ë³µí•© í‚¤`);

  // ì•¡ë©´ì˜ˆì‚° ë°ì´í„°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ VLOOKUP ìˆ˜í–‰
  console.log(`ğŸ” [VLOOKUP] ì•¡ë©´ì˜ˆì‚° ê¸°ì¤€ìœ¼ë¡œ ì‚¬ìš©ìì‹œíŠ¸ ê²€ìƒ‰ ì‹œì‘...`);

  for (let j = dataStartRow; j < phoneklData.length; j++) {
    const phoneklRow = phoneklData[j];
    if (!phoneklRow || phoneklRow.length < 33) continue;

    const policyGroup = (phoneklRow[15] || '').toString().trim(); // Pì—´: ì •ì±…ê·¸ë£¹
    const armyType = (phoneklRow[14] || '').toString().trim(); // Oì—´: ì •ì±…êµ° (S, A, B, C, D, E)
    const categoryType = (phoneklRow[30] || '').toString().trim(); // AEì—´: ìœ í˜•
    const modelName = (phoneklRow[0] || '').toString().trim(); // Aì—´: ëª¨ë¸ëª…

    // ì •ì±…ê·¸ë£¹ í•„í„°ë§
    if (!selectedPolicyGroups.includes(policyGroup)) {
      policyGroupFiltered++;
      continue;
    }

    // ë‚ ì§œ ë²”ìœ„ í•„í„°ë§
    let isInDateRange = true;
    if (dateRange) {
      const receptionDate = normalizeReceptionDate(phoneklRow[16]); // Qì—´: ì ‘ìˆ˜ì¼
      const activationDate = normalizeActivationDate(phoneklRow[20], phoneklRow[21], phoneklRow[22]); // U, V, Wì—´: ê°œí†µì¼

      if (dateRange.applyReceiptDate && dateRange.receiptStartDate && dateRange.receiptEndDate) {
        const receptionInRange = receptionDate ? isDateInRange(receptionDate, dateRange.receiptStartDate, dateRange.receiptEndDate) : false;
        isInDateRange = isInDateRange && receptionInRange;
      }

      const activationStartDate = dateRange.activationStartDate || dateRange.startDate;
      const activationEndDate = dateRange.activationEndDate || dateRange.endDate;

      if (activationStartDate && activationEndDate) {
        const activationInRange = activationDate ? isDateInRange(activationDate, activationStartDate, activationEndDate) : false;
        isInDateRange = isInDateRange && activationInRange;
      }
    }

    if (!isInDateRange) {
      dateRangeFiltered++;
      continue;
    }

    // ì•¡ë©´ì˜ˆì‚° ë³µí•© í‚¤ ìƒì„±: ëª¨ë¸ëª…&ì •ì±…êµ°&ìœ í˜•
    const phoneklCompositeKey = `${modelName}&${armyType}&${categoryType}`;

    // VLOOKUP: ì‚¬ìš©ìì‹œíŠ¸ì—ì„œ ë§¤ì¹­ ë°ì´í„° ê²€ìƒ‰
    const matchingUserData = userSheetIndex.get(phoneklCompositeKey);

    if (matchingUserData) {
      // ë§¤ì¹­ ì„±ê³µ! ì‚¬ìš©ìì‹œíŠ¸ ë°ì´í„°ë¥¼ ì•¡ë©´ì˜ˆì‚°ì— ë³µì‚¬
      matchedItems++;
      processedRows++;

      const actualRowNumber = j + 1; // Google Sheets í–‰ ë²ˆí˜¸ (1-based)

      // ì‚¬ìš©ìì‹œíŠ¸ ë°ì´í„°ë¥¼ ì•¡ë©´ì˜ˆì‚°ì— ë³µì‚¬
      dataMapping[actualRowNumber] = {
        remainingBudget: matchingUserData.remainingBudget, // Kì—´ â†’ Lì—´
        securedBudget: matchingUserData.securedBudget,     // Iì—´ â†’ Mì—´
        usedBudget: matchingUserData.usedBudget            // Jì—´ â†’ Nì—´
      };

      calculationResults.push({
        rowIndex: j + dataStartRow,
        actualRowNumber,
        calculatedBudgetValue: matchingUserData.remainingBudget,
        securedBudgetValue: matchingUserData.securedBudget,
        usedBudgetValue: matchingUserData.usedBudget,
        matchingData: {
          policyGroup,
          armyType,
          categoryType,
          modelName
        }
      });

      totalSecuredBudget += matchingUserData.securedBudget;
      totalUsedBudget += matchingUserData.usedBudget;
      totalRemainingBudget += matchingUserData.remainingBudget;

      // ë§¤ì¹­ ì„±ê³µ ë¡œê·¸ (ë°°ì¹˜ ë‹¨ìœ„ë¡œë§Œ ì¶œë ¥)
      if (batchCount % 10 === 0) {
        console.log(`âœ… [VLOOKUPì„±ê³µ] Row ${actualRowNumber}: ì •ì±…ê·¸ë£¹=${policyGroup}, ëª¨ë¸=${modelName}, êµ°=${armyType}, ìœ í˜•=${categoryType}`);
        console.log(`   ğŸ“Š ë³µì‚¬ëœ ë°ì´í„°: í™•ë³´=${matchingUserData.securedBudget}, ì‚¬ìš©=${matchingUserData.usedBudget}, ì”ì•¡=${matchingUserData.remainingBudget}`);
      }

      // ë°°ì¹˜ ì²˜ë¦¬ í›„ ë©”ëª¨ë¦¬ ì •ë¦¬
      batchCount++;
      if (batchCount % BATCH_SIZE === 0) {
        const currentMemory = process.memoryUsage();
        console.log(`ğŸ“¦ [ë°°ì¹˜ì²˜ë¦¬] ${batchCount}ê°œ ë§¤ì¹­ ì™„ë£Œ - ë©”ëª¨ë¦¬: RSS=${Math.round(currentMemory.rss / 1024 / 1024)}MB, Heap=${Math.round(currentMemory.heapUsed / 1024 / 1024)}MB`);

        if (global.gc) {
          global.gc();
          console.log(`ğŸ§¹ [ë©”ëª¨ë¦¬] ê°€ë¹„ì§€ ì»¬ë ‰ì…˜ ì‹¤í–‰`);
        }
      }
    } else {
      // ë§¤ì¹­ ì‹¤íŒ¨
      modelMismatch++;

      // ë¡œê·¸ ìŠ¤íŒ¸ ë°©ì§€ë¥¼ ìœ„í•´ ê°„ë‹¨í•œ ë¡œê·¸ë§Œ ì¶œë ¥
      if (modelMismatch % 50 === 0) {
        console.log(`âŒ [VLOOKUPì‹¤íŒ¨] ì•¡ë©´ì˜ˆì‚° Row ${j + 1}: ëª¨ë¸=${modelName}, êµ°=${armyType}, ìœ í˜•=${categoryType} (ë§¤ì¹­ ì‹¤íŒ¨)`);
      }
    }
  }

  // ì‚¬ìš©ìì‹œíŠ¸ ë°ì´í„°ê°€ ë¹„ì–´ìˆëŠ” ê²½ìš° ì²˜ë¦¬
  if (userSheetData.length <= 1) {
    console.log(`ğŸš« ì‚¬ìš©ì ì‹œíŠ¸ ë°ì´í„°ê°€ ë¹„ì–´ìˆìŒ (í—¤ë”ë§Œ ì¡´ì¬)`);
  }

  // ìµœì¢… ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ë¡œê·¸
  const endMemory = process.memoryUsage();
  const memoryDiff = {
    rss: Math.round((endMemory.rss - startMemory.rss) / 1024 / 1024),
    heap: Math.round((endMemory.heapUsed - startMemory.heapUsed) / 1024 / 1024)
  };

  console.log(`ğŸ“ˆ [performBudgetMatching] ì™„ë£Œ: ì²˜ë¦¬=${processedRows}, ë§¤ì¹­=${matchedItems}, ëª¨ë¸ë¶ˆì¼ì¹˜=${modelMismatch}`);
  console.log(`ğŸ“‹ [dataMapping] ìƒì„± ì™„ë£Œ: ${Object.keys(dataMapping).length}ê°œ í–‰`);
  console.log(`ğŸ§  [ë©”ëª¨ë¦¬] ì™„ë£Œ: RSS=${Math.round(endMemory.rss / 1024 / 1024)}MB (${memoryDiff.rss > 0 ? '+' : ''}${memoryDiff.rss}MB), Heap=${Math.round(endMemory.heapUsed / 1024 / 1024)}MB (${memoryDiff.heap > 0 ? '+' : ''}${memoryDiff.heap}MB)`);

  return {
    dataMapping,
    calculationResults,
    totalSecuredBudget,
    totalUsedBudget,
    totalRemainingBudget,
    processedRows,
    matchedItems,
    statistics: {
      policyGroupFiltered: 0, // ì‚¬ìš©ì ì‹œíŠ¸ ê¸°ì¤€ì´ë¯€ë¡œ ì •ì±…ê·¸ë£¹ í•„í„°ë§ì€ ì•¡ë©´ì˜ˆì‚°ì—ì„œ ì²˜ë¦¬
      dateRangeFiltered: 0,   // ì‚¬ìš©ì ì‹œíŠ¸ ê¸°ì¤€ì´ë¯€ë¡œ ë‚ ì§œ í•„í„°ë§ì€ ì•¡ë©´ì˜ˆì‚°ì—ì„œ ì²˜ë¦¬
      modelMismatch
    }
  };
}

// findMatchingUserData í•¨ìˆ˜ëŠ” ì œê±°ë¨ - performBudgetMatchingì—ì„œ ì§ì ‘ ì²˜ë¦¬

// ì•ˆì „í•œ ê³„ì‚° ì „ìš© í•¨ìˆ˜ (ì‹¤ì œ ì—…ë°ì´íŠ¸ ì—†ì´ ê³„ì‚°ë§Œ ìˆ˜í–‰)
async function calculateUsageBudgetDryRun(sheetId, selectedPolicyGroups, dateRange, userName, budgetType) {
  console.log('ğŸ§® [DRY-RUN] calculateUsageBudgetDryRun ì‹œì‘ - ì‚¬ìš©ì:', userName);
  console.log('ğŸ§® [DRY-RUN] dateRange í™•ì¸:', JSON.stringify(dateRange, null, 2));

  try {
    // 1. ì‚¬ìš©ì ì‹œíŠ¸ ë°ì´í„° ì½ê¸°
    const userSheetName = await getUserSheetName(userName, budgetType);
    const userSheetRange = `${userSheetName}!A2:L`;

    const userSheetResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: sheetId,
      range: userSheetRange
    });

    const userSheetData = userSheetResponse.data.values || [];

    // 2. ì•¡ë©´ì˜ˆì‚° ì½ê¸° (AGì—´ê¹Œì§€ í•„ìš”)
    const phoneklRange = 'ì•¡ë©´ì˜ˆì‚°!A:AG';
    const phoneklResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: sheetId,
      range: phoneklRange
    });

    const phoneklData = phoneklResponse.data.values || [];

    // 3. ê³„ì‚° ìˆ˜í–‰ (dateRange ëª…ì‹œì  ì „ë‹¬)
    const calculationResult = await performBudgetMatching(
      userSheetData,
      phoneklData,
      selectedPolicyGroups,
      dateRange,
      budgetType
    );
    return calculationResult;

  } catch (error) {
    console.error('âŒ [DRY-RUN] ê³„ì‚° ì‹¤íŒ¨:', error);
    throw error;
  }
}

// ê¸°ì¡´ ì‚¬ìš©ì˜ˆì‚° ê³„ì‚° í•¨ìˆ˜ (ë ˆê±°ì‹œ)
async function calculateUsageBudget(sheetId, selectedPolicyGroups, dateRange, userName, budgetType) {
  const sheets = google.sheets({ version: 'v4', auth });

  console.log('ğŸ” [calculateUsageBudget] ì‹œì‘ - ì‚¬ìš©ì:', userName);

  // ì‚¬ìš©ìë³„ ì˜ˆì‚° ë°ì´í„° ê°€ì ¸ì˜¤ê¸° - ì‹œíŠ¸ ëª©ë¡ì—ì„œ í•´ë‹¹ ì‚¬ìš©ìì˜ ì‹œíŠ¸ ì°¾ê¸°
  const baseUserName = userName.replace(/\([^)]+\)/, '').trim(); // ëª¨ë“  ê´„í˜¸ ë‚´ìš© ì œê±°
  let userSheetName = `ì•¡ë©´_${baseUserName}`;
  let budgetData = [];

  // ì‚¬ìš©ìì˜ ìê²© ì •ë³´ë¥¼ ëŒ€ë¦¬ì ì•„ì´ë””ê´€ë¦¬ì—ì„œ ê°€ì ¸ì˜¤ê¸°
  let userQualification = 'ì´ì‚¬'; // ê¸°ë³¸ê°’
  try {
    const agentValues = await getSheetValues(AGENT_SHEET_NAME);
    if (agentValues) {
      const agentRows = agentValues.slice(1);
      const userAgent = agentRows.find(row => row[0] === baseUserName); // Aì—´: ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰
      if (userAgent) {
        userQualification = userAgent[1] || 'ì´ì‚¬'; // Bì—´: ìê²©
        console.log(`ğŸ“‹ [calculateUsageBudget] ì‚¬ìš©ì ìê²© í™•ì¸: ${baseUserName} â†’ ${userQualification}`);
      }
    }
  } catch (error) {
    console.error('ì‚¬ìš©ì ìê²© ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error);
  }

  // ì‹œíŠ¸ ëª©ë¡ì—ì„œ í•´ë‹¹ ì‚¬ìš©ìì˜ ì‹œíŠ¸ ì°¾ê¸°
  try {
    const sheetsListResponse = await sheets.spreadsheets.get({
      spreadsheetId: sheetId,
    });
    const sheetsList = sheetsListResponse.data.sheets || [];

    // ì‹œíŠ¸ ëª©ë¡ì—ì„œ ì‚¬ìš©ì ì‹œíŠ¸ ì°¾ê¸°

    // ì‚¬ìš©ìëª…ì—ì„œ ê´„í˜¸ì™€ ê³µë°±ì„ ì™„ì „íˆ ì œê±°í•˜ì—¬ ì‹œíŠ¸ëª… ìƒì„±
    const cleanUserName = baseUserName.replace(/\([^)]+\)/g, '').trim();
    const expectedSheetName = `ì•¡ë©´_${cleanUserName}(${budgetType || 'â… '}) (${userQualification})`;
    console.log(`ğŸ§­ [calculateUsageBudget] budgetType=${budgetType || 'â… '}, expectedSheetName=${expectedSheetName} (ì›ë³¸: "${baseUserName}")`);
    const userSheet = sheetsList.find(sheet =>
      sheet.properties.title === expectedSheetName
    );

    if (userSheet) {
      userSheetName = userSheet.properties.title;
      console.log(`âœ… ì‚¬ìš©ì ì‹œíŠ¸ ì°¾ìŒ: ${userSheetName}`);
    } else {
      console.warn(`ì‚¬ìš©ì ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${expectedSheetName}`);
      console.warn(`ê²€ìƒ‰ ì¡°ê±´: ì •í™•í•œ ì‹œíŠ¸ ì´ë¦„ ë§¤ì¹­ - ${expectedSheetName}`);
    }
  } catch (error) {
    console.warn('ì‹œíŠ¸ ëª©ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜:', error.message);
  }

  try {
    console.log(`ğŸ“¥ [calculateUsageBudget] ì‚¬ìš©ì ì‹œíŠ¸ ë²”ìœ„ ì½ê¸°: ${userSheetName}!A:L`);
    const budgetResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: sheetId,
      range: `${userSheetName}!A:L`, // Aì—´ë¶€í„° Lì—´ê¹Œì§€ (3ì—´ ì¶”ê°€ë¡œ 12ê°œ ì»¬ëŸ¼)
    });
    budgetData = budgetResponse.data.values || [];
    console.log(`ğŸ’° ${userSheetName} ì‹œíŠ¸ ë°ì´í„° ë¡œë“œ:`, budgetData.length, 'í–‰');
    if (budgetData.length === 0) {
      console.warn('âš ï¸ [calculateUsageBudget] ì‚¬ìš©ì ì‹œíŠ¸ ë°ì´í„°ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤. (í—¤ë” í¬í•¨ 0í–‰)');
    } else {
      // í—¤ë” ì •ë³´ í™•ì¸
    }
  } catch (error) {
    console.warn(`ì‚¬ìš©ì ì‹œíŠ¸ ${userSheetName}ì—ì„œ ì˜ˆì‚° ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:`, error.message);
  }

  // ì•¡ë©´ì˜ˆì‚° ì‹œíŠ¸ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (AGì—´ê¹Œì§€ í•„ìš”)
  const activationData = await sheets.spreadsheets.values.get({
    spreadsheetId: sheetId,
    range: 'ì•¡ë©´ì˜ˆì‚°!A:AG', // AGì—´ê¹Œì§€ í¬í•¨
  });

  const activationRows = activationData.data.values || [];
  console.log('ğŸ“± ì•¡ë©´ì˜ˆì‚° ì‹œíŠ¸ ë°ì´í„° ë¡œë“œ:', activationRows.length, 'í–‰');

  // í—¤ë” êµ¬ì¡° í™•ì¸
  console.log('ğŸ“‹ ì•¡ë©´ì˜ˆì‚° í—¤ë” êµ¬ì¡° í™•ì¸:');
  activationRows.slice(0, 10).forEach((row, i) => {
    console.log(`  í–‰${i + 1}:`, row.slice(0, 5).join(' | ')); // ì²˜ìŒ 5ê°œ ì»¬ëŸ¼ë§Œ ì¶œë ¥
  });

  // ì‚¬ìš©ìê°€ ëª…í™•íˆ ì•Œë ¤ì¤€ ëŒ€ë¡œ ê³ ì •ê°’ ì‚¬ìš©: C4í–‰ í—¤ë”, C5í–‰ë¶€í„° ë°ì´í„° ì‹œì‘
  const dataStartRow = 5; // C5í–‰ë¶€í„° ì‹œì‘
  console.log(`ğŸ¯ ë°ì´í„° ì‹œì‘ í–‰: ${dataStartRow} (C${dataStartRow}) - ê³ ì •ê°’ ì‚¬ìš©`);

  // ì‚¬ìš©ì˜ˆì‚° ê³„ì‚° ë° Aì—´, Bì—´, Cì—´ ì—…ë°ì´íŠ¸
  let totalUsedBudget = 0;
  let totalSecuredBudget = 0;
  let totalRemainingBudget = 0;
  const calculatedData = [];
  const updateRequests = [];

  // í†µê³„ ë³€ìˆ˜
  let policyGroupFiltered = 0;
  let dateRangeFiltered = 0;
  let modelMismatch = 0;
  let armyTypeMismatch = 0;
  let categoryTypeMismatch = 0;
  let successfulMatches = 0;

  // C5í–‰ë¶€í„° ë°ì´í„° ì²˜ë¦¬ (ë°°ì—´ ì¸ë±ìŠ¤ 4ë¶€í„° ì‹œì‘)
  activationRows.slice(4).forEach((row, index) => {
    const actualRowNumber = 5 + index; // C5, C6, C7, C8...
    if (row.length >= 33) { // AGì—´ê¹Œì§€ ì ‘ê·¼í•˜ë¯€ë¡œ ìµœì†Œ 33ê°œ ì»¬ëŸ¼ í•„ìš”
      const policyGroup = row[15]; // Pì—´: ì •ì±…ê·¸ë£¹ (ê¸°ì¡´ Eì—´ì—ì„œ +11)
      const armyType = row[14]; // Oì—´: ì •ì±…êµ° (ê¸°ì¡´ Dì—´ì—ì„œ +11)
      const categoryType = row[30]; // AEì—´: ìœ í˜• (ê¸°ì¡´ Tì—´ì—ì„œ +11)
      const currentBudgetValue = parseFloat((row[13] || '').toString().replace(/,/g, '')) || 0; // Nì—´: í˜„ì¬ ì˜ˆì‚°ê°’ (ê¸°ì¡´ Cì—´ì—ì„œ +11)

      // ë‚ ì§œ ë°ì´í„° ì •ê·œí™”
      const receptionDate = normalizeReceptionDate(row[16]); // Qì—´: ì ‘ìˆ˜ì¼ (ê¸°ì¡´ Fì—´ì—ì„œ +11)
      const activationDate = normalizeActivationDate(row[20], row[21], row[22]); // U, V, Wì—´: ê°œí†µì¼ (ê¸°ì¡´ J, K, Lì—´ì—ì„œ +11)

      // ì •ì±…ê·¸ë£¹ ë§¤ì¹­ (ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€)
      if (!selectedPolicyGroups.includes(policyGroup)) {
        // ì •ì±…ê·¸ë£¹ ë¶ˆì¼ì¹˜ë¡œ ì œì™¸
        policyGroupFiltered++;
        if (policyGroupFiltered <= 5) { // ì²˜ìŒ 5ê°œë§Œ ë¡œê·¸ ì¶œë ¥
          console.log(`ğŸš« [calculateUsageBudget] ì •ì±…ê·¸ë£¹ ë¶ˆì¼ì¹˜: ${policyGroup} (ì„ íƒëœ ì •ì±…ê·¸ë£¹: ${selectedPolicyGroups.join(', ')})`);
        }
      }
      if (selectedPolicyGroups.includes(policyGroup)) {
        // ë‚ ì§œ ë²”ìœ„ í•„í„°ë§ - ìƒˆë¡œìš´ 4ê°œ ë‚ ì§œ ì»¬ëŸ¼ ì‚¬ìš©
        let isInDateRange = true;
        if (dateRange && dateRange.startDate && dateRange.endDate) {
          // ì ‘ìˆ˜ì¼ ë˜ëŠ” ê°œí†µì¼ì´ ë²”ìœ„ì— ìˆëŠ”ì§€ í™•ì¸
          const receptionInRange = receptionDate ? isDateInRange(receptionDate, dateRange.startDate, dateRange.endDate) : false;
          const activationInRange = activationDate ? isDateInRange(activationDate, dateRange.startDate, dateRange.endDate) : false;
          isInDateRange = receptionInRange || activationInRange;
        }
        // ë‚ ì§œ ë²”ìœ„ ì œì™¸

        if (isInDateRange) {
          // ì •ì±…êµ° ë§¤í•‘ (S, A, B, C, D, E ëª¨ë‘ ë§¤í•‘)
          let mappedArmyType = '';
          if (armyType === 'S') mappedArmyType = 'Sêµ°';
          else if (armyType === 'A') mappedArmyType = 'Aêµ°';
          else if (armyType === 'B') mappedArmyType = 'Bêµ°';
          else if (armyType === 'C') mappedArmyType = 'Cêµ°';
          else if (armyType === 'D') mappedArmyType = 'Dêµ°';
          else if (armyType === 'E') mappedArmyType = 'Eêµ°';
          else mappedArmyType = armyType; // ê¸°íƒ€ ê²½ìš° ê·¸ëŒ€ë¡œ ì‚¬ìš©

          // ìœ í˜• ë§¤í•‘ (ì‹ ê·œ, MNP, ë³´ìƒ, ê¸°ë³€ ëª¨ë‘ ë§¤í•‘)
          let mappedCategoryType = categoryType;
          if (categoryType === 'ì‹ ê·œ') mappedCategoryType = 'ì‹ ê·œ';
          else if (categoryType === 'MNP') mappedCategoryType = 'MNP';
          else if (categoryType === 'ë³´ìƒ') mappedCategoryType = 'ë³´ìƒ';
          else if (categoryType === 'ê¸°ë³€') mappedCategoryType = 'ë³´ìƒ';
          else mappedCategoryType = categoryType; // ê¸°íƒ€ ê²½ìš° ê·¸ëŒ€ë¡œ ì‚¬ìš©

          // ë§¤ì¹­ ì¡°ê±´ í™•ì¸ (ë””ë²„ê·¸ìš©)

          // ì‚¬ìš©ìë³„ ì˜ˆì‚° ë°ì´í„°ì—ì„œ í•´ë‹¹í•˜ëŠ” ì‚¬ìš© ì˜ˆì‚° ì°¾ê¸°
          let calculatedBudgetValue = 0; // ê¸°ë³¸ê°’ 0ì›
          let securedBudgetValue = 0; // í™•ë³´ì˜ˆì‚° ê¸°ë³¸ê°’
          let matchFound = false;

          // í—¤ë” ì œì™¸í•˜ê³  ì˜ˆì‚° ë°ì´í„°ì—ì„œ ë§¤ì¹­
          if (budgetData.length > 1) {
            for (let i = 1; i < budgetData.length; i++) {
              const budgetRow = budgetData[i];
              if (budgetRow.length >= 12) { // 12ê°œ ì»¬ëŸ¼ í•„ìš”
                const budgetModelName = budgetRow[5]; // Fì—´: ëª¨ë¸ëª… (ê¸°ì¡´ Cì—´ì—ì„œ 3ì—´ ë°€ë¦¼)
                const budgetArmyType = budgetRow[6]; // Gì—´: êµ° (ê¸°ì¡´ Dì—´ì—ì„œ 3ì—´ ë°€ë¦¼)
                const budgetCategoryType = budgetRow[7]; // Hì—´: ìœ í˜• (ê¸°ì¡´ Eì—´ì—ì„œ 3ì—´ ë°€ë¦¼)
                const budgetUsedAmount = parseFloat((budgetRow[9] || '').toString().replace(/,/g, '')) || 0; // Jì—´: ì‚¬ìš© ì˜ˆì‚° (ê¸°ì¡´ Gì—´ì—ì„œ 3ì—´ ë°€ë¦¼)
                const budgetSecuredAmount = parseFloat((budgetRow[8] || '').toString().replace(/,/g, '')) || 0; // Iì—´: í™•ë³´ ì˜ˆì‚° (ê¸°ì¡´ Fì—´ì—ì„œ 3ì—´ ë°€ë¦¼)

                // ì•¡ë©´ì˜ˆì‚° Aì—´ì˜ ëª¨ë¸ëª…ê³¼ ë¹„êµ
                const activationModelName = row[0]; // Aì—´: ëª¨ë¸ëª…

                // ëª¨ë¸ëª…, êµ°, ìœ í˜•ì´ ëª¨ë‘ ì¼ì¹˜í•˜ëŠ” ê²½ìš°
                if (budgetModelName === activationModelName &&
                  budgetArmyType === mappedArmyType &&
                  budgetCategoryType === mappedCategoryType) {
                  calculatedBudgetValue = budgetUsedAmount;
                  securedBudgetValue = budgetSecuredAmount;
                  matchFound = true;
                  successfulMatches++;
                  // ë§¤ì¹­ ì„±ê³µ
                  break;
                }
              }
            }
          }

          if (!matchFound) {
            // ë§¤ì¹­ ì‹¤íŒ¨ ì›ì¸ ë¶„ì„
            const activationModelName = row[0]; // Aì—´: ëª¨ë¸ëª…
            // ë§¤ì¹­ ì‹¤íŒ¨

            // ì•¡ë©´_í™ë‚¨ì˜¥ì—ì„œ í•´ë‹¹ ëª¨ë¸ëª…ì´ ìˆëŠ”ì§€ í™•ì¸
            const modelExists = budgetData.slice(1).some(budgetRow =>
              budgetRow.length >= 12 && budgetRow[5] === activationModelName
            );

            if (!modelExists) {
              modelMismatch++;
              // ëª¨ë¸ëª… ë¶ˆì¼ì¹˜
            } else {
              // ëª¨ë¸ì€ ìˆì§€ë§Œ êµ°/ìœ í˜•ì´ ë‹¤ë¥¸ ê²½ìš°
              const matchingBudgetRows = budgetData.slice(1).filter(budgetRow =>
                budgetRow.length >= 12 && budgetRow[5] === activationModelName
              );

              const armyTypeExists = matchingBudgetRows.some(budgetRow => budgetRow[6] === mappedArmyType);
              const categoryTypeExists = matchingBudgetRows.some(budgetRow => budgetRow[7] === mappedCategoryType);

              if (!armyTypeExists) {
                armyTypeMismatch++;
                // ì •ì±…êµ° ë¶ˆì¼ì¹˜
              }
              if (!categoryTypeExists) {
                categoryTypeMismatch++;
                // ìœ í˜• ë¶ˆì¼ì¹˜
              }
            }
          }

          // ë§¤í•‘ëœ ë°ì´í„° ì €ì¥
          calculatedData.push({
            rowIndex: actualRowNumber, // ì‹¤ì œ í–‰ ë²ˆí˜¸
            policyGroup,
            armyType: mappedArmyType,
            categoryType: mappedCategoryType,
            budgetValue: calculatedBudgetValue,
            securedBudget: securedBudgetValue, // í™•ë³´ì˜ˆì‚° ì¶”ê°€
            remainingBudget: securedBudgetValue - calculatedBudgetValue, // ì˜ˆì‚°ì”ì•¡ ì¶”ê°€ (í™•ë³´ì˜ˆì‚° - ì‚¬ìš©ì˜ˆì‚°)
            receptionDate: receptionDate && !isNaN(receptionDate.getTime()) ? receptionDate.toISOString() : null,
            activationDate: activationDate && !isNaN(activationDate.getTime()) ? activationDate.toISOString() : null
          });

          totalUsedBudget += calculatedBudgetValue;
          totalSecuredBudget += securedBudgetValue;
          totalRemainingBudget += (securedBudgetValue - calculatedBudgetValue);

          // ì•¡ë©´ì˜ˆì‚° íƒ€ì…ì— ë”°ë¼ ë‹¤ë¥¸ ì»¬ëŸ¼ ì—…ë°ì´íŠ¸
          // ì•¡ë©´ì˜ˆì‚°(â… ): Lì—´(ì˜ˆì‚°ì”ì•¡), Mì—´(í™•ë³´ì˜ˆì‚°), Nì—´(ì‚¬ìš©ì˜ˆì‚°)
          // ì•¡ë©´ì˜ˆì‚°(â…¡): Iì—´(ì˜ˆì‚°ì”ì•¡), Jì—´(í™•ë³´ì˜ˆì‚°), Kì—´(ì‚¬ìš©ì˜ˆì‚°)
          let remainingCol, securedCol, usedCol;
          let remainingIdx, securedIdx, usedIdx;

          if (budgetType === 'â…¡') {
            // ì•¡ë©´ì˜ˆì‚°(â…¡): I, J, Kì—´
            remainingCol = 'I'; securedCol = 'J'; usedCol = 'K';
            remainingIdx = 8; securedIdx = 9; usedIdx = 10; // I=9ë²ˆì§¸(8), J=10ë²ˆì§¸(9), K=11ë²ˆì§¸(10)
          } else {
            // ì•¡ë©´ì˜ˆì‚°(â… ): L, M, Nì—´ (ê¸°ë³¸ê°’)
            remainingCol = 'L'; securedCol = 'M'; usedCol = 'N';
            remainingIdx = 11; securedIdx = 12; usedIdx = 13; // L=12ë²ˆì§¸(11), M=13ë²ˆì§¸(12), N=14ë²ˆì§¸(13)
          }

          // ì „ì²´ ì¬ê³„ì‚°ì—ì„œëŠ” ê¸°ì¡´ ê°’ê³¼ ê´€ê³„ì—†ì´ í•­ìƒ ì—…ë°ì´íŠ¸ (ë°ì´í„° ìœ„ì¹˜ ë³€ê²½ ëŒ€ì‘)
          // ì˜ˆì‚°ì”ì•¡ ì—…ë°ì´íŠ¸
          updateRequests.push({
            range: `ì•¡ë©´ì˜ˆì‚°!${remainingCol}${actualRowNumber}`,
            values: [[securedBudgetValue - calculatedBudgetValue]]
          });

          // í™•ë³´ì˜ˆì‚° ì—…ë°ì´íŠ¸
          updateRequests.push({
            range: `ì•¡ë©´ì˜ˆì‚°!${securedCol}${actualRowNumber}`,
            values: [[securedBudgetValue]]
          });

          // ì‚¬ìš©ì˜ˆì‚° ì—…ë°ì´íŠ¸
          updateRequests.push({
            range: `ì•¡ë©´ì˜ˆì‚°!${usedCol}${actualRowNumber}`,
            values: [[calculatedBudgetValue]]
          });

          // ì…ë ¥ì/ì…ë ¥ì¼ì‹œ ì»¬ëŸ¼ ì—…ë°ì´íŠ¸ (ê¸°ì¡´ ì €ì¥ ë²„íŠ¼ê³¼ ë™ì¼í•œ í˜•ì‹)
          if (budgetType === 'â…¡') {
            // ì•¡ë©´ì˜ˆì‚°(â…¡): Bì—´(ì…ë ¥ì), Cì—´(ì…ë ¥ì¼ì‹œ)
            updateRequests.push({
              range: `ì•¡ë©´ì˜ˆì‚°!B${actualRowNumber}`,
              values: [[`${userName}(${budgetType})`]]
            });
            updateRequests.push({
              range: `ì•¡ë©´ì˜ˆì‚°!C${actualRowNumber}`,
              values: [[`${new Date().toISOString()} (${budgetType})`]]
            });
          } else {
            // ì•¡ë©´ì˜ˆì‚°(â… ): Dì—´(ì…ë ¥ì), Eì—´(ì…ë ¥ì¼ì‹œ)
            updateRequests.push({
              range: `ì•¡ë©´ì˜ˆì‚°!D${actualRowNumber}`,
              values: [[`${userName}(${budgetType})`]]
            });
            updateRequests.push({
              range: `ì•¡ë©´ì˜ˆì‚°!E${actualRowNumber}`,
              values: [[`${new Date().toISOString()} (${budgetType})`]]
            });
          }
        } else {
          // ë‚ ì§œ ë²”ìœ„ì— í¬í•¨ë˜ì§€ ì•ŠëŠ” ê²½ìš° ê³µë°±ìœ¼ë¡œ ì„¤ì • (ë°ì´í„° ì†ìƒ ë°©ì§€)
          dateRangeFiltered++;
          // ë‚ ì§œ ë²”ìœ„ ì œì™¸
          updateRequests.push({
            range: `ì•¡ë©´ì˜ˆì‚°!L${actualRowNumber}`,
            values: [['']] // ì˜ˆì‚°ì”ì•¡ ê³µë°±
          });
          updateRequests.push({
            range: `ì•¡ë©´ì˜ˆì‚°!M${actualRowNumber}`,
            values: [['']] // í™•ë³´ì˜ˆì‚° ê³µë°±
          });
          updateRequests.push({
            range: `ì•¡ë©´ì˜ˆì‚°!N${actualRowNumber}`,
            values: [['']] // ì‚¬ìš©ì˜ˆì‚° ê³µë°±
          });
        }
      } else {
        // ì„ íƒë˜ì§€ ì•Šì€ ì •ì±…ê·¸ë£¹ì˜ ê²½ìš° ê³µë°±ìœ¼ë¡œ ì„¤ì • (ë°ì´í„° ì†ìƒ ë°©ì§€)
        policyGroupFiltered++;
        // ì •ì±…ê·¸ë£¹ ì œì™¸
        updateRequests.push({
          range: `ì•¡ë©´ì˜ˆì‚°!L${actualRowNumber}`,
          values: [['']] // ì˜ˆì‚°ì”ì•¡ ê³µë°±
        });
        updateRequests.push({
          range: `ì•¡ë©´ì˜ˆì‚°!M${actualRowNumber}`,
          values: [['']] // í™•ë³´ì˜ˆì‚° ê³µë°±
        });
        updateRequests.push({
          range: `ì•¡ë©´ì˜ˆì‚°!N${actualRowNumber}`,
          values: [['']] // ì‚¬ìš©ì˜ˆì‚° ê³µë°±
        });
      }
    }
  });

  // í†µê³„ ìš”ì•½
  console.log(`ğŸ“Š [calculateUsageBudget] ì™„ë£Œ - ì²˜ë¦¬: ${activationRows.length - 1}í–‰, ë§¤ì¹­: ${successfulMatches}ê°œ`);
  console.log(`  - ì´ í™•ë³´ì˜ˆì‚°: ${totalSecuredBudget}`);
  console.log(`  - ì´ ì‚¬ìš©ì˜ˆì‚°: ${totalUsedBudget}`);
  console.log(`  - ì´ ì˜ˆì‚°ì”ì•¡: ${totalRemainingBudget}`);
  console.log('ğŸš¨ [TRACE] calculateUsageBudget í•¨ìˆ˜ ì™„ë£Œ:', new Date().toISOString());

  // ì•¡ë©´ì˜ˆì‚° ì‹œíŠ¸ì˜ Lì—´, Mì—´, Nì—´ ì¼ê´„ ì—…ë°ì´íŠ¸ (ê¸°ì¡´ A, B, Cì—´ì—ì„œ +11)
  if (updateRequests.length > 0) {
    console.log('ğŸš¨ [TRACE] batchUpdate ì‹œì‘ - ì•¡ë©´ì˜ˆì‚°:', new Date().toISOString());
    await sheets.spreadsheets.values.batchUpdate({
      spreadsheetId: sheetId,
      resource: {
        valueInputOption: 'RAW',
        data: updateRequests
      }
    });
    console.log('ğŸš¨ [TRACE] batchUpdate ì™„ë£Œ - ì•¡ë©´ì˜ˆì‚°:', new Date().toISOString());
  }

  return {
    totalSecuredBudget,
    totalUsedBudget,
    totalRemainingBudget,
    calculatedData,
    updatedRows: updateRequests.length,
    message: 'ì˜ˆì‚° ê³„ì‚°ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.'
  };
}

// ì‚¬ìš©ì˜ˆì‚° ê³„ì‚° API
app.post('/api/budget/calculate-usage', async (req, res) => {
  try {
    const { sheetId, selectedPolicyGroups, dateRange, userName, budgetType } = req.body;

    if (!sheetId || !selectedPolicyGroups || !Array.isArray(selectedPolicyGroups)) {
      return res.status(400).json({ error: 'í•„ìˆ˜ íŒŒë¼ë¯¸í„°ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.' });
    }

    const result = await calculateUsageBudget(sheetId, selectedPolicyGroups, dateRange, userName, budgetType);
    res.json(result);

  } catch (error) {
    console.error('ì‚¬ìš©ì˜ˆì‚° ê³„ì‚° ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'ì‚¬ìš©ì˜ˆì‚° ê³„ì‚° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
  }
});

// Multer ì—ëŸ¬ í•¸ë“¤ë§ ë¯¸ë“¤ì›¨ì–´ (CORS í—¤ë” í¬í•¨, multer ì—ëŸ¬ íŠ¹ë³„ ì²˜ë¦¬)
app.use((error, req, res, next) => {
  // CORS í—¤ë”ë¥¼ ë¨¼ì € ì„¤ì •í•˜ì—¬ ì—ëŸ¬ ì‘ë‹µì—ë„ í¬í•¨
  const corsOrigins = process.env.CORS_ORIGIN?.split(',') || [];
  const defaultOrigins = [
    'https://vipmobile.vercel.app',
    'http://localhost:3000',
    'http://localhost:3001',
    'http://localhost:4000'
  ];
  const allowedOrigins = [...corsOrigins, ...defaultOrigins];
  const origin = req.headers.origin;

  if (origin && allowedOrigins.includes(origin)) {
    res.header('Access-Control-Allow-Origin', origin);
  } else if (allowedOrigins.length > 0) {
    res.header('Access-Control-Allow-Origin', allowedOrigins[0]);
  }
  res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS, PATCH');
  res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With, Origin, Accept, X-API-Key');
  res.header('Access-Control-Allow-Credentials', 'true');

  // Multer ì—ëŸ¬ íŠ¹ë³„ ì²˜ë¦¬ (multerê°€ ì •ì˜ëœ ê²½ìš°ì—ë§Œ)
  if (multer && multer.MulterError && error instanceof multer.MulterError) {
    console.error('ğŸš¨ [Multerì—ëŸ¬]', error.code, error.message);
    if (error.code === 'LIMIT_FILE_SIZE') {
      return res.status(400).json({
        success: false,
        error: 'íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. ìµœëŒ€ 25MBê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.',
        code: error.code
      });
    }
    return res.status(400).json({
      success: false,
      error: `íŒŒì¼ ì—…ë¡œë“œ ì˜¤ë¥˜: ${error.message}`,
      code: error.code
    });
  }

  console.error('ğŸš¨ [ì„œë²„ì—ëŸ¬]', error);

  res.status(500).json({
    success: false,
    error: 'ì„œë²„ ë‚´ë¶€ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
    message: error.message,
    timestamp: new Date().toISOString()
  });
});

// ==================== ê°€ì…ìì¦ê° ê´€ë ¨ API ====================

// ê°€ì…ìì¦ê° API OPTIONS ìš”ì²­ ì²˜ë¦¬
app.options('/api/subscriber-increase/*', (req, res) => {
  const corsOrigins = process.env.CORS_ORIGIN?.split(',') || [];
  const defaultOrigins = [
    'https://vipmobile.vercel.app',
    'http://localhost:3000',
    'http://localhost:3001',
    'http://localhost:4000'
  ];
  const allowedOrigins = [...corsOrigins, ...defaultOrigins];
  const origin = req.headers.origin;

  if (origin && allowedOrigins.includes(origin)) {
    res.header('Access-Control-Allow-Origin', origin);
  } else if (allowedOrigins.length > 0) {
    res.header('Access-Control-Allow-Origin', allowedOrigins[0]);
  } else if (origin) {
    res.header('Access-Control-Allow-Origin', origin);
  }
  res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS, PATCH');
  res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With, Origin, Accept, X-API-Key');
  res.header('Access-Control-Allow-Credentials', 'true');
  res.header('Access-Control-Max-Age', '86400'); // 24ì‹œê°„ ìºì‹œ
  res.status(200).end();
});

// ê°€ì…ìì¦ê° ê¶Œí•œ í™•ì¸ API
app.get('/api/subscriber-increase/access', async (req, res) => {
  // CORS í—¤ë” ì„¤ì •
  const allowedOrigins = [
    'https://vipmobile.vercel.app',
    'http://localhost:3000',
    'http://localhost:3001'
  ];

  const origin = req.headers.origin;
  if (allowedOrigins.includes(origin)) {
    res.header('Access-Control-Allow-Origin', origin);
  }
  res.header('Access-Control-Allow-Credentials', 'true');

  try {
    // ëŒ€ë¦¬ì ì•„ì´ë””ê´€ë¦¬ ì‹œíŠ¸ì—ì„œ Kì—´ ê¶Œí•œ í™•ì¸ (ì±„ê¶Œì¥í‘œ ë©”ë‰´ ê¶Œí•œ) (ê¸°ì¡´ Iì—´ â†’ Kì—´)
    const agentResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${AGENT_SHEET_NAME}!A:L`
    });

    if (!agentResponse.data.values || agentResponse.data.values.length === 0) {
      throw new Error('Failed to fetch agent data');
    }

    // í—¤ë” ì œê±°
    const agentRows = agentResponse.data.values.slice(1);

    // Kì—´ì—ì„œ "O" ê¶Œí•œì´ ìˆëŠ” ëŒ€ë¦¬ì  ì°¾ê¸° (ì±„ê¶Œì¥í‘œ ë©”ë‰´ ê¶Œí•œ) (ê¸°ì¡´ Iì—´ â†’ Kì—´)
    const authorizedAgents = agentRows
      .filter(row => row && row.length > 10 && row[10] === 'O') // Kì—´ (10ë²ˆ ì¸ë±ìŠ¤)
      .map(row => ({
        agentCode: row[0] || '', // Aì—´: ëŒ€ë¦¬ì ì½”ë“œ
        agentName: row[1] || '', // Bì—´: ëŒ€ë¦¬ì ëª…
        accessLevel: row[10] || '' // Kì—´: ì±„ê¶Œì¥í‘œ ë©”ë‰´ ì ‘ê·¼ê¶Œí•œ
      }));

    res.json({
      success: true,
      hasAccess: authorizedAgents.length > 0,
      authorizedAgents,
      totalAgents: agentRows.length,
      authorizedCount: authorizedAgents.length
    });
  } catch (error) {
    console.error('Error checking subscriber increase access:', error);
    res.status(500).json({
      success: false,
      hasAccess: false,
      error: 'Failed to check subscriber increase access',
      message: error.message
    });
  }
});

// ê°€ì…ìì¦ê° ì‹œíŠ¸ ì´ˆê¸°í™”/ìƒì„± API
app.post('/api/subscriber-increase/init-sheet', async (req, res) => {
  // CORS í—¤ë” ì„¤ì •
  const allowedOrigins = [
    'https://vipmobile.vercel.app',
    'http://localhost:3000',
    'http://localhost:3001'
  ];

  const origin = req.headers.origin;
  if (allowedOrigins.includes(origin)) {
    res.header('Access-Control-Allow-Origin', origin);
  }
  res.header('Access-Control-Allow-Credentials', 'true');

  try {
    // ì‹œíŠ¸ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
    const spreadsheetResponse = await sheets.spreadsheets.get({
      spreadsheetId: SPREADSHEET_ID
    });

    const existingSheets = spreadsheetResponse.data.sheets || [];
    const targetSheet = existingSheets.find(sheet => sheet.properties.title === SUBSCRIBER_INCREASE_SHEET_NAME);

    if (targetSheet) {
      // ì‹œíŠ¸ê°€ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê²½ìš° ê¸°ì¡´ ë°ì´í„° í™•ì¸
      const dataResponse = await sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: `${SUBSCRIBER_INCREASE_SHEET_NAME}!A:AA`
      });

      const existingData = dataResponse.data.values || [];

      // ë°ì´í„°ê°€ ë¹„ì–´ìˆìœ¼ë©´ ì´ˆê¸° ë°ì´í„° ì…ë ¥
      if (existingData.length === 0) {
        console.log('ì‹œíŠ¸ê°€ ì¡´ì¬í•˜ì§€ë§Œ ë°ì´í„°ê°€ ë¹„ì–´ìˆìŒ. ì´ˆê¸° ë°ì´í„°ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.');

        // í—¤ë” ì„¤ì • (ëŒ€ë¦¬ì ì½”ë“œ, ëŒ€ë¦¬ì ëª…, êµ¬ë¶„, ë…„ì›” ì»¬ëŸ¼ë“¤)
        const headers = [
          'ëŒ€ë¦¬ì ì½”ë“œ', 'ëŒ€ë¦¬ì ëª…', 'êµ¬ë¶„',
          '2024ë…„ 1ì›”', '2024ë…„ 2ì›”', '2024ë…„ 3ì›”', '2024ë…„ 4ì›”', '2024ë…„ 5ì›”', '2024ë…„ 6ì›”',
          '2024ë…„ 7ì›”', '2024ë…„ 8ì›”', '2024ë…„ 9ì›”', '2024ë…„ 10ì›”', '2024ë…„ 11ì›”', '2024ë…„ 12ì›”',
          '2025ë…„ 1ì›”', '2025ë…„ 2ì›”', '2025ë…„ 3ì›”', '2025ë…„ 4ì›”', '2025ë…„ 5ì›”', '2025ë…„ 6ì›”',
          '2025ë…„ 7ì›”', '2025ë…„ 8ì›”', '2025ë…„ 9ì›”', '2025ë…„ 10ì›”', '2025ë…„ 11ì›”', '2025ë…„ 12ì›”'
        ];

        // ì´ˆê¸° ë°ì´í„° ì„¤ì •
        const initialData = [
          headers,
          ['í•©ê³„', 'í•©ê³„', 'ê°€ì…ììˆ˜', ...Array(24).fill('')],
          ['í•©ê³„', 'í•©ê³„', 'ê´€ë¦¬ìˆ˜ìˆ˜ë£Œ', ...Array(24).fill('')],
          ['306891', 'ê²½ìˆ˜', 'ê°€ì…ììˆ˜', ...Array(24).fill('')],
          ['306891', 'ê²½ìˆ˜', 'ê´€ë¦¬ìˆ˜ìˆ˜ë£Œ', ...Array(24).fill('')],
          ['315835', 'ê²½ì¸', 'ê°€ì…ììˆ˜', ...Array(24).fill('')],
          ['315835', 'ê²½ì¸', 'ê´€ë¦¬ìˆ˜ìˆ˜ë£Œ', ...Array(24).fill('')],
          ['315835(ì œì™¸)', 'ê²½ì¸(ì œì™¸)', 'ê°€ì…ììˆ˜', ...Array(24).fill('')],
          ['315835(ì œì™¸)', 'ê²½ì¸(ì œì™¸)', 'ê´€ë¦¬ìˆ˜ìˆ˜ë£Œ', ...Array(24).fill('')],
          ['316558', 'ë™ì„œìš¸', 'ê°€ì…ììˆ˜', ...Array(24).fill('')],
          ['316558', 'ë™ì„œìš¸', 'ê´€ë¦¬ìˆ˜ìˆ˜ë£Œ', ...Array(24).fill('')],
          ['314942', 'í˜¸ë‚¨', 'ê°€ì…ììˆ˜', ...Array(24).fill('')],
          ['314942', 'í˜¸ë‚¨', 'ê´€ë¦¬ìˆ˜ìˆ˜ë£Œ', ...Array(24).fill('')],
          ['316254', 'í˜¸ë‚¨2', 'ê°€ì…ììˆ˜', ...Array(24).fill('')],
          ['316254', 'í˜¸ë‚¨2', 'ê´€ë¦¬ìˆ˜ìˆ˜ë£Œ', ...Array(24).fill('')]
        ];

        // ë°ì´í„° ì…ë ¥
        await sheets.spreadsheets.values.update({
          spreadsheetId: SPREADSHEET_ID,
          range: `${SUBSCRIBER_INCREASE_SHEET_NAME}!A1:AA${initialData.length}`,
          valueInputOption: 'RAW',
          resource: { values: initialData }
        });

        return res.json({
          success: true,
          message: 'ì‹œíŠ¸ê°€ ì¡´ì¬í–ˆì§€ë§Œ ë°ì´í„°ê°€ ë¹„ì–´ìˆì–´ ì´ˆê¸° ë°ì´í„°ë¥¼ ì…ë ¥í–ˆìŠµë‹ˆë‹¤',
          data: initialData
        });
      }

      // 315835(ì œì™¸) í–‰ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ì—†ìœ¼ë©´ ì¶”ê°€
      const hasExcludedRow = existingData.some(row => row[0] === '315835(ì œì™¸)');
      if (!hasExcludedRow && existingData.length > 0) {
        console.log('315835(ì œì™¸) í–‰ì´ ì—†ì–´ì„œ ì¶”ê°€í•©ë‹ˆë‹¤.');

        // 315835 í–‰ ë‹¤ìŒì— 315835(ì œì™¸) í–‰ ì¶”ê°€
        const updatedData = [...existingData];
        const insertIndex = updatedData.findIndex(row => row[0] === '315835' && row[2] === 'ê´€ë¦¬ìˆ˜ìˆ˜ë£Œ') + 1;

        const excludedSubscriberRow = ['315835(ì œì™¸)', 'ê²½ì¸(ì œì™¸)', 'ê°€ì…ììˆ˜', ...Array(24).fill('')];
        const excludedFeeRow = ['315835(ì œì™¸)', 'ê²½ì¸(ì œì™¸)', 'ê´€ë¦¬ìˆ˜ìˆ˜ë£Œ', ...Array(24).fill('')];

        updatedData.splice(insertIndex, 0, excludedSubscriberRow, excludedFeeRow);

        // ì—…ë°ì´íŠ¸ëœ ë°ì´í„°ë¥¼ ì‹œíŠ¸ì— ì €ì¥
        await sheets.spreadsheets.values.update({
          spreadsheetId: SPREADSHEET_ID,
          range: `${SUBSCRIBER_INCREASE_SHEET_NAME}!A1:AA${updatedData.length}`,
          valueInputOption: 'RAW',
          resource: { values: updatedData }
        });

        return res.json({
          success: true,
          message: 'ì‹œíŠ¸ê°€ ì¡´ì¬í–ˆì§€ë§Œ 315835(ì œì™¸) í–‰ì´ ì—†ì–´ì„œ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤',
          data: updatedData
        });
      }

      return res.json({
        success: true,
        message: 'ì‹œíŠ¸ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤',
        data: existingData
      });
    }

    // ì‹œíŠ¸ ìƒì„±
    const createSheetRequest = {
      spreadsheetId: SPREADSHEET_ID,
      resource: {
        requests: [{
          addSheet: {
            properties: {
              title: SUBSCRIBER_INCREASE_SHEET_NAME,
              gridProperties: {
                rowCount: 20,
                columnCount: 27  // 27ê°œ ì»¬ëŸ¼ (Aë¶€í„° AAê¹Œì§€)
              }
            }
          }
        }]
      }
    };

    await sheets.spreadsheets.batchUpdate(createSheetRequest);

    // í—¤ë” ì„¤ì • (ëŒ€ë¦¬ì ì½”ë“œ, ëŒ€ë¦¬ì ëª…, êµ¬ë¶„, ë…„ì›” ì»¬ëŸ¼ë“¤)
    const headers = [
      'ëŒ€ë¦¬ì ì½”ë“œ', 'ëŒ€ë¦¬ì ëª…', 'êµ¬ë¶„',
      '2024ë…„ 1ì›”', '2024ë…„ 2ì›”', '2024ë…„ 3ì›”', '2024ë…„ 4ì›”', '2024ë…„ 5ì›”', '2024ë…„ 6ì›”',
      '2024ë…„ 7ì›”', '2024ë…„ 8ì›”', '2024ë…„ 9ì›”', '2024ë…„ 10ì›”', '2024ë…„ 11ì›”', '2024ë…„ 12ì›”',
      '2025ë…„ 1ì›”', '2025ë…„ 2ì›”', '2025ë…„ 3ì›”', '2025ë…„ 4ì›”', '2025ë…„ 5ì›”', '2025ë…„ 6ì›”',
      '2025ë…„ 7ì›”', '2025ë…„ 8ì›”', '2025ë…„ 9ì›”', '2025ë…„ 10ì›”', '2025ë…„ 11ì›”', '2025ë…„ 12ì›”'
    ];

    // ì´ˆê¸° ë°ì´í„° ì„¤ì •
    const initialData = [
      headers,
      ['í•©ê³„', 'í•©ê³„', 'ê°€ì…ììˆ˜', ...Array(24).fill('')],
      ['í•©ê³„', 'í•©ê³„', 'ê´€ë¦¬ìˆ˜ìˆ˜ë£Œ', ...Array(24).fill('')],
      ['306891', 'ê²½ìˆ˜', 'ê°€ì…ììˆ˜', ...Array(24).fill('')],
      ['306891', 'ê²½ìˆ˜', 'ê´€ë¦¬ìˆ˜ìˆ˜ë£Œ', ...Array(24).fill('')],
      ['315835', 'ê²½ì¸', 'ê°€ì…ììˆ˜', ...Array(24).fill('')],
      ['315835', 'ê²½ì¸', 'ê´€ë¦¬ìˆ˜ìˆ˜ë£Œ', ...Array(24).fill('')],
      ['316558', 'ë™ì„œìš¸', 'ê°€ì…ììˆ˜', ...Array(24).fill('')],
      ['316558', 'ë™ì„œìš¸', 'ê´€ë¦¬ìˆ˜ìˆ˜ë£Œ', ...Array(24).fill('')],
      ['314942', 'í˜¸ë‚¨', 'ê°€ì…ììˆ˜', ...Array(24).fill('')],
      ['314942', 'í˜¸ë‚¨', 'ê´€ë¦¬ìˆ˜ìˆ˜ë£Œ', ...Array(24).fill('')],
      ['316254', 'í˜¸ë‚¨2', 'ê°€ì…ììˆ˜', ...Array(24).fill('')],
      ['316254', 'í˜¸ë‚¨2', 'ê´€ë¦¬ìˆ˜ìˆ˜ë£Œ', ...Array(24).fill('')]
    ];

    // ë°ì´í„° ì…ë ¥
    await sheets.spreadsheets.values.update({
      spreadsheetId: SPREADSHEET_ID,
      range: `${SUBSCRIBER_INCREASE_SHEET_NAME}!A1:AA${initialData.length}`,
      valueInputOption: 'RAW',
      resource: { values: initialData }
    });

    res.json({
      success: true,
      message: 'ê°€ì…ìì¦ê° ì‹œíŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤',
      data: initialData
    });

  } catch (error) {
    console.error('Error initializing subscriber increase sheet:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to initialize sheet',
      message: error.message
    });
  }
});

// ê°€ì…ìì¦ê° ì‹œíŠ¸ì— 315835(ì œì™¸) í–‰ ì¶”ê°€ API
app.post('/api/subscriber-increase/add-excluded-row', async (req, res) => {
  // CORS í—¤ë” ì„¤ì •
  const allowedOrigins = [
    'https://vipmobile.vercel.app',
    'http://localhost:3000',
    'http://localhost:3001'
  ];

  const origin = req.headers.origin;
  if (allowedOrigins.includes(origin)) {
    res.header('Access-Control-Allow-Origin', origin);
  }
  res.header('Access-Control-Allow-Credentials', 'true');

  try {
    // ê¸°ì¡´ ë°ì´í„° ì¡°íšŒ
    const dataResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${SUBSCRIBER_INCREASE_SHEET_NAME}!A:AA`
    });

    const existingData = dataResponse.data.values || [];
    if (existingData.length === 0) {
      return res.status(404).json({
        success: false,
        error: 'ì‹œíŠ¸ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'
      });
    }

    // 315835(ì œì™¸) í–‰ì´ ìˆëŠ”ì§€ í™•ì¸
    const hasExcludedRow = existingData.some(row => row[0] === '315835(ì œì™¸)');
    if (hasExcludedRow) {
      return res.json({
        success: true,
        message: '315835(ì œì™¸) í–‰ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤',
        data: existingData
      });
    }

    console.log('315835(ì œì™¸) í–‰ì´ ì—†ì–´ì„œ ì¶”ê°€í•©ë‹ˆë‹¤.');

    // 315835 í–‰ ë‹¤ìŒì— 315835(ì œì™¸) í–‰ ì¶”ê°€
    const updatedData = [...existingData];
    const insertIndex = updatedData.findIndex(row => row[0] === '315835' && row[2] === 'ê´€ë¦¬ìˆ˜ìˆ˜ë£Œ') + 1;

    const excludedSubscriberRow = ['315835(ì œì™¸)', 'ê²½ì¸(ì œì™¸)', 'ê°€ì…ììˆ˜', ...Array(24).fill('')];
    const excludedFeeRow = ['315835(ì œì™¸)', 'ê²½ì¸(ì œì™¸)', 'ê´€ë¦¬ìˆ˜ìˆ˜ë£Œ', ...Array(24).fill('')];

    updatedData.splice(insertIndex, 0, excludedSubscriberRow, excludedFeeRow);

    // ì—…ë°ì´íŠ¸ëœ ë°ì´í„°ë¥¼ ì‹œíŠ¸ì— ì €ì¥
    await sheets.spreadsheets.values.update({
      spreadsheetId: SPREADSHEET_ID,
      range: `${SUBSCRIBER_INCREASE_SHEET_NAME}!A1:AA${updatedData.length}`,
      valueInputOption: 'RAW',
      resource: { values: updatedData }
    });

    res.json({
      success: true,
      message: '315835(ì œì™¸) í–‰ì´ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤',
      data: updatedData
    });

  } catch (error) {
    console.error('Error adding excluded row:', error);
    res.status(500).json({
      success: false,
      error: '315835(ì œì™¸) í–‰ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤',
      message: error.message
    });
  }
});

// ê°€ì…ìì¦ê° ë°ì´í„° ì¡°íšŒ API
app.get('/api/subscriber-increase/data', async (req, res) => {
  // CORS í—¤ë” ì„¤ì •
  const allowedOrigins = [
    'https://vipmobile.vercel.app',
    'http://localhost:3000',
    'http://localhost:3001'
  ];

  const origin = req.headers.origin;
  if (allowedOrigins.includes(origin)) {
    res.header('Access-Control-Allow-Origin', origin);
  }
  res.header('Access-Control-Allow-Credentials', 'true');

  try {
    const dataResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${SUBSCRIBER_INCREASE_SHEET_NAME}!A:AA`
    });

    res.json({
      success: true,
      data: dataResponse.data.values || []
    });

  } catch (error) {
    console.error('Error fetching subscriber increase data:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to fetch data',
      message: error.message
    });
  }
});

// ê°€ì…ìì¦ê° ë°ì´í„° ì €ì¥ API
app.post('/api/subscriber-increase/save', async (req, res) => {
  // CORS í—¤ë” ì„¤ì •
  const allowedOrigins = [
    'https://vipmobile.vercel.app',
    'http://localhost:3000',
    'http://localhost:3001'
  ];

  const origin = req.headers.origin;
  if (allowedOrigins.includes(origin)) {
    res.header('Access-Control-Allow-Origin', origin);
  }
  res.header('Access-Control-Allow-Credentials', 'true');

  try {
    const { yearMonth, agentCode, type, value } = req.body;

    // ì…ë ¥ ë°ì´í„° ê²€ì¦
    if (!yearMonth || !agentCode || !type || value === undefined) {
      return res.status(400).json({
        success: false,
        error: 'í•„ìˆ˜ ë°ì´í„°ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤',
        required: ['yearMonth', 'agentCode', 'type', 'value']
      });
    }

    // ìˆ«ì ê²€ì¦
    if (type !== 'ê°€ì…ììˆ˜' && type !== 'ê´€ë¦¬ìˆ˜ìˆ˜ë£Œ') {
      return res.status(400).json({
        success: false,
        error: 'ì˜ëª»ëœ íƒ€ì…ì…ë‹ˆë‹¤. ê°€ì…ììˆ˜ ë˜ëŠ” ê´€ë¦¬ìˆ˜ìˆ˜ë£Œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤'
      });
    }

    // ê¸°ì¡´ ë°ì´í„° ì¡°íšŒ
    const dataResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${SUBSCRIBER_INCREASE_SHEET_NAME}!A:AA`
    });

    const existingData = dataResponse.data.values || [];
    if (existingData.length === 0) {
      return res.status(404).json({
        success: false,
        error: 'ì‹œíŠ¸ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'
      });
    }

    // í—¤ë”ì—ì„œ ë…„ì›” ì»¬ëŸ¼ ì¸ë±ìŠ¤ ì°¾ê¸°
    const headers = existingData[0];
    const yearMonthIndex = headers.findIndex(header => header === yearMonth);

    if (yearMonthIndex === -1) {
      return res.status(400).json({
        success: false,
        error: 'í•´ë‹¹ ë…„ì›” ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'
      });
    }

    // í•´ë‹¹ ëŒ€ë¦¬ì ê³¼ íƒ€ì…ì˜ í–‰ ì°¾ê¸°
    let targetRowIndex = -1;
    for (let i = 1; i < existingData.length; i++) {
      const row = existingData[i];
      if (row[0] === agentCode && row[2] === type) {
        targetRowIndex = i;
        break;
      }
    }

    if (targetRowIndex === -1) {
      return res.status(404).json({
        success: false,
        error: 'í•´ë‹¹ ëŒ€ë¦¬ì ê³¼ íƒ€ì…ì˜ í–‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'
      });
    }

    // ë°ì´í„° ì—…ë°ì´íŠ¸
    const updatedData = [...existingData];
    updatedData[targetRowIndex][yearMonthIndex] = value;

    // Google Sheetsì— ì €ì¥
    await sheets.spreadsheets.values.update({
      spreadsheetId: SPREADSHEET_ID,
      range: `${SUBSCRIBER_INCREASE_SHEET_NAME}!A${targetRowIndex + 1}:AA${targetRowIndex + 1}`,
      valueInputOption: 'RAW',
      resource: { values: [updatedData[targetRowIndex]] }
    });

    // í•©ê³„ ê³„ì‚° ë° ì—…ë°ì´íŠ¸
    await calculateAndUpdateTotals(SPREADSHEET_ID, SUBSCRIBER_INCREASE_SHEET_NAME, yearMonthIndex);

    res.json({
      success: true,
      message: 'ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤',
      data: {
        yearMonth,
        agentCode,
        type,
        value,
        rowIndex: targetRowIndex + 1,
        columnIndex: yearMonthIndex + 1
      }
    });

  } catch (error) {
    console.error('Error saving subscriber increase data:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to save data',
      message: error.message
    });
  }
});

// ê°€ì…ìì¦ê° ë°ì´í„° ì¼ê´„ ì €ì¥ API
app.post('/api/subscriber-increase/bulk-save', async (req, res) => {
  // CORS í—¤ë” ì„¤ì •
  const allowedOrigins = [
    'https://vipmobile.vercel.app',
    'http://localhost:3000',
    'http://localhost:3001'
  ];

  const origin = req.headers.origin;
  if (allowedOrigins.includes(origin)) {
    res.header('Access-Control-Allow-Origin', origin);
  } else {
    res.header('Access-Control-Allow-Origin', '*');
  }
  res.header('Access-Control-Allow-Credentials', 'true');
  res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
  res.header('Access-Control-Allow-Headers', 'Origin, X-Requested-With, Content-Type, Accept, Authorization');

  try {
    const { bulkData } = req.body; // [{ yearMonth, agentCode, type, value }, ...]

    if (!bulkData || !Array.isArray(bulkData) || bulkData.length === 0) {
      return res.status(400).json({
        success: false,
        error: 'ì¼ê´„ ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤'
      });
    }

    // ê¸°ì¡´ ë°ì´í„° ì¡°íšŒ (ë¹ˆë„ ì œí•œ ì ìš©)
    const dataResponse = await rateLimitedSheetsCall(async () => {
      return await sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: `${SUBSCRIBER_INCREASE_SHEET_NAME}!A:AA`
      });
    });

    const existingData = dataResponse.data.values || [];
    if (existingData.length === 0) {
      return res.status(404).json({
        success: false,
        error: 'ì‹œíŠ¸ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'
      });
    }

    const headers = existingData[0];
    const updatedData = [...existingData];
    const updateResults = [];
    const errors = [];

    // ê° ë°ì´í„° í•­ëª© ì²˜ë¦¬
    for (const item of bulkData) {
      try {
        const { yearMonth, agentCode, type, value } = item;

        // ì…ë ¥ ë°ì´í„° ê²€ì¦
        if (!yearMonth || !agentCode || !type || value === undefined) {
          errors.push({
            item,
            error: 'í•„ìˆ˜ ë°ì´í„°ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤'
          });
          continue;
        }

        // íƒ€ì… ê²€ì¦
        if (type !== 'ê°€ì…ììˆ˜' && type !== 'ê´€ë¦¬ìˆ˜ìˆ˜ë£Œ') {
          errors.push({
            item,
            error: 'ì˜ëª»ëœ íƒ€ì…ì…ë‹ˆë‹¤. ê°€ì…ììˆ˜ ë˜ëŠ” ê´€ë¦¬ìˆ˜ìˆ˜ë£Œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤'
          });
          continue;
        }

        // í—¤ë”ì—ì„œ ë…„ì›” ì»¬ëŸ¼ ì¸ë±ìŠ¤ ì°¾ê¸°
        const yearMonthIndex = headers.findIndex(header => header === yearMonth);

        if (yearMonthIndex === -1) {
          errors.push({
            item,
            error: 'í•´ë‹¹ ë…„ì›” ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'
          });
          continue;
        }

        // í•´ë‹¹ ëŒ€ë¦¬ì ê³¼ íƒ€ì…ì˜ í–‰ ì°¾ê¸°
        let targetRowIndex = -1;
        for (let i = 1; i < updatedData.length; i++) {
          const row = updatedData[i];
          if (row[0] === agentCode && row[2] === type) {
            targetRowIndex = i;
            break;
          }
        }

        if (targetRowIndex === -1) {
          errors.push({
            item,
            error: 'í•´ë‹¹ ëŒ€ë¦¬ì ê³¼ íƒ€ì…ì˜ í–‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'
          });
          continue;
        }

        // ë°ì´í„° ì—…ë°ì´íŠ¸
        updatedData[targetRowIndex][yearMonthIndex] = value;

        updateResults.push({
          yearMonth,
          agentCode,
          type,
          value,
          rowIndex: targetRowIndex + 1,
          columnIndex: yearMonthIndex + 1
        });

      } catch (itemError) {
        errors.push({
          item,
          error: itemError.message
        });
      }
    }

    // Google Sheetsì— ì¼ê´„ ì €ì¥ (ì „ì²´ ì‹œíŠ¸ ì—…ë°ì´íŠ¸) - ë¹ˆë„ ì œí•œ ì ìš©
    if (updateResults.length > 0) {
      await rateLimitedSheetsCall(async () => {
        return await sheets.spreadsheets.values.update({
          spreadsheetId: SPREADSHEET_ID,
          range: `${SUBSCRIBER_INCREASE_SHEET_NAME}!A:AA`,
          valueInputOption: 'RAW',
          resource: { values: updatedData }
        });
      });

      // í•©ê³„ ê³„ì‚° ë° ì—…ë°ì´íŠ¸ (ëª¨ë“  ì›”ì— ëŒ€í•´) - ë¹ˆë„ ì œí•œ ì ìš©
      const uniqueYearMonths = [...new Set(updateResults.map(r => r.yearMonth))];
      for (const yearMonth of uniqueYearMonths) {
        const yearMonthIndex = headers.findIndex(header => header === yearMonth);
        if (yearMonthIndex !== -1) {
          await rateLimitedSheetsCall(async () => {
            return await calculateAndUpdateTotals(SPREADSHEET_ID, SUBSCRIBER_INCREASE_SHEET_NAME, yearMonthIndex);
          });
        }
      }
    }

    res.json({
      success: true,
      message: `${updateResults.length}ê°œ ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤`,
      results: {
        successCount: updateResults.length,
        errorCount: errors.length,
        updatedData: updateResults,
        errors: errors
      }
    });

  } catch (error) {
    console.error('Error bulk saving subscriber increase data:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to bulk save data',
      message: error.message
    });
  }
});

// ê°€ì…ìì¦ê° ë°ì´í„° ì‚­ì œ API
app.post('/api/subscriber-increase/delete', async (req, res) => {
  // CORS í—¤ë” ì„¤ì •
  const allowedOrigins = [
    'https://vipmobile.vercel.app',
    'http://localhost:3000',
    'http://localhost:3001'
  ];

  const origin = req.headers.origin;
  if (allowedOrigins.includes(origin)) {
    res.header('Access-Control-Allow-Origin', origin);
  }
  res.header('Access-Control-Allow-Credentials', 'true');

  try {
    const { yearMonth, agentCode, type } = req.body;

    // ì…ë ¥ ë°ì´í„° ê²€ì¦
    if (!yearMonth || !agentCode || !type) {
      return res.status(400).json({
        success: false,
        error: 'í•„ìˆ˜ ë°ì´í„°ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤',
        required: ['yearMonth', 'agentCode', 'type']
      });
    }

    // ê¸°ì¡´ ë°ì´í„° ì¡°íšŒ
    const dataResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${SUBSCRIBER_INCREASE_SHEET_NAME}!A:AA`
    });

    const existingData = dataResponse.data.values || [];
    if (existingData.length === 0) {
      return res.status(404).json({
        success: false,
        error: 'ì‹œíŠ¸ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'
      });
    }

    // í—¤ë”ì—ì„œ ë…„ì›” ì»¬ëŸ¼ ì¸ë±ìŠ¤ ì°¾ê¸°
    const headers = existingData[0];
    const yearMonthIndex = headers.findIndex(header => header === yearMonth);

    if (yearMonthIndex === -1) {
      return res.status(400).json({
        success: false,
        error: 'í•´ë‹¹ ë…„ì›” ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'
      });
    }

    // í•´ë‹¹ ëŒ€ë¦¬ì ê³¼ íƒ€ì…ì˜ í–‰ ì°¾ê¸°
    let targetRowIndex = -1;
    for (let i = 1; i < existingData.length; i++) {
      const row = existingData[i];
      if (row[0] === agentCode && row[2] === type) {
        targetRowIndex = i;
        break;
      }
    }

    if (targetRowIndex === -1) {
      return res.status(404).json({
        success: false,
        error: 'í•´ë‹¹ ëŒ€ë¦¬ì ê³¼ íƒ€ì…ì˜ í–‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'
      });
    }

    // ë°ì´í„° ì‚­ì œ (ë¹ˆ ê°’ìœ¼ë¡œ ì„¤ì •)
    const updatedData = [...existingData];
    updatedData[targetRowIndex][yearMonthIndex] = '';

    // Google Sheetsì— ì €ì¥
    await sheets.spreadsheets.values.update({
      spreadsheetId: SPREADSHEET_ID,
      range: `${SUBSCRIBER_INCREASE_SHEET_NAME}!A${targetRowIndex + 1}:AA${targetRowIndex + 1}`,
      valueInputOption: 'RAW',
      resource: { values: [updatedData[targetRowIndex]] }
    });

    // í•©ê³„ ê³„ì‚° ë° ì—…ë°ì´íŠ¸
    await calculateAndUpdateTotals(SPREADSHEET_ID, SUBSCRIBER_INCREASE_SHEET_NAME, yearMonthIndex);

    res.json({
      success: true,
      message: 'ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤',
      data: {
        yearMonth,
        agentCode,
        type,
        rowIndex: targetRowIndex + 1,
        columnIndex: yearMonthIndex + 1
      }
    });

  } catch (error) {
    console.error('Error deleting subscriber increase data:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to delete data',
      message: error.message
    });
  }
});

// í•©ê³„ ê³„ì‚° ë° ì—…ë°ì´íŠ¸ í•¨ìˆ˜
async function calculateAndUpdateTotals(spreadsheetId, sheetName, yearMonthIndex) {
  try {
    // ê¸°ì¡´ ë°ì´í„° ì¡°íšŒ
    const dataResponse = await sheets.spreadsheets.values.get({
      spreadsheetId,
      range: `${sheetName}!A:AA`
    });

    const data = dataResponse.data.values || [];
    if (data.length < 3) return;

    // ê° íƒ€ì…ë³„ í•©ê³„ ê³„ì‚°
    const subscriberTotals = {};
    const feeTotals = {};

    for (let i = 3; i < data.length; i++) {
      const row = data[i];
      const agentCode = row[0];
      const type = row[2];
      const value = parseFloat(row[yearMonthIndex]) || 0;

      if (type === 'ê°€ì…ììˆ˜') {
        subscriberTotals[agentCode] = (subscriberTotals[agentCode] || 0) + value;
      } else if (type === 'ê´€ë¦¬ìˆ˜ìˆ˜ë£Œ') {
        feeTotals[agentCode] = (feeTotals[agentCode] || 0) + value;
      }
    }

    // í•©ê³„ ê³„ì‚°
    const totalSubscribers = Object.values(subscriberTotals).reduce((sum, val) => sum + val, 0);
    const totalFees = Object.values(feeTotals).reduce((sum, val) => sum + val, 0);

    // í•©ê³„ í–‰ ì—…ë°ì´íŠ¸
    const updatedData = [...data];
    updatedData[1][yearMonthIndex] = totalSubscribers; // ê°€ì…ììˆ˜ í•©ê³„
    updatedData[2][yearMonthIndex] = totalFees; // ê´€ë¦¬ìˆ˜ìˆ˜ë£Œ í•©ê³„

    // Google Sheetsì— í•©ê³„ ì—…ë°ì´íŠ¸
    await sheets.spreadsheets.values.update({
      spreadsheetId,
      range: `${sheetName}!A2:AA3`,
      valueInputOption: 'RAW',
      resource: { values: [updatedData[1], updatedData[2]] }
    });

  } catch (error) {
    console.error('Error calculating totals:', error);
  }
}

// ============================================
// ì¬ì´ˆë‹´ì´ˆì±„ê¶Œ API
// ============================================

// ì¬ì´ˆë‹´ì´ˆì±„ê¶Œ API OPTIONS ìš”ì²­ ì²˜ë¦¬ (ëª¨ë“  ì—”ë“œí¬ì¸íŠ¸ë³´ë‹¤ ì•ì— ìœ„ì¹˜)
app.options('/api/rechotancho-bond/*', (req, res) => {
  const corsOrigins = process.env.CORS_ORIGIN?.split(',') || [];
  const defaultOrigins = [
    'https://vipmobile.vercel.app',
    'http://localhost:3000',
    'http://localhost:3001',
    'http://localhost:4000'
  ];
  const allowedOrigins = [...corsOrigins, ...defaultOrigins];
  const origin = req.headers.origin;

  if (origin && allowedOrigins.includes(origin)) {
    res.header('Access-Control-Allow-Origin', origin);
  } else if (allowedOrigins.length > 0) {
    res.header('Access-Control-Allow-Origin', allowedOrigins[0]);
  }
  res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS, PATCH');
  res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With, Origin, Accept, X-API-Key');
  res.header('Access-Control-Allow-Credentials', 'true');
  res.header('Access-Control-Max-Age', '86400');
  res.status(200).end();
});

// ì¬ì´ˆë‹´ì´ˆì±„ê¶Œ ë°ì´í„° ì €ì¥
app.post('/api/rechotancho-bond/save', async (req, res) => {
  try {
    const { data, inputUser } = req.body;

    if (!data || !Array.isArray(data)) {
      return res.status(400).json({
        success: false,
        error: 'ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'
      });
    }

    const spreadsheetId = process.env.GOOGLE_SHEET_ID || process.env.SHEET_ID;
    const sheetName = 'ì¬ì´ˆë‹´ì´ˆì±„ê¶Œ_ë‚´ì—­';

    // í˜„ì¬ ì‹œê°„ ìƒì„± (KST)
    const now = new Date();
    const kstTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    const timestamp = kstTime.toISOString().replace('T', ' ').substring(0, 19);

    // ì‹œíŠ¸ì— ì €ì¥í•  í–‰ ìƒì„± (ë¹ˆ ê°’ë„ í—ˆìš©)
    const rows = data.map(item => [
      timestamp,                          // A: ì €ì¥ì¼ì‹œ
      item.agentCode,                     // B: ëŒ€ë¦¬ì ì½”ë“œ
      item.agentName,                     // C: ëŒ€ë¦¬ì ëª…
      Number(item.inventoryBond) || 0,    // D: ì¬ê³ ì´ˆê³¼ì±„ê¶Œ
      Number(item.collateralBond) || 0,   // E: ë‹´ë³´ì´ˆê³¼ì±„ê¶Œ
      Number(item.managementBond) || 0,   // F: ê´€ë¦¬ëŒ€ìƒì±„ê¶Œ
      inputUser || ''                     // G: ì…ë ¥ì
    ]);

    // Google Sheetsì— ë°ì´í„° ì¶”ê°€
    await rateLimitedSheetsCall(async () => {
      return await sheets.spreadsheets.values.append({
        spreadsheetId,
        range: `${sheetName}!A:G`,
        valueInputOption: 'RAW',
        resource: {
          values: rows
        }
      });
    });

    console.log(`âœ… ì¬ì´ˆë‹´ì´ˆì±„ê¶Œ ë°ì´í„° ì €ì¥ ì™„ë£Œ: ${timestamp}, ì…ë ¥ì: ${inputUser}, ${rows.length}ê°œ ëŒ€ë¦¬ì `);

    res.json({
      success: true,
      message: 'ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.',
      timestamp
    });

  } catch (error) {
    console.error('âŒ ì¬ì´ˆë‹´ì´ˆì±„ê¶Œ ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:', error);
    res.status(500).json({
      success: false,
      error: 'ë°ì´í„° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
      message: error.message
    });
  }
});

// ì¬ì´ˆë‹´ì´ˆì±„ê¶Œ ì €ì¥ ì‹œì  ëª©ë¡ ì¡°íšŒ
app.get('/api/rechotancho-bond/history', async (req, res) => {
  // CORS í—¤ë” ì„¤ì •
  const corsOrigins = process.env.CORS_ORIGIN?.split(',') || [];
  const defaultOrigins = [
    'https://vipmobile.vercel.app',
    'http://localhost:3000',
    'http://localhost:3001',
    'http://localhost:4000'
  ];
  const allowedOrigins = [...corsOrigins, ...defaultOrigins];
  const origin = req.headers.origin;

  if (origin && allowedOrigins.includes(origin)) {
    res.header('Access-Control-Allow-Origin', origin);
  } else if (allowedOrigins.length > 0) {
    res.header('Access-Control-Allow-Origin', allowedOrigins[0]);
  }
  res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS, PATCH');
  res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With, Origin, Accept, X-API-Key');
  res.header('Access-Control-Allow-Credentials', 'true');

  try {
    const spreadsheetId = process.env.GOOGLE_SHEET_ID || process.env.SHEET_ID;
    const sheetName = 'ì¬ì´ˆë‹´ì´ˆì±„ê¶Œ_ë‚´ì—­';

    // ì‹œíŠ¸ ë°ì´í„° ì¡°íšŒ
    const response = await rateLimitedSheetsCall(async () => {
      return await sheets.spreadsheets.values.get({
        spreadsheetId,
        range: `${sheetName}!A:G`
      });
    });

    const rows = response.data.values || [];

    if (rows.length <= 1) {
      return res.json({
        success: true,
        data: []
      });
    }

    // í—¤ë” ì œì™¸í•˜ê³  ë°ì´í„° í–‰ë§Œ ì²˜ë¦¬
    const dataRows = rows.slice(1);

    // ì €ì¥ ì‹œì ë³„ë¡œ ê·¸ë£¹í™” (ì¤‘ë³µ ì œê±°)
    const timestampMap = new Map();

    dataRows.forEach(row => {
      const timestamp = row[0];
      const inputUser = row[6];

      if (timestamp && !timestampMap.has(timestamp)) {
        timestampMap.set(timestamp, {
          timestamp,
          inputUser: inputUser || 'ë¯¸ìƒ'
        });
      }
    });

    // ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬
    const history = Array.from(timestampMap.values())
      .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

    console.log(`âœ… ì¬ì´ˆë‹´ì´ˆì±„ê¶Œ ì €ì¥ ì‹œì  ì¡°íšŒ ì™„ë£Œ: ${history.length}ê°œ`);

    res.json({
      success: true,
      data: history
    });

  } catch (error) {
    console.error('âŒ ì¬ì´ˆë‹´ì´ˆì±„ê¶Œ ì €ì¥ ì‹œì  ì¡°íšŒ ì‹¤íŒ¨:', error);
    // CORS í—¤ë” ì„¤ì • (ì—ëŸ¬ ì‘ë‹µì—ë„ í¬í•¨)
    const corsOrigins = process.env.CORS_ORIGIN?.split(',') || [];
    const defaultOrigins = [
      'https://vipmobile.vercel.app',
      'http://localhost:3000',
      'http://localhost:3001',
      'http://localhost:4000'
    ];
    const allowedOrigins = [...corsOrigins, ...defaultOrigins];
    const origin = req.headers.origin;

    if (origin && allowedOrigins.includes(origin)) {
      res.header('Access-Control-Allow-Origin', origin);
    } else if (allowedOrigins.length > 0) {
      res.header('Access-Control-Allow-Origin', allowedOrigins[0]);
    }
    res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS, PATCH');
    res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With, Origin, Accept, X-API-Key');
    res.header('Access-Control-Allow-Credentials', 'true');

    res.status(500).json({
      success: false,
      error: 'ì €ì¥ ì‹œì  ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
      message: error.message
    });
  }
});

// íŠ¹ì • ì‹œì ì˜ ì¬ì´ˆë‹´ì´ˆì±„ê¶Œ ë°ì´í„° ì¡°íšŒ
app.get('/api/rechotancho-bond/data/:timestamp', async (req, res) => {
  try {
    const { timestamp } = req.params;

    if (!timestamp) {
      return res.status(400).json({
        success: false,
        error: 'ì‹œì  ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }

    const spreadsheetId = process.env.GOOGLE_SHEET_ID || process.env.SHEET_ID;
    const sheetName = 'ì¬ì´ˆë‹´ì´ˆì±„ê¶Œ_ë‚´ì—­';

    // ì‹œíŠ¸ ë°ì´í„° ì¡°íšŒ
    const response = await rateLimitedSheetsCall(async () => {
      return await sheets.spreadsheets.values.get({
        spreadsheetId,
        range: `${sheetName}!A:G`
      });
    });

    const rows = response.data.values || [];

    if (rows.length <= 1) {
      return res.json({
        success: true,
        data: []
      });
    }

    // í—¤ë” ì œì™¸í•˜ê³  í•´ë‹¹ ì‹œì ì˜ ë°ì´í„°ë§Œ í•„í„°ë§
    const dataRows = rows.slice(1).filter(row => row[0] === timestamp);

    if (dataRows.length === 0) {
      return res.json({
        success: true,
        data: []
      });
    }

    // ë°ì´í„° ë³€í™˜
    const data = dataRows.map(row => ({
      timestamp: row[0] || '',
      agentCode: row[1] || '',
      agentName: row[2] || '',
      inventoryBond: Number(row[3]) || 0,
      collateralBond: Number(row[4]) || 0,
      managementBond: Number(row[5]) || 0,
      inputUser: row[6] || ''
    }));

    console.log(`âœ… ì¬ì´ˆë‹´ì´ˆì±„ê¶Œ ë°ì´í„° ì¡°íšŒ ì™„ë£Œ: ${timestamp}, ${data.length}ê°œ`);

    res.json({
      success: true,
      data
    });

  } catch (error) {
    console.error('âŒ ì¬ì´ˆë‹´ì´ˆì±„ê¶Œ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨:', error);
    res.status(500).json({
      success: false,
      error: 'ë°ì´í„° ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
      message: error.message
    });
  }
});

// ëª¨ë“  ì¬ì´ˆë‹´ì´ˆì±„ê¶Œ ë°ì´í„° ì¡°íšŒ (ê·¸ë˜í”„ìš©)
app.get('/api/rechotancho-bond/all-data', async (req, res) => {
  // CORS í—¤ë” ì„¤ì •
  const corsOrigins = process.env.CORS_ORIGIN?.split(',') || [];
  const defaultOrigins = [
    'https://vipmobile.vercel.app',
    'http://localhost:3000',
    'http://localhost:3001',
    'http://localhost:4000'
  ];
  const allowedOrigins = [...corsOrigins, ...defaultOrigins];
  const origin = req.headers.origin;

  if (origin && allowedOrigins.includes(origin)) {
    res.header('Access-Control-Allow-Origin', origin);
  } else if (allowedOrigins.length > 0) {
    res.header('Access-Control-Allow-Origin', allowedOrigins[0]);
  }
  res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS, PATCH');
  res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With, Origin, Accept, X-API-Key');
  res.header('Access-Control-Allow-Credentials', 'true');

  try {
    const spreadsheetId = process.env.GOOGLE_SHEET_ID || process.env.SHEET_ID;
    const sheetName = 'ì¬ì´ˆë‹´ì´ˆì±„ê¶Œ_ë‚´ì—­';

    // ì‹œíŠ¸ ë°ì´í„° ì¡°íšŒ
    const response = await rateLimitedSheetsCall(async () => {
      return await sheets.spreadsheets.values.get({
        spreadsheetId,
        range: `${sheetName}!A:G`
      });
    });

    const rows = response.data.values || [];

    if (rows.length <= 1) {
      return res.json({
        success: true,
        data: []
      });
    }

    // í—¤ë” ì œì™¸í•˜ê³  ë°ì´í„° ë³€í™˜
    const data = rows.slice(1).map(row => ({
      timestamp: row[0] || '',
      agentCode: row[1] || '',
      agentName: row[2] || '',
      inventoryBond: Number(row[3]) || 0,
      collateralBond: Number(row[4]) || 0,
      managementBond: Number(row[5]) || 0,
      inputUser: row[6] || ''
    }));

    console.log(`âœ… ì¬ì´ˆë‹´ì´ˆì±„ê¶Œ ì „ì²´ ë°ì´í„° ì¡°íšŒ ì™„ë£Œ: ${data.length}ê°œ`);

    res.json({
      success: true,
      data
    });

  } catch (error) {
    // CORS í—¤ë” ì„¤ì • (ì—ëŸ¬ ì‘ë‹µì—ë„ í¬í•¨)
    const corsOrigins = process.env.CORS_ORIGIN?.split(',') || [];
    const defaultOrigins = [
      'https://vipmobile.vercel.app',
      'http://localhost:3000',
      'http://localhost:3001',
      'http://localhost:4000'
    ];
    const allowedOrigins = [...corsOrigins, ...defaultOrigins];
    const origin = req.headers.origin;

    if (origin && allowedOrigins.includes(origin)) {
      res.header('Access-Control-Allow-Origin', origin);
    } else if (allowedOrigins.length > 0) {
      res.header('Access-Control-Allow-Origin', allowedOrigins[0]);
    }
    res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS, PATCH');
    res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With, Origin, Accept, X-API-Key');
    res.header('Access-Control-Allow-Credentials', 'true');

    console.error('âŒ ì¬ì´ˆë‹´ì´ˆì±„ê¶Œ ì „ì²´ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨:', error);
    res.status(500).json({
      success: false,
      error: 'ì „ì²´ ë°ì´í„° ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
      message: error.message
    });
  }
});

// ì¬ì´ˆë‹´ì´ˆì±„ê¶Œ ë°ì´í„° ìˆ˜ì •
app.put('/api/rechotancho-bond/update/:timestamp', async (req, res) => {
  try {
    const { timestamp } = req.params;
    const { data, inputUser } = req.body;

    if (!timestamp) {
      return res.status(400).json({
        success: false,
        error: 'ì‹œì  ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }

    if (!data || !Array.isArray(data)) {
      return res.status(400).json({
        success: false,
        error: 'ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'
      });
    }

    const spreadsheetId = process.env.GOOGLE_SHEET_ID || process.env.SHEET_ID;
    const sheetName = 'ì¬ì´ˆë‹´ì´ˆì±„ê¶Œ_ë‚´ì—­';

    // ë¨¼ì € í•´ë‹¹ ì‹œì ì˜ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
    const response = await rateLimitedSheetsCall(async () => {
      return await sheets.spreadsheets.values.get({
        spreadsheetId,
        range: `${sheetName}!A:G`
      });
    });

    const rows = response.data.values || [];
    if (rows.length <= 1) {
      return res.status(404).json({
        success: false,
        error: 'ìˆ˜ì •í•  ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }

    // í•´ë‹¹ ì‹œì ì˜ ë°ì´í„° í–‰ ì°¾ê¸°
    const targetRows = [];
    rows.forEach((row, index) => {
      if (row[0] === timestamp) {
        targetRows.push(index + 1); // êµ¬ê¸€ ì‹œíŠ¸ì˜ ì‹¤ì œ í–‰ ë²ˆí˜¸ (1-based)
      }
    });

    if (targetRows.length === 0) {
      return res.status(404).json({
        success: false,
        error: 'í•´ë‹¹ ì‹œì ì˜ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }

    // ì‹œíŠ¸ ë©”íƒ€ë°ì´í„° ì¡°íšŒí•˜ì—¬ sheetId ê°€ì ¸ì˜¤ê¸°
    const sheetMetadata = await rateLimitedSheetsCall(async () => {
      return await sheets.spreadsheets.get({
        spreadsheetId
      });
    });

    const targetSheet = sheetMetadata.data.sheets.find(sheet => sheet.properties.title === sheetName);
    if (!targetSheet) {
      return res.status(404).json({
        success: false,
        error: 'ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }

    const sheetId = targetSheet.properties.sheetId;

    // ê¸°ì¡´ ë°ì´í„° ì‚­ì œ - ì‹¤ì œ í–‰ ì‚­ì œ (ë’¤ì—ì„œë¶€í„° ì‚­ì œí•˜ì—¬ ì¸ë±ìŠ¤ ë³€í™” ë°©ì§€)
    for (let i = targetRows.length - 1; i >= 0; i--) {
      await rateLimitedSheetsCall(async () => {
        return await sheets.spreadsheets.batchUpdate({
          spreadsheetId,
          resource: {
            requests: [{
              deleteDimension: {
                range: {
                  sheetId: sheetId,
                  dimension: 'ROWS',
                  startIndex: targetRows[i] - 1,
                  endIndex: targetRows[i]
                }
              }
            }]
          }
        });
      });
    }

    // ìƒˆ ë°ì´í„° ì¶”ê°€
    const newRows = data.map(item => [
      timestamp,                          // A: ì €ì¥ì¼ì‹œ
      item.agentCode,                     // B: ëŒ€ë¦¬ì ì½”ë“œ
      item.agentName,                     // C: ëŒ€ë¦¬ì ëª…
      Number(item.inventoryBond) || 0,    // D: ì¬ê³ ì´ˆê³¼ì±„ê¶Œ
      Number(item.collateralBond) || 0,   // E: ë‹´ë³´ì´ˆê³¼ì±„ê¶Œ
      Number(item.managementBond) || 0,   // F: ê´€ë¦¬ëŒ€ìƒì±„ê¶Œ
      inputUser || ''                     // G: ì…ë ¥ì
    ]);

    await rateLimitedSheetsCall(async () => {
      return await sheets.spreadsheets.values.append({
        spreadsheetId,
        range: `${sheetName}!A:G`,
        valueInputOption: 'RAW',
        resource: {
          values: newRows
        }
      });
    });

    console.log(`âœ… ì¬ì´ˆë‹´ì´ˆì±„ê¶Œ ë°ì´í„° ìˆ˜ì • ì™„ë£Œ: ${timestamp}, ì…ë ¥ì: ${inputUser}, ${newRows.length}ê°œ ëŒ€ë¦¬ì `);

    res.json({
      success: true,
      message: 'ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.',
      timestamp
    });

  } catch (error) {
    console.error('âŒ ì¬ì´ˆë‹´ì´ˆì±„ê¶Œ ë°ì´í„° ìˆ˜ì • ì‹¤íŒ¨:', error);
    res.status(500).json({
      success: false,
      error: 'ë°ì´í„° ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
      message: error.message
    });
  }
});

// ì¬ì´ˆë‹´ì´ˆì±„ê¶Œ ë°ì´í„° ì‚­ì œ
app.delete('/api/rechotancho-bond/delete/:timestamp', async (req, res) => {
  try {
    const { timestamp } = req.params;

    if (!timestamp) {
      return res.status(400).json({
        success: false,
        error: 'ì‹œì  ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }

    const spreadsheetId = process.env.GOOGLE_SHEET_ID || process.env.SHEET_ID;
    const sheetName = 'ì¬ì´ˆë‹´ì´ˆì±„ê¶Œ_ë‚´ì—­';

    // í•´ë‹¹ ì‹œì ì˜ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
    const response = await rateLimitedSheetsCall(async () => {
      return await sheets.spreadsheets.values.get({
        spreadsheetId,
        range: `${sheetName}!A:G`
      });
    });

    const rows = response.data.values || [];
    if (rows.length <= 1) {
      return res.status(404).json({
        success: false,
        error: 'ì‚­ì œí•  ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }

    // í•´ë‹¹ ì‹œì ì˜ ë°ì´í„° í–‰ ì°¾ê¸°
    const targetRows = [];
    rows.forEach((row, index) => {
      if (row[0] === timestamp) {
        targetRows.push(index + 1); // êµ¬ê¸€ ì‹œíŠ¸ì˜ ì‹¤ì œ í–‰ ë²ˆí˜¸ (1-based)
      }
    });

    if (targetRows.length === 0) {
      return res.status(404).json({
        success: false,
        error: 'í•´ë‹¹ ì‹œì ì˜ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }

    // ì‹œíŠ¸ ë©”íƒ€ë°ì´í„° ì¡°íšŒí•˜ì—¬ sheetId ê°€ì ¸ì˜¤ê¸°
    const sheetMetadata = await rateLimitedSheetsCall(async () => {
      return await sheets.spreadsheets.get({
        spreadsheetId
      });
    });

    const targetSheet = sheetMetadata.data.sheets.find(sheet => sheet.properties.title === sheetName);
    if (!targetSheet) {
      return res.status(404).json({
        success: false,
        error: 'ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }

    const sheetId = targetSheet.properties.sheetId;

    // ë°ì´í„° ì‚­ì œ - ì‹¤ì œ í–‰ ì‚­ì œ (ë’¤ì—ì„œë¶€í„° ì‚­ì œí•˜ì—¬ ì¸ë±ìŠ¤ ë³€í™” ë°©ì§€)
    for (let i = targetRows.length - 1; i >= 0; i--) {
      await rateLimitedSheetsCall(async () => {
        return await sheets.spreadsheets.batchUpdate({
          spreadsheetId,
          resource: {
            requests: [{
              deleteDimension: {
                range: {
                  sheetId: sheetId,
                  dimension: 'ROWS',
                  startIndex: targetRows[i] - 1,
                  endIndex: targetRows[i]
                }
              }
            }]
          }
        });
      });
    }

    console.log(`âœ… ì¬ì´ˆë‹´ì´ˆì±„ê¶Œ ë°ì´í„° ì‚­ì œ ì™„ë£Œ: ${timestamp}, ${targetRows.length}ê°œ í–‰ ì‚­ì œ`);

    res.json({
      success: true,
      message: 'ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.'
    });

  } catch (error) {
    console.error('âŒ ì¬ì´ˆë‹´ì´ˆì±„ê¶Œ ë°ì´í„° ì‚­ì œ ì‹¤íŒ¨:', error);
    res.status(500).json({
      success: false,
      error: 'ë°ì´í„° ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
      message: error.message
    });
  }
});

// ==================== ê°œí†µì •ë³´ ëª©ë¡ ê´€ë¦¬ API ====================

// ê°œí†µì •ë³´ ë³´ë¥˜ ì²˜ë¦¬ API
app.post('/api/onsale/activation-info/:sheetId/:rowIndex/pending', async (req, res) => {
  try {
    const { sheetId, rowIndex } = req.params;
    const { pendingBy } = req.body;

    console.log(`â¸ï¸ [ê°œí†µì •ë³´ë³´ë¥˜] ë³´ë¥˜ ì²˜ë¦¬ ì‹œì‘: ì‹œíŠ¸=${sheetId}, í–‰=${rowIndex}, ì²˜ë¦¬ì=${pendingBy}`);

    if (!pendingBy) {
      return res.status(400).json({
        success: false,
        error: 'ë³´ë¥˜ ì²˜ë¦¬ì ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }

    // ì‹œíŠ¸ ì •ë³´ ì¡°íšŒ
    const linksResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: 'ì˜¨ì„¸ì¼ë§í¬ê´€ë¦¬!A:G',
    });

    const links = linksResponse.data.values || [];
    const link = links.slice(1).find(row => row[5] === sheetId);

    if (!link) {
      return res.status(404).json({
        success: false,
        error: 'ê°œí†µì–‘ì‹ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }

    const sheetName = link[6];
    const now = new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' });

    // Gì—´(ë³´ë¥˜), Hì—´(ë³´ë¥˜ì²˜ë¦¬ì), Iì—´(ë³´ë¥˜ì¼ì‹œ) ì—…ë°ì´íŠ¸
    await sheets.spreadsheets.values.update({
      spreadsheetId: sheetId,
      range: `${sheetName}!G${rowIndex}:I${rowIndex}`,
      valueInputOption: 'RAW',
      requestBody: {
        values: [['ë³´ë¥˜', pendingBy, now]]
      }
    });

    console.log(`âœ… [ê°œí†µì •ë³´ë³´ë¥˜] ë³´ë¥˜ ì²˜ë¦¬ ì™„ë£Œ: ${sheetName} ${rowIndex}í–‰`);

    res.json({
      success: true,
      message: 'ê°œí†µì •ë³´ê°€ ë³´ë¥˜ë˜ì—ˆìŠµë‹ˆë‹¤.'
    });

  } catch (error) {
    console.error('âŒ [ê°œí†µì •ë³´ë³´ë¥˜] ë³´ë¥˜ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

// ê°œí†µì •ë³´ ë³´ë¥˜ í•´ì œ API
app.post('/api/onsale/activation-info/:sheetId/:rowIndex/unpending', async (req, res) => {
  try {
    const { sheetId, rowIndex } = req.params;

    console.log(`â–¶ï¸ [ê°œí†µì •ë³´ë³´ë¥˜í•´ì œ] ë³´ë¥˜ í•´ì œ ì‹œì‘: ì‹œíŠ¸=${sheetId}, í–‰=${rowIndex}`);

    // ì‹œíŠ¸ ì •ë³´ ì¡°íšŒ
    const linksResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: 'ì˜¨ì„¸ì¼ë§í¬ê´€ë¦¬!A:G',
    });

    const links = linksResponse.data.values || [];
    const link = links.slice(1).find(row => row[5] === sheetId);

    if (!link) {
      return res.status(404).json({
        success: false,
        error: 'ê°œí†µì–‘ì‹ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }

    const sheetName = link[6];

    // Gì—´(ë³´ë¥˜), Hì—´(ë³´ë¥˜ì²˜ë¦¬ì), Iì—´(ë³´ë¥˜ì¼ì‹œ) ì´ˆê¸°í™”
    await sheets.spreadsheets.values.update({
      spreadsheetId: sheetId,
      range: `${sheetName}!G${rowIndex}:I${rowIndex}`,
      valueInputOption: 'RAW',
      requestBody: {
        values: [['', '', '']]
      }
    });

    console.log(`âœ… [ê°œí†µì •ë³´ë³´ë¥˜í•´ì œ] ë³´ë¥˜ í•´ì œ ì™„ë£Œ: ${sheetName} ${rowIndex}í–‰`);

    res.json({
      success: true,
      message: 'ë³´ë¥˜ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.'
    });

  } catch (error) {
    console.error('âŒ [ê°œí†µì •ë³´ë³´ë¥˜í•´ì œ] ë³´ë¥˜ í•´ì œ ì‹¤íŒ¨:', error);
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

// ê°œí†µì •ë³´ ëª©ë¡ ì¡°íšŒ API
app.get('/api/onsale/activation-list', async (req, res) => {
  try {
    console.log('ğŸ“‹ [ê°œí†µì •ë³´ëª©ë¡] ê°œí†µì •ë³´ ëª©ë¡ ì¡°íšŒ ì‹œì‘');
    const { storeName, sheetId, allSheets, month } = req.query;

    console.log('ğŸ“‹ [ê°œí†µì •ë³´ëª©ë¡] ìš”ì²­ íŒŒë¼ë¯¸í„°:', { storeName, sheetId, allSheets, month });
    console.log('ğŸ“‹ [ê°œí†µì •ë³´ëª©ë¡] ìš”ì²­ IP:', req.ip);
    console.log('ğŸ“‹ [ê°œí†µì •ë³´ëª©ë¡] User-Agent:', req.get('User-Agent'));

    let targetSheets = [];

    if (allSheets === 'true') {
      // ëª¨ë“  ê°œí†µì–‘ì‹ ì‹œíŠ¸ ì¡°íšŒ
      console.log('ğŸ“‹ [ê°œí†µì •ë³´ëª©ë¡] ì˜¨ì„¸ì¼ë§í¬ê´€ë¦¬ ì‹œíŠ¸ì—ì„œ ê°œí†µì–‘ì‹ ì •ë³´ ì¡°íšŒ');

      const linksResponse = await sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ì˜¨ì„¸ì¼ë§í¬ê´€ë¦¬!A:G',
      });

      const links = linksResponse.data.values || [];
      console.log('ğŸ“‹ [ê°œí†µì •ë³´ëª©ë¡] ì˜¨ì„¸ì¼ë§í¬ê´€ë¦¬ ì „ì²´ ë°ì´í„°:', links);
      console.log('ğŸ“‹ [ê°œí†µì •ë³´ëª©ë¡] ì˜¨ì„¸ì¼ë§í¬ê´€ë¦¬ ë°ì´í„° ê°œìˆ˜:', links.length);

      if (links.length > 0) {
        console.log('ğŸ“‹ [ê°œí†µì •ë³´ëª©ë¡] ì˜¨ì„¸ì¼ë§í¬ê´€ë¦¬ í—¤ë”:', links[0]);
        console.log('ğŸ“‹ [ê°œí†µì •ë³´ëª©ë¡] ì˜¨ì„¸ì¼ë§í¬ê´€ë¦¬ ë°ì´í„° (ì²« 5ê°œ):', links.slice(1, 6));
      }

      const filteredLinks = links.slice(1)
        .filter(row => row[4] === 'O') // ê°œí†µì–‘ì‹ ì‚¬ìš© ì—¬ë¶€ê°€ 'O'
        .map(row => ({
          sheetId: row[5] || '',
          sheetName: row[6] || ''
        }))
        .filter(sheet => sheet.sheetId && sheet.sheetName);

      console.log('ğŸ“‹ [ê°œí†µì •ë³´ëª©ë¡] ê°œí†µì–‘ì‹ ì‚¬ìš© ì„¤ì •ëœ ë§í¬ë“¤:', filteredLinks);
      console.log('ğŸ“‹ [ê°œí†µì •ë³´ëª©ë¡] ê°œí†µì–‘ì‹ ë§í¬ ê°œìˆ˜:', filteredLinks.length);

      targetSheets = filteredLinks;
    } else if (sheetId) {
      // íŠ¹ì • ì‹œíŠ¸ë§Œ ì¡°íšŒ
      const linksResponse = await sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ì˜¨ì„¸ì¼ë§í¬ê´€ë¦¬!A:G',
      });

      const links = linksResponse.data.values || [];
      const link = links.slice(1).find(row => row[5] === sheetId);
      if (link) {
        targetSheets = [{
          sheetId: link[5],
          sheetName: link[6]
        }];
      }
    } else {
      return res.status(400).json({
        success: false,
        error: 'sheetId ë˜ëŠ” allSheets íŒŒë¼ë¯¸í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }

    const allData = [];

    console.log('ğŸ“‹ [ê°œí†µì •ë³´ëª©ë¡] ì²˜ë¦¬í•  ì‹œíŠ¸ ê°œìˆ˜:', targetSheets.length);

    if (targetSheets.length === 0) {
      console.log('âš ï¸ [ê°œí†µì •ë³´ëª©ë¡] ì²˜ë¦¬í•  ì‹œíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤');
      return res.json({
        success: true,
        data: [],
        message: 'í™œì„±í™”ëœ ê°œí†µì–‘ì‹ì´ ì—†ìŠµë‹ˆë‹¤. ì˜¨ì„¸ì¼ê´€ë¦¬ëª¨ë“œì—ì„œ ê°œí†µì–‘ì‹ ì‚¬ìš©ì„ í™œì„±í™”í•´ì£¼ì„¸ìš”.'
      });
    }

    for (const sheet of targetSheets) {
      try {
        console.log(`ğŸ“‹ [ê°œí†µì •ë³´ëª©ë¡] ì‹œíŠ¸ ì²˜ë¦¬ ì¤‘: ${sheet.sheetName} (ID: ${sheet.sheetId})`);

        const sheetData = await sheets.spreadsheets.values.get({
          spreadsheetId: sheet.sheetId,
          range: `${sheet.sheetName}!A:AL`,
        });

        const rows = sheetData.data.values || [];
        console.log(`ğŸ“‹ [ê°œí†µì •ë³´ëª©ë¡] ${sheet.sheetName} ì‹œíŠ¸ ë°ì´í„° ê°œìˆ˜:`, rows.length);

        if (rows.length > 0) {
          console.log(`ğŸ“‹ [ê°œí†µì •ë³´ëª©ë¡] ${sheet.sheetName} ì‹œíŠ¸ í—¤ë”:`, rows[0]);
          console.log(`ğŸ“‹ [ê°œí†µì •ë³´ëª©ë¡] ${sheet.sheetName} ì‹œíŠ¸ ì²« ë²ˆì§¸ ë°ì´í„°:`, rows[1]);
        }

        for (let i = 1; i < rows.length; i++) { // í—¤ë” ì œì™¸
          const row = rows[i];
          if (row.length === 0) continue;

          const isCompleted = row[0]?.trim() === 'ê°œí†µì™„ë£Œ'; // Aì—´
          const completedBy = row[1] || ''; // Bì—´
          const completedAt = row[2] || ''; // Cì—´
          const isCancelled = row[3]?.trim() === 'ì·¨ì†Œ'; // Dì—´
          const cancelledBy = row[4] || ''; // Eì—´
          const cancelledAt = row[5] || ''; // Fì—´

          // ===== ìƒˆë¡œ ì¶”ê°€ =====
          const isPending = row[6]?.trim() === 'ë³´ë¥˜'; // Gì—´ (ì‹ ê·œ)
          const pendingBy = row[7] || ''; // Hì—´ (ì‹ ê·œ)
          const pendingAt = row[8] || ''; // Iì—´ (ì‹ ê·œ)
          // ====================

          const lastEditor = row[9] || ''; // Jì—´ (ê¸°ì¡´ 6 â†’ 9)
          const editedAt = row[10] || ''; // Kì—´ (ê¸°ì¡´ 7 â†’ 10)
          const submittedAt = row[11] || ''; // Lì—´ (ê¸°ì¡´ 8 â†’ 11)
          const storeNameFromSheet = row[12] || ''; // Mì—´ (ê¸°ì¡´ 9 â†’ 12)
          const pCode = row[13] || ''; // Nì—´ (ê¸°ì¡´ 10 â†’ 13)

          // submittedAt ê²€ì¦ ë¡œê·¸
          if (!submittedAt) {
            console.log(`âš ï¸ [ê°œí†µì •ë³´ëª©ë¡] submittedAt ì—†ìŒ: ${storeNameFromSheet} - ${row[16] || 'ì´ë¦„ì—†ìŒ'} (í–‰: ${i + 1})`);
          }

          // ì™„ë£Œ ìƒíƒœ ë¡œê¹…
          if (isCompleted) {
            console.log(`âœ… [ê°œí†µì •ë³´ëª©ë¡] ì™„ë£Œëœ ë°ì´í„° ë°œê²¬: ${storeNameFromSheet} - ${row[16] || ''} - ${completedBy}`);
          }

          // ë³´ë¥˜ ìƒíƒœ ë¡œê¹…
          if (isPending) {
            console.log(`â¸ï¸ [ê°œí†µì •ë³´ëª©ë¡] ë³´ë¥˜ëœ ë°ì´í„° ë°œê²¬: ${storeNameFromSheet} - ${row[16] || ''} - ${pendingBy}`);
          }

          const activationType = row[14] || ''; // Oì—´ (ê¸°ì¡´ 11 â†’ 14)
          const previousCarrier = row[15] || ''; // Pì—´ (ê¸°ì¡´ 12 â†’ 15)
          const customerName = row[16] || ''; // Qì—´ (ê¸°ì¡´ 13 â†’ 16)
          const birthDate = row[17] || ''; // Rì—´ (ê¸°ì¡´ 14 â†’ 17)
          const phoneNumber = row[18] || ''; // Sì—´ (ê¸°ì¡´ 15 â†’ 18)
          const modelName = row[19] || ''; // Tì—´ (ê¸°ì¡´ 16 â†’ 19)
          const deviceSerial = row[20] || ''; // Uì—´ (ê¸°ì¡´ 17 â†’ 20)
          const color = row[21] || ''; // Vì—´ (ê¸°ì¡´ 18 â†’ 21)
          const simModel = row[22] || ''; // Wì—´ (ê¸°ì¡´ 19 â†’ 22)
          const simSerial = row[23] || ''; // Xì—´ (ê¸°ì¡´ 20 â†’ 23)
          const plan = row[30] || ''; // AEì—´ (ê¸°ì¡´ 27 â†’ 30)

          // storeName í•„í„°ë§
          if (storeName && storeNameFromSheet !== storeName) {
            continue;
          }

          allData.push({
            rowIndex: i + 1,
            sheetId: sheet.sheetId,
            sheetName: sheet.sheetName,
            submittedAt,
            lastEditor,
            storeName: storeNameFromSheet,
            activationType,
            customerName,
            phoneNumber,
            birthDate,
            modelName,
            deviceSerial,
            color,          // ìƒ‰ìƒ í•„ë“œ ì¶”ê°€
            simModel,
            simSerial,
            plan,
            isCompleted,
            completedBy,
            completedAt,
            isCancelled,
            cancelledBy,
            cancelledAt,
            isPending,      // ì‹ ê·œ ì¶”ê°€
            pendingBy,      // ì‹ ê·œ ì¶”ê°€
            pendingAt,      // ì‹ ê·œ ì¶”ê°€
            editedAt
          });
        }
      } catch (error) {
        console.error(`âŒ [ê°œí†µì •ë³´ëª©ë¡] ì‹œíŠ¸ ${sheet.sheetName} ì¡°íšŒ ì‹¤íŒ¨:`, error);
        continue;
      }
    }

    // ì›”ë³„ í•„í„°ë§ ì ìš©
    let filteredData = allData;
    if (month) {
      console.log('ğŸ“‹ [ê°œí†µì •ë³´ëª©ë¡] ì›”ë³„ í•„í„°ë§ ì ìš©:', month);
      filteredData = allData.filter(item => {
        if (!item.submittedAt) return false;

        // submittedAtì„ Date ê°ì²´ë¡œ ë³€í™˜
        const submittedDate = new Date(item.submittedAt);
        const submittedYear = submittedDate.getFullYear();
        const submittedMonth = String(submittedDate.getMonth() + 1).padStart(2, '0');
        const submittedYearMonth = `${submittedYear}-${submittedMonth}`;

        console.log('ğŸ“‹ [ê°œí†µì •ë³´ëª©ë¡] í•„í„°ë§ ë¹„êµ:', {
          submittedYearMonth,
          filterMonth: month,
          match: submittedYearMonth === month
        });

        return submittedYearMonth === month;
      });
      console.log(`ğŸ“‹ [ê°œí†µì •ë³´ëª©ë¡] ì›”ë³„ í•„í„°ë§ ê²°ê³¼: ${filteredData.length}ê°œ (ì „ì²´: ${allData.length}ê°œ)`);
    }

    // ì œì¶œì¼ì‹œ ê¸°ì¤€ ìµœì‹ ìˆœ ì •ë ¬
    filteredData.sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt));

    console.log(`âœ… [ê°œí†µì •ë³´ëª©ë¡] ì¡°íšŒ ì™„ë£Œ: ${filteredData.length}ê°œ`);
    res.json({ success: true, data: filteredData });

  } catch (error) {
    console.error('âŒ [ê°œí†µì •ë³´ëª©ë¡] ì¡°íšŒ ì‹¤íŒ¨:', error);
    res.status(500).json({
      success: false,
      error: 'ê°œí†µì •ë³´ ëª©ë¡ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
      message: error.message
    });
  }
});



// ê°œí†µì •ë³´ ì·¨ì†Œ ì²˜ë¦¬ API
app.post('/api/onsale/activation-info/:sheetId/:rowIndex/cancel', async (req, res) => {
  try {
    const { sheetId, rowIndex } = req.params;
    const { cancelledBy } = req.body;

    console.log(`ğŸš« [ê°œí†µì •ë³´ì·¨ì†Œ] ê°œí†µì •ë³´ ì·¨ì†Œ: ${sheetId}, í–‰ ${rowIndex}`);

    // ì‹œíŠ¸ ì´ë¦„ ì°¾ê¸°
    const linksResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: 'ì˜¨ì„¸ì¼ë§í¬ê´€ë¦¬!A:G',
    });

    const links = linksResponse.data.values || [];
    const link = links.slice(1).find(row => row[5] === sheetId);

    if (!link) {
      return res.status(404).json({
        success: false,
        error: 'ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }

    const sheetName = link[6];

    // ì·¨ì†Œ ì²˜ë¦¬ (Dì—´: ì·¨ì†Œì—¬ë¶€, Eì—´: ì·¨ì†Œì, Fì—´: ì·¨ì†Œì‹œê°„)
    const cancelledAt = new Date().toLocaleString('ko-KR', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    });

    await sheets.spreadsheets.values.update({
      spreadsheetId: sheetId,
      range: `${sheetName}!D${rowIndex}:F${rowIndex}`,
      valueInputOption: 'RAW',
      requestBody: {
        values: [['ì·¨ì†Œ', cancelledBy || '', cancelledAt]]
      }
    });

    console.log(`âœ… [ê°œí†µì •ë³´ì·¨ì†Œ] ì·¨ì†Œ ì™„ë£Œ`);
    res.json({ success: true, message: 'ê°œí†µì •ë³´ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.' });

  } catch (error) {
    console.error('âŒ [ê°œí†µì •ë³´ì·¨ì†Œ] ì·¨ì†Œ ì‹¤íŒ¨:', error);
    res.status(500).json({
      success: false,
      error: 'ê°œí†µì •ë³´ ì·¨ì†Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
      message: error.message
    });
  }
});

// ==================== ê°œí†µì •ë³´ ê´€ë¦¬ API ====================

// ê°œí†µì •ë³´ ë‹¨ê±´ ì¡°íšŒ (ìˆ˜ì •ìš©)
app.get('/api/onsale/activation-info/:sheetId/:rowIndex', async (req, res) => {
  try {
    const { sheetId, rowIndex } = req.params;
    console.log(`ğŸ“‹ [ê°œí†µì •ë³´ì¡°íšŒ] ì‹œíŠ¸: ${sheetId}, í–‰: ${rowIndex}`);

    // ì‹œíŠ¸ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
    const sheetResponse = await sheets.spreadsheets.get({
      spreadsheetId: sheetId
    });

    const sheetName = sheetResponse.data.sheets[0].properties.title;
    console.log(`ğŸ“‹ [ê°œí†µì •ë³´ì¡°íšŒ] ì‹œíŠ¸ëª…: ${sheetName}`);

    // L~ALì—´ ë°ì´í„° ì½ê¸° (27ê°œ í•„ë“œ) - ì œì¶œì¼ì‹œë¶€í„° U+ì œì¶œë°ì´í„°ê¹Œì§€
    const range = `${sheetName}!L${rowIndex}:AL${rowIndex}`;
    const response = await sheets.spreadsheets.values.get({
      spreadsheetId: sheetId,
      range: range
    });

    const row = response.data.values?.[0] || [];

    if (row.length === 0) {
      return res.status(404).json({
        success: false,
        error: 'ê°œí†µì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }

    // 27ê°œ í•„ë“œ ë§¤í•‘ (Lì—´ë¶€í„° ALì—´ê¹Œì§€)
    const data = {
      submittedAt: row[0] || '', // Lì—´(11): ì œì¶œì¼ì‹œ
      storeName: row[1] || '', // Mì—´(12): ë§¤ì¥ëª…
      pCode: row[2] || '', // Nì—´(13): Pì½”ë“œ
      activationType: row[3] || '', // Oì—´(14): ê°œí†µìœ í˜•
      previousCarrier: row[4] || '', // Pì—´(15): ì´ì „í†µì‹ ì‚¬
      customerName: row[5] || '', // Qì—´(16): ê³ ê°ëª…
      birthDate: row[6] || '', // Rì—´(17): ìƒë…„ì›”ì¼
      phoneNumber: row[7] || '', // Sì—´(18): ê°œí†µë²ˆí˜¸
      modelName: row[8] || '', // Tì—´(19): ëª¨ë¸ëª…
      deviceSerial: row[9] || '', // Uì—´(20): ê¸°ê¸°ì¼ë ¨ë²ˆí˜¸
      color: row[10] || '', // Vì—´(21): ìƒ‰ìƒ
      simModel: row[11] || '', // Wì—´(22): ìœ ì‹¬ëª¨ë¸
      simSerial: row[12] || '', // Xì—´(23): ìœ ì‹¬ì¼ë ¨ë²ˆí˜¸
      contractType: row[13] || '', // Yì—´(24): ì•½ì •ìœ í˜•
      conversionSubsidy: row[14] || '', // Zì—´(25): ì „í™˜ì§€ì›ê¸ˆ (ì´í†µì‚¬ì§€ì›ê¸ˆ)
      additionalSubsidy: row[15] || '', // AAì—´(26): ìœ í†µë§ì¶”ê°€ì§€ì›ê¸ˆ
      installmentMonths: row[16] || '', // ABì—´(27): í• ë¶€ê°œì›”
      installmentAmount: row[17] || '', // ACì—´(28): í• ë¶€ì›ê¸ˆ
      free: row[18] || '', // ADì—´(29): í”„ë¦¬
      plan: row[19] || '', // AEì—´(30): ìš”ê¸ˆì œ
      mediaServices: row[20] ? (typeof row[20] === 'string' && row[20].includes(',') ? row[20].split(',').map(s => s.trim()) : [row[20]]) : [], // AFì—´(31): ë¯¸ë””ì–´ì„œë¹„ìŠ¤
      additionalServices: row[21] || '', // AGì—´(32): ë¶€ê°€ì„œë¹„ìŠ¤
      premierContract: row[22] || '', // AHì—´(33): í”„ë¦¬ë¯¸ì–´ì•½ì •
      reservationNumber: row[23] || '', // AIì—´(34): ì˜ˆì•½ë²ˆí˜¸
      otherRequests: row[24] || '', // AJì—´(35): ê¸°íƒ€ìš”ì²­ì‚¬í•­
      uplusSubmittedAt: row[25] || '', // AKì—´(36): U+ì œì¶œì¼ì‹œ
      uplusSubmissionData: row[26] || '' // ALì—´(37): U+ì œì¶œë°ì´í„°
    };

    console.log(`âœ… [ê°œí†µì •ë³´ì¡°íšŒ] ì¡°íšŒ ì™„ë£Œ`);
    res.json({ success: true, data });

  } catch (error) {
    console.error('âŒ [ê°œí†µì •ë³´ì¡°íšŒ] ì¡°íšŒ ì‹¤íŒ¨:', error);
    res.status(500).json({
      success: false,
      error: 'ê°œí†µì •ë³´ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
      message: error.message
    });
  }
});

// ê°œí†µì •ë³´ ìˆ˜ì •
app.put('/api/onsale/activation-info/:sheetId/:rowIndex', async (req, res) => {
  try {
    const { sheetId, rowIndex } = req.params;
    const { data: formData, editor } = req.body;

    console.log(`ğŸ“ [ê°œí†µì •ë³´ìˆ˜ì •] ì‹œíŠ¸: ${sheetId}, í–‰: ${rowIndex}, ìˆ˜ì •ì: ${editor}`);

    // ì‹œíŠ¸ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
    const sheetResponse = await sheets.spreadsheets.get({
      spreadsheetId: sheetId
    });

    const sheetName = sheetResponse.data.sheets[0].properties.title;
    console.log(`ğŸ“ [ê°œí†µì •ë³´ìˆ˜ì •] ì‹œíŠ¸ëª…: ${sheetName}`);

    // ìˆ˜ì •ì ì •ë³´ ì—…ë°ì´íŠ¸ (Jì—´ - ìµœì¢…ìˆ˜ì •ì)
    await sheets.spreadsheets.values.update({
      spreadsheetId: sheetId,
      range: `${sheetName}!J${rowIndex}`,
      valueInputOption: 'RAW',
      requestBody: {
        values: [[editor || '']]
      }
    });

    // ìˆ˜ì •ì‹œê°„ ì •ë³´ ì—…ë°ì´íŠ¸ (Kì—´ - ìµœì¢…ìˆ˜ì •ì¼ì‹œ)
    const editedAt = new Date().toLocaleString('ko-KR', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    });

    await sheets.spreadsheets.values.update({
      spreadsheetId: sheetId,
      range: `${sheetName}!K${rowIndex}`,
      valueInputOption: 'RAW',
      requestBody: {
        values: [[editedAt]]
      }
    });

    // 26ê°œ í•„ë“œ ë°ì´í„° ì—…ë°ì´íŠ¸ (L~AJì—´ - ì œì¶œì¼ì‹œë¶€í„° ê¸°íƒ€ìš”ì²­ì‚¬í•­ê¹Œì§€, U+ì œì¶œ í•„ë“œëŠ” ì œì™¸)
    const rowData = [
      formData.submittedAt || new Date().toLocaleString('ko-KR'),
      formData.storeName || '',
      formData.pCode || '',
      formData.activationType || '',
      formData.previousCarrier || '',
      formData.customerName || '',
      formData.birthDate || '',
      formData.phoneNumber || '',
      formData.modelName || '',
      formData.deviceSerial || '',
      formData.color || '',
      formData.simModel || '',
      formData.simSerial || '',
      formData.contractType || '',
      formData.conversionSubsidy || '',
      formData.additionalSubsidy || '',
      formData.installmentMonths || '',
      formData.installmentAmount || '',
      formData.free || '',
      formData.plan || '',
      Array.isArray(formData.mediaServices) ? formData.mediaServices.join(', ') : (formData.mediaServices || formData.mediaService || ''),
      formData.additionalServices || formData.additionalService || '',
      formData.premierContract || '',
      formData.reservationNumber || '',
      formData.otherRequests || ''
    ];

    // L~AJì—´ë§Œ ì—…ë°ì´íŠ¸ (U+ì œì¶œì¼ì‹œ, U+ì œì¶œë°ì´í„°ëŠ” U+ ì œì¶œ APIì—ì„œë§Œ ì—…ë°ì´íŠ¸)
    await sheets.spreadsheets.values.update({
      spreadsheetId: sheetId,
      range: `${sheetName}!L${rowIndex}:AJ${rowIndex}`,
      valueInputOption: 'RAW',
      requestBody: {
        values: [rowData]
      }
    });

    console.log(`âœ… [ê°œí†µì •ë³´ìˆ˜ì •] ìˆ˜ì • ì™„ë£Œ`);
    res.json({ success: true, message: 'ê°œí†µì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' });

  } catch (error) {
    console.error('âŒ [ê°œí†µì •ë³´ìˆ˜ì •] ìˆ˜ì • ì‹¤íŒ¨:', error);
    res.status(500).json({
      success: false,
      error: 'ê°œí†µì •ë³´ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
      message: error.message
    });
  }
});

// ==================== ì˜¨ì„¸ì¼ ê´€ë¦¬ API ====================

// ì˜¨ì„¸ì¼ ë§í¬ ê´€ë¦¬ - ì „ì²´ ë§í¬ ì¡°íšŒ (ê´€ë¦¬ìëª¨ë“œìš©)
app.get('/api/onsale/links', async (req, res) => {
  try {
    console.log('ğŸ“‹ [ì˜¨ì„¸ì¼] ì „ì²´ ë§í¬ ëª©ë¡ ì¡°íšŒ ì‹œì‘');

    const sheetName = 'ì˜¨ì„¸ì¼ë§í¬ê´€ë¦¬';
    const range = 'A:G'; // A~Gì—´: ë§í¬URL, ë²„íŠ¼ëª…, ëŒ€ë¦¬ì ì •ë³´ìˆ¨ê¹€, í™œì„±í™”ì—¬ë¶€, ê°œí†µì–‘ì‹ì‚¬ìš©ì—¬ë¶€, ê°œí†µì–‘ì‹ì‹œíŠ¸ID, ê°œí†µì–‘ì‹ì‹œíŠ¸ì´ë¦„

    const response = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${sheetName}!${range}`,
    });

    const rows = response.data.values || [];

    if (rows.length <= 1) {
      // í—¤ë”ë§Œ ìˆê±°ë‚˜ ë°ì´í„° ì—†ìŒ
      return res.json({ success: true, links: [] });
    }

    const links = rows.slice(1).map((row, index) => ({
      rowIndex: index + 2, // êµ¬ê¸€ ì‹œíŠ¸ì˜ ì‹¤ì œ í–‰ ë²ˆí˜¸ (í—¤ë” ì œì™¸, 1-based)
      url: row[0] || '',
      buttonName: row[1] || '',
      hideAgentInfo: row[2] === 'O',
      isActive: row[3] === 'O',
      useActivationForm: row[4] === 'O',
      activationSheetId: row[5] || '',
      activationSheetName: row[6] || ''
    }));

    console.log(`âœ… [ì˜¨ì„¸ì¼] ë§í¬ ì¡°íšŒ ì™„ë£Œ: ${links.length}ê°œ`);
    res.json({ success: true, links });

  } catch (error) {
    console.error('âŒ [ì˜¨ì„¸ì¼] ë§í¬ ì¡°íšŒ ì‹¤íŒ¨:', error);
    res.status(500).json({
      success: false,
      error: 'ë§í¬ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
      message: error.message
    });
  }
});

// ì˜¨ì„¸ì¼ ë§í¬ ê´€ë¦¬ - í™œì„±í™”ëœ ë§í¬ë§Œ ì¡°íšŒ (ì¼ë°˜ëª¨ë“œìš©)
app.get('/api/onsale/active-links', async (req, res) => {
  try {
    console.log('ğŸ“‹ [ì˜¨ì„¸ì¼] í™œì„±í™” ë§í¬ ëª©ë¡ ì¡°íšŒ ì‹œì‘');

    const sheetName = 'ì˜¨ì„¸ì¼ë§í¬ê´€ë¦¬';
    const range = 'A:G';

    const response = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${sheetName}!${range}`,
    });

    const rows = response.data.values || [];

    if (rows.length <= 1) {
      return res.json({ success: true, links: [] });
    }

    const activeLinks = rows.slice(1)
      .filter(row => row[3] === 'O') // í™œì„±í™”ì—¬ë¶€ê°€ 'O'ì¸ ê²ƒë§Œ
      .map(row => ({
        url: row[0] || '',
        buttonName: row[1] || '',
        hideAgentInfo: row[2] === 'O',
        useActivationForm: row[4] === 'O',
        activationSheetId: row[5] || '',
        activationSheetName: row[6] || ''
      }));

    console.log(`âœ… [ì˜¨ì„¸ì¼] í™œì„±í™” ë§í¬ ì¡°íšŒ ì™„ë£Œ: ${activeLinks.length}ê°œ`);
    res.json({ success: true, links: activeLinks });

  } catch (error) {
    console.error('âŒ [ì˜¨ì„¸ì¼] í™œì„±í™” ë§í¬ ì¡°íšŒ ì‹¤íŒ¨:', error);
    res.status(500).json({
      success: false,
      error: 'ë§í¬ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
      message: error.message
    });
  }
});

// ì˜¨ì„¸ì¼ ë§í¬ ê´€ë¦¬ - ìƒˆ ë§í¬ ì¶”ê°€
app.post('/api/onsale/links', async (req, res) => {
  try {
    console.log('â• [ì˜¨ì„¸ì¼] ìƒˆ ë§í¬ ì¶”ê°€ ì‹œì‘');
    const { url, buttonName, hideAgentInfo, isActive, useActivationForm, activationSheetId, activationSheetName } = req.body;

    if (!url || !buttonName) {
      return res.status(400).json({
        success: false,
        error: 'URLê³¼ ë²„íŠ¼ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.'
      });
    }

    const sheetName = 'ì˜¨ì„¸ì¼ë§í¬ê´€ë¦¬';
    const newRow = [
      url,
      buttonName,
      hideAgentInfo ? 'O' : 'X',
      isActive ? 'O' : 'X',
      useActivationForm ? 'O' : 'X',
      activationSheetId || '',
      activationSheetName || ''
    ];

    await sheets.spreadsheets.values.append({
      spreadsheetId: SPREADSHEET_ID,
      range: `${sheetName}!A:G`,
      valueInputOption: 'RAW',
      requestBody: {
        values: [newRow]
      }
    });

    console.log(`âœ… [ì˜¨ì„¸ì¼] ë§í¬ ì¶”ê°€ ì™„ë£Œ: ${buttonName}`);
    res.json({ success: true, message: 'ë§í¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.' });

  } catch (error) {
    console.error('âŒ [ì˜¨ì„¸ì¼] ë§í¬ ì¶”ê°€ ì‹¤íŒ¨:', error);
    res.status(500).json({
      success: false,
      error: 'ë§í¬ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
      message: error.message
    });
  }
});

// ì˜¨ì„¸ì¼ ë§í¬ ê´€ë¦¬ - ë§í¬ ìˆ˜ì •
app.put('/api/onsale/links/:rowIndex', async (req, res) => {
  try {
    const { rowIndex } = req.params;
    const { url, buttonName, hideAgentInfo, isActive, useActivationForm, activationSheetId, activationSheetName } = req.body;

    console.log(`âœï¸ [ì˜¨ì„¸ì¼] ë§í¬ ìˆ˜ì • ì‹œì‘: í–‰ ${rowIndex}`);

    if (!url || !buttonName) {
      return res.status(400).json({
        success: false,
        error: 'URLê³¼ ë²„íŠ¼ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.'
      });
    }

    const sheetName = 'ì˜¨ì„¸ì¼ë§í¬ê´€ë¦¬';
    const updatedRow = [
      url,
      buttonName,
      hideAgentInfo ? 'O' : 'X',
      isActive ? 'O' : 'X',
      useActivationForm ? 'O' : 'X',
      activationSheetId || '',
      activationSheetName || ''
    ];

    await sheets.spreadsheets.values.update({
      spreadsheetId: SPREADSHEET_ID,
      range: `${sheetName}!A${rowIndex}:G${rowIndex}`,
      valueInputOption: 'RAW',
      requestBody: {
        values: [updatedRow]
      }
    });

    console.log(`âœ… [ì˜¨ì„¸ì¼] ë§í¬ ìˆ˜ì • ì™„ë£Œ: ${buttonName}`);
    res.json({ success: true, message: 'ë§í¬ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' });

  } catch (error) {
    console.error('âŒ [ì˜¨ì„¸ì¼] ë§í¬ ìˆ˜ì • ì‹¤íŒ¨:', error);
    res.status(500).json({
      success: false,
      error: 'ë§í¬ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
      message: error.message
    });
  }
});

// ì˜¨ì„¸ì¼ ë§í¬ ê´€ë¦¬ - ë§í¬ ì‚­ì œ
app.delete('/api/onsale/links/:rowIndex', async (req, res) => {
  try {
    const { rowIndex } = req.params;

    console.log(`ğŸ—‘ï¸ [ì˜¨ì„¸ì¼] ë§í¬ ì‚­ì œ ì‹œì‘: í–‰ ${rowIndex}`);

    const sheetName = 'ì˜¨ì„¸ì¼ë§í¬ê´€ë¦¬';

    // Google Sheets APIë¡œ í–‰ ìì²´ë¥¼ ì‚­ì œ
    await sheets.spreadsheets.batchUpdate({
      spreadsheetId: SPREADSHEET_ID,
      requestBody: {
        requests: [{
          deleteDimension: {
            range: {
              sheetId: 0, // ì²« ë²ˆì§¸ ì‹œíŠ¸ (ì˜¨ì„¸ì¼ë§í¬ê´€ë¦¬)
              dimension: 'ROWS',
              startIndex: parseInt(rowIndex) - 1, // 0-based index
              endIndex: parseInt(rowIndex) // ì‚­ì œí•  í–‰ì˜ ë ì¸ë±ìŠ¤
            }
          }
        }]
      }
    });

    console.log(`âœ… [ì˜¨ì„¸ì¼] ë§í¬ ì‚­ì œ ì™„ë£Œ: í–‰ ${rowIndex} ì™„ì „ ì‚­ì œ`);
    res.json({ success: true, message: 'ë§í¬ê°€ ì™„ì „íˆ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.' });

  } catch (error) {
    console.error('âŒ [ì˜¨ì„¸ì¼] ë§í¬ ì‚­ì œ ì‹¤íŒ¨:', error);
    res.status(500).json({
      success: false,
      error: 'ë§í¬ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
      message: error.message
    });
  }
});

// ==================== ê°œí†µì •ë³´ ì €ì¥ API ====================

// ê°œí†µì •ë³´ ì €ì¥ API
app.post('/api/onsale/activation-info', async (req, res) => {
  try {
    console.log('ğŸ“ [ê°œí†µì •ë³´] ê°œí†µì •ë³´ ì €ì¥ ì‹œì‘');
    const { sheetId, sheetName, data } = req.body;

    if (!sheetId || !sheetName || !data) {
      return res.status(400).json({
        success: false,
        error: 'ì‹œíŠ¸ ID, ì‹œíŠ¸ ì´ë¦„, ë°ì´í„°ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.'
      });
    }

    // Google Sheets APIë¡œ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì ‘ê·¼
    const spreadsheet = await sheets.spreadsheets.get({
      spreadsheetId: sheetId
    });

    // ì‹œíŠ¸ ì°¾ê¸° ë˜ëŠ” ìƒì„±
    let targetSheet = spreadsheet.data.sheets.find(sheet => sheet.properties.title === sheetName);
    if (!targetSheet) {
      console.log(`ğŸ“„ [ê°œí†µì •ë³´] ì‹œíŠ¸ ìƒì„±: ${sheetName}`);
      const newSheet = await sheets.spreadsheets.batchUpdate({
        spreadsheetId: sheetId,
        requestBody: {
          requests: [{
            addSheet: {
              properties: {
                title: sheetName
              }
            }
          }]
        }
      });
      targetSheet = newSheet.data.replies[0].addSheet;
    }

    // ì‹œíŠ¸ ë°ì´í„° í™•ì¸
    const sheetData = await sheets.spreadsheets.values.get({
      spreadsheetId: sheetId,
      range: `${sheetName}!A1:AI1`
    });

    const existingHeaders = sheetData.data.values?.[0] || [];

    // í—¤ë”ê°€ ì—†ìœ¼ë©´ ìƒì„±
    if (existingHeaders.length === 0) {
      console.log('ğŸ“‹ [ê°œí†µì •ë³´] í—¤ë” ìƒì„±');
      const headers = [
        'ê°œí†µì™„ë£Œ', 'ì™„ë£Œì²˜ë¦¬ì', 'ì™„ë£Œì¼ì‹œ', 'ì·¨ì†Œ', 'ì·¨ì†Œì²˜ë¦¬ì', 'ì·¨ì†Œì¼ì‹œ', 'ë³´ë¥˜', 'ë³´ë¥˜ì²˜ë¦¬ì', 'ë³´ë¥˜ì¼ì‹œ', 'ìµœì¢…ìˆ˜ì •ì', 'ìµœì¢…ìˆ˜ì •ì¼ì‹œ', 'ì œì¶œì¼ì‹œ', 'ë§¤ì¥ëª…', 'Pì½”ë“œ', 'ê°œí†µìœ í˜•', 'ì´ì „í†µì‹ ì‚¬', 'ê³ ê°ëª…', 'ìƒë…„ì›”ì¼', 'ê°œí†µë²ˆí˜¸', 'ëª¨ë¸ëª…', 'ê¸°ê¸°ì¼ë ¨ë²ˆí˜¸', 'ìƒ‰ìƒ', 'ìœ ì‹¬ëª¨ë¸', 'ìœ ì‹¬ì¼ë ¨ë²ˆí˜¸', 'ì•½ì •ìœ í˜•', 'ì „í™˜ì§€ì›ê¸ˆ', 'ìœ í†µë§ì¶”ê°€ì§€ì›ê¸ˆ', 'í• ë¶€ê°œì›”', 'í• ë¶€ì›ê¸ˆ', 'í”„ë¦¬', 'ìš”ê¸ˆì œ', 'ë¯¸ë””ì–´ì„œë¹„ìŠ¤', 'ë¶€ê°€ì„œë¹„ìŠ¤', 'í”„ë¦¬ë¯¸ì–´ì•½ì •', 'ì˜ˆì•½ë²ˆí˜¸', 'ê¸°íƒ€ìš”ì²­ì‚¬í•­', 'U+ì œì¶œì¼ì‹œ', 'U+ì œì¶œë°ì´í„°'
      ];

      // ì „ì²´ í—¤ë” ìƒì„± (A1:AL1)
      await sheets.spreadsheets.values.update({
        spreadsheetId: sheetId,
        range: `${sheetName}!A1:AL1`,
        valueInputOption: 'RAW',
        requestBody: {
          values: [headers]
        }
      });
    }

    // ë°ì´í„° ì¤€ë¹„
    const timestamp = new Date().toLocaleString('ko-KR');
    const rowData = [
      timestamp,
      data.storeName || '',
      data.pCode || '',
      data.activationType || '',
      data.previousCarrier || '',
      data.customerName || '',
      data.birthDate || '',
      data.phoneNumber || '',
      data.modelName || '',
      data.deviceSerial || '',
      data.color || '',
      data.simModel || '',
      data.simSerial || '',
      data.contractType || '',
      data.conversionSubsidy || '',
      data.additionalSubsidy || '',
      data.installmentMonths || '',
      data.installmentAmount || '',
      data.free || '',
      data.plan || '',
      Array.isArray(data.mediaServices) ? data.mediaServices.join(', ') : (data.mediaServices || ''),
      data.additionalServices || '',
      data.premierContract || '',
      data.reservationNumber || '',
      data.otherRequests || ''
    ];

    // ì œì¶œì¼ì‹œ ìƒì„±
    const submittedAt = new Date().toLocaleString('ko-KR', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    });

    // ë§¤ì¥ëª… ì¶”ì¶œ
    const storeName = data.storeName || '';

    // ëª¨ë“  ë³€ìˆ˜ ì •ì˜
    const pCode = data.pCode || '';
    const activationType = data.activationType || '';
    const previousCarrier = data.previousCarrier || '';
    const customerName = data.customerName || '';
    const birthDate = data.birthDate || '';
    const phoneNumber = data.phoneNumber || '';
    const modelName = data.modelName || '';
    const deviceSerial = data.deviceSerial || '';
    const color = data.color || '';
    const simModel = data.simModel || '';
    const simSerial = data.simSerial || '';
    const contractType = data.contractType || '';
    const conversionSupport = data.conversionSubsidy || '';
    const distributionSupport = data.additionalSubsidy || '';
    const installmentMonths = data.installmentMonths || '';
    const installmentAmount = data.installmentAmount || '';
    const isFree = data.free || '';
    const plan = data.plan || '';
    const mediaServices = Array.isArray(data.mediaServices) ? data.mediaServices.join(', ') : (data.mediaServices || '');
    const additionalServices = data.additionalServices || '';
    const premierContract = data.premierContract || '';
    const reservationNumber = data.reservationNumber || '';
    const otherRequests = data.otherRequests || '';

    // ë°ì´í„° ì¶”ê°€ (Aì—´ë¶€í„° - ê°œí†µì™„ë£Œ, ì™„ë£Œì²˜ë¦¬ì, ì™„ë£Œì¼ì‹œ, ì·¨ì†Œ, ì·¨ì†Œì²˜ë¦¬ì, ì·¨ì†Œì¼ì‹œ, ë³´ë¥˜, ë³´ë¥˜ì²˜ë¦¬ì, ë³´ë¥˜ì¼ì‹œ, ìµœì¢…ìˆ˜ì •ì, ìµœì¢…ìˆ˜ì •ì¼ì‹œ, ì œì¶œì¼ì‹œ, ë§¤ì¥ëª…, ...)
    const fullRowData = [
      '', // Aì—´: ê°œí†µì™„ë£Œ ì—¬ë¶€ (ì‹ ê·œ ì…ë ¥ ì‹œ ë¹ˆ ê°’)
      '', // Bì—´: ì™„ë£Œì²˜ë¦¬ì (ì‹ ê·œ ì…ë ¥ ì‹œ ë¹ˆ ê°’)
      '', // Cì—´: ì™„ë£Œì¼ì‹œ (ì‹ ê·œ ì…ë ¥ ì‹œ ë¹ˆ ê°’)
      '', // Dì—´: ì·¨ì†Œì—¬ë¶€ (ì‹ ê·œ ì…ë ¥ ì‹œ ë¹ˆ ê°’)
      '', // Eì—´: ì·¨ì†Œì²˜ë¦¬ì (ì‹ ê·œ ì…ë ¥ ì‹œ ë¹ˆ ê°’)
      '', // Fì—´: ì·¨ì†Œì¼ì‹œ (ì‹ ê·œ ì…ë ¥ ì‹œ ë¹ˆ ê°’)
      '', // Gì—´: ë³´ë¥˜ì—¬ë¶€ (ì‹ ê·œ ì…ë ¥ ì‹œ ë¹ˆ ê°’)
      '', // Hì—´: ë³´ë¥˜ì²˜ë¦¬ì (ì‹ ê·œ ì…ë ¥ ì‹œ ë¹ˆ ê°’)
      '', // Iì—´: ë³´ë¥˜ì¼ì‹œ (ì‹ ê·œ ì…ë ¥ ì‹œ ë¹ˆ ê°’)
      '', // Jì—´: ìµœì¢…ìˆ˜ì •ì (ì‹ ê·œ ì…ë ¥ ì‹œ ë¹ˆ ê°’)
      '', // Kì—´: ìµœì¢…ìˆ˜ì •ì¼ì‹œ (ì‹ ê·œ ì…ë ¥ ì‹œ ë¹ˆ ê°’)
      submittedAt, // Lì—´: ì œì¶œì¼ì‹œ
      storeName, // Mì—´: ë§¤ì¥ëª…
      pCode, // Nì—´: Pì½”ë“œ
      activationType, // Oì—´: ê°œí†µìœ í˜•
      previousCarrier, // Pì—´: ì´ì „í†µì‹ ì‚¬
      customerName, // Qì—´: ê³ ê°ëª…
      birthDate, // Rì—´: ìƒë…„ì›”ì¼
      phoneNumber, // Sì—´: ê°œí†µë²ˆí˜¸
      modelName, // Tì—´: ëª¨ë¸ëª…
      deviceSerial, // Uì—´: ê¸°ê¸°ì¼ë ¨ë²ˆí˜¸
      color, // Vì—´: ìƒ‰ìƒ
      simModel, // Wì—´: ìœ ì‹¬ëª¨ë¸
      simSerial, // Xì—´: ìœ ì‹¬ì¼ë ¨ë²ˆí˜¸
      contractType, // Yì—´: ì•½ì •ìœ í˜•
      conversionSupport, // Zì—´: ì „í™˜ì§€ì›ê¸ˆ
      distributionSupport, // AAì—´: ìœ í†µë§ì¶”ê°€ì§€ì›ê¸ˆ
      installmentMonths, // ABì—´: í• ë¶€ê°œì›”
      installmentAmount, // ACì—´: í• ë¶€ì›ê¸ˆ
      isFree, // ADì—´: í”„ë¦¬
      plan, // AEì—´: ìš”ê¸ˆì œ
      mediaServices, // AFì—´: ë¯¸ë””ì–´ì„œë¹„ìŠ¤
      additionalServices, // AGì—´: ë¶€ê°€ì„œë¹„ìŠ¤
      premierContract, // AHì—´: í”„ë¦¬ë¯¸ì–´ì•½ì •
      reservationNumber, // AIì—´: ì˜ˆì•½ë²ˆí˜¸
      otherRequests, // AJì—´: ê¸°íƒ€ìš”ì²­ì‚¬í•­
      '', // AKì—´: U+ì œì¶œì¼ì‹œ (ë¹ˆ ê°’)
      '' // ALì—´: U+ì œì¶œë°ì´í„° (ë¹ˆ ê°’)
    ];

    await sheets.spreadsheets.values.append({
      spreadsheetId: sheetId,
      range: `${sheetName}!A:AL`,
      valueInputOption: 'RAW',
      requestBody: {
        values: [fullRowData]
      }
    });

    console.log('âœ… [ê°œí†µì •ë³´] ê°œí†µì •ë³´ ì €ì¥ ì™„ë£Œ');
    res.json({ success: true, message: 'ê°œí†µì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.' });

  } catch (error) {
    console.error('âŒ [ê°œí†µì •ë³´] ê°œí†µì •ë³´ ì €ì¥ ì‹¤íŒ¨:', error);
    res.status(500).json({
      success: false,
      error: 'ê°œí†µì •ë³´ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
      message: error.message
    });
  }
});

// U+ ì œì¶œ ë°ì´í„° ì €ì¥ API
app.post('/api/onsale/uplus-submission', async (req, res) => {
  try {
    console.log('ğŸ“¤ [U+ì œì¶œ] U+ ì œì¶œ ë°ì´í„° ì €ì¥ ì‹œì‘');
    const { sheetId, sheetName, phoneNumber, data } = req.body;

    if (!sheetId || !sheetName || !data) {
      return res.status(400).json({
        success: false,
        error: 'ì‹œíŠ¸ ID, ì‹œíŠ¸ ì´ë¦„, ë°ì´í„°ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.'
      });
    }

    // Google Sheets APIë¡œ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì ‘ê·¼
    const spreadsheet = await sheets.spreadsheets.get({
      spreadsheetId: sheetId
    });

    // ì‹œíŠ¸ ì°¾ê¸°
    const targetSheet = spreadsheet.data.sheets.find(sheet => sheet.properties.title === sheetName);
    if (!targetSheet) {
      return res.status(404).json({
        success: false,
        error: 'ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }

    // ì „í™”ë²ˆí˜¸ë¡œ ê°œí†µì–‘ì‹ ë°ì´í„° í–‰ ì°¾ê¸°
    // Aì—´ë¶€í„° ì „ì²´ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (í—¤ë” í¬í•¨)
    const searchRange = `${sheetName}!A:AL`;
    const sheetData = await sheets.spreadsheets.values.get({
      spreadsheetId: sheetId,
      range: searchRange
    });

    const rows = sheetData.data.values || [];
    let targetRowIndex = -1;

    // ì „í™”ë²ˆí˜¸ë¡œ ë§¤ì¹­ë˜ëŠ” í–‰ ì°¾ê¸° (í—¤ë” ì œì™¸, 2í–‰ë¶€í„°)
    // Sì—´(ê°œí†µë²ˆí˜¸) = Aì—´ ê¸°ì¤€ 19ë²ˆì§¸ (0-basedë¡œ 18)
    for (let i = 1; i < rows.length; i++) { // í—¤ë”(1í–‰) ì œì™¸
      const row = rows[i];
      if (row[18] === phoneNumber) { // Sì—´: ê°œí†µë²ˆí˜¸ (Aì—´ ê¸°ì¤€ 19ë²ˆì§¸, 0-basedë¡œ 18)
        targetRowIndex = i + 1; // 1-based ì¸ë±ìŠ¤ (êµ¬ê¸€ì‹œíŠ¸ í–‰ ë²ˆí˜¸)
        break;
      }
    }

    if (targetRowIndex === -1) {
      // ë§¤ì¹­ë˜ëŠ” í–‰ì´ ì—†ìœ¼ë©´ ìƒˆ í–‰ì— AK, ALì—´ì— ì €ì¥
      console.log('ğŸ“ [U+ì œì¶œ] ë§¤ì¹­ë˜ëŠ” ê°œí†µì–‘ì‹ ì—†ìŒ, ìƒˆ í–‰ì— ì €ì¥');
      const timestamp = new Date().toLocaleString('ko-KR');
      const newRowData = [
        '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', // A~AJì—´ ë¹ˆ ê°’ (37ê°œ)
        timestamp, // AKì—´: U+ì œì¶œì¼ì‹œ
        JSON.stringify(data) // ALì—´: U+ì œì¶œë°ì´í„° (JSON)
      ];

      await sheets.spreadsheets.values.append({
        spreadsheetId: sheetId,
        range: `${sheetName}!A:AL`,
        valueInputOption: 'RAW',
        requestBody: {
          values: [newRowData]
        }
      });
    } else {
      // ë§¤ì¹­ë˜ëŠ” í–‰ì´ ìˆìœ¼ë©´ AK, ALì—´ì— U+ ë°ì´í„° ì €ì¥
      console.log(`ğŸ“ [U+ì œì¶œ] ë§¤ì¹­ë˜ëŠ” ê°œí†µì–‘ì‹ ë°œê²¬, í–‰ ${targetRowIndex}ì— U+ ë°ì´í„° ì¶”ê°€`);
      const timestamp = new Date().toLocaleString('ko-KR');
      const uplusData = [
        timestamp, // AKì—´: U+ì œì¶œì¼ì‹œ
        JSON.stringify(data) // ALì—´: U+ì œì¶œë°ì´í„° (JSON)
      ];

      await sheets.spreadsheets.values.update({
        spreadsheetId: sheetId,
        range: `${sheetName}!AK${targetRowIndex}:AL${targetRowIndex}`,
        valueInputOption: 'RAW',
        requestBody: {
          values: [uplusData]
        }
      });
    }

    console.log('âœ… [U+ì œì¶œ] U+ ì œì¶œ ë°ì´í„° ì €ì¥ ì™„ë£Œ');
    res.json({ success: true, message: 'U+ ì œì¶œ ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.' });

  } catch (error) {
    console.error('âŒ [U+ì œì¶œ] U+ ì œì¶œ ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:', error);
    res.status(500).json({
      success: false,
      error: 'U+ ì œì¶œ ë°ì´í„° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
      message: error.message
    });
  }
});

// ==================== ì¼ë°˜ëª¨ë“œ ì˜¨ì„¸ì¼ì ‘ìˆ˜ API ====================

// ì¼ë°˜ëª¨ë“œ ì˜¨ì„¸ì¼ ê¶Œí•œ í™•ì¸
app.post('/api/check-onsale-permission', async (req, res) => {
  try {
    const { userId, password } = req.body;

    console.log(`ğŸ” [ì˜¨ì„¸ì¼ê¶Œí•œ] ê¶Œí•œ í™•ì¸ ì‹œì‘: ${userId}`);

    if (!userId || !password) {
      return res.status(400).json({
        success: false,
        hasPermission: false,
        error: 'ì‚¬ìš©ì IDì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'
      });
    }

    const sheetName = 'ì¼ë°˜ëª¨ë“œê¶Œí•œê´€ë¦¬';
    const range = 'A:F'; // A~Fì—´: ì‚¬ìš©ìID(POSì½”ë“œ), ì—…ì²´ëª…, ì˜ì—…ë‹´ë‹¹, ê¸°ë³¸ëª¨ë“œ, ì˜¨ì„¸ì¼ì ‘ìˆ˜ëª¨ë“œ, ë¹„ë°€ë²ˆí˜¸

    const response = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${sheetName}!${range}`,
    });

    const rows = response.data.values || [];

    // í—¤ë”ëŠ” 3í–‰(ì¸ë±ìŠ¤ 2), ë°ì´í„°ëŠ” 4í–‰(ì¸ë±ìŠ¤ 3)ë¶€í„°
    if (rows.length <= 3) {
      console.log('âš ï¸ [ì˜¨ì„¸ì¼ê¶Œí•œ] ì¼ë°˜ëª¨ë“œê¶Œí•œê´€ë¦¬ ì‹œíŠ¸ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return res.json({ success: true, hasPermission: false });
    }

    // 4í–‰ë¶€í„° ë°ì´í„°
    const dataRows = rows.slice(3);
    const userRow = dataRows.find(row => row[0] === userId);

    if (!userRow) {
      console.log(`âš ï¸ [ì˜¨ì„¸ì¼ê¶Œí•œ] ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${userId}`);
      return res.json({ success: true, hasPermission: false });
    }

    const storeName = userRow[1] || '';
    // Eì—´(4ì¸ë±ìŠ¤): ì˜¨ì„¸ì¼ì ‘ìˆ˜ ëª¨ë“œ - 'O' ë˜ëŠ” 'M' ëª¨ë‘ í—ˆìš©
    const eColumnValue = (userRow[4] || '').toString().trim().toUpperCase();
    const hasPermission = eColumnValue === 'O' || eColumnValue === 'M';
    const storedPassword = userRow[5] || ''; // Fì—´(5ì¸ë±ìŠ¤): ë¹„ë°€ë²ˆí˜¸

    if (!hasPermission) {
      console.log(`âš ï¸ [ì˜¨ì„¸ì¼ê¶Œí•œ] ê¶Œí•œ ì—†ìŒ: ${userId}`);
      return res.json({ success: true, hasPermission: false });
    }

    if (storedPassword !== password) {
      console.log(`âš ï¸ [ì˜¨ì„¸ì¼ê¶Œí•œ] ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜: ${userId}`);
      return res.json({ success: true, hasPermission: false, error: 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.' });
    }

    console.log(`âœ… [ì˜¨ì„¸ì¼ê¶Œí•œ] ê¶Œí•œ í™•ì¸ ì„±ê³µ: ${userId} (${storeName})`);
    res.json({
      success: true,
      hasPermission: true,
      storeName
    });

  } catch (error) {
    console.error('âŒ [ì˜¨ì„¸ì¼ê¶Œí•œ] ê¶Œí•œ í™•ì¸ ì‹¤íŒ¨:', error);
    res.status(500).json({
      success: false,
      hasPermission: false,
      error: 'ê¶Œí•œ í™•ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
      message: error.message
    });
  }
});

// ========== ì˜¨ì„¸ì¼ ì •ì±…ê²Œì‹œíŒ API ==========

// ê·¸ë£¹ ëª©ë¡ ì¡°íšŒ (ì¼ë°˜ëª¨ë“œê¶Œí•œê´€ë¦¬ ì‹œíŠ¸ì—ì„œ)
app.get('/api/onsale/policies/groups', async (req, res) => {
  try {
    console.log('ğŸ“‹ [ì •ì±…ê²Œì‹œíŒ] ê·¸ë£¹ ëª©ë¡ ì¡°íšŒ ì‹œì‘');

    const sheetName = 'ì¼ë°˜ëª¨ë“œê¶Œí•œê´€ë¦¬';
    const range = 'A:C'; // Aì—´: ì•„ì´ë””, Bì—´: ì—…ì²´ëª…, Cì—´: ê·¸ë£¹

    const response = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${sheetName}!${range}`,
    });

    const rows = response.data.values || [];

    // í—¤ë”ëŠ” 3í–‰(ì¸ë±ìŠ¤ 2), ë°ì´í„°ëŠ” 4í–‰(ì¸ë±ìŠ¤ 3)ë¶€í„°
    if (rows.length <= 3) {
      return res.json({ success: true, groups: [] });
    }

    const dataRows = rows.slice(3);

    // ê·¸ë£¹ë³„ë¡œ ì—…ì²´ë“¤ì„ ê·¸ë£¹í•‘
    const groupMap = new Map();

    dataRows.forEach(row => {
      const groupName = (row[2] || '').trim(); // Cì—´: ê·¸ë£¹
      const companyName = (row[1] || '').trim(); // Bì—´: ì—…ì²´ëª…
      const companyId = (row[0] || '').trim(); // Aì—´: ì•„ì´ë””

      if (!groupName || !companyName || !companyId) return;

      if (!groupMap.has(groupName)) {
        groupMap.set(groupName, []);
      }

      groupMap.get(groupName).push({
        id: companyId,
        name: companyName
      });
    });

    // ê·¸ë£¹ ëª©ë¡ ìƒì„± (ì¤‘ë³µ ì œê±°)
    const groups = Array.from(groupMap.entries()).map(([groupName, companies]) => ({
      name: groupName,
      companies: companies
    }));

    console.log(`âœ… [ì •ì±…ê²Œì‹œíŒ] ê·¸ë£¹ ëª©ë¡ ì¡°íšŒ ì™„ë£Œ: ${groups.length}ê°œ ê·¸ë£¹`);
    res.json({ success: true, groups });

  } catch (error) {
    console.error('âŒ [ì •ì±…ê²Œì‹œíŒ] ê·¸ë£¹ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
    res.status(500).json({
      success: false,
      error: 'ê·¸ë£¹ ëª©ë¡ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
      message: error.message
    });
  }
});

// ì •ì±… ëª©ë¡ ì¡°íšŒ
app.get('/api/onsale/policies', async (req, res) => {
  try {
    console.log('ğŸ“‹ [ì •ì±…ê²Œì‹œíŒ] ì •ì±… ëª©ë¡ ì¡°íšŒ ì‹œì‘');

    const sheetName = 'ì˜¨ì„¸ì¼ì •ì±…ê²Œì‹œíŒ';
    const range = 'A:K'; // ë²ˆí˜¸, ì œëª©, ê·¸ë£¹(JSON), ì—…ì²´ID(JSON), ë‚´ìš©, ìƒë‹¨ê³ ì •ì—¬ë¶€, ë“±ë¡ì, ë“±ë¡ì¼, ìˆ˜ì •ì¼, ì‚­ì œì—¬ë¶€, í™•ì¸ì´ë ¥(JSON)

    const response = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${sheetName}!${range}`,
    });

    const rows = response.data.values || [];

    if (rows.length <= 1) {
      return res.json({ success: true, policies: [] });
    }

    const policies = rows.slice(1).map((row, index) => {
      try {
        const viewHistory = row[10] ? JSON.parse(row[10]) : []; // Kì—´: í™•ì¸ì´ë ¥

        // ì¤‘ë³µ ì œê±°í•˜ì—¬ ê³ ìœ  ì—…ì²´ ìˆ˜ ê³„ì‚°
        const uniqueCompanies = new Set();
        let firstViewDate = null;

        viewHistory.forEach(view => {
          if (view.companyId && !uniqueCompanies.has(view.companyId)) {
            uniqueCompanies.add(view.companyId);
            if (!firstViewDate || (view.firstViewDate && view.firstViewDate < firstViewDate)) {
              firstViewDate = view.firstViewDate || view.viewDate;
            }
          }
        });

        return {
          id: index + 2, // êµ¬ê¸€ ì‹œíŠ¸ì˜ ì‹¤ì œ í–‰ ë²ˆí˜¸ (í—¤ë” ì œì™¸, 1-based)
          number: row[0] || '',
          title: row[1] || '',
          groups: row[2] ? JSON.parse(row[2]) : [],
          companyIds: row[3] ? JSON.parse(row[3]) : [],
          content: row[4] || '',
          isPinned: row[5] === 'O',
          createdBy: row[6] || '',
          createdAt: row[7] || '',
          updatedAt: row[8] || '',
          isDeleted: row[9] === 'O',
          viewCount: uniqueCompanies.size,
          firstViewDate: firstViewDate
        };
      } catch (error) {
        console.error(`âš ï¸ [ì •ì±…ê²Œì‹œíŒ] í–‰ ${index + 2} íŒŒì‹± ì˜¤ë¥˜:`, error);
        return null;
      }
    }).filter(policy => policy && !policy.isDeleted); // ì‚­ì œë˜ì§€ ì•Šì€ ì •ì±…ë§Œ

    // ìƒë‹¨ê³ ì • ì •ì±…ì„ ë¨¼ì €, ê·¸ ë‹¤ìŒ ë“±ë¡ì¼ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
    policies.sort((a, b) => {
      if (a.isPinned && !b.isPinned) return -1;
      if (!a.isPinned && b.isPinned) return 1;
      return new Date(b.createdAt) - new Date(a.createdAt);
    });

    console.log(`âœ… [ì •ì±…ê²Œì‹œíŒ] ì •ì±… ëª©ë¡ ì¡°íšŒ ì™„ë£Œ: ${policies.length}ê°œ`);
    res.json({ success: true, policies });

  } catch (error) {
    console.error('âŒ [ì •ì±…ê²Œì‹œíŒ] ì •ì±… ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
    res.status(500).json({
      success: false,
      error: 'ì •ì±… ëª©ë¡ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
      message: error.message
    });
  }
});

// ì •ì±… ìƒì„¸ ì¡°íšŒ
app.get('/api/onsale/policies/:id', async (req, res) => {
  try {
    const { id } = req.params;
    const rowIndex = parseInt(id);

    console.log(`ğŸ“‹ [ì •ì±…ê²Œì‹œíŒ] ì •ì±… ìƒì„¸ ì¡°íšŒ ì‹œì‘: í–‰ ${rowIndex}`);

    const sheetName = 'ì˜¨ì„¸ì¼ì •ì±…ê²Œì‹œíŒ';
    const range = `A${rowIndex}:K${rowIndex}`;

    const response = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${sheetName}!${range}`,
    });

    const rows = response.data.values || [];

    if (rows.length === 0) {
      return res.status(404).json({
        success: false,
        error: 'ì •ì±…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }

    const row = rows[0];

    try {
      const viewHistory = row[10] ? JSON.parse(row[10]) : [];

      const policy = {
        id: rowIndex,
        number: row[0] || '',
        title: row[1] || '',
        groups: row[2] ? JSON.parse(row[2]) : [],
        companyIds: row[3] ? JSON.parse(row[3]) : [],
        content: row[4] || '',
        isPinned: row[5] === 'O',
        createdBy: row[6] || '',
        createdAt: row[7] || '',
        updatedAt: row[8] || '',
        isDeleted: row[9] === 'O',
        viewHistory: viewHistory
      };

      console.log(`âœ… [ì •ì±…ê²Œì‹œíŒ] ì •ì±… ìƒì„¸ ì¡°íšŒ ì™„ë£Œ: ${policy.title}`);
      res.json({ success: true, policy });

    } catch (error) {
      console.error('âŒ [ì •ì±…ê²Œì‹œíŒ] ì •ì±… íŒŒì‹± ì˜¤ë¥˜:', error);
      res.status(500).json({
        success: false,
        error: 'ì •ì±… ë°ì´í„° íŒŒì‹±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
        message: error.message
      });
    }

  } catch (error) {
    console.error('âŒ [ì •ì±…ê²Œì‹œíŒ] ì •ì±… ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨:', error);
    res.status(500).json({
      success: false,
      error: 'ì •ì±… ìƒì„¸ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
      message: error.message
    });
  }
});

// ì •ì±… ë“±ë¡
app.post('/api/onsale/policies', async (req, res) => {
  try {
    const { title, groups, companyIds, content, isPinned, createdBy } = req.body;

    console.log('â• [ì •ì±…ê²Œì‹œíŒ] ìƒˆ ì •ì±… ë“±ë¡ ì‹œì‘');

    if (!title || !content || !createdBy) {
      return res.status(400).json({
        success: false,
        error: 'ì œëª©, ë‚´ìš©, ë“±ë¡ìëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.'
      });
    }

    const sheetName = 'ì˜¨ì„¸ì¼ì •ì±…ê²Œì‹œíŒ';

    // ë‹¤ìŒ ë²ˆí˜¸ ê³„ì‚° (ê¸°ì¡´ ë°ì´í„° í™•ì¸)
    const existingResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${sheetName}!A:A`,
    });

    const existingRows = existingResponse.data.values || [];
    const nextNumber = existingRows.length; // í—¤ë” í¬í•¨í•˜ë¯€ë¡œ ë‹¤ìŒ ë²ˆí˜¸

    const now = new Date().toISOString().slice(0, 19).replace('T', ' ');

    const newRow = [
      nextNumber.toString(), // ë²ˆí˜¸
      title, // ì œëª©
      JSON.stringify(groups || []), // ê·¸ë£¹
      JSON.stringify(companyIds || []), // ì—…ì²´ID
      content, // ë‚´ìš©
      isPinned ? 'O' : 'X', // ìƒë‹¨ê³ ì •ì—¬ë¶€
      createdBy, // ë“±ë¡ì
      now, // ë“±ë¡ì¼
      '', // ìˆ˜ì •ì¼
      'X', // ì‚­ì œì—¬ë¶€
      JSON.stringify([]) // í™•ì¸ì´ë ¥
    ];

    await sheets.spreadsheets.values.append({
      spreadsheetId: SPREADSHEET_ID,
      range: `${sheetName}!A:K`,
      valueInputOption: 'RAW',
      requestBody: {
        values: [newRow]
      }
    });

    console.log(`âœ… [ì •ì±…ê²Œì‹œíŒ] ì •ì±… ë“±ë¡ ì™„ë£Œ: ${title}`);
    res.json({ success: true, message: 'ì •ì±…ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.' });

  } catch (error) {
    console.error('âŒ [ì •ì±…ê²Œì‹œíŒ] ì •ì±… ë“±ë¡ ì‹¤íŒ¨:', error);
    res.status(500).json({
      success: false,
      error: 'ì •ì±… ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
      message: error.message
    });
  }
});

// ì •ì±… ìˆ˜ì •
// ì˜¨ì„¸ì¼ ì •ì±… ìˆ˜ì • OPTIONS ìš”ì²­ ì²˜ë¦¬
app.options('/api/onsale/policies/:id', (req, res) => {
  const corsOrigins = process.env.CORS_ORIGIN?.split(',') || [];
  const defaultOrigins = [
    'https://vipmobile.vercel.app',
    'http://localhost:3000',
    'http://localhost:3001',
    'http://localhost:4000'
  ];
  const allowedOrigins = [...corsOrigins, ...defaultOrigins];
  const origin = req.headers.origin;

  if (origin && allowedOrigins.includes(origin)) {
    res.header('Access-Control-Allow-Origin', origin);
  } else if (allowedOrigins.length > 0) {
    res.header('Access-Control-Allow-Origin', allowedOrigins[0]);
  }
  res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS, PATCH');
  res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With, Origin, Accept, X-API-Key');
  res.header('Access-Control-Allow-Credentials', 'true');
  res.header('Access-Control-Max-Age', '86400'); // 24ì‹œê°„ ìºì‹œ
  res.status(200).end();
});

app.put('/api/onsale/policies/:id', async (req, res) => {
  // CORS í—¤ë” ëª…ì‹œì  ì„¤ì •
  const corsOrigins = process.env.CORS_ORIGIN?.split(',') || [];
  const defaultOrigins = [
    'https://vipmobile.vercel.app',
    'http://localhost:3000',
    'http://localhost:3001',
    'http://localhost:4000'
  ];
  const allowedOrigins = [...corsOrigins, ...defaultOrigins];
  const origin = req.headers.origin;

  if (origin && allowedOrigins.includes(origin)) {
    res.header('Access-Control-Allow-Origin', origin);
  } else if (allowedOrigins.length > 0) {
    res.header('Access-Control-Allow-Origin', allowedOrigins[0]);
  }
  res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS, PATCH');
  res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With, Origin, Accept, X-API-Key');
  res.header('Access-Control-Allow-Credentials', 'true');

  try {
    const { id } = req.params;
    const { title, groups, companyIds, content, isPinned } = req.body;
    const rowIndex = parseInt(id);

    console.log(`âœï¸ [ì •ì±…ê²Œì‹œíŒ] ì •ì±… ìˆ˜ì • ì‹œì‘: í–‰ ${rowIndex}`);

    if (!title || !content) {
      return res.status(400).json({
        success: false,
        error: 'ì œëª©ê³¼ ë‚´ìš©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.'
      });
    }

    const sheetName = 'ì˜¨ì„¸ì¼ì •ì±…ê²Œì‹œíŒ';

    // ê¸°ì¡´ ë°ì´í„° ì½ê¸°
    const existingResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${sheetName}!A${rowIndex}:K${rowIndex}`,
    });

    const existingRow = existingResponse.data.values?.[0];
    if (!existingRow) {
      return res.status(404).json({
        success: false,
        error: 'ì •ì±…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }

    const now = new Date().toISOString().slice(0, 19).replace('T', ' ');

    const updatedRow = [
      existingRow[0], // ë²ˆí˜¸ (ë³€ê²½ ì—†ìŒ)
      title, // ì œëª©
      JSON.stringify(groups || []), // ê·¸ë£¹
      JSON.stringify(companyIds || []), // ì—…ì²´ID
      content, // ë‚´ìš©
      isPinned ? 'O' : 'X', // ìƒë‹¨ê³ ì •ì—¬ë¶€
      existingRow[6], // ë“±ë¡ì (ë³€ê²½ ì—†ìŒ)
      existingRow[7], // ë“±ë¡ì¼ (ë³€ê²½ ì—†ìŒ)
      now, // ìˆ˜ì •ì¼
      existingRow[9], // ì‚­ì œì—¬ë¶€ (ë³€ê²½ ì—†ìŒ)
      existingRow[10] || JSON.stringify([]) // í™•ì¸ì´ë ¥ (ë³€ê²½ ì—†ìŒ)
    ];

    await sheets.spreadsheets.values.update({
      spreadsheetId: SPREADSHEET_ID,
      range: `${sheetName}!A${rowIndex}:K${rowIndex}`,
      valueInputOption: 'RAW',
      requestBody: {
        values: [updatedRow]
      }
    });

    console.log(`âœ… [ì •ì±…ê²Œì‹œíŒ] ì •ì±… ìˆ˜ì • ì™„ë£Œ: ${title}`);
    res.json({ success: true, message: 'ì •ì±…ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' });

  } catch (error) {
    console.error('âŒ [ì •ì±…ê²Œì‹œíŒ] ì •ì±… ìˆ˜ì • ì‹¤íŒ¨:', error);
    res.status(500).json({
      success: false,
      error: 'ì •ì±… ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
      message: error.message
    });
  }
});

// ì •ì±… ì‚­ì œ
app.delete('/api/onsale/policies/:id', async (req, res) => {
  try {
    const { id } = req.params;
    const rowIndex = parseInt(id);

    console.log(`ğŸ—‘ï¸ [ì •ì±…ê²Œì‹œíŒ] ì •ì±… ì‚­ì œ ì‹œì‘: í–‰ ${rowIndex}`);

    const sheetName = 'ì˜¨ì„¸ì¼ì •ì±…ê²Œì‹œíŒ';

    // ê¸°ì¡´ ë°ì´í„° ì½ê¸°
    const existingResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${sheetName}!A${rowIndex}:K${rowIndex}`,
    });

    const existingRow = existingResponse.data.values?.[0];
    if (!existingRow) {
      return res.status(404).json({
        success: false,
        error: 'ì •ì±…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }

    // ì‚­ì œ í”Œë˜ê·¸ë§Œ ì—…ë°ì´íŠ¸ (ì‹¤ì œ í–‰ ì‚­ì œ ì•ˆ í•¨)
    const updatedRow = [...existingRow];
    updatedRow[9] = 'O'; // ì‚­ì œì—¬ë¶€

    await sheets.spreadsheets.values.update({
      spreadsheetId: SPREADSHEET_ID,
      range: `${sheetName}!A${rowIndex}:K${rowIndex}`,
      valueInputOption: 'RAW',
      requestBody: {
        values: [updatedRow]
      }
    });

    console.log(`âœ… [ì •ì±…ê²Œì‹œíŒ] ì •ì±… ì‚­ì œ ì™„ë£Œ: í–‰ ${rowIndex}`);
    res.json({ success: true, message: 'ì •ì±…ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.' });

  } catch (error) {
    console.error('âŒ [ì •ì±…ê²Œì‹œíŒ] ì •ì±… ì‚­ì œ ì‹¤íŒ¨:', error);
    res.status(500).json({
      success: false,
      error: 'ì •ì±… ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
      message: error.message
    });
  }
});

// ì •ì±… í™•ì¸ ì´ë ¥ ê¸°ë¡
app.post('/api/onsale/policies/:id/view', async (req, res) => {
  try {
    const { id } = req.params;
    const { companyId, companyName } = req.body;
    const rowIndex = parseInt(id);

    console.log(`ğŸ‘ï¸ [ì •ì±…ê²Œì‹œíŒ] ì •ì±… í™•ì¸ ì´ë ¥ ê¸°ë¡ ì‹œì‘: í–‰ ${rowIndex}, ì—…ì²´ ${companyId}`);

    if (!companyId || !companyName) {
      return res.status(400).json({
        success: false,
        error: 'ì—…ì²´ IDì™€ ì—…ì²´ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.'
      });
    }

    const sheetName = 'ì˜¨ì„¸ì¼ì •ì±…ê²Œì‹œíŒ';

    // ê¸°ì¡´ ë°ì´í„° ì½ê¸°
    const existingResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${sheetName}!A${rowIndex}:K${rowIndex}`,
    });

    const existingRow = existingResponse.data.values?.[0];
    if (!existingRow) {
      return res.status(404).json({
        success: false,
        error: 'ì •ì±…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }

    // ê¸°ì¡´ í™•ì¸ ì´ë ¥ íŒŒì‹±
    let viewHistory = [];
    try {
      viewHistory = existingRow[10] ? JSON.parse(existingRow[10]) : [];
    } catch (error) {
      console.error('âš ï¸ [ì •ì±…ê²Œì‹œíŒ] í™•ì¸ ì´ë ¥ íŒŒì‹± ì˜¤ë¥˜, ë¹ˆ ë°°ì—´ë¡œ ì´ˆê¸°í™”:', error);
      viewHistory = [];
    }

    // ê°™ì€ ì—…ì²´ì˜ ê¸°ì¡´ í™•ì¸ ì´ë ¥ ì°¾ê¸°
    const existingView = viewHistory.find(v => v.companyId === companyId);
    const now = new Date().toISOString().slice(0, 19).replace('T', ' ');

    if (existingView) {
      // ê¸°ì¡´ í™•ì¸ ì´ë ¥ì´ ìˆìœ¼ë©´ ì¡°íšŒì¼ì‹œë§Œ ì—…ë°ì´íŠ¸
      existingView.viewDate = now;
    } else {
      // ìƒˆë¡œìš´ í™•ì¸ ì´ë ¥ ì¶”ê°€
      viewHistory.push({
        companyId: companyId,
        companyName: companyName,
        viewDate: now,
        firstViewDate: now
      });
    }

    // í™•ì¸ ì´ë ¥ ì—…ë°ì´íŠ¸
    const updatedRow = [...existingRow];
    updatedRow[10] = JSON.stringify(viewHistory);

    await sheets.spreadsheets.values.update({
      spreadsheetId: SPREADSHEET_ID,
      range: `${sheetName}!A${rowIndex}:K${rowIndex}`,
      valueInputOption: 'RAW',
      requestBody: {
        values: [updatedRow]
      }
    });

    console.log(`âœ… [ì •ì±…ê²Œì‹œíŒ] ì •ì±… í™•ì¸ ì´ë ¥ ê¸°ë¡ ì™„ë£Œ: ì—…ì²´ ${companyName}`);
    res.json({ success: true, message: 'í™•ì¸ ì´ë ¥ì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.' });

  } catch (error) {
    console.error('âŒ [ì •ì±…ê²Œì‹œíŒ] ì •ì±… í™•ì¸ ì´ë ¥ ê¸°ë¡ ì‹¤íŒ¨:', error);
    res.status(500).json({
      success: false,
      error: 'í™•ì¸ ì´ë ¥ ê¸°ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
      message: error.message
    });
  }
});

// ì˜¨ì„¸ì¼ í”„ë¡ì‹œ - ì•ˆë‚´ í˜ì´ì§€ ìƒì„± (ë°©ì•ˆ 2)
app.post('/api/onsale-proxy', async (req, res) => {
  try {
    const { url, agentCode } = req.body;

    console.log(`ğŸ“„ [ì˜¨ì„¸ì¼í”„ë¡ì‹œ] ì•ˆë‚´ í˜ì´ì§€ ìƒì„± ì‹œì‘: ${url}`);

    if (!url) {
      return res.status(400).json({
        success: false,
        error: 'URLì´ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }

    // ê¹”ë”í•œ ì•ˆë‚´ í˜ì´ì§€ HTML
    const guidePage = `
      <!DOCTYPE html>
      <html lang="ko">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>U+ ì˜¨ë¼ì¸ ê°€ì… ì•ˆë‚´</title>
        <style>
          * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
          }
          
          body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 0;
            margin: 0;
          }
          
          .header {
            background: #E6007E;
            padding: 15px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
          }
          
          .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
          }
          
          .logo-text {
            color: white;
            font-size: 24px;
            font-weight: bold;
            letter-spacing: -0.5px;
          }
          
          .container {
            max-width: 600px;
            margin: 80px auto;
            padding: 20px;
          }
          
          .main-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            padding: 60px 50px;
            text-align: center;
          }
          
          @keyframes fadeIn {
            from {
              opacity: 0;
              transform: translateY(20px);
            }
            to {
              opacity: 1;
              transform: translateY(0);
            }
          }
          
          .icon-circle {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #E6007E 0%, #FF6B9D 100%);
            border-radius: 50%;
            margin: 0 auto 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 50px;
          }
          
          h1 {
            font-size: 32px;
            color: #222;
            margin-bottom: 15px;
            font-weight: 700;
          }
          
          .subtitle {
            font-size: 18px;
            color: #666;
            margin-bottom: 50px;
            line-height: 1.8;
          }
          
          .btn-start {
            background: linear-gradient(135deg, #E6007E 0%, #FF1493 100%);
            color: white;
            border: none;
            padding: 20px 60px;
            font-size: 20px;
            font-weight: 700;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(230, 0, 126, 0.3);
            transition: all 0.2s ease;
            width: 100%;
            max-width: 400px;
          }
          
          .btn-start:hover {
            background: linear-gradient(135deg, #CC006B 0%, #E6007E 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(230, 0, 126, 0.4);
          }
          
          .btn-start:active {
            transform: translateY(0);
          }
          
          .footer {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid #eee;
            font-size: 14px;
            color: #999;
            line-height: 1.6;
          }
          
          .uplus-brand {
            color: #E6007E;
            font-weight: 700;
          }
        </style>
      </head>
      <body>
        <div class="header">
          <div class="header-content">
            <div class="logo-text">U+</div>
          </div>
        </div>
        
        <div class="container">
          <div class="main-card">
            <div class="icon-circle">ğŸ“±</div>
            
            <h1>ì˜¨ë¼ì¸ ê°€ì…ì‹ ì²­</h1>
            <p class="subtitle">
              <span class="uplus-brand">LG U+</span> ê³µì‹ ì¸ì¦ëŒ€ë¦¬ì ì„ í†µí•´<br>
              ì•ˆì „í•˜ê³  í¸ë¦¬í•˜ê²Œ ê°€ì…í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
            
            <button class="btn-start" onclick="startApplication()">
              ê°€ì… ì‹ ì²­ ì‹œì‘í•˜ê¸°
            </button>
            
            <p class="footer">
              ë³¸ ì„œë¹„ìŠ¤ëŠ” <span class="uplus-brand">LGìœ í”ŒëŸ¬ìŠ¤</span> ê³µì‹ ì¸ì¦ëŒ€ë¦¬ì ì„ í†µí•´ ì œê³µë©ë‹ˆë‹¤
            </p>
          </div>
        </div>
        
        <script>
          function startApplication() {
            // ì›ë³¸ URLì„ ìƒˆ ì°½ì—ì„œ ì—´ê¸°
            window.open('${url}', '_blank', 'noopener,noreferrer');
            
            // ë¶€ëª¨ ì°½ì— ë©”ì‹œì§€ ì „ë‹¬ (ì„ íƒì )
            if (window.parent) {
              window.parent.postMessage({ type: 'APPLICATION_STARTED' }, '*');
            }
          }
        </script>
      </body>
      </html>
    `;

    console.log(`âœ… [ì˜¨ì„¸ì¼í”„ë¡ì‹œ] ì•ˆë‚´ í˜ì´ì§€ ìƒì„± ì™„ë£Œ`);

    res.send(guidePage);

  } catch (error) {
    console.error('âŒ [ì˜¨ì„¸ì¼í”„ë¡ì‹œ] í”„ë¡ì‹œ ì²˜ë¦¬ ì‹¤íŒ¨:', error);

    // ì—ëŸ¬ ë°œìƒ ì‹œ ê°„ë‹¨í•œ ì•ˆë‚´ í˜ì´ì§€ ë°˜í™˜
    const errorHtml = `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>í˜ì´ì§€ ë¡œë“œ ì‹¤íŒ¨</title>
        <style>
          body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f5f5f5;
          }
          .error-container {
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          }
          h1 { color: #d32f2f; }
          p { color: #666; }
          button {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #1976d2;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
          }
          button:hover {
            background-color: #1565c0;
          }
        </style>
      </head>
      <body>
        <div class="error-container">
          <h1>í˜ì´ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h1>
          <p>ì¼ì‹œì ì¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
          <p>ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì›ë³¸ í˜ì´ì§€ì—ì„œ ì§„í–‰í•´ì£¼ì„¸ìš”.</p>
          <button onclick="window.open('${req.body.url}', '_blank')">
            ì›ë³¸ í˜ì´ì§€ì—ì„œ ì—´ê¸°
          </button>
        </div>
      </body>
      </html>
    `;

    res.send(errorHtml);
  }
});

// ==================== Chrome í™•ì¥ í”„ë¡œê·¸ë¨ ê´€ë¦¬ API ====================

// í™•ì¥ í”„ë¡œê·¸ë¨ ìµœì†Œ ë²„ì „ ìš”êµ¬ì‚¬í•­
const REQUIRED_EXTENSION_VERSION = '1.3.0';

// í™•ì¥ í”„ë¡œê·¸ë¨ ìµœì†Œ ë²„ì „ ì¡°íšŒ
app.get('/api/extension-version', (req, res) => {
  res.json({
    success: true,
    requiredVersion: REQUIRED_EXTENSION_VERSION,
    message: 'í™•ì¥ í”„ë¡œê·¸ë¨ ìµœì†Œ ë²„ì „ì…ë‹ˆë‹¤.'
  });
});

// Chrome í™•ì¥ í”„ë¡œê·¸ë¨ ZIP ë‹¤ìš´ë¡œë“œ
app.get('/api/download-chrome-extension', (req, res) => {
  try {
    console.log('ğŸ“¥ [í™•ì¥ë‹¤ìš´ë¡œë“œ] Chrome í™•ì¥ í”„ë¡œê·¸ë¨ ë‹¤ìš´ë¡œë“œ ì‹œì‘');

    const archiver = require('archiver');
    const path = require('path');
    const fs = require('fs');

    // vip-extension í´ë” ê²½ë¡œ (server í´ë” ë‚´ë¶€)
    const extensionPath = path.join(__dirname, 'vip-extension');

    // í´ë” ì¡´ì¬ í™•ì¸
    if (!fs.existsSync(extensionPath)) {
      console.error('âŒ [í™•ì¥ë‹¤ìš´ë¡œë“œ] vip-extension í´ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', extensionPath);
      return res.status(404).json({
        success: false,
        error: 'Chrome í™•ì¥ í”„ë¡œê·¸ë¨ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }

    // ZIP íŒŒì¼ ìƒì„±
    const archive = archiver('zip', {
      zlib: { level: 9 } // ìµœëŒ€ ì••ì¶•
    });

    // ì—ëŸ¬ í•¸ë“¤ëŸ¬
    archive.on('error', (err) => {
      console.error('âŒ [í™•ì¥ë‹¤ìš´ë¡œë“œ] ZIP ìƒì„± ì˜¤ë¥˜:', err);
      res.status(500).json({
        success: false,
        error: 'ZIP íŒŒì¼ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
      });
    });

    // ì‘ë‹µ í—¤ë” ì„¤ì •
    res.attachment('vip-extension.zip');
    res.setHeader('Content-Type', 'application/zip');

    // archiveë¥¼ responseì— íŒŒì´í”„
    archive.pipe(res);

    // vip-extension í´ë”ì˜ ëª¨ë“  íŒŒì¼ ì¶”ê°€ (.md íŒŒì¼ í¬í•¨)
    archive.directory(extensionPath, false);

    // ZIP ìƒì„± ì™„ë£Œ
    archive.finalize();

    console.log('âœ… [í™•ì¥ë‹¤ìš´ë¡œë“œ] ZIP ìƒì„± ì™„ë£Œ ë° ì „ì†¡ ì‹œì‘');

  } catch (error) {
    console.error('âŒ [í™•ì¥ë‹¤ìš´ë¡œë“œ] ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨:', error);
    res.status(500).json({
      success: false,
      error: 'Chrome í™•ì¥ í”„ë¡œê·¸ë¨ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
      message: error.message
    });
  }
});

// ì„œë²„ ì‹œì‘
const server = app.listen(port, '0.0.0.0', async () => {
  try {
    console.log(`ğŸš€ ì„œë²„ê°€ í¬íŠ¸ ${port}ì—ì„œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤`);
    console.log(`ğŸ”‘ VAPID Public Key: ${vapidKeys.publicKey}`);
    console.log(`ğŸ“… ì„œë²„ ì‹œì‘ ì‹œê°„: ${new Date().toISOString()}`);
    console.log(`ğŸŒ ì„œë²„ í™˜ê²½: ${process.env.NODE_ENV || 'development'}`);
    console.log(`ğŸ’¾ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰: ${Math.round(process.memoryUsage().heapUsed / 1024 / 1024)}MB`);

    // í™˜ê²½ë³€ìˆ˜ ë””ë²„ê¹… (ë¯¼ê°í•œ ì •ë³´ëŠ” ë¡œê¹…í•˜ì§€ ì•ŠìŒ)
    console.log('ğŸ”§ [ì„œë²„ì‹œì‘] í™˜ê²½ë³€ìˆ˜ ìƒíƒœ í™•ì¸:');
    console.log('- GOOGLE_SHEET_ID ì„¤ì •ë¨:', !!process.env.GOOGLE_SHEET_ID);
    console.log('- SHEET_ID ì„¤ì •ë¨:', !!process.env.SHEET_ID);
    console.log('- SALES_SHEET_ID ì„¤ì •ë¨:', !!process.env.SALES_SHEET_ID);

    const spreadsheetId = process.env.GOOGLE_SHEET_ID || process.env.SHEET_ID;
    console.log('- ìµœì¢… ì‚¬ìš©í•  Spreadsheet ID ì„¤ì •ë¨:', !!spreadsheetId);

    if (spreadsheetId) {
      console.log('- Spreadsheet ID ê¸¸ì´:', spreadsheetId.length);
      console.log('- Spreadsheet ID ì‹œì‘:', spreadsheetId.substring(0, 10) + '...');
    }
    if (process.env.SALES_SHEET_ID) {
      console.log('- SALES_SHEET_ID ê¸¸ì´:', process.env.SALES_SHEET_ID.length);
      console.log('- SALES_SHEET_ID ì‹œì‘:', process.env.SALES_SHEET_ID.substring(0, 10) + '...');
    }
    console.log('ğŸ¤– Discord ë´‡ í™˜ê²½ë³€ìˆ˜ ìƒíƒœ:');
    console.log('- DISCORD_BOT_TOKEN ì„¤ì •ë¨:', !!process.env.DISCORD_BOT_TOKEN);
    console.log('- DISCORD_CHANNEL_ID ì„¤ì •ë¨:', !!process.env.DISCORD_CHANNEL_ID);
    console.log('- DISCORD_AGENT_CHANNEL_ID ì„¤ì •ë¨:', !!process.env.DISCORD_AGENT_CHANNEL_ID);
    console.log('- DISCORD_STORE_CHANNEL_ID ì„¤ì •ë¨:', !!process.env.DISCORD_STORE_CHANNEL_ID);
    console.log('- DISCORD_LOGGING_ENABLED ì„¤ì •ë¨:', process.env.DISCORD_LOGGING_ENABLED);

    // ë¬´ë£Œ Geocoding ì„œë¹„ìŠ¤ ìƒíƒœ
    // console.log('ë¬´ë£Œ Geocoding ì„œë¹„ìŠ¤ ìƒíƒœ:');
    // console.log('- Photon API (Komoot): ì‚¬ìš© ê°€ëŠ¥ (ë¬´ë£Œ)');
    // console.log('- Nominatim API (OpenStreetMap): ì‚¬ìš© ê°€ëŠ¥ (ë¬´ë£Œ)');
    // console.log('- Pelias API (Mapzen): ì‚¬ìš© ê°€ëŠ¥ (ë¬´ë£Œ)');
    // console.log('- ì´ 3ê°œ ë¬´ë£Œ ì„œë¹„ìŠ¤ë¡œ ì •í™•ë„ í–¥ìƒ');

    // ë´‡ ë¡œê·¸ì¸ (ì„œë²„ ì‹œì‘ í›„)
    if (DISCORD_LOGGING_ENABLED && DISCORD_BOT_TOKEN && discordBot) {
      // console.log('ì„œë²„ ì‹œì‘ í›„ Discord ë´‡ ë¡œê·¸ì¸ ì‹œë„...');
      try {
        await discordBot.login(DISCORD_BOT_TOKEN);
        // console.log('Discord ë´‡ ì—°ê²° ì„±ê³µ!');

        // ê´€ë¦¬ì ì±„ë„ ì—°ê²° í…ŒìŠ¤íŠ¸
        if (DISCORD_AGENT_CHANNEL_ID) {
          try {
            const agentChannel = await discordBot.channels.fetch(DISCORD_AGENT_CHANNEL_ID);
            if (agentChannel) {
              // console.log(`ê´€ë¦¬ì ì±„ë„ '${agentChannel.name}' ì—°ê²° ì„±ê³µ!`);
            }
          } catch (agentChannelError) {
            console.error('ê´€ë¦¬ì ì±„ë„ ì—°ê²° ì‹¤íŒ¨:', agentChannelError.message);
          }
        }

        // ì¼ë°˜ ë§¤ì¥ ì±„ë„ ì—°ê²° í…ŒìŠ¤íŠ¸
        if (DISCORD_STORE_CHANNEL_ID) {
          try {
            const storeChannel = await discordBot.channels.fetch(DISCORD_STORE_CHANNEL_ID);
            if (storeChannel) {
              // console.log(`ì¼ë°˜ ë§¤ì¥ ì±„ë„ '${storeChannel.name}' ì—°ê²° ì„±ê³µ!`);
            }
          } catch (storeChannelError) {
            console.error('ì¼ë°˜ ë§¤ì¥ ì±„ë„ ì—°ê²° ì‹¤íŒ¨:', storeChannelError.message);
          }
        }

        // í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡ (ê¸°ë³¸ ì±„ë„)
        if (DISCORD_CHANNEL_ID) {
          const channel = await discordBot.channels.fetch(DISCORD_CHANNEL_ID);
          if (channel) {
            // console.log(`ì±„ë„ '${channel.name}' ì—°ê²° ì„±ê³µ!`);

            // í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡
            const testEmbed = new EmbedBuilder()
              .setTitle('ì„œë²„ ì‹œì‘ ì•Œë¦¼')
              .setColor(5763719)
              .setDescription('ì„œë²„ê°€ ì„±ê³µì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.')
              .setTimestamp()
              .setFooter({ text: '(ì£¼)ë¸Œì´ì•„ì´í”¼í”ŒëŸ¬ìŠ¤ ì„œë²„' });

            await channel.send({ embeds: [testEmbed] });
            // console.log('ì„œë²„ ì‹œì‘ ì•Œë¦¼ ë©”ì‹œì§€ ì „ì†¡ë¨');
          }
        }
      } catch (error) {
        console.error('ì„œë²„ ì‹œì‘ ì‹œ Discord ë´‡ ì´ˆê¸°í™” ì˜¤ë¥˜:', error.message);
        console.error('Discord ë´‡ì€ ë¹„í™œì„±í™” ìƒíƒœë¡œ ì„œë²„ê°€ ê³„ì† ì‹¤í–‰ë©ë‹ˆë‹¤.');
      }
    } else {
      // console.log('Discord ë´‡ ê¸°ëŠ¥ì´ ë¹„í™œì„±í™”ë˜ì—ˆê±°ë‚˜ ì„¤ì •ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
    }

    // ===== ìë™ ìŠ¤ì¼€ì¤„ ê¸°ëŠ¥ ì´ˆê¸°í™” =====
    console.log('â° [ìŠ¤ì¼€ì¤„ëŸ¬] ìë™ ìŠ¤ì¼€ì¤„ ê¸°ëŠ¥ ì´ˆê¸°í™” ì‹œì‘...');
    
    // Discord ëª¨ë‹ˆí„°ë§ ìë™ ê°±ì‹  í•¨ìˆ˜
    async function refreshAllDiscordImages() {
      try {
        console.log('ğŸ”„ [ìŠ¤ì¼€ì¤„ëŸ¬] Discord ì´ë¯¸ì§€ ìë™ ê°±ì‹  ì‹œì‘...');
        
        // ëª¨ë‹ˆí„°ë§ ë°ì´í„° ì§ì ‘ ì¡°íšŒ (ë‚´ë¶€ í•¨ìˆ˜ í˜¸ì¶œ)
        const sheets = originalSheets;
        const monitoringData = {
          direct: {
            mobileImages: [],
            masterImages: [],
            storePhotos: []
          }
        };
        
        try {
          // ì§ì˜ì _ëª¨ë¸ì´ë¯¸ì§€ ì¡°íšŒ
          const { HEADERS_MOBILE_IMAGES } = require('./directRoutes');
          const { ensureSheetHeaders } = require('./directRoutes');
          await ensureSheetHeaders(sheets, SPREADSHEET_ID, 'ì§ì˜ì _ëª¨ë¸ì´ë¯¸ì§€', HEADERS_MOBILE_IMAGES);
          
          const imageResponse = await rateLimitedSheetsCall(() =>
            sheets.spreadsheets.values.get({
              spreadsheetId: SPREADSHEET_ID,
              range: 'ì§ì˜ì _ëª¨ë¸ì´ë¯¸ì§€!A:K'
            })
          );
          
          const imageRows = (imageResponse.data.values || []).slice(1);
          
          monitoringData.direct.mobileImages = imageRows
            .filter(row => {
              const messageId = (row[8] || '').trim();
              const threadId = (row[10] || '').trim();
              // Discord snowflake í˜•ì‹ ê²€ì¦ ì¶”ê°€
              return messageId && threadId && isValidSnowflake(messageId) && isValidSnowflake(threadId);
            })
            .map(row => ({
              carrier: (row[0] || '').trim(),
              modelId: (row[1] || '').trim(),
              modelName: (row[2] || '').trim(),
              petName: (row[3] || '').trim(),
              imageUrl: (row[5] || '').trim(),
              messageId: (row[8] || '').trim(),
              postId: (row[9] || '').trim(),
              threadId: (row[10] || '').trim()
            }));
          
          // ì§ì˜ì _ë‹¨ë§ë§ˆìŠ¤í„° ì¡°íšŒ
          const { HEADERS_MOBILE_MASTER } = require('./directRoutes');
          await ensureSheetHeaders(sheets, SPREADSHEET_ID, 'ì§ì˜ì _ë‹¨ë§ë§ˆìŠ¤í„°', HEADERS_MOBILE_MASTER);
          
          const masterResponse = await rateLimitedSheetsCall(() =>
            sheets.spreadsheets.values.get({
              spreadsheetId: SPREADSHEET_ID,
              range: 'ì§ì˜ì _ë‹¨ë§ë§ˆìŠ¤í„°!A:R'
            })
          );
          
          const masterRows = (masterResponse.data.values || []).slice(1);
          
          monitoringData.direct.masterImages = masterRows
            .filter(row => {
              const messageId = (row[15] || '').trim();
              const threadId = (row[17] || '').trim();
              // Discord snowflake í˜•ì‹ ê²€ì¦ ì¶”ê°€
              return messageId && threadId && isValidSnowflake(messageId) && isValidSnowflake(threadId);
            })
            .map(row => ({
              carrier: (row[0] || '').trim(),
              modelId: (row[1] || '').trim(),
              modelName: (row[2] || '').trim(),
              petName: (row[3] || '').trim(),
              imageUrl: (row[12] || '').trim(),
              messageId: (row[15] || '').trim(),
              postId: (row[16] || '').trim(),
              threadId: (row[17] || '').trim()
            }));
          
          // ì§ì˜ì _ë§¤ì¥ì‚¬ì§„ ì¡°íšŒ
          const { ensureSheetHeaders: ensureHeaders } = require('./directRoutes');
          await ensureHeaders(sheets, SPREADSHEET_ID, CUSTOMER_STORE_PHOTO_SHEET_NAME, HEADERS_STORE_PHOTO);
          
          const storePhotoResponse = await rateLimitedSheetsCall(() =>
            sheets.spreadsheets.values.get({
              spreadsheetId: SPREADSHEET_ID,
              range: `${CUSTOMER_STORE_PHOTO_SHEET_NAME}!A:AH`
            })
          );
          
          const storePhotoRows = (storePhotoResponse.data.values || []).slice(1);
          const photoTypes = ['front', 'inside', 'outside', 'outside2', 'manager', 'staff1', 'staff2', 'staff3'];
          const photoTypeMap = {
            front: { url: 1, msgId: 2, postId: 3, threadId: 4 },
            inside: { url: 5, msgId: 6, postId: 7, threadId: 8 },
            outside: { url: 9, msgId: 10, postId: 11, threadId: 12 },
            outside2: { url: 13, msgId: 14, postId: 15, threadId: 16 },
            manager: { url: 17, msgId: 18, postId: 19, threadId: 20 },
            staff1: { url: 21, msgId: 22, postId: 23, threadId: 24 },
            staff2: { url: 25, msgId: 26, postId: 27, threadId: 28 },
            staff3: { url: 29, msgId: 30, postId: 31, threadId: 32 }
          };
          
          storePhotoRows.forEach(row => {
            const storeName = (row[0] || '').trim();
            photoTypes.forEach(photoType => {
              const map = photoTypeMap[photoType];
              const messageId = (row[map.msgId] || '').trim();
              const threadId = (row[map.threadId] || '').trim();
              if (messageId && threadId) {
                monitoringData.direct.storePhotos.push({
                  storeName,
                  photoType,
                  imageUrl: (row[map.url] || '').trim(),
                  messageId,
                  postId: (row[map.postId] || '').trim(),
                  threadId
                });
              }
            });
          });
        } catch (err) {
          console.error('âŒ [ìŠ¤ì¼€ì¤„ëŸ¬] ëª¨ë‹ˆí„°ë§ ë°ì´í„° ì¡°íšŒ ì˜¤ë¥˜:', err);
          return;
        }
        
        // ëª¨ë“  ì´ë¯¸ì§€ í•­ëª© ìˆ˜ì§‘
        const allItems = [
          ...monitoringData.direct.mobileImages.map(item => ({ type: 'mobile-image', ...item })),
          ...monitoringData.direct.masterImages.map(item => ({ type: 'master-image', ...item })),
          ...monitoringData.direct.storePhotos.map(item => ({ type: 'store-photo', ...item }))
        ];
        
        if (allItems.length === 0) {
          console.log('â„¹ï¸ [ìŠ¤ì¼€ì¤„ëŸ¬] ê°±ì‹ í•  Discord ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }
        
        // ìŠ¤ë§ˆíŠ¸ ê°±ì‹ : ë§Œë£Œëœ URLë§Œ í•„í„°ë§
        console.log(`ğŸ” [ìŠ¤ì¼€ì¤„ëŸ¬] ${allItems.length}ê°œ ì´ë¯¸ì§€ URL ìœ íš¨ì„± ê²€ì¦ ì¤‘...`);
        const itemsToValidate = allItems.filter(item => item.imageUrl);
        const validationResults = await Promise.all(
          itemsToValidate.map(async (item) => {
            const validation = await validateImageUrl(item.imageUrl);
            return { ...item, urlValid: validation.valid, urlStatus: validation.status };
          })
        );
        
        // ë§Œë£Œë˜ì—ˆê±°ë‚˜ ì˜¤ë¥˜ê°€ ìˆëŠ” í•­ëª©ë§Œ ê°±ì‹ 
        const expiredItems = validationResults.filter(item => 
          !item.urlValid || item.urlStatus === 'expired' || item.urlStatus === 'error' || item.urlStatus === 'timeout'
        );
        
        if (expiredItems.length === 0) {
          console.log('âœ… [ìŠ¤ì¼€ì¤„ëŸ¬] ëª¨ë“  Discord ì´ë¯¸ì§€ URLì´ ì •ìƒì…ë‹ˆë‹¤. ê°±ì‹ í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }
        
        console.log(`ğŸ”„ [ìŠ¤ì¼€ì¤„ëŸ¬] ${expiredItems.length}ê°œ ë§Œë£Œ/ì˜¤ë¥˜ ì´ë¯¸ì§€ ê°±ì‹  ì‹œì‘ (ì „ì²´ ${allItems.length}ê°œ ì¤‘)...`);
        
        // ë°°ì¹˜ ê°±ì‹  ì‹¤í–‰ (ì¬ì‚¬ìš© ê°€ëŠ¥í•œ í•¨ìˆ˜ í˜¸ì¶œ)
        const results = await processBatchRefreshItems(expiredItems);
        
        const successCount = results.filter(r => r.success).length;
        const failCount = results.length - successCount;
        console.log(`âœ… [ìŠ¤ì¼€ì¤„ëŸ¬] Discord ì´ë¯¸ì§€ ìë™ ê°±ì‹  ì™„ë£Œ: ì„±ê³µ ${successCount}ê°œ, ì‹¤íŒ¨ ${failCount}ê°œ`);
      } catch (error) {
        console.error('âŒ [ìŠ¤ì¼€ì¤„ëŸ¬] Discord ì´ë¯¸ì§€ ìë™ ê°±ì‹  ì˜¤ë¥˜:', error);
      }
    }
    
    // ì¬ì‹œë„ í—¬í¼ í•¨ìˆ˜ (ì§€ìˆ˜ ë°±ì˜¤í”„)
    async function retryWithBackoff(fn, maxRetries = 3, baseDelayMs = 1000) {
      let lastError;
      for (let attempt = 0; attempt < maxRetries; attempt++) {
        try {
          return await fn();
        } catch (error) {
          lastError = error;
          if (attempt < maxRetries - 1) {
            const delayMs = baseDelayMs * Math.pow(2, attempt);
            console.warn(`âš ï¸ [ì¬ì‹œë„] ì‹œë„ ${attempt + 1}/${maxRetries} ì‹¤íŒ¨, ${delayMs}ms í›„ ì¬ì‹œë„... (ì˜¤ë¥˜: ${error.message})`);
            await new Promise(resolve => setTimeout(resolve, delayMs));
          }
        }
      }
      throw lastError;
    }
    
    // ë°ì´í„° ì¬ë¹Œë“œ ì‹¤í–‰ ìƒíƒœ ê´€ë¦¬
    let isRebuilding = false;
    let rebuildStartTime = null;
    const MAX_REBUILD_DURATION_MS = 30 * 60 * 1000; // 30ë¶„ ìµœëŒ€ ì‹¤í–‰ ì‹œê°„
    
    // ë°ì´í„° ì¬ë¹Œë“œ í•¨ìˆ˜
    async function rebuildMasterData() {
      // ì´ë¯¸ ì¬ë¹Œë“œê°€ ì§„í–‰ ì¤‘ì´ë©´ ê±´ë„ˆë›°ê¸°
      if (isRebuilding) {
        const elapsed = rebuildStartTime ? Date.now() - rebuildStartTime : 0;
        if (elapsed > MAX_REBUILD_DURATION_MS) {
          console.warn('âš ï¸ [ìŠ¤ì¼€ì¤„ëŸ¬] ì¬ë¹Œë“œê°€ ìµœëŒ€ ì‹¤í–‰ ì‹œê°„ì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ê°•ì œ ì¢…ë£Œí•©ë‹ˆë‹¤.');
          isRebuilding = false;
          rebuildStartTime = null;
        } else {
          console.log(`âš ï¸ [ìŠ¤ì¼€ì¤„ëŸ¬] ì´ë¯¸ ì¬ë¹Œë“œê°€ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. (ê²½ê³¼ ì‹œê°„: ${Math.floor(elapsed / 1000)}ì´ˆ) ê±´ë„ˆëœë‹ˆë‹¤.`);
          return;
        }
      }
      
      isRebuilding = true;
      rebuildStartTime = Date.now();
      const startTime = Date.now();
      
      try {
        console.log('ğŸ”„ [ìŠ¤ì¼€ì¤„ëŸ¬] ë°ì´í„° ì¬ë¹Œë“œ ì‹œì‘...');
        
        const { rebuildPlanMaster, rebuildDeviceMaster, rebuildPricingMaster, invalidateDirectStoreCache } = require('./directRoutes');
        const carriers = ['SK', 'KT', 'LG'];
        
        // 1. ìš”ê¸ˆì œ ë§ˆìŠ¤í„° ë¦¬ë¹Œë“œ (ì¬ì‹œë„ í¬í•¨)
        console.log(`[ìŠ¤ì¼€ì¤„ëŸ¬] Rebuilding Plan Master for ${carriers.join(',')}`);
        const planResult = await retryWithBackoff(
          () => rebuildPlanMaster(carriers),
          3,
          2000
        );
        console.log(`[ìŠ¤ì¼€ì¤„ëŸ¬] Plan Master ì™„ë£Œ: ${planResult?.totalCount || 0}ê°œ`);
        
        // 2. ë‹¨ë§ ë§ˆìŠ¤í„° ë¦¬ë¹Œë“œ (ì¬ì‹œë„ í¬í•¨)
        console.log(`[ìŠ¤ì¼€ì¤„ëŸ¬] Rebuilding Device Master for ${carriers.join(',')}`);
        const deviceResult = await retryWithBackoff(
          () => rebuildDeviceMaster(carriers),
          3,
          2000
        );
        console.log(`[ìŠ¤ì¼€ì¤„ëŸ¬] Device Master ì™„ë£Œ: ${deviceResult?.totalCount || 0}ê°œ`);
        
        // 3. ë‹¨ë§ ìš”ê¸ˆì •ì±… ë¦¬ë¹Œë“œ (ì¬ì‹œë„ í¬í•¨)
        console.log(`[ìŠ¤ì¼€ì¤„ëŸ¬] Rebuilding Pricing Master for ${carriers.join(',')}`);
        const pricingResult = await retryWithBackoff(
          () => rebuildPricingMaster(carriers),
          3,
          2000
        );
        console.log(`[ìŠ¤ì¼€ì¤„ëŸ¬] Pricing Master ì™„ë£Œ: ${pricingResult?.totalCount || 0}ê°œ`);
        
        // 4. ì¬ë¹Œë“œ ì™„ë£Œ í›„ ëª¨ë“  ê´€ë ¨ ìºì‹œ ë¬´íš¨í™”
        console.log(`[ìŠ¤ì¼€ì¤„ëŸ¬] Invalidating all related caches after rebuild`);
        if (typeof invalidateDirectStoreCache === 'function') {
          invalidateDirectStoreCache();
        }
        
        const elapsed = Date.now() - startTime;
        console.log(`âœ… [ìŠ¤ì¼€ì¤„ëŸ¬] ë°ì´í„° ì¬ë¹Œë“œ ì™„ë£Œ (ì†Œìš” ì‹œê°„: ${Math.floor(elapsed / 1000)}ì´ˆ)`);
      } catch (error) {
        const elapsed = Date.now() - startTime;
        console.error(`âŒ [ìŠ¤ì¼€ì¤„ëŸ¬] ë°ì´í„° ì¬ë¹Œë“œ ì˜¤ë¥˜ (ì†Œìš” ì‹œê°„: ${Math.floor(elapsed / 1000)}ì´ˆ):`, error);
        console.error(`âŒ [ìŠ¤ì¼€ì¤„ëŸ¬] ì¬ì‹œë„ í›„ì—ë„ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ìŠ¤ì¼€ì¤„ì—ì„œ ë‹¤ì‹œ ì‹œë„í•©ë‹ˆë‹¤.`);
        // ì—ëŸ¬ê°€ ë°œìƒí•´ë„ ë‹¤ìŒ ìŠ¤ì¼€ì¤„ì„ ìœ„í•´ í”Œë˜ê·¸ í•´ì œ
      } finally {
        isRebuilding = false;
        rebuildStartTime = null;
      }
    }
    
    // ì„œë²„ ì‹œì‘ ì‹œ ì‹¤í–‰
    console.log('ğŸš€ [ìŠ¤ì¼€ì¤„ëŸ¬] ì„œë²„ ì‹œì‘ ì‹œ ìë™ ì‹¤í–‰ ì‹œì‘...');
    
    // ë°ì´í„° ì¬ë¹Œë“œ (ì„œë²„ ì‹œì‘ ì‹œ 1íšŒ) - ë¨¼ì € ì‹¤í–‰í•˜ì—¬ ë°ì´í„° ì¤€ë¹„
    setTimeout(async () => {
      console.log('ğŸ”„ [ìŠ¤ì¼€ì¤„ëŸ¬] ì„œë²„ ì‹œì‘ ì‹œ ë°ì´í„° ì¬ë¹Œë“œ ì‹¤í–‰');
      await rebuildMasterData();
    }, 300000); // 5ë¶„ í›„ ì‹¤í–‰ (ì„œë²„ ì´ˆê¸°í™” ë° ë‹¤ë¥¸ ì‘ì—… ì™„ë£Œ ëŒ€ê¸°)
    
    // Discord ëª¨ë‹ˆí„°ë§ ìë™ ê°±ì‹  (ì„œë²„ ì‹œì‘ ì‹œ 1íšŒ)
    // ë°ì´í„° ì¬ë¹Œë“œ ì™„ë£Œ í›„ ì‹¤í–‰í•˜ì—¬ ì •ìƒì ì¸ Discord IDë¡œ ê°±ì‹ 
    setTimeout(async () => {
      console.log('ğŸ”„ [ìŠ¤ì¼€ì¤„ëŸ¬] ì„œë²„ ì‹œì‘ ì‹œ Discord ì´ë¯¸ì§€ ìë™ ê°±ì‹  ì‹¤í–‰');
      await refreshAllDiscordImages();
    }, 600000); // 10ë¶„ í›„ ì‹¤í–‰ (ë°ì´í„° ì¬ë¹Œë“œ ì™„ë£Œ í›„ ì¶©ë¶„í•œ ì‹œê°„ ëŒ€ê¸°)
    
    // Discord ëª¨ë‹ˆí„°ë§ ìë™ ê°±ì‹  ìŠ¤ì¼€ì¤„ ë“±ë¡
    // ë§¤ì¼ 11:30, 17:30
    cron.schedule('30 11 * * *', async () => {
      console.log('â° [ìŠ¤ì¼€ì¤„ëŸ¬] ì •ê¸° ìŠ¤ì¼€ì¤„ ì‹¤í–‰: Discord ì´ë¯¸ì§€ ìë™ ê°±ì‹  (11:30)');
      await refreshAllDiscordImages();
    }, {
      scheduled: true,
      timezone: 'Asia/Seoul'
    });
    
    cron.schedule('30 17 * * *', async () => {
      console.log('â° [ìŠ¤ì¼€ì¤„ëŸ¬] ì •ê¸° ìŠ¤ì¼€ì¤„ ì‹¤í–‰: Discord ì´ë¯¸ì§€ ìë™ ê°±ì‹  (17:30)');
      await refreshAllDiscordImages();
    }, {
      scheduled: true,
      timezone: 'Asia/Seoul'
    });
    
    // ë°ì´í„° ì¬ë¹Œë“œ ìŠ¤ì¼€ì¤„ ë“±ë¡
    // ë§¤ì¼ 11:00-19:00 ë§¤ì‹œê°„ 10ë¶„ (11:10, 12:10, 13:10, ..., 19:10)
    for (let hour = 11; hour <= 19; hour++) {
      cron.schedule(`10 ${hour} * * *`, async () => {
        console.log(`â° [ìŠ¤ì¼€ì¤„ëŸ¬] ì •ê¸° ìŠ¤ì¼€ì¤„ ì‹¤í–‰: ë°ì´í„° ì¬ë¹Œë“œ (${hour}:10)`);
        await rebuildMasterData();
      }, {
        scheduled: true,
        timezone: 'Asia/Seoul'
      });
    }
    
    console.log('âœ… [ìŠ¤ì¼€ì¤„ëŸ¬] ìë™ ìŠ¤ì¼€ì¤„ ê¸°ëŠ¥ ì´ˆê¸°í™” ì™„ë£Œ');
    console.log('   - Discord ì´ë¯¸ì§€ ìë™ ê°±ì‹ : ì„œë²„ ì‹œì‘ ì‹œ, ë§¤ì¼ 11:30, 17:30');
    console.log('   - ë°ì´í„° ì¬ë¹Œë“œ: ì„œë²„ ì‹œì‘ ì‹œ, ë§¤ì¼ 11:10-19:10 ë§¤ì‹œê°„');
    // ===== ìë™ ìŠ¤ì¼€ì¤„ ê¸°ëŠ¥ ì´ˆê¸°í™” ì™„ë£Œ =====

    // ì£¼ì†Œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ í˜¸ì¶œ (ë¹„ë™ê¸°ë¡œ ì²˜ë¦¬í•˜ì—¬ ë°°ì • ë¡œì§ì„ ë°©í•´í•˜ì§€ ì•Šë„ë¡)
    console.log('ğŸ” [ì„œë²„ì‹œì‘] ì£¼ì†Œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ì‹œì‘ (ë¹„ë™ê¸° ì²˜ë¦¬)');
    checkAndUpdateAddresses().then(() => {
      console.log('âœ… [ì„œë²„ì‹œì‘] ì£¼ì†Œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ì™„ë£Œ');
    }).catch(error => {
      console.error('âŒ [ì„œë²„ì‹œì‘] ì£¼ì†Œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ì‹¤íŒ¨:', error.message);
    });

    // SALES_SHEET_ID ì£¼ì†Œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ í˜¸ì¶œ (ë¹„ë™ê¸°ë¡œ ì²˜ë¦¬)
    console.log('ğŸ” [ì„œë²„ì‹œì‘] SALES_SHEET_ID ì£¼ì†Œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ì‹œì‘ (ë¹„ë™ê¸° ì²˜ë¦¬)');
    checkAndUpdateSalesAddresses().then(() => {

    }).catch(error => {
      console.error('âŒ [ì„œë²„ì‹œì‘] SALES_SHEET_ID ì£¼ì†Œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ì‹¤íŒ¨:', error.message);
    });

    // ì˜ì—… ë°ì´í„° ë¯¸ë¦¬ ë¡œë“œ (ë¹„ë™ê¸°ë¡œ ì²˜ë¦¬)
    console.log('ğŸ” [ì„œë²„ì‹œì‘] ì˜ì—… ë°ì´í„° ë¯¸ë¦¬ ë¡œë“œ ì‹œì‘ (ë¹„ë™ê¸° ì²˜ë¦¬)');
    preloadSalesData().then(() => {

    }).catch(error => {
      console.error('âŒ [ì„œë²„ì‹œì‘] ì˜ì—… ë°ì´í„° ë¯¸ë¦¬ ë¡œë“œ ì‹¤íŒ¨:', error.message);
    });

    // ë§¤ ì‹œê°„ë§ˆë‹¤ ì—…ë°ì´íŠ¸ ì²´í¬ ì‹¤í–‰ (3600000ms = 1ì‹œê°„)
    setInterval(checkAndUpdateAddresses, 3600000);

    // Git ì»¤ë°‹ íˆìŠ¤í† ë¦¬ë¥¼ êµ¬ê¸€ì‹œíŠ¸ì— ìë™ ì…ë ¥
    console.log('ğŸ” [ì„œë²„ì‹œì‘] Git íˆìŠ¤í† ë¦¬ ì—…ë°ì´íŠ¸ ì‹œì‘');
    try {
      await updateGoogleSheetWithGitHistory();

    } catch (error) {
      console.error('âŒ [ì„œë²„ì‹œì‘] Git íˆìŠ¤í† ë¦¬ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error.message);
    }

    // í‘¸ì‹œ êµ¬ë… ì •ë³´ ì´ˆê¸°í™”
    console.log('ğŸ” [ì„œë²„ì‹œì‘] í‘¸ì‹œ êµ¬ë… ì´ˆê¸°í™” ì‹œì‘');
    try {
      await initializePushSubscriptions();

    } catch (error) {
      console.error('âŒ [ì„œë²„ì‹œì‘] í‘¸ì‹œ êµ¬ë… ì´ˆê¸°í™” ì‹¤íŒ¨:', error.message);
    }

    // SMS ì‹œíŠ¸ í—¤ë” ì´ˆê¸°í™” (ì„œë²„ ì‹œì‘ ì‹œ í•œ ë²ˆë§Œ ì‹¤í–‰)
    console.log('ğŸ“± [ì„œë²„ì‹œì‘] SMS ì‹œíŠ¸ í—¤ë” ì´ˆê¸°í™” ì‹œì‘');
    try {
      await ensureSmsSheetHeaders();
      console.log('âœ… [ì„œë²„ì‹œì‘] SMS ì‹œíŠ¸ í—¤ë” ì´ˆê¸°í™” ì™„ë£Œ');
    } catch (error) {
      console.error('âŒ [ì„œë²„ì‹œì‘] SMS ì‹œíŠ¸ í—¤ë” ì´ˆê¸°í™” ì‹¤íŒ¨:', error.message);
    }

    // SMS ìë™ì‘ë‹µ ì‹œíŠ¸ í—¤ë” ì´ˆê¸°í™” (ì„œë²„ ì‹œì‘ ì‹œ í•œ ë²ˆë§Œ ì‹¤í–‰)
    console.log('ğŸ¤– [ì„œë²„ì‹œì‘] SMS ìë™ì‘ë‹µ ì‹œíŠ¸ í—¤ë” ì´ˆê¸°í™” ì‹œì‘');
    try {
      await ensureAutoReplySheetHeaders();
      console.log('âœ… [ì„œë²„ì‹œì‘] SMS ìë™ì‘ë‹µ ì‹œíŠ¸ í—¤ë” ì´ˆê¸°í™” ì™„ë£Œ');
    } catch (error) {
      console.error('âŒ [ì„œë²„ì‹œì‘] SMS ìë™ì‘ë‹µ ì‹œíŠ¸ í—¤ë” ì´ˆê¸°í™” ì‹¤íŒ¨:', error.message);
    }

    // ì„œë²„ ì‹œì‘ ì‹œ ë°°ì •ì™„ë£Œëœ ì¬ê³  ìë™ ì €ì¥ ë° ì¤‘ë³µ ì •ë¦¬ (ì§€ì—° ë¡œë”©ìœ¼ë¡œ ì„±ëŠ¥ ìµœì í™”)
    console.log('ğŸ’¾ [ì„œë²„ì‹œì‘] ë°°ì •ì™„ë£Œëœ ì¬ê³  ìë™ ì €ì¥ ë° ì¤‘ë³µ ì •ë¦¬ ì‹œì‘ (ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰)');

    // ë°±ê·¸ë¼ìš´ë“œì—ì„œ ë°ì´í„° ë¡œë“œ (ì„œë²„ ì‹œì‘ ì§€ì—° ë°©ì§€, Rate Limit ê³ ë ¤í•˜ì—¬ ì¶©ë¶„í•œ ì§€ì—°)
    // ìŠ¤ì¼€ì¤„ëŸ¬ ì‘ì—…ë“¤ê³¼ ì¶©ëŒí•˜ì§€ ì•Šë„ë¡ 6ë¶„ í›„ ì‹¤í–‰
    setTimeout(async () => {
      try {
        console.log('ğŸ” [ì„œë²„ì‹œì‘] 1ë‹¨ê³„: ì‹œíŠ¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹œì‘ (ë°±ê·¸ë¼ìš´ë“œ)');

        // í°í´ì¬ê³ ë°ì´í„°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë°°ì • ìƒíƒœ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const phoneklInventoryValues = await getSheetValues('í°í´ì¬ê³ ë°ì´í„°');
        console.log(`ğŸ” [ì„œë²„ì‹œì‘] í°í´ì¬ê³ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${phoneklInventoryValues ? phoneklInventoryValues.length : 0}ê°œ í–‰`);

        const reservationSiteValues = await getSheetValues('ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸');
        // ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ë¡œë“œ ì™„ë£Œ

        // 1ë‹¨ê³„: ë¨¼ì € ê°œí†µì™„ë£Œ ìƒíƒœ í™•ì¸ ë° Fì—´ ì—…ë°ì´íŠ¸ (ë¹„ë™ê¸° ì²˜ë¦¬)
        console.log('ğŸ“‹ [ì„œë²„ì‹œì‘] 1-1ë‹¨ê³„: ê°œí†µì™„ë£Œ ìƒíƒœ í™•ì¸ ì‹œì‘ (ë¹„ë™ê¸°)');
        fetch(`${process.env.REACT_APP_API_URL || 'http://localhost:4000'}/api/inventory/activation-status`)
          .then(async (activationResponse) => {
            if (activationResponse.ok) {
              const activationResult = await activationResponse.json();
              if (activationResult.success) {

              } else {
                console.error('âŒ [ì„œë²„ì‹œì‘] ê°œí†µì™„ë£Œ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', activationResult.error);
              }
            } else {
              console.error('âŒ [ì„œë²„ì‹œì‘] ê°œí†µì™„ë£Œ ìƒíƒœ í™•ì¸ API í˜¸ì¶œ ì‹¤íŒ¨:', activationResponse.status);
            }
          })
          .catch(error => {
            console.error('âŒ [ì„œë²„ì‹œì‘] ê°œí†µì™„ë£Œ ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error.message);
          });

        // í°í´ì¶œê³ ì²˜ë°ì´í„° ë¡œë“œ (POSì  ë§¤í•‘ìš©)
        const phoneklStoreValues = await getSheetValues('í°í´ì¶œê³ ì²˜ë°ì´í„°');
        console.log(`ğŸ” [ì„œë²„ì‹œì‘] í°í´ì¶œê³ ì²˜ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${phoneklStoreValues ? phoneklStoreValues.length : 0}ê°œ í–‰`);

        // ì •ê·œí™” ê·œì¹™ ë¡œë“œ
        const normalizationValues = await getSheetValues('ì •ê·œí™”ì‘ì—…');
        console.log(`ğŸ” [ì„œë²„ì‹œì‘] ì •ê·œí™”ì‘ì—… ë¡œë“œ ì™„ë£Œ: ${normalizationValues ? normalizationValues.length : 0}ê°œ í–‰`);

        // ì •ê·œí™” ê·œì¹™ ìƒì„±
        const normalizationRules = new Map();
        if (normalizationValues && normalizationValues.length > 1) {
          normalizationValues.slice(1).forEach(row => {
            if (row.length >= 4) {
              const reservationSite = (row[1] || '').toString().trim(); // Bì—´: ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ í˜•ì‹
              const phoneklFormat = (row[2] || '').toString().trim(); // Cì—´: í°í´í˜•ì‹
              const combinedFormat = (row[3] || '').toString().trim(); // Dì—´: ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸&í°í´í˜•ì‹

              if (reservationSite && phoneklFormat) {
                // ì •ê·œí™” ê·œì¹™ì˜ í‚¤ë¥¼ ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ í˜•ì‹ìœ¼ë¡œ ìƒì„± (íŒŒì´í”„ ì œê±°)
                const key = reservationSite.replace(/\s*\|\s*/g, ' ').trim();
                normalizationRules.set(key, { phoneklFormat });
              }
            }
          });
          console.log(`ğŸ”§ [ì„œë²„ì‹œì‘] ì •ê·œí™” ê·œì¹™ ë¡œë“œ ì™„ë£Œ: ${normalizationRules.size}ê°œ ê·œì¹™`);
        }

        if (!phoneklInventoryValues || !reservationSiteValues) {
          throw new Error('ì‹œíŠ¸ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }

        // í°í´ì¶œê³ ì²˜ë°ì´í„°ì—ì„œ ì¶œê³ ì²˜ë³„ Pì½”ë“œ ë§¤í•‘ ìƒì„±
        const storeToPosCodeMap = new Map();
        if (phoneklStoreValues && phoneklStoreValues.length > 1) {
          phoneklStoreValues.slice(1).forEach(row => {
            if (row.length >= 8) {
              const storeName = (row[6] || '').toString().trim(); // Gì—´: ì¶œê³ ì²˜ëª…
              const posCode = (row[7] || '').toString().trim(); // Hì—´: Pì½”ë“œ

              if (storeName && posCode) {
                storeToPosCodeMap.set(storeName, posCode);
              }
            }
          });
          console.log(`ğŸ”§ [ì„œë²„ì‹œì‘] ì¶œê³ ì²˜-Pì½”ë“œ ë§¤í•‘ ìƒì„± ì™„ë£Œ: ${storeToPosCodeMap.size}ê°œ`);
        }

        // í°í´ì¬ê³ ë°ì´í„° ì²˜ë¦¬ (ë°°ì •ì™„ë£Œëœ ì¬ê³ ë§Œ - Nì—´ ì¶œê³ ì²˜ì— ê°’ì´ ìˆëŠ” ì¬ê³ )
        const inventoryMap = new Map(); // ëª¨ë¸ë³„ ì¼ë ¨ë²ˆí˜¸ ë°°ì—´ ì €ì¥
        phoneklInventoryValues.slice(1).forEach(row => {
          if (row.length >= 22) {
            const serialNumber = (row[11] || '').toString().trim(); // Dì—´: ì¼ë ¨ë²ˆí˜¸ (3+8)
            const modelCapacity = (row[13] || '').toString().trim(); // Fì—´: ëª¨ë¸ëª…&ìš©ëŸ‰ (5+8)
            const color = (row[14] || '').toString().trim(); // Gì—´: ìƒ‰ìƒ (6+8)
            const storeName = (row[21] || '').toString().trim(); // Nì—´: ì¶œê³ ì²˜ (13+8)

            // Nì—´ ì¶œê³ ì²˜ê°€ ë¹„ì–´ìˆëŠ” ì¬ê³ ë§Œ ì‚¬ìš© ê°€ëŠ¥í•œ ì¬ê³ ë¡œ ê°„ì£¼ (ì•„ì§ ë°°ì •ë˜ì§€ ì•Šì€ ì¬ê³ )
            if (serialNumber && modelCapacity && color && (!storeName || storeName.trim() === '')) {
              const inventoryKey = `${modelCapacity} | ${color}`;

              // ê°™ì€ ëª¨ë¸ì˜ ì¬ê³ ë¥¼ ë°°ì—´ë¡œ ì €ì¥
              if (!inventoryMap.has(inventoryKey)) {
                inventoryMap.set(inventoryKey, []);
              }
              inventoryMap.get(inventoryKey).push(serialNumber);
            }
          }
        });

        console.log(`ğŸ’¾ [ì„œë²„ì‹œì‘] ì¬ê³  ë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ: ${inventoryMap.size}ê°œ ë°°ì •ì™„ë£Œ ì¬ê³ `);
        console.log(`ğŸ” [ì„œë²„ì‹œì‘] ì¬ê³  ë°ì´í„° ìƒ˜í”Œ:`, Array.from(inventoryMap.entries()).slice(0, 5));

        // ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ë°ì´í„°ì™€ ë§¤ì¹­
        const assignments = [];
        let updatedCount = 0;
        let skippedCount = 0;
        let noMatchCount = 0;

        // ì„œë²„ ì‹œì‘ ì‹œ ì¤‘ë³µ ë°°ì • ìë™ ì •ë¦¬
        console.log('ğŸ§¹ [ì„œë²„ì‹œì‘] ì¤‘ë³µ ë°°ì • ë°ì´í„° ìë™ ì •ë¦¬ ì‹œì‘');
        const serialToReservations = new Map(); // ì¼ë ¨ë²ˆí˜¸ë³„ ì˜ˆì•½ë²ˆí˜¸ ë§¤í•‘

        // ê¸°ì¡´ ë°°ì • ë°ì´í„° ìˆ˜ì§‘ (ê°œí†µì™„ë£Œ ê³ ê° ì œì™¸ - ì¼ë ¨ë²ˆí˜¸ë¥¼ ë‹¤ë¥¸ ê³ ê°ì—ê²Œ ë°°ì •í•˜ê¸° ìœ„í•´)
        reservationSiteValues.slice(1).forEach((row, index) => {
          if (row.length < 22) return;

          const reservationNumber = (row[8] || '').toString().trim(); // Iì—´: ì˜ˆì•½ë²ˆí˜¸
          const existingSerial = (row[6] || '').toString().trim(); // Gì—´: ê¸°ì¡´ ë°°ì •ì¼ë ¨ë²ˆí˜¸
          const activationStatus = (row[5] || '').toString().trim(); // Fì—´: ê°œí†µìƒíƒœ

          // ê°œí†µì™„ë£Œëœ ê³ ê°ì€ ì¤‘ë³µ ì •ë¦¬ì—ì„œ ì œì™¸ (ì¼ë ¨ë²ˆí˜¸ë¥¼ ë‹¤ë¥¸ ê³ ê°ì—ê²Œ ë°°ì •í•˜ê¸° ìœ„í•´)
          if (existingSerial && existingSerial.trim() !== '' && activationStatus !== 'ê°œí†µì™„ë£Œ') {
            if (!serialToReservations.has(existingSerial)) {
              serialToReservations.set(existingSerial, []);
            }
            serialToReservations.get(existingSerial).push({
              reservationNumber,
              rowIndex: index + 1,
              row: row
            });
          }
        });

        // ì¤‘ë³µ ë°°ì •ëœ ì¼ë ¨ë²ˆí˜¸ë“¤ ì •ë¦¬
        let cleanedCount = 0;
        for (const [serialNumber, reservations] of serialToReservations.entries()) {
          if (reservations.length > 1) {
            console.log(`âš ï¸ [ì„œë²„ì‹œì‘] ì¼ë ¨ë²ˆí˜¸ ${serialNumber}ì— ${reservations.length}ê°œ ê³ ê° ë°°ì •ë¨: ${reservations.map(r => r.reservationNumber).join(', ')}`);

            // ìš°ì„ ìˆœìœ„ì— ë”°ë¼ ì²« ë²ˆì§¸ ê³ ê°ë§Œ ë‚¨ê¸°ê³  ë‚˜ë¨¸ì§€ëŠ” ë°°ì • í•´ì œ
            const sortedReservations = reservations.sort((a, b) => {
              // ì˜ˆì•½ë²ˆí˜¸ ìˆœì„œë¡œ ì •ë ¬ (ê³ ìœ ë¬¸ì)
              return a.reservationNumber.localeCompare(b.reservationNumber);
            });

            // ì²« ë²ˆì§¸ ê³ ê°ë§Œ ìœ ì§€í•˜ê³  ë‚˜ë¨¸ì§€ëŠ” ë°°ì • í•´ì œ
            for (let i = 1; i < sortedReservations.length; i++) {
              const reservationToRemove = sortedReservations[i];
              reservationToRemove.row[6] = ''; // Gì—´ ë°°ì • í•´ì œ
              cleanedCount++;
              console.log(`ğŸ§¹ [ì„œë²„ì‹œì‘] ë°°ì • í•´ì œ: ${reservationToRemove.reservationNumber} (ì¼ë ¨ë²ˆí˜¸: ${serialNumber})`);
            }
          }
        }



        // ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ë°ì´í„° ì²˜ë¦¬ ì‹œì‘

        // 1ë‹¨ê³„: ëª¨ë“  ê³ ê°ì— ëŒ€í•´ ê°œí†µì™„ë£Œ ì²´í¬ (í•„ìˆ˜ ë°ì´í„° ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´)
        reservationSiteValues.slice(1).forEach((row, index) => {
          if (row.length < 22) {
            console.log(`âš ï¸ [ì„œë²„ì‹œì‘] í–‰ ${index + 2}: ì»¬ëŸ¼ ìˆ˜ ë¶€ì¡± (${row.length})`);
            return;
          }

          const reservationNumber = (row[8] || '').toString().trim(); // Iì—´: ì˜ˆì•½ë²ˆí˜¸
          const activationStatus = (row[5] || '').toString().trim(); // Fì—´: ê°œí†µìƒíƒœ

          // ê°œí†µì™„ë£Œëœ ê³ ê°ì€ ìƒˆë¡œìš´ ë°°ì •ì—ì„œë§Œ ì œì™¸ (ê¸°ì¡´ ì¼ë ¨ë²ˆí˜¸ëŠ” ìœ ì§€)
          if (activationStatus === 'ê°œí†µì™„ë£Œ') {
            if (index < 5) {
              console.log(`âš ï¸ [ì„œë²„ì‹œì‘] í–‰ ${index + 2}: ê°œí†µì™„ë£Œ ê³ ê° ë°°ì • ê±´ë„ˆëœ€: ${reservationNumber}`);
            }
            skippedCount++;
            return; // ìƒˆë¡œìš´ ë°°ì •ë§Œ ê±´ë„ˆëœ€, ê¸°ì¡´ ì¼ë ¨ë²ˆí˜¸ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€
          }
        });

        // 2ë‹¨ê³„: í•„ìˆ˜ ë°ì´í„°ê°€ ìˆëŠ” ê³ ê°ë“¤ì— ëŒ€í•´ ë°°ì • ë¡œì§ ì‹¤í–‰
        reservationSiteValues.slice(1).forEach((row, index) => {
          if (row.length < 22) {
            console.log(`âš ï¸ [ì„œë²„ì‹œì‘] í–‰ ${index + 2}: ì»¬ëŸ¼ ìˆ˜ ë¶€ì¡± (${row.length})`);
            return;
          }

          const reservationNumber = (row[8] || '').toString().trim(); // Iì—´: ì˜ˆì•½ë²ˆí˜¸
          const customerName = (row[7] || '').toString().trim(); // Hì—´: ê³ ê°ëª…
          const model = (row[15] || '').toString().trim(); // Pì—´: ëª¨ë¸ëª…
          const capacity = (row[16] || '').toString().trim(); // Qì—´: ìš©ëŸ‰
          const color = (row[17] || '').toString().trim(); // Rì—´: ìƒ‰ìƒ
          const posCode = (row[21] || '').toString().trim(); // Vì—´: POSì½”ë“œ
          const currentSerialNumber = (row[6] || '').toString().trim(); // Gì—´: ë°°ì •ì¼ë ¨ë²ˆí˜¸
          const activationStatus = (row[5] || '').toString().trim(); // Fì—´: ê°œí†µìƒíƒœ

          // ê°œí†µì™„ë£Œëœ ê³ ê°ì€ ìƒˆë¡œìš´ ë°°ì •ì—ì„œë§Œ ì œì™¸ (ê¸°ì¡´ ì¼ë ¨ë²ˆí˜¸ëŠ” ìœ ì§€)
          if (activationStatus === 'ê°œí†µì™„ë£Œ') {
            if (index < 5) {
              console.log(`âš ï¸ [ì„œë²„ì‹œì‘] í–‰ ${index + 2}: ê°œí†µì™„ë£Œ ê³ ê° ë°°ì • ê±´ë„ˆëœ€: ${reservationNumber}`);
            }
            skippedCount++;
            return; // ìƒˆë¡œìš´ ë°°ì •ë§Œ ê±´ë„ˆëœ€, ê¸°ì¡´ ì¼ë ¨ë²ˆí˜¸ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€
          }

          if (reservationNumber && customerName && model && color && capacity && posCode) {
            // ì •ê·œí™” ê·œì¹™ ì ìš©
            const originalKey = `${model} ${capacity} ${color}`;
            let normalizedKey = originalKey;

            // ì •ê·œí™” ê·œì¹™ì—ì„œ ë§¤ì¹­ë˜ëŠ” í‚¤ ì°¾ê¸°
            for (const [ruleKey, ruleValue] of normalizationRules.entries()) {
              if (originalKey.includes(ruleKey) || ruleKey.includes(originalKey)) {
                normalizedKey = ruleValue.phoneklFormat;
                if (index < 5) {
                  console.log(`ğŸ”§ [ì„œë²„ì‹œì‘] ì •ê·œí™” ì ìš©: "${originalKey}" â†’ "${normalizedKey}"`);
                }
                break;
              }
            }

            const inventoryKey = normalizedKey;

            // ì²˜ìŒ 5ê°œ í–‰ì€ ìƒì„¸ ë¡œê·¸
            if (index < 5) {
              console.log(`ğŸ” [ì„œë²„ì‹œì‘] í–‰ ${index + 2}: ì˜ˆì•½ë²ˆí˜¸="${reservationNumber}", ëª¨ë¸="${model} ${capacity} ${color}", í˜„ì¬ì¼ë ¨ë²ˆí˜¸="${currentSerialNumber}"`);
            }

            // POSì½”ë“œì— í•´ë‹¹í•˜ëŠ” ì¶œê³ ì²˜ ì°¾ê¸°
            let targetStoreName = null;
            for (const [storeName, storePosCode] of storeToPosCodeMap.entries()) {
              if (storePosCode === posCode) {
                targetStoreName = storeName;
                break;
              }
            }

            if (!targetStoreName) {
              noMatchCount++;
              if (index < 5) {
                console.log(`âŒ [ì„œë²„ì‹œì‘] í–‰ ${index + 2}: POSì½”ë“œ "${posCode}"ì— í•´ë‹¹í•˜ëŠ” ì¶œê³ ì²˜ ì—†ìŒ`);
              }
              return;
            }

            // í•´ë‹¹ ì¶œê³ ì²˜ì— ë°°ì •ëœ ì¬ê³  ì°¾ê¸°
            const availableSerials = [];
            phoneklInventoryValues.slice(1).forEach(inventoryRow => {
              if (inventoryRow.length >= 15) {
                const inventorySerialNumber = (inventoryRow[11] || '').toString().trim(); // Dì—´: ì¼ë ¨ë²ˆí˜¸ (3+8)
                const inventoryModelCapacity = (inventoryRow[13] || '').toString().trim(); // Fì—´: ëª¨ë¸ëª…&ìš©ëŸ‰ (5+8)
                const inventoryColor = (inventoryRow[14] || '').toString().trim(); // Gì—´: ìƒ‰ìƒ (6+8)
                const inventoryStoreName = (inventoryRow[21] || '').toString().trim(); // Nì—´: ì¶œê³ ì²˜ (13+8)

                // í•´ë‹¹ ì¶œê³ ì²˜ì— ë°°ì •ëœ ì¬ê³ ì´ê³ , ëª¨ë¸ì´ ì¼ì¹˜í•˜ëŠ” ê²½ìš°
                if (inventorySerialNumber && inventoryModelCapacity && inventoryColor &&
                  inventoryStoreName === targetStoreName &&
                  `${inventoryModelCapacity} | ${inventoryColor}` === inventoryKey) {
                  availableSerials.push(inventorySerialNumber);
                }
              }
            });

            if (availableSerials.length > 0) {
              // ê¸°ì¡´ ë°°ì • ìƒíƒœ í™•ì¸
              const existingAssignment = assignmentMemory.get(reservationNumber);

              // ì‚¬ìš© ê°€ëŠ¥í•œ ì¼ë ¨ë²ˆí˜¸ ì¤‘ì—ì„œ ì¤‘ë³µë˜ì§€ ì•ŠëŠ” ê²ƒì„ ì°¾ê¸°
              let assignedSerialNumber = null;

              for (const serial of availableSerials) {
                // ì´ë¯¸ ë°°ì •ëœ ì¼ë ¨ë²ˆí˜¸ê°€ ìˆê³ , í˜„ì¬ì™€ ë‹¤ë¥¸ ê²½ìš°ì—ë§Œ ì—…ë°ì´íŠ¸
                if (currentSerialNumber !== serial) {
                  // ê¸°ì¡´ì— ë°°ì •ëœ ì ì´ ì—†ê±°ë‚˜, ë‹¤ë¥¸ ì¼ë ¨ë²ˆí˜¸ë¡œ ë°°ì •ëœ ê²½ìš°ì—ë§Œ ì—…ë°ì´íŠ¸
                  if (!existingAssignment || existingAssignment.serialNumber !== serial) {
                    // ì¤‘ë³µ ë°°ì • ì²´í¬: ê°™ì€ ì¼ë ¨ë²ˆí˜¸ê°€ ì´ë¯¸ ë‹¤ë¥¸ ê³ ê°ì—ê²Œ ë°°ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸
                    let isDuplicate = false;
                    for (let i = 0; i < index; i++) {
                      const prevRow = reservationSiteValues[i + 1];
                      if (prevRow && prevRow.length >= 22) {
                        const prevSerial = (prevRow[6] || '').toString().trim();
                        if (prevSerial === serial) {
                          isDuplicate = true;
                          break;
                        }
                      }
                    }

                    if (!isDuplicate) {
                      assignedSerialNumber = serial;
                      break; // ì‚¬ìš© ê°€ëŠ¥í•œ ì¼ë ¨ë²ˆí˜¸ë¥¼ ì°¾ì•˜ìœ¼ë¯€ë¡œ ë£¨í”„ ì¢…ë£Œ
                    }
                  }
                }
              }

              if (assignedSerialNumber) {
                row[6] = assignedSerialNumber; // Gì—´ ì—…ë°ì´íŠ¸
                updatedCount++;

                if (index < 5) {

                }

                assignments.push({
                  reservationNumber,
                  assignedSerialNumber
                });
              } else {
                noMatchCount++;
                if (index < 5) {
                  console.log(`âŒ [ì„œë²„ì‹œì‘] í–‰ ${index + 2}: ì‚¬ìš© ê°€ëŠ¥í•œ ì¼ë ¨ë²ˆí˜¸ ì—†ìŒ "${inventoryKey}"`);
                }
              }
            } else {
              noMatchCount++;
              if (index < 5) {
                console.log(`âŒ [ì„œë²„ì‹œì‘] í–‰ ${index + 2}: ì¬ê³  ë§¤ì¹­ ì‹¤íŒ¨ "${inventoryKey}"`);
              }
            }
          } else {
            if (index < 5) {
              console.log(`âš ï¸ [ì„œë²„ì‹œì‘] í–‰ ${index + 2}: í•„ìˆ˜ ë°ì´í„° ëˆ„ë½ - ì˜ˆì•½ë²ˆí˜¸:${!!reservationNumber}, ê³ ê°ëª…:${!!customerName}, ëª¨ë¸:${!!model}, ìš©ëŸ‰:${!!capacity}, ìƒ‰ìƒ:${!!color}`);
            }
          }
        });

        console.log(`ğŸ“Š [ì„œë²„ì‹œì‘] ë§¤ì¹­ ê²°ê³¼: ì—…ë°ì´íŠ¸=${updatedCount}, ìœ ì§€=${skippedCount}, ë§¤ì¹­ì‹¤íŒ¨=${noMatchCount}`);

        // ê¸°ì¡´ ë°°ì • ìƒíƒœë¥¼ ë©”ëª¨ë¦¬ì— ë¡œë“œ
        console.log(`ğŸ’¾ [ì„œë²„ì‹œì‘] ê¸°ì¡´ ë°°ì • ìƒíƒœ ë©”ëª¨ë¦¬ ë¡œë“œ ì‹œì‘`);
        reservationSiteValues.slice(1).forEach((row, index) => {
          if (row.length >= 22) {
            const reservationNumber = (row[8] || '').toString().trim(); // Iì—´: ì˜ˆì•½ë²ˆí˜¸
            const currentSerialNumber = (row[6] || '').toString().trim(); // Gì—´: ë°°ì •ì¼ë ¨ë²ˆí˜¸

            if (reservationNumber && currentSerialNumber) {
              assignmentMemory.set(reservationNumber, {
                serialNumber: currentSerialNumber,
                timestamp: Date.now()
              });
            }
          }
        });
        console.log(`ğŸ’¾ [ì„œë²„ì‹œì‘] ê¸°ì¡´ ë°°ì • ìƒíƒœ ${assignmentMemory.size}ê°œ ë©”ëª¨ë¦¬ ë¡œë“œ ì™„ë£Œ`);

        // Google Sheetsì— ì €ì¥
        if (updatedCount > 0) {
          try {
            const sheets = google.sheets({ version: 'v4', auth });
            const spreadsheetId = process.env.GOOGLE_SHEET_ID || process.env.SHEET_ID;

            // spreadsheetId ê²€ì¦
            if (!spreadsheetId) {
              throw new Error('GOOGLE_SHEET_ID ë˜ëŠ” SHEET_ID í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            }

            console.log(`ğŸ”§ [ì„œë²„ì‹œì‘] Google Sheets ì—…ë°ì´íŠ¸ ì‹œì‘ - Spreadsheet ID: ${spreadsheetId.substring(0, 10)}...`);

            // Gì—´ë§Œ ì—…ë°ì´íŠ¸ (ë°°ì •ì¼ë ¨ë²ˆí˜¸)
            const range = 'ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸!G2:G' + (reservationSiteValues.length);
            const values = reservationSiteValues.slice(1).map(row => [row[6] || '']); // Gì—´ ë°ì´í„°ë§Œ ì¶”ì¶œ

            await sheets.spreadsheets.values.update({
              spreadsheetId,
              range,
              valueInputOption: 'RAW',
              resource: { values }
            });


          } catch (error) {
            console.error('âŒ [ì„œë²„ì‹œì‘] Google Sheets ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error.message);
            console.error('âŒ [ì„œë²„ì‹œì‘] í™˜ê²½ë³€ìˆ˜ í™•ì¸ í•„ìš”: GOOGLE_SHEET_ID');
          }
        }

        console.log(`ğŸ“ˆ [ì„œë²„ì‹œì‘] ë°°ì •ì™„ë£Œ ì¬ê³  ìë™ ì €ì¥ ì™„ë£Œ: ${updatedCount}ê°œ ì €ì¥, ${skippedCount}ê°œ ìœ ì§€, ${cleanedCount}ê°œ ì¤‘ë³µì •ë¦¬`);

        // ì£¼ê¸°ì  ìƒíƒœ ë¡œê·¸ (5ë¶„ë§ˆë‹¤)
        setInterval(() => {
          const memoryUsage = process.memoryUsage();
          const uptime = Math.floor(process.uptime());
          console.log(`ğŸ“Š [ìƒíƒœì²´í¬] ì„œë²„ ê°€ë™ì‹œê°„: ${uptime}ì´ˆ, ë©”ëª¨ë¦¬: ${Math.round(memoryUsage.heapUsed / 1024 / 1024)}MB`);
        }, 5 * 60 * 1000); // 5ë¶„ë§ˆë‹¤

        // ì‹¤ì œ ì‹œíŠ¸ ë°ì´í„°ì™€ ë¹„êµ ë¶„ì„
        console.log('ğŸ” [ì„œë²„ì‹œì‘] ì‹¤ì œ ì‹œíŠ¸ ë°ì´í„°ì™€ ë°°ì • ìƒíƒœ ë¹„êµ ë¶„ì„ ì‹œì‘');

        // ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ì—ì„œ ì‹¤ì œë¡œ ì¼ë ¨ë²ˆí˜¸ê°€ ì…ë ¥ëœ ê³ ê°ë“¤ ìˆ˜ì§‘
        const actualAssignedCustomers = [];
        reservationSiteValues.slice(1).forEach(row => {
          if (row.length >= 22) {
            const reservationNumber = (row[8] || '').toString().trim(); // Iì—´: ì˜ˆì•½ë²ˆí˜¸
            const customerName = (row[7] || '').toString().trim(); // Hì—´: ê³ ê°ëª…
            const assignedSerialNumber = (row[6] || '').toString().trim(); // Gì—´: ë°°ì •ì¼ë ¨ë²ˆí˜¸

            if (reservationNumber && customerName && assignedSerialNumber) {
              actualAssignedCustomers.push({
                reservationNumber,
                customerName,
                assignedSerialNumber
              });
            }
          }
        });

        console.log(`ğŸ“Š [ì„œë²„ì‹œì‘] ì‹¤ì œ ì‹œíŠ¸ì— ì¼ë ¨ë²ˆí˜¸ê°€ ì…ë ¥ëœ ê³ ê°: ${actualAssignedCustomers.length}ê°œ`);

        // ì¬ê³ ê´€ë¦¬ì—ì„œ ë°°ì •ì™„ë£Œë¡œ í‘œì‹œëœ ì¬ê³ ë“¤
        const inventoryAssignedCount = inventoryMap.size;
        console.log(`ğŸ“Š [ì„œë²„ì‹œì‘] ì¬ê³ ê´€ë¦¬ì—ì„œ ë°°ì •ì™„ë£Œë¡œ í‘œì‹œëœ ì¬ê³ : ${inventoryAssignedCount}ê°œ`);

        // ì°¨ì´ì  ë¶„ì„
        const difference = actualAssignedCustomers.length - inventoryAssignedCount;
        console.log(`ğŸ“Š [ì„œë²„ì‹œì‘] ì°¨ì´ì : ${difference > 0 ? '+' : ''}${difference}ê°œ`);

        if (difference !== 0) {
          console.log('âš ï¸ [ì„œë²„ì‹œì‘] ë¶ˆì¼ì¹˜ ë°œê²¬! ìƒì„¸ ë¶„ì„:');

          // ì‹¤ì œ ì‹œíŠ¸ì— ìˆì§€ë§Œ ì¬ê³ ê´€ë¦¬ì— ì—†ëŠ” ì¼ë ¨ë²ˆí˜¸ë“¤
          const actualSerialNumbers = new Set(actualAssignedCustomers.map(c => c.assignedSerialNumber));
          const inventorySerialNumbers = new Set(inventoryMap.values());

          const onlyInSheet = [...actualSerialNumbers].filter(sn => !inventorySerialNumbers.has(sn));
          const onlyInInventory = [...inventorySerialNumbers].filter(sn => !actualSerialNumbers.has(sn));

          console.log(`  - ì‹œíŠ¸ì—ë§Œ ìˆëŠ” ì¼ë ¨ë²ˆí˜¸: ${onlyInSheet.length}ê°œ`);
          if (onlyInSheet.length > 0) {
            console.log(`    ìƒ˜í”Œ: ${onlyInSheet.slice(0, 5).join(', ')}`);
          }

          console.log(`  - ì¬ê³ ê´€ë¦¬ì—ë§Œ ìˆëŠ” ì¼ë ¨ë²ˆí˜¸: ${onlyInInventory.length}ê°œ`);
          if (onlyInInventory.length > 0) {
            console.log(`    ìƒ˜í”Œ: ${onlyInInventory.slice(0, 5).join(', ')}`);
          }
        }

      } catch (error) {
        console.error('âŒ [ì„œë²„ì‹œì‘] ë°°ì •ì™„ë£Œ ì¬ê³  ìë™ ì €ì¥ ì˜¤ë¥˜:', error);
        console.error('âŒ [ì„œë²„ì‹œì‘] ì˜¤ë¥˜ ìƒì„¸:', error.message);
        console.error('âŒ [ì„œë²„ì‹œì‘] ì˜¤ë¥˜ ìŠ¤íƒ:', error.stack);
      }
    }, 360000); // 6ë¶„ í›„ ì‹¤í–‰ (ìŠ¤ì¼€ì¤„ëŸ¬ ì‘ì—…ë“¤ê³¼ ì¶©ëŒ ë°©ì§€, Rate Limit ê³ ë ¤)

  } catch (error) {
    console.error('ì„œë²„ ì‹œì‘ ì¤‘ ì˜¤ë¥˜:', error);
  }
}).on('error', (error) => {
  console.error('ì„œë²„ ì‹œì‘ ì‹¤íŒ¨:', error);
  process.exit(1);
});

// ì •ìƒì ì¸ ì¢…ë£Œ ì²˜ë¦¬
process.on('SIGTERM', async () => {
  // console.log('Received SIGTERM signal. Shutting down gracefully...');

  // Discordì— ì„œë²„ ì¢…ë£Œ ì•Œë¦¼ ì „ì†¡
  if (DISCORD_LOGGING_ENABLED && discordBot) {
    try {
      // ë´‡ ì¤€ë¹„ ìƒíƒœ í™•ì¸
      if (!discordBot.isReady()) {
        // console.log('Discord ë´‡ì´ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. 5ì´ˆ ëŒ€ê¸° í›„ ì¬ì‹œë„...');
        await new Promise(resolve => setTimeout(resolve, 5000)); // 5ì´ˆ ëŒ€ê¸°
      }

      if (discordBot.isReady()) {
        // ê¸°ë³¸ ì±„ë„ì— ì•Œë¦¼ ì „ì†¡
        if (DISCORD_CHANNEL_ID) {
          try {
            const channel = await discordBot.channels.fetch(DISCORD_CHANNEL_ID);
            if (channel) {
              const shutdownEmbed = new EmbedBuilder()
                .setTitle('âš ï¸ ì„œë²„ ì¢…ë£Œ ì•Œë¦¼')
                .setColor(15548997) // ë¹¨ê°„ìƒ‰
                .setDescription('@everyone\nì„œë²„ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì„œë¹„ìŠ¤ ì´ìš©ì´ ë¶ˆê°€ëŠ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.')
                .setTimestamp()
                .setFooter({ text: '(ì£¼)ë¸Œì´ì•„ì´í”¼í”ŒëŸ¬ìŠ¤ ì„œë²„ ì•Œë¦¼' });

              // console.log('ì¢…ë£Œ ì•Œë¦¼ ì „ì†¡ ì‹œë„ ì¤‘...');
              const sentMessage = await channel.send({ content: '@everyone', embeds: [shutdownEmbed] });
              // console.log(`ì„œë²„ ì¢…ë£Œ ì•Œë¦¼ ë©”ì‹œì§€ê°€ Discordë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤. ë©”ì‹œì§€ ID: ${sentMessage.id}`);
            }
          } catch (error) {
            console.error('Discord ì±„ë„ ì ‘ê·¼ ë˜ëŠ” ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:', error);
          }
        }
      } else {
        console.log('Discord ë´‡ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•„ ì¢…ë£Œ ì•Œë¦¼ì„ ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      }
    } catch (error) {
      console.error('Discord ì¢…ë£Œ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨:', error);
    }

    // Discord ë´‡ ì—°ê²° ì¢…ë£Œë¥¼ ê¸°ë‹¤ë¦¼ (ë©”ì‹œì§€ ì „ì†¡ì— ì¶©ë¶„í•œ ì‹œê°„)
    console.log('Discord ë©”ì‹œì§€ ì „ì†¡ ëŒ€ê¸° ì¤‘... (3ì´ˆ)');
    await new Promise(resolve => setTimeout(resolve, 3000));
    console.log('ëŒ€ê¸° ì™„ë£Œ, ì„œë²„ ì¢…ë£Œ ì§„í–‰');
  }

  server.close(() => {
    console.log('Server closed');
    // ì¼ì • ì‹œê°„ í›„ ê°•ì œ ì¢…ë£Œ (ë©”ì‹œì§€ê°€ ì „ì†¡ë˜ì§€ ì•Šë”ë¼ë„)
    setTimeout(() => {
      console.log('ê°•ì œ ì¢…ë£Œ');
      process.exit(0);
    }, 1000);
  });
});

// SIGINT ì²˜ë¦¬ (Ctrl+C)
process.on('SIGINT', async () => {
  // console.log('Received SIGINT signal (Ctrl+C). Shutting down gracefully...');

  // Discordì— ì„œë²„ ì¢…ë£Œ ì•Œë¦¼ ì „ì†¡
  if (DISCORD_LOGGING_ENABLED && discordBot) {
    try {
      // ë´‡ ì¤€ë¹„ ìƒíƒœ í™•ì¸
      if (!discordBot.isReady()) {
        // console.log('Discord ë´‡ì´ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. 5ì´ˆ ëŒ€ê¸° í›„ ì¬ì‹œë„...');
        await new Promise(resolve => setTimeout(resolve, 5000)); // 5ì´ˆ ëŒ€ê¸°
      }

      if (discordBot.isReady()) {
        // ê¸°ë³¸ ì±„ë„ì— ì•Œë¦¼ ì „ì†¡
        if (DISCORD_CHANNEL_ID) {
          try {
            const channel = await discordBot.channels.fetch(DISCORD_CHANNEL_ID);
            if (channel) {
              const shutdownEmbed = new EmbedBuilder()
                .setTitle('âš ï¸ ì„œë²„ ì¢…ë£Œ ì•Œë¦¼')
                .setColor(15548997) // ë¹¨ê°„ìƒ‰
                .setDescription('@everyone\nì„œë²„ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì„œë¹„ìŠ¤ ì´ìš©ì´ ë¶ˆê°€ëŠ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.')
                .setTimestamp()
                .setFooter({ text: '(ì£¼)ë¸Œì´ì•„ì´í”¼í”ŒëŸ¬ìŠ¤ ì„œë²„ ì•Œë¦¼' });

              console.log('ì¢…ë£Œ ì•Œë¦¼ ì „ì†¡ ì‹œë„ ì¤‘...');
              const sentMessage = await channel.send({ content: '@everyone', embeds: [shutdownEmbed] });
              console.log(`ì„œë²„ ì¢…ë£Œ ì•Œë¦¼ ë©”ì‹œì§€ê°€ Discordë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤. ë©”ì‹œì§€ ID: ${sentMessage.id}`);
            }
          } catch (error) {
            console.error('Discord ì±„ë„ ì ‘ê·¼ ë˜ëŠ” ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:', error);
          }
        }
      } else {
        console.log('Discord ë´‡ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•„ ì¢…ë£Œ ì•Œë¦¼ì„ ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      }
    } catch (error) {
      console.error('Discord ì¢…ë£Œ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨:', error);
    }

    // Discord ë´‡ ì—°ê²° ì¢…ë£Œë¥¼ ê¸°ë‹¤ë¦¼ (ë©”ì‹œì§€ ì „ì†¡ì— ì¶©ë¶„í•œ ì‹œê°„)
    console.log('Discord ë©”ì‹œì§€ ì „ì†¡ ëŒ€ê¸° ì¤‘... (3ì´ˆ)');
    await new Promise(resolve => setTimeout(resolve, 3000));
    console.log('ëŒ€ê¸° ì™„ë£Œ, ì„œë²„ ì¢…ë£Œ ì§„í–‰');
  }

  server.close(() => {
    console.log('Server closed');
    // ì¼ì • ì‹œê°„ í›„ ê°•ì œ ì¢…ë£Œ (ë©”ì‹œì§€ê°€ ì „ì†¡ë˜ì§€ ì•Šë”ë¼ë„)
    setTimeout(() => {
      console.log('ê°•ì œ ì¢…ë£Œ');
      process.exit(0);
    }, 1000);
  });
});

// ë°°ì •ê´€ë¦¬ ê´€ë ¨ API
app.get('/api/assignment/history', async (req, res) => {
  try {
    // ë°°ì • íˆìŠ¤í† ë¦¬ ë°ì´í„° (ì„ì‹œë¡œ í•˜ë“œì½”ë”©ëœ ë°ì´í„° ë°˜í™˜)
    const assignments = [
      {
        id: 1,
        assigner: 'ê²½ìˆ˜',
        model: 'iPhone 15 Pro',
        color: 'ë¸”ë™',
        quantity: 50,
        target_office: 'ê²½ì¸ì‚¬ë¬´ì†Œ',
        target_department: 'ì˜ì—…1íŒ€',
        target_agent: 'ê¹€ì˜ì—…',
        assigned_at: new Date('2024-01-15T10:30:00'),
        status: 'completed'
      },
      {
        id: 2,
        assigner: 'í™ê¸°í˜„',
        model: 'Galaxy S24',
        color: 'í™”ì´íŠ¸',
        quantity: 30,
        target_office: 'í˜¸ë‚¨ì‚¬ë¬´ì†Œ',
        target_department: 'ì˜ì—…2íŒ€',
        target_agent: 'ì´ì˜ì—…',
        assigned_at: new Date('2024-01-15T09:15:00'),
        status: 'completed'
      }
    ];

    res.json({ success: true, assignments });
  } catch (error) {
    console.error('ë°°ì • íˆìŠ¤í† ë¦¬ ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({ success: false, error: 'ë°°ì • íˆìŠ¤í† ë¦¬ ì¡°íšŒ ì‹¤íŒ¨' });
  }
});

app.post('/api/assignment/complete', async (req, res) => {
  // console.log('=== ë°°ì • ì™„ë£Œ API í˜¸ì¶œë¨ ===');
  // console.log('ìš”ì²­ ë³¸ë¬¸:', JSON.stringify(req.body, null, 2));

  try {
    const {
      assigner,
      model,
      color,
      quantity,
      target_office,
      target_department,
      target_agent,
      target_offices,
      target_departments,
      target_agents
    } = req.body;

    // ì‹¤ì œ ë°°ì •ëœ ìˆ˜ëŸ‰ ê³„ì‚° (quantityê°€ 0ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ)
    const actualQuantity = parseInt(quantity) || 0;

    // ë°°ì • ì •ë³´ ì €ì¥ (ì‹¤ì œë¡œëŠ” ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥)
    const assignment = {
      id: Date.now(),
      assigner,
      model,
      color,
      quantity: actualQuantity,
      target_office,
      target_department,
      target_agent,
      assigned_at: new Date(),
      status: 'completed'
    };

    // console.log('ìƒˆë¡œìš´ ë°°ì • ì™„ë£Œ:', assignment);
    // console.log('ë°°ì • ëŒ€ìƒì:', { target_offices, target_departments, target_agents });

    // ë°°ì • ëŒ€ìƒìì—ê²Œë§Œ ì•Œë¦¼ ì „ì†¡ (ì‹¤ì œ ë°°ì •ëœ ìˆ˜ëŸ‰ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ)
    if (actualQuantity > 0) {
      const notification = {
        type: 'assignment_completed',
        title: 'ìƒˆë¡œìš´ ë°°ì • ì™„ë£Œ',
        message: `${assigner}ë‹˜ì´ ${model} (${color}) ${actualQuantity}ëŒ€ë¥¼ ë°°ì •í–ˆìŠµë‹ˆë‹¤.`,
        data: assignment,
        timestamp: new Date()
      };

      // console.log('ì•Œë¦¼ ì „ì†¡ ì‹œì‘:', {
      //   notification,
      //   targetOffices: target_offices,
      //   targetDepartments: target_departments,
      //   targetAgents: target_agents
      // });

      // ëŒ€ìƒì í•„í„°ë§í•˜ì—¬ ì•Œë¦¼ ì „ì†¡
      await sendNotificationToTargetAgents(notification, target_offices, target_departments, target_agents);
    } else {
      // console.log('ë°°ì •ëœ ìˆ˜ëŸ‰ì´ 0ì´ë¯€ë¡œ ì•Œë¦¼ì„ ì „ì†¡í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    }

    res.json({ success: true, assignment });
  } catch (error) {
    console.error('ë°°ì • ì™„ë£Œ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
    res.status(500).json({ success: false, error: 'ë°°ì • ì™„ë£Œ ì²˜ë¦¬ ì‹¤íŒ¨' });
  }
});

// ì•Œë¦¼ ê´€ë ¨ API
app.get('/api/notifications', async (req, res) => {
  try {
    const { user_id } = req.query;

    // ì‹¤ì œ ì•Œë¦¼ ë°ì´í„°ëŠ” ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì¡°íšŒ (í˜„ì¬ëŠ” ë¹ˆ ë°°ì—´)
    const notifications = [];

    res.json({ success: true, notifications });
  } catch (error) {
    console.error('ì•Œë¦¼ ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({ success: false, error: 'ì•Œë¦¼ ì¡°íšŒ ì‹¤íŒ¨' });
  }
});

app.put('/api/notifications/:id/read', async (req, res) => {
  try {
    const { id } = req.params;

    // ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬ (ì‹¤ì œë¡œëŠ” ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸)
    console.log(`ì•Œë¦¼ ${id} ì½ìŒ ì²˜ë¦¬`);

    res.json({ success: true });
  } catch (error) {
    console.error('ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
    res.status(500).json({ success: false, error: 'ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬ ì‹¤íŒ¨' });
  }
});

// ëª¨ë“  ì•Œë¦¼ì„ ì½ìŒ ì²˜ë¦¬í•˜ëŠ” API
app.put('/api/notifications/mark-all-read', async (req, res) => {
  try {
    const { user_id } = req.body;

    // ëª¨ë“  ì•Œë¦¼ì„ ì½ìŒ ì²˜ë¦¬ (ì‹¤ì œë¡œëŠ” ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸)
    console.log(`ì‚¬ìš©ì ${user_id}ì˜ ëª¨ë“  ì•Œë¦¼ì„ ì½ìŒ ì²˜ë¦¬`);

    res.json({ success: true });
  } catch (error) {
    console.error('ëª¨ë“  ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
    res.status(500).json({ success: false, error: 'ëª¨ë“  ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬ ì‹¤íŒ¨' });
  }
});

// ì‹¤ì‹œê°„ ì•Œë¦¼ ìŠ¤íŠ¸ë¦¼ (Server-Sent Events)
const connectedClients = new Map();

app.get('/api/notifications/stream', (req, res) => {
  const { user_id } = req.query;

  // HTTP/2 í˜¸í™˜ì„±ì„ ìœ„í•œ SSE í—¤ë” ì„¤ì •
  res.writeHead(200, {
    'Content-Type': 'text/event-stream',
    'Cache-Control': 'no-cache, no-store, must-revalidate, private',
    'Connection': 'keep-alive',
    'X-Accel-Buffering': 'no', // Nginx í”„ë¡ì‹œì—ì„œ ë²„í¼ë§ ë¹„í™œì„±í™”
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Headers': 'Cache-Control, Content-Type, Last-Event-ID',
    'Access-Control-Allow-Methods': 'GET, OPTIONS',
    'Access-Control-Allow-Credentials': 'true',
    'Access-Control-Expose-Headers': 'Last-Event-ID'
  });

  // í´ë¼ì´ì–¸íŠ¸ ì—°ê²° ì €ì¥
  const clientId = Date.now();
  connectedClients.set(clientId, { res, user_id });

  console.log(`í´ë¼ì´ì–¸íŠ¸ ${clientId} (${user_id}) ì—°ê²°ë¨`);

  // ì—°ê²° í•´ì œ ì‹œ í´ë¼ì´ì–¸íŠ¸ ì œê±°
  req.on('close', () => {
    connectedClients.delete(clientId);
    console.log(`í´ë¼ì´ì–¸íŠ¸ ${clientId} ì—°ê²° í•´ì œë¨`);
  });

  req.on('error', (error) => {
    console.error(`í´ë¼ì´ì–¸íŠ¸ ${clientId} ì—°ê²° ì˜¤ë¥˜:`, error);
    connectedClients.delete(clientId);
  });

  // ì´ˆê¸° ì—°ê²° ë©”ì‹œì§€ (keep-alive ìœ ì§€)
  res.write(`data: ${JSON.stringify({ type: 'connected', clientId, timestamp: Date.now() })}\n\n`);

  // ì£¼ê¸°ì ìœ¼ë¡œ ì—°ê²° ìƒíƒœ í™•ì¸ (30ì´ˆë§ˆë‹¤)
  const keepAliveInterval = setInterval(() => {
    try {
      if (connectedClients.has(clientId)) {
        res.write(`data: ${JSON.stringify({ type: 'ping', timestamp: Date.now() })}\n\n`);
      } else {
        clearInterval(keepAliveInterval);
      }
    } catch (error) {
      console.error(`í´ë¼ì´ì–¸íŠ¸ ${clientId} keep-alive ì˜¤ë¥˜:`, error);
      connectedClients.delete(clientId);
      clearInterval(keepAliveInterval);
    }
  }, 30000);

  // ì—°ê²° í•´ì œ ì‹œ ì¸í„°ë²Œ ì •ë¦¬
  req.on('close', () => {
    clearInterval(keepAliveInterval);
  });
});

// ëª¨ë“  ê´€ë¦¬ìëª¨ë“œ ì ‘ì†ìì—ê²Œ ì•Œë¦¼ ì „ì†¡í•˜ëŠ” í•¨ìˆ˜
function sendNotificationToAllAgents(notification) {
  console.log('ëª¨ë“  ê´€ë¦¬ìëª¨ë“œ ì ‘ì†ìì—ê²Œ ì•Œë¦¼ ì „ì†¡:', notification);

  connectedClients.forEach((client, clientId) => {
    try {
      client.res.write(`data: ${JSON.stringify(notification)}\n\n`);
      console.log(`ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ: í´ë¼ì´ì–¸íŠ¸ ${clientId}`);
    } catch (error) {
      console.error(`í´ë¼ì´ì–¸íŠ¸ ${clientId}ì—ê²Œ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨:`, error);
      connectedClients.delete(clientId);
    }
  });
}

// ë°°ì • ëŒ€ìƒìì—ê²Œë§Œ ì•Œë¦¼ ì „ì†¡í•˜ëŠ” í•¨ìˆ˜
async function sendNotificationToTargetAgents(notification, targetOffices, targetDepartments, targetAgents) {
  console.log('ë°°ì • ëŒ€ìƒìì—ê²Œë§Œ ì•Œë¦¼ ì „ì†¡ ì‹œì‘:', {
    notification,
    targetOffices,
    targetDepartments,
    targetAgents
  });

  // ì‹¤ì œ ë‹´ë‹¹ì ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë¡œì§ (Google Sheetsì—ì„œ)
  let agents = [];

  try {
    // Google Sheetsì—ì„œ ë‹´ë‹¹ì ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const agentSheetName = 'ëŒ€ë¦¬ì ì•„ì´ë””ê´€ë¦¬';
    const agentData = await getSheetValues(agentSheetName);

    console.log('ë‹´ë‹¹ì ì‹œíŠ¸ ë°ì´í„° ë¡œë“œ ê²°ê³¼:', {
      hasData: !!agentData,
      dataLength: agentData?.length || 0,
      firstRow: agentData?.[0],
      secondRow: agentData?.[1]
    });

    if (agentData && agentData.length > 3) {
      // í—¤ë” ì œê±° (3í–‰ê¹Œì§€ê°€ í—¤ë”ì´ë¯€ë¡œ 4í–‰ë¶€í„° ì‹œì‘)
      agents = agentData.slice(3).map((row, index) => {
        const agent = {
          target: row[0], // Aì—´: ë‹´ë‹¹ìëª…
          qualification: row[1] || '', // Bì—´: ìê²© (ìˆ˜ì •)
          contactId: row[2], // Cì—´: ì—°ë½ì²˜(ì•„ì´ë””)
          office: row[5] || '', // Fì—´: ì‚¬ë¬´ì‹¤ (ê¸°ì¡´ Dì—´ â†’ Fì—´ë¡œ ì´ë™)
          department: row[6] || '', // Gì—´: ì†Œì† (ê¸°ì¡´ Eì—´ â†’ Gì—´ë¡œ ì´ë™)
          userRole: row[17] || '', // Rì—´: ê¶Œí•œ (ê¸°ì¡´ Pì—´ â†’ Rì—´ë¡œ ì´ë™)
          pushSubscription: row[16] ? JSON.parse(row[16]) : null // Qì—´: í‘¸ì‹œ êµ¬ë… ì •ë³´ (ê¸°ì¡´ Oì—´ â†’ Qì—´ë¡œ ì´ë™)
        };

        console.log(`ë‹´ë‹¹ì ë°ì´í„° íŒŒì‹± ${index + 1}:`, {
          target: agent.target,
          contactId: agent.contactId,
          office: agent.office,
          department: agent.department,
          hasPushSubscription: !!agent.pushSubscription
        });
        return agent;
      }).filter(agent => agent.target && agent.contactId);

      console.log(`ë‹´ë‹¹ì ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${agents.length}ëª…`);
    } else {
      console.warn('ë‹´ë‹¹ì ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•ŠìŒ');
    }
  } catch (error) {
    console.error('ë‹´ë‹¹ì ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
  }

  console.log('ì‚¬ìš© ê°€ëŠ¥í•œ ë‹´ë‹¹ì ëª©ë¡:', agents.map(a => `${a.target}(${a.contactId}) - ${a.role} - ${a.office} ${a.department}`));
  console.log('í˜„ì¬ ì—°ê²°ëœ í´ë¼ì´ì–¸íŠ¸:', Array.from(connectedClients.entries()).map(([id, client]) => `${id}:${client.user_id}`));
  console.log('ë°°ì • ëŒ€ìƒì ì •ë³´:', {
    targetOffices: targetOffices || [],
    targetDepartments: targetDepartments || [],
    targetAgents: targetAgents || []
  });
  console.log('í˜„ì¬ í‘¸ì‹œ êµ¬ë… ìƒíƒœ:', {
    totalSubscriptions: pushSubscriptions.size,
    subscriptions: Array.from(pushSubscriptions.keys())
  });

  // ë°°ì • ëŒ€ìƒì í•„í„°ë§
  const targetAgentsList = agents.filter(agent =>
    isTargetAgent(agent.contactId, targetOffices, targetDepartments, targetAgents, agents)
  );

  console.log('ë°°ì • ëŒ€ìƒì í•„í„°ë§ ê²°ê³¼:', {
    totalAgents: agents.length,
    targetAgentsCount: targetAgentsList.length,
    targetAgents: targetAgentsList.map(a => `${a.target}(${a.contactId})`)
  });

  // SSE ì‹¤ì‹œê°„ ì•Œë¦¼ ì „ì†¡
  let sseSentCount = 0;
  connectedClients.forEach((client, clientId) => {
    try {
      // í´ë¼ì´ì–¸íŠ¸ê°€ ë°°ì • ëŒ€ìƒìì¸ì§€ í™•ì¸
      if (isTargetAgent(client.user_id, targetOffices, targetDepartments, targetAgents, agents)) {
        client.res.write(`data: ${JSON.stringify(notification)}\n\n`);
        console.log(`SSE ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ: í´ë¼ì´ì–¸íŠ¸ ${clientId} (${client.user_id})`);
        sseSentCount++;

        // í‘¸ì‹œ ì•Œë¦¼ë„ í•¨ê»˜ ì „ì†¡ (ì‹œíŠ¸ì—ì„œ ë¡œë“œí•œ êµ¬ë… ì •ë³´ ì‚¬ìš©)
        const targetAgent = agents.find(agent => agent.contactId === client.user_id);
        const subscription = targetAgent?.pushSubscription || pushSubscriptions.get(client.user_id);
        if (subscription) {
          sendPushNotificationToUser(client.user_id, notification, subscription);
        }
      } else {
        console.log(`í´ë¼ì´ì–¸íŠ¸ ${clientId} (${client.user_id})ëŠ” ë°°ì • ëŒ€ìƒìê°€ ì•„ë‹˜`);
      }
    } catch (error) {
      console.error(`í´ë¼ì´ì–¸íŠ¸ ${clientId}ì—ê²Œ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨:`, error);
      connectedClients.delete(clientId);
    }
  });

  // ì˜¤í”„ë¼ì¸ ì‚¬ìš©ìë¥¼ ìœ„í•œ í‘¸ì‹œ ì•Œë¦¼ ì „ì†¡
  let pushSentCount = 0;
  targetAgentsList.forEach(agent => {
    // í˜„ì¬ ì˜¨ë¼ì¸ ìƒíƒœê°€ ì•„ë‹Œ ì‚¬ìš©ìì—ê²Œë§Œ í‘¸ì‹œ ì•Œë¦¼ ì „ì†¡
    const isOnline = Array.from(connectedClients.values()).some(client => client.user_id === agent.contactId);
    if (!isOnline) {
      // ì‹œíŠ¸ì—ì„œ ë¡œë“œí•œ êµ¬ë… ì •ë³´ê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ë©”ëª¨ë¦¬ì—ì„œ ì°¾ê¸°
      const subscription = agent.pushSubscription || pushSubscriptions.get(agent.contactId);
      if (subscription) {
        sendPushNotificationToUser(agent.contactId, notification, subscription);
        pushSentCount++;
      } else {
        console.log(`ì‚¬ìš©ì ${agent.contactId}ì˜ í‘¸ì‹œ êµ¬ë… ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
      }
    }
  });

  console.log('ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ ìš”ì•½:', {
    sseSentCount,
    pushSentCount,
    totalSent: sseSentCount + pushSentCount
  });
}

// í‘¸ì‹œ ì•Œë¦¼ ì „ì†¡ í•¨ìˆ˜
async function sendPushNotificationToUser(userId, notification, subscription = null) {
  try {
    // êµ¬ë… ì •ë³´ê°€ ì „ë‹¬ë˜ì§€ ì•Šìœ¼ë©´ ë©”ëª¨ë¦¬ì—ì„œ ì°¾ê¸°
    if (!subscription) {
      subscription = pushSubscriptions.get(userId);
    }

    console.log(`í‘¸ì‹œ ì•Œë¦¼ ì „ì†¡ ì‹œë„: ${userId}`, {
      hasSubscription: !!subscription,
      subscriptionSource: subscription ? (subscription === pushSubscriptions.get(userId) ? 'memory' : 'sheet') : 'none',
      notificationTitle: notification.title,
      notificationMessage: notification.message
    });

    if (!subscription) {
      console.log(`ì‚¬ìš©ì ${userId}ì˜ í‘¸ì‹œ êµ¬ë…ì´ ì—†ìŠµë‹ˆë‹¤.`);
      return;
    }

    const payload = JSON.stringify({
      title: notification.title || 'ìƒˆë¡œìš´ ë°°ì • ì™„ë£Œ',
      body: notification.message || 'ìƒˆë¡œìš´ ë°°ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.',
      icon: '/logo192.png',
      badge: '/logo192.png',
      tag: 'assignment-notification',
      data: {
        url: '/',
        timestamp: Date.now(),
        ...notification.data
      }
    });

    console.log(`í‘¸ì‹œ ì•Œë¦¼ í˜ì´ë¡œë“œ:`, payload);

    await webpush.sendNotification(subscription, payload);
    console.log(`í‘¸ì‹œ ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ: ${userId}`);
  } catch (error) {
    console.error(`í‘¸ì‹œ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨ (${userId}):`, error);

    // êµ¬ë…ì´ ë§Œë£Œëœ ê²½ìš° ì‚­ì œ
    if (error.statusCode === 410) {
      pushSubscriptions.delete(userId);
      console.log(`ë§Œë£Œëœ êµ¬ë… ì‚­ì œ: ${userId}`);
    }
  }
}

// ëŒ€ìƒì í™•ì¸ í•¨ìˆ˜
function isTargetAgent(userId, targetOffices, targetDepartments, targetAgents, agents) {
  console.log('ëŒ€ìƒì í™•ì¸ í•¨ìˆ˜ í˜¸ì¶œ:', {
    userId,
    targetOffices,
    targetDepartments,
    targetAgents,
    agentsCount: agents?.length || 0
  });

  // ì‚¬ìš©ì ì •ë³´ì—ì„œ ì†Œì† í™•ì¸ (contactId ë˜ëŠ” roleë¡œ ë§¤ì¹­)
  let userAgent = agents.find(agent => agent.contactId === userId);
  if (!userAgent) {
    // contactIdë¡œ ì°¾ì§€ ëª»í•˜ë©´ roleë¡œ ì°¾ê¸°
    userAgent = agents.find(agent => agent.role === userId);
  }
  if (!userAgent) {
    console.log(`ì‚¬ìš©ì ${userId}ì˜ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ`);
    return false;
  }

  console.log(`ì‚¬ìš©ì ${userId} ì •ë³´:`, userAgent);
  console.log(`ë°°ì • ëŒ€ìƒì:`, { targetOffices, targetDepartments, targetAgents });

  // ë¹ˆ ë°°ì—´ì´ê±°ë‚˜ undefinedì¸ ê²½ìš° ì²˜ë¦¬
  const offices = Array.isArray(targetOffices) ? targetOffices : [];
  const departments = Array.isArray(targetDepartments) ? targetDepartments : [];
  const targetAgentsList = Array.isArray(targetAgents) ? targetAgents : [];

  // ì „ì²´ ë°°ì •ì¸ ê²½ìš° ëª¨ë“  ê´€ë¦¬ìëª¨ë“œ ì ‘ì†ìì—ê²Œ ì „ì†¡
  if (offices.includes('ì „ì²´') || departments.includes('ì „ì²´') || targetAgentsList.includes('ì „ì²´')) {
    console.log(`ì „ì²´ ë°°ì •ì´ë¯€ë¡œ ${userId}ì—ê²Œ ì•Œë¦¼ ì „ì†¡`);
    return true;
  }

  // íŠ¹ì • ëŒ€ìƒì ë°°ì •ì¸ ê²½ìš° í•´ë‹¹ ëŒ€ìƒìë§Œ í™•ì¸
  const isTarget = offices.includes(userAgent.office) ||
    departments.includes(userAgent.department) ||
    targetAgentsList.includes(userAgent.target) ||
    targetAgentsList.includes(userAgent.contactId) ||
    targetAgentsList.includes(userAgent.role);

  console.log(`${userId} ëŒ€ìƒì ì—¬ë¶€:`, isTarget, {
    officeMatch: offices.includes(userAgent.office),
    departmentMatch: departments.includes(userAgent.department),
    targetMatch: targetAgentsList.includes(userAgent.target),
    contactIdMatch: targetAgentsList.includes(userAgent.contactId),
    roleMatch: targetAgentsList.includes(userAgent.role)
  });

  return isTarget;
}

// í‘¸ì‹œ êµ¬ë… ì •ë³´ë¥¼ Google Sheetsì— ì €ì¥í•˜ëŠ” í•¨ìˆ˜
async function savePushSubscriptionToSheet(userId, subscription) {
  try {
    console.log(`í‘¸ì‹œ êµ¬ë… ì •ë³´ë¥¼ ì‹œíŠ¸ì— ì €ì¥ ì¤‘: ${userId}`);

    const agentValues = await getSheetValues(AGENT_SHEET_NAME);
    if (!agentValues || agentValues.length < 4) {
      throw new Error('ëŒ€ë¦¬ì ì•„ì´ë””ê´€ë¦¬ ì‹œíŠ¸ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    // í—¤ë” ì œê±° (3í–‰ê¹Œì§€ê°€ í—¤ë”ì´ë¯€ë¡œ 4í–‰ë¶€í„° ì‹œì‘)
    const agentRows = agentValues.slice(3);

    // ì‚¬ìš©ì IDë¡œ í•´ë‹¹ í–‰ ì°¾ê¸° (Cì—´: ì—°ë½ì²˜(ì•„ì´ë””))
    const userRowIndex = agentRows.findIndex(row => row[2] === userId);

    if (userRowIndex === -1) {
      console.log(`ì‚¬ìš©ì ${userId}ë¥¼ ëŒ€ë¦¬ì ì•„ì´ë””ê´€ë¦¬ ì‹œíŠ¸ì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
      return false;
    }

    // ì‹¤ì œ ì‹œíŠ¸ í–‰ ë²ˆí˜¸ (í—¤ë” 3í–‰ + 0ë¶€í„° ì‹œì‘í•˜ëŠ” ì¸ë±ìŠ¤ + 1)
    const actualRowNumber = 4 + userRowIndex;

    // êµ¬ë… ì •ë³´ë¥¼ JSON ë¬¸ìì—´ë¡œ ë³€í™˜ (nullì¸ ê²½ìš° ë¹ˆ ë¬¸ìì—´)
    const subscriptionJson = subscription ? JSON.stringify(subscription) : '';

    // Google Sheets APIë¥¼ ì‚¬ìš©í•˜ì—¬ Oì—´ì— êµ¬ë… ì •ë³´ ì €ì¥
    const sheets = google.sheets({ version: 'v4', auth });

    await sheets.spreadsheets.values.update({
      spreadsheetId: SPREADSHEET_ID,
      range: `${AGENT_SHEET_NAME}!O${actualRowNumber}`,
      valueInputOption: 'RAW',
      resource: {
        values: [[subscriptionJson]]
      }
    });

    console.log(`í‘¸ì‹œ êµ¬ë… ì •ë³´ ì €ì¥ ì™„ë£Œ: ${userId} (í–‰ ${actualRowNumber})`);
    return true;

  } catch (error) {
    console.error(`í‘¸ì‹œ êµ¬ë… ì •ë³´ ì €ì¥ ì‹¤íŒ¨ (${userId}):`, error);
    return false;
  }
}

// Google Sheetsì—ì„œ í‘¸ì‹œ êµ¬ë… ì •ë³´ë¥¼ ë¡œë“œí•˜ëŠ” í•¨ìˆ˜
async function loadPushSubscriptionsFromSheet() {
  try {
    console.log('Google Sheetsì—ì„œ í‘¸ì‹œ êµ¬ë… ì •ë³´ ë¡œë“œ ì¤‘...');

    const agentValues = await getSheetValues(AGENT_SHEET_NAME);
    if (!agentValues || agentValues.length < 4) {
      console.warn('ëŒ€ë¦¬ì ì•„ì´ë””ê´€ë¦¬ ì‹œíŠ¸ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return new Map();
    }

    // í—¤ë” ì œê±° (3í–‰ê¹Œì§€ê°€ í—¤ë”ì´ë¯€ë¡œ 4í–‰ë¶€í„° ì‹œì‘)
    const agentRows = agentValues.slice(3);

    const subscriptions = new Map();

    agentRows.forEach((row, index) => {
      const userId = row[2]; // Cì—´: ì—°ë½ì²˜(ì•„ì´ë””)
      const subscriptionJson = row[16]; // Qì—´: í‘¸ì‹œ êµ¬ë… ì •ë³´ (ê¸°ì¡´ Oì—´ â†’ Qì—´ë¡œ ì´ë™)

      if (userId && subscriptionJson) {
        try {
          // ë¹ˆ ë¬¸ìì—´ì´ë‚˜ "O" ê°™ì€ ë‹¨ì¼ ë¬¸ìëŠ” JSONì´ ì•„ë‹ˆë¯€ë¡œ ìŠ¤í‚µ
          if (subscriptionJson.trim().length > 1 && subscriptionJson.trim().startsWith('{')) {
            const subscription = JSON.parse(subscriptionJson);
            subscriptions.set(userId, subscription);
            console.log(`í‘¸ì‹œ êµ¬ë… ì •ë³´ ë¡œë“œ: ${userId}`);
          } else {
            console.log(`í‘¸ì‹œ êµ¬ë… ì •ë³´ ì—†ìŒ ë˜ëŠ” ìœ íš¨í•˜ì§€ ì•ŠìŒ (${userId}): "${subscriptionJson}"`);
          }
        } catch (error) {
          console.error(`í‘¸ì‹œ êµ¬ë… ì •ë³´ íŒŒì‹± ì‹¤íŒ¨ (${userId}):`, error);
          console.error(`  - ì›ë³¸ ê°’: "${subscriptionJson}"`);
          console.error(`  - ê°’ íƒ€ì…: ${typeof subscriptionJson}`);
        }
      }
    });

    console.log(`í‘¸ì‹œ êµ¬ë… ì •ë³´ ë¡œë“œ ì™„ë£Œ: ${subscriptions.size}ê°œ`);
    return subscriptions;

  } catch (error) {
    console.error('í‘¸ì‹œ êµ¬ë… ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
    return new Map();
  }
}

// ì„œë²„ ì‹œì‘ ì‹œ í‘¸ì‹œ êµ¬ë… ì •ë³´ ë¡œë“œ
async function initializePushSubscriptions() {
  try {
    console.log('ì„œë²„ ì‹œì‘ ì‹œ í‘¸ì‹œ êµ¬ë… ì •ë³´ ì´ˆê¸°í™” ì¤‘...');
    const subscriptions = await loadPushSubscriptionsFromSheet();

    // ê¸°ì¡´ ë©”ëª¨ë¦¬ ê¸°ë°˜ êµ¬ë… ì •ë³´ë¥¼ ì‹œíŠ¸ì—ì„œ ë¡œë“œí•œ ì •ë³´ë¡œ êµì²´
    pushSubscriptions.clear();
    subscriptions.forEach((subscription, userId) => {
      pushSubscriptions.set(userId, subscription);
    });

    console.log(`í‘¸ì‹œ êµ¬ë… ì •ë³´ ì´ˆê¸°í™” ì™„ë£Œ: ${pushSubscriptions.size}ê°œ`);
  } catch (error) {
    console.error('í‘¸ì‹œ êµ¬ë… ì •ë³´ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
  }
}

// í‘¸ì‹œ ì•Œë¦¼ ê´€ë ¨ API
app.get('/api/push/vapid-public-key', (req, res) => {
  res.json({
    success: true,
    publicKey: vapidKeys.publicKey
  });
});

// í‘¸ì‹œ êµ¬ë… ë“±ë¡
app.post('/api/push/subscribe', async (req, res) => {
  try {
    const { subscription, userId } = req.body;

    console.log('í‘¸ì‹œ êµ¬ë… ë“±ë¡ ìš”ì²­:', {
      hasSubscription: !!subscription,
      userId,
      subscriptionKeys: subscription ? Object.keys(subscription) : []
    });

    if (!subscription || !userId) {
      return res.status(400).json({
        success: false,
        error: 'êµ¬ë… ì •ë³´ì™€ ì‚¬ìš©ì IDê°€ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }

    // ë©”ëª¨ë¦¬ì™€ Google Sheets ëª¨ë‘ì— êµ¬ë… ì •ë³´ ì €ì¥
    pushSubscriptions.set(userId, subscription);

    // Google Sheetsì— ì €ì¥ ì‹œë„
    const sheetSaveResult = await savePushSubscriptionToSheet(userId, subscription);

    console.log(`í‘¸ì‹œ êµ¬ë… ë“±ë¡ ì™„ë£Œ: ${userId}`, {
      totalSubscriptions: pushSubscriptions.size,
      sheetSaveResult,
      subscription: {
        endpoint: subscription.endpoint,
        keys: subscription.keys ? Object.keys(subscription.keys) : []
      }
    });

    res.json({
      success: true,
      sheetSaved: sheetSaveResult
    });
  } catch (error) {
    console.error('í‘¸ì‹œ êµ¬ë… ë“±ë¡ ì˜¤ë¥˜:', error);
    res.status(500).json({ success: false, error: 'êµ¬ë… ë“±ë¡ ì‹¤íŒ¨' });
  }
});

// í‘¸ì‹œ êµ¬ë… í•´ì œ
app.post('/api/push/unsubscribe', async (req, res) => {
  try {
    const { userId } = req.body;

    if (!userId) {
      return res.status(400).json({
        success: false,
        error: 'ì‚¬ìš©ì IDê°€ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }

    // ë©”ëª¨ë¦¬ì—ì„œ êµ¬ë… ì •ë³´ ì‚­ì œ
    pushSubscriptions.delete(userId);

    // Google Sheetsì—ì„œë„ êµ¬ë… ì •ë³´ ì‚­ì œ (ë¹ˆ ë¬¸ìì—´ë¡œ ì—…ë°ì´íŠ¸)
    const sheetDeleteResult = await savePushSubscriptionToSheet(userId, null);

    console.log(`í‘¸ì‹œ êµ¬ë… í•´ì œ: ${userId}`, {
      sheetDeleteResult
    });

    res.json({
      success: true,
      sheetDeleted: sheetDeleteResult
    });
  } catch (error) {
    console.error('í‘¸ì‹œ êµ¬ë… í•´ì œ ì˜¤ë¥˜:', error);
    res.status(500).json({ success: false, error: 'êµ¬ë… í•´ì œ ì‹¤íŒ¨' });
  }
});

// í‘¸ì‹œ ì•Œë¦¼ ì „ì†¡ (íŠ¹ì • ì‚¬ìš©ì)
app.post('/api/push/send', async (req, res) => {
  try {
    const { userId, notification } = req.body;

    if (!userId || !notification) {
      return res.status(400).json({
        success: false,
        error: 'ì‚¬ìš©ì IDì™€ ì•Œë¦¼ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }

    // ë¨¼ì € ë©”ëª¨ë¦¬ì—ì„œ êµ¬ë… ì •ë³´ ì°¾ê¸°
    let subscription = pushSubscriptions.get(userId);

    // ë©”ëª¨ë¦¬ì— ì—†ìœ¼ë©´ ì‹œíŠ¸ì—ì„œ ë¡œë“œ
    if (!subscription) {
      try {
        const agentValues = await getSheetValues(AGENT_SHEET_NAME);
        if (agentValues && agentValues.length > 3) {
          const agentRows = agentValues.slice(3);
          const userRow = agentRows.find(row => row[2] === userId);
          if (userRow && userRow[14]) {
            subscription = JSON.parse(userRow[14]);
            console.log(`ì‹œíŠ¸ì—ì„œ êµ¬ë… ì •ë³´ ë¡œë“œ: ${userId}`);
          }
        }
      } catch (error) {
        console.error('ì‹œíŠ¸ì—ì„œ êµ¬ë… ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
      }
    }

    if (!subscription) {
      return res.status(404).json({
        success: false,
        error: 'ì‚¬ìš©ìì˜ í‘¸ì‹œ êµ¬ë…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }

    const payload = JSON.stringify({
      title: notification.title || 'ìƒˆë¡œìš´ ì•Œë¦¼',
      body: notification.message || 'ìƒˆë¡œìš´ ì•Œë¦¼ì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤.',
      icon: '/logo192.png',
      badge: '/logo192.png',
      tag: 'assignment-notification',
      data: {
        url: '/',
        timestamp: Date.now(),
        ...notification.data
      }
    });

    await webpush.sendNotification(subscription, payload);
    console.log(`í‘¸ì‹œ ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ: ${userId}`);

    res.json({ success: true });
  } catch (error) {
    console.error('í‘¸ì‹œ ì•Œë¦¼ ì „ì†¡ ì˜¤ë¥˜:', error);

    // êµ¬ë…ì´ ë§Œë£Œëœ ê²½ìš° ì‚­ì œ
    if (error.statusCode === 410) {
      const { userId } = req.body;
      pushSubscriptions.delete(userId);
      // ì‹œíŠ¸ì—ì„œë„ ì‚­ì œ
      await savePushSubscriptionToSheet(userId, null);
      console.log(`ë§Œë£Œëœ êµ¬ë… ì‚­ì œ: ${userId}`);
    }

    res.status(500).json({ success: false, error: 'í‘¸ì‹œ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨' });
  }
});

// ëª¨ë¸ìƒ‰ìƒë³„ ì •ë¦¬ ë°ì´í„° API (ìµœì í™” ë²„ì „)
app.get('/api/reservation-sales/model-color', async (req, res) => {
  try {
    console.log('ëª¨ë¸ìƒ‰ìƒë³„ ì •ë¦¬ ë°ì´í„° ìš”ì²­');

    // ìºì‹œ í‚¤ ìƒì„±
    const cacheKey = 'model_color_stats';

    // ìºì‹œì—ì„œ ë¨¼ì € í™•ì¸ (5ë¶„ TTL)
    const cachedData = cacheUtils.get(cacheKey);
    if (cachedData) {
      console.log('ìºì‹œëœ ëª¨ë¸ìƒ‰ìƒë³„ ì •ë¦¬ ë°ì´í„° ë°˜í™˜');
      return res.json(cachedData);
    }

    // 1. ì •ê·œí™”ëœ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ìºì‹œ í™œìš©)
    const normalizedCacheKey = 'normalized_data_cache';
    let normalizedData = cacheUtils.get(normalizedCacheKey);

    if (!normalizedData) {
      const normalizedResponse = await fetch(`${process.env.REACT_APP_API_URL || 'http://localhost:4000'}/api/reservation-settings/normalized-data`);
      if (!normalizedResponse.ok) {
        throw new Error('ì •ê·œí™”ëœ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      }
      normalizedData = await normalizedResponse.json();

      if (!normalizedData.success) {
        throw new Error('ì •ê·œí™”ëœ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨');
      }

      // ì •ê·œí™” ë°ì´í„° ìºì‹± (10ë¶„ TTL)
      cacheUtils.set(normalizedCacheKey, normalizedData, 600);
    }

    // 2. ë³‘ë ¬ë¡œ ì‹œíŠ¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì˜¨ì„¸ì¼, ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ í¬í•¨)
    const [reservationSiteValues, yardValues, onSaleValues, mobileJoinValues] = await Promise.all([
      getSheetValues('ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸'),
      getSheetValues('ë§ˆë‹¹ì ‘ìˆ˜'),
      getSheetValues('ì˜¨ì„¸ì¼'),
      getSheetValues('ëª¨ë°”ì¼ê°€ì…ë‚´ì—­')
    ]);

    if (!reservationSiteValues || reservationSiteValues.length < 2) {
      throw new Error('ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    if (!yardValues || yardValues.length < 2) {
      throw new Error('ë§ˆë‹¹ì ‘ìˆ˜ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    if (!onSaleValues || onSaleValues.length < 2) {
      throw new Error('ì˜¨ì„¸ì¼ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    if (!mobileJoinValues || mobileJoinValues.length < 2) {
      console.log('ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ë¬´ì‹œë¨)');
    }

    // 4. ì •ê·œí™” ê·œì¹™ ë§¤í•‘ ìƒì„±
    const normalizationRules = normalizedData.normalizationRules || [];
    const ruleMap = new Map();

    console.log(`ì •ê·œí™” ê·œì¹™ ìˆ˜: ${normalizationRules.length}`);

    normalizationRules.forEach(rule => {
      // reservationSite ë¶€ë¶„ë§Œ ì‚¬ìš©í•˜ì—¬ í‚¤ ìƒì„± (P|Q|R í˜•ì‹) - ê³µë°± ì œê±°
      const key = rule.reservationSite.replace(/\s+/g, '');
      ruleMap.set(key, rule.normalizedModel);
      console.log(`ì •ê·œí™” ê·œì¹™ ì¶”ê°€: ${key} -> ${rule.normalizedModel}`);
      console.log(`  ì›ë³¸ ë°ì´í„°: reservationSite="${rule.reservationSite}", phonekl="${rule.phonekl}"`);
    });

    console.log(`ì •ê·œí™” ê·œì¹™ ë§¤í•‘ ì™„ë£Œ: ${ruleMap.size}ê°œ ê·œì¹™`);

    // 5. ë§ˆë‹¹ì ‘ìˆ˜ ë°ì´í„° ì¸ë±ì‹± (ì˜ˆì•½ë²ˆí˜¸ë³„ ë¹ ë¥¸ ê²€ìƒ‰ì„ ìœ„í•´)
    const yardIndex = new Map();
    let yardIndexCount = 0;
    yardValues.slice(1).forEach((yardRow, index) => {
      if (yardRow.length >= 22) { // Vì—´ê¹Œì§€ í•„ìš”í•˜ë¯€ë¡œ ìµœì†Œ 22ê°œ ì»¬ëŸ¼
        const uValue = (yardRow[20] || '').toString().trim(); // Uì—´ (21ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
        const vValue = (yardRow[21] || '').toString().trim(); // Vì—´ (22ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
        const receivedDateTime = (yardRow[11] || '').toString().trim(); // Lì—´ (12ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
        const receivedMemo = (yardRow[20] || '').toString().trim(); // Uì—´ (21ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)

        // ì˜ˆì•½ë²ˆí˜¸ íŒ¨í„´ ì°¾ê¸° (í•˜ì´í”ˆì´ ì—†ëŠ” í˜•íƒœ: XX000000)
        const reservationPattern = /[A-Z]{2}\d{6}/g;
        const uMatches = uValue.match(reservationPattern) || [];
        const vMatches = vValue.match(reservationPattern) || [];

        // ëª¨ë“  ì˜ˆì•½ë²ˆí˜¸ë¥¼ ì¸ë±ìŠ¤ì— ì¶”ê°€ (ì´ë¯¸ í•˜ì´í”ˆì´ ì—†ëŠ” í˜•íƒœ)
        [...uMatches, ...vMatches].forEach(match => {
          const normalizedReservationNumber = match;
          yardIndex.set(normalizedReservationNumber, {
            receivedDateTime,
            receivedMemo
          });
          yardIndexCount++;

          // ì²˜ìŒ 5ê°œ ë§ˆë‹¹ì ‘ìˆ˜ ë°ì´í„° ë¡œê·¸
          if (index < 5) {
            console.log(`ë§ˆë‹¹ì ‘ìˆ˜ ì¸ë±ì‹±: ì›ë³¸="${match}" -> ì •ê·œí™”="${normalizedReservationNumber}"`);
            console.log(`  Uì—´: "${uValue}", Vì—´: "${vValue}"`);
            console.log(`  ì ‘ìˆ˜ì¼ì‹œ: "${receivedDateTime}", ì ‘ìˆ˜ë©”ëª¨: "${receivedMemo}"`);
          }
        });
      }
    });

    console.log(`ë§ˆë‹¹ì ‘ìˆ˜ ë°ì´í„° ì¸ë±ì‹± ì™„ë£Œ: ${yardIndex.size}ê°œ ì˜ˆì•½ë²ˆí˜¸ (ì´ ${yardIndexCount}ê°œ ì²˜ë¦¬)`);
    console.log(`ë§ˆë‹¹ì ‘ìˆ˜ ì˜ˆì•½ë²ˆí˜¸ ìƒ˜í”Œ:`, Array.from(yardIndex.keys()).slice(0, 5));

    // ì˜¨ì„¸ì¼ ë°ì´í„° ì¸ë±ì‹± (ê³ ê°ëª… + ëŒ€ë¦¬ì ì½”ë“œ ê¸°ì¤€)
    const onSaleIndex = new Map();
    let onSaleIndexCount = 0;

    onSaleValues.slice(1).forEach((row, index) => {
      const customerName = row[2] || ''; // Cì—´ (3ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
      const storeCode = row[12] || ''; // Mì—´ (13ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
      const receivedDate = row[5] || ''; // Fì—´ (6ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)

      if (customerName && storeCode) {
        const key = `${customerName}_${storeCode}`;
        onSaleIndex.set(key, receivedDate);
        onSaleIndexCount++;

        // ì²˜ìŒ 5ê°œë§Œ ë””ë²„ê¹… ë¡œê·¸
        if (index < 5) {
          console.log(`ì˜¨ì„¸ì¼ í–‰ ${index + 2}: ê³ ê°ëª…="${customerName}", ëŒ€ë¦¬ì ì½”ë“œ="${storeCode}", ì ‘ìˆ˜ì¼="${receivedDate}"`);
        }
      }
    });

    console.log(`ì˜¨ì„¸ì¼ ë°ì´í„° ì¸ë±ì‹± ì™„ë£Œ: ${onSaleIndex.size}ê°œ ê³ ê°-ëŒ€ë¦¬ì  ì¡°í•© (ì´ ${onSaleIndexCount}ê°œ ì²˜ë¦¬)`);
    console.log(`ì˜¨ì„¸ì¼ ë°ì´í„° ìƒ˜í”Œ:`, Array.from(onSaleIndex.entries()).slice(0, 5));

    // ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ ë°ì´í„° ì¸ë±ì‹± (ì˜ˆì•½ë²ˆí˜¸ ê¸°ì¤€)
    const mobileJoinIndex = new Map();
    let mobileJoinIndexCount = 0;

    if (mobileJoinValues && mobileJoinValues.length > 1) {
      mobileJoinValues.slice(1).forEach((row, index) => {
        const reservationNumber = (row[6] || '').toString().trim(); // Gì—´ (7ë²ˆì§¸, 0ë¶€í„° ì‹œì‘): ì˜ˆì•½ë²ˆí˜¸
        const reservationDateTime = (row[9] || '').toString().trim(); // Jì—´ (10ë²ˆì§¸, 0ë¶€í„° ì‹œì‘): ì˜ˆì•½ì¼ì‹œ

        if (reservationNumber) {
          // ì˜ˆì•½ë²ˆí˜¸ ì •ê·œí™” (í•˜ì´í”ˆ ì œê±°)
          const normalizedReservationNumber = reservationNumber.replace(/-/g, '');
          mobileJoinIndex.set(normalizedReservationNumber, reservationDateTime);
          mobileJoinIndexCount++;

          // ì²˜ìŒ 5ê°œë§Œ ë””ë²„ê¹… ë¡œê·¸
          if (index < 5) {
            console.log(`ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ í–‰ ${index + 2}: ì˜ˆì•½ë²ˆí˜¸="${reservationNumber}", ì •ê·œí™”="${normalizedReservationNumber}", ì˜ˆì•½ì¼ì‹œ="${reservationDateTime}"`);
          }
        }
      });
    }

    console.log(`ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ ë°ì´í„° ì¸ë±ì‹± ì™„ë£Œ: ${mobileJoinIndex.size}ê°œ ì˜ˆì•½ë²ˆí˜¸ (ì´ ${mobileJoinIndexCount}ê°œ ì²˜ë¦¬)`);
    console.log(`ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ ë°ì´í„° ìƒ˜í”Œ:`, Array.from(mobileJoinIndex.entries()).slice(0, 5));

    // 6. ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ë°ì´í„° ì²˜ë¦¬
    const reservationSiteRows = reservationSiteValues.slice(1); // í—¤ë” ì œê±°
    const modelColorStats = new Map(); // ëª¨ë¸ìƒ‰ìƒë³„ í†µê³„

    // ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ë°ì´í„° ì²˜ë¦¬

    let processedCount = 0;
    let matchedCount = 0;

    reservationSiteRows.forEach((row, index) => {
      if (row.length < 20) {
        console.log(`í–‰ ${index + 1}: ì»¬ëŸ¼ ìˆ˜ ë¶€ì¡± (${row.length})`);
        return; // ìµœì†Œ ì»¬ëŸ¼ ìˆ˜ í™•ì¸
      }

      const pValue = (row[15] || '').toString().trim(); // Pì—´
      const qValue = (row[16] || '').toString().trim(); // Qì—´
      const rValue = (row[17] || '').toString().trim(); // Rì—´
      const reservationNumber = (row[8] || '').toString().trim(); // Iì—´: ì˜ˆì•½ë²ˆí˜¸
      const customerName = (row[7] || '').toString().trim(); // Hì—´: ê³ ê°ëª…
      const storeCode = (row[23] || '').toString().trim(); // Xì—´: ëŒ€ë¦¬ì ì½”ë“œ
      const type = (row[31] || '').toString().trim(); // AFì—´: ìœ í˜•

      // ì²˜ìŒ ëª‡ ê°œ í–‰ì˜ ë°ì´í„° í™•ì¸
      if (index < 5) {
        console.log(`í–‰ ${index + 1} ë°ì´í„°: P="${pValue}", Q="${qValue}", R="${rValue}", ì˜ˆì•½ë²ˆí˜¸="${reservationNumber}", ìœ í˜•="${type}"`);
      }

      if (!pValue || !qValue || !rValue || !reservationNumber) {
        if (index < 10) {
          console.log(`í–‰ ${index + 1}: í•„ìˆ˜ ë°ì´í„° ëˆ„ë½ - P:${!!pValue}, Q:${!!qValue}, R:${!!rValue}, ì˜ˆì•½ë²ˆí˜¸:${!!reservationNumber}`);
        }
        return;
      }

      processedCount++;

      // ì •ê·œí™”ëœ ëª¨ë¸ëª… ì°¾ê¸° (ê³µë°± ì œê±°)
      const originalKey = `${pValue}|${qValue}|${rValue}`.replace(/\s+/g, '');
      const normalizedModel = ruleMap.get(originalKey);

      if (!normalizedModel) {
        if (index < 5) {
          console.log(`ì •ê·œí™”ë˜ì§€ ì•Šì€ ëª¨ë¸: ${originalKey}`);
          console.log(`  ì›ë³¸ ê°’: P="${pValue}", Q="${qValue}", R="${rValue}"`);
        }
        return; // ì •ê·œí™”ë˜ì§€ ì•Šì€ ëª¨ë¸ì€ ì œì™¸
      }

      matchedCount++;
      console.log(`ì •ê·œí™”ëœ ëª¨ë¸ ë§¤ì¹­: ${originalKey} -> ${normalizedModel}`);

      // ëª¨ë¸ê³¼ ìƒ‰ìƒ ë¶„ë¦¬ (ì •ê·œí™”ëœ ëª¨ë¸ëª…ì—ì„œ ëª¨ë¸ëª…ë§Œ ì¶”ì¶œ)
      // "Z Fold7 512G ë¸”ë£¨ ì‰ë„ìš° SM-F966N_512G ë¸”ë£¨ ì‰ë„ìš°" -> "Z Fold7 512G ë¸”ë£¨ ì‰ë„ìš°"
      const modelMatch = normalizedModel.match(/^(.+?)\s+SM-[A-Z0-9_]+/);
      if (!modelMatch) {
        if (index < 5) {
          console.log(`ëª¨ë¸ëª… ì¶”ì¶œ ì‹¤íŒ¨: ì •ê·œí™”ëœëª¨ë¸="${normalizedModel}"`);
          console.log(`  ì •ê·œí‘œí˜„ì‹ ë§¤ì¹­ ì‹¤íŒ¨: ${normalizedModel}`);
        }
        return;
      }

      const model = modelMatch[1].trim();
      const color = ''; // ìƒ‰ìƒì€ ëª¨ë¸ëª…ì— í¬í•¨ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ë³„ë„ ì¶”ì¶œí•˜ì§€ ì•ŠìŒ

      if (!model) {
        if (index < 5) {
          console.log(`ëª¨ë¸ëª…ì´ ë¹„ì–´ìˆìŒ: ì •ê·œí™”ëœëª¨ë¸="${normalizedModel}"`);
        }
        return;
      }

      if (index < 5) {
        console.log(`ëª¨ë¸ëª… ì¶”ì¶œ ì„±ê³µ: ì •ê·œí™”ëœëª¨ë¸="${normalizedModel}" -> ëª¨ë¸ëª…="${model}"`);
      }

      // ìœ í˜• ë¶„ë¥˜ í•¨ìˆ˜
      const classifyType = (typeValue) => {
        if (!typeValue) return 'ê¸°íƒ€';
        const typeStr = typeValue.toString().trim();
        if (typeStr.includes('ì‹ ê·œê°€ì…')) return 'ì‹ ê·œ';
        if (typeStr.includes('ë²ˆí˜¸ì´ë™')) return 'MNP';
        if (typeStr.includes('ê¸°ê¸°ë³€ê²½')) return 'ê¸°ë³€';
        return 'ê¸°íƒ€';
      };

      const classifiedType = classifyType(type);

      const key = model; // ëª¨ë¸ëª…ë§Œìœ¼ë¡œ í‚¤ ìƒì„±

      if (!modelColorStats.has(key)) {
        modelColorStats.set(key, {
          model,
          total: 0,
          received: {
            ì‹ ê·œ: 0,
            MNP: 0,
            ê¸°ë³€: 0,
            ê¸°íƒ€: 0
          },
          notReceived: {
            ì‹ ê·œ: 0,
            MNP: 0,
            ê¸°ë³€: 0,
            ê¸°íƒ€: 0
          }
        });
      }

      const stats = modelColorStats.get(key);
      stats.total++;

      // ì„œë¥˜ì ‘ìˆ˜ ì—¬ë¶€ í™•ì¸ (ë§ˆë‹¹ì ‘ìˆ˜ OR ì˜¨ì„¸ì¼ ì ‘ìˆ˜)
      // ì˜ˆì•½ë²ˆí˜¸ë„ í•˜ì´í”ˆ ì œê±°í•˜ì—¬ ì •ê·œí™”ëœ í˜•íƒœë¡œ ë¹„êµ
      const normalizedReservationNumber = reservationNumber.replace(/-/g, '');
      const isYardReceived = yardIndex.has(normalizedReservationNumber);
      const isOnSaleReceived = onSaleIndex.has(`${customerName}_${storeCode}`);
      const isReceived = isYardReceived || isOnSaleReceived;

      if (index < 5) {
        console.log(`ì„œë¥˜ì ‘ìˆ˜ ë§¤ì¹­ ì‹œë„: ì˜ˆì•½ë²ˆí˜¸="${reservationNumber}" -> ì •ê·œí™”="${normalizedReservationNumber}" -> ë§ˆë‹¹ì ‘ìˆ˜=${isYardReceived}, ì˜¨ì„¸ì¼ì ‘ìˆ˜=${isOnSaleReceived}, ìµœì¢…ê²°ê³¼=${isReceived}`);
        console.log(`  ë§ˆë‹¹ì ‘ìˆ˜ ì¸ë±ìŠ¤ì— ì¡´ì¬: ${yardIndex.has(normalizedReservationNumber)}`);
        console.log(`  ì˜¨ì„¸ì¼ ì¸ë±ìŠ¤ì— ì¡´ì¬: ${onSaleIndex.has(`${customerName}_${storeCode}`)}`);
      }

      if (isReceived) {
        stats.received[classifiedType]++;
        if (index < 5) {
          console.log(`âœ… ì„œë¥˜ì ‘ìˆ˜ í™•ì¸ë¨: ${reservationNumber} (ì •ê·œí™”: ${normalizedReservationNumber}) -> ${model} (${classifiedType})`);
        }
      } else {
        stats.notReceived[classifiedType]++;
        if (index < 5) {
          console.log(`âŒ ì„œë¥˜ë¯¸ì ‘ìˆ˜: ${reservationNumber} (ì •ê·œí™”: ${normalizedReservationNumber}) -> ${model} (${classifiedType})`);
        }
      }
    });

    // 7. ê²°ê³¼ ì •ë ¬ ë° ë°˜í™˜
    const result = Array.from(modelColorStats.values())
      .sort((a, b) => b.total - a.total) // ì´ ìˆ˜ëŸ‰ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
      .map((item, index) => {
        // ìœ í˜•ë³„ í•©ê³„ ê³„ì‚°
        const receivedTotal = item.received.ì‹ ê·œ + item.received.MNP + item.received.ê¸°ë³€ + item.received.ê¸°íƒ€;
        const notReceivedTotal = item.notReceived.ì‹ ê·œ + item.notReceived.MNP + item.notReceived.ê¸°ë³€ + item.notReceived.ê¸°íƒ€;

        return {
          ...item,
          rank: index + 1,
          receivedTotal,
          notReceivedTotal
        };
      });

    console.log(`ëª¨ë¸ìƒ‰ìƒë³„ ì •ë¦¬ ë°ì´í„° ìƒì„± ì™„ë£Œ: ${result.length}ê°œ ëª¨ë¸ìƒ‰ìƒ ì¡°í•©`);
    console.log(`ì²˜ë¦¬ëœ ë°ì´í„°: ${processedCount}ê°œ, ë§¤ì¹­ëœ ë°ì´í„°: ${matchedCount}ê°œ`);
    console.log(`ëª¨ë¸ìƒ‰ìƒ í†µê³„: ${modelColorStats.size}ê°œ ì¡°í•©`);

    const responseData = {
      success: true,
      data: result,
      total: result.length,
      stats: {
        totalItems: result.reduce((sum, item) => sum + item.total, 0),
        totalReceived: result.reduce((sum, item) => sum + item.receivedTotal, 0),
        totalNotReceived: result.reduce((sum, item) => sum + item.notReceivedTotal, 0)
      }
    };

    // ê²°ê³¼ ìºì‹± (5ë¶„ TTL)
    cacheUtils.set(cacheKey, responseData, 300);

    res.json(responseData);

  } catch (error) {
    console.error('ëª¨ë¸ìƒ‰ìƒë³„ ì •ë¦¬ ë°ì´í„° ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to load model-color data',
      message: error.message
    });
  }
});

// POSë³„ ëª¨ë¸ìƒ‰ìƒ ë°ì´í„° API (ìµœì í™” ë²„ì „)
app.get('/api/reservation-sales/model-color/by-pos/:posName', async (req, res) => {
  try {
    const { posName } = req.params;
    console.log(`POSë³„ ëª¨ë¸ìƒ‰ìƒ ë°ì´í„° ìš”ì²­: ${posName}`);

    // ìºì‹œ í‚¤ ìƒì„±
    const cacheKey = `pos_customer_list_${posName}`;

    // ìºì‹œì—ì„œ ë¨¼ì € í™•ì¸ (5ë¶„ TTL)
    const cachedData = cacheUtils.get(cacheKey);
    if (cachedData) {
      console.log(`ìºì‹œëœ POSë³„ ê³ ê° ë¦¬ìŠ¤íŠ¸ ë°˜í™˜: ${posName}`);
      return res.json(cachedData);
    }

    // 1. ì •ê·œí™”ëœ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ìºì‹œ í™œìš©)
    const normalizedCacheKey = 'normalized_data_cache';
    let normalizedData = cacheUtils.get(normalizedCacheKey);

    if (!normalizedData) {
      const normalizedResponse = await fetch(`${process.env.REACT_APP_API_URL || 'http://localhost:4000'}/api/reservation-settings/normalized-data`);
      if (!normalizedResponse.ok) {
        throw new Error('ì •ê·œí™”ëœ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      }
      normalizedData = await normalizedResponse.json();

      if (!normalizedData.success) {
        throw new Error('ì •ê·œí™”ëœ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨');
      }

      // ì •ê·œí™” ë°ì´í„° ìºì‹± (10ë¶„ TTL)
      cacheUtils.set(normalizedCacheKey, normalizedData, 600);
    }

    // 2. ë³‘ë ¬ë¡œ ëª¨ë“  ì‹œíŠ¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const [reservationSiteValues, yardValues, onSaleValues] = await Promise.all([
      getSheetValues('ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸'),
      getSheetValues('ë§ˆë‹¹ì ‘ìˆ˜'),
      getSheetValues('ì˜¨ì„¸ì¼')
    ]);

    // 3. POSì½”ë“œë³€ê²½ì„¤ì • ì‹œíŠ¸ ë¡œë“œ (ì„ íƒì‚¬í•­ - ì—†ì–´ë„ ì—ëŸ¬ ë°œìƒí•˜ì§€ ì•ŠìŒ)
    let posCodeMappingValues = null;
    try {
      posCodeMappingValues = await getSheetValues('POSì½”ë“œë³€ê²½ì„¤ì •');
      console.log('POSë³„ ê³ ê°ë¦¬ìŠ¤íŠ¸: POSì½”ë“œë³€ê²½ì„¤ì • ì‹œíŠ¸ ë¡œë“œ ì„±ê³µ');
    } catch (error) {
      console.log('POSë³„ ê³ ê°ë¦¬ìŠ¤íŠ¸: POSì½”ë“œë³€ê²½ì„¤ì • ì‹œíŠ¸ ë¡œë“œ ì‹¤íŒ¨ (ë¬´ì‹œë¨):', error.message);
      posCodeMappingValues = [];
    }

    // POSì½”ë“œ/ì´ë¦„ ë§¤í•‘ í…Œì´ë¸” ìƒì„±
    const posCodeMapping = new Map();
    const posNameMapping = new Map();
    const posNameMappingWithReceiver = new Map();

    if (posCodeMappingValues && posCodeMappingValues.length > 1) {
      posCodeMappingValues.slice(1).forEach(row => {
        if (row.length >= 4) {
          const originalCode = (row[0] || '').toString().trim();
          const newCode = (row[1] || '').toString().trim();
          const originalName = (row[2] || '').toString().trim();
          const newName = (row[3] || '').toString().trim();
          const receiver = row.length > 4 ? (row[4] || '').toString().trim() : '';

          if (originalCode && newCode) {
            posCodeMapping.set(originalCode, newCode);
          }

          if (originalName && newName) {
            if (receiver) {
              // ì ‘ìˆ˜ìë³„ ë§¤í•‘
              const key = `${originalName}_${receiver}`;
              posNameMappingWithReceiver.set(key, newName);
            } else {
              // ì¼ë°˜ ë§¤í•‘
              posNameMapping.set(originalName, newName);
            }
          }
        }
      });
      console.log(`POSë³„ ê³ ê°ë¦¬ìŠ¤íŠ¸: POSì½”ë“œ ë§¤í•‘ ${posCodeMapping.size}ê°œ, POSëª… ë§¤í•‘ ${posNameMapping.size}ê°œ, ì ‘ìˆ˜ìë³„ ë§¤í•‘ ${posNameMappingWithReceiver.size}ê°œ ë¡œë“œ`);
    }

    if (!reservationSiteValues || reservationSiteValues.length < 2) {
      throw new Error('ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    if (!yardValues || yardValues.length < 2) {
      throw new Error('ë§ˆë‹¹ì ‘ìˆ˜ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    if (!onSaleValues || onSaleValues.length < 2) {
      throw new Error('ì˜¨ì„¸ì¼ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    // 4. ì •ê·œí™” ê·œì¹™ ë§¤í•‘ ìƒì„±
    const normalizationRules = normalizedData.normalizationRules || [];
    const ruleMap = new Map();

    normalizationRules.forEach(rule => {
      const key = rule.reservationSite.replace(/\s+/g, '');
      ruleMap.set(key, rule.normalizedModel);
    });

    // 4. ë§ˆë‹¹ì ‘ìˆ˜ ë°ì´í„° ì¸ë±ì‹± (ì˜ˆì•½ë²ˆí˜¸ë³„ ë¹ ë¥¸ ê²€ìƒ‰ì„ ìœ„í•´)
    const yardIndex = new Map();
    let yardIndexCount = 0;
    yardValues.slice(1).forEach((yardRow, index) => {
      if (yardRow.length >= 22) { // Vì—´ê¹Œì§€ í•„ìš”í•˜ë¯€ë¡œ ìµœì†Œ 22ê°œ ì»¬ëŸ¼
        const uValue = (yardRow[20] || '').toString().trim(); // Uì—´ (21ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
        const vValue = (yardRow[21] || '').toString().trim(); // Vì—´ (22ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
        const receivedDateTime = (yardRow[11] || '').toString().trim(); // Lì—´ (12ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
        const receivedMemo = (yardRow[20] || '').toString().trim(); // Uì—´ (21ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)

        // ì˜ˆì•½ë²ˆí˜¸ íŒ¨í„´ ì°¾ê¸° (í•˜ì´í”ˆì´ ì—†ëŠ” í˜•íƒœ: XX000000)
        const reservationPattern = /[A-Z]{2}\d{6}/g;
        const uMatches = uValue.match(reservationPattern) || [];
        const vMatches = vValue.match(reservationPattern) || [];

        // ëª¨ë“  ì˜ˆì•½ë²ˆí˜¸ë¥¼ ì¸ë±ìŠ¤ì— ì¶”ê°€ (ì´ë¯¸ í•˜ì´í”ˆì´ ì—†ëŠ” í˜•íƒœ)
        [...uMatches, ...vMatches].forEach(match => {
          const normalizedReservationNumber = match;
          yardIndex.set(normalizedReservationNumber, {
            receivedDateTime,
            receivedMemo
          });
          yardIndexCount++;

          // ì²˜ìŒ 5ê°œ ë§ˆë‹¹ì ‘ìˆ˜ ë°ì´í„° ë¡œê·¸
          if (index < 5) {
            console.log(`POSë³„ ë§ˆë‹¹ì ‘ìˆ˜ ì¸ë±ì‹±: ì›ë³¸="${match}" -> ì •ê·œí™”="${normalizedReservationNumber}"`);
            console.log(`  Uì—´: "${uValue}", Vì—´: "${vValue}"`);
            console.log(`  ì ‘ìˆ˜ì¼ì‹œ: "${receivedDateTime}", ì ‘ìˆ˜ë©”ëª¨: "${receivedMemo}"`);
          }
        });
      }
    });

    console.log(`POSë³„ ë§ˆë‹¹ì ‘ìˆ˜ ë°ì´í„° ì¸ë±ì‹± ì™„ë£Œ: ${yardIndex.size}ê°œ ì˜ˆì•½ë²ˆí˜¸ (ì´ ${yardIndexCount}ê°œ ì²˜ë¦¬)`);
    console.log(`POSë³„ ë§ˆë‹¹ì ‘ìˆ˜ ì˜ˆì•½ë²ˆí˜¸ ìƒ˜í”Œ:`, Array.from(yardIndex.keys()).slice(0, 5));

    // ì˜¨ì„¸ì¼ ë°ì´í„° ì¸ë±ì‹± (ê³ ê°ëª… + ëŒ€ë¦¬ì ì½”ë“œ ê¸°ì¤€)
    const onSaleIndex = new Map();
    let onSaleIndexCount = 0;

    onSaleValues.slice(1).forEach(row => {
      const customerName = row[2] || ''; // Cì—´ (3ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
      const storeCode = row[12] || ''; // Mì—´ (13ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
      const receivedDate = row[5] || ''; // Fì—´ (6ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)

      if (customerName && storeCode) {
        const key = `${customerName}_${storeCode}`;
        onSaleIndex.set(key, receivedDate);
        onSaleIndexCount++;
      }
    });

    console.log(`POSë³„ ì˜¨ì„¸ì¼ ë°ì´í„° ì¸ë±ì‹± ì™„ë£Œ: ${onSaleIndex.size}ê°œ ê³ ê°-ëŒ€ë¦¬ì  ì¡°í•© (ì´ ${onSaleIndexCount}ê°œ ì²˜ë¦¬)`);

    // 5. ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ë°ì´í„° ì²˜ë¦¬ (POSë³„ í•„í„°ë§, ìµœì í™”)
    const reservationSiteRows = reservationSiteValues.slice(1);
    const customerList = [];

    // POSë³„ í•„í„°ë§ì„ ë¨¼ì € ìˆ˜í–‰í•˜ì—¬ ì²˜ë¦¬í•  ë°ì´í„° ì–‘ ì¤„ì´ê¸°
    // ë§¤í•‘ëœ POSëª…ë„ í¬í•¨í•˜ì—¬ í•„í„°ë§
    const targetPosNames = new Set([posName]);

    // ë§¤í•‘ëœ POSëª…ì—ì„œ ì›ë³¸ POSëª… ì°¾ê¸°
    for (const [originalName, mappedName] of posNameMapping.entries()) {
      if (mappedName === posName) {
        targetPosNames.add(originalName);
      }
    }

    // ì ‘ìˆ˜ìë³„ ë§¤í•‘ì—ì„œë„ ì›ë³¸ POSëª… ì°¾ê¸°
    for (const [key, mappedName] of posNameMappingWithReceiver.entries()) {
      if (mappedName === posName) {
        const originalName = key.split('_')[0]; // keyëŠ” "ì›ë³¸POSëª…_ì ‘ìˆ˜ì" í˜•íƒœ
        targetPosNames.add(originalName);
      }
    }

    console.log(`POS "${posName}" í•„í„°ë§ ëŒ€ìƒ:`, Array.from(targetPosNames));

    const filteredRows = reservationSiteRows.filter(row => {
      if (row.length < 30) return false;
      const rowPosName = (row[22] || '').toString().trim(); // Wì—´: POSëª…
      return targetPosNames.has(rowPosName);
    });

    console.log(`POS "${posName}" í•„í„°ë§ ê²°ê³¼: ${filteredRows.length}ê°œ í–‰ (ì „ì²´ ${reservationSiteRows.length}ê°œ ì¤‘)`);

    filteredRows.forEach((row, index) => {
      const reservationNumber = (row[8] || '').toString().trim(); // Iì—´: ì˜ˆì•½ë²ˆí˜¸
      const customerName = (row[7] || '').toString().trim(); // Hì—´: ê³ ê°ëª…
      const reservationDateTime = (row[14] || '').toString().trim(); // Oì—´: ì˜ˆì•½ì¼ì‹œ
      const model = (row[15] || '').toString().trim(); // Pì—´: ëª¨ë¸
      const capacity = (row[16] || '').toString().trim(); // Qì—´: ìš©ëŸ‰
      const color = (row[17] || '').toString().trim(); // Rì—´: ìƒ‰ìƒ
      const type = row.length > 31 ? (row[31] || '') : ''; // AFì—´: ìœ í˜•
      const storeCode = (row[23] || '').toString().trim(); // Xì—´: ëŒ€ë¦¬ì ì½”ë“œ
      const originalPosName = (row[22] || '').toString().trim(); // Wì—´: POSëª… (ì›ë³¸)
      const reservationMemo = row.length > 34 ? (row[34] || '') : ''; // AIì—´: ì˜ˆì•½ë©”ëª¨
      const receiver = (row[25] || '').toString().trim(); // Zì—´: ì ‘ìˆ˜ì

      if (!reservationNumber || !customerName || !model || !capacity || !color) return;

      // ì„œë¥˜ì ‘ìˆ˜ ì •ë³´ ì°¾ê¸° (ì¸ë±ìŠ¤ í™œìš©ìœ¼ë¡œ ë¹ ë¥¸ ê²€ìƒ‰)
      // ì˜ˆì•½ë²ˆí˜¸ë„ í•˜ì´í”ˆ ì œê±°í•˜ì—¬ ì •ê·œí™”ëœ í˜•íƒœë¡œ ë¹„êµ
      const normalizedReservationNumber = reservationNumber.replace(/-/g, '');
      const yardData = yardIndex.get(normalizedReservationNumber) || {};
      const receivedDateTime = yardData.receivedDateTime || '';
      const receivedMemo = yardData.receivedMemo || '';

      // ì˜¨ì„¸ì¼ì ‘ìˆ˜ ì •ë³´ ë§¤ì¹­ (ì˜¨ì„¸ì¼ â†’ ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ ìˆœì„œë¡œ ì°¾ê¸°)
      const onSaleKey = `${customerName}_${storeCode}`;
      let onSaleReceivedDate = onSaleIndex.get(onSaleKey) || '';

      // ì˜¨ì„¸ì¼ì—ì„œ ì°¾ì§€ ëª»í•œ ê²½ìš° ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ì—ì„œ ì°¾ê¸°
      if (!onSaleReceivedDate && mobileJoinIndex.has(normalizedReservationNumber)) {
        onSaleReceivedDate = mobileJoinIndex.get(normalizedReservationNumber);
        if (index < 5) {
          console.log(`  ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ì—ì„œ ì˜¨ì„¸ì¼ì ‘ìˆ˜ì¼ ì°¾ìŒ: "${onSaleReceivedDate}"`);
        }
      }

      // POSëª… ë§¤í•‘ ì ìš© (ì ‘ìˆ˜ìë³„ ë§¤í•‘ ìš°ì„ , ì¼ë°˜ ë§¤í•‘ ì°¨ì„ )
      let mappedPosName = originalPosName;
      if (originalPosName && receiver) {
        // ì ‘ìˆ˜ìë³„ ë§¤í•‘ ë¨¼ì € í™•ì¸
        const receiverKey = `${originalPosName}_${receiver}`;
        if (posNameMappingWithReceiver.has(receiverKey)) {
          mappedPosName = posNameMappingWithReceiver.get(receiverKey);
        } else if (posNameMapping.has(originalPosName)) {
          // ì¼ë°˜ ë§¤í•‘ í™•ì¸
          mappedPosName = posNameMapping.get(originalPosName);
        }
      } else if (originalPosName && posNameMapping.has(originalPosName)) {
        // ì¼ë°˜ ë§¤í•‘ë§Œ í™•ì¸
        mappedPosName = posNameMapping.get(originalPosName);
      }

      // ì²˜ìŒ 5ê°œ ê³ ê°ì˜ ì ‘ìˆ˜ì •ë³´ ë””ë²„ê¹… ë¡œê·¸
      if (index < 5) {
        console.log(`POSë³„ ê³ ê°ë¦¬ìŠ¤íŠ¸ ì ‘ìˆ˜ì •ë³´ ë§¤ì¹­: ê³ ê°ëª…="${customerName}", ì˜ˆì•½ë²ˆí˜¸="${reservationNumber}"`);
        console.log(`  ì •ê·œí™”ëœ ì˜ˆì•½ë²ˆí˜¸: "${normalizedReservationNumber}"`);
        console.log(`  ë§ˆë‹¹ì ‘ìˆ˜ ì¸ë±ìŠ¤ ì¡´ì¬: ${yardIndex.has(normalizedReservationNumber)}`);
        console.log(`  ì ‘ìˆ˜ì¼ì‹œ: "${receivedDateTime}"`);
        console.log(`  ì ‘ìˆ˜ë©”ëª¨: "${receivedMemo}"`);
        console.log(`  ì˜¨ì„¸ì¼ì ‘ìˆ˜ì¼: "${onSaleReceivedDate}"`);
        console.log(`  ëª¨ë¸ëª…: "${model}"`);
        console.log(`  ì›ë³¸ POSëª…: "${originalPosName}" -> ë§¤í•‘ëœ POSëª…: "${mappedPosName}"`);
      }

      // ëª¨ë¸/ìš©ëŸ‰/ìƒ‰ìƒ ì¡°í•©
      const modelCapacityColor = [model, capacity, color].filter(Boolean).join('/');

      customerList.push({
        customerName,
        reservationNumber,
        reservationDateTime,
        yardReceivedDate: receivedDateTime,
        onSaleReceivedDate,
        modelCapacityColor, // ëª¨ë¸&ìš©ëŸ‰&ìƒ‰ìƒìœ¼ë¡œ ë³€ê²½
        type,
        storeCode,
        posName: mappedPosName, // ë§¤í•‘ëœ POSëª… ì‚¬ìš©
        reservationMemo,
        yardReceivedMemo: receivedMemo,
        receiver
      });
    });

    // 6. ì˜ˆì•½ì¼ì‹œë¡œ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬
    customerList.sort((a, b) => {
      const dateA = new Date(a.reservationDateTime);
      const dateB = new Date(b.reservationDateTime);
      return dateA - dateB;
    });

    console.log(`POSë³„ ê³ ê° ë¦¬ìŠ¤íŠ¸ ìƒì„± ì™„ë£Œ: ${customerList.length}ê°œ ê³ ê°`);

    const result = {
      success: true,
      data: customerList,
      total: customerList.length,
      posName: posName
    };

    // ê²°ê³¼ ìºì‹± (5ë¶„ TTL)
    cacheUtils.set(cacheKey, result, 300);

    res.json(result);

  } catch (error) {
    console.error('POSë³„ ëª¨ë¸ìƒ‰ìƒ ë°ì´í„° ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to load POS-specific data',
      message: error.message
    });
  }
});

// ëª¨ë¸ë³„ ê³ ê° ë¦¬ìŠ¤íŠ¸ API (ìµœì í™” ë²„ì „)
app.get('/api/reservation-sales/customers/by-model/:model', async (req, res) => {
  try {
    const { model } = req.params;
    console.log(`ëª¨ë¸ë³„ ê³ ê° ë¦¬ìŠ¤íŠ¸ ìš”ì²­: ${model}`);

    // ìºì‹œ í‚¤ ìƒì„± (POS ë§¤í•‘ í¬í•¨)
    const cacheKey = `model_customer_list_with_pos_mapping_${model}`;

    // ìºì‹œì—ì„œ ë¨¼ì € í™•ì¸ (5ë¶„ TTL)
    const cachedData = cacheUtils.get(cacheKey);
    if (cachedData) {
      console.log(`ìºì‹œëœ ëª¨ë¸ë³„ ê³ ê° ë¦¬ìŠ¤íŠ¸ ë°˜í™˜: ${model}`);
      return res.json(cachedData);
    }

    // 1. ì •ê·œí™”ëœ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ìºì‹œ í™œìš©)
    const normalizedCacheKey = 'normalized_data_cache';
    let normalizedData = cacheUtils.get(normalizedCacheKey);

    if (!normalizedData) {
      const normalizedResponse = await fetch(`${process.env.REACT_APP_API_URL || 'http://localhost:4000'}/api/reservation-settings/normalized-data`);
      if (!normalizedResponse.ok) {
        throw new Error('ì •ê·œí™”ëœ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      }
      normalizedData = await normalizedResponse.json();

      if (!normalizedData.success) {
        throw new Error('ì •ê·œí™”ëœ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨');
      }

      // ì •ê·œí™” ë°ì´í„° ìºì‹± (10ë¶„ TTL)
      cacheUtils.set(normalizedCacheKey, normalizedData, 600);
    }

    // 2. ë³‘ë ¬ë¡œ ì‹œíŠ¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì˜¨ì„¸ì¼, ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ í¬í•¨)
    const [reservationSiteValues, yardValues, onSaleValues, mobileJoinValues] = await Promise.all([
      getSheetValues('ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸'),
      getSheetValues('ë§ˆë‹¹ì ‘ìˆ˜'),
      getSheetValues('ì˜¨ì„¸ì¼'),
      getSheetValues('ëª¨ë°”ì¼ê°€ì…ë‚´ì—­')
    ]);

    // 3. POSì½”ë“œë³€ê²½ì„¤ì • ì‹œíŠ¸ ë¡œë“œ (ì„ íƒì‚¬í•­ - ì—†ì–´ë„ ì—ëŸ¬ ë°œìƒí•˜ì§€ ì•ŠìŒ)
    let posCodeMappingValues = null;
    try {
      posCodeMappingValues = await getSheetValues('POSì½”ë“œë³€ê²½ì„¤ì •');
      console.log('ëª¨ë¸ë³„ ê³ ê°ë¦¬ìŠ¤íŠ¸: POSì½”ë“œë³€ê²½ì„¤ì • ì‹œíŠ¸ ë¡œë“œ ì„±ê³µ');
    } catch (error) {
      console.log('ëª¨ë¸ë³„ ê³ ê°ë¦¬ìŠ¤íŠ¸: POSì½”ë“œë³€ê²½ì„¤ì • ì‹œíŠ¸ ë¡œë“œ ì‹¤íŒ¨ (ë¬´ì‹œë¨):', error.message);
      posCodeMappingValues = [];
    }

    // POSì½”ë“œ/ì´ë¦„ ë§¤í•‘ í…Œì´ë¸” ìƒì„±
    const posCodeMapping = new Map();
    const posNameMapping = new Map();
    const posNameMappingWithReceiver = new Map();

    if (posCodeMappingValues && posCodeMappingValues.length > 1) {
      posCodeMappingValues.slice(1).forEach(row => {
        if (row.length >= 4) {
          const originalCode = (row[0] || '').toString().trim();
          const newCode = (row[1] || '').toString().trim();
          const originalName = (row[2] || '').toString().trim();
          const newName = (row[3] || '').toString().trim();
          const receiver = row.length > 4 ? (row[4] || '').toString().trim() : '';

          if (originalCode && newCode) {
            posCodeMapping.set(originalCode, newCode);
          }

          if (originalName && newName) {
            if (receiver) {
              // ì ‘ìˆ˜ìë³„ ë§¤í•‘
              const key = `${originalName}_${receiver}`;
              posNameMappingWithReceiver.set(key, newName);
            } else {
              // ì¼ë°˜ ë§¤í•‘
              posNameMapping.set(originalName, newName);
            }
          }
        }
      });
      console.log(`ëª¨ë¸ë³„ ê³ ê°ë¦¬ìŠ¤íŠ¸: POSì½”ë“œ ë§¤í•‘ ${posCodeMapping.size}ê°œ, POSëª… ë§¤í•‘ ${posNameMapping.size}ê°œ, ì ‘ìˆ˜ìë³„ ë§¤í•‘ ${posNameMappingWithReceiver.size}ê°œ ë¡œë“œ`);

      // ë§¤í•‘ í…Œì´ë¸” ë‚´ìš© ë””ë²„ê¹… (ì²˜ìŒ 5ê°œë§Œ)
      console.log('ëª¨ë¸ë³„ POSëª… ë§¤í•‘ í…Œì´ë¸” ë‚´ìš©:');
      let count = 0;
      for (const [original, mapped] of posNameMapping.entries()) {
        if (count < 5) {
          console.log(`  "${original}" -> "${mapped}"`);
          count++;
        }
      }

      console.log('ëª¨ë¸ë³„ ì ‘ìˆ˜ìë³„ POSëª… ë§¤í•‘ í…Œì´ë¸” ë‚´ìš©:');
      count = 0;
      for (const [key, mapped] of posNameMappingWithReceiver.entries()) {
        if (count < 5) {
          console.log(`  "${key}" -> "${mapped}"`);
          count++;
        }
      }
    }

    if (!reservationSiteValues || reservationSiteValues.length < 2) {
      throw new Error('ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    if (!yardValues || yardValues.length < 2) {
      throw new Error('ë§ˆë‹¹ì ‘ìˆ˜ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    if (!mobileJoinValues || mobileJoinValues.length < 2) {
      console.log('ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ë¬´ì‹œë¨)');
    }

    // ì˜¨ì„¸ì¼ ë°ì´í„° ì¸ë±ì‹± (ê³ ê°ëª… + ëŒ€ë¦¬ì ì½”ë“œ ê¸°ì¤€)
    const onSaleIndex = new Map();
    let onSaleIndexCount = 0;
    onSaleValues.slice(1).forEach(row => {
      const customerName = row[2] || '';
      const storeCode = row[12] || '';
      const receivedDate = row[5] || '';
      if (customerName && storeCode) {
        const key = `${customerName}_${storeCode}`;
        onSaleIndex.set(key, receivedDate);
        onSaleIndexCount++;
      }
    });

    // ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ ë°ì´í„° ì¸ë±ì‹± (ì˜ˆì•½ë²ˆí˜¸ ê¸°ì¤€)
    const mobileJoinIndex = new Map();
    let mobileJoinIndexCount = 0;

    if (mobileJoinValues && mobileJoinValues.length > 1) {
      mobileJoinValues.slice(1).forEach((row, index) => {
        const reservationNumber = (row[6] || '').toString().trim(); // Gì—´ (7ë²ˆì§¸, 0ë¶€í„° ì‹œì‘): ì˜ˆì•½ë²ˆí˜¸
        const reservationDateTime = (row[9] || '').toString().trim(); // Jì—´ (10ë²ˆì§¸, 0ë¶€í„° ì‹œì‘): ì˜ˆì•½ì¼ì‹œ

        if (reservationNumber) {
          // ì˜ˆì•½ë²ˆí˜¸ ì •ê·œí™” (í•˜ì´í”ˆ ì œê±°)
          const normalizedReservationNumber = reservationNumber.replace(/-/g, '');
          mobileJoinIndex.set(normalizedReservationNumber, reservationDateTime);
          mobileJoinIndexCount++;

          // ì²˜ìŒ 5ê°œë§Œ ë””ë²„ê¹… ë¡œê·¸
          if (index < 5) {
            console.log(`ëª¨ë¸ë³„ ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ í–‰ ${index + 2}: ì˜ˆì•½ë²ˆí˜¸="${reservationNumber}", ì •ê·œí™”="${normalizedReservationNumber}", ì˜ˆì•½ì¼ì‹œ="${reservationDateTime}"`);
          }
        }
      });
    }

    console.log(`ëª¨ë¸ë³„ ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ ë°ì´í„° ì¸ë±ì‹± ì™„ë£Œ: ${mobileJoinIndex.size}ê°œ ì˜ˆì•½ë²ˆí˜¸ (ì´ ${mobileJoinIndexCount}ê°œ ì²˜ë¦¬)`);

    // 3. ì •ê·œí™” ê·œì¹™ ë§¤í•‘ ìƒì„±
    const normalizationRules = normalizedData.normalizationRules || [];
    const ruleMap = new Map();

    normalizationRules.forEach(rule => {
      const key = rule.reservationSite.replace(/\s+/g, '');
      ruleMap.set(key, rule.normalizedModel);
    });

    // 4. ë§ˆë‹¹ì ‘ìˆ˜ ë°ì´í„° ì¸ë±ì‹± (ì˜ˆì•½ë²ˆí˜¸ë³„ ë¹ ë¥¸ ê²€ìƒ‰ì„ ìœ„í•´)
    const yardIndex = new Map();
    let yardIndexCount = 0;
    yardValues.slice(1).forEach((yardRow, index) => {
      if (yardRow.length >= 22) { // Vì—´ê¹Œì§€ í•„ìš”í•˜ë¯€ë¡œ ìµœì†Œ 22ê°œ ì»¬ëŸ¼
        const uValue = (yardRow[20] || '').toString().trim(); // Uì—´ (21ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
        const vValue = (yardRow[21] || '').toString().trim(); // Vì—´ (22ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
        const receivedDateTime = (yardRow[11] || '').toString().trim(); // Lì—´ (12ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
        const receivedMemo = (yardRow[20] || '').toString().trim(); // Uì—´ (21ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)

        // ì˜ˆì•½ë²ˆí˜¸ íŒ¨í„´ ì°¾ê¸° (í•˜ì´í”ˆì´ ì—†ëŠ” í˜•íƒœ: XX000000)
        const reservationPattern = /[A-Z]{2}\d{6}/g;
        const uMatches = uValue.match(reservationPattern) || [];
        const vMatches = vValue.match(reservationPattern) || [];

        // ëª¨ë“  ì˜ˆì•½ë²ˆí˜¸ë¥¼ ì¸ë±ìŠ¤ì— ì¶”ê°€ (ì´ë¯¸ í•˜ì´í”ˆì´ ì—†ëŠ” í˜•íƒœ)
        [...uMatches, ...vMatches].forEach(match => {
          const normalizedReservationNumber = match;
          yardIndex.set(normalizedReservationNumber, {
            receivedDateTime,
            receivedMemo
          });
          yardIndexCount++;

          // ì²˜ìŒ 5ê°œ ë§ˆë‹¹ì ‘ìˆ˜ ë°ì´í„° ë¡œê·¸
          if (index < 5) {
            console.log(`ëª¨ë¸ë³„ ë§ˆë‹¹ì ‘ìˆ˜ ì¸ë±ì‹±: ì›ë³¸="${match}" -> ì •ê·œí™”="${normalizedReservationNumber}"`);
            console.log(`  Uì—´: "${uValue}", Vì—´: "${vValue}"`);
            console.log(`  ì ‘ìˆ˜ì¼ì‹œ: "${receivedDateTime}", ì ‘ìˆ˜ë©”ëª¨: "${receivedMemo}"`);
          }
        });
      }
    });

    console.log(`ëª¨ë¸ë³„ ë§ˆë‹¹ì ‘ìˆ˜ ë°ì´í„° ì¸ë±ì‹± ì™„ë£Œ: ${yardIndex.size}ê°œ ì˜ˆì•½ë²ˆí˜¸ (ì´ ${yardIndexCount}ê°œ ì²˜ë¦¬)`);
    console.log(`ëª¨ë¸ë³„ ë§ˆë‹¹ì ‘ìˆ˜ ì˜ˆì•½ë²ˆí˜¸ ìƒ˜í”Œ:`, Array.from(yardIndex.keys()).slice(0, 5));

    // 5. ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ë°ì´í„° ì²˜ë¦¬ (ëª¨ë¸ë³„ í•„í„°ë§, ìµœì í™”)
    const reservationSiteRows = reservationSiteValues.slice(1);
    const customerList = [];

    // ë””ë²„ê¹…: ìš”ì²­ëœ ëª¨ë¸ëª…ê³¼ ì‹¤ì œ ë°ì´í„°ì˜ ëª¨ë¸ëª… ë¹„êµ
    console.log(`ëª¨ë¸ë³„ ê³ ê°ë¦¬ìŠ¤íŠ¸ í•„í„°ë§: ìš”ì²­ëœ ëª¨ë¸ëª…="${req.params.model}"`);

    // ì‹¤ì œ ë°ì´í„°ì—ì„œ ì‚¬ìš©ë˜ëŠ” ëª¨ë¸ëª…ë“¤ ìˆ˜ì§‘ (ì²˜ìŒ 20ê°œ)
    const actualModels = new Set();
    reservationSiteRows.slice(0, 20).forEach((row, index) => {
      if (row.length >= 16) {
        const actualModel = (row[15] || '').toString().trim(); // Pì—´: ëª¨ë¸
        if (actualModel) {
          actualModels.add(actualModel);
        }
      }
    });
    console.log(`ì‹¤ì œ ë°ì´í„°ì˜ ëª¨ë¸ëª… ìƒ˜í”Œ (ì²˜ìŒ 20ê°œ):`, Array.from(actualModels));

    reservationSiteRows.forEach((row, index) => {
      if (row.length < 30) return;

      const reservationNumber = (row[8] || '').toString().trim(); // Iì—´: ì˜ˆì•½ë²ˆí˜¸
      const customerName = (row[7] || '').toString().trim(); // Hì—´: ê³ ê°ëª…
      const reservationDateTime = (row[14] || '').toString().trim(); // Oì—´: ì˜ˆì•½ì¼ì‹œ
      const model = (row[15] || '').toString().trim(); // Pì—´: ëª¨ë¸
      const capacity = (row[16] || '').toString().trim(); // Qì—´: ìš©ëŸ‰
      const color = (row[17] || '').toString().trim(); // Rì—´: ìƒ‰ìƒ
      const type = row.length > 31 ? (row[31] || '') : ''; // AFì—´: ìœ í˜•
      const storeCode = (row[23] || '').toString().trim(); // Xì—´: ëŒ€ë¦¬ì ì½”ë“œ
      const posName = (row[22] || '').toString().trim(); // Wì—´: POSëª…
      const reservationMemo = row.length > 34 ? (row[34] || '') : ''; // AIì—´: ì˜ˆì•½ë©”ëª¨
      const receiver = (row[25] || '').toString().trim(); // Zì—´: ì ‘ìˆ˜ì

      if (!reservationNumber || !customerName || !model || !capacity || !color) return;

      // ëª¨ë¸ í•„í„°ë§ (ëª¨ë¸+ìš©ëŸ‰+ìƒ‰ìƒ ì¡°í•©ìœ¼ë¡œ ì •í™•íˆ ë¹„êµ)
      // ìš”ì²­ëœ ëª¨ë¸ëª…ì„ ëª¨ë¸/ìš©ëŸ‰/ìƒ‰ìƒìœ¼ë¡œ ë¶„í•´
      const requestedParts = req.params.model.split(' ');
      const requestedModel = requestedParts.slice(0, 2).join(' '); // "Z Flip7"
      const requestedCapacity = requestedParts[2]; // "512G"
      const requestedColor = requestedParts.slice(3).join(' '); // "ì œíŠ¸ë¸”ë™"

      // ë°ì´í„°ì˜ ëª¨ë¸/ìš©ëŸ‰/ìƒ‰ìƒê³¼ ë¹„êµ
      if (model !== requestedModel || capacity !== requestedCapacity || color !== requestedColor) {
        // ì²˜ìŒ 10ê°œë§Œ ë¡œê·¸ ì¶œë ¥
        if (index < 10) {
          console.log(`ëª¨ë¸ ë¶ˆì¼ì¹˜: ë°ì´í„°="${model} ${capacity} ${color}" vs ìš”ì²­="${requestedModel} ${requestedCapacity} ${requestedColor}"`);
        }
        return;
      }

      // ì„œë¥˜ì ‘ìˆ˜ ì •ë³´ ì°¾ê¸° (ì¸ë±ìŠ¤ í™œìš©ìœ¼ë¡œ ë¹ ë¥¸ ê²€ìƒ‰)
      // ì˜ˆì•½ë²ˆí˜¸ë„ í•˜ì´í”ˆ ì œê±°í•˜ì—¬ ì •ê·œí™”ëœ í˜•íƒœë¡œ ë¹„êµ
      const normalizedReservationNumber = reservationNumber.replace(/-/g, '');
      const yardData = yardIndex.get(normalizedReservationNumber) || {};
      const receivedDateTime = yardData.receivedDateTime || '';
      const receivedMemo = yardData.receivedMemo || '';

      // ì˜¨ì„¸ì¼ ì ‘ìˆ˜ì¼ (ì˜¨ì„¸ì¼ â†’ ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ ìˆœì„œë¡œ ì°¾ê¸°)
      const onSaleKey = `${customerName}_${storeCode}`;
      let onSaleReceivedDate = onSaleIndex.get(onSaleKey) || '';

      // ì˜¨ì„¸ì¼ì—ì„œ ì°¾ì§€ ëª»í•œ ê²½ìš° ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ì—ì„œ ì°¾ê¸°
      if (!onSaleReceivedDate && mobileJoinIndex.has(normalizedReservationNumber)) {
        onSaleReceivedDate = mobileJoinIndex.get(normalizedReservationNumber);
        if (index < 5) {
          console.log(`  ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ì—ì„œ ì˜¨ì„¸ì¼ì ‘ìˆ˜ì¼ ì°¾ìŒ: "${onSaleReceivedDate}"`);
        }
      }

      // POSëª… ë§¤í•‘ ì ìš© (ì ‘ìˆ˜ìë³„ ë§¤í•‘ ìš°ì„ , ì¼ë°˜ ë§¤í•‘ ì°¨ì„ )
      let mappedPosName = posName;
      if (posName && receiver) {
        // ì ‘ìˆ˜ìë³„ ë§¤í•‘ ë¨¼ì € í™•ì¸
        const receiverKey = `${posName}_${receiver}`;
        if (posNameMappingWithReceiver.has(receiverKey)) {
          mappedPosName = posNameMappingWithReceiver.get(receiverKey);
        } else if (posNameMapping.has(posName)) {
          // ì¼ë°˜ ë§¤í•‘ í™•ì¸
          mappedPosName = posNameMapping.get(posName);
        }
      } else if (posName && posNameMapping.has(posName)) {
        // ì¼ë°˜ ë§¤í•‘ë§Œ í™•ì¸
        mappedPosName = posNameMapping.get(posName);
      }

      // ì²˜ìŒ 5ê°œ ê³ ê°ì˜ ì ‘ìˆ˜ì •ë³´ ë””ë²„ê¹… ë¡œê·¸
      if (index < 5) {
        console.log(`ëª¨ë¸ë³„ ê³ ê°ë¦¬ìŠ¤íŠ¸ ì ‘ìˆ˜ì •ë³´ ë§¤ì¹­: ê³ ê°ëª…="${customerName}", ì˜ˆì•½ë²ˆí˜¸="${reservationNumber}"`);
        console.log(`  ì •ê·œí™”ëœ ì˜ˆì•½ë²ˆí˜¸: "${normalizedReservationNumber}"`);
        console.log(`  ë§ˆë‹¹ì ‘ìˆ˜ ì¸ë±ìŠ¤ ì¡´ì¬: ${yardIndex.has(normalizedReservationNumber)}`);
        console.log(`  ë§ˆë‹¹ì ‘ìˆ˜ì¼: "${receivedDateTime}"`);
        console.log(`  ë§ˆë‹¹ë©”ëª¨: "${receivedMemo}"`);
        console.log(`  ì˜¨ì„¸ì¼ì ‘ìˆ˜ì¼: "${onSaleReceivedDate}"`);
        console.log(`  ëª¨ë¸ëª…: "${model}"`);
        console.log(`  ì›ë³¸ POSëª…: "${posName}" -> ë§¤í•‘ëœ POSëª…: "${mappedPosName}"`);
      }

      // ëª¨ë¸/ìš©ëŸ‰/ìƒ‰ìƒ ì¡°í•©
      const modelCapacityColor = [model, capacity, color].filter(Boolean).join('/');

      customerList.push({
        customerName,
        reservationNumber,
        reservationDateTime,
        yardReceivedDate: receivedDateTime,
        onSaleReceivedDate,
        modelCapacityColor, // ëª¨ë¸&ìš©ëŸ‰&ìƒ‰ìƒìœ¼ë¡œ ë³€ê²½
        type,
        storeCode,
        posName: mappedPosName, // ë§¤í•‘ëœ POSëª… ì‚¬ìš©
        reservationMemo,
        yardReceivedMemo: receivedMemo,
        receiver
      });
    });

    // 6. ì˜ˆì•½ì¼ì‹œë¡œ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬
    customerList.sort((a, b) => {
      const dateA = new Date(a.reservationDateTime);
      const dateB = new Date(b.reservationDateTime);
      return dateA - dateB;
    });

    console.log(`ëª¨ë¸ë³„ ê³ ê° ë¦¬ìŠ¤íŠ¸ ìƒì„± ì™„ë£Œ: ${customerList.length}ê°œ ê³ ê°`);

    const result = {
      success: true,
      data: customerList,
      total: customerList.length,
      model: req.params.model
    };

    // ê²°ê³¼ ìºì‹± (5ë¶„ TTL)
    cacheUtils.set(cacheKey, result, 300);

    res.json(result);

  } catch (error) {
    console.error('ëª¨ë¸ë³„ ê³ ê° ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to load model-specific customer data',
      message: error.message
    });
  }
});

// ëª¨ë¸ë³„ ê³ ê° ë¦¬ìŠ¤íŠ¸ API (model-color ê²½ë¡œ)
app.get('/api/reservation-sales/model-color/by-model/:model', async (req, res) => {
  try {
    const { model } = req.params;
    console.log(`ëª¨ë¸ë³„ ê³ ê° ë¦¬ìŠ¤íŠ¸ ìš”ì²­ (model-color): ${model}`);

    // ê¸°ì¡´ customers/by-model APIë¥¼ ì¬ì‚¬ìš©
    const response = await fetch(`${process.env.REACT_APP_API_URL || 'http://localhost:4000'}/api/reservation-sales/customers/by-model/${encodeURIComponent(model)}`);

    if (!response.ok) {
      throw new Error('ëª¨ë¸ë³„ ê³ ê° ë¦¬ìŠ¤íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    const data = await response.json();
    res.json(data);

  } catch (error) {
    console.error('ëª¨ë¸ë³„ ê³ ê° ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ ì˜¤ë¥˜ (model-color):', error);
    res.status(500).json({
      success: false,
      error: 'Failed to load model-specific customer data',
      message: error.message
    });
  }
});

// í‘¸ì‹œ êµ¬ë… ì •ë³´ ê´€ë¦¬ API
app.get('/api/push/subscriptions', async (req, res) => {
  try {
    // ë©”ëª¨ë¦¬ì™€ ì‹œíŠ¸ì˜ ëª¨ë“  êµ¬ë… ì •ë³´ ìˆ˜ì§‘
    const allSubscriptions = new Map(pushSubscriptions);

    // ì‹œíŠ¸ì—ì„œ ì¶”ê°€ êµ¬ë… ì •ë³´ ë¡œë“œ
    try {
      const agentValues = await getSheetValues(AGENT_SHEET_NAME);
      if (agentValues && agentValues.length > 3) {
        const agentRows = agentValues.slice(3);
        agentRows.forEach(row => {
          const userId = row[2]; // Cì—´: ì—°ë½ì²˜(ì•„ì´ë””)
          const subscriptionJson = row[16]; // Qì—´: í‘¸ì‹œ êµ¬ë… ì •ë³´ (ê¸°ì¡´ Oì—´ â†’ Qì—´ë¡œ ì´ë™)

          if (userId && subscriptionJson && !allSubscriptions.has(userId)) {
            try {
              // ë¹ˆ ë¬¸ìì—´ì´ë‚˜ "O" ê°™ì€ ë‹¨ì¼ ë¬¸ìëŠ” JSONì´ ì•„ë‹ˆë¯€ë¡œ ìŠ¤í‚µ
              if (subscriptionJson.trim().length > 1 && subscriptionJson.trim().startsWith('{')) {
                const subscription = JSON.parse(subscriptionJson);
                allSubscriptions.set(userId, subscription);
              }
            } catch (error) {
              console.error(`êµ¬ë… ì •ë³´ íŒŒì‹± ì‹¤íŒ¨ (${userId}):`, error);
              console.error(`  - ì›ë³¸ ê°’: "${subscriptionJson}"`);
            }
          }
        });
      }
    } catch (error) {
      console.error('ì‹œíŠ¸ì—ì„œ êµ¬ë… ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
    }

    const subscriptions = Array.from(allSubscriptions.entries()).map(([userId, subscription]) => ({
      userId,
      endpoint: subscription.endpoint,
      hasKeys: !!subscription.keys,
      source: pushSubscriptions.has(userId) ? 'memory' : 'sheet'
    }));

    res.json({
      success: true,
      subscriptions,
      totalCount: subscriptions.length,
      memoryCount: pushSubscriptions.size,
      sheetCount: subscriptions.length - pushSubscriptions.size
    });
  } catch (error) {
    console.error('í‘¸ì‹œ êµ¬ë… ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({ success: false, error: 'êµ¬ë… ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨' });
  }
});

// í‘¸ì‹œ ì•Œë¦¼ ì „ì†¡ (ëª¨ë“  êµ¬ë…ì)
app.post('/api/push/send-all', async (req, res) => {
  try {
    const { notification } = req.body;

    if (!notification) {
      return res.status(400).json({
        success: false,
        error: 'ì•Œë¦¼ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }

    const payload = JSON.stringify({
      title: notification.title || 'ìƒˆë¡œìš´ ì•Œë¦¼',
      body: notification.message || 'ìƒˆë¡œìš´ ì•Œë¦¼ì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤.',
      icon: '/logo192.png',
      badge: '/logo192.png',
      tag: 'assignment-notification',
      data: {
        url: '/',
        timestamp: Date.now(),
        ...notification.data
      }
    });

    const results = [];
    const expiredSubscriptions = [];

    // ë©”ëª¨ë¦¬ì™€ ì‹œíŠ¸ì˜ ëª¨ë“  êµ¬ë… ì •ë³´ ìˆ˜ì§‘
    const allSubscriptions = new Map(pushSubscriptions);

    // ì‹œíŠ¸ì—ì„œ ì¶”ê°€ êµ¬ë… ì •ë³´ ë¡œë“œ
    try {
      const agentValues = await getSheetValues(AGENT_SHEET_NAME);
      if (agentValues && agentValues.length > 3) {
        const agentRows = agentValues.slice(3);
        agentRows.forEach(row => {
          const userId = row[2]; // Cì—´: ì—°ë½ì²˜(ì•„ì´ë””)
          const subscriptionJson = row[16]; // Qì—´: í‘¸ì‹œ êµ¬ë… ì •ë³´ (ê¸°ì¡´ Oì—´ â†’ Qì—´ë¡œ ì´ë™)

          if (userId && subscriptionJson && !allSubscriptions.has(userId)) {
            try {
              // ë¹ˆ ë¬¸ìì—´ì´ë‚˜ "O" ê°™ì€ ë‹¨ì¼ ë¬¸ìëŠ” JSONì´ ì•„ë‹ˆë¯€ë¡œ ìŠ¤í‚µ
              if (subscriptionJson.trim().length > 1 && subscriptionJson.trim().startsWith('{')) {
                const subscription = JSON.parse(subscriptionJson);
                allSubscriptions.set(userId, subscription);
              }
            } catch (error) {
              console.error(`êµ¬ë… ì •ë³´ íŒŒì‹± ì‹¤íŒ¨ (${userId}):`, error);
              console.error(`  - ì›ë³¸ ê°’: "${subscriptionJson}"`);
            }
          }
        });
      }
    } catch (error) {
      console.error('ì‹œíŠ¸ì—ì„œ êµ¬ë… ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
    }

    for (const [userId, subscription] of allSubscriptions.entries()) {
      try {
        await webpush.sendNotification(subscription, payload);
        results.push({ userId, success: true });
        console.log(`í‘¸ì‹œ ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ: ${userId}`);
      } catch (error) {
        console.error(`í‘¸ì‹œ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨ (${userId}):`, error);
        results.push({ userId, success: false, error: error.message });

        // êµ¬ë…ì´ ë§Œë£Œëœ ê²½ìš° ì‚­ì œ
        if (error.statusCode === 410) {
          expiredSubscriptions.push(userId);
        }
      }
    }

    // ë§Œë£Œëœ êµ¬ë… ì‚­ì œ
    expiredSubscriptions.forEach(userId => {
      pushSubscriptions.delete(userId);
      savePushSubscriptionToSheet(userId, null);
      console.log(`ë§Œë£Œëœ êµ¬ë… ì‚­ì œ: ${userId}`);
    });

    res.json({
      success: true,
      results,
      expiredCount: expiredSubscriptions.length,
      totalSent: allSubscriptions.size
    });
  } catch (error) {
    console.error('í‘¸ì‹œ ì•Œë¦¼ ì „ì†¡ ì˜¤ë¥˜:', error);
    res.status(500).json({ success: false, error: 'í‘¸ì‹œ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨' });
  }
});

// ê°œí†µì¼ì‹œë¶„ ì •ê·œí™” í•¨ìˆ˜
function normalizeActivationDateTime(manualDate, manualTime, systemDate, systemHour, systemMinute) {
  try {
    // ìˆ˜ê¸°ì´ˆ ë°ì´í„° ì •ê·œí™”
    let manualDateTime = '';
    if (manualDate && manualTime) {
      const date = manualDate.trim();
      const time = manualTime.toString().trim();

      if (date && time && time.length >= 4) {
        const hour = time.substring(0, 2);
        const minute = time.substring(2, 4);

        // ìˆ˜ê¸°ì´ˆ ë¶„ê°’ì„ 5ë¶„ ë‹¨ìœ„ë¡œ ë‚´ë¦¼ì°¨ìˆœ ì²˜ë¦¬
        const minuteNum = parseInt(minute, 10);
        const normalizedMinute = Math.floor(minuteNum / 5) * 5;
        const normalizedMinuteStr = normalizedMinute.toString().padStart(2, '0');

        manualDateTime = `${date} ${hour}:${normalizedMinuteStr}`;
      }
    }

    // í°í´ê°œí†µë°ì´í„° ì •ê·œí™”
    let systemDateTime = '';
    if (systemDate && systemHour && systemMinute) {
      const date = systemDate.trim();
      const hour = systemHour.toString().replace('ì‹œ', '').trim();
      const minute = systemMinute.toString().replace('ë¶„', '').trim();

      if (date && hour && minute) {
        // í°í´ê°œí†µë°ì´í„° ì‹œê°’ê³¼ ë¶„ê°’ì„ 2ìë¦¬ í˜•ì‹ìœ¼ë¡œ ì •ê·œí™”
        const hourNum = parseInt(hour, 10);
        const minuteNum = parseInt(minute, 10);
        const normalizedHourStr = hourNum.toString().padStart(2, '0');
        const normalizedMinuteStr = minuteNum.toString().padStart(2, '0');

        systemDateTime = `${date} ${normalizedHourStr}:${normalizedMinuteStr}`;
      }
    }

    return { manualDateTime, systemDateTime };
  } catch (error) {
    console.error('ê°œí†µì¼ì‹œë¶„ ì •ê·œí™” ì˜¤ë¥˜:', error);
    return { manualDateTime: '', systemDateTime: '' };
  }
}

// ì»¬ëŸ¼ ì„¤ì • ê´€ë¦¬ API
app.get('/api/inspection/columns', async (req, res) => {
  try {
    // í˜„ì¬ ì»¬ëŸ¼ ì„¤ì • ë°˜í™˜
    const columnSettings = {
      manualKeyColumn: 'U', // ìˆ˜ê¸°ì´ˆ ê°€ì…ë²ˆí˜¸ ì»¬ëŸ¼
      manualKeyColumnName: 'ê°€ì…ë²ˆí˜¸',
      systemKeyColumn: 'BW', // í°í´ê°œí†µë°ì´í„° ê°€ì…ë²ˆí˜¸ ì»¬ëŸ¼
      systemKeyColumnName: 'ê°€ì…ë²ˆí˜¸',
      systemAgentColumn: 'BR', // í°í´ê°œí†µë°ì´í„° ë“±ë¡ì§ì› ì»¬ëŸ¼
      systemAgentColumnName: 'ë“±ë¡ì§ì›',
      systemMemo2Column: 'BP', // í°í´ê°œí†µë°ì´í„° ë©”ëª¨2 ì»¬ëŸ¼
      systemMemo2ColumnName: 'ë©”ëª¨2',
      // ë™ì  ë§¤ì¹­ ì„¤ì •
      dynamicMappings: [
        {
          key: 'store_code',
          manualColumn: 'O',
          manualColumnName: 'ëŒ€ë¦¬ì ì½”ë“œ',
          systemColumn: 'BX',
          systemColumnName: 'ë©”ëª¨2',
          description: 'ëŒ€ë¦¬ì ì½”ë“œ ë¹„êµ (ë©”ëª¨2ì—ì„œ ìˆ«ì ì¶”ì¶œ)',
          regex: '\\d+',
          enabled: true
        },
        {
          key: 'activation_datetime',
          manualColumns: ['AD', 'AE'],
          manualColumnNames: ['ê°€ì…ì¼ì', 'ê°œí†µì‹œê°„'],
          systemColumns: ['J', 'K', 'L'],
          systemColumnNames: ['ê°œí†µì¼', 'ê°œí†µì‹œ', 'ê°œí†µë¶„'],
          description: 'ê°œí†µì¼ì‹œë¶„ ë¹„êµ (ì´ˆ ì œì™¸, 24ì‹œê°„ í˜•ì‹)',
          enabled: true
        },
        {
          key: 'model_serial',
          manualColumns: ['AM', 'AN'],
          manualColumnNames: ['ê°œí†µëª¨ë¸', 'íŒë§¤ëª¨ë¸ì¼ë ¨ë²ˆí˜¸'],
          systemColumns: ['V', 'X'],
          systemColumnNames: ['ëª¨ë¸ëª…', 'ì¼ë ¨ë²ˆí˜¸'],
          description: 'ëª¨ë¸ëª…ê³¼ ì¼ë ¨ë²ˆí˜¸ ë¹„êµ (ëª¨ë¸ëª… ì •ê·œí™”, ì¼ë ¨ë²ˆí˜¸ 6ìë¦¬ ë¹„êµ)',
          enabled: true
        }
      ]
    };

    res.json({
      success: true,
      settings: columnSettings
    });
  } catch (error) {
    console.error('Error fetching column settings:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to fetch column settings',
      message: error.message
    });
  }
});

// ì»¬ëŸ¼ ì„¤ì • ì—…ë°ì´íŠ¸ API
app.post('/api/inspection/columns', async (req, res) => {
  try {
    const { settings } = req.body;

    if (!settings) {
      return res.status(400).json({
        success: false,
        error: 'Settings are required'
      });
    }

    // ì„¤ì •ì„ ê²€ìˆ˜ì„¤ì • ì‹œíŠ¸ì— ì €ì¥
    const settingsData = [
      [
        new Date().toISOString(), // ì„¤ì •ì¼ì‹œ
        JSON.stringify(settings), // ì„¤ì • JSON
        'ì»¬ëŸ¼ì„¤ì •ì—…ë°ì´íŠ¸'        // ë¹„ê³ 
      ]
    ];

    await sheets.spreadsheets.values.append({
      spreadsheetId: SPREADSHEET_ID,
      range: `${INSPECTION_SETTINGS_SHEET_NAME}!A:C`,
      valueInputOption: 'USER_ENTERED',
      resource: {
        values: settingsData
      }
    });

    // ìºì‹œ ë¬´íš¨í™”
    cacheUtils.deletePattern('inspection_data_*');

    res.json({
      success: true,
      message: 'ì»¬ëŸ¼ ì„¤ì •ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.'
    });
  } catch (error) {
    console.error('Error updating column settings:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to update column settings',
      message: error.message
    });
  }
});

// ìˆ˜ì •ì™„ë£Œ ìƒíƒœë¥¼ ì‹œíŠ¸ì—ì„œ ê´€ë¦¬ (ì„œë²„ ì¬ì‹œì‘ì‹œì—ë„ ìœ ì§€)
let modificationCompletionStatus = new Map(); // uniqueKey -> {userId, isCompleted, timestamp}
let modificationNotes = new Map(); // uniqueKey -> {userId, notes, timestamp}

// ê³ ìœ í‚¤ ìƒì„± í•¨ìˆ˜
function generateUniqueKey(subscriptionNumber, incorrectValue, correctValue) {
  // ê°€ì…ë²ˆí˜¸ + ìˆ˜ê¸°ì´ˆê°’ + í°í´ë°ì´í„°ê°’ ì¡°í•©ìœ¼ë¡œ ê³ ìœ í‚¤ ìƒì„±
  const sanitizedIncorrect = (incorrectValue || '').toString().replace(/[^a-zA-Z0-9ê°€-í£]/g, '');
  const sanitizedCorrect = (correctValue || '').toString().replace(/[^a-zA-Z0-9ê°€-í£]/g, '');
  return `${subscriptionNumber}_${sanitizedIncorrect}_${sanitizedCorrect}`;
}

// ì„œë²„ ì‹œì‘ ì‹œ ì‹œíŠ¸ì—ì„œ ë°ì´í„° ë¡œë“œ
async function initializeInspectionMemoData() {
  try {
    console.log('ì—¬ì§ì›ê²€ìˆ˜ë°ì´í„°ë©”ëª¨ ì‹œíŠ¸ì—ì„œ ë°ì´í„° ë¡œë“œ ì¤‘...');
    const { completionStatus, notes } = await loadInspectionMemoData();

    // ê¸°ì¡´ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš° ë§ˆì´ê·¸ë ˆì´ì…˜ ìˆ˜í–‰
    if (completionStatus.size > 0 || notes.size > 0) {
      console.log('ê¸°ì¡´ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ìˆ˜í–‰ ì¤‘...');
      await migrateExistingData(completionStatus, notes);
    }

    modificationCompletionStatus = completionStatus;
    modificationNotes = notes;
    console.log(`ì—¬ì§ì›ê²€ìˆ˜ë°ì´í„°ë©”ëª¨ ë¡œë“œ ì™„ë£Œ: ì™„ë£Œìƒíƒœ ${completionStatus.size}ê°œ, ë©”ëª¨ ${notes.size}ê°œ`);
  } catch (error) {
    console.error('ì—¬ì§ì›ê²€ìˆ˜ë°ì´í„°ë©”ëª¨ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
    modificationCompletionStatus = new Map();
    modificationNotes = new Map();
  }
}

// ê¸°ì¡´ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ í•¨ìˆ˜
async function migrateExistingData(completionStatus, notes) {
  try {
    const memoData = await getSheetValues(INSPECTION_MEMO_SHEET_NAME);
    if (!memoData || memoData.length <= 1) {
      return;
    }

    // ê¸°ì¡´ êµ¬ì¡°ì¸ì§€ í™•ì¸ (6ê°œ ì»¬ëŸ¼ì´ë©´ ê¸°ì¡´ êµ¬ì¡°)
    const firstDataRow = memoData[1];
    if (firstDataRow && firstDataRow.length === 6) {
      console.log('ê¸°ì¡´ ë°ì´í„° êµ¬ì¡° ê°ì§€, ë§ˆì´ê·¸ë ˆì´ì…˜ ìˆ˜í–‰...');

      const newRows = [['ê³ ìœ í‚¤', 'ê°€ì…ë²ˆí˜¸', 'ì‚¬ìš©ìID', 'ì™„ë£Œìƒíƒœ', 'ë©”ëª¨ë‚´ìš©', 'ì—…ë°ì´íŠ¸ì‹œê°„', 'í•„ë“œêµ¬ë¶„']];

      for (let i = 1; i < memoData.length; i++) {
        const row = memoData[i];
        if (row && row.length >= 6) {
          const subscriptionNumber = (row[0] || '').toString().trim();
          const userId = (row[1] || '').toString().trim();
          const isCompleted = (row[2] || '').toString().trim();
          const memoContent = (row[3] || '').toString().trim();
          const updateTime = (row[4] || '').toString().trim();
          const fieldType = (row[5] || '').toString().trim();

          if (subscriptionNumber && userId) {
            // ê³ ìœ í‚¤ ìƒì„± (ê¸°ì¡´ ë°ì´í„°ëŠ” ê°€ì…ë²ˆí˜¸ë§Œìœ¼ë¡œ ê³ ìœ í‚¤ ìƒì„±)
            const uniqueKey = `${subscriptionNumber}_${Date.now()}_${i}`;

            newRows.push([
              uniqueKey,
              subscriptionNumber,
              userId,
              isCompleted,
              memoContent,
              updateTime,
              fieldType
            ]);
          }
        }
      }

      // ìƒˆë¡œìš´ êµ¬ì¡°ë¡œ ì‹œíŠ¸ ì—…ë°ì´íŠ¸
      await sheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: `${INSPECTION_MEMO_SHEET_NAME}!A:G`,
        valueInputOption: 'USER_ENTERED',
        resource: {
          values: newRows
        }
      });

      console.log('ê¸°ì¡´ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ');
    }
  } catch (error) {
    console.error('ê¸°ì¡´ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨:', error);
  }
}

// ì„œë²„ ì‹œì‘ ì‹œ ì´ˆê¸°í™” ì‹¤í–‰ (ë¹„ë™ê¸°ë¡œ ì²˜ë¦¬í•˜ì—¬ ë‹¤ë¥¸ ì´ˆê¸°í™”ë¥¼ ë°©í•´í•˜ì§€ ì•Šë„ë¡)
initializeInspectionMemoData().catch(error => {
  console.error('ì—¬ì§ì›ê²€ìˆ˜ë°ì´í„°ë©”ëª¨ ì´ˆê¸°í™” ì‹¤íŒ¨ (ë¬´ì‹œë¨):', error);
});

// ìˆ˜ì •ì™„ë£Œ ìƒíƒœ ì¡°íšŒ API
app.get('/api/inspection/modification-completion-status', async (req, res) => {
  try {
    const { userId, view = 'personal' } = req.query;

    if (!userId) {
      return res.status(400).json({
        success: false,
        error: 'User ID is required'
      });
    }

    // ë©”ëª¨ë¦¬ì—ì„œ ìˆ˜ì •ì™„ë£Œ í•­ëª©ë“¤ ì¡°íšŒ
    const completedItems = [];
    const notesData = {};

    // ì™„ë£Œ ìƒíƒœ ì¡°íšŒ (ê°œì¸í˜„í™©ì—ì„œëŠ” í•´ë‹¹ ì‚¬ìš©ìì˜ ì™„ë£Œ í•­ëª©ë§Œ)
    for (const [uniqueKey, status] of modificationCompletionStatus) {
      if (status.isCompleted) {
        if (view === 'personal') {
          // ê°œì¸í˜„í™©: í•´ë‹¹ ì‚¬ìš©ìì˜ í•­ëª©ë§Œ
          if (status.userId === userId) {
            completedItems.push(uniqueKey);
          }
        } else {
          // ì „ì²´í˜„í™©: ëª¨ë“  ì‚¬ìš©ìì˜ í•­ëª©
          completedItems.push(uniqueKey);
        }
      }
    }

    // ë©”ëª¨ ë‚´ìš© ì¡°íšŒ (ê°œì¸í˜„í™©ì—ì„œëŠ” í•´ë‹¹ ì‚¬ìš©ìì˜ ë©”ëª¨ë§Œ)
    for (const [uniqueKey, notes] of modificationNotes) {
      if (view === 'personal') {
        // ê°œì¸í˜„í™©: í•´ë‹¹ ì‚¬ìš©ìì˜ ë©”ëª¨ë§Œ
        if (notes.userId === userId) {
          notesData[uniqueKey] = notes.notes;
        }
      } else {
        // ì „ì²´í˜„í™©: ëª¨ë“  ì‚¬ìš©ìì˜ ë©”ëª¨
        notesData[uniqueKey] = notes.notes;
      }
    }

    res.json({
      completedItems,
      notes: notesData,
      total: completedItems.length
    });
  } catch (error) {
    console.error('Error fetching modification completion status:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to fetch modification completion status',
      message: error.message
    });
  }
});

// ìˆ˜ì •ì™„ë£Œ ìƒíƒœ ì—…ë°ì´íŠ¸ API
app.post('/api/inspection/modification-complete', async (req, res) => {
  try {
    const { itemId, userId, isCompleted, subscriptionNumber, incorrectValue, correctValue } = req.body;

    if (!itemId || !userId) {
      return res.status(400).json({
        success: false,
        error: 'Item ID and User ID are required'
      });
    }

    // ê³ ìœ í‚¤ ìƒì„±
    const uniqueKey = generateUniqueKey(subscriptionNumber, incorrectValue, correctValue);

    // ë©”ëª¨ë¦¬ì— ìƒíƒœ ì €ì¥
    if (isCompleted) {
      // ì™„ë£Œ ì²´í¬ ì‹œ
      modificationCompletionStatus.set(uniqueKey, {
        userId,
        isCompleted: true,
        timestamp: new Date().toISOString()
      });
    } else {
      // ì™„ë£Œì²´í¬ í•´ì œ ì‹œ "ëŒ€ê¸°" ìƒíƒœë¡œ ë³€ê²½
      modificationCompletionStatus.set(uniqueKey, {
        userId,
        isCompleted: false,  // false = ëŒ€ê¸° ìƒíƒœ
        timestamp: new Date().toISOString()
      });
      // ë©”ëª¨ëŠ” ìœ ì§€ (ì‚¬ìš©ìê°€ ë‹¤ì‹œ ì²´í¬í•  ìˆ˜ ìˆë„ë¡)
    }

    // ì‹œíŠ¸ì— ì €ì¥
    await saveInspectionMemoData(modificationCompletionStatus, modificationNotes);

    console.log(`ìˆ˜ì •ì™„ë£Œ ìƒíƒœ ì—…ë°ì´íŠ¸: ${uniqueKey} - ${userId} - ${isCompleted ? 'ì™„ë£Œ' : 'ëŒ€ê¸°'}`);

    res.json({
      success: true,
      message: 'ìˆ˜ì •ì™„ë£Œ ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.'
    });
  } catch (error) {
    console.error('Error updating modification completion:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to update modification completion',
      message: error.message
    });
  }
});

// ìˆ˜ì •ì™„ë£Œ ë‚´ìš© ì—…ë°ì´íŠ¸ API
app.post('/api/inspection/modification-notes', async (req, res) => {
  try {
    const { itemId, userId, notes, subscriptionNumber, incorrectValue, correctValue } = req.body;

    if (!itemId || !userId) {
      return res.status(400).json({
        success: false,
        error: 'Item ID and User ID are required'
      });
    }

    // ê³ ìœ í‚¤ ìƒì„±
    const uniqueKey = generateUniqueKey(subscriptionNumber, incorrectValue, correctValue);

    // ë©”ëª¨ë¦¬ì— ë‚´ìš© ì €ì¥
    if (notes && notes.trim()) {
      // ë©”ëª¨ê°€ ìˆëŠ” ê²½ìš°
      modificationNotes.set(uniqueKey, {
        userId,
        notes: notes.trim(),
        timestamp: new Date().toISOString()
      });

      // ì™„ë£Œ ìƒíƒœ ì„¤ì •
      modificationCompletionStatus.set(uniqueKey, {
        userId,
        isCompleted: true,
        timestamp: new Date().toISOString()
      });
    } else {
      // ë©”ëª¨ê°€ ì—†ëŠ” ê²½ìš° (ê³µë°±ìœ¼ë¡œ ë³€ê²½)
      modificationNotes.set(uniqueKey, {
        userId,
        notes: '',  // ë¹ˆ ë¬¸ìì—´ë¡œ ì„¤ì •
        timestamp: new Date().toISOString()
      });

      // ì™„ë£Œ ìƒíƒœëŠ” ìœ ì§€
      modificationCompletionStatus.set(uniqueKey, {
        userId,
        isCompleted: true,
        timestamp: new Date().toISOString()
      });
    }

    // ì‹œíŠ¸ì— ì €ì¥
    await saveInspectionMemoData(modificationCompletionStatus, modificationNotes);

    console.log(`ìˆ˜ì •ì™„ë£Œ ë‚´ìš© ì—…ë°ì´íŠ¸: ${uniqueKey} - ${userId} - ${notes}`);

    res.json({
      success: true,
      message: 'ìˆ˜ì •ì™„ë£Œ ë‚´ìš©ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.'
    });
  } catch (error) {
    console.error('Error updating modification notes:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to update modification notes',
      message: error.message
    });
  }
});

// ê²€ìˆ˜ëª¨ë“œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ë³´ì•ˆ ê°•í™”ëœ ìºì‹± ì ìš©)
app.get('/api/inspection-data', async (req, res) => {
  const { view = 'personal', userId, field } = req.query;
  const cacheKey = `inspection_data_${view}_${userId}_${field || 'all'}`;

  // í°í´ê°œí†µë°ì´í„° ìºì‹œ ë¬´íš¨í™” (BZì—´ ë°ì´í„° í¬í•¨í•˜ë„ë¡)
  invalidatePhoneklActivationCache();

  // ìºì‹œì—ì„œ ë¨¼ì € í™•ì¸ (ë³´ì•ˆ TTL ì ìš©)
  const cachedData = cacheUtils.get(cacheKey);
  if (cachedData) {
    console.log('ìºì‹œëœ ê²€ìˆ˜ ë°ì´í„° ë°˜í™˜ (ë³´ì•ˆ TTL ì ìš©)');
    return res.json(cachedData);
  }

  try {
    console.log('ê²€ìˆ˜ ë°ì´í„° ì²˜ë¦¬ ì‹œì‘... (ê°œì¸ì •ë³´ ë³´ì•ˆ ì²˜ë¦¬ í¬í•¨)');
    const startTime = Date.now();

    // ìˆ˜ê¸°ì´ˆ, í°í´ê°œí†µë°ì´í„°, í°í´ì¶œê³ ì²˜ë°ì´í„°, ë¬´ì„ ìš”ê¸ˆì œêµ° ë³‘ë ¬ ë¡œë“œ (ìºì‹œ í™œìš©)
    const [manualValues, systemValues, storeValues, planValues] = await Promise.all([
      getSheetValues(MANUAL_DATA_SHEET_NAME),
      getSheetValues(CURRENT_MONTH_ACTIVATION_SHEET_NAME),
      getSheetValues(STORE_SHEET_NAME),
      getSheetValues(PLAN_SHEET_NAME)
    ]);

    if (!manualValues || !systemValues) {
      throw new Error('Failed to fetch data from sheets');
    }

    // í—¤ë” ì œê±° (ìˆ˜ê¸°ì´ˆ: 1í–‰ í—¤ë”, í°í´ê°œí†µë°ì´í„°: 3í–‰ í—¤ë”)
    const manualRows = manualValues.slice(1);
    const systemRows = systemValues.slice(3);

    // ìˆ˜ê¸°ì´ˆ ë°ì´í„°ë¥¼ ë™ì¼í•œ ì—´ êµ¬ì¡°ë¡œ ë§ì¶°ì£¼ëŠ” í•¨ìˆ˜
    function normalizeManualRows(manualRows) {
      const REQUIRED_COLUMNS = 150; // DXì—´(127) + ì—¬ìœ ë¶„ì„ ìœ„í•´ 150ê°œë¡œ ì„¤ì •

      return manualRows.map(row => {
        if (row.length < REQUIRED_COLUMNS) {
          // ë¶€ì¡±í•œ ì—´ë§Œí¼ ë¹ˆ ë¬¸ìì—´ë¡œ ì±„ìš°ê¸°
          const normalizedRow = [...row];
          while (normalizedRow.length < REQUIRED_COLUMNS) {
            normalizedRow.push('');
          }
          return normalizedRow;
        }
        return row;
      });
    }

    // ìˆ˜ê¸°ì´ˆ ë°ì´í„° ì •ê·œí™” ì ìš©
    const normalizedManualRows = normalizeManualRows(manualRows);

    // ìˆ˜ê¸°ì´ˆ ë°ì´í„°ì˜ ìµœëŒ€ ì¼ì‹œ ê³„ì‚° (ë©”ëª¨ë¦¬ ìµœì í™”)
    function getMaxManualDateTime(normalizedManualRows) {
      let maxDateTime = null;
      let processedCount = 0;
      const BATCH_SIZE = 1000;

      for (let i = 0; i < normalizedManualRows.length; i++) {
        const row = normalizedManualRows[i];

        if (row.length > 30) { // ADì—´(29) + AEì—´(30) ìµœì†Œ í•„ìš”
          const date = (row[29] || '').toString().trim(); // ADì—´: ê°€ì…ì¼ì
          const time = (row[30] || '').toString().trim(); // AEì—´: ê°œí†µì‹œê°„

          if (date && time && time.length >= 4) {
            const hour = time.substring(0, 2);
            const minute = time.substring(2, 4);

            // 5ë¶„ ë‹¨ìœ„ë¡œ ë‚´ë¦¼ì°¨ìˆœ ì²˜ë¦¬ (ê¸°ì¡´ ì •ê·œí™” ë¡œì§ê³¼ ë™ì¼)
            const minuteNum = parseInt(minute, 10);
            const normalizedMinute = Math.floor(minuteNum / 5) * 5;
            const normalizedMinuteStr = normalizedMinute.toString().padStart(2, '0');

            const dateTimeStr = `${date} ${hour}:${normalizedMinuteStr}`;
            const dateTime = new Date(dateTimeStr);

            if (!isNaN(dateTime.getTime()) && (!maxDateTime || dateTime > maxDateTime)) {
              maxDateTime = dateTime;
            }
          }
        }

        processedCount++;

        // ë°°ì¹˜ ë‹¨ìœ„ë¡œ ë©”ëª¨ë¦¬ ì •ë¦¬
        if (processedCount % BATCH_SIZE === 0) {
          if (global.gc) {
            global.gc();
          }
          console.log(`ğŸ§  [ì¼ì‹œí•„í„°ë§] ìµœëŒ€ì¼ì‹œ ê³„ì‚° ì§„í–‰ë¥ : ${processedCount}/${normalizedManualRows.length} (${Math.round(processedCount / normalizedManualRows.length * 100)}%)`);
        }
      }

      return maxDateTime;
    }

    // í°í´ ë°ì´í„°ë¥¼ ìˆ˜ê¸°ì´ˆ ìµœëŒ€ ì¼ì‹œë¡œ í•„í„°ë§ (ë©”ëª¨ë¦¬ ìµœì í™”)
    function filterSystemRowsByDateTime(systemRows, maxManualDateTime) {
      if (!maxManualDateTime) {
        return systemRows; // ìµœëŒ€ ì¼ì‹œê°€ ì—†ìœ¼ë©´ ëª¨ë“  ë°ì´í„° ë°˜í™˜
      }

      const filteredRows = [];
      let processedCount = 0;
      const BATCH_SIZE = 1000;

      for (let i = 0; i < systemRows.length; i++) {
        const row = systemRows[i];
        let shouldInclude = true;

        if (row.length > 11) { // Jì—´(9) + Kì—´(10) + Lì—´(11) ìµœì†Œ í•„ìš”
          const date = (row[9] || '').toString().trim(); // Jì—´: ê°œí†µì¼
          const hour = (row[10] || '').toString().replace('ì‹œ', '').trim(); // Kì—´: ê°œí†µì‹œ
          const minute = (row[11] || '').toString().replace('ë¶„', '').trim(); // Lì—´: ê°œí†µë¶„

          if (date && hour && minute) {
            const hourNum = parseInt(hour, 10);
            const minuteNum = parseInt(minute, 10);
            const normalizedHourStr = hourNum.toString().padStart(2, '0');
            const normalizedMinuteStr = minuteNum.toString().padStart(2, '0');

            const dateTimeStr = `${date} ${normalizedHourStr}:${normalizedMinuteStr}`;
            const dateTime = new Date(dateTimeStr);

            // ìˆ˜ê¸°ì´ˆ ìµœëŒ€ ì¼ì‹œ ì´ì „ ë˜ëŠ” ê°™ì€ ë°ì´í„°ë§Œ í¬í•¨
            shouldInclude = !isNaN(dateTime.getTime()) && dateTime <= maxManualDateTime;
          }
        }

        if (shouldInclude) {
          filteredRows.push(row);
        }

        processedCount++;

        // ë°°ì¹˜ ë‹¨ìœ„ë¡œ ë©”ëª¨ë¦¬ ì •ë¦¬
        if (processedCount % BATCH_SIZE === 0) {
          if (global.gc) {
            global.gc();
          }
          console.log(`ğŸ§  [ì¼ì‹œí•„í„°ë§] í°í´í•„í„°ë§ ì§„í–‰ë¥ : ${processedCount}/${systemRows.length} (${Math.round(processedCount / systemRows.length * 100)}%)`);
        }
      }

      return filteredRows;
    }

    // ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§
    const startMemory = process.memoryUsage();
    console.log(`ğŸ§  [ë©”ëª¨ë¦¬] ì¼ì‹œí•„í„°ë§ ì‹œì‘: ${Math.round(startMemory.heapUsed / 1024 / 1024)}MB`);

    // ìˆ˜ê¸°ì´ˆ ìµœëŒ€ ì¼ì‹œ ê³„ì‚°
    const maxManualDateTime = getMaxManualDateTime(normalizedManualRows);
    console.log(`ğŸ“… [ì¼ì‹œí•„í„°ë§] ìˆ˜ê¸°ì´ˆ ìµœëŒ€ ì¼ì‹œ: ${maxManualDateTime ? maxManualDateTime.toISOString() : 'ì—†ìŒ'}`);

    // í°í´ ë°ì´í„° í•„í„°ë§
    const originalSystemRowsCount = systemRows.length;
    const filteredSystemRows = filterSystemRowsByDateTime(systemRows, maxManualDateTime);
    const filteredSystemRowsCount = filteredSystemRows.length;
    const excludedCount = originalSystemRowsCount - filteredSystemRowsCount;

    console.log(`ğŸ“… [ì¼ì‹œí•„í„°ë§] í°í´ ë°ì´í„° í•„í„°ë§ ê²°ê³¼: ì „ì²´ ${originalSystemRowsCount}ê°œ â†’ í•„í„°ë§ í›„ ${filteredSystemRowsCount}ê°œ (ì œì™¸: ${excludedCount}ê°œ)`);

    // ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§
    const endMemory = process.memoryUsage();
    console.log(`ğŸ§  [ë©”ëª¨ë¦¬] ì¼ì‹œí•„í„°ë§ ì™„ë£Œ: ${Math.round(endMemory.heapUsed / 1024 / 1024)}MB (ì¦ê°€: ${Math.round((endMemory.heapUsed - startMemory.heapUsed) / 1024 / 1024)}MB)`);

    // ê°•ì œ ê°€ë¹„ì§€ ì»¬ë ‰ì…˜
    if (global.gc) {
      global.gc();
      const afterGCMemory = process.memoryUsage();
      console.log(`ğŸ§  [ë©”ëª¨ë¦¬] GC í›„: ${Math.round(afterGCMemory.heapUsed / 1024 / 1024)}MB`);
    }

    // í•„í„°ë§ëœ ë°ì´í„°ë¡œ ê³„ì† ì§„í–‰
    const filteredSystemRowsForComparison = filteredSystemRows;

    // ë°ì´í„° ë¹„êµ ë° ì°¨ì´ì  ì°¾ê¸°
    const differences = [];
    const manualMap = new Map();
    const systemMap = new Map();

    // ìˆ˜ê¸°ì´ˆ ë°ì´í„° ì¸ë±ì‹± (Uì—´: ê°€ì…ë²ˆí˜¸ ê¸°ì¤€)
    normalizedManualRows.forEach((row, index) => {
      if (row.length > 20 && row[20]) {
        const key = row[20].toString().trim();
        manualMap.set(key, { row, index: index + 2 }); // +2ëŠ” í—¤ë”ì™€ 1-based ì¸ë±ìŠ¤ ë•Œë¬¸
      }
    });

    // ì¤‘ë³µ ë¶„ì„ í•¨ìˆ˜ë“¤
    function analyzeDuplicateDifferences(duplicateRows) {
      if (duplicateRows.length <= 1) return '';

      const differences = [];
      const baseRow = duplicateRows[0];

      for (let i = 1; i < duplicateRows.length; i++) {
        const currentRow = duplicateRows[i];
        const rowDifferences = [];

        // ëª¨ë¸ëª… ë¹„êµ (Vì—´: 21ë²ˆì§¸ ì»¬ëŸ¼)
        if (baseRow[21] !== currentRow[21]) {
          rowDifferences.push(`ëª¨ë¸ëª…: ${baseRow[21] || 'ì—†ìŒ'} vs ${currentRow[21] || 'ì—†ìŒ'}`);
        }

        // ê°œí†µìœ í˜• ë¹„êµ (Tì—´: 19ë²ˆì§¸ ì»¬ëŸ¼)
        if (baseRow[19] !== currentRow[19]) {
          rowDifferences.push(`ê°œí†µìœ í˜•: ${baseRow[19] || 'ì—†ìŒ'} vs ${currentRow[19] || 'ì—†ìŒ'}`);
        }

        // ì…ê³ ì²˜ ë¹„êµ (Mì—´: 12ë²ˆì§¸ ì»¬ëŸ¼)
        if (baseRow[12] !== currentRow[12]) {
          rowDifferences.push(`ì…ê³ ì²˜: ${baseRow[12] || 'ì—†ìŒ'} vs ${currentRow[12] || 'ì—†ìŒ'}`);
        }

        if (rowDifferences.length > 0) {
          differences.push(`ì¤‘ë³µ${i}: ${rowDifferences.join(', ')}`);
        } else {
          differences.push(`ì¤‘ë³µ${i}: ì™„ì „ë™ì¼`);
        }
      }

      return differences.join(' | ');
    }

    // ê° í–‰ë³„ë¡œ ê°œë³„ì ì¸ ì¤‘ë³µ ì •ë³´ë¥¼ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
    function generateIndividualDuplicateInfo(duplicateRows, currentRowIndex, duplicateType) {
      if (duplicateRows.length <= 1) return '';

      const currentRow = duplicateRows[currentRowIndex];
      const differences = [];

      for (let i = 0; i < duplicateRows.length; i++) {
        if (i === currentRowIndex) continue; // ìê¸° ìì‹ ì€ ì œì™¸

        const otherRow = duplicateRows[i];
        const rowDifferences = [];

        // ì…ê³ ì²˜ ë¹„êµ (Mì—´: 12ë²ˆì§¸ ì»¬ëŸ¼)
        if (currentRow[12] !== otherRow[12]) {
          rowDifferences.push(`${currentRow[12] || 'ì—†ìŒ'}`);
        }

        // ëª¨ë¸ëª… ë¹„êµ (Vì—´: 21ë²ˆì§¸ ì»¬ëŸ¼)
        if (currentRow[21] !== otherRow[21]) {
          rowDifferences.push(`${currentRow[21] || 'ëª¨ë¸ëª…ì—†ìŒ'}`);
        }

        // ê°œí†µìœ í˜• ë¹„êµ (Tì—´: 19ë²ˆì§¸ ì»¬ëŸ¼)
        if (currentRow[19] !== otherRow[19]) {
          rowDifferences.push(`${currentRow[19] || 'ê°œí†µìœ í˜•ì—†ìŒ'}`);
        }

        if (rowDifferences.length > 0) {
          differences.push(`${rowDifferences.join(' ')}`);
        } else {
          differences.push(`ì™„ì „ë™ì¼`);
        }
      }

      return differences.join(' | ');
    }

    function getDuplicateType(manualDuplicates, systemDuplicates) {
      // ìˆ˜ê¸°ì´ˆ 1ê°œ + í°í´ 1ê°œ = ì •ìƒ (ì¤‘ë³µ ì•„ë‹˜)
      if (!manualDuplicates && !systemDuplicates) return 'no_duplicate';

      // ìˆ˜ê¸°ì´ˆ 2ê°œ ì´ìƒ + í°í´ 1ê°œ = ìˆ˜ê¸°ì´ˆ ì¤‘ë³µ
      if (manualDuplicates && !systemDuplicates) return 'manual_duplicate';

      // ìˆ˜ê¸°ì´ˆ 1ê°œ + í°í´ 2ê°œ ì´ìƒ = í°í´ ì¤‘ë³µ
      if (!manualDuplicates && systemDuplicates) return 'system_duplicate';

      // ìˆ˜ê¸°ì´ˆ 2ê°œ ì´ìƒ + í°í´ 2ê°œ ì´ìƒ = ì–‘ìª½ ì¤‘ë³µ
      if (manualDuplicates && systemDuplicates) return 'both_duplicate';

      return 'no_duplicate';
    }

    // ë‹¨ìˆœí•˜ê³  ì‹¬í”Œí•œ í–‰ê°’ ê¸°ë°˜ ì²˜ë¦¬ ë¡œì§
    const allRows = [];

    // ëª¨ë“  ìˆ˜ê¸°ì´ˆ ë°ì´í„° ì¶”ê°€
    normalizedManualRows.forEach((row, index) => {
      if (row.length > 20 && row[20]) {
        const key = row[20].toString().trim();
        allRows.push({
          key,
          row,
          index: index + 2,
          source: 'manual'
        });
      }
    });

    // ëª¨ë“  í°í´ ë°ì´í„° ì¶”ê°€ (í•„í„°ë§ëœ ë°ì´í„° ì‚¬ìš©)
    filteredSystemRowsForComparison.forEach((row, index) => {
      if (row.length > 74 && row[74]) { // BWì—´ì€ 75ë²ˆì§¸ ì»¬ëŸ¼ (0-based)
        const key = row[74].toString().trim();
        allRows.push({
          key,
          row,
          index: index + 4,
          source: 'system'
        });
      }
    });

    // ê°€ì…ë²ˆí˜¸ë³„ë¡œ ê·¸ë£¹í™”í•˜ì—¬ ì¤‘ë³µ ê°ì§€
    const groupsByKey = new Map();
    allRows.forEach(item => {
      if (!groupsByKey.has(item.key)) {
        groupsByKey.set(item.key, []);
      }
      groupsByKey.get(item.key).push(item);
    });

    // ê° ê°€ì…ë²ˆí˜¸ ê·¸ë£¹ë³„ë¡œ ì²˜ë¦¬
    for (const [key, group] of groupsByKey) {
      const manualItems = group.filter(item => item.source === 'manual');
      const systemItems = group.filter(item => item.source === 'system');

      const isManualDuplicate = manualItems.length > 1;
      const isSystemDuplicate = systemItems.length > 1;

      // ìˆ˜ê¸°ì´ˆ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°
      if (manualItems.length > 0) {
        for (const manualItem of manualItems) {
          // í°í´ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš° - ê° í°í´ ë°ì´í„°ì™€ ë¹„êµ
          if (systemItems.length > 0) {
            for (const systemItem of systemItems) {
              // ì¤‘ë³µ íƒ€ì… ê²°ì •
              const duplicateType = getDuplicateType(isManualDuplicate, isSystemDuplicate);

              // ì¤‘ë³µ ì •ë³´ ìƒì„±
              let duplicateInfo = '';
              if (isSystemDuplicate) {
                const systemIndex = systemItems.findIndex(item => item.index === systemItem.index);
                duplicateInfo = generateIndividualDuplicateInfo(
                  systemItems.map(item => item.row),
                  systemIndex,
                  'system_duplicate'
                );
              } else if (isManualDuplicate) {
                const manualIndex = manualItems.findIndex(item => item.index === manualItem.index);
                duplicateInfo = generateIndividualDuplicateInfo(
                  manualItems.map(item => item.row),
                  manualIndex,
                  'manual_duplicate'
                );
              }

              // ë‘ ë°ì´í„° ë¹„êµ
              const rowDifferences = compareDynamicColumns(manualItem.row, systemItem.row, key, field, storeValues, planValues);

              rowDifferences.forEach(diff => {
                differences.push({
                  ...diff,
                  manualRow: manualItem.index,
                  systemRow: systemItem.index,
                  assignedAgent: systemItem.row[77] || '', // BZì—´: ë“±ë¡ì§ì›
                  isDuplicate: isManualDuplicate || isSystemDuplicate,
                  duplicateType: duplicateType,
                  duplicateInfo: duplicateInfo
                });
              });
            }
          } else {
            // ìˆ˜ê¸°ì´ˆì—ë§Œ ìˆëŠ” ë°ì´í„°
            if (!field) {
              const duplicateType = isManualDuplicate ? 'manual_duplicate' : 'no_duplicate';
              let duplicateInfo = '';

              if (isManualDuplicate) {
                const manualIndex = manualItems.findIndex(item => item.index === manualItem.index);
                duplicateInfo = generateIndividualDuplicateInfo(
                  manualItems.map(item => item.row),
                  manualIndex,
                  'manual_duplicate'
                );
              }

              differences.push({
                key,
                type: 'manual_only',
                field: 'ì „ì²´',
                fieldKey: 'all',
                correctValue: 'ìˆ˜ê¸°ì´ˆì—ë§Œ ì¡´ì¬',
                incorrectValue: 'ì—†ìŒ',
                manualRow: manualItem.index,
                systemRow: null,
                assignedAgent: '',
                isDuplicate: isManualDuplicate,
                duplicateType: duplicateType,
                duplicateInfo: duplicateInfo
              });
            }
          }
        }
      } else {
        // í°í´ì—ë§Œ ìˆëŠ” ë°ì´í„°
        if (!field) {
          systemItems.forEach(systemItem => {
            const duplicateType = isSystemDuplicate ? 'system_duplicate' : 'no_duplicate';
            let duplicateInfo = '';

            if (isSystemDuplicate) {
              const systemIndex = systemItems.findIndex(item => item.index === systemItem.index);
              duplicateInfo = generateIndividualDuplicateInfo(
                systemItems.map(item => item.row),
                systemIndex,
                'system_duplicate'
              );
            }

            differences.push({
              key,
              type: 'system_only',
              field: 'ì „ì²´',
              fieldKey: 'all',
              correctValue: 'ì—†ìŒ',
              incorrectValue: 'ìˆ˜ê¸°ì´ˆì— ì—†ìŒ',
              manualRow: null,
              systemRow: systemItem.index,
              assignedAgent: systemItem.row[77] || '', // BZì—´: ë“±ë¡ì§ì›
              isDuplicate: isSystemDuplicate,
              duplicateType: duplicateType,
              duplicateInfo: duplicateInfo
            });
          });
        }
      }
    }

    // ì²˜ë¦¬ì ì´ë¦„ì—ì„œ ê´„í˜¸ì™€ ì ‘ë‘ì‚¬ ì œê±°í•˜ëŠ” í•¨ìˆ˜
    function cleanAgentName(agentName) {
      if (!agentName) return '';
      let cleaned = agentName.toString();

      // VIPâ”‚, MINâ”‚ ì ‘ë‘ì‚¬ ì œê±° (ì˜ˆ: "VIPâ”‚ìµœì€ì§„" â†’ "ìµœì€ì§„")
      cleaned = cleaned.replace(/^(VIPâ”‚|MINâ”‚)/, '');

      // ê´„í˜¸ì™€ ê´„í˜¸ ì•ˆì˜ ë‚´ìš© ì œê±° (ì˜ˆ: "í™ê¸¸ë™ (RM)" â†’ "í™ê¸¸ë™")
      cleaned = cleaned.replace(/\s*\([^)]*\)/g, '');

      // ì•ë’¤ ê³µë°± ì œê±°
      cleaned = cleaned.trim();

      // ë¹ˆ ë¬¸ìì—´ì´ë©´ ì›ë³¸ ë°˜í™˜
      if (!cleaned) return agentName.toString().trim();

      return cleaned;
    }

    // ë·°ì— ë”°ë¥¸ í•„í„°ë§
    let filteredDifferences = differences;
    if (view === 'personal' && userId) {
      console.log(`ê°œì¸ë‹´ë‹¹ í•„í„°ë§: userId=${userId}, ì „ì²´ ì°¨ì´ì =${differences.length}ê°œ`);
      console.log('ë“±ë¡ì§ì› ëª©ë¡:', [...new Set(differences.map(d => d.assignedAgent))]);
      console.log('ì •ë¦¬ëœ ë“±ë¡ì§ì› ëª©ë¡:', [...new Set(differences.map(d => cleanAgentName(d.assignedAgent)))]);

      // ì‚¬ìš©ì IDê°€ ì „í™”ë²ˆí˜¸ì¸ì§€ í™•ì¸í•˜ê³ , ì „í™”ë²ˆí˜¸ì¸ ê²½ìš° ëŒ€ë¦¬ì  ê´€ë¦¬ì ì‹œíŠ¸ì—ì„œ ì´ë¦„ì„ ì°¾ê¸°
      let userName = userId;

      // ì „í™”ë²ˆí˜¸ íŒ¨í„´ í™•ì¸ (010ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” 11ìë¦¬)
      if (/^010\d{8}$/.test(userId)) {
        console.log(`ì „í™”ë²ˆí˜¸ ê°ì§€: ${userId}, ëŒ€ë¦¬ì  ê´€ë¦¬ì ì‹œíŠ¸ì—ì„œ ì´ë¦„ ê²€ìƒ‰ ì¤‘...`);

        try {
          const agentValues = await getSheetValues(AGENT_SHEET_NAME);
          if (agentValues) {
            const agentRows = agentValues.slice(1);
            const agent = agentRows.find(row => row[2] === userId); // Cì—´: ì—°ë½ì²˜(ì•„ì´ë””)

            if (agent) {
              userName = agent[0]; // Aì—´: ëŒ€ìƒ (ì´ë¦„)
              console.log(`ëŒ€ë¦¬ì  ê´€ë¦¬ì ì‹œíŠ¸ì—ì„œ ì´ë¦„ ì°¾ìŒ: "${userName}" (ì „í™”ë²ˆí˜¸: ${userId})`);
            } else {
              console.log(`ëŒ€ë¦¬ì  ê´€ë¦¬ì ì‹œíŠ¸ì—ì„œ ì „í™”ë²ˆí˜¸ ${userId}ì— í•´ë‹¹í•˜ëŠ” ì´ë¦„ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ`);
            }
          }
        } catch (error) {
          console.error('ëŒ€ë¦¬ì  ê´€ë¦¬ì ì‹œíŠ¸ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜:', error);
        }
      }

      // ì‚¬ìš©ì ì´ë¦„ê³¼ ì •ë¦¬ëœ ë“±ë¡ì§ì› ì´ë¦„ì„ ë¹„êµ
      const cleanUserName = cleanAgentName(userName);
      console.log(`ì •ë¦¬ëœ ì‚¬ìš©ì ì´ë¦„: "${cleanUserName}" (ì›ë³¸: "${userName}")`);

      // ë§¤ì¹­ ì‹œë„ ë¡œê·¸
      let matchCount = 0;
      filteredDifferences = differences.filter(diff => {
        const cleanAgent = cleanAgentName(diff.assignedAgent);
        const isMatch = cleanAgent === cleanUserName;
        if (isMatch) {
          matchCount++;
        }
        return isMatch;
      });
    }

    // ê°œì¸ì •ë³´ ë³´ì•ˆ ì²˜ë¦¬: ë§ˆìŠ¤í‚¹ ë° í•´ì‹œí™”
    const secureDifferences = securityUtils.createSafeDataStructure(filteredDifferences);

    // í˜„ì¬ ê²€ìˆ˜ ëŒ€ìƒ ê°€ì…ë²ˆí˜¸ ëª©ë¡ ìƒì„± (ìë™ ì •ë¦¬ìš©)
    const currentInspectionKeys = new Set();
    secureDifferences.forEach(diff => {
      if (diff.key) {
        currentInspectionKeys.add(diff.key);
      }
    });

    // ì—¬ì§ì›ê²€ìˆ˜ë°ì´í„°ë©”ëª¨ ì‹œíŠ¸ ìë™ ì •ë¦¬ (ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰)
    cleanupInspectionMemoData(currentInspectionKeys).catch(error => {
      console.error('ì—¬ì§ì›ê²€ìˆ˜ë°ì´í„°ë©”ëª¨ ì‹œíŠ¸ ì •ë¦¬ ì‹¤íŒ¨:', error);
    });

    const result = {
      differences: secureDifferences,
      total: secureDifferences.length,
      manualOnly: secureDifferences.filter(d => d.type === 'manual_only').length,
      systemOnly: secureDifferences.filter(d => d.type === 'system_only').length,
      mismatched: secureDifferences.filter(d => d.type === 'mismatch').length,
      securityNote: 'ê²€ìˆ˜ìëŠ” ì‹¤ì œ ê°’ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. IDëŠ” í•´ì‹œí™”ë˜ì–´ ë³´ì•ˆì´ ìœ ì§€ë©ë‹ˆë‹¤.'
    };

    const processingTime = Date.now() - startTime;
    console.log(`ê²€ìˆ˜ ë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ: ${result.total}ê°œ ì°¨ì´ì , ${processingTime}ms ì†Œìš” (ë³´ì•ˆ ì²˜ë¦¬ í¬í•¨)`);

    // ë³´ì•ˆ ê°•í™”ëœ ìºì‹œì— ì €ì¥ (2ë¶„ TTL)
    cacheUtils.set(cacheKey, result, SECURE_CACHE_TTL);

    res.json(result);
  } catch (error) {
    console.error('Error fetching inspection data:', error);
    res.status(500).json({
      error: 'Failed to fetch inspection data',
      message: error.message
    });
  }
});

// í•´ì‹œí™”ëœ IDë¥¼ ì›ë³¸ í‚¤ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
function findOriginalKeyFromHash(hashId, differences) {
  for (const diff of differences) {
    if (securityUtils.hashPersonalInfo(diff.key) === hashId) {
      return diff.key;
    }
  }
  return null;
}

// ì„ íƒì  ìºì‹œ ë¬´íš¨í™” í•¨ìˆ˜
function invalidateInspectionCache(userId, field = null) {
  const cacheKeysToDelete = [
    `inspection_data_personal_${userId}`,
    `inspection_data_overview_${userId}`,
    `inspection_data_personal_${userId}_all`,
    `inspection_data_overview_${userId}_all`
  ];

  // íŠ¹ì • í•„ë“œê°€ ì§€ì •ëœ ê²½ìš° í•´ë‹¹ í•„ë“œ ìºì‹œë„ ì‚­ì œ
  if (field && field !== 'all') {
    cacheKeysToDelete.push(`inspection_data_personal_${userId}_${field}`);
    cacheKeysToDelete.push(`inspection_data_overview_${userId}_${field}`);
  }

  cacheKeysToDelete.forEach(key => {
    if (cacheUtils.get(key)) {
      cacheUtils.delete(key);
      console.log(`ìºì‹œ ë¬´íš¨í™”: ${key}`);
    }
  });
}

// ê²€ìˆ˜ ì™„ë£Œ ìƒíƒœ ì—…ë°ì´íŠ¸ (í•´ì‹œí™”ëœ ID ì²˜ë¦¬)
app.post('/api/inspection/complete', async (req, res) => {
  try {
    const { itemId, userId, status } = req.body;

    if (!itemId || !userId) {
      return res.status(400).json({
        success: false,
        error: 'Item ID and User ID are required'
      });
    }

    // í•´ì‹œí™”ëœ IDë¥¼ ì›ë³¸ í‚¤ë¡œ ë³€í™˜
    let originalKey = itemId;
    // ìºì‹œì—ì„œ ì›ë³¸ ë°ì´í„° ì°¾ê¸°
    const cacheKeys = Array.from(cache.keys()).filter(key => key.includes('inspection_data'));
    for (const cacheKey of cacheKeys) {
      const cachedData = cacheUtils.get(cacheKey);
      if (cachedData && cachedData.differences) {
        const foundKey = findOriginalKeyFromHash(itemId, cachedData.differences);
        if (foundKey) {
          originalKey = foundKey;
          break;
        }
      }
    }

    // ê²€ìˆ˜ê²°ê³¼ ì‹œíŠ¸ì— ì™„ë£Œ ìƒíƒœ ê¸°ë¡
    const completionData = [
      [
        new Date().toISOString(), // ì™„ë£Œì¼ì‹œ
        userId,                   // ì²˜ë¦¬ì
        originalKey,              // ì›ë³¸ í•­ëª© ID
        status || 'ì™„ë£Œ',         // ìƒíƒœ
        'ì²˜ë¦¬ì™„ë£Œ'                // ë¹„ê³ 
      ]
    ];

    await sheets.spreadsheets.values.append({
      spreadsheetId: SPREADSHEET_ID,
      range: `${INSPECTION_RESULT_SHEET_NAME}!A:E`,
      valueInputOption: 'USER_ENTERED',
      resource: {
        values: completionData
      }
    });

    // ìºì‹œ ë¬´íš¨í™”
    invalidateInspectionCache(userId);

    res.json({
      success: true,
      message: 'ê²€ìˆ˜ ì™„ë£Œ ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.'
    });
  } catch (error) {
    console.error('Error updating inspection completion:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to update inspection completion',
      message: error.message
    });
  }
});

// ì •ê·œí™” ë°ì´í„° ì €ì¥
app.post('/api/inspection/normalize', async (req, res) => {
  try {
    const { itemId, userId, originalValue, normalizedValue, field } = req.body;

    if (!itemId || !userId || !normalizedValue) {
      return res.status(400).json({
        success: false,
        error: 'Item ID, User ID, and normalized value are required'
      });
    }

    // ì •ê·œí™”ì´ë ¥ ì‹œíŠ¸ì— ê¸°ë¡
    const normalizationData = [
      [
        new Date().toISOString(), // ì •ê·œí™”ì¼ì‹œ
        userId,                   // ì²˜ë¦¬ì
        itemId,                   // í•­ëª© ID
        field,                    // í•„ë“œëª…
        originalValue || '',      // ì›ë³¸ê°’
        normalizedValue,          // ì •ê·œí™”ê°’
        'ìˆ˜ë™ì •ê·œí™”'              // ë¹„ê³ 
      ]
    ];

    await sheets.spreadsheets.values.append({
      spreadsheetId: SPREADSHEET_ID,
      range: `${NORMALIZATION_HISTORY_SHEET_NAME}!A:G`,
      valueInputOption: 'USER_ENTERED',
      resource: {
        values: normalizationData
      }
    });

    // ìºì‹œ ë¬´íš¨í™”
    invalidateInspectionCache(userId);

    res.json({
      success: true,
      message: 'ì •ê·œí™” ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'
    });
  } catch (error) {
    console.error('Error saving normalization data:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to save normalization data',
      message: error.message
    });
  }
});

// í°í´ê°œí†µë°ì´í„° ìˆ˜ì • API
app.post('/api/inspection/update-system-data', async (req, res) => {
  try {
    const { itemId, userId, field, correctValue, systemRow } = req.body;

    if (!itemId || !userId || !field || !correctValue || systemRow === null) {
      return res.status(400).json({
        success: false,
        error: 'Item ID, User ID, field, correct value, and system row are required'
      });
    }

    // í•„ë“œëª…ì— ë”°ë¥¸ ì»¬ëŸ¼ ì¸ë±ìŠ¤ ë§¤í•‘
    const fieldToColumnMap = {
      'ì´ë¦„': 1,      // Bì—´
      'ì „í™”ë²ˆí˜¸': 2,   // Cì—´
      'ì£¼ì†Œ': 3,      // Dì—´
      'ìƒë…„ì›”ì¼': 4,  // Eì—´
      'ì„±ë³„': 5,      // Fì—´
      // ë” ë§ì€ í•„ë“œ ë§¤í•‘ ì¶”ê°€ ê°€ëŠ¥
    };

    const columnIndex = fieldToColumnMap[field];
    if (columnIndex === undefined) {
      return res.status(400).json({
        success: false,
        error: 'Invalid field name'
      });
    }

    // í°í´ê°œí†µë°ì´í„° ì‹œíŠ¸ì—ì„œ í•´ë‹¹ í–‰ì˜ íŠ¹ì • ì»¬ëŸ¼ ìˆ˜ì •
    const range = `${CURRENT_MONTH_ACTIVATION_SHEET_NAME}!${String.fromCharCode(65 + columnIndex)}${systemRow}`;

    await sheets.spreadsheets.values.update({
      spreadsheetId: SPREADSHEET_ID,
      range: range,
      valueInputOption: 'USER_ENTERED',
      resource: {
        values: [[correctValue]]
      }
    });

    // ìˆ˜ì • ì´ë ¥ ì‹œíŠ¸ì— ê¸°ë¡
    const updateHistoryData = [
      [
        new Date().toISOString(), // ìˆ˜ì •ì¼ì‹œ
        userId,                   // ì²˜ë¦¬ì
        itemId,                   // í•­ëª© ID
        field,                    // í•„ë“œëª…
        correctValue,             // ìˆ˜ì •ëœ ê°’
        'í°í´ê°œí†µë°ì´í„° ìˆ˜ì •'     // ë¹„ê³ 
      ]
    ];

    await sheets.spreadsheets.values.append({
      spreadsheetId: SPREADSHEET_ID,
      range: `${INSPECTION_RESULT_SHEET_NAME}!A:F`,
      valueInputOption: 'USER_ENTERED',
      resource: {
        values: updateHistoryData
      }
    });

    // ìºì‹œ ë¬´íš¨í™”
    invalidateInspectionCache(userId);

    res.json({
      success: true,
      message: 'í°í´ê°œí†µë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.'
    });
  } catch (error) {
    console.error('Error updating system data:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to update system data',
      message: error.message
    });
  }
});

// ì‚¬ìš© ê°€ëŠ¥í•œ í•„ë“œ ëª©ë¡ ì¡°íšŒ API
app.get('/api/inspection/available-fields', async (req, res) => {
  try {
    const fields = COLUMN_MATCHING_CONFIG.map(config => ({
      key: config.manualField.key,
      name: config.manualField.name,
      description: config.description
    }));

    res.json({
      success: true,
      fields
    });
  } catch (error) {
    console.error('Error fetching available fields:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to fetch available fields',
      message: error.message
    });
  }
});

// í•„ë“œë³„ ê³ ìœ ê°’ ì¡°íšŒ API
app.get('/api/inspection/field-values', async (req, res) => {
  try {
    const { field } = req.query;

    if (!field) {
      return res.status(400).json({
        success: false,
        error: 'Field name is required'
      });
    }

    // í•„ë“œëª…ì— ë”°ë¥¸ ì»¬ëŸ¼ ì¸ë±ìŠ¤ ë§¤í•‘
    const fieldMapping = COLUMN_MAPPINGS.find(mapping => mapping.name === field);
    if (!fieldMapping) {
      return res.status(400).json({
        success: false,
        error: 'Invalid field name'
      });
    }

    const columnIndex = fieldMapping.manual;

    // ìˆ˜ê¸°ì´ˆì™€ í°í´ê°œí†µë°ì´í„°ì—ì„œ í•´ë‹¹ í•„ë“œì˜ ëª¨ë“  ê°’ ìˆ˜ì§‘
    const [manualValues, systemValues] = await Promise.all([
      getSheetValues(MANUAL_DATA_SHEET_NAME),
      getSheetValues(CURRENT_MONTH_ACTIVATION_SHEET_NAME)
    ]);

    const allValues = new Set();

    // ìˆ˜ê¸°ì´ˆì—ì„œ ê°’ ìˆ˜ì§‘
    if (manualValues && manualValues.length > 1) {
      manualValues.slice(1).forEach(row => {
        if (row.length > columnIndex && row[columnIndex]) {
          allValues.add(row[columnIndex].toString().trim());
        }
      });
    }

    // í°í´ê°œí†µë°ì´í„°ì—ì„œ ê°’ ìˆ˜ì§‘
    if (systemValues && systemValues.length > 1) {
      systemValues.slice(1).forEach(row => {
        if (row.length > columnIndex && row[columnIndex]) {
          allValues.add(row[columnIndex].toString().trim());
        }
      });
    }

    // ì •ê·œí™” ì´ë ¥ì—ì„œë„ ê°’ ìˆ˜ì§‘
    try {
      const normalizationResponse = await sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: `${NORMALIZATION_HISTORY_SHEET_NAME}!A:G`
      });

      if (normalizationResponse.data.values && normalizationResponse.data.values.length > 1) {
        normalizationResponse.data.values.slice(1).forEach(row => {
          if (row.length >= 6 && row[3] === field && row[5]) { // í•„ë“œëª…ì´ ì¼ì¹˜í•˜ê³  ì •ê·œí™”ê°’ì´ ìˆëŠ” ê²½ìš°
            allValues.add(row[5].toString().trim());
          }
        });
      }
    } catch (error) {
      // ì •ê·œí™” ì´ë ¥ ì‹œíŠ¸ê°€ ì—†ê±°ë‚˜ ë¹„ì–´ìˆëŠ” ê²½ìš° ë¬´ì‹œ
      console.log('ì •ê·œí™” ì´ë ¥ ì‹œíŠ¸ê°€ ì—†ê±°ë‚˜ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
    }

    const uniqueValues = Array.from(allValues).filter(value => value).sort();

    res.json({
      success: true,
      field,
      values: uniqueValues
    });
  } catch (error) {
    console.error('Error fetching field values:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to fetch field values',
      message: error.message
    });
  }
});

// ê²€ìˆ˜ ì™„ë£Œ ìƒíƒœ ì¡°íšŒ
app.get('/api/inspection/completion-status', async (req, res) => {
  try {
    const { userId } = req.query;

    if (!userId) {
      return res.status(400).json({
        success: false,
        error: 'User ID is required'
      });
    }

    // ê²€ìˆ˜ê²°ê³¼ ì‹œíŠ¸ì—ì„œ í•´ë‹¹ ì‚¬ìš©ìì˜ ì™„ë£Œ í•­ëª© ì¡°íšŒ
    let completionData = [];
    try {
      const response = await sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: `${INSPECTION_RESULT_SHEET_NAME}!A:E`
      });
      completionData = response.data.values || [];
    } catch (error) {
      // ì‹œíŠ¸ê°€ ì—†ê±°ë‚˜ ë¹„ì–´ìˆëŠ” ê²½ìš° ë¹ˆ ë°°ì—´ ë°˜í™˜
      console.log('ê²€ìˆ˜ê²°ê³¼ ì‹œíŠ¸ê°€ ì—†ê±°ë‚˜ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
    }

    // í—¤ë” ì œê±°í•˜ê³  í•´ë‹¹ ì‚¬ìš©ìì˜ ì™„ë£Œ í•­ëª©ë§Œ í•„í„°ë§
    const userCompletions = completionData
      .slice(1) // í—¤ë” ì œê±°
      .filter(row => row.length >= 3 && row[1] === userId) // ì²˜ë¦¬ì IDê°€ ì¼ì¹˜í•˜ëŠ” í•­ëª©
      .map(row => row[2]); // í•­ëª© IDë§Œ ì¶”ì¶œ

    res.json({
      success: true,
      completedItems: userCompletions
    });
  } catch (error) {
    console.error('Error fetching completion status:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to fetch completion status',
      message: error.message
    });
  }
});

// ì»¬ëŸ¼ ë§¤ì¹­ ì„¤ì • (ìˆ˜ê¸°ì´ˆ ì»¬ëŸ¼ â†” í°í´ê°œí†µë°ì´í„° ì»¬ëŸ¼)
const COLUMN_MATCHING_CONFIG = [
  {
    manualField: { name: 'ëŒ€ë¦¬ì ì½”ë“œ', key: 'store_code', column: 14 }, // Oì—´ (ê¸°ì¡´ Fì—´ì—ì„œ +9)
    systemField: { name: 'ë©”ëª¨2', key: 'memo2', column: 75 }, // BXì—´ (ê¸°ì¡´ BPì—´ì—ì„œ +8)
    regex: '\\d+', // ìˆ«ì ì¶”ì¶œ (6ìë¦¬ ì œí•œ ì œê±°)
    description: 'ëŒ€ë¦¬ì ì½”ë“œ ë¹„êµ (ë©”ëª¨2ì—ì„œ ìˆ«ì ì¶”ì¶œ)'
  },
  {
    manualField: { name: 'ê°œí†µì¼ì‹œë¶„', key: 'activation_datetime', column: 29 }, // ADì—´ (ê¸°ì¡´ Uì—´ì—ì„œ +9)
    systemField: { name: 'ê°œí†µì¼ì‹œë¶„', key: 'activation_datetime', column: 9 }, // Jì—´ (ê¸°ì¡´ Bì—´ì—ì„œ +8)
    description: 'ê°œí†µì¼ì‹œë¶„ ë¹„êµ (ì´ˆ ì œì™¸, 24ì‹œê°„ í˜•ì‹)'
  },
  {
    manualField: { name: 'ëª¨ë¸ëª…(ì¼ë ¨ë²ˆí˜¸)', key: 'model_serial', column: 38 }, // AMì—´ (ê¸°ì¡´ ADì—´ì—ì„œ +9)
    systemField: { name: 'ëª¨ë¸ëª…(ì¼ë ¨ë²ˆí˜¸)', key: 'model_serial', column: 21 }, // Vì—´ (ê¸°ì¡´ Nì—´ì—ì„œ +8)
    description: 'ëª¨ë¸ëª…ê³¼ ì¼ë ¨ë²ˆí˜¸ ë¹„êµ (ëª¨ë¸ëª… ì •ê·œí™”, ì¼ë ¨ë²ˆí˜¸ 6ìë¦¬ ë¹„êµ)'
  },
  {
    manualField: { name: 'ê°œí†µìœ í˜•', key: 'activation_type', column: 19 }, // Tì—´ (ê¸°ì¡´ Kì—´ì—ì„œ +9)
    systemField: { name: 'ê°œí†µìœ í˜•', key: 'activation_type', column: 19 }, // Tì—´ (ê¸°ì¡´ Lì—´ì—ì„œ +8)
    description: 'ê°œí†µìœ í˜• ë° Cíƒ€ê²Ÿì°¨ê°ëŒ€ìƒ ë¹„êµ (ê°€ì…êµ¬ë¶„+ì´ì „ì‚¬ì—…ì+ê¸°ë³€íƒ€ê²Ÿêµ¬ë¶„ ì •ê·œí™”)'
  },
  {
    manualField: { name: 'ì‹¤íŒë§¤POS', key: 'sales_pos', column: 16 }, // Qì—´ (ê¸°ì¡´ Hì—´ì—ì„œ +9)
    systemField: { name: 'ì‹¤íŒë§¤POS', key: 'sales_pos', column: 5 }, // Fì—´ (ìƒˆë¡œ ì¶”ê°€ëœ POSì½”ë“œ ì»¬ëŸ¼)
    description: 'ì‹¤íŒë§¤POS ë¹„êµ (ì§ì ‘ ë¹„êµ, ì „ëµì˜¨ë¼ì¸ ì œì™¸)'
  },
  {
    manualField: { name: 'ìš”ê¸ˆì œ', key: 'plan', column: 46 }, // AUì—´ (ê¸°ì¡´ ALì—´ì—ì„œ +9)
    systemField: { name: 'ìš”ê¸ˆì œ', key: 'plan', column: 29 }, // ADì—´ (ê¸°ì¡´ Vì—´ì—ì„œ +8)
    description: 'ìš”ê¸ˆì œ ë¹„êµ (VLOOKUP ë°©ì‹ ì •ê·œí™”, ANì—´ BLANK ì œì™¸)'
  },
  {
    manualField: { name: 'ì¶œê³ ê°€ìƒì´', key: 'shipping_virtual', column: 56 }, // BDì—´ (ê¸°ì¡´ AVì—´ì—ì„œ +9)
    systemField: { name: 'ì¶œê³ ê°€ìƒì´', key: 'shipping_virtual', column: 35 }, // AJì—´ (ê¸°ì¡´ ABì—´ì—ì„œ +8)
    description: 'ì¶œê³ ê°€ìƒì´ ë¹„êµ (ë”í•˜ê¸° ë°©ì‹ ì •ê·œí™”)'
  },
  {
    manualField: { name: 'ì§€ì›ê¸ˆ ë° ì•½ì •ìƒì´', key: 'support_contract', column: 94 }, // DQì—´ (ê¸°ì¡´ DHì—´ì—ì„œ +9)
    systemField: { name: 'ì§€ì›ê¸ˆ ë° ì•½ì •ìƒì´', key: 'support_contract', column: 36 }, // AKì—´ (ê¸°ì¡´ ACì—´ì—ì„œ +8)
    description: 'ì§€ì›ê¸ˆ ë° ì•½ì •ìƒì´ ë¹„êµ (ì„ íƒë°©ì‹ ì •ê·œí™”, ANì—´ BLANK ì œì™¸)'
  },
  {
    manualField: { name: 'í”„ë¦¬í• ë¶€ìƒì´', key: 'pre_installment', column: 56 }, // BEì—´
    systemField: { name: 'í”„ë¦¬í• ë¶€ìƒì´', key: 'pre_installment', column: 39 }, // ANì—´
    description: 'í”„ë¦¬í• ë¶€ìƒì´ ë¹„êµ (ì§ì ‘ ë¹„êµ, ANì—´ BLANK ì œì™¸)'
  },
  {
    manualField: { name: 'ìœ í†µë§ì§€ì›ê¸ˆ ìƒì´', key: 'distribution_support', column: 75 }, // BXì—´
    systemField: { name: 'ìœ í†µë§ì§€ì›ê¸ˆ ìƒì´', key: 'distribution_support', column: 37 }, // ALì—´
    description: 'ìœ í†µë§ì§€ì›ê¸ˆ ìƒì´ ë¹„êµ (ìˆ«ì ì„œì‹ ì •ê·œí™”)'
  },
  {
    manualField: { name: 'ìœ í”Œë ˆì´ ìœ ì¹˜ ì¶”ê°€', key: 'uplay_check', column: 127 }, // DXì—´ (ê¸°ì¡´ DOì—´ì—ì„œ +9)
    systemField: { name: 'ìœ í”Œë ˆì´ ìœ ì¹˜ ì¶”ê°€', key: 'uplay_check', column: 30 }, // AEì—´ (ê¸°ì¡´ Wì—´ì—ì„œ +8)
    description: 'ìœ í”Œë ˆì´ ìœ ì¹˜ ì¶”ê°€ (ë‹¨ì–´ í¬í•¨ ì—¬ë¶€ ë¹„êµ)'
  },
  {
    manualField: { name: 'Vì»¬ëŸ¬ë§ ìŒì•…ê°ìƒ í”ŒëŸ¬ìŠ¤ ìœ ì¹˜', key: 'vcoloring_music_plus', column: 119 }, // DPì—´
    systemField: { name: 'Vì»¬ëŸ¬ë§ ìŒì•…ê°ìƒ í”ŒëŸ¬ìŠ¤ ìœ ì¹˜', key: 'vcoloring_music_plus', column: 30 }, // AEì—´
    description: 'Vì»¬ëŸ¬ë§ ìŒì•…ê°ìƒ í”ŒëŸ¬ìŠ¤ ìœ ì¹˜ (ë‹¨ì–´ í¬í•¨ ì—¬ë¶€ ë¹„êµ)'
  },
  {
    manualField: { name: 'í°êµì²´ íŒ¨ìŠ¤ ìœ ì¹˜', key: 'phone_exchange_pass', column: 124 }, // DUì—´
    systemField: { name: 'í°êµì²´ íŒ¨ìŠ¤ ìœ ì¹˜', key: 'phone_exchange_pass', column: 30 }, // AEì—´
    description: 'í°êµì²´ íŒ¨ìŠ¤ ìœ ì¹˜ (ë‹¨ì–´ í¬í•¨ ì—¬ë¶€ ë¹„êµ)'
  },
  {
    manualField: { name: 'í°êµì²´ ìŠ¬ë¦¼ ìœ ì¹˜', key: 'phone_exchange_slim', column: 124 }, // DUì—´
    systemField: { name: 'í°êµì²´ ìŠ¬ë¦¼ ìœ ì¹˜', key: 'phone_exchange_slim', column: 30 }, // AEì—´
    description: 'í°êµì²´ ìŠ¬ë¦¼ ìœ ì¹˜ (ë‹¨ì–´ í¬í•¨ ì—¬ë¶€ ë¹„êµ)'
  },
  {
    manualField: { name: 'í° ì•ˆì‹¬íŒ¨ìŠ¤ ìœ ì¹˜', key: 'phone_safe_pass', column: 124 }, // DUì—´
    systemField: { name: 'í° ì•ˆì‹¬íŒ¨ìŠ¤ ìœ ì¹˜', key: 'phone_safe_pass', column: 30 }, // AEì—´
    description: 'í° ì•ˆì‹¬íŒ¨ìŠ¤ ìœ ì¹˜ (ë‹¨ì–´ í¬í•¨ ì—¬ë¶€ ë¹„êµ)'
  },
  {
    manualField: { name: 'ë³´í—˜ ë¯¸ìœ ì¹˜', key: 'insurance_no', column: 124 }, // DUì—´
    systemField: { name: 'ë³´í—˜ ë¯¸ìœ ì¹˜', key: 'insurance_no', column: 31 }, // AFì—´
    description: 'ë³´í—˜ ë¯¸ìœ ì¹˜ (í°í´: ë³´í—˜ í¬í•¨ì‹œ ë¯¸ìœ ì¹˜, ë¯¸í¬í•¨ì‹œ ìœ ì¹˜)'
  },
  {
    manualField: { name: 'í†µí™”ì—°ê²°ìŒ ìœ ì¹˜', key: 'call_ringtone', column: 131 }, // EBì—´
    systemField: { name: 'í†µí™”ì—°ê²°ìŒ ìœ ì¹˜', key: 'call_ringtone', column: 30 }, // AEì—´
    description: 'í†µí™”ì—°ê²°ìŒ ìœ ì¹˜ (ë‹¨ì–´ í¬í•¨ ì—¬ë¶€ ë¹„êµ)'
  },
  {
    manualField: { name: 'í†µí™”ì—°ê²°ìŒ ë¯¸ìœ ì¹˜', key: 'call_ringtone_no', column: 119 }, // DPì—´ ë˜ëŠ” EBì—´
    systemField: { name: 'í†µí™”ì—°ê²°ìŒ ë¯¸ìœ ì¹˜', key: 'call_ringtone_no', column: 31 }, // AFì—´
    description: 'í†µí™”ì—°ê²°ìŒ ë¯¸ìœ ì¹˜ (í°í´: í†µí™”ì—°ê²°ìŒ í¬í•¨ì‹œ ë¯¸ìœ ì¹˜, ë¯¸í¬í•¨ì‹œ ìœ ì¹˜)'
  },
  {
    manualField: { name: 'ì²­ì†Œë…„ìš”ê¸ˆì œì¶”ê°€ì •ì±…(1)ìœ ì¹˜', key: 'youth_plan_policy_1', column: 19 }, // Tì—´, AXì—´, CVì—´
    systemField: { name: 'ì²­ì†Œë…„ìš”ê¸ˆì œì¶”ê°€ì •ì±…(1)ìœ ì¹˜', key: 'youth_plan_policy_1', column: 30 }, // AEì—´
    description: 'ì²­ì†Œë…„ìš”ê¸ˆì œì¶”ê°€ì •ì±…(1)ìœ ì¹˜ (ë³µí•© ì¡°ê±´ ë¹„êµ)'
  },
  {
    manualField: { name: 'ì²­ì†Œë…„ìš”ê¸ˆì œì¶”ê°€ì •ì±…(2)ìœ ì¹˜', key: 'youth_plan_policy_2', column: 19 }, // Tì—´, AMì—´, CVì—´
    systemField: { name: 'ì²­ì†Œë…„ìš”ê¸ˆì œì¶”ê°€ì •ì±…(2)ìœ ì¹˜', key: 'youth_plan_policy_2', column: 30 }, // AEì—´
    description: 'ì²­ì†Œë…„ìš”ê¸ˆì œì¶”ê°€ì •ì±…(2)ìœ ì¹˜ (ë³µí•© ì¡°ê±´ ë¹„êµ)'
  },
  {
    manualField: { name: 'ìœ í†µë§ì§€ì›ê¸ˆ í™œì„±í™”ì •ì±…', key: 'distribution_support_activation', column: 19 }, // Tì—´, AXì—´, AMì—´, BXì—´
    systemField: { name: 'ìœ í†µë§ì§€ì›ê¸ˆ í™œì„±í™”ì •ì±…', key: 'distribution_support_activation', column: 30 }, // AEì—´
    description: 'ìœ í†µë§ì§€ì›ê¸ˆ í™œì„±í™”ì •ì±… (ë³µí•© ì¡°ê±´ ë¹„êµ)'
  },
  {
    manualField: { name: '115êµ° ì„ íƒì•½ì • ì°¨ê°', key: '115_group_contract_deduction', column: 19 }, // Tì—´, AXì—´, BQì—´, CUì—´, CVì—´
    systemField: { name: '115êµ° ì„ íƒì•½ì • ì°¨ê°', key: '115_group_contract_deduction', column: 31 }, // AFì—´
    description: '115êµ° ì„ íƒì•½ì • ì°¨ê° (ë³µí•© ì¡°ê±´ ë¹„êµ)'
  },
  {
    manualField: { name: 'ì„ íƒì•½ì • S721(010ì‹ ê·œ) ì°¨ê°', key: 's721_contract_deduction', column: 19 }, // Tì—´, AXì—´, AMì—´, BQì—´, CVì—´
    systemField: { name: 'ì„ íƒì•½ì • S721(010ì‹ ê·œ) ì°¨ê°', key: 's721_contract_deduction', column: 31 }, // AFì—´
    description: 'ì„ íƒì•½ì • S721(010ì‹ ê·œ) ì°¨ê° (ë³µí•© ì¡°ê±´ ë¹„êµ)'
  },
  {
    manualField: { name: 'ì„ íƒì•½ì • S931,S938,S937(MNP) ì°¨ê°', key: 's931_s938_s937_contract_deduction', column: 19 }, // Tì—´, AXì—´, AMì—´, BQì—´, CVì—´
    systemField: { name: 'ì„ íƒì•½ì • S931,S938,S937(MNP) ì°¨ê°', key: 's931_s938_s937_contract_deduction', column: 31 }, // AFì—´
    description: 'ì„ íƒì•½ì • S931,S938,S937(MNP) ì°¨ê° (ë³µí•© ì¡°ê±´ ë¹„êµ)'
  },
  {
    manualField: { name: 'ì„ íƒì•½ì • ì•„ì´í°16ë¥˜ì „ì²´(MNP) ì°¨ê°', key: 'iphone16_contract_deduction', column: 19 }, // Tì—´, AXì—´, AMì—´, BQì—´, CVì—´
    systemField: { name: 'ì„ íƒì•½ì • ì•„ì´í°16ë¥˜ì „ì²´(MNP) ì°¨ê°', key: 'iphone16_contract_deduction', column: 31 }, // AFì—´
    description: 'ì„ íƒì•½ì • ì•„ì´í°16ë¥˜ì „ì²´(MNP) ì°¨ê° (ë³µí•© ì¡°ê±´ ë¹„êµ)'
  },
  {
    manualField: { name: 'A166 44êµ° ëŒ€ìƒì™¸ìš”ê¸ˆì œ(MNP) ì°¨ê°', key: 'a166_44group_excluded_plan_deduction', column: 19 }, // Tì—´, AXì—´, AMì—´, BQì—´, CVì—´, ATì—´
    systemField: { name: 'A166 44êµ° ëŒ€ìƒì™¸ìš”ê¸ˆì œ(MNP) ì°¨ê°', key: 'a166_44group_excluded_plan_deduction', column: 31 }, // AFì—´
    description: 'A166 44êµ° ëŒ€ìƒì™¸ìš”ê¸ˆì œ(MNP) ì°¨ê° (ë³µí•© ì¡°ê±´ ë¹„êµ)'
  },
  {
    manualField: { name: 'A166 44êµ° ëŒ€ìƒì™¸ìš”ê¸ˆì œ(ê¸°ë³€) ì°¨ê°', key: 'a166_44group_excluded_plan_change_deduction', column: 19 }, // Tì—´, AMì—´, BQì—´, CVì—´, ATì—´
    systemField: { name: 'A166 44êµ° ëŒ€ìƒì™¸ìš”ê¸ˆì œ(ê¸°ë³€) ì°¨ê°', key: 'a166_44group_excluded_plan_change_deduction', column: 31 }, // AFì—´
    description: 'A166 44êµ° ëŒ€ìƒì™¸ìš”ê¸ˆì œ(ê¸°ë³€) ì°¨ê° (ë³µí•© ì¡°ê±´ ë¹„êµ)'
  },
  {
    manualField: { name: 'ì •ì±…ê¸°ë³€ ì°¨ê°', key: 'policy_change_deduction', column: 19 }, // Tì—´
    systemField: { name: 'ì •ì±…ê¸°ë³€ ì°¨ê°', key: 'policy_change_deduction', column: 31 }, // AFì—´
    description: 'ì •ì±…ê¸°ë³€ ì°¨ê° (ë‹¨ìˆœ ì¡°ê±´ ë¹„êµ)'
  },
  {
    manualField: { name: 'ê¸°ë³€ Cíƒ€ê²Ÿ ì°¨ê°', key: 'change_c_target_deduction', column: 89 }, // CLì—´
    systemField: { name: 'ê¸°ë³€ Cíƒ€ê²Ÿ ì°¨ê°', key: 'change_c_target_deduction', column: 31 }, // AFì—´
    description: 'ê¸°ë³€ Cíƒ€ê²Ÿ ì°¨ê° (ë‹¨ìˆœ ì¡°ê±´ ë¹„êµ)'
  },
  {
    manualField: { name: '33êµ°ë¯¸ë§Œ, ì‹œë‹ˆì–´1êµ°ì‹œ ì°¨ê°', key: '33group_senior1_deduction', column: 99 }, // CVì—´
    systemField: { name: '33êµ°ë¯¸ë§Œ, ì‹œë‹ˆì–´1êµ°ì‹œ ì°¨ê°', key: '33group_senior1_deduction', column: 31 }, // AFì—´
    description: '33êµ°ë¯¸ë§Œ, ì‹œë‹ˆì–´1êµ°ì‹œ ì°¨ê° (ë‹¨ìˆœ ì¡°ê±´ ë¹„êµ)'
  },
  {
    manualField: { name: 'ì˜¨ì„¸ì¼ ì „ëµì˜¨ë¼ì¸POS ì°¨ê°', key: 'onsale_strategy_online_pos_deduction', column: 82 }, // CEì—´
    systemField: { name: 'ì˜¨ì„¸ì¼ ì „ëµì˜¨ë¼ì¸POS ì°¨ê°', key: 'onsale_strategy_online_pos_deduction', column: 31 }, // AFì—´
    description: 'ì˜¨ì„¸ì¼ ì „ëµì˜¨ë¼ì¸POS ì°¨ê° (ë³µí•© ì¡°ê±´ ë¹„êµ)'
  },
  {
    manualField: { name: 'ìœ í”Œë ˆì´ ë¯¸ìœ ì¹˜ ì°¨ê°', key: 'uplay_no_check', column: 127 }, // DXì—´ (ê¸°ì¡´ DOì—´ì—ì„œ +9)
    systemField: { name: 'ìœ í”Œë ˆì´ ë¯¸ìœ ì¹˜ ì°¨ê°', key: 'uplay_no_check', column: 31 }, // AFì—´ (ê¸°ì¡´ Xì—´ì—ì„œ +8)
    description: 'ìœ í”Œë ˆì´ ë¯¸ìœ ì¹˜ ì°¨ê° (ë‹¨ì–´ ë¯¸í¬í•¨/í¬í•¨ ì—¬ë¶€ ë¹„êµ)'
  }
];

// ì •ê·œí‘œí˜„ì‹ìœ¼ë¡œ ê°’ ì¶”ì¶œ (ì‰¼í‘œ, ìŠ¬ë˜ì‹œ, ë„ì–´ì“°ê¸° êµ¬ë¶„í•˜ì—¬ ëª¨ë“  ìˆ«ì ì¶”ì¶œ)
function extractValueWithRegex(value, regex) {
  if (!regex || !value) return value;
  try {
    // ì‰¼í‘œ, ìŠ¬ë˜ì‹œ, ë„ì–´ì“°ê¸°ë¡œ ë¶„ë¦¬
    const parts = value.toString().split(/[,/\\s]+/);

    // ëª¨ë“  ë¶€ë¶„ì—ì„œ ì •ê·œí‘œí˜„ì‹ ë§¤ì¹˜ ì°¾ê¸°
    const allMatches = [];
    for (const part of parts) {
      const trimmed = part.trim();
      if (trimmed) {
        const matches = trimmed.match(new RegExp(regex, 'g'));
        if (matches) {
          allMatches.push(...matches);
        }
      }
    }
    return allMatches.join(', '); // ëª¨ë“  ë§¤ì¹˜ë¥¼ ì‰¼í‘œë¡œ ì—°ê²°í•˜ì—¬ ë°˜í™˜
  } catch (error) {
    console.error('ì •ê·œí‘œí˜„ì‹ ì˜¤ë¥˜:', error);
    return value;
  }
}

// ë””ë²„ê¹… ëŒ€ìƒ ì‹œë¦¬ì–¼ë²ˆí˜¸ ëª©ë¡ (í•„ìš”ì‹œì—ë§Œ ì‚¬ìš©)
const DEBUG_SERIAL_NUMBERS = [];
const DEBUG_SUBSCRIPTION_NUMBERS = [];

// ëª¨ë¸ëª… ì •ê·œí™” í•¨ìˆ˜
function normalizeModelName(modelName) {
  if (!modelName) return '';

  let normalized = modelName.toString().trim();

  // ì–¸ë”ìŠ¤ì½”ì–´ë¥¼ ì œê±°í•˜ê³  Gë¥¼ ì œê±°
  normalized = normalized.replace(/_/g, '').replace(/G$/i, '');

  return normalized;
}

// ì¼ë ¨ë²ˆí˜¸ ì •ê·œí™” í•¨ìˆ˜
function normalizeSerialNumber(serialNumber) {
  if (!serialNumber) return '';

  let serial = serialNumber.toString().trim();

  // ìˆ«ìì¸ì§€ í™•ì¸
  if (/^\d+$/.test(serial)) {
    // ìˆ«ìì¸ ê²½ìš°: ì˜¤ë¥¸ìª½ì—ì„œë¶€í„° 6ìë¦¬ë¡œ ë§ì¶¤
    // 6ìë¦¬ë³´ë‹¤ ë¶€ì¡±í•œ ê²½ìš° ì™¼ìª½ì— 0ì„ ë¶™ì—¬ì„œ 6ìë¦¬ë¡œ ë§ì¶¤
    if (serial.length > 6) {
      // 6ìë¦¬ë³´ë‹¤ ê¸´ ê²½ìš°: ì˜¤ë¥¸ìª½ì—ì„œ 6ìë¦¬ë§Œ ì‚¬ìš©
      return serial.slice(-6);
    } else {
      // 6ìë¦¬ë³´ë‹¤ ì§§ì€ ê²½ìš°: ì™¼ìª½ì— 0ì„ ë¶™ì—¬ì„œ 6ìë¦¬ë¡œ ë§ì¶¤
      return serial.padStart(6, '0');
    }
  } else {
    // ì˜ë¬¸ì´ í¬í•¨ëœ ê²½ìš°: ì•ì˜ 0ë“¤ì„ ì œê±°í•˜ê³  ë°˜í™˜
    const result = serial.replace(/^0+/, '');
    return result;
  }
}

// ìˆ«ì ì„œì‹ ì •ê·œí™” í•¨ìˆ˜ (#,### í˜•ì‹)
function normalizeNumberFormat(value) {
  // 0ê°’ë„ ìœ íš¨í•œ ê°’ìœ¼ë¡œ ì²˜ë¦¬
  if (value === null || value === undefined || value === '') return '';

  const strValue = value.toString().trim();

  // ìˆ«ìë§Œ ì¶”ì¶œ (ì‰¼í‘œ, ê³µë°±, ê¸°íƒ€ ë¬¸ì ì œê±°)
  const numericValue = strValue.replace(/[^\d.-]/g, '');

  if (!numericValue || numericValue === '-') return '';

  // ìˆ«ìë¡œ ë³€í™˜
  const num = parseFloat(numericValue);
  if (isNaN(num)) return '';

  // #,### í˜•ì‹ìœ¼ë¡œ í¬ë§·íŒ…
  return num.toLocaleString();
}

// ìˆ«ì ë”í•˜ê¸° ì—°ì‚° í•¨ìˆ˜
function addNumbers(values) {
  let sum = 0;
  for (const value of values) {
    if (value) {
      const numericValue = value.toString().replace(/[^\d.-]/g, '');
      const num = parseFloat(numericValue);
      if (!isNaN(num)) {
        sum += num;
      }
    }
  }
  return sum;
}

// ìˆ«ì ë¹¼ê¸° ì—°ì‚° í•¨ìˆ˜
function subtractNumbers(value1, value2) {
  const num1 = parseFloat(value1.toString().replace(/[^\d.-]/g, '')) || 0;
  const num2 = parseFloat(value2.toString().replace(/[^\d.-]/g, '')) || 0;
  return num1 - num2;
}

// ê°œí†µìœ í˜• ì •ê·œí™” í•¨ìˆ˜
function normalizeActivationType(manualRow, systemRow) {
  // ìˆ˜ê¸°ì´ˆ ë°ì´í„° ì •ê·œí™” (Kì—´, AOì—´, CCì—´ ì¡°í•©)
  let manualType = '';
  if (manualRow.length > 80) { // ìµœì†Œ CCì—´(80)ì€ ìˆì–´ì•¼ í•¨
    const joinType = (manualRow[19] || '').toString().trim(); // Kì—´: ê°€ì…êµ¬ë¶„ (10+9)
    const prevOperator = (manualRow[49] || '').toString().trim(); // AOì—´: ì´ì „ì‚¬ì—…ì (40+9)
    const changeTarget = (manualRow[89] || '').toString().trim(); // CCì—´: ê¸°ë³€íƒ€ê²Ÿêµ¬ë¶„ (80+9)
    const finalPolicy = (manualRow[48] || '').toString().trim(); // ANì—´: ìµœì¢…ì˜ì—…ì •ì±… (39+9)

    // ìˆ˜ê¸°ì´ˆ ì •ê·œí™” ë¡œì§
    if (joinType === 'ì‹ ê·œ') {
      if (prevOperator && prevOperator.includes('ì¼ë°˜ê°œí†µ')) {
        manualType = 'ì‹ ê·œ';
      } else {
        manualType = 'MNP';
      }
    } else if (joinType === 'ì¬ê°€ì…') {
      if (changeTarget && changeTarget.includes('ê¸°ë³€C')) {
        manualType = 'ë³´ìƒ(Cíƒ€ê²Ÿ)';
      } else {
        manualType = 'ë³´ìƒ';
      }
    } else if (joinType === 'ì •ì±…ê¸°ë³€') {
      if (changeTarget && changeTarget.includes('ê¸°ë³€C')) {
        manualType = 'ê¸°ë³€(Cíƒ€ê²Ÿ)';
      } else {
        manualType = 'ê¸°ë³€';
      }
    }

    // ì¤‘ê³  ì¡°ê±´ í™•ì¸ (ANì—´ì— "BLANK"ê°€ ìˆìœ¼ë©´ "ì¤‘ê³ -" ì ‘ë‘ì‚¬ ì¶”ê°€)
    if (finalPolicy && finalPolicy.includes('BLANK')) {
      manualType = `ì¤‘ê³ -${manualType}`;
    }
  }

  // í°í´ ë°ì´í„° ì •ê·œí™” (Lì—´, Xì—´ ì¡°í•©)
  let systemType = '';
  if (systemRow.length > 23) { // ìµœì†Œ Xì—´(23)ì€ ìˆì–´ì•¼ í•¨
    const activationType = (systemRow[19] || '').toString().trim(); // Lì—´: ê°œí†µ (11+8)
    const returnService = (systemRow[31] || '').toString().trim(); // Xì—´: í™˜ìˆ˜ì„œë¹„ìŠ¤ (23+8)
    const columnI = (systemRow[16] || '').toString().trim(); // Iì—´ (8+8)
    const columnE = (systemRow[12] || '').toString().trim(); // Eì—´ (4+8)

    // ì„ ë¶ˆê°œí†µ ì¡°ê±´ ë¨¼ì € í™•ì¸
    if (activationType && activationType.includes('ì„ ë¶ˆê°œí†µ')) {
      systemType = 'ì„ ë¶ˆê°œí†µ';

      // ì¤‘ê³  ì¡°ê±´ í™•ì¸ (Iì—´/Eì—´ì— "ì¤‘ê³ " í¬í•¨)
      if ((columnI && columnI.includes('ì¤‘ê³ ')) ||
        (columnE && columnE.includes('ì¤‘ê³ '))) {
        systemType = `ì¤‘ê³ -${systemType}`;
      }
    } else {
      // ê¸°ì¡´ í°í´ ì •ê·œí™” ë¡œì§
      if (activationType === 'ì‹ ê·œ') {
        if (!returnService.includes('Cíƒ€ê²Ÿ')) {
          systemType = 'ì‹ ê·œ';
        }
      } else if (activationType === 'MNP') {
        if (!returnService.includes('Cíƒ€ê²Ÿ')) {
          systemType = 'MNP';
        }
      } else if (activationType === 'ë³´ìƒ') {
        if (returnService.includes('Cíƒ€ê²Ÿ')) {
          systemType = 'ë³´ìƒ(Cíƒ€ê²Ÿ)';
        } else {
          systemType = 'ë³´ìƒ';
        }
      } else if (activationType === 'ê¸°ë³€') {
        if (returnService.includes('Cíƒ€ê²Ÿ')) {
          systemType = 'ê¸°ë³€(Cíƒ€ê²Ÿ)';
        } else {
          systemType = 'ê¸°ë³€';
        }
      }
    }
  }

  return { manualType, systemType };
}

// ì‹¤íŒë§¤POS ì •ê·œí™” í•¨ìˆ˜
function normalizeSalesPos(manualRow, systemRow, storeData = null) {
  // ìˆ˜ê¸°ì´ˆ ë°ì´í„° ì •ê·œí™” (Qì—´, Rì—´)
  let manualPos = '';
  if (manualRow.length > 17) { // ìµœì†Œ Rì—´(17)ì€ ìˆì–´ì•¼ í•¨
    const salesPos = (manualRow[16] || '').toString().trim(); // Qì—´: ì‹¤íŒë§¤POS
    const strategyOnline = (manualRow[17] || '').toString().trim(); // Rì—´: ì „ëµì˜¨ë¼ì¸ ì²´í¬

    // ì „ëµì˜¨ë¼ì¸ ì œì™¸ ì¡°ê±´
    if (strategyOnline && strategyOnline.includes('ì „ëµì˜¨ë¼ì¸')) {
      return { manualPos: '', systemPos: '' }; // ê²€ìˆ˜ ëŒ€ìƒì—ì„œ ì œì™¸
    }

    // ìˆ˜ê¸°ì´ˆ ì •ê·œí™”: Qì—´ ê°’ ê·¸ëŒ€ë¡œ ì‚¬ìš©
    manualPos = salesPos;
  }

  // í°í´ ë°ì´í„° ì •ê·œí™” (Fì—´ - ìƒˆë¡œ ì¶”ê°€ëœ POSì½”ë“œ ì»¬ëŸ¼)
  let systemPos = '';
  if (systemRow.length > 5) { // ìµœì†Œ Fì—´(5)ì€ ìˆì–´ì•¼ í•¨
    const posCode = (systemRow[5] || '').toString().trim(); // Fì—´: POSì½”ë“œ

    // í°í´ ì •ê·œí™”: Fì—´ POSì½”ë“œ ê°’ ê·¸ëŒ€ë¡œ ì‚¬ìš©
    systemPos = posCode;
  }

  return { manualPos, systemPos };
}

// ìš”ê¸ˆì œ ì •ê·œí™” í•¨ìˆ˜
function normalizePlan(manualRow, systemRow, planData = null) {
  // ìˆ˜ê¸°ì´ˆ ë°ì´í„° ì •ê·œí™” (ALì—´)
  let manualPlan = '';
  let manualPlanType = '';
  if (manualRow.length > 37) { // ìµœì†Œ ALì—´(37)ì€ ìˆì–´ì•¼ í•¨
    const planName = (manualRow[46] || '').toString().trim(); // ALì—´: ìµœì¢…ìš”ê¸ˆì œ (37+9)
    const finalPolicy = (manualRow[48] || '').toString().trim(); // ANì—´: ìµœì¢…ì˜ì—…ì •ì±… (39+9)

    // ANì—´ì— "BLANK" ë¬¸êµ¬ í¬í•¨ê±´ì€ ëŒ€ìƒì—ì„œ ì œì™¸
    if (finalPolicy && finalPolicy.toUpperCase().includes('BLANK')) {
      return { manualPlan: '', systemPlan: '', manualPlanType: '', systemPlanType: '' }; // ê²€ìˆ˜ ëŒ€ìƒì—ì„œ ì œì™¸
    }

    // ìˆ˜ê¸°ì´ˆ ì •ê·œí™”: ALì—´ & (VLOOKUP1) & (VLOOKUP2)
    if (planName && planData) {
      const vlookup1 = vlookupPlanNameToPlanCode(planName, planData);
      const vlookup2 = vlookupPlanNameToPlanType(planName, planData);

      const parts = [planName];
      if (vlookup1) parts.push(`(${vlookup1})`);
      if (vlookup2) parts.push(`(${vlookup2})`);

      manualPlan = parts.join(' & ');
      manualPlanType = vlookup2 || ''; // Uì—´ ê°’ ì €ì¥
    } else {
      manualPlan = planName;
    }
  }

  // í°í´ ë°ì´í„° ì •ê·œí™” (Vì—´)
  let systemPlan = '';
  let systemPlanType = '';
  if (systemRow.length > 21) { // ìµœì†Œ Vì—´(21)ì€ ìˆì–´ì•¼ í•¨
    const planCode = (systemRow[29] || '').toString().trim(); // Vì—´: ìš”ê¸ˆì œ (21+8)

    // í°í´ ì •ê·œí™”: VLOOKUP1 & (Vì—´) & (VLOOKUP2)
    if (planCode && planData) {
      const vlookup1 = vlookupPlanCodeToPlanName(planCode, planData);
      const vlookup2 = vlookupPlanCodeToPlanType(planCode, planData);

      const parts = [];
      if (vlookup1) parts.push(vlookup1);
      parts.push(`(${planCode})`);
      if (vlookup2) parts.push(`(${vlookup2})`);

      systemPlan = parts.join(' & ');
      systemPlanType = vlookup2 || ''; // Uì—´ ê°’ ì €ì¥
    } else {
      systemPlan = planCode ? `(${planCode})` : '';
    }
  }

  return { manualPlan, systemPlan, manualPlanType, systemPlanType };
}

// ì¶œê³ ê°€ìƒì´ ì •ê·œí™” í•¨ìˆ˜
function normalizeShippingVirtual(manualRow, systemRow) {
  // ìˆ˜ê¸°ì´ˆ ë°ì´í„° ì •ê·œí™” (AVì—´+AZì—´+AWì—´+BKì—´+BMì—´+BNì—´+BLì—´)
  let manualShipping = '';
  if (manualRow.length > 65) { // ìµœì†Œ BNì—´(65)ì€ ìˆì–´ì•¼ í•¨
    const avValue = (manualRow[56] || '').toString().trim(); // AVì—´ (47+9)
    const azValue = (manualRow[60] || '').toString().trim(); // AZì—´ (51+9)
    const awValue = (manualRow[57] || '').toString().trim(); // AWì—´ (48+9)
    const bkValue = (manualRow[71] || '').toString().trim(); // BKì—´ (62+9)
    const bmValue = (manualRow[73] || '').toString().trim(); // BMì—´ (64+9)
    const bnValue = (manualRow[74] || '').toString().trim(); // BNì—´ (65+9)
    const blValue = (manualRow[75] || '').toString().trim(); // BLì—´ (66+9)
    const finalPolicy = (manualRow[48] || '').toString().trim(); // ANì—´: ìµœì¢…ì˜ì—…ì •ì±… (39+9)

    // ANì—´ì— "BLANK" í¬í•¨ë˜ì–´ìˆìœ¼ë©´ ëŒ€ìƒì—ì„œ ì œì™¸
    if (finalPolicy && finalPolicy.toUpperCase().includes('BLANK')) {
      return { manualShipping: '', systemShipping: '' }; // ê²€ìˆ˜ ëŒ€ìƒì—ì„œ ì œì™¸
    }

    // ìˆ«ì ë”í•˜ê¸° ì—°ì‚°ìœ¼ë¡œ ì •ê·œí™”
    const values = [avValue, azValue, awValue, bkValue, bmValue, bnValue, blValue].filter(v => v);
    const sum = addNumbers(values);
    manualShipping = normalizeNumberFormat(sum);
  }

  // í°í´ ë°ì´í„° ì •ê·œí™” (ABì—´)
  let systemShipping = '';
  if (systemRow.length > 27) { // ìµœì†Œ ABì—´(27)ì€ ìˆì–´ì•¼ í•¨
    const abValue = (systemRow[35] || '').toString().trim(); // ABì—´: ì¶œê³ ê°€ìƒì´ (27+8)
    systemShipping = normalizeNumberFormat(abValue);
  }

  return { manualShipping, systemShipping };
}

// ì§€ì›ê¸ˆ ë° ì•½ì •ìƒì´ ì •ê·œí™” í•¨ìˆ˜
function normalizeSupportContract(manualRow, systemRow) {
  // ìˆ˜ê¸°ì´ˆ ë°ì´í„° ì •ê·œí™” (BHì—´ ë˜ëŠ” BKì—´)
  let manualSupport = '';
  if (manualRow.length > 62) { // ìµœì†Œ BKì—´(62)ì€ ìˆì–´ì•¼ í•¨
    const bhValue = (manualRow[68] || '').toString().trim(); // BHì—´ (59+9)
    const bkValue = (manualRow[71] || '').toString().trim(); // BKì—´ (62+9)
    const finalPolicy = (manualRow[48] || '').toString().trim(); // ANì—´: ìµœì¢…ì˜ì—…ì •ì±… (39+9)

    // ANì—´ì— "BLANK" í¬í•¨ë˜ì–´ìˆìœ¼ë©´ ëŒ€ìƒì—ì„œ ì œì™¸
    if (finalPolicy && finalPolicy.toUpperCase().includes('BLANK')) {
      return { manualSupport: '', systemSupport: '' }; // ê²€ìˆ˜ ëŒ€ìƒì—ì„œ ì œì™¸
    }

    // ì„ íƒë°©ì‹ ì •ê·œí™”: BHì—´ì— "ì„ íƒ" í¬í•¨ ì‹œ "ì„ íƒì•½ì •í• ì¸", ì•„ë‹ˆë©´ BKì—´
    console.log(`BHì—´ ê°’: "${bhValue}", BKì—´ ê°’: "${bkValue}"`);
    if (bhValue && bhValue.includes('ì„ íƒ')) {
      console.log('BHì—´ì— "ì„ íƒ" í¬í•¨ë¨ â†’ "ì„ íƒì•½ì •í• ì¸" ì„¤ì •');
      manualSupport = 'ì„ íƒì•½ì •í• ì¸';
    } else {
      console.log('BHì—´ì— "ì„ íƒ" ì—†ìŒ â†’ BKì—´ ìˆ«ì í˜•ì‹ìœ¼ë¡œ ì •ê·œí™”');
      manualSupport = normalizeNumberFormat(bkValue);
    }
  }

  // í°í´ ë°ì´í„° ì •ê·œí™” (ACì—´)
  let systemSupport = '';
  if (systemRow.length > 28) { // ìµœì†Œ ACì—´(28)ì€ ìˆì–´ì•¼ í•¨
    const acValue = (systemRow[36] || '').toString().trim(); // ACì—´: ì§€ì›ê¸ˆ ë° ì•½ì •ìƒì´ (28+8)

    // ì„ íƒë°©ì‹ ì •ê·œí™”: ACì—´ì— "ì„ íƒ" í¬í•¨ ì‹œ "ì„ íƒì•½ì •í• ì¸", ì•„ë‹ˆë©´ ìˆ«ì í˜•ì‹
    console.log(`ACì—´ ê°’: "${acValue}"`);
    if (acValue && acValue.includes('ì„ íƒ')) {
      console.log('ACì—´ì— "ì„ íƒ" í¬í•¨ë¨ â†’ "ì„ íƒì•½ì •í• ì¸" ì„¤ì •');
      systemSupport = 'ì„ íƒì•½ì •í• ì¸';
    } else {
      console.log('ACì—´ì— "ì„ íƒ" ì—†ìŒ â†’ ìˆ«ì í˜•ì‹ìœ¼ë¡œ ì •ê·œí™”');
      systemSupport = normalizeNumberFormat(acValue);
    }
  }

  return { manualSupport, systemSupport };
}

// í”„ë¦¬í• ë¶€ìƒì´ ì •ê·œí™” í•¨ìˆ˜
function normalizePreInstallment(manualRow, systemRow) {
  // ìˆ˜ê¸°ì´ˆ ë°ì´í„° ì •ê·œí™” (BEì—´)
  let manualPreInstallment = '';
  if (manualRow.length > 56) { // ìµœì†Œ BEì—´(56)ì€ ìˆì–´ì•¼ í•¨
    const beValue = (manualRow[56] || '').toString().trim(); // BEì—´: í”„ë¦¬í• ë¶€ìƒì´
    const finalPolicy = (manualRow[48] || '').toString().trim(); // ANì—´: ìµœì¢…ì˜ì—…ì •ì±… (39+9)

    // ANì—´ì— "BLANK" í¬í•¨ë˜ì–´ìˆìœ¼ë©´ ëŒ€ìƒì—ì„œ ì œì™¸
    if (finalPolicy && finalPolicy.toUpperCase().includes('BLANK')) {
      return { manualPreInstallment: '', systemPreInstallment: '' }; // ê²€ìˆ˜ ëŒ€ìƒì—ì„œ ì œì™¸
    }

    // BEì—´ì—ì„œ ì§ì ‘ ê°€ì ¸ì˜¤ê¸°
    manualPreInstallment = normalizeNumberFormat(beValue);
  }

  // í°í´ ë°ì´í„° ì •ê·œí™” (ANì—´)
  let systemPreInstallment = '';
  if (systemRow.length > 39) { // ìµœì†Œ ANì—´(39)ì€ ìˆì–´ì•¼ í•¨
    const anValue = (systemRow[39] || '').toString().trim(); // ANì—´: í”„ë¦¬í• ë¶€ìƒì´

    // ANì—´ì—ì„œ ì§ì ‘ ê°€ì ¸ì˜¤ê¸°
    systemPreInstallment = normalizeNumberFormat(anValue);
  }

  return { manualPreInstallment, systemPreInstallment };
}

// ìœ í†µë§ì§€ì›ê¸ˆ ìƒì´ ì •ê·œí™” í•¨ìˆ˜
function normalizeDistributionSupport(manualRow, systemRow) {
  // ìˆ˜ê¸°ì´ˆ ë°ì´í„° ì •ê·œí™” (BXì—´)
  let manualDistribution = '';
  if (manualRow.length > 75) { // ìµœì†Œ BXì—´(75)ì€ ìˆì–´ì•¼ í•¨
    const bxValue = (manualRow[75] || '').toString().trim(); // BXì—´: ìœ í†µë§ì§€ì›ê¸ˆì•¡
    manualDistribution = normalizeNumberFormat(bxValue);
  }

  // í°í´ ë°ì´í„° ì •ê·œí™” (ALì—´)
  let systemDistribution = '';
  if (systemRow.length > 37) { // ìµœì†Œ ALì—´(37)ì€ ìˆì–´ì•¼ í•¨
    const alValue = (systemRow[37] || '').toString().trim(); // ALì—´: ìœ í†µë§ì§€ì›ê¸ˆ
    // ê³µë°±ì´ë©´ 0ìœ¼ë¡œ í‘œê¸°
    if (!alValue || alValue === '') {
      systemDistribution = '0';
    } else {
      systemDistribution = normalizeNumberFormat(alValue);
    }
  }

  return { manualDistribution, systemDistribution };
}

// ìœ í”Œë ˆì´ ìœ ì¹˜ ì¶”ê°€ ì •ê·œí™” í•¨ìˆ˜
function normalizeUplayCheck(manualRow, systemRow) {
  // ìˆ˜ê¸°ì´ˆ ë°ì´í„° ì •ê·œí™” (DXì—´)
  let manualValue = 'ìœ í”Œë ˆì´ ìœ ì¹˜ ì¶”ê°€ ë¹„ëŒ€ìƒ'; // ê¸°ë³¸ê°’ ì„¤ì •
  if (manualRow.length > 127) { // ìµœì†Œ DXì—´(127)ì€ ìˆì–´ì•¼ í•¨
    const uplayValue = (manualRow[127] || '').toString().trim(); // DXì—´: ìœ í”Œë ˆì´

    // "ìœ í”Œë ˆì´" í¬í•¨ ì‹œ "ìœ í”Œë ˆì´ ìœ ì¹˜ ì¶”ê°€" í‘œê¸°
    if (uplayValue && uplayValue.includes('ìœ í”Œë ˆì´')) {
      manualValue = 'ìœ í”Œë ˆì´ ìœ ì¹˜ ì¶”ê°€ ëŒ€ìƒ';
    } else {
      manualValue = 'ìœ í”Œë ˆì´ ìœ ì¹˜ ì¶”ê°€ ë¹„ëŒ€ìƒ';
    }
  }

  // í°í´ ë°ì´í„° ì •ê·œí™” (AEì—´)
  let systemValue = 'ìœ í”Œë ˆì´ ìœ ì¹˜ ì¶”ê°€ ë¹„ëŒ€ìƒ'; // ê¸°ë³¸ê°’ ì„¤ì •
  if (systemRow.length > 30) { // ìµœì†Œ AEì—´(30)ì€ ìˆì–´ì•¼ í•¨
    const uplayValue = (systemRow[30] || '').toString().trim(); // AEì—´: ìœ í”Œë ˆì´

    // "ìœ í”Œë ˆì´" í¬í•¨ ì‹œ "ìœ í”Œë ˆì´ ìœ ì¹˜ ì¶”ê°€" í‘œê¸°
    if (uplayValue && uplayValue.includes('ìœ í”Œë ˆì´')) {
      systemValue = 'ìœ í”Œë ˆì´ ìœ ì¹˜ ì¶”ê°€ ëŒ€ìƒ';
    } else {
      systemValue = 'ìœ í”Œë ˆì´ ìœ ì¹˜ ì¶”ê°€ ë¹„ëŒ€ìƒ';
    }
  }

  return { manualValue, systemValue };
}

// Vì»¬ëŸ¬ë§ ìŒì•…ê°ìƒ í”ŒëŸ¬ìŠ¤ ìœ ì¹˜ ì •ê·œí™” í•¨ìˆ˜
function normalizeVcoloringMusicPlus(manualRow, systemRow) {
  // ìˆ˜ê¸°ì´ˆ ë°ì´í„° ì •ê·œí™” (DPì—´)
  let manualValue = 'Vì»¬ëŸ¬ë§ ìŒì•…ê°ìƒ í”ŒëŸ¬ìŠ¤ ë¯¸ìœ ì¹˜'; // ê¸°ë³¸ê°’ ì„¤ì •
  if (manualRow.length > 119) { // ìµœì†Œ DPì—´(119)ì€ ìˆì–´ì•¼ í•¨
    const musicValue = (manualRow[119] || '').toString().trim(); // DPì—´: ë®¤ì§ë¥˜

    // "Vì»¬ëŸ¬ë§ ìŒì•…ê°ìƒ í”ŒëŸ¬ìŠ¤" ë‹¨ì–´ í¬í•¨ ì—¬ë¶€ë¡œ ì •ê·œí™”
    if (musicValue && musicValue.includes('Vì»¬ëŸ¬ë§ ìŒì•…ê°ìƒ í”ŒëŸ¬ìŠ¤')) {
      manualValue = 'Vì»¬ëŸ¬ë§ ìŒì•…ê°ìƒ í”ŒëŸ¬ìŠ¤ ìœ ì¹˜';
    } else {
      manualValue = 'Vì»¬ëŸ¬ë§ ìŒì•…ê°ìƒ í”ŒëŸ¬ìŠ¤ ë¯¸ìœ ì¹˜';
    }
  }

  // í°í´ ë°ì´í„° ì •ê·œí™” (AEì—´)
  let systemValue = 'Vì»¬ëŸ¬ë§ ìŒì•…ê°ìƒ í”ŒëŸ¬ìŠ¤ ë¯¸ìœ ì¹˜'; // ê¸°ë³¸ê°’ ì„¤ì •
  if (systemRow.length > 30) { // ìµœì†Œ AEì—´(30)ì€ ìˆì–´ì•¼ í•¨
    const serviceValue = (systemRow[30] || '').toString().trim(); // AEì—´: ë¶€ê°€ì„œë¹„ìŠ¤

    // "Vì»¬ëŸ¬ë§ ìŒì•…ê°ìƒ í”ŒëŸ¬ìŠ¤" ë‹¨ì–´ í¬í•¨ ì—¬ë¶€ë¡œ ì •ê·œí™”
    if (serviceValue && serviceValue.includes('Vì»¬ëŸ¬ë§ ìŒì•…ê°ìƒ í”ŒëŸ¬ìŠ¤')) {
      systemValue = 'Vì»¬ëŸ¬ë§ ìŒì•…ê°ìƒ í”ŒëŸ¬ìŠ¤ ìœ ì¹˜';
    } else {
      systemValue = 'Vì»¬ëŸ¬ë§ ìŒì•…ê°ìƒ í”ŒëŸ¬ìŠ¤ ë¯¸ìœ ì¹˜';
    }
  }

  return { manualValue, systemValue };
}

// í°êµì²´ íŒ¨ìŠ¤ ìœ ì¹˜ ì •ê·œí™” í•¨ìˆ˜
function normalizePhoneExchangePass(manualRow, systemRow) {
  // ìˆ˜ê¸°ì´ˆ ë°ì´í„° ì •ê·œí™” (DUì—´)
  let manualValue = 'í°êµì²´ íŒ¨ìŠ¤ ë¯¸ìœ ì¹˜'; // ê¸°ë³¸ê°’ ì„¤ì •
  if (manualRow.length > 124) { // ìµœì†Œ DUì—´(124)ì€ ìˆì–´ì•¼ í•¨
    const insuranceValue = (manualRow[124] || '').toString().trim(); // DUì—´: ë³´í—˜(í°êµì²´)

    // "í°êµì²´ íŒ¨ìŠ¤" ë‹¨ì–´ í¬í•¨ ì—¬ë¶€ë¡œ ì •ê·œí™”
    if (insuranceValue && insuranceValue.includes('í°êµì²´ íŒ¨ìŠ¤')) {
      manualValue = 'í°êµì²´ íŒ¨ìŠ¤ ìœ ì¹˜';
    } else {
      manualValue = 'í°êµì²´ íŒ¨ìŠ¤ ë¯¸ìœ ì¹˜';
    }
  }

  // í°í´ ë°ì´í„° ì •ê·œí™” (AEì—´)
  let systemValue = 'í°êµì²´ íŒ¨ìŠ¤ ë¯¸ìœ ì¹˜'; // ê¸°ë³¸ê°’ ì„¤ì •
  if (systemRow.length > 30) { // ìµœì†Œ AEì—´(30)ì€ ìˆì–´ì•¼ í•¨
    const serviceValue = (systemRow[30] || '').toString().trim(); // AEì—´: ë¶€ê°€ì„œë¹„ìŠ¤

    // "í°êµì²´íŒ¨ìŠ¤" ë‹¨ì–´ í¬í•¨ ì—¬ë¶€ë¡œ ì •ê·œí™” (ê³µë°± ì—†ìŒ)
    if (serviceValue && serviceValue.includes('í°êµì²´íŒ¨ìŠ¤')) {
      systemValue = 'í°êµì²´ íŒ¨ìŠ¤ ìœ ì¹˜';
    } else {
      systemValue = 'í°êµì²´ íŒ¨ìŠ¤ ë¯¸ìœ ì¹˜';
    }
  }

  return { manualValue, systemValue };
}

// í°êµì²´ ìŠ¬ë¦¼ ìœ ì¹˜ ì •ê·œí™” í•¨ìˆ˜
function normalizePhoneExchangeSlim(manualRow, systemRow) {
  // ìˆ˜ê¸°ì´ˆ ë°ì´í„° ì •ê·œí™” (DUì—´)
  let manualValue = 'í°êµì²´ ìŠ¬ë¦¼ ë¯¸ìœ ì¹˜'; // ê¸°ë³¸ê°’ ì„¤ì •
  if (manualRow.length > 124) { // ìµœì†Œ DUì—´(124)ì€ ìˆì–´ì•¼ í•¨
    const insuranceValue = (manualRow[124] || '').toString().trim(); // DUì—´: ë³´í—˜(í°êµì²´)

    // "í°êµì²´ ìŠ¬ë¦¼" ë‹¨ì–´ í¬í•¨ ì—¬ë¶€ë¡œ ì •ê·œí™”
    if (insuranceValue && insuranceValue.includes('í°êµì²´ ìŠ¬ë¦¼')) {
      manualValue = 'í°êµì²´ ìŠ¬ë¦¼ ìœ ì¹˜';
    } else {
      manualValue = 'í°êµì²´ ìŠ¬ë¦¼ ë¯¸ìœ ì¹˜';
    }
  }

  // í°í´ ë°ì´í„° ì •ê·œí™” (AEì—´)
  let systemValue = 'í°êµì²´ ìŠ¬ë¦¼ ë¯¸ìœ ì¹˜'; // ê¸°ë³¸ê°’ ì„¤ì •
  if (systemRow.length > 30) { // ìµœì†Œ AEì—´(30)ì€ ìˆì–´ì•¼ í•¨
    const serviceValue = (systemRow[30] || '').toString().trim(); // AEì—´: ë¶€ê°€ì„œë¹„ìŠ¤

    // "í°êµì²´ìŠ¬ë¦¼" ë‹¨ì–´ í¬í•¨ ì—¬ë¶€ë¡œ ì •ê·œí™” (ê³µë°± ì—†ìŒ)
    if (serviceValue && serviceValue.includes('í°êµì²´ìŠ¬ë¦¼')) {
      systemValue = 'í°êµì²´ ìŠ¬ë¦¼ ìœ ì¹˜';
    } else {
      systemValue = 'í°êµì²´ ìŠ¬ë¦¼ ë¯¸ìœ ì¹˜';
    }
  }

  return { manualValue, systemValue };
}

// í° ì•ˆì‹¬íŒ¨ìŠ¤ ìœ ì¹˜ ì •ê·œí™” í•¨ìˆ˜
function normalizePhoneSafePass(manualRow, systemRow) {
  // ìˆ˜ê¸°ì´ˆ ë°ì´í„° ì •ê·œí™” (DUì—´)
  let manualValue = 'í° ì•ˆì‹¬íŒ¨ìŠ¤ ë¯¸ìœ ì¹˜'; // ê¸°ë³¸ê°’ ì„¤ì •
  if (manualRow.length > 124) { // ìµœì†Œ DUì—´(124)ì€ ìˆì–´ì•¼ í•¨
    const insuranceValue = (manualRow[124] || '').toString().trim(); // DUì—´: ë³´í—˜(í°êµì²´)

    // "í° ì•ˆì‹¬íŒ¨ìŠ¤" ë‹¨ì–´ í¬í•¨ ì—¬ë¶€ë¡œ ì •ê·œí™”
    if (insuranceValue && insuranceValue.includes('í° ì•ˆì‹¬íŒ¨ìŠ¤')) {
      manualValue = 'í° ì•ˆì‹¬íŒ¨ìŠ¤ ìœ ì¹˜';
    } else {
      manualValue = 'í° ì•ˆì‹¬íŒ¨ìŠ¤ ë¯¸ìœ ì¹˜';
    }
  }

  // í°í´ ë°ì´í„° ì •ê·œí™” (AEì—´)
  let systemValue = 'í° ì•ˆì‹¬íŒ¨ìŠ¤ ë¯¸ìœ ì¹˜'; // ê¸°ë³¸ê°’ ì„¤ì •
  if (systemRow.length > 30) { // ìµœì†Œ AEì—´(30)ì€ ìˆì–´ì•¼ í•¨
    const serviceValue = (systemRow[30] || '').toString().trim(); // AEì—´: ë¶€ê°€ì„œë¹„ìŠ¤

    // "í° ì•ˆì‹¬íŒ¨ìŠ¤" ë‹¨ì–´ í¬í•¨ ì—¬ë¶€ë¡œ ì •ê·œí™”
    if (serviceValue && serviceValue.includes('í° ì•ˆì‹¬íŒ¨ìŠ¤')) {
      systemValue = 'í° ì•ˆì‹¬íŒ¨ìŠ¤ ìœ ì¹˜';
    } else {
      systemValue = 'í° ì•ˆì‹¬íŒ¨ìŠ¤ ë¯¸ìœ ì¹˜';
    }
  }

  return { manualValue, systemValue };
}

// ë³´í—˜ ë¯¸ìœ ì¹˜ ì •ê·œí™” í•¨ìˆ˜
function normalizeInsuranceNo(manualRow, systemRow) {
  // ìˆ˜ê¸°ì´ˆ ë°ì´í„° ì •ê·œí™” (DUì—´)
  let manualValue = 'ë³´í—˜ ë¯¸ìœ ì¹˜'; // ê¸°ë³¸ê°’ ì„¤ì •
  if (manualRow.length > 124) { // ìµœì†Œ DUì—´(124)ì€ ìˆì–´ì•¼ í•¨
    const insuranceValue = (manualRow[124] || '').toString().trim(); // DUì—´: ë³´í—˜(í°êµì²´)

    // "í° ì•ˆì‹¬íŒ¨ìŠ¤" ë˜ëŠ” "í°êµì²´ íŒ¨ìŠ¤" ë˜ëŠ” "í°êµì²´ ìŠ¬ë¦¼" í¬í•¨ ì—¬ë¶€ë¡œ ì •ê·œí™”
    if (insuranceValue && (
      insuranceValue.includes('í° ì•ˆì‹¬íŒ¨ìŠ¤') ||
      insuranceValue.includes('í°êµì²´ íŒ¨ìŠ¤') ||
      insuranceValue.includes('í°êµì²´ ìŠ¬ë¦¼')
    )) {
      manualValue = 'ë³´í—˜ ìœ ì¹˜';
    } else {
      manualValue = 'ë³´í—˜ ë¯¸ìœ ì¹˜';
    }
  }

  // í°í´ ë°ì´í„° ì •ê·œí™” (AFì—´)
  let systemValue = 'ë³´í—˜ ë¯¸ìœ ì¹˜'; // ê¸°ë³¸ê°’ ì„¤ì •
  if (systemRow.length > 31) { // ìµœì†Œ AFì—´(31)ì€ ìˆì–´ì•¼ í•¨
    const serviceValue = (systemRow[31] || '').toString().trim(); // AFì—´: í™˜ìˆ˜ì„œë¹„ìŠ¤

    // "ë³´í—˜" ë‹¨ì–´ í¬í•¨ ì—¬ë¶€ë¡œ ì •ê·œí™” (í¬í•¨ì‹œ ë¯¸ìœ ì¹˜, ë¯¸í¬í•¨ì‹œ ìœ ì¹˜)
    if (serviceValue && serviceValue.includes('ë³´í—˜')) {
      systemValue = 'ë³´í—˜ ë¯¸ìœ ì¹˜';
    } else {
      systemValue = 'ë³´í—˜ ìœ ì¹˜';
    }
  }

  return { manualValue, systemValue };
}

// í†µí™”ì—°ê²°ìŒ ìœ ì¹˜ ì •ê·œí™” í•¨ìˆ˜
function normalizeCallRingtone(manualRow, systemRow) {
  // ìˆ˜ê¸°ì´ˆ ë°ì´í„° ì •ê·œí™” (EBì—´)
  let manualValue = 'í†µí™”ì—°ê²°ìŒ ë¯¸ìœ ì¹˜'; // ê¸°ë³¸ê°’ ì„¤ì •
  if (manualRow.length > 131) { // ìµœì†Œ EBì—´(131)ì€ ìˆì–´ì•¼ í•¨
    const ringtoneValue = (manualRow[131] || '').toString().trim(); // EBì—´: í†µí™”ì—°ê²°ìŒ

    // "Vì»¬ëŸ¬ë§ ê¸°ë³¸" ë˜ëŠ” "ì§€ì •ë²ˆí˜¸ í•„í„°ë§" í¬í•¨ ì—¬ë¶€ë¡œ ì •ê·œí™”
    if (ringtoneValue && (
      ringtoneValue.includes('Vì»¬ëŸ¬ë§ ê¸°ë³¸') ||
      ringtoneValue.includes('ì§€ì •ë²ˆí˜¸ í•„í„°ë§')
    )) {
      manualValue = 'í†µí™”ì—°ê²°ìŒ ìœ ì¹˜';
    } else {
      manualValue = 'í†µí™”ì—°ê²°ìŒ ë¯¸ìœ ì¹˜';
    }
  }

  // í°í´ ë°ì´í„° ì •ê·œí™” (AEì—´)
  let systemValue = 'í†µí™”ì—°ê²°ìŒ ë¯¸ìœ ì¹˜'; // ê¸°ë³¸ê°’ ì„¤ì •
  if (systemRow.length > 30) { // ìµœì†Œ AEì—´(30)ì€ ìˆì–´ì•¼ í•¨
    const serviceValue = (systemRow[30] || '').toString().trim(); // AEì—´: ë¶€ê°€ì„œë¹„ìŠ¤

    // "Vì»¬ëŸ¬ë§ ê¸°ë³¸" ë˜ëŠ” "ì§€ì •ë²ˆí˜¸í•„í„°ë§" í¬í•¨ ì—¬ë¶€ë¡œ ì •ê·œí™” (ê³µë°± ì—†ìŒ)
    if (serviceValue && (
      serviceValue.includes('Vì»¬ëŸ¬ë§ ê¸°ë³¸') ||
      serviceValue.includes('ì§€ì •ë²ˆí˜¸í•„í„°ë§')
    )) {
      systemValue = 'í†µí™”ì—°ê²°ìŒ ìœ ì¹˜';
    } else {
      systemValue = 'í†µí™”ì—°ê²°ìŒ ë¯¸ìœ ì¹˜';
    }
  }

  return { manualValue, systemValue };
}

// í†µí™”ì—°ê²°ìŒ ë¯¸ìœ ì¹˜ ì •ê·œí™” í•¨ìˆ˜
function normalizeCallRingtoneNo(manualRow, systemRow) {
  // ìˆ˜ê¸°ì´ˆ ë°ì´í„° ì •ê·œí™” (DPì—´ ë˜ëŠ” EBì—´)
  let manualValue = 'í†µí™”ì—°ê²°ìŒ ë¯¸ìœ ì¹˜'; // ê¸°ë³¸ê°’ ì„¤ì •
  if (manualRow.length > 119) { // ìµœì†Œ DPì—´(119)ì€ ìˆì–´ì•¼ í•¨
    const musicValue = (manualRow[119] || '').toString().trim(); // DPì—´: ë®¤ì§ë¥˜
    const ringtoneValue = (manualRow.length > 131 ? (manualRow[131] || '').toString().trim() : ''); // EBì—´: í†µí™”ì—°ê²°ìŒ

    // "Vì»¬ëŸ¬ë§ ê¸°ë³¸" ë˜ëŠ” "ì§€ì •ë²ˆí˜¸ í•„í„°ë§" ë˜ëŠ” "Vì»¬ëŸ¬ë§ ìŒì•…ê°ìƒ í”ŒëŸ¬ìŠ¤" í¬í•¨ ì—¬ë¶€ë¡œ ì •ê·œí™”
    const combinedValue = musicValue + ' ' + ringtoneValue;
    if (combinedValue && (
      combinedValue.includes('Vì»¬ëŸ¬ë§ ê¸°ë³¸') ||
      combinedValue.includes('ì§€ì •ë²ˆí˜¸ í•„í„°ë§') ||
      combinedValue.includes('Vì»¬ëŸ¬ë§ ìŒì•…ê°ìƒ í”ŒëŸ¬ìŠ¤')
    )) {
      manualValue = 'í†µí™”ì—°ê²°ìŒ ìœ ì¹˜';
    } else {
      manualValue = 'í†µí™”ì—°ê²°ìŒ ë¯¸ìœ ì¹˜';
    }
  }

  // í°í´ ë°ì´í„° ì •ê·œí™” (AFì—´)
  let systemValue = 'í†µí™”ì—°ê²°ìŒ ë¯¸ìœ ì¹˜'; // ê¸°ë³¸ê°’ ì„¤ì •
  if (systemRow.length > 31) { // ìµœì†Œ AFì—´(31)ì€ ìˆì–´ì•¼ í•¨
    const serviceValue = (systemRow[31] || '').toString().trim(); // AFì—´: í™˜ìˆ˜ì„œë¹„ìŠ¤

    // "í†µí™”ì—°ê²°ìŒ" í¬í•¨ ì—¬ë¶€ë¡œ ì •ê·œí™” (í¬í•¨ì‹œ ë¯¸ìœ ì¹˜, ë¯¸í¬í•¨ì‹œ ìœ ì¹˜)
    if (serviceValue && serviceValue.includes('í†µí™”ì—°ê²°ìŒ')) {
      systemValue = 'í†µí™”ì—°ê²°ìŒ ë¯¸ìœ ì¹˜';
    } else {
      systemValue = 'í†µí™”ì—°ê²°ìŒ ìœ ì¹˜';
    }
  }

  return { manualValue, systemValue };
}

// ì²­ì†Œë…„ìš”ê¸ˆì œì¶”ê°€ì •ì±…(1)ìœ ì¹˜ ì •ê·œí™” í•¨ìˆ˜
function normalizeYouthPlanPolicy1(manualRow, systemRow) {
  // ìˆ˜ê¸°ì´ˆ ë°ì´í„° ì •ê·œí™” (Tì—´, AXì—´, CVì—´)
  let manualValue = 'ì²­ì†Œë…„ìš”ê¸ˆì œì¶”ê°€ì •ì±…(1) ë¯¸ìœ ì¹˜'; // ê¸°ë³¸ê°’ ì„¤ì •
  if (manualRow.length > 99) { // ìµœì†Œ CVì—´(99)ì€ ìˆì–´ì•¼ í•¨
    const joinType = (manualRow[19] || '').toString().trim(); // Tì—´: ê°€ì…êµ¬ë¶„
    const prevCarrier = (manualRow[49] || '').toString().trim(); // AXì—´: ì´ì „ì‚¬ì—…ì
    const planType = (manualRow[99] || '').toString().trim(); // CVì—´: ìš”ê¸ˆì œìœ í˜•ëª…

    // ë³µí•© ì¡°ê±´: ê°€ì…êµ¬ë¶„ì´ "ì‹ ê·œ" í¬í•¨, ì´ì „ì‚¬ì—…ìê°€ "ì¼ë°˜ê°œí†µ" í¬í•¨, ìš”ê¸ˆì œìœ í˜•ëª…ì´ "ì²­ì†Œë…„" ë˜ëŠ” "í‚¤ì¦ˆ" í¬í•¨
    if (joinType && joinType.includes('ì‹ ê·œ') &&
      prevCarrier && prevCarrier.includes('ì¼ë°˜ê°œí†µ') &&
      planType && (planType.includes('ì²­ì†Œë…„') || planType.includes('í‚¤ì¦ˆ'))) {
      manualValue = 'ì²­ì†Œë…„ìš”ê¸ˆì œì¶”ê°€ì •ì±…(1) ìœ ì¹˜';
    } else {
      manualValue = 'ì²­ì†Œë…„ìš”ê¸ˆì œì¶”ê°€ì •ì±…(1) ë¯¸ìœ ì¹˜';
    }
  }

  // í°í´ ë°ì´í„° ì •ê·œí™” (AEì—´)
  let systemValue = 'ì²­ì†Œë…„ìš”ê¸ˆì œì¶”ê°€ì •ì±…(1) ë¯¸ìœ ì¹˜'; // ê¸°ë³¸ê°’ ì„¤ì •
  if (systemRow.length > 30) { // ìµœì†Œ AEì—´(30)ì€ ìˆì–´ì•¼ í•¨
    const serviceValue = (systemRow[30] || '').toString().trim(); // AEì—´: ë¶€ê°€ì„œë¹„ìŠ¤

    // "ì²­ì†Œë…„ì¶”ê°€â‘ " í¬í•¨ ì—¬ë¶€ë¡œ ì •ê·œí™”
    if (serviceValue && serviceValue.includes('ì²­ì†Œë…„ì¶”ê°€â‘ ')) {
      systemValue = 'ì²­ì†Œë…„ìš”ê¸ˆì œì¶”ê°€ì •ì±…(1) ìœ ì¹˜';
    } else {
      systemValue = 'ì²­ì†Œë…„ìš”ê¸ˆì œì¶”ê°€ì •ì±…(1) ë¯¸ìœ ì¹˜';
    }
  }

  return { manualValue, systemValue };
}

// ì²­ì†Œë…„ìš”ê¸ˆì œì¶”ê°€ì •ì±…(2)ìœ ì¹˜ ì •ê·œí™” í•¨ìˆ˜
function normalizeYouthPlanPolicy2(manualRow, systemRow) {
  // ìˆ˜ê¸°ì´ˆ ë°ì´í„° ì •ê·œí™” (Tì—´, AMì—´, CVì—´)
  let manualValue = 'ì²­ì†Œë…„ìš”ê¸ˆì œì¶”ê°€ì •ì±…(2) ë¯¸ìœ ì¹˜'; // ê¸°ë³¸ê°’ ì„¤ì •
  if (manualRow.length > 99) { // ìµœì†Œ CVì—´(99)ì€ ìˆì–´ì•¼ í•¨
    const joinType = (manualRow[19] || '').toString().trim(); // Tì—´: ê°€ì…êµ¬ë¶„
    const model = (manualRow[38] || '').toString().trim(); // AMì—´: ê°œí†µëª¨ë¸
    const planType = (manualRow[99] || '').toString().trim(); // CVì—´: ìš”ê¸ˆì œìœ í˜•ëª…

    // í—ˆìš©ëœ ëª¨ë¸ ëª©ë¡
    const allowedModels = [
      'UIP16-128', 'UIP16-256', 'UIP16-512',
      'UIP16PL-128', 'UIP16PL-256', 'UIP16PL-512',
      'UIP16PR-128', 'UIP16PR-256', 'UIP16PR-512', 'UIP16PR-1T',
      'UIP16PM-256', 'UIP16PM-512', 'UIP16PM-1T'
    ];

    // ë³µí•© ì¡°ê±´: ê°€ì…êµ¬ë¶„ì´ "ì¬ê°€ì…" ë˜ëŠ” "ì •ì±…ê¸°ë³€" í¬í•¨, ê°œí†µëª¨ë¸ì´ í—ˆìš©ëœ ëª¨ë¸ ì¤‘ í•˜ë‚˜, ìš”ê¸ˆì œìœ í˜•ëª…ì´ "ì²­ì†Œë…„ â…¡êµ°" ë˜ëŠ” "ì²­ì†Œë…„ â…¢êµ°" í¬í•¨
    const isJoinTypeValid = joinType && (joinType.includes('ì¬ê°€ì…') || joinType.includes('ì •ì±…ê¸°ë³€'));
    const isModelValid = model && allowedModels.some(allowedModel => model.includes(allowedModel));
    const isPlanTypeValid = planType && (planType.includes('ì²­ì†Œë…„ â…¡êµ°') || planType.includes('ì²­ì†Œë…„ â…¢êµ°'));

    if (isJoinTypeValid && isModelValid && isPlanTypeValid) {
      manualValue = 'ì²­ì†Œë…„ìš”ê¸ˆì œì¶”ê°€ì •ì±…(2) ìœ ì¹˜';
    } else {
      manualValue = 'ì²­ì†Œë…„ìš”ê¸ˆì œì¶”ê°€ì •ì±…(2) ë¯¸ìœ ì¹˜';
    }
  }

  // í°í´ ë°ì´í„° ì •ê·œí™” (AEì—´)
  let systemValue = 'ì²­ì†Œë…„ìš”ê¸ˆì œì¶”ê°€ì •ì±…(2) ë¯¸ìœ ì¹˜'; // ê¸°ë³¸ê°’ ì„¤ì •
  if (systemRow.length > 30) { // ìµœì†Œ AEì—´(30)ì€ ìˆì–´ì•¼ í•¨
    const serviceValue = (systemRow[30] || '').toString().trim(); // AEì—´: ë¶€ê°€ì„œë¹„ìŠ¤

    // "ì²­ì†Œë…„ì¶”ê°€â‘¡" í¬í•¨ ì—¬ë¶€ë¡œ ì •ê·œí™”
    if (serviceValue && serviceValue.includes('ì²­ì†Œë…„ì¶”ê°€â‘¡')) {
      systemValue = 'ì²­ì†Œë…„ìš”ê¸ˆì œì¶”ê°€ì •ì±…(2) ìœ ì¹˜';
    } else {
      systemValue = 'ì²­ì†Œë…„ìš”ê¸ˆì œì¶”ê°€ì •ì±…(2) ë¯¸ìœ ì¹˜';
    }
  }

  return { manualValue, systemValue };
}

// ìœ í†µë§ì§€ì›ê¸ˆ í™œì„±í™”ì •ì±… ì •ê·œí™” í•¨ìˆ˜
function normalizeDistributionSupportActivation(manualRow, systemRow) {
  // ìˆ˜ê¸°ì´ˆ ë°ì´í„° ì •ê·œí™” (Tì—´, AXì—´, AMì—´, BXì—´)
  let manualValue = 'ìœ í†µë§ì§€ì›ê¸ˆ í™œì„±í™”ì •ì±… ë¹„ëŒ€ìƒ'; // ê¸°ë³¸ê°’ ì„¤ì •
  if (manualRow.length > 75) { // ìµœì†Œ BXì—´(75)ì€ ìˆì–´ì•¼ í•¨
    const joinType = (manualRow[19] || '').toString().trim(); // Tì—´: ê°€ì…êµ¬ë¶„
    const prevCarrier = (manualRow[49] || '').toString().trim(); // AXì—´: ì´ì „ì‚¬ì—…ì
    const model = (manualRow[38] || '').toString().trim(); // AMì—´: ê°œí†µëª¨ë¸
    const supportAmount = (manualRow[75] || '').toString().trim(); // BXì—´: ìœ í†µë§ì§€ì›ê¸ˆ

    // í—ˆìš©ëœ ëª¨ë¸ ëª©ë¡
    const allowedModels = [
      'SM-F761N256', 'SM-F766N256', 'SM-F766N512',
      'SM-F966N256', 'SM-F966N512', 'SM-F966N1TB',
      'SM-S937N256', 'SM-S937N512', 'SM-S931N256', 'SM-S931N512',
      'SM-S936N256', 'SM-S936N512', 'SM-S938N256', 'SM-S938N512', 'SM-S938N1TB',
      'UIP16-128', 'UIP16-256', 'UIP16-512',
      'UIP16PL-128', 'UIP16PL-256', 'UIP16PL-512',
      'UIP16PR-128', 'UIP16PR-256', 'UIP16PR-512', 'UIP16PR-1T',
      'UIP16PM-256', 'UIP16PM-512', 'UIP16PM-1T'
    ];

    // ë³µí•© ì¡°ê±´: ê°€ì…êµ¬ë¶„ì´ "ì‹ ê·œ" í¬í•¨, ì´ì „ì‚¬ì—…ìê°€ "ì¼ë°˜ê°œí†µ" ì œì™¸ ëª¨ë‘ í¬í•¨, ê°œí†µëª¨ë¸ì´ í—ˆìš©ëœ ëª¨ë¸ ì¤‘ í•˜ë‚˜, ìœ í†µë§ì§€ì›ê¸ˆì´ 200000 ì´ìƒ
    const isJoinTypeValid = joinType && joinType.includes('ì‹ ê·œ');
    const isPrevCarrierValid = prevCarrier && !prevCarrier.includes('ì¼ë°˜ê°œí†µ'); // "ì¼ë°˜ê°œí†µ" ì œì™¸ ëª¨ë‘ í¬í•¨
    const isModelValid = model && allowedModels.some(allowedModel => model.includes(allowedModel));

    // ìœ í†µë§ì§€ì›ê¸ˆ ìˆ«ì ë³€í™˜ ë° ë¹„êµ
    let isSupportAmountValid = false;
    const numericSupportAmount = parseFloat(supportAmount.replace(/[^\d.-]/g, ''));
    if (!isNaN(numericSupportAmount)) {
      isSupportAmountValid = numericSupportAmount >= 200000;
    }

    if (isJoinTypeValid && isPrevCarrierValid && isModelValid && isSupportAmountValid) {
      manualValue = 'ìœ í†µë§ì§€ì›ê¸ˆ í™œì„±í™”ì •ì±… ëŒ€ìƒ';
    } else {
      manualValue = 'ìœ í†µë§ì§€ì›ê¸ˆ í™œì„±í™”ì •ì±… ë¹„ëŒ€ìƒ';
    }
  }

  // í°í´ ë°ì´í„° ì •ê·œí™” (AEì—´)
  let systemValue = 'ìœ í†µë§ì§€ì›ê¸ˆ í™œì„±í™”ì •ì±… ë¹„ëŒ€ìƒ'; // ê¸°ë³¸ê°’ ì„¤ì •
  if (systemRow.length > 30) { // ìµœì†Œ AEì—´(30)ì€ ìˆì–´ì•¼ í•¨
    const serviceValue = (systemRow[30] || '').toString().trim(); // AEì—´: ë¶€ê°€ì„œë¹„ìŠ¤

    // "ìœ í†µë§ì§€ì›ê¸ˆ í™œì„±í™”ì •ì±…" í¬í•¨ ì—¬ë¶€ë¡œ ì •ê·œí™”
    if (serviceValue && serviceValue.includes('ìœ í†µë§ì§€ì›ê¸ˆ í™œì„±í™”ì •ì±…')) {
      systemValue = 'ìœ í†µë§ì§€ì›ê¸ˆ í™œì„±í™”ì •ì±… ëŒ€ìƒ';
    } else {
      systemValue = 'ìœ í†µë§ì§€ì›ê¸ˆ í™œì„±í™”ì •ì±… ë¹„ëŒ€ìƒ';
    }
  }

  return { manualValue, systemValue };
}

// 115êµ° ì„ íƒì•½ì • ì°¨ê° ì •ê·œí™” í•¨ìˆ˜
function normalize115GroupContractDeduction(manualRow, systemRow) {
  // ìˆ˜ê¸°ì´ˆ ë°ì´í„° ì •ê·œí™” (Tì—´, AXì—´, BQì—´, CUì—´, CVì—´)
  let manualValue = '115êµ° ì„ íƒì•½ì • ì°¨ê° ë¹„ëŒ€ìƒ'; // ê¸°ë³¸ê°’ ì„¤ì •
  if (manualRow.length > 99) { // ìµœì†Œ CVì—´(99)ì€ ìˆì–´ì•¼ í•¨
    const joinType = (manualRow[19] || '').toString().trim(); // Tì—´: ê°€ì…êµ¬ë¶„
    const prevCarrier = (manualRow[49] || '').toString().trim(); // AXì—´: ì´ì „ì‚¬ì—…ì
    const contractDetail = (manualRow[68] || '').toString().trim(); // BQì—´: ì•½ì •ìƒì„¸êµ¬ë¶„
    const modelType = (manualRow[98] || '').toString().trim(); // CUì—´: ëª¨ë¸ìœ í˜•
    const planType = (manualRow[99] || '').toString().trim(); // CVì—´: ìš”ê¸ˆì œìœ í˜•ëª…

    // ë³µí•© ì¡°ê±´: ê°€ì…êµ¬ë¶„ì´ "ì‹ ê·œ"ì´ë©´ì„œ ì´ì „ì‚¬ì—…ìê°€ "ì¼ë°˜ê°œí†µ"ì´ë©´ ì œì™¸, ì•½ì •ìƒì„¸êµ¬ë¶„ì´ "ì„ íƒì•½ì •" í¬í•¨, ëª¨ë¸ìœ í˜•ì´ "5Gëª¨ë¸" í¬í•¨, ìš”ê¸ˆì œìœ í˜•ëª…ì´ "115êµ°" í¬í•¨
    const isJoinTypeValid = joinType && joinType.includes('ì‹ ê·œ');
    const isPrevCarrierExcluded = prevCarrier && prevCarrier.includes('ì¼ë°˜ê°œí†µ'); // ì œì™¸ ì¡°ê±´
    const isContractDetailValid = contractDetail && contractDetail.includes('ì„ íƒì•½ì •');
    const isModelTypeValid = modelType && modelType.includes('5Gëª¨ë¸');
    const isPlanTypeValid = planType && planType.includes('115êµ°');

    // ì‹ ê·œì´ë©´ì„œ ì¼ë°˜ê°œí†µì´ë©´ ì œì™¸, ê·¸ ì™¸ì˜ ê²½ìš° ì¡°ê±´ ë§Œì¡± ì‹œ ëŒ€ìƒ
    if (isJoinTypeValid && isPrevCarrierExcluded) {
      manualValue = '115êµ° ì„ íƒì•½ì • ì°¨ê° ë¹„ëŒ€ìƒ'; // ì‹ ê·œ + ì¼ë°˜ê°œí†µ ì¡°í•©ì€ ì œì™¸
    } else if (isContractDetailValid && isModelTypeValid && isPlanTypeValid) {
      manualValue = '115êµ° ì„ íƒì•½ì • ì°¨ê° ëŒ€ìƒ';
    } else {
      manualValue = '115êµ° ì„ íƒì•½ì • ì°¨ê° ë¹„ëŒ€ìƒ';
    }
  }

  // í°í´ ë°ì´í„° ì •ê·œí™” (AFì—´)
  let systemValue = '115êµ° ì„ íƒì•½ì • ì°¨ê° ë¹„ëŒ€ìƒ'; // ê¸°ë³¸ê°’ ì„¤ì •
  if (systemRow.length > 31) { // ìµœì†Œ AFì—´(31)ì€ ìˆì–´ì•¼ í•¨
    const serviceValue = (systemRow[31] || '').toString().trim(); // AFì—´: í™˜ìˆ˜ì„œë¹„ìŠ¤

    // "5Gì „ëª¨ë¸ 115êµ°ì´ìƒ ì„ íƒì•½ì •" í¬í•¨ ì—¬ë¶€ë¡œ ì •ê·œí™”
    if (serviceValue && serviceValue.includes('5Gì „ëª¨ë¸ 115êµ°ì´ìƒ ì„ íƒì•½ì •')) {
      systemValue = '115êµ° ì„ íƒì•½ì • ì°¨ê° ëŒ€ìƒ';
    } else {
      systemValue = '115êµ° ì„ íƒì•½ì • ì°¨ê° ë¹„ëŒ€ìƒ';
    }
  }

  return { manualValue, systemValue };
}

// ì„ íƒì•½ì • S721(010ì‹ ê·œ) ì°¨ê° ì •ê·œí™” í•¨ìˆ˜
function normalizeS721ContractDeduction(manualRow, systemRow) {
  // ìˆ˜ê¸°ì´ˆ ë°ì´í„° ì •ê·œí™” (Tì—´, AXì—´, AMì—´, BQì—´, CVì—´)
  let manualValue = 'ì„ íƒì•½ì • S721(010ì‹ ê·œ) ì°¨ê° ë¹„ëŒ€ìƒ'; // ê¸°ë³¸ê°’ ì„¤ì •
  if (manualRow.length > 99) { // ìµœì†Œ CVì—´(99)ì€ ìˆì–´ì•¼ í•¨
    const joinType = (manualRow[19] || '').toString().trim(); // Tì—´: ê°€ì…êµ¬ë¶„
    const prevCarrier = (manualRow[49] || '').toString().trim(); // AXì—´: ì´ì „ì‚¬ì—…ì
    const model = (manualRow[38] || '').toString().trim(); // AMì—´: ê°œí†µëª¨ë¸
    const contractDetail = (manualRow[68] || '').toString().trim(); // BQì—´: ì•½ì •ìƒì„¸êµ¬ë¶„
    const planType = (manualRow[99] || '').toString().trim(); // CVì—´: ìš”ê¸ˆì œìœ í˜•ëª…

    // í—ˆìš©ëœ ìš”ê¸ˆì œ ìœ í˜• ëª©ë¡
    const allowedPlanTypes = [
      'ì²­ì†Œë…„ â… êµ°', 'ì²­ì†Œë…„ â…¡êµ°', 'ì²­ì†Œë…„ â…¢êµ°',
      'ì‹œë‹ˆì–´ â… êµ°', 'ì‹œë‹ˆì–´ â…¡êµ°', 'í‚¤ì¦ˆêµ°', '33êµ° ë¯¸ë§Œ'
    ];

    // ë³µí•© ì¡°ê±´: ê°€ì…êµ¬ë¶„ì´ "ì‹ ê·œ" í¬í•¨, ì´ì „ì‚¬ì—…ìê°€ "ì¼ë°˜ê°œí†µ" í¬í•¨, ê°œí†µëª¨ë¸ì´ "SM-S721N" í¬í•¨, ì•½ì •ìƒì„¸êµ¬ë¶„ì´ "ì„ íƒì•½ì •" í¬í•¨, ìš”ê¸ˆì œìœ í˜•ëª…ì´ í—ˆìš©ëœ ìœ í˜• ì¤‘ í•˜ë‚˜
    const isJoinTypeValid = joinType && joinType.includes('ì‹ ê·œ');
    const isPrevCarrierValid = prevCarrier && prevCarrier.includes('ì¼ë°˜ê°œí†µ');
    const isModelValid = model && model.includes('SM-S721N');
    const isContractDetailValid = contractDetail && contractDetail.includes('ì„ íƒì•½ì •');
    const isPlanTypeValid = planType && allowedPlanTypes.some(allowedType => planType.includes(allowedType));

    if (isJoinTypeValid && isPrevCarrierValid && isModelValid && isContractDetailValid && isPlanTypeValid) {
      manualValue = 'ì„ íƒì•½ì • S721(010ì‹ ê·œ) ì°¨ê° ëŒ€ìƒ';
    } else {
      manualValue = 'ì„ íƒì•½ì • S721(010ì‹ ê·œ) ì°¨ê° ë¹„ëŒ€ìƒ';
    }
  }

  // í°í´ ë°ì´í„° ì •ê·œí™” (AFì—´)
  let systemValue = 'ì„ íƒì•½ì • S721(010ì‹ ê·œ) ì°¨ê° ë¹„ëŒ€ìƒ'; // ê¸°ë³¸ê°’ ì„¤ì •
  if (systemRow.length > 31) { // ìµœì†Œ AFì—´(31)ì€ ìˆì–´ì•¼ í•¨
    const serviceValue = (systemRow[31] || '').toString().trim(); // AFì—´: í™˜ìˆ˜ì„œë¹„ìŠ¤

    // "S721 í‚¤ì¦ˆêµ°/ì²­ì†Œë…„/ì‹œë‹ˆì–´/33ë¯¸ë§Œ ìœ ì¹˜ì‹œ ê·¸ë¦¬ê³  010ì‹ ê·œì„ íƒì•½ì • ê°œí†µì‹œ ì°¨ê°" í¬í•¨ ì—¬ë¶€ë¡œ ì •ê·œí™”
    if (serviceValue && serviceValue.includes('S721 í‚¤ì¦ˆêµ°/ì²­ì†Œë…„/ì‹œë‹ˆì–´/33ë¯¸ë§Œ ìœ ì¹˜ì‹œ ê·¸ë¦¬ê³  010ì‹ ê·œì„ íƒì•½ì • ê°œí†µì‹œ ì°¨ê°')) {
      systemValue = 'ì„ íƒì•½ì • S721(010ì‹ ê·œ) ì°¨ê° ëŒ€ìƒ';
    } else {
      systemValue = 'ì„ íƒì•½ì • S721(010ì‹ ê·œ) ì°¨ê° ë¹„ëŒ€ìƒ';
    }
  }

  return { manualValue, systemValue };
}

// ì„ íƒì•½ì • S931,S938,S937(MNP) ì°¨ê° ì •ê·œí™” í•¨ìˆ˜
function normalizeS931S938S937ContractDeduction(manualRow, systemRow) {
  // ìˆ˜ê¸°ì´ˆ ë°ì´í„° ì •ê·œí™” (Tì—´, AXì—´, AMì—´, BQì—´, CVì—´)
  let manualValue = 'ì„ íƒì•½ì • S931,S938,S937(MNP) ì°¨ê° ë¹„ëŒ€ìƒ'; // ê¸°ë³¸ê°’ ì„¤ì •
  if (manualRow.length > 99) { // ìµœì†Œ CVì—´(99)ì€ ìˆì–´ì•¼ í•¨
    const joinType = (manualRow[19] || '').toString().trim(); // Tì—´: ê°€ì…êµ¬ë¶„
    const prevCarrier = (manualRow[49] || '').toString().trim(); // AXì—´: ì´ì „ì‚¬ì—…ì
    const model = (manualRow[38] || '').toString().trim(); // AMì—´: ê°œí†µëª¨ë¸
    const contractDetail = (manualRow[68] || '').toString().trim(); // BQì—´: ì•½ì •ìƒì„¸êµ¬ë¶„
    const planType = (manualRow[99] || '').toString().trim(); // CVì—´: ìš”ê¸ˆì œìœ í˜•ëª…

    // í—ˆìš©ëœ ëª¨ë¸ ëª©ë¡
    const allowedModels = [
      'SM-S937N256', 'SM-S937N512',
      'SM-S931N256', 'SM-S931N512',
      'SM-S938N256', 'SM-S938N512', 'SM-S938N1TB'
    ];

    // í—ˆìš©ëœ ìš”ê¸ˆì œ ìœ í˜• ëª©ë¡
    const allowedPlanTypes = [
      'ì²­ì†Œë…„ â…¢êµ°', '75êµ°', '85êµ°', '95êµ°', '105êµ°', '115êµ°'
    ];

    // ë³µí•© ì¡°ê±´: ê°€ì…êµ¬ë¶„ì´ "ì‹ ê·œ"ì´ë©´ì„œ ì´ì „ì‚¬ì—…ìê°€ "ì¼ë°˜ê°œí†µ" ì•„ë‹Œ ê²½ìš°, ê°œí†µëª¨ë¸ì´ í—ˆìš©ëœ ëª¨ë¸ ì¤‘ í•˜ë‚˜, ì•½ì •ìƒì„¸êµ¬ë¶„ì´ "ì„ íƒì•½ì •" í¬í•¨, ìš”ê¸ˆì œìœ í˜•ëª…ì´ í—ˆìš©ëœ ìœ í˜• ì¤‘ í•˜ë‚˜
    const isJoinTypeValid = joinType && joinType.includes('ì‹ ê·œ');
    const isPrevCarrierValid = prevCarrier && !prevCarrier.includes('ì¼ë°˜ê°œí†µ'); // "ì¼ë°˜ê°œí†µ" ì•„ë‹Œ ê²½ìš°
    const isModelValid = model && allowedModels.some(allowedModel => model.includes(allowedModel));
    const isContractDetailValid = contractDetail && contractDetail.includes('ì„ íƒì•½ì •');
    const isPlanTypeValid = planType && allowedPlanTypes.some(allowedType => planType.includes(allowedType));

    if (isJoinTypeValid && isPrevCarrierValid && isModelValid && isContractDetailValid && isPlanTypeValid) {
      manualValue = 'ì„ íƒì•½ì • S931,S938,S937(MNP) ì°¨ê° ëŒ€ìƒ';
    } else {
      manualValue = 'ì„ íƒì•½ì • S931,S938,S937(MNP) ì°¨ê° ë¹„ëŒ€ìƒ';
    }
  }

  // í°í´ ë°ì´í„° ì •ê·œí™” (AFì—´)
  let systemValue = 'ì„ íƒì•½ì • S931,S938,S937(MNP) ì°¨ê° ë¹„ëŒ€ìƒ'; // ê¸°ë³¸ê°’ ì„¤ì •
  if (systemRow.length > 31) { // ìµœì†Œ AFì—´(31)ì€ ìˆì–´ì•¼ í•¨
    const serviceValue = (systemRow[31] || '').toString().trim(); // AFì—´: í™˜ìˆ˜ì„œë¹„ìŠ¤

    // "S931, S938, S937 75êµ°/ì²­ì†Œë…„ 3êµ°ì´ìƒ/ ì„ íƒì•½ì • MNP ê°œí†µì‹œ ì°¨ê°" í¬í•¨ ì—¬ë¶€ë¡œ ì •ê·œí™”
    if (serviceValue && serviceValue.includes('S931, S938, S937 75êµ°/ì²­ì†Œë…„ 3êµ°ì´ìƒ/ ì„ íƒì•½ì • MNP ê°œí†µì‹œ ì°¨ê°')) {
      systemValue = 'ì„ íƒì•½ì • S931,S938,S937(MNP) ì°¨ê° ëŒ€ìƒ';
    } else {
      systemValue = 'ì„ íƒì•½ì • S931,S938,S937(MNP) ì°¨ê° ë¹„ëŒ€ìƒ';
    }
  }

  return { manualValue, systemValue };
}

// ì„ íƒì•½ì • ì•„ì´í°16ë¥˜ì „ì²´(MNP) ì°¨ê° ì •ê·œí™” í•¨ìˆ˜
function normalizeIphone16ContractDeduction(manualRow, systemRow) {
  // ìˆ˜ê¸°ì´ˆ ë°ì´í„° ì •ê·œí™” (Tì—´, AXì—´, AMì—´, BQì—´, CVì—´)
  let manualValue = 'ì„ íƒì•½ì • ì•„ì´í°16ë¥˜ì „ì²´(MNP) ì°¨ê° ë¹„ëŒ€ìƒ'; // ê¸°ë³¸ê°’ ì„¤ì •
  if (manualRow.length > 99) { // ìµœì†Œ CVì—´(99)ì€ ìˆì–´ì•¼ í•¨
    const joinType = (manualRow[19] || '').toString().trim(); // Tì—´: ê°€ì…êµ¬ë¶„
    const prevCarrier = (manualRow[49] || '').toString().trim(); // AXì—´: ì´ì „ì‚¬ì—…ì
    const model = (manualRow[38] || '').toString().trim(); // AMì—´: ê°œí†µëª¨ë¸
    const contractDetail = (manualRow[68] || '').toString().trim(); // BQì—´: ì•½ì •ìƒì„¸êµ¬ë¶„
    const planType = (manualRow[99] || '').toString().trim(); // CVì—´: ìš”ê¸ˆì œìœ í˜•ëª…

    // í—ˆìš©ëœ ëª¨ë¸ ëª©ë¡
    const allowedModels = [
      'UIP16-128', 'UIP16-256', 'UIP16-512',
      'UIP16PL-128', 'UIP16PL-256', 'UIP16PL-512',
      'UIP16PR-128', 'UIP16PR-256', 'UIP16PR-512', 'UIP16PR-1T',
      'UIP16PM-256', 'UIP16PM-512', 'UIP16PM-1T'
    ];

    // í—ˆìš©ëœ ìš”ê¸ˆì œ ìœ í˜• ëª©ë¡
    const allowedPlanTypes = [
      'ì²­ì†Œë…„ â…¢êµ°', '75êµ°', '85êµ°', '95êµ°', '105êµ°', '115êµ°'
    ];

    // ë³µí•© ì¡°ê±´: ê°€ì…êµ¬ë¶„ì´ "ì‹ ê·œ"ì´ë©´ì„œ ì´ì „ì‚¬ì—…ìê°€ "ì¼ë°˜ê°œí†µ" ì•„ë‹Œ ê²½ìš°, ê°œí†µëª¨ë¸ì´ í—ˆìš©ëœ ëª¨ë¸ ì¤‘ í•˜ë‚˜, ì•½ì •ìƒì„¸êµ¬ë¶„ì´ "ì„ íƒì•½ì •" í¬í•¨, ìš”ê¸ˆì œìœ í˜•ëª…ì´ í—ˆìš©ëœ ìœ í˜• ì¤‘ í•˜ë‚˜
    const isJoinTypeValid = joinType && joinType.includes('ì‹ ê·œ');
    const isPrevCarrierValid = prevCarrier && !prevCarrier.includes('ì¼ë°˜ê°œí†µ'); // "ì¼ë°˜ê°œí†µ" ì•„ë‹Œ ê²½ìš°
    const isModelValid = model && allowedModels.some(allowedModel => model.includes(allowedModel));
    const isContractDetailValid = contractDetail && contractDetail.includes('ì„ íƒì•½ì •');
    const isPlanTypeValid = planType && allowedPlanTypes.some(allowedType => planType.includes(allowedType));

    if (isJoinTypeValid && isPrevCarrierValid && isModelValid && isContractDetailValid && isPlanTypeValid) {
      manualValue = 'ì„ íƒì•½ì • ì•„ì´í°16ë¥˜ì „ì²´(MNP) ì°¨ê° ëŒ€ìƒ';
    } else {
      manualValue = 'ì„ íƒì•½ì • ì•„ì´í°16ë¥˜ì „ì²´(MNP) ì°¨ê° ë¹„ëŒ€ìƒ';
    }
  }

  // í°í´ ë°ì´í„° ì •ê·œí™” (AFì—´)
  let systemValue = 'ì„ íƒì•½ì • ì•„ì´í°16ë¥˜ì „ì²´(MNP) ì°¨ê° ë¹„ëŒ€ìƒ'; // ê¸°ë³¸ê°’ ì„¤ì •
  if (systemRow.length > 31) { // ìµœì†Œ AFì—´(31)ì€ ìˆì–´ì•¼ í•¨
    const serviceValue = (systemRow[31] || '').toString().trim(); // AFì—´: í™˜ìˆ˜ì„œë¹„ìŠ¤

    // "UIP16ë¥˜ì „ì²´(UIP16Eì œì™¸) 75êµ°/ì²­ì†Œë…„ 3êµ°ì´ìƒ/ ì„ íƒì•½ì • MNP ê°œí†µì‹œ ì°¨ê°" í¬í•¨ ì—¬ë¶€ë¡œ ì •ê·œí™”
    if (serviceValue && serviceValue.includes('UIP16ë¥˜ì „ì²´(UIP16Eì œì™¸) 75êµ°/ì²­ì†Œë…„ 3êµ°ì´ìƒ/ ì„ íƒì•½ì • MNP ê°œí†µì‹œ ì°¨ê°')) {
      systemValue = 'ì„ íƒì•½ì • ì•„ì´í°16ë¥˜ì „ì²´(MNP) ì°¨ê° ëŒ€ìƒ';
    } else {
      systemValue = 'ì„ íƒì•½ì • ì•„ì´í°16ë¥˜ì „ì²´(MNP) ì°¨ê° ë¹„ëŒ€ìƒ';
    }
  }

  return { manualValue, systemValue };
}

// A166 44êµ° ëŒ€ìƒì™¸ìš”ê¸ˆì œ(MNP) ì°¨ê° ì •ê·œí™” í•¨ìˆ˜
function normalizeA16644GroupExcludedPlanDeduction(manualRow, systemRow) {
  // ìˆ˜ê¸°ì´ˆ ë°ì´í„° ì •ê·œí™” (Tì—´, AXì—´, AMì—´, BQì—´, CVì—´, ATì—´)
  let manualValue = 'A166 44êµ° ëŒ€ìƒì™¸ìš”ê¸ˆì œ(MNP) ì°¨ê° ë¹„ëŒ€ìƒ'; // ê¸°ë³¸ê°’ ì„¤ì •
  if (manualRow.length > 99) { // ìµœì†Œ CVì—´(99)ì€ ìˆì–´ì•¼ í•¨
    const joinType = (manualRow[19] || '').toString().trim(); // Tì—´: ê°€ì…êµ¬ë¶„
    const prevCarrier = (manualRow[49] || '').toString().trim(); // AXì—´: ì´ì „ì‚¬ì—…ì
    const model = (manualRow[38] || '').toString().trim(); // AMì—´: ê°œí†µëª¨ë¸
    const contractDetail = (manualRow[68] || '').toString().trim(); // BQì—´: ì•½ì •ìƒì„¸êµ¬ë¶„
    const planType = (manualRow[99] || '').toString().trim(); // CVì—´: ìš”ê¸ˆì œìœ í˜•ëª…
    const planName = (manualRow[45] || '').toString().trim(); // ATì—´: ê°œí†µìš”ê¸ˆì œëª…

    // í—ˆìš©ëœ ëª¨ë¸ ëª©ë¡
    const allowedModels = [
      'SM-A166L', 'SM-A156L'
    ];

    // ì œì™¸í•  ìš”ê¸ˆì œëª… ëª©ë¡
    const excludedPlanNames = [
      '5G ìŠ¬ë¦¼+', 'ìœ ì“° 5G ìŠ¬ë¦¼+', 'ì¶”ê°€ ìš”ê¸ˆ ê±±ì • ì—†ëŠ” ë°ì´í„° 49'
    ];

    // ë³µí•© ì¡°ê±´: ê°€ì…êµ¬ë¶„ì´ "ì‹ ê·œ"ì´ë©´ì„œ ì´ì „ì‚¬ì—…ìê°€ "ì¼ë°˜ê°œí†µ" ì•„ë‹Œ ê²½ìš°, ê°œí†µëª¨ë¸ì´ í—ˆìš©ëœ ëª¨ë¸ ì¤‘ í•˜ë‚˜, ì•½ì •ìƒì„¸êµ¬ë¶„ì´ "ì„ íƒì•½ì •" í¬í•¨, ìš”ê¸ˆì œìœ í˜•ëª…ì´ "44êµ°" í¬í•¨, ê°œí†µìš”ê¸ˆì œëª…ì´ ì œì™¸ ëª©ë¡ì— ì—†ëŠ” ê²½ìš°
    const isJoinTypeValid = joinType && joinType.includes('ì‹ ê·œ');
    const isPrevCarrierValid = prevCarrier && !prevCarrier.includes('ì¼ë°˜ê°œí†µ'); // "ì¼ë°˜ê°œí†µ" ì•„ë‹Œ ê²½ìš°
    const isModelValid = model && allowedModels.some(allowedModel => model.includes(allowedModel));
    const isContractDetailValid = contractDetail && contractDetail.includes('ì„ íƒì•½ì •');
    const isPlanTypeValid = planType && planType.includes('44êµ°');
    const isPlanNameValid = planName && !excludedPlanNames.some(excludedPlan => planName.includes(excludedPlan)); // ì œì™¸ ëª©ë¡ì— ì—†ëŠ” ê²½ìš°

    if (isJoinTypeValid && isPrevCarrierValid && isModelValid && isContractDetailValid && isPlanTypeValid && isPlanNameValid) {
      manualValue = 'A166 44êµ° ëŒ€ìƒì™¸ìš”ê¸ˆì œ(MNP) ì°¨ê° ëŒ€ìƒ';
    } else {
      manualValue = 'A166 44êµ° ëŒ€ìƒì™¸ìš”ê¸ˆì œ(MNP) ì°¨ê° ë¹„ëŒ€ìƒ';
    }
  }

  // í°í´ ë°ì´í„° ì •ê·œí™” (AFì—´)
  let systemValue = 'A166 44êµ° ëŒ€ìƒì™¸ìš”ê¸ˆì œ(MNP) ì°¨ê° ë¹„ëŒ€ìƒ'; // ê¸°ë³¸ê°’ ì„¤ì •
  if (systemRow.length > 31) { // ìµœì†Œ AFì—´(31)ì€ ìˆì–´ì•¼ í•¨
    const serviceValue = (systemRow[31] || '').toString().trim(); // AFì—´: í™˜ìˆ˜ì„œë¹„ìŠ¤

    // "44êµ° ëŒ€ìƒì™¸ ìš”ê¸ˆì œ ì°¨ê°- Dêµ°ì¤‘ (55,ì²­ì†Œë…„â…¡,ì‹œë‹ˆì–´â…¡)ì°¨ê°ì œì™¸ MNP" í¬í•¨ ì—¬ë¶€ë¡œ ì •ê·œí™”
    if (serviceValue && serviceValue.includes('44êµ° ëŒ€ìƒì™¸ ìš”ê¸ˆì œ ì°¨ê°- Dêµ°ì¤‘ (55,ì²­ì†Œë…„â…¡,ì‹œë‹ˆì–´â…¡)ì°¨ê°ì œì™¸ MNP')) {
      systemValue = 'A166 44êµ° ëŒ€ìƒì™¸ìš”ê¸ˆì œ(MNP) ì°¨ê° ëŒ€ìƒ';
    } else {
      systemValue = 'A166 44êµ° ëŒ€ìƒì™¸ìš”ê¸ˆì œ(MNP) ì°¨ê° ë¹„ëŒ€ìƒ';
    }
  }

  return { manualValue, systemValue };
}

// A166 44êµ° ëŒ€ìƒì™¸ìš”ê¸ˆì œ(ê¸°ë³€) ì°¨ê° ì •ê·œí™” í•¨ìˆ˜
function normalizeA16644GroupExcludedPlanChangeDeduction(manualRow, systemRow) {
  // ìˆ˜ê¸°ì´ˆ ë°ì´í„° ì •ê·œí™” (Tì—´, AMì—´, BQì—´, CVì—´, ATì—´)
  let manualValue = 'A166 44êµ° ëŒ€ìƒì™¸ìš”ê¸ˆì œ(ê¸°ë³€) ì°¨ê° ë¹„ëŒ€ìƒ'; // ê¸°ë³¸ê°’ ì„¤ì •
  if (manualRow.length > 99) { // ìµœì†Œ CVì—´(99)ì€ ìˆì–´ì•¼ í•¨
    const joinType = (manualRow[19] || '').toString().trim(); // Tì—´: ê°€ì…êµ¬ë¶„
    const model = (manualRow[38] || '').toString().trim(); // AMì—´: ê°œí†µëª¨ë¸
    const contractDetail = (manualRow[68] || '').toString().trim(); // BQì—´: ì•½ì •ìƒì„¸êµ¬ë¶„
    const planType = (manualRow[99] || '').toString().trim(); // CVì—´: ìš”ê¸ˆì œìœ í˜•ëª…
    const planName = (manualRow[45] || '').toString().trim(); // ATì—´: ê°œí†µìš”ê¸ˆì œëª…

    // í—ˆìš©ëœ ëª¨ë¸ ëª©ë¡
    const allowedModels = [
      'SM-A166L', 'SM-A156L'
    ];

    // ì œì™¸í•  ìš”ê¸ˆì œëª… ëª©ë¡
    const excludedPlanNames = [
      '5G ìŠ¬ë¦¼+', 'ìœ ì“° 5G ìŠ¬ë¦¼+', 'ì¶”ê°€ ìš”ê¸ˆ ê±±ì • ì—†ëŠ” ë°ì´í„° 49'
    ];

    // ë³µí•© ì¡°ê±´: ê°€ì…êµ¬ë¶„ì´ "ì¬ê°€ì…" ë˜ëŠ” "ì •ì±…ê¸°ë³€"ì¸ ê²½ìš°, ê°œí†µëª¨ë¸ì´ í—ˆìš©ëœ ëª¨ë¸ ì¤‘ í•˜ë‚˜, ì•½ì •ìƒì„¸êµ¬ë¶„ì´ "ì„ íƒì•½ì •" í¬í•¨, ìš”ê¸ˆì œìœ í˜•ëª…ì´ "44êµ°" í¬í•¨, ê°œí†µìš”ê¸ˆì œëª…ì´ ì œì™¸ ëª©ë¡ì— ì—†ëŠ” ê²½ìš°
    const isJoinTypeValid = joinType && (joinType.includes('ì¬ê°€ì…') || joinType.includes('ì •ì±…ê¸°ë³€'));
    const isModelValid = model && allowedModels.some(allowedModel => model.includes(allowedModel));
    const isContractDetailValid = contractDetail && contractDetail.includes('ì„ íƒì•½ì •');
    const isPlanTypeValid = planType && planType.includes('44êµ°');
    const isPlanNameValid = planName && !excludedPlanNames.some(excludedPlan => planName.includes(excludedPlan)); // ì œì™¸ ëª©ë¡ì— ì—†ëŠ” ê²½ìš°

    if (isJoinTypeValid && isModelValid && isContractDetailValid && isPlanTypeValid && isPlanNameValid) {
      manualValue = 'A166 44êµ° ëŒ€ìƒì™¸ìš”ê¸ˆì œ(ê¸°ë³€) ì°¨ê° ëŒ€ìƒ';
    } else {
      manualValue = 'A166 44êµ° ëŒ€ìƒì™¸ìš”ê¸ˆì œ(ê¸°ë³€) ì°¨ê° ë¹„ëŒ€ìƒ';
    }
  }

  // í°í´ ë°ì´í„° ì •ê·œí™” (AFì—´)
  let systemValue = 'A166 44êµ° ëŒ€ìƒì™¸ìš”ê¸ˆì œ(ê¸°ë³€) ì°¨ê° ë¹„ëŒ€ìƒ'; // ê¸°ë³¸ê°’ ì„¤ì •
  if (systemRow.length > 31) { // ìµœì†Œ AFì—´(31)ì€ ìˆì–´ì•¼ í•¨
    const serviceValue = (systemRow[31] || '').toString().trim(); // AFì—´: í™˜ìˆ˜ì„œë¹„ìŠ¤

    // "44êµ° ëŒ€ìƒì™¸ ìš”ê¸ˆì œ ì°¨ê°- Dêµ°ì¤‘ (55,ì²­ì†Œë…„â…¡,ì‹œë‹ˆì–´â…¡)ì°¨ê°ì œì™¸ ê¸°ë³€" í¬í•¨ ì—¬ë¶€ë¡œ ì •ê·œí™”
    if (serviceValue && serviceValue.includes('44êµ° ëŒ€ìƒì™¸ ìš”ê¸ˆì œ ì°¨ê°- Dêµ°ì¤‘ (55,ì²­ì†Œë…„â…¡,ì‹œë‹ˆì–´â…¡)ì°¨ê°ì œì™¸ ê¸°ë³€')) {
      systemValue = 'A166 44êµ° ëŒ€ìƒì™¸ìš”ê¸ˆì œ(ê¸°ë³€) ì°¨ê° ëŒ€ìƒ';
    } else {
      systemValue = 'A166 44êµ° ëŒ€ìƒì™¸ìš”ê¸ˆì œ(ê¸°ë³€) ì°¨ê° ë¹„ëŒ€ìƒ';
    }
  }

  return { manualValue, systemValue };
}

// ì •ì±…ê¸°ë³€ ì°¨ê° ì •ê·œí™” í•¨ìˆ˜
function normalizePolicyChangeDeduction(manualRow, systemRow) {
  // ìˆ˜ê¸°ì´ˆ ë°ì´í„° ì •ê·œí™” (Tì—´)
  let manualValue = 'ì •ì±…ê¸°ë³€ ì°¨ê° ë¹„ëŒ€ìƒ'; // ê¸°ë³¸ê°’ ì„¤ì •
  if (manualRow.length > 19) { // ìµœì†Œ Tì—´(19)ì€ ìˆì–´ì•¼ í•¨
    const joinType = (manualRow[19] || '').toString().trim(); // Tì—´: ê°€ì…êµ¬ë¶„

    // "ì •ì±…ê¸°ë³€" í¬í•¨ ì—¬ë¶€ë¡œ ì •ê·œí™”
    if (joinType && joinType.includes('ì •ì±…ê¸°ë³€')) {
      manualValue = 'ì •ì±…ê¸°ë³€ ì°¨ê° ëŒ€ìƒ';
    } else {
      manualValue = 'ì •ì±…ê¸°ë³€ ì°¨ê° ë¹„ëŒ€ìƒ';
    }
  }

  // í°í´ ë°ì´í„° ì •ê·œí™” (AFì—´)
  let systemValue = 'ì •ì±…ê¸°ë³€ ì°¨ê° ë¹„ëŒ€ìƒ'; // ê¸°ë³¸ê°’ ì„¤ì •
  if (systemRow.length > 31) { // ìµœì†Œ AFì—´(31)ì€ ìˆì–´ì•¼ í•¨
    const serviceValue = (systemRow[31] || '').toString().trim(); // AFì—´: í™˜ìˆ˜ì„œë¹„ìŠ¤

    // "ì •ì±…ê¸°ë³€" í¬í•¨ ì—¬ë¶€ë¡œ ì •ê·œí™”
    if (serviceValue && serviceValue.includes('ì •ì±…ê¸°ë³€')) {
      systemValue = 'ì •ì±…ê¸°ë³€ ì°¨ê° ëŒ€ìƒ';
    } else {
      systemValue = 'ì •ì±…ê¸°ë³€ ì°¨ê° ë¹„ëŒ€ìƒ';
    }
  }

  return { manualValue, systemValue };
}

// ê¸°ë³€ Cíƒ€ê²Ÿ ì°¨ê° ì •ê·œí™” í•¨ìˆ˜
function normalizeChangeCTargetDeduction(manualRow, systemRow) {
  // ìˆ˜ê¸°ì´ˆ ë°ì´í„° ì •ê·œí™” (CLì—´)
  let manualValue = 'ê¸°ë³€ Cíƒ€ê²Ÿ ì°¨ê° ë¹„ëŒ€ìƒ'; // ê¸°ë³¸ê°’ ì„¤ì •
  if (manualRow.length > 89) { // ìµœì†Œ CLì—´(89)ì€ ìˆì–´ì•¼ í•¨
    const joinType = (manualRow[89] || '').toString().trim(); // CLì—´: ê°€ì…êµ¬ë¶„

    // "ê¸°ë³€C" í¬í•¨ ì—¬ë¶€ë¡œ ì •ê·œí™”
    if (joinType && joinType.includes('ê¸°ë³€C')) {
      manualValue = 'ê¸°ë³€ Cíƒ€ê²Ÿ ì°¨ê° ëŒ€ìƒ';
    } else {
      manualValue = 'ê¸°ë³€ Cíƒ€ê²Ÿ ì°¨ê° ë¹„ëŒ€ìƒ';
    }
  }

  // í°í´ ë°ì´í„° ì •ê·œí™” (AFì—´)
  let systemValue = 'ê¸°ë³€ Cíƒ€ê²Ÿ ì°¨ê° ë¹„ëŒ€ìƒ'; // ê¸°ë³¸ê°’ ì„¤ì •
  if (systemRow.length > 31) { // ìµœì†Œ AFì—´(31)ì€ ìˆì–´ì•¼ í•¨
    const serviceValue = (systemRow[31] || '').toString().trim(); // AFì—´: í™˜ìˆ˜ì„œë¹„ìŠ¤

    // "ê¸°ë³€ Cíƒ€ê²Ÿ" í¬í•¨ ì—¬ë¶€ë¡œ ì •ê·œí™”
    if (serviceValue && serviceValue.includes('ê¸°ë³€ Cíƒ€ê²Ÿ')) {
      systemValue = 'ê¸°ë³€ Cíƒ€ê²Ÿ ì°¨ê° ëŒ€ìƒ';
    } else {
      systemValue = 'ê¸°ë³€ Cíƒ€ê²Ÿ ì°¨ê° ë¹„ëŒ€ìƒ';
    }
  }

  return { manualValue, systemValue };
}

// 33êµ°ë¯¸ë§Œ, ì‹œë‹ˆì–´1êµ°ì‹œ ì°¨ê° ì •ê·œí™” í•¨ìˆ˜
function normalize33GroupSenior1Deduction(manualRow, systemRow) {
  // ìˆ˜ê¸°ì´ˆ ë°ì´í„° ì •ê·œí™” (CVì—´)
  let manualValue = '33êµ°ë¯¸ë§Œ, ì‹œë‹ˆì–´1êµ°ì‹œ ì°¨ê° ë¹„ëŒ€ìƒ'; // ê¸°ë³¸ê°’ ì„¤ì •
  if (manualRow.length > 99) { // ìµœì†Œ CVì—´(99)ì€ ìˆì–´ì•¼ í•¨
    const planType = (manualRow[99] || '').toString().trim(); // CVì—´: ìš”ê¸ˆì œìœ í˜•ëª…

    // "ì‹œë‹ˆì–´ â… êµ°" ë˜ëŠ” "33êµ° ë¯¸ë§Œ" í¬í•¨ ì—¬ë¶€ë¡œ ì •ê·œí™”
    if (planType && (planType.includes('ì‹œë‹ˆì–´ â… êµ°') || planType.includes('33êµ° ë¯¸ë§Œ'))) {
      manualValue = '33êµ°ë¯¸ë§Œ, ì‹œë‹ˆì–´1êµ°ì‹œ ì°¨ê° ëŒ€ìƒ';
    } else {
      manualValue = '33êµ°ë¯¸ë§Œ, ì‹œë‹ˆì–´1êµ°ì‹œ ì°¨ê° ë¹„ëŒ€ìƒ';
    }
  }

  // í°í´ ë°ì´í„° ì •ê·œí™” (AFì—´)
  let systemValue = '33êµ°ë¯¸ë§Œ, ì‹œë‹ˆì–´1êµ°ì‹œ ì°¨ê° ë¹„ëŒ€ìƒ'; // ê¸°ë³¸ê°’ ì„¤ì •
  if (systemRow.length > 31) { // ìµœì†Œ AFì—´(31)ì€ ìˆì–´ì•¼ í•¨
    const serviceValue = (systemRow[31] || '').toString().trim(); // AFì—´: í™˜ìˆ˜ì„œë¹„ìŠ¤

    // "33êµ° ë¯¸ë§Œ/ LTE ì‹œë‹ˆì–´1êµ° ìœ ì¹˜ì‹œ" í¬í•¨ ì—¬ë¶€ë¡œ ì •ê·œí™”
    if (serviceValue && serviceValue.includes('33êµ° ë¯¸ë§Œ/ LTE ì‹œë‹ˆì–´1êµ° ìœ ì¹˜ì‹œ')) {
      systemValue = '33êµ°ë¯¸ë§Œ, ì‹œë‹ˆì–´1êµ°ì‹œ ì°¨ê° ëŒ€ìƒ';
    } else {
      systemValue = '33êµ°ë¯¸ë§Œ, ì‹œë‹ˆì–´1êµ°ì‹œ ì°¨ê° ë¹„ëŒ€ìƒ';
    }
  }

  return { manualValue, systemValue };
}

// ì˜¨ì„¸ì¼ ì „ëµì˜¨ë¼ì¸POS ì°¨ê° ì •ê·œí™” í•¨ìˆ˜
function normalizeOnsaleStrategyOnlinePosDeduction(manualRow, systemRow) {
  // ìˆ˜ê¸°ì´ˆ ë°ì´í„° ì •ê·œí™” (CEì—´, AWì—´, CUì—´)
  let manualValue = 'ì˜¨ì„¸ì¼ ì „ëµì˜¨ë¼ì¸POS ì°¨ê° ë¹„ëŒ€ìƒ'; // ê¸°ë³¸ê°’ ì„¤ì •

  if (manualRow.length > 98) { // ìµœì†Œ CUì—´(98)ì€ ìˆì–´ì•¼ í•¨
    const reservationSystem = (manualRow[82] || '').toString().trim(); // CEì—´: ì˜ˆì•½ê°€ì…ì‹œìŠ¤í…œ
    const finalPolicy = (manualRow[48] || '').toString().trim(); // AWì—´: ìµœì¢…ì˜ì—…ì •ì±…
    const modelType = (manualRow[98] || '').toString().trim(); // CUì—´: ëª¨ë¸ìœ í˜•

    // ë³µí•© ì¡°ê±´ í™•ì¸:
    // 1. CEì—´ì— "ì˜¨ì„¸ì¼" í¬í•¨
    // 2. AWì—´ì— "BLANK" ë¯¸í¬í•¨
    // 3. CUì—´ì— "LTE_2ndëª¨ë¸" ë˜ëŠ” "5G_2ndëª¨ë¸" ë¯¸í¬í•¨
    const hasOnsale = reservationSystem && reservationSystem.includes('ì˜¨ì„¸ì¼');
    const notBlank = finalPolicy && !finalPolicy.includes('BLANK');
    const notSecondModel = modelType && !modelType.includes('LTE_2ndëª¨ë¸') && !modelType.includes('5G_2ndëª¨ë¸');

    if (hasOnsale && notBlank && notSecondModel) {
      manualValue = 'ì˜¨ì„¸ì¼ ì „ëµì˜¨ë¼ì¸POS ì°¨ê° ëŒ€ìƒ';
    } else {
      manualValue = 'ì˜¨ì„¸ì¼ ì „ëµì˜¨ë¼ì¸POS ì°¨ê° ë¹„ëŒ€ìƒ';
    }
  }

  // í°í´ ë°ì´í„° ì •ê·œí™” (AFì—´)
  let systemValue = 'ì˜¨ì„¸ì¼ ì „ëµì˜¨ë¼ì¸POS ì°¨ê° ë¹„ëŒ€ìƒ'; // ê¸°ë³¸ê°’ ì„¤ì •
  if (systemRow.length > 31) { // ìµœì†Œ AFì—´(31)ì€ ìˆì–´ì•¼ í•¨
    const serviceValue = (systemRow[31] || '').toString().trim(); // AFì—´: í™˜ìˆ˜ì„œë¹„ìŠ¤

    // "ì˜¨ì„¸ì¼ ì „ëµì˜¨ë¼ì¸POS ê°œí†µì‹œ" í¬í•¨ ì—¬ë¶€ë¡œ ì •ê·œí™”
    if (serviceValue && serviceValue.includes('ì˜¨ì„¸ì¼ ì „ëµì˜¨ë¼ì¸POS ê°œí†µì‹œ')) {
      systemValue = 'ì˜¨ì„¸ì¼ ì „ëµì˜¨ë¼ì¸POS ì°¨ê° ëŒ€ìƒ';
    } else {
      systemValue = 'ì˜¨ì„¸ì¼ ì „ëµì˜¨ë¼ì¸POS ì°¨ê° ë¹„ëŒ€ìƒ';
    }
  }

  return { manualValue, systemValue };
}

// ìœ í”Œë ˆì´ ë¯¸ìœ ì¹˜ ì°¨ê° ì •ê·œí™” í•¨ìˆ˜
function normalizeUplayNoCheck(manualRow, systemRow) {
  // ìˆ˜ê¸°ì´ˆ ë°ì´í„° ì •ê·œí™” (DXì—´)
  let manualValue = 'ìœ í”Œë ˆì´ ë¯¸ìœ ì¹˜ ì°¨ê° ë¹„ëŒ€ìƒ'; // ê¸°ë³¸ê°’ ì„¤ì •

  // ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
  console.log(`ğŸ” [ìœ í”Œë ˆì´ ë¯¸ìœ ì¹˜] ìˆ˜ê¸°ì´ˆ ë°°ì—´ ê¸¸ì´: ${manualRow.length}`);
  console.log(`ğŸ” [ìœ í”Œë ˆì´ ë¯¸ìœ ì¹˜] DXì—´(127) ì›ë³¸ê°’: "${manualRow[127]}"`);
  console.log(`ğŸ” [ìœ í”Œë ˆì´ ë¯¸ìœ ì¹˜] DXì—´(127) íƒ€ì…: ${typeof manualRow[127]}`);

  if (manualRow.length > 127) { // ìµœì†Œ DXì—´(127)ì€ ìˆì–´ì•¼ í•¨ (128 ì´ìƒ)
    const uplayValue = (manualRow[127] || '').toString().trim(); // DXì—´: ìœ í”Œë ˆì´

    console.log(`ğŸ” [ìœ í”Œë ˆì´ ë¯¸ìœ ì¹˜] uplayValue: "${uplayValue}"`);
    console.log(`ğŸ” [ìœ í”Œë ˆì´ ë¯¸ìœ ì¹˜] !uplayValue: ${!uplayValue}`);
    console.log(`ğŸ” [ìœ í”Œë ˆì´ ë¯¸ìœ ì¹˜] !uplayValue.includes('ìœ í”Œë ˆì´'): ${!uplayValue.includes('ìœ í”Œë ˆì´')}`);
    console.log(`ğŸ” [ìœ í”Œë ˆì´ ë¯¸ìœ ì¹˜] ì¡°ê±´ë¬¸ ê²°ê³¼: ${!uplayValue || !uplayValue.includes('ìœ í”Œë ˆì´')}`);

    // "ìœ í”Œë ˆì´" ë¬¸êµ¬ê°€ ì—†ê±°ë‚˜ ê³µë°±ì´ë©´ "ìœ í”Œë ˆì´ ë¯¸ìœ ì¹˜ ì°¨ê° ëŒ€ìƒ"
    if (!uplayValue || !uplayValue.includes('ìœ í”Œë ˆì´')) {
      manualValue = 'ìœ í”Œë ˆì´ ë¯¸ìœ ì¹˜ ì°¨ê° ëŒ€ìƒ';
      console.log(`ğŸ” [ìœ í”Œë ˆì´ ë¯¸ìœ ì¹˜] ì¡°ê±´ë¬¸ í†µê³¼ - manualValueë¥¼ "ëŒ€ìƒ"ìœ¼ë¡œ ì„¤ì •`);
    } else {
      manualValue = 'ìœ í”Œë ˆì´ ë¯¸ìœ ì¹˜ ì°¨ê° ë¹„ëŒ€ìƒ';
      console.log(`ğŸ” [ìœ í”Œë ˆì´ ë¯¸ìœ ì¹˜] ì¡°ê±´ë¬¸ ì‹¤íŒ¨ - manualValueë¥¼ "ë¹„ëŒ€ìƒ"ìœ¼ë¡œ ì„¤ì •`);
    }
  } else {
    console.log(`ğŸ” [ìœ í”Œë ˆì´ ë¯¸ìœ ì¹˜] ë°°ì—´ ê¸¸ì´ ë¶€ì¡± (${manualRow.length} <= 127) - ê¸°ë³¸ê°’ "ë¹„ëŒ€ìƒ" ìœ ì§€`);
  }

  // í°í´ ë°ì´í„° ì •ê·œí™” (AFì—´)
  let systemValue = 'ìœ í”Œë ˆì´ ë¯¸ìœ ì¹˜ ì°¨ê° ë¹„ëŒ€ìƒ'; // ê¸°ë³¸ê°’ ì„¤ì •
  if (systemRow.length > 31) { // ìµœì†Œ AFì—´(31)ì€ ìˆì–´ì•¼ í•¨
    const uplayNoValue = (systemRow[31] || '').toString().trim(); // AFì—´: ìœ í”Œë ˆì´ ë¯¸ìœ ì¹˜

    // "ìœ í”Œë ˆì´" ë¬¸êµ¬ê°€ ìˆë‹¤ë©´ "ìœ í”Œë ˆì´ ë¯¸ìœ ì¹˜ ì°¨ê° ëŒ€ìƒ"
    if (uplayNoValue && uplayNoValue.includes('ìœ í”Œë ˆì´')) {
      systemValue = 'ìœ í”Œë ˆì´ ë¯¸ìœ ì¹˜ ì°¨ê° ëŒ€ìƒ';
    } else {
      systemValue = 'ìœ í”Œë ˆì´ ë¯¸ìœ ì¹˜ ì°¨ê° ë¹„ëŒ€ìƒ';
    }
  }

  return { manualValue, systemValue };
}

// ë™ì  ì»¬ëŸ¼ ë¹„êµ í•¨ìˆ˜
function compareDynamicColumns(manualRow, systemRow, key, targetField = null, storeData = null, planData = null) {
  const differences = [];

  // íŠ¹ì • í•„ë“œë§Œ ë¹„êµí•˜ê±°ë‚˜ ì „ì²´ í•„ë“œ ë¹„êµ
  const mappingsToCompare = targetField
    ? COLUMN_MATCHING_CONFIG.filter(config => config.manualField.key === targetField)
    : COLUMN_MATCHING_CONFIG;

  mappingsToCompare.forEach(config => {
    const { manualField, systemField, regex, description } = config;

    // ê°œí†µì¼ì‹œë¶„ ë¹„êµ ë¡œì§
    if (manualField.key === 'activation_datetime') {
      // ë°°ì—´ ë²”ìœ„ ì²´í¬
      if (manualRow.length <= 20 || systemRow.length <= 3) { // U=20, B=1, C=2, D=3
        return;
      }

      const manualDate = manualRow[29] || ''; // Uì—´: ê°€ì…ì¼ì (20+9)
      const manualTime = manualRow[30] || ''; // Vì—´: ê°œí†µì‹œê°„ (21+9)
      const systemDate = systemRow[9] || '';  // Bì—´: ê°œí†µì¼ (1+8)
      const systemHour = systemRow[10] || '';  // Cì—´: ê°œí†µì‹œ (2+8)
      const systemMinute = systemRow[11] || ''; // Dì—´: ê°œí†µë¶„ (3+8)

      // ê°œí†µì¼ì‹œë¶„ ì •ê·œí™”
      const { manualDateTime, systemDateTime } = normalizeActivationDateTime(
        manualDate, manualTime, systemDate, systemHour, systemMinute
      );

      // ì •ê·œí™”ëœ ê°’ì´ ìˆê³  ë‹¤ë¥´ë©´ ì°¨ì´ì ìœ¼ë¡œ ê¸°ë¡
      if (manualDateTime && systemDateTime && manualDateTime !== systemDateTime) {
        differences.push({
          key,
          type: 'mismatch',
          field: 'ê°œí†µì¼ì‹œë¶„',
          fieldKey: 'activation_datetime',
          correctValue: manualDateTime,
          incorrectValue: systemDateTime,
          description: 'ê°œí†µì¼ì‹œë¶„ ë¹„êµ (ì´ˆ ì œì™¸, 24ì‹œê°„ í˜•ì‹)',
          manualRow: null,
          systemRow: null,
          assignedAgent: systemRow[77] || '' // BRì—´: ë“±ë¡ì§ì› (69+8)
        });
      }
      return;
    }

    // ëª¨ë¸ëª…(ì¼ë ¨ë²ˆí˜¸) ë¹„êµ ë¡œì§
    if (manualField.key === 'model_serial') {
      // ë°°ì—´ ë²”ìœ„ ì²´í¬ (AD=29, AE=30, AN=39, N=13, P=15)
      if (manualRow.length <= 30 || systemRow.length <= 15) {
        console.log(`ëª¨ë¸ëª… ë¹„êµ ë²”ìœ„ ì²´í¬ ì‹¤íŒ¨: key=${key}, manualRow.length=${manualRow.length}, systemRow.length=${systemRow.length}`);
        return;
      }

      // ANì—´ ìµœì¢…ì˜ì—…ì •ì±…ì´ "BLANK"ì¸ ê²½ìš° ë¹„êµ ì œì™¸
      const finalPolicy = manualRow[48] || ''; // ANì—´: ìµœì¢…ì˜ì—…ì •ì±… (39+9)
      if (finalPolicy.toString().trim().toUpperCase() === 'BLANK') {
        return;
      }

      const manualModel = manualRow[38] || ''; // ADì—´: ê°œí†µëª¨ë¸ (29+9)
      const manualSerial = manualRow[39] || ''; // AEì—´: ê°œí†µëª¨ë¸ì¼ë ¨ë²ˆí˜¸ (30+9)
      const systemModel = systemRow[21] || '';  // Nì—´: ëª¨ë¸ëª… (13+8)
      const systemSerial = systemRow[23] || ''; // Pì—´: ì¼ë ¨ë²ˆí˜¸ (15+8)

      // ë””ë²„ê¹… ëŒ€ìƒ ì‹œë¦¬ì–¼ë²ˆí˜¸ì¸ì§€ í™•ì¸ (í•„ìš”ì‹œì—ë§Œ ì‚¬ìš©)
      const isDebugTarget = DEBUG_SERIAL_NUMBERS.includes(manualSerial) || DEBUG_SERIAL_NUMBERS.includes(systemSerial);

      // ëª¨ë¸ëª…ê³¼ ì¼ë ¨ë²ˆí˜¸ ì •ê·œí™”
      const normalizedManualModel = normalizeModelName(manualModel);
      const normalizedSystemModel = normalizeModelName(systemModel);
      const normalizedManualSerial = normalizeSerialNumber(manualSerial);
      const normalizedSystemSerial = normalizeSerialNumber(systemSerial);



      // ëª¨ë¸ëª…ê³¼ ì¼ë ¨ë²ˆí˜¸ë¥¼ ì¡°í•©í•˜ì—¬ ë¹„êµ
      const manualCombined = `${normalizedManualModel}(${normalizedManualSerial})`;
      const systemCombined = `${normalizedSystemModel}(${normalizedSystemSerial})`;



      // ê°’ì´ ë‹¤ë¥´ê³  ë‘˜ ë‹¤ ë¹„ì–´ìˆì§€ ì•Šì€ ê²½ìš°ë§Œ ì°¨ì´ì ìœ¼ë¡œ ê¸°ë¡
      if (manualCombined !== systemCombined &&
        (manualCombined || systemCombined)) {

        differences.push({
          key,
          type: 'mismatch',
          field: 'ëª¨ë¸ëª…(ì¼ë ¨ë²ˆí˜¸)',
          fieldKey: 'model_serial',
          correctValue: manualCombined,
          incorrectValue: systemCombined,
          description: 'ëª¨ë¸ëª…ê³¼ ì¼ë ¨ë²ˆí˜¸ ë¹„êµ (ëª¨ë¸ëª… ì •ê·œí™”, ì¼ë ¨ë²ˆí˜¸ 6ìë¦¬ ë¹„êµ)',
          manualRow: null,
          systemRow: null,
          assignedAgent: systemRow[77] || '' // BRì—´: ë“±ë¡ì§ì› (69+8)
        });
      }
      return;
    }

    // ê°œí†µìœ í˜• ë¹„êµ ë¡œì§
    if (manualField.key === 'activation_type') {
      // ë°°ì—´ ë²”ìœ„ ì²´í¬ (K=10, AO=40, CC=80, L=11, X=23)
      if (manualRow.length <= 80 || systemRow.length <= 23) {
        return;
      }

      // ê°œí†µìœ í˜• ì •ê·œí™”
      const { manualType, systemType } = normalizeActivationType(manualRow, systemRow);

      // ê°’ì´ ë‹¤ë¥´ê³  ë‘˜ ë‹¤ ë¹„ì–´ìˆì§€ ì•Šì€ ê²½ìš°ë§Œ ì°¨ì´ì ìœ¼ë¡œ ê¸°ë¡
      if (manualType !== systemType &&
        (manualType || systemType)) {

        differences.push({
          key,
          type: 'mismatch',
          field: 'ê°œí†µìœ í˜•',
          fieldKey: 'activation_type',
          correctValue: manualType || 'ì •ê·œí™” ë¶ˆê°€',
          incorrectValue: systemType || 'ì •ê·œí™” ë¶ˆê°€',
          description: 'ê°œí†µìœ í˜• ë° Cíƒ€ê²Ÿì°¨ê°ëŒ€ìƒ ë¹„êµ (ê°€ì…êµ¬ë¶„+ì´ì „ì‚¬ì—…ì+ê¸°ë³€íƒ€ê²Ÿêµ¬ë¶„ ì •ê·œí™”)',
          manualRow: null,
          systemRow: null,
          assignedAgent: systemRow[77] || '' // BRì—´: ë“±ë¡ì§ì› (69+8)
        });
      }
      return;
    }

    // ì‹¤íŒë§¤POS ë¹„êµ ë¡œì§
    if (manualField.key === 'sales_pos') {
      // ë°°ì—´ ë²”ìœ„ ì²´í¬ (Q=16, R=17, F=5)
      if (manualRow.length <= 17 || systemRow.length <= 5) {
        return;
      }

      // ì‹¤íŒë§¤POS ì •ê·œí™”
      const { manualPos, systemPos } = normalizeSalesPos(manualRow, systemRow, storeData);

      // ì „ëµì˜¨ë¼ì¸ ì œì™¸ ì¡°ê±´ìœ¼ë¡œ ì¸í•´ ë¹ˆ ê°’ì´ ë°˜í™˜ëœ ê²½ìš° ë¹„êµ ì œì™¸
      if (!manualPos && !systemPos) {
        return;
      }

      // ê°’ì´ ë‹¤ë¥´ê³  ë‘˜ ë‹¤ ë¹„ì–´ìˆì§€ ì•Šì€ ê²½ìš°ë§Œ ì°¨ì´ì ìœ¼ë¡œ ê¸°ë¡
      if (manualPos !== systemPos &&
        (manualPos || systemPos)) {

        differences.push({
          key,
          type: 'mismatch',
          field: 'ì‹¤íŒë§¤POS',
          fieldKey: 'sales_pos',
          correctValue: manualPos || 'ì •ê·œí™” ë¶ˆê°€',
          incorrectValue: systemPos || 'ì •ê·œí™” ë¶ˆê°€',
          description: 'ì‹¤íŒë§¤POS ë¹„êµ (VLOOKUP ë°©ì‹ ì •ê·œí™”, ì „ëµì˜¨ë¼ì¸ ì œì™¸)',
          manualRow: null,
          systemRow: null,
          assignedAgent: systemRow[77] || '' // BRì—´: ë“±ë¡ì§ì› (69+8)
        });
      }
      return;
    }

    // ìš”ê¸ˆì œ ë¹„êµ ë¡œì§
    if (manualField.key === 'plan') {
      // ë°°ì—´ ë²”ìœ„ ì²´í¬ (AL=37, AN=39, V=21)
      if (manualRow.length <= 39 || systemRow.length <= 21) {
        return;
      }

      // ìš”ê¸ˆì œ ì •ê·œí™”
      const { manualPlan, systemPlan, manualPlanType, systemPlanType } = normalizePlan(manualRow, systemRow, planData);

      // ANì—´ BLANK ì œì™¸ ì¡°ê±´ìœ¼ë¡œ ì¸í•´ ë¹ˆ ê°’ì´ ë°˜í™˜ëœ ê²½ìš° ë¹„êµ ì œì™¸
      if (!manualPlan && !systemPlan) {
        return;
      }

      // ìš”ê¸ˆì œ êµ¬ë¶„(Uì—´)ì´ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
      const planTypeMatch = manualPlanType && systemPlanType && manualPlanType === systemPlanType;

      // ê°’ì´ ë‹¤ë¥´ê³  ë‘˜ ë‹¤ ë¹„ì–´ìˆì§€ ì•Šì€ ê²½ìš°ë§Œ ì°¨ì´ì ìœ¼ë¡œ ê¸°ë¡
      // ë‹¨, ìš”ê¸ˆì œ êµ¬ë¶„(Uì—´)ì´ ì¼ì¹˜í•˜ë©´ ì°¨ì´ì ìœ¼ë¡œ ê¸°ë¡í•˜ì§€ ì•ŠìŒ
      if (manualPlan !== systemPlan &&
        (manualPlan || systemPlan) &&
        !planTypeMatch) {

        differences.push({
          key,
          type: 'mismatch',
          field: 'ìš”ê¸ˆì œ',
          fieldKey: 'plan',
          correctValue: manualPlan || 'ì •ê·œí™” ë¶ˆê°€',
          incorrectValue: systemPlan || 'ì •ê·œí™” ë¶ˆê°€',
          description: 'ìš”ê¸ˆì œ ë¹„êµ (VLOOKUP ë°©ì‹ ì •ê·œí™”, ANì—´ BLANK ì œì™¸, Uì—´ ì¼ì¹˜ ì‹œ ì œì™¸)',
          manualRow: null,
          systemRow: null,
          assignedAgent: systemRow[77] || '' // BRì—´: ë“±ë¡ì§ì› (69+8)
        });
      }
      return;
    }

    // ì¶œê³ ê°€ìƒì´ ë¹„êµ ë¡œì§
    if (manualField.key === 'shipping_virtual') {
      // ë°°ì—´ ë²”ìœ„ ì²´í¬ (AV=47, AZ=51, AW=48, BK=62, BM=64, BN=63, BL=65, AB=27)
      if (manualRow.length <= 65 || systemRow.length <= 27) {
        return;
      }

      // ì¶œê³ ê°€ìƒì´ ì •ê·œí™”
      const { manualShipping, systemShipping } = normalizeShippingVirtual(manualRow, systemRow);

      // ANì—´ BLANK ì œì™¸ ì¡°ê±´ìœ¼ë¡œ ì¸í•´ ë¹ˆ ê°’ì´ ë°˜í™˜ëœ ê²½ìš° ë¹„êµ ì œì™¸
      if (!manualShipping && !systemShipping) {
        return;
      }

      // ê°’ì´ ë‹¤ë¥´ê³  ë‘˜ ë‹¤ ë¹„ì–´ìˆì§€ ì•Šì€ ê²½ìš°ë§Œ ì°¨ì´ì ìœ¼ë¡œ ê¸°ë¡
      if (manualShipping !== systemShipping &&
        (manualShipping || systemShipping)) {

        differences.push({
          key,
          type: 'mismatch',
          field: 'ì¶œê³ ê°€ìƒì´',
          fieldKey: 'shipping_virtual',
          correctValue: manualShipping || 'ì •ê·œí™” ë¶ˆê°€',
          incorrectValue: systemShipping || 'ì •ê·œí™” ë¶ˆê°€',
          description: 'ì¶œê³ ê°€ìƒì´ ë¹„êµ (ë”í•˜ê¸° ë°©ì‹ ì •ê·œí™”, ANì—´ BLANK ì œì™¸)',
          manualRow: null,
          systemRow: null,
          assignedAgent: systemRow[77] || '' // BRì—´: ë“±ë¡ì§ì› (69+8)
        });
      }
      return;
    }

    // ì§€ì›ê¸ˆ ë° ì•½ì •ìƒì´ ë¹„êµ ë¡œì§
    if (manualField.key === 'support_contract') {
      // ë°°ì—´ ë²”ìœ„ ì²´í¬ (DH=85, BK=62, AN=39, AC=28)
      if (manualRow.length <= 85 || systemRow.length <= 28) {
        return;
      }

      // ì§€ì›ê¸ˆ ë° ì•½ì •ìƒì´ ì •ê·œí™”
      const { manualSupport, systemSupport } = normalizeSupportContract(manualRow, systemRow);

      // ANì—´ BLANK ì œì™¸ ì¡°ê±´ìœ¼ë¡œ ì¸í•´ ë¹ˆ ê°’ì´ ë°˜í™˜ëœ ê²½ìš° ë¹„êµ ì œì™¸
      if (!manualSupport && !systemSupport) {
        return;
      }

      // ê°’ì´ ë‹¤ë¥´ê³  ë‘˜ ë‹¤ ë¹„ì–´ìˆì§€ ì•Šì€ ê²½ìš°ë§Œ ì°¨ì´ì ìœ¼ë¡œ ê¸°ë¡
      if (manualSupport !== systemSupport &&
        (manualSupport || systemSupport)) {

        differences.push({
          key,
          type: 'mismatch',
          field: 'ì§€ì›ê¸ˆ ë° ì•½ì •ìƒì´',
          fieldKey: 'support_contract',
          correctValue: manualSupport || 'ì •ê·œí™” ë¶ˆê°€',
          incorrectValue: systemSupport || 'ì •ê·œí™” ë¶ˆê°€',
          description: 'ì§€ì›ê¸ˆ ë° ì•½ì •ìƒì´ ë¹„êµ (ì„ íƒë°©ì‹ ì •ê·œí™”, ANì—´ BLANK ì œì™¸)',
          manualRow: null,
          systemRow: null,
          assignedAgent: systemRow[77] || '' // BRì—´: ë“±ë¡ì§ì› (69+8)
        });
      }
      return;
    }

    // í”„ë¦¬í• ë¶€ìƒì´ ë¹„êµ ë¡œì§
    if (manualField.key === 'pre_installment') {
      // ë°°ì—´ ë²”ìœ„ ì²´í¬ (BE=56, AN=39)
      if (manualRow.length <= 56 || systemRow.length <= 39) {
        return;
      }

      // í”„ë¦¬í• ë¶€ìƒì´ ì •ê·œí™”
      const { manualPreInstallment, systemPreInstallment } = normalizePreInstallment(manualRow, systemRow);

      // ANì—´ BLANK ì œì™¸ ì¡°ê±´ìœ¼ë¡œ ì¸í•´ ë¹ˆ ê°’ì´ ë°˜í™˜ëœ ê²½ìš° ë¹„êµ ì œì™¸
      if (!manualPreInstallment && !systemPreInstallment) {
        return;
      }

      // ê°’ì´ ë‹¤ë¥´ê³  ë‘˜ ë‹¤ ë¹„ì–´ìˆì§€ ì•Šì€ ê²½ìš°ë§Œ ì°¨ì´ì ìœ¼ë¡œ ê¸°ë¡
      if (manualPreInstallment !== systemPreInstallment &&
        (manualPreInstallment || systemPreInstallment)) {

        differences.push({
          key,
          type: 'mismatch',
          field: 'í”„ë¦¬í• ë¶€ìƒì´',
          fieldKey: 'pre_installment',
          correctValue: manualPreInstallment || 'ì •ê·œí™” ë¶ˆê°€',
          incorrectValue: systemPreInstallment || 'ì •ê·œí™” ë¶ˆê°€',
          description: 'í”„ë¦¬í• ë¶€ìƒì´ ë¹„êµ (ì§ì ‘ ë¹„êµ, ANì—´ BLANK ì œì™¸)',
          manualRow: null,
          systemRow: null,
          assignedAgent: systemRow[77] || '' // BRì—´: ë“±ë¡ì§ì› (69+8)
        });
      }
      return;
    }

    // ìœ í†µë§ì§€ì›ê¸ˆ ìƒì´ ë¹„êµ ë¡œì§
    if (manualField.key === 'distribution_support') {
      // ë°°ì—´ ë²”ìœ„ ì²´í¬ (BX=75, AL=37)
      if (manualRow.length <= 75 || systemRow.length <= 37) {
        return;
      }

      // ìœ í†µë§ì§€ì›ê¸ˆ ìƒì´ ì •ê·œí™”
      const { manualDistribution, systemDistribution } = normalizeDistributionSupport(manualRow, systemRow);

      // ê°’ì´ ë‹¤ë¥´ê³  ë‘˜ ë‹¤ ë¹„ì–´ìˆì§€ ì•Šì€ ê²½ìš°ë§Œ ì°¨ì´ì ìœ¼ë¡œ ê¸°ë¡
      if (manualDistribution !== systemDistribution &&
        (manualDistribution || systemDistribution)) {

        differences.push({
          key,
          type: 'mismatch',
          field: 'ìœ í†µë§ì§€ì›ê¸ˆ ìƒì´',
          fieldKey: 'distribution_support',
          correctValue: manualDistribution || 'ì •ê·œí™” ë¶ˆê°€',
          incorrectValue: systemDistribution || 'ì •ê·œí™” ë¶ˆê°€',
          description: 'ìœ í†µë§ì§€ì›ê¸ˆ ìƒì´ ë¹„êµ (ìˆ«ì ì„œì‹ ì •ê·œí™”)',
          manualRow: null,
          systemRow: null,
          assignedAgent: systemRow[77] || '' // BRì—´: ë“±ë¡ì§ì› (69+8)
        });
      }
      return;
    }

    // ìœ í”Œë ˆì´ ìœ ì¹˜ ì¶”ê°€ ë¹„êµ ë¡œì§
    if (manualField.key === 'uplay_check') {
      // ìœ í”Œë ˆì´ ìœ ì¹˜ ì¶”ê°€ ì •ê·œí™”
      const { manualValue, systemValue } = normalizeUplayCheck(manualRow, systemRow);

      // ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
      console.log(`[ìœ í”Œë ˆì´ ìœ ì¹˜ ì¶”ê°€] key=${key}, manualValue="${manualValue}", systemValue="${systemValue}"`);

      // ê°’ì´ ë‹¤ë¥´ë©´ ì°¨ì´ì ìœ¼ë¡œ ê¸°ë¡
      if (manualValue.trim() !== systemValue.trim()) {

        console.log(`[ìœ í”Œë ˆì´ ìœ ì¹˜ ì¶”ê°€] ë¶ˆì¼ì¹˜ ë°œê²¬: manualValue="${manualValue}" !== systemValue="${systemValue}"`);

        differences.push({
          key,
          type: 'mismatch',
          field: 'ìœ í”Œë ˆì´ ìœ ì¹˜ ì¶”ê°€',
          fieldKey: 'uplay_check',
          correctValue: manualValue,
          incorrectValue: systemValue,
          description: 'ìœ í”Œë ˆì´ ìœ ì¹˜ ì¶”ê°€ (ë‹¨ì–´ í¬í•¨ ì—¬ë¶€ ë¹„êµ)',
          manualRow: null,
          systemRow: null,
          assignedAgent: systemRow[77] || '' // BRì—´: ë“±ë¡ì§ì› (69+8)
        });
      } else {
        console.log(`[ìœ í”Œë ˆì´ ìœ ì¹˜ ì¶”ê°€] ì¼ì¹˜: manualValue="${manualValue}" === systemValue="${systemValue}"`);
      }
      return;
    }

    // Vì»¬ëŸ¬ë§ ìŒì•…ê°ìƒ í”ŒëŸ¬ìŠ¤ ìœ ì¹˜ ë¹„êµ ë¡œì§
    if (manualField.key === 'vcoloring_music_plus') {
      // Vì»¬ëŸ¬ë§ ìŒì•…ê°ìƒ í”ŒëŸ¬ìŠ¤ ìœ ì¹˜ ì •ê·œí™”
      const { manualValue, systemValue } = normalizeVcoloringMusicPlus(manualRow, systemRow);

      // ê°’ì´ ë‹¤ë¥´ë©´ ì°¨ì´ì ìœ¼ë¡œ ê¸°ë¡
      if (manualValue.trim() !== systemValue.trim()) {
        differences.push({
          key,
          type: 'mismatch',
          field: 'Vì»¬ëŸ¬ë§ ìŒì•…ê°ìƒ í”ŒëŸ¬ìŠ¤ ìœ ì¹˜',
          fieldKey: 'vcoloring_music_plus',
          correctValue: manualValue,
          incorrectValue: systemValue,
          description: 'Vì»¬ëŸ¬ë§ ìŒì•…ê°ìƒ í”ŒëŸ¬ìŠ¤ ìœ ì¹˜ (ë‹¨ì–´ í¬í•¨ ì—¬ë¶€ ë¹„êµ)',
          manualRow: null,
          systemRow: null,
          assignedAgent: systemRow[77] || '' // BRì—´: ë“±ë¡ì§ì› (69+8)
        });
      }
      return;
    }

    // í°êµì²´ íŒ¨ìŠ¤ ìœ ì¹˜ ë¹„êµ ë¡œì§
    if (manualField.key === 'phone_exchange_pass') {
      // í°êµì²´ íŒ¨ìŠ¤ ìœ ì¹˜ ì •ê·œí™”
      const { manualValue, systemValue } = normalizePhoneExchangePass(manualRow, systemRow);

      // ê°’ì´ ë‹¤ë¥´ë©´ ì°¨ì´ì ìœ¼ë¡œ ê¸°ë¡
      if (manualValue.trim() !== systemValue.trim()) {
        differences.push({
          key,
          type: 'mismatch',
          field: 'í°êµì²´ íŒ¨ìŠ¤ ìœ ì¹˜',
          fieldKey: 'phone_exchange_pass',
          correctValue: manualValue,
          incorrectValue: systemValue,
          description: 'í°êµì²´ íŒ¨ìŠ¤ ìœ ì¹˜ (ë‹¨ì–´ í¬í•¨ ì—¬ë¶€ ë¹„êµ)',
          manualRow: null,
          systemRow: null,
          assignedAgent: systemRow[77] || '' // BRì—´: ë“±ë¡ì§ì› (69+8)
        });
      }
      return;
    }

    // í°êµì²´ ìŠ¬ë¦¼ ìœ ì¹˜ ë¹„êµ ë¡œì§
    if (manualField.key === 'phone_exchange_slim') {
      // í°êµì²´ ìŠ¬ë¦¼ ìœ ì¹˜ ì •ê·œí™”
      const { manualValue, systemValue } = normalizePhoneExchangeSlim(manualRow, systemRow);

      // ê°’ì´ ë‹¤ë¥´ë©´ ì°¨ì´ì ìœ¼ë¡œ ê¸°ë¡
      if (manualValue.trim() !== systemValue.trim()) {
        differences.push({
          key,
          type: 'mismatch',
          field: 'í°êµì²´ ìŠ¬ë¦¼ ìœ ì¹˜',
          fieldKey: 'phone_exchange_slim',
          correctValue: manualValue,
          incorrectValue: systemValue,
          description: 'í°êµì²´ ìŠ¬ë¦¼ ìœ ì¹˜ (ë‹¨ì–´ í¬í•¨ ì—¬ë¶€ ë¹„êµ)',
          manualRow: null,
          systemRow: null,
          assignedAgent: systemRow[77] || '' // BRì—´: ë“±ë¡ì§ì› (69+8)
        });
      }
      return;
    }

    // í° ì•ˆì‹¬íŒ¨ìŠ¤ ìœ ì¹˜ ë¹„êµ ë¡œì§
    if (manualField.key === 'phone_safe_pass') {
      // í° ì•ˆì‹¬íŒ¨ìŠ¤ ìœ ì¹˜ ì •ê·œí™”
      const { manualValue, systemValue } = normalizePhoneSafePass(manualRow, systemRow);

      // ê°’ì´ ë‹¤ë¥´ë©´ ì°¨ì´ì ìœ¼ë¡œ ê¸°ë¡
      if (manualValue.trim() !== systemValue.trim()) {
        differences.push({
          key,
          type: 'mismatch',
          field: 'í° ì•ˆì‹¬íŒ¨ìŠ¤ ìœ ì¹˜',
          fieldKey: 'phone_safe_pass',
          correctValue: manualValue,
          incorrectValue: systemValue,
          description: 'í° ì•ˆì‹¬íŒ¨ìŠ¤ ìœ ì¹˜ (ë‹¨ì–´ í¬í•¨ ì—¬ë¶€ ë¹„êµ)',
          manualRow: null,
          systemRow: null,
          assignedAgent: systemRow[77] || '' // BRì—´: ë“±ë¡ì§ì› (69+8)
        });
      }
      return;
    }

    // ë³´í—˜ ë¯¸ìœ ì¹˜ ë¹„êµ ë¡œì§
    if (manualField.key === 'insurance_no') {
      // ë³´í—˜ ë¯¸ìœ ì¹˜ ì •ê·œí™”
      const { manualValue, systemValue } = normalizeInsuranceNo(manualRow, systemRow);

      // ë³´í—˜ ë¯¸ìœ ì¹˜: ê°’ì´ ë‹¤ë¥´ë©´ ë¶ˆì¼ì¹˜, ê°™ìœ¼ë©´ ì¼ì¹˜
      if (manualValue.trim() !== systemValue.trim()) {
        differences.push({
          key,
          type: 'mismatch',
          field: 'ë³´í—˜ ë¯¸ìœ ì¹˜',
          fieldKey: 'insurance_no',
          correctValue: manualValue,
          incorrectValue: systemValue,
          description: 'ë³´í—˜ ë¯¸ìœ ì¹˜ (í°í´: ë³´í—˜ í¬í•¨ì‹œ ë¯¸ìœ ì¹˜, ë¯¸í¬í•¨ì‹œ ìœ ì¹˜)',
          manualRow: null,
          systemRow: null,
          assignedAgent: systemRow[77] || '' // BRì—´: ë“±ë¡ì§ì› (69+8)
        });
      }
      return;
    }

    // í†µí™”ì—°ê²°ìŒ ìœ ì¹˜ ë¹„êµ ë¡œì§
    if (manualField.key === 'call_ringtone') {
      // í†µí™”ì—°ê²°ìŒ ìœ ì¹˜ ì •ê·œí™”
      const { manualValue, systemValue } = normalizeCallRingtone(manualRow, systemRow);

      // ê°’ì´ ë‹¤ë¥´ë©´ ì°¨ì´ì ìœ¼ë¡œ ê¸°ë¡
      if (manualValue.trim() !== systemValue.trim()) {
        differences.push({
          key,
          type: 'mismatch',
          field: 'í†µí™”ì—°ê²°ìŒ ìœ ì¹˜',
          fieldKey: 'call_ringtone',
          correctValue: manualValue,
          incorrectValue: systemValue,
          description: 'í†µí™”ì—°ê²°ìŒ ìœ ì¹˜ (ë‹¨ì–´ í¬í•¨ ì—¬ë¶€ ë¹„êµ)',
          manualRow: null,
          systemRow: null,
          assignedAgent: systemRow[77] || '' // BRì—´: ë“±ë¡ì§ì› (69+8)
        });
      }
      return;
    }

    // í†µí™”ì—°ê²°ìŒ ë¯¸ìœ ì¹˜ ë¹„êµ ë¡œì§
    if (manualField.key === 'call_ringtone_no') {
      // í†µí™”ì—°ê²°ìŒ ë¯¸ìœ ì¹˜ ì •ê·œí™”
      const { manualValue, systemValue } = normalizeCallRingtoneNo(manualRow, systemRow);

      // í†µí™”ì—°ê²°ìŒ ë¯¸ìœ ì¹˜: ê°’ì´ ë‹¤ë¥´ë©´ ë¶ˆì¼ì¹˜, ê°™ìœ¼ë©´ ì¼ì¹˜
      if (manualValue.trim() !== systemValue.trim()) {
        differences.push({
          key,
          type: 'mismatch',
          field: 'í†µí™”ì—°ê²°ìŒ ë¯¸ìœ ì¹˜',
          fieldKey: 'call_ringtone_no',
          correctValue: manualValue,
          incorrectValue: systemValue,
          description: 'í†µí™”ì—°ê²°ìŒ ë¯¸ìœ ì¹˜ (í°í´: í†µí™”ì—°ê²°ìŒ í¬í•¨ì‹œ ë¯¸ìœ ì¹˜, ë¯¸í¬í•¨ì‹œ ìœ ì¹˜)',
          manualRow: null,
          systemRow: null,
          assignedAgent: systemRow[77] || '' // BRì—´: ë“±ë¡ì§ì› (69+8)
        });
      }
      return;
    }

    // ì²­ì†Œë…„ìš”ê¸ˆì œì¶”ê°€ì •ì±…(1)ìœ ì¹˜ ë¹„êµ ë¡œì§
    if (manualField.key === 'youth_plan_policy_1') {
      // ì²­ì†Œë…„ìš”ê¸ˆì œì¶”ê°€ì •ì±…(1)ìœ ì¹˜ ì •ê·œí™”
      const { manualValue, systemValue } = normalizeYouthPlanPolicy1(manualRow, systemRow);

      // ê°’ì´ ë‹¤ë¥´ë©´ ì°¨ì´ì ìœ¼ë¡œ ê¸°ë¡
      if (manualValue.trim() !== systemValue.trim()) {
        differences.push({
          key,
          type: 'mismatch',
          field: 'ì²­ì†Œë…„ìš”ê¸ˆì œì¶”ê°€ì •ì±…(1)ìœ ì¹˜',
          fieldKey: 'youth_plan_policy_1',
          correctValue: manualValue,
          incorrectValue: systemValue,
          description: 'ì²­ì†Œë…„ìš”ê¸ˆì œì¶”ê°€ì •ì±…(1)ìœ ì¹˜ (ë³µí•© ì¡°ê±´ ë¹„êµ)',
          manualRow: null,
          systemRow: null,
          assignedAgent: systemRow[77] || '' // BRì—´: ë“±ë¡ì§ì› (69+8)
        });
      }
      return;
    }

    // ì²­ì†Œë…„ìš”ê¸ˆì œì¶”ê°€ì •ì±…(2)ìœ ì¹˜ ë¹„êµ ë¡œì§
    if (manualField.key === 'youth_plan_policy_2') {
      // ì²­ì†Œë…„ìš”ê¸ˆì œì¶”ê°€ì •ì±…(2)ìœ ì¹˜ ì •ê·œí™”
      const { manualValue, systemValue } = normalizeYouthPlanPolicy2(manualRow, systemRow);

      // ê°’ì´ ë‹¤ë¥´ë©´ ì°¨ì´ì ìœ¼ë¡œ ê¸°ë¡
      if (manualValue.trim() !== systemValue.trim()) {
        differences.push({
          key,
          type: 'mismatch',
          field: 'ì²­ì†Œë…„ìš”ê¸ˆì œì¶”ê°€ì •ì±…(2)ìœ ì¹˜',
          fieldKey: 'youth_plan_policy_2',
          correctValue: manualValue,
          incorrectValue: systemValue,
          description: 'ì²­ì†Œë…„ìš”ê¸ˆì œì¶”ê°€ì •ì±…(2)ìœ ì¹˜ (ë³µí•© ì¡°ê±´ ë¹„êµ)',
          manualRow: null,
          systemRow: null,
          assignedAgent: systemRow[77] || '' // BRì—´: ë“±ë¡ì§ì› (69+8)
        });
      }
      return;
    }

    // ìœ í†µë§ì§€ì›ê¸ˆ í™œì„±í™”ì •ì±… ë¹„êµ ë¡œì§
    if (manualField.key === 'distribution_support_activation') {
      // ìœ í†µë§ì§€ì›ê¸ˆ í™œì„±í™”ì •ì±… ì •ê·œí™”
      const { manualValue, systemValue } = normalizeDistributionSupportActivation(manualRow, systemRow);

      // ê°’ì´ ë‹¤ë¥´ë©´ ì°¨ì´ì ìœ¼ë¡œ ê¸°ë¡
      if (manualValue.trim() !== systemValue.trim()) {
        differences.push({
          key,
          type: 'mismatch',
          field: 'ìœ í†µë§ì§€ì›ê¸ˆ í™œì„±í™”ì •ì±…',
          fieldKey: 'distribution_support_activation',
          correctValue: manualValue,
          incorrectValue: systemValue,
          description: 'ìœ í†µë§ì§€ì›ê¸ˆ í™œì„±í™”ì •ì±… (ë³µí•© ì¡°ê±´ ë¹„êµ)',
          manualRow: null,
          systemRow: null,
          assignedAgent: systemRow[77] || '' // BRì—´: ë“±ë¡ì§ì› (69+8)
        });
      }
      return;
    }

    // 115êµ° ì„ íƒì•½ì • ì°¨ê° ë¹„êµ ë¡œì§
    if (manualField.key === '115_group_contract_deduction') {
      // 115êµ° ì„ íƒì•½ì • ì°¨ê° ì •ê·œí™”
      const { manualValue, systemValue } = normalize115GroupContractDeduction(manualRow, systemRow);

      // ê°’ì´ ë‹¤ë¥´ë©´ ì°¨ì´ì ìœ¼ë¡œ ê¸°ë¡
      if (manualValue.trim() !== systemValue.trim()) {
        differences.push({
          key,
          type: 'mismatch',
          field: '115êµ° ì„ íƒì•½ì • ì°¨ê°',
          fieldKey: '115_group_contract_deduction',
          correctValue: manualValue,
          incorrectValue: systemValue,
          description: '115êµ° ì„ íƒì•½ì • ì°¨ê° (ë³µí•© ì¡°ê±´ ë¹„êµ)',
          manualRow: null,
          systemRow: null,
          assignedAgent: systemRow[77] || '' // BRì—´: ë“±ë¡ì§ì› (69+8)
        });
      }
      return;
    }

    // ì„ íƒì•½ì • S721(010ì‹ ê·œ) ì°¨ê° ë¹„êµ ë¡œì§
    if (manualField.key === 's721_contract_deduction') {
      // ì„ íƒì•½ì • S721(010ì‹ ê·œ) ì°¨ê° ì •ê·œí™”
      const { manualValue, systemValue } = normalizeS721ContractDeduction(manualRow, systemRow);

      // ê°’ì´ ë‹¤ë¥´ë©´ ì°¨ì´ì ìœ¼ë¡œ ê¸°ë¡
      if (manualValue.trim() !== systemValue.trim()) {
        differences.push({
          key,
          type: 'mismatch',
          field: 'ì„ íƒì•½ì • S721(010ì‹ ê·œ) ì°¨ê°',
          fieldKey: 's721_contract_deduction',
          correctValue: manualValue,
          incorrectValue: systemValue,
          description: 'ì„ íƒì•½ì • S721(010ì‹ ê·œ) ì°¨ê° (ë³µí•© ì¡°ê±´ ë¹„êµ)',
          manualRow: null,
          systemRow: null,
          assignedAgent: systemRow[77] || '' // BRì—´: ë“±ë¡ì§ì› (69+8)
        });
      }
      return;
    }

    // ì„ íƒì•½ì • S931,S938,S937(MNP) ì°¨ê° ë¹„êµ ë¡œì§
    if (manualField.key === 's931_s938_s937_contract_deduction') {
      // ì„ íƒì•½ì • S931,S938,S937(MNP) ì°¨ê° ì •ê·œí™”
      const { manualValue, systemValue } = normalizeS931S938S937ContractDeduction(manualRow, systemRow);

      // ê°’ì´ ë‹¤ë¥´ë©´ ì°¨ì´ì ìœ¼ë¡œ ê¸°ë¡
      if (manualValue.trim() !== systemValue.trim()) {
        differences.push({
          key,
          type: 'mismatch',
          field: 'ì„ íƒì•½ì • S931,S938,S937(MNP) ì°¨ê°',
          fieldKey: 's931_s938_s937_contract_deduction',
          correctValue: manualValue,
          incorrectValue: systemValue,
          description: 'ì„ íƒì•½ì • S931,S938,S937(MNP) ì°¨ê° (ë³µí•© ì¡°ê±´ ë¹„êµ)',
          manualRow: null,
          systemRow: null,
          assignedAgent: systemRow[77] || '' // BRì—´: ë“±ë¡ì§ì› (69+8)
        });
      }
      return;
    }

    // ì„ íƒì•½ì • ì•„ì´í°16ë¥˜ì „ì²´(MNP) ì°¨ê° ë¹„êµ ë¡œì§
    if (manualField.key === 'iphone16_contract_deduction') {
      // ì„ íƒì•½ì • ì•„ì´í°16ë¥˜ì „ì²´(MNP) ì°¨ê° ì •ê·œí™”
      const { manualValue, systemValue } = normalizeIphone16ContractDeduction(manualRow, systemRow);

      // ê°’ì´ ë‹¤ë¥´ë©´ ì°¨ì´ì ìœ¼ë¡œ ê¸°ë¡
      if (manualValue.trim() !== systemValue.trim()) {
        differences.push({
          key,
          type: 'mismatch',
          field: 'ì„ íƒì•½ì • ì•„ì´í°16ë¥˜ì „ì²´(MNP) ì°¨ê°',
          fieldKey: 'iphone16_contract_deduction',
          correctValue: manualValue,
          incorrectValue: systemValue,
          description: 'ì„ íƒì•½ì • ì•„ì´í°16ë¥˜ì „ì²´(MNP) ì°¨ê° (ë³µí•© ì¡°ê±´ ë¹„êµ)',
          manualRow: null,
          systemRow: null,
          assignedAgent: systemRow[77] || '' // BRì—´: ë“±ë¡ì§ì› (69+8)
        });
      }
      return;
    }

    // A166 44êµ° ëŒ€ìƒì™¸ìš”ê¸ˆì œ(MNP) ì°¨ê° ë¹„êµ ë¡œì§
    if (manualField.key === 'a166_44group_excluded_plan_deduction') {
      // A166 44êµ° ëŒ€ìƒì™¸ìš”ê¸ˆì œ(MNP) ì°¨ê° ì •ê·œí™”
      const { manualValue, systemValue } = normalizeA16644GroupExcludedPlanDeduction(manualRow, systemRow);

      // ê°’ì´ ë‹¤ë¥´ë©´ ì°¨ì´ì ìœ¼ë¡œ ê¸°ë¡
      if (manualValue.trim() !== systemValue.trim()) {
        differences.push({
          key,
          type: 'mismatch',
          field: 'A166 44êµ° ëŒ€ìƒì™¸ìš”ê¸ˆì œ(MNP) ì°¨ê°',
          fieldKey: 'a166_44group_excluded_plan_deduction',
          correctValue: manualValue,
          incorrectValue: systemValue,
          description: 'A166 44êµ° ëŒ€ìƒì™¸ìš”ê¸ˆì œ(MNP) ì°¨ê° (ë³µí•© ì¡°ê±´ ë¹„êµ)',
          manualRow: null,
          systemRow: null,
          assignedAgent: systemRow[77] || '' // BRì—´: ë“±ë¡ì§ì› (69+8)
        });
      }
      return;
    }

    // A166 44êµ° ëŒ€ìƒì™¸ìš”ê¸ˆì œ(ê¸°ë³€) ì°¨ê° ë¹„êµ ë¡œì§
    if (manualField.key === 'a166_44group_excluded_plan_change_deduction') {
      // A166 44êµ° ëŒ€ìƒì™¸ìš”ê¸ˆì œ(ê¸°ë³€) ì°¨ê° ì •ê·œí™”
      const { manualValue, systemValue } = normalizeA16644GroupExcludedPlanChangeDeduction(manualRow, systemRow);

      // ê°’ì´ ë‹¤ë¥´ë©´ ì°¨ì´ì ìœ¼ë¡œ ê¸°ë¡
      if (manualValue.trim() !== systemValue.trim()) {
        differences.push({
          key,
          type: 'mismatch',
          field: 'A166 44êµ° ëŒ€ìƒì™¸ìš”ê¸ˆì œ(ê¸°ë³€) ì°¨ê°',
          fieldKey: 'a166_44group_excluded_plan_change_deduction',
          correctValue: manualValue,
          incorrectValue: systemValue,
          description: 'A166 44êµ° ëŒ€ìƒì™¸ìš”ê¸ˆì œ(ê¸°ë³€) ì°¨ê° (ë³µí•© ì¡°ê±´ ë¹„êµ)',
          manualRow: null,
          systemRow: null,
          assignedAgent: systemRow[77] || '' // BRì—´: ë“±ë¡ì§ì› (69+8)
        });
      }
      return;
    }

    // ì •ì±…ê¸°ë³€ ì°¨ê° ë¹„êµ ë¡œì§
    if (manualField.key === 'policy_change_deduction') {
      // ì •ì±…ê¸°ë³€ ì°¨ê° ì •ê·œí™”
      const { manualValue, systemValue } = normalizePolicyChangeDeduction(manualRow, systemRow);

      // ê°’ì´ ë‹¤ë¥´ë©´ ì°¨ì´ì ìœ¼ë¡œ ê¸°ë¡
      if (manualValue.trim() !== systemValue.trim()) {
        differences.push({
          key,
          type: 'mismatch',
          field: 'ì •ì±…ê¸°ë³€ ì°¨ê°',
          fieldKey: 'policy_change_deduction',
          correctValue: manualValue,
          incorrectValue: systemValue,
          description: 'ì •ì±…ê¸°ë³€ ì°¨ê° (ë‹¨ìˆœ ì¡°ê±´ ë¹„êµ)',
          manualRow: null,
          systemRow: null,
          assignedAgent: systemRow[77] || '' // BRì—´: ë“±ë¡ì§ì› (69+8)
        });
      }
      return;
    }

    // ê¸°ë³€ Cíƒ€ê²Ÿ ì°¨ê° ë¹„êµ ë¡œì§
    if (manualField.key === 'change_c_target_deduction') {
      // ê¸°ë³€ Cíƒ€ê²Ÿ ì°¨ê° ì •ê·œí™”
      const { manualValue, systemValue } = normalizeChangeCTargetDeduction(manualRow, systemRow);

      // ê°’ì´ ë‹¤ë¥´ë©´ ì°¨ì´ì ìœ¼ë¡œ ê¸°ë¡
      if (manualValue.trim() !== systemValue.trim()) {
        differences.push({
          key,
          type: 'mismatch',
          field: 'ê¸°ë³€ Cíƒ€ê²Ÿ ì°¨ê°',
          fieldKey: 'change_c_target_deduction',
          correctValue: manualValue,
          incorrectValue: systemValue,
          description: 'ê¸°ë³€ Cíƒ€ê²Ÿ ì°¨ê° (ë‹¨ìˆœ ì¡°ê±´ ë¹„êµ)',
          manualRow: null,
          systemRow: null,
          assignedAgent: systemRow[77] || '' // BRì—´: ë“±ë¡ì§ì› (69+8)
        });
      }
      return;
    }

    // 33êµ°ë¯¸ë§Œ, ì‹œë‹ˆì–´1êµ°ì‹œ ì°¨ê° ë¹„êµ ë¡œì§
    if (manualField.key === '33group_senior1_deduction') {
      // 33êµ°ë¯¸ë§Œ, ì‹œë‹ˆì–´1êµ°ì‹œ ì°¨ê° ì •ê·œí™”
      const { manualValue, systemValue } = normalize33GroupSenior1Deduction(manualRow, systemRow);

      // ê°’ì´ ë‹¤ë¥´ë©´ ì°¨ì´ì ìœ¼ë¡œ ê¸°ë¡
      if (manualValue.trim() !== systemValue.trim()) {
        differences.push({
          key,
          type: 'mismatch',
          field: '33êµ°ë¯¸ë§Œ, ì‹œë‹ˆì–´1êµ°ì‹œ ì°¨ê°',
          fieldKey: '33group_senior1_deduction',
          correctValue: manualValue,
          incorrectValue: systemValue,
          description: '33êµ°ë¯¸ë§Œ, ì‹œë‹ˆì–´1êµ°ì‹œ ì°¨ê° (ë‹¨ìˆœ ì¡°ê±´ ë¹„êµ)',
          manualRow: null,
          systemRow: null,
          assignedAgent: systemRow[77] || '' // BRì—´: ë“±ë¡ì§ì› (69+8)
        });
      }
      return;
    }

    // ì˜¨ì„¸ì¼ ì „ëµì˜¨ë¼ì¸POS ì°¨ê° ë¹„êµ ë¡œì§
    if (manualField.key === 'onsale_strategy_online_pos_deduction') {
      // ì˜¨ì„¸ì¼ ì „ëµì˜¨ë¼ì¸POS ì°¨ê° ì •ê·œí™”
      const { manualValue, systemValue } = normalizeOnsaleStrategyOnlinePosDeduction(manualRow, systemRow);

      // ê°’ì´ ë‹¤ë¥´ë©´ ì°¨ì´ì ìœ¼ë¡œ ê¸°ë¡
      if (manualValue.trim() !== systemValue.trim()) {
        differences.push({
          key,
          type: 'mismatch',
          field: 'ì˜¨ì„¸ì¼ ì „ëµì˜¨ë¼ì¸POS ì°¨ê°',
          fieldKey: 'onsale_strategy_online_pos_deduction',
          correctValue: manualValue,
          incorrectValue: systemValue,
          description: 'ì˜¨ì„¸ì¼ ì „ëµì˜¨ë¼ì¸POS ì°¨ê° (ë³µí•© ì¡°ê±´ ë¹„êµ)',
          manualRow: null,
          systemRow: null,
          assignedAgent: systemRow[77] || '' // BRì—´: ë“±ë¡ì§ì› (69+8)
        });
      }
      return;
    }

    // ìœ í”Œë ˆì´ ë¯¸ìœ ì¹˜ ì°¨ê° ë¹„êµ ë¡œì§
    if (manualField.key === 'uplay_no_check') {
      // ìœ í”Œë ˆì´ ë¯¸ìœ ì¹˜ ì°¨ê° ì •ê·œí™”
      const { manualValue, systemValue } = normalizeUplayNoCheck(manualRow, systemRow);

      // 500280760172 ê°€ë²ˆ ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€


      // ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
      console.log(`[ìœ í”Œë ˆì´ ë¯¸ìœ ì¹˜ ì°¨ê°] key=${key}, manualValue="${manualValue}", systemValue="${systemValue}"`);

      // ê°’ì´ ë‹¤ë¥´ë©´ ë¶ˆì¼ì¹˜ë¡œ ê¸°ë¡
      if (manualValue.trim() !== systemValue.trim()) {

        console.log(`[ìœ í”Œë ˆì´ ë¯¸ìœ ì¹˜ ì°¨ê°] ë¶ˆì¼ì¹˜ ë°œê²¬: manualValue="${manualValue}" !== systemValue="${systemValue}"`);

        differences.push({
          key,
          type: 'mismatch',
          field: 'ìœ í”Œë ˆì´ ë¯¸ìœ ì¹˜ ì°¨ê°',
          fieldKey: 'uplay_no_check',
          correctValue: manualValue,
          incorrectValue: systemValue,
          description: 'ìœ í”Œë ˆì´ ë¯¸ìœ ì¹˜ ì°¨ê° (ì¼ë°˜ ë¡œì§: ê°’ì´ ë‹¤ë¥´ë©´ ë¶ˆì¼ì¹˜)',
          manualRow: null,
          systemRow: null,
          assignedAgent: systemRow[77] || '' // BRì—´: ë“±ë¡ì§ì› (69+8)
        });
      } else {
        console.log(`[ìœ í”Œë ˆì´ ë¯¸ìœ ì¹˜ ì°¨ê°] ì¼ì¹˜: manualValue="${manualValue}" === systemValue="${systemValue}"`);
      }
      return;
    }

    // ê¸°ì¡´ ë¹„êµ ë¡œì§ (ëŒ€ë¦¬ì ì½”ë“œ ë“±)
    // ë°°ì—´ ë²”ìœ„ ì²´í¬
    if (manualRow.length <= manualField.column || systemRow.length <= systemField.column) {
      return;
    }

    let manualValue = manualRow[manualField.column] || '';
    let systemValue = systemRow[systemField.column] || '';

    // ì •ê·œí‘œí˜„ì‹ì´ ìˆìœ¼ë©´ ê°’ ì¶”ì¶œ
    if (regex) {
      manualValue = extractValueWithRegex(manualValue, regex);
      systemValue = extractValueWithRegex(systemValue, regex);

      // ëŒ€ë¦¬ì ì½”ë“œì˜ ê²½ìš°: ìˆ˜ê¸°ì´ˆ ê°’ì´ í°í´ë°ì´í„°ì— í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ì¼ì¹˜ë¡œ ì²˜ë¦¬
      if (manualField.key === 'store_code' && manualValue && systemValue) {
        const manualCodes = manualValue.split(', ').map(code => code.trim());
        const systemCodes = systemValue.split(', ').map(code => code.trim());

        // ìˆ˜ê¸°ì´ˆì˜ ëŒ€ë¦¬ì ì½”ë“œê°€ í°í´ë°ì´í„°ì— í•˜ë‚˜ë¼ë„ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ì¼ì¹˜
        const hasMatch = manualCodes.some(manualCode =>
          systemCodes.some(systemCode => manualCode === systemCode)
        );

        if (hasMatch) {
          return; // ì¼ì¹˜í•˜ë¯€ë¡œ ì°¨ì´ì ìœ¼ë¡œ ê¸°ë¡í•˜ì§€ ì•ŠìŒ
        }
      }
    }

    // ê°’ì´ ë‹¤ë¥´ê³  ë‘˜ ë‹¤ ë¹„ì–´ìˆì§€ ì•Šì€ ê²½ìš°ë§Œ ì°¨ì´ì ìœ¼ë¡œ ê¸°ë¡
    if (manualValue.toString().trim() !== systemValue.toString().trim() &&
      (manualValue.toString().trim() || systemValue.toString().trim())) {
      differences.push({
        key,
        type: 'mismatch',
        field: manualField.name,
        fieldKey: manualField.key,
        correctValue: manualValue.toString().trim(),
        incorrectValue: systemValue.toString().trim(),
        description,
        manualRow: null,
        systemRow: null,
        assignedAgent: systemRow[77] || '' // BRì—´: ë“±ë¡ì§ì› (69+8)
      });
    }
  });

  return differences;
}

// ê²€ìˆ˜ ì™„ë£Œ ìƒíƒœ ì—…ë°ì´íŠ¸
app.post('/api/inspection/complete', async (req, res) => {
  try {
    const { itemId, userId, status } = req.body;

    if (!itemId || !userId) {
      return res.status(400).json({
        success: false,
        error: 'Item ID and User ID are required'
      });
    }

    // ê²€ìˆ˜ê²°ê³¼ ì‹œíŠ¸ì— ì™„ë£Œ ìƒíƒœ ê¸°ë¡
    const completionData = [
      [
        new Date().toISOString(), // ì™„ë£Œì¼ì‹œ
        userId,                   // ì²˜ë¦¬ì
        itemId,                   // í•­ëª© ID
        status || 'ì™„ë£Œ',         // ìƒíƒœ
        'ì²˜ë¦¬ì™„ë£Œ'                // ë¹„ê³ 
      ]
    ];

    await sheets.spreadsheets.values.append({
      spreadsheetId: SPREADSHEET_ID,
      range: `${INSPECTION_RESULT_SHEET_NAME}!A:E`,
      valueInputOption: 'USER_ENTERED',
      resource: {
        values: completionData
      }
    });

    // ìºì‹œ ë¬´íš¨í™”
    invalidateInspectionCache(userId);

    res.json({
      success: true,
      message: 'ê²€ìˆ˜ ì™„ë£Œ ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.'
    });
  } catch (error) {
    console.error('Error updating inspection completion:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to update inspection completion',
      message: error.message
    });
  }
});

// ì •ê·œí™” ë°ì´í„° ì €ì¥
app.post('/api/inspection/normalize', async (req, res) => {
  try {
    const { itemId, userId, originalValue, normalizedValue, field } = req.body;

    if (!itemId || !userId || !normalizedValue) {
      return res.status(400).json({
        success: false,
        error: 'Item ID, User ID, and normalized value are required'
      });
    }

    // ì •ê·œí™”ì´ë ¥ ì‹œíŠ¸ì— ê¸°ë¡
    const normalizationData = [
      [
        new Date().toISOString(), // ì •ê·œí™”ì¼ì‹œ
        userId,                   // ì²˜ë¦¬ì
        itemId,                   // í•­ëª© ID
        field,                    // í•„ë“œëª…
        originalValue || '',      // ì›ë³¸ê°’
        normalizedValue,          // ì •ê·œí™”ê°’
        'ìˆ˜ë™ì •ê·œí™”'              // ë¹„ê³ 
      ]
    ];

    await sheets.spreadsheets.values.append({
      spreadsheetId: SPREADSHEET_ID,
      range: `${NORMALIZATION_HISTORY_SHEET_NAME}!A:G`,
      valueInputOption: 'USER_ENTERED',
      resource: {
        values: normalizationData
      }
    });

    // ìºì‹œ ë¬´íš¨í™”
    invalidateInspectionCache(userId);

    res.json({
      success: true,
      message: 'ì •ê·œí™” ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'
    });
  } catch (error) {
    console.error('Error saving normalization data:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to save normalization data',
      message: error.message
    });
  }
});

// í°í´ê°œí†µë°ì´í„° ìˆ˜ì • API
app.post('/api/inspection/update-system-data', async (req, res) => {
  try {
    const { itemId, userId, field, correctValue, systemRow } = req.body;

    if (!itemId || !userId || !field || !correctValue || systemRow === null) {
      return res.status(400).json({
        success: false,
        error: 'Item ID, User ID, field, correct value, and system row are required'
      });
    }

    // í•„ë“œëª…ì— ë”°ë¥¸ ì»¬ëŸ¼ ì¸ë±ìŠ¤ ë§¤í•‘
    const fieldToColumnMap = {
      'ì´ë¦„': 1,      // Bì—´
      'ì „í™”ë²ˆí˜¸': 2,   // Cì—´
      'ì£¼ì†Œ': 3,      // Dì—´
      'ìƒë…„ì›”ì¼': 4,  // Eì—´
      'ì„±ë³„': 5,      // Fì—´
      // ë” ë§ì€ í•„ë“œ ë§¤í•‘ ì¶”ê°€ ê°€ëŠ¥
    };

    const columnIndex = fieldToColumnMap[field];
    if (columnIndex === undefined) {
      return res.status(400).json({
        success: false,
        error: 'Invalid field name'
      });
    }

    // í°í´ê°œí†µë°ì´í„° ì‹œíŠ¸ì—ì„œ í•´ë‹¹ í–‰ì˜ íŠ¹ì • ì»¬ëŸ¼ ìˆ˜ì •
    const range = `${CURRENT_MONTH_ACTIVATION_SHEET_NAME}!${String.fromCharCode(65 + columnIndex)}${systemRow}`;

    await sheets.spreadsheets.values.update({
      spreadsheetId: SPREADSHEET_ID,
      range: range,
      valueInputOption: 'USER_ENTERED',
      resource: {
        values: [[correctValue]]
      }
    });

    // ìˆ˜ì • ì´ë ¥ ì‹œíŠ¸ì— ê¸°ë¡
    const updateHistoryData = [
      [
        new Date().toISOString(), // ìˆ˜ì •ì¼ì‹œ
        userId,                   // ì²˜ë¦¬ì
        itemId,                   // í•­ëª© ID
        field,                    // í•„ë“œëª…
        correctValue,             // ìˆ˜ì •ëœ ê°’
        'í°í´ê°œí†µë°ì´í„° ìˆ˜ì •'     // ë¹„ê³ 
      ]
    ];

    await sheets.spreadsheets.values.append({
      spreadsheetId: SPREADSHEET_ID,
      range: `${INSPECTION_RESULT_SHEET_NAME}!A:F`,
      valueInputOption: 'USER_ENTERED',
      resource: {
        values: updateHistoryData
      }
    });

    // ìºì‹œ ë¬´íš¨í™”
    invalidateInspectionCache(userId);

    res.json({
      success: true,
      message: 'í°í´ê°œí†µë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.'
    });
  } catch (error) {
    console.error('Error updating system data:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to update system data',
      message: error.message
    });
  }
});

// ì‚¬ìš© ê°€ëŠ¥í•œ í•„ë“œ ëª©ë¡ ì¡°íšŒ API
app.get('/api/inspection/available-fields', async (req, res) => {
  try {
    const fields = COLUMN_MAPPINGS.map(mapping => ({
      key: mapping.key,
      name: mapping.name
    }));

    res.json({
      success: true,
      fields
    });
  } catch (error) {
    console.error('Error fetching available fields:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to fetch available fields',
      message: error.message
    });
  }
});

// í•„ë“œë³„ ê³ ìœ ê°’ ì¡°íšŒ API
app.get('/api/inspection/field-values', async (req, res) => {
  try {
    const { field } = req.query;

    if (!field) {
      return res.status(400).json({
        success: false,
        error: 'Field name is required'
      });
    }

    // í•„ë“œëª…ì— ë”°ë¥¸ ì»¬ëŸ¼ ì¸ë±ìŠ¤ ë§¤í•‘
    const fieldMapping = COLUMN_MAPPINGS.find(mapping => mapping.name === field);
    if (!fieldMapping) {
      return res.status(400).json({
        success: false,
        error: 'Invalid field name'
      });
    }

    const columnIndex = fieldMapping.manual;

    // ìˆ˜ê¸°ì´ˆì™€ í°í´ê°œí†µë°ì´í„°ì—ì„œ í•´ë‹¹ í•„ë“œì˜ ëª¨ë“  ê°’ ìˆ˜ì§‘
    const [manualValues, systemValues] = await Promise.all([
      getSheetValues(MANUAL_DATA_SHEET_NAME),
      getSheetValues(CURRENT_MONTH_ACTIVATION_SHEET_NAME)
    ]);

    const allValues = new Set();

    // ìˆ˜ê¸°ì´ˆì—ì„œ ê°’ ìˆ˜ì§‘
    if (manualValues && manualValues.length > 1) {
      manualValues.slice(1).forEach(row => {
        if (row.length > columnIndex && row[columnIndex]) {
          allValues.add(row[columnIndex].toString().trim());
        }
      });
    }

    // í°í´ê°œí†µë°ì´í„°ì—ì„œ ê°’ ìˆ˜ì§‘
    if (systemValues && systemValues.length > 1) {
      systemValues.slice(1).forEach(row => {
        if (row.length > columnIndex && row[columnIndex]) {
          allValues.add(row[columnIndex].toString().trim());
        }
      });
    }

    // ì •ê·œí™” ì´ë ¥ì—ì„œë„ ê°’ ìˆ˜ì§‘
    try {
      const normalizationResponse = await sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: `${NORMALIZATION_HISTORY_SHEET_NAME}!A:G`
      });

      if (normalizationResponse.data.values && normalizationResponse.data.values.length > 1) {
        normalizationResponse.data.values.slice(1).forEach(row => {
          if (row.length >= 6 && row[3] === field && row[5]) { // í•„ë“œëª…ì´ ì¼ì¹˜í•˜ê³  ì •ê·œí™”ê°’ì´ ìˆëŠ” ê²½ìš°
            allValues.add(row[5].toString().trim());
          }
        });
      }
    } catch (error) {
      // ì •ê·œí™” ì´ë ¥ ì‹œíŠ¸ê°€ ì—†ê±°ë‚˜ ë¹„ì–´ìˆëŠ” ê²½ìš° ë¬´ì‹œ
      console.log('ì •ê·œí™” ì´ë ¥ ì‹œíŠ¸ê°€ ì—†ê±°ë‚˜ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
    }

    const uniqueValues = Array.from(allValues).filter(value => value).sort();

    res.json({
      success: true,
      field,
      values: uniqueValues
    });
  } catch (error) {
    console.error('Error fetching field values:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to fetch field values',
      message: error.message
    });
  }
});

// ê²€ìˆ˜ ì™„ë£Œ ìƒíƒœ ì¡°íšŒ
app.get('/api/inspection/completion-status', async (req, res) => {
  try {
    const { userId } = req.query;

    if (!userId) {
      return res.status(400).json({
        success: false,
        error: 'User ID is required'
      });
    }

    // ê²€ìˆ˜ê²°ê³¼ ì‹œíŠ¸ì—ì„œ í•´ë‹¹ ì‚¬ìš©ìì˜ ì™„ë£Œ í•­ëª© ì¡°íšŒ
    let completionData = [];
    try {
      const response = await sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: `${INSPECTION_RESULT_SHEET_NAME}!A:E`
      });
      completionData = response.data.values || [];
    } catch (error) {
      // ì‹œíŠ¸ê°€ ì—†ê±°ë‚˜ ë¹„ì–´ìˆëŠ” ê²½ìš° ë¹ˆ ë°°ì—´ ë°˜í™˜
      console.log('ê²€ìˆ˜ê²°ê³¼ ì‹œíŠ¸ê°€ ì—†ê±°ë‚˜ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
    }

    // í—¤ë” ì œê±°í•˜ê³  í•´ë‹¹ ì‚¬ìš©ìì˜ ì™„ë£Œ í•­ëª©ë§Œ í•„í„°ë§
    const userCompletions = completionData
      .slice(1) // í—¤ë” ì œê±°
      .filter(row => row.length >= 3 && row[1] === userId) // ì²˜ë¦¬ì IDê°€ ì¼ì¹˜í•˜ëŠ” í•­ëª©
      .map(row => row[2]); // í•­ëª© IDë§Œ ì¶”ì¶œ

    res.json({
      success: true,
      completedItems: userCompletions
    });
  } catch (error) {
    console.error('Error fetching completion status:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to fetch completion status',
      message: error.message
    });
  }
});

// ê°œì¸ì •ë³´ ë³´ì•ˆ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
const securityUtils = {
  // ê°œì¸ì •ë³´ ë§ˆìŠ¤í‚¹ í•¨ìˆ˜
  maskPersonalInfo: (value, type = 'default') => {
    if (!value || typeof value !== 'string') return value;

    const trimmed = value.toString().trim();
    if (!trimmed) return value;

    switch (type) {
      case 'name':
        // ì´ë¦„: ì²« ê¸€ìë§Œ ë³´ì´ê³  ë‚˜ë¨¸ì§€ëŠ” *
        return trimmed.length > 1 ? trimmed[0] + '*'.repeat(trimmed.length - 1) : '*';

      case 'phone':
        // ì „í™”ë²ˆí˜¸: ì• 3ìë¦¬ì™€ ë’¤ 4ìë¦¬ë§Œ ë³´ì´ê³  ì¤‘ê°„ì€ *
        if (trimmed.length >= 7) {
          return trimmed.substring(0, 3) + '*'.repeat(trimmed.length - 7) + trimmed.substring(trimmed.length - 4);
        }
        return '*'.repeat(trimmed.length);

      case 'address':
        // ì£¼ì†Œ: ì‹œ/ë„ê¹Œì§€ë§Œ ë³´ì´ê³  ë‚˜ë¨¸ì§€ëŠ” *
        const addressParts = trimmed.split(' ');
        if (addressParts.length > 1) {
          return addressParts[0] + ' ' + '*'.repeat(trimmed.length - addressParts[0].length - 1);
        }
        return '*'.repeat(trimmed.length);

      case 'birthdate':
        // ìƒë…„ì›”ì¼: ë…„ë„ë§Œ ë³´ì´ê³  ì›”ì¼ì€ *
        if (trimmed.length >= 4) {
          return trimmed.substring(0, 4) + '*'.repeat(trimmed.length - 4);
        }
        return '*'.repeat(trimmed.length);

      default:
        // ê¸°ë³¸: ì „ì²´ë¥¼ *ë¡œ ë§ˆìŠ¤í‚¹
        return '*'.repeat(trimmed.length);
    }
  },

  // ê°œì¸ì •ë³´ í•´ì‹œ í•¨ìˆ˜ (ê°„ë‹¨í•œ í•´ì‹œ)
  hashPersonalInfo: (value) => {
    if (!value || typeof value !== 'string') return '';
    const trimmed = value.toString().trim();
    if (!trimmed) return '';

    // ê°„ë‹¨í•œ í•´ì‹œ í•¨ìˆ˜ (ì‹¤ì œ ìš´ì˜ì—ì„œëŠ” ë” ê°•ë ¥í•œ í•´ì‹œ ì‚¬ìš© ê¶Œì¥)
    let hash = 0;
    for (let i = 0; i < trimmed.length; i++) {
      const char = trimmed.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash = hash & hash; // 32bit ì •ìˆ˜ë¡œ ë³€í™˜
    }
    return Math.abs(hash).toString(36);
  },

  // ì•ˆì „í•œ ë°ì´í„° êµ¬ì¡° ìƒì„± (ê²€ìˆ˜ìëŠ” ì‹¤ì œ ê°’ ë³¼ ìˆ˜ ìˆìŒ)
  createSafeDataStructure: (differences) => {
    return differences.map(diff => {
      const safeDiff = {
        id: securityUtils.hashPersonalInfo(diff.key), // ê°œì¸ì •ë³´ í•´ì‹œí™”
        type: diff.type,
        field: diff.field,
        fieldKey: diff.fieldKey,
        manualRow: diff.manualRow,
        systemRow: diff.systemRow,
        assignedAgent: diff.assignedAgent,
        // ê²€ìˆ˜ìëŠ” ì‹¤ì œ ê°’ì„ ë³¼ ìˆ˜ ìˆë„ë¡ ì›ë³¸ ê°’ ì „ì†¡
        correctValue: diff.correctValue,
        incorrectValue: diff.incorrectValue,
        // ê°€ì…ë²ˆí˜¸ëŠ” í™”ë©´ì— í‘œì‹œë˜ì–´ì•¼ í•˜ë¯€ë¡œ ì›ë³¸ ê°’ ìœ ì§€
        originalKey: diff.key,
        // ì¤‘ë³µ ê´€ë ¨ ì •ë³´ ì¶”ê°€
        isDuplicate: diff.isDuplicate || false,
        duplicateType: diff.duplicateType || 'no_duplicate',
        duplicateInfo: diff.duplicateInfo || ''
      };

      return safeDiff;
    });
  }
};

// í•„ë“œ íƒ€ì… íŒë³„ í•¨ìˆ˜
function getFieldType(fieldKey) {
  const fieldTypeMap = {
    'name': 'name',
    'phone': 'phone',
    'address': 'address',
    'birthdate': 'birthdate',
    'gender': 'default',
    'type': 'default',
    'model': 'default',
    'plan': 'default',
    'store': 'default'
  };
  return fieldTypeMap[fieldKey] || 'default';
}

// ê°œì¸ì •ë³´ í¬í•¨ ìºì‹œ TTL ë‹¨ì¶• (ë³´ì•ˆ ê°•í™”)
const SECURE_CACHE_TTL = 10 * 60 * 1000; // 10ë¶„ (ê²€ìˆ˜ ë°ì´í„°ëŠ” ìì£¼ ë³€ê²½ë˜ì§€ ì•ŠìŒ)

// ê²€ìˆ˜ ì™„ë£Œ ìƒíƒœ ì—…ë°ì´íŠ¸
app.post('/api/inspection/complete', async (req, res) => {
  try {
    const { itemId, userId, status } = req.body;

    if (!itemId || !userId) {
      return res.status(400).json({
        success: false,
        error: 'Item ID and User ID are required'
      });
    }

    // ê²€ìˆ˜ê²°ê³¼ ì‹œíŠ¸ì— ì™„ë£Œ ìƒíƒœ ê¸°ë¡
    const completionData = [
      [
        new Date().toISOString(), // ì™„ë£Œì¼ì‹œ
        userId,                   // ì²˜ë¦¬ì
        itemId,                   // í•­ëª© ID
        status || 'ì™„ë£Œ',         // ìƒíƒœ
        'ì²˜ë¦¬ì™„ë£Œ'                // ë¹„ê³ 
      ]
    ];

    await sheets.spreadsheets.values.append({
      spreadsheetId: SPREADSHEET_ID,
      range: `${INSPECTION_RESULT_SHEET_NAME}!A:E`,
      valueInputOption: 'USER_ENTERED',
      resource: {
        values: completionData
      }
    });

    // ìºì‹œ ë¬´íš¨í™”
    invalidateInspectionCache(userId);

    res.json({
      success: true,
      message: 'ê²€ìˆ˜ ì™„ë£Œ ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.'
    });
  } catch (error) {
    console.error('Error updating inspection completion:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to update inspection completion',
      message: error.message
    });
  }
});

// ì •ê·œí™” ë°ì´í„° ì €ì¥
app.post('/api/inspection/normalize', async (req, res) => {
  try {
    const { itemId, userId, originalValue, normalizedValue, field } = req.body;

    if (!itemId || !userId || !normalizedValue) {
      return res.status(400).json({
        success: false,
        error: 'Item ID, User ID, and normalized value are required'
      });
    }

    // ì •ê·œí™”ì´ë ¥ ì‹œíŠ¸ì— ê¸°ë¡
    const normalizationData = [
      [
        new Date().toISOString(), // ì •ê·œí™”ì¼ì‹œ
        userId,                   // ì²˜ë¦¬ì
        itemId,                   // í•­ëª© ID
        field,                    // í•„ë“œëª…
        originalValue || '',      // ì›ë³¸ê°’
        normalizedValue,          // ì •ê·œí™”ê°’
        'ìˆ˜ë™ì •ê·œí™”'              // ë¹„ê³ 
      ]
    ];

    await sheets.spreadsheets.values.append({
      spreadsheetId: SPREADSHEET_ID,
      range: `${NORMALIZATION_HISTORY_SHEET_NAME}!A:G`,
      valueInputOption: 'USER_ENTERED',
      resource: {
        values: normalizationData
      }
    });

    // ìºì‹œ ë¬´íš¨í™”
    invalidateInspectionCache(userId);

    res.json({
      success: true,
      message: 'ì •ê·œí™” ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'
    });
  } catch (error) {
    console.error('Error saving normalization data:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to save normalization data',
      message: error.message
    });
  }
});

// í°í´ê°œí†µë°ì´í„° ìˆ˜ì • API
app.post('/api/inspection/update-system-data', async (req, res) => {
  try {
    const { itemId, userId, field, correctValue, systemRow } = req.body;

    if (!itemId || !userId || !field || !correctValue || systemRow === null) {
      return res.status(400).json({
        success: false,
        error: 'Item ID, User ID, field, correct value, and system row are required'
      });
    }

    // í•„ë“œëª…ì— ë”°ë¥¸ ì»¬ëŸ¼ ì¸ë±ìŠ¤ ë§¤í•‘
    const fieldToColumnMap = {
      'ì´ë¦„': 1,      // Bì—´
      'ì „í™”ë²ˆí˜¸': 2,   // Cì—´
      'ì£¼ì†Œ': 3,      // Dì—´
      'ìƒë…„ì›”ì¼': 4,  // Eì—´
      'ì„±ë³„': 5,      // Fì—´
      // ë” ë§ì€ í•„ë“œ ë§¤í•‘ ì¶”ê°€ ê°€ëŠ¥
    };

    const columnIndex = fieldToColumnMap[field];
    if (columnIndex === undefined) {
      return res.status(400).json({
        success: false,
        error: 'Invalid field name'
      });
    }

    // í°í´ê°œí†µë°ì´í„° ì‹œíŠ¸ì—ì„œ í•´ë‹¹ í–‰ì˜ íŠ¹ì • ì»¬ëŸ¼ ìˆ˜ì •
    const range = `${CURRENT_MONTH_ACTIVATION_SHEET_NAME}!${String.fromCharCode(65 + columnIndex)}${systemRow}`;

    await sheets.spreadsheets.values.update({
      spreadsheetId: SPREADSHEET_ID,
      range: range,
      valueInputOption: 'USER_ENTERED',
      resource: {
        values: [[correctValue]]
      }
    });

    // ìˆ˜ì • ì´ë ¥ ì‹œíŠ¸ì— ê¸°ë¡
    const updateHistoryData = [
      [
        new Date().toISOString(), // ìˆ˜ì •ì¼ì‹œ
        userId,                   // ì²˜ë¦¬ì
        itemId,                   // í•­ëª© ID
        field,                    // í•„ë“œëª…
        correctValue,             // ìˆ˜ì •ëœ ê°’
        'í°í´ê°œí†µë°ì´í„° ìˆ˜ì •'     // ë¹„ê³ 
      ]
    ];

    await sheets.spreadsheets.values.append({
      spreadsheetId: SPREADSHEET_ID,
      range: `${INSPECTION_RESULT_SHEET_NAME}!A:F`,
      valueInputOption: 'USER_ENTERED',
      resource: {
        values: updateHistoryData
      }
    });

    // ìºì‹œ ë¬´íš¨í™”
    invalidateInspectionCache(userId);

    res.json({
      success: true,
      message: 'í°í´ê°œí†µë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.'
    });
  } catch (error) {
    console.error('Error updating system data:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to update system data',
      message: error.message
    });
  }
});

// ì‚¬ìš© ê°€ëŠ¥í•œ í•„ë“œ ëª©ë¡ ì¡°íšŒ API
app.get('/api/inspection/available-fields', async (req, res) => {
  try {
    const fields = COLUMN_MAPPINGS.map(mapping => ({
      key: mapping.key,
      name: mapping.name
    }));

    res.json({
      success: true,
      fields
    });
  } catch (error) {
    console.error('Error fetching available fields:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to fetch available fields',
      message: error.message
    });
  }
});

// í•„ë“œë³„ ê³ ìœ ê°’ ì¡°íšŒ API
app.get('/api/inspection/field-values', async (req, res) => {
  try {
    const { field } = req.query;

    if (!field) {
      return res.status(400).json({
        success: false,
        error: 'Field name is required'
      });
    }

    // í•„ë“œëª…ì— ë”°ë¥¸ ì»¬ëŸ¼ ì¸ë±ìŠ¤ ë§¤í•‘
    const fieldMapping = COLUMN_MAPPINGS.find(mapping => mapping.name === field);
    if (!fieldMapping) {
      return res.status(400).json({
        success: false,
        error: 'Invalid field name'
      });
    }

    const columnIndex = fieldMapping.manual;

    // ìˆ˜ê¸°ì´ˆì™€ í°í´ê°œí†µë°ì´í„°ì—ì„œ í•´ë‹¹ í•„ë“œì˜ ëª¨ë“  ê°’ ìˆ˜ì§‘
    const [manualValues, systemValues] = await Promise.all([
      getSheetValues(MANUAL_DATA_SHEET_NAME),
      getSheetValues(CURRENT_MONTH_ACTIVATION_SHEET_NAME)
    ]);

    const allValues = new Set();

    // ìˆ˜ê¸°ì´ˆì—ì„œ ê°’ ìˆ˜ì§‘
    if (manualValues && manualValues.length > 1) {
      manualValues.slice(1).forEach(row => {
        if (row.length > columnIndex && row[columnIndex]) {
          allValues.add(row[columnIndex].toString().trim());
        }
      });
    }

    // í°í´ê°œí†µë°ì´í„°ì—ì„œ ê°’ ìˆ˜ì§‘
    if (systemValues && systemValues.length > 1) {
      systemValues.slice(1).forEach(row => {
        if (row.length > columnIndex && row[columnIndex]) {
          allValues.add(row[columnIndex].toString().trim());
        }
      });
    }

    // ì •ê·œí™” ì´ë ¥ì—ì„œë„ ê°’ ìˆ˜ì§‘
    try {
      const normalizationResponse = await sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: `${NORMALIZATION_HISTORY_SHEET_NAME}!A:G`
      });

      if (normalizationResponse.data.values && normalizationResponse.data.values.length > 1) {
        normalizationResponse.data.values.slice(1).forEach(row => {
          if (row.length >= 6 && row[3] === field && row[5]) { // í•„ë“œëª…ì´ ì¼ì¹˜í•˜ê³  ì •ê·œí™”ê°’ì´ ìˆëŠ” ê²½ìš°
            allValues.add(row[5].toString().trim());
          }
        });
      }
    } catch (error) {
      // ì •ê·œí™” ì´ë ¥ ì‹œíŠ¸ê°€ ì—†ê±°ë‚˜ ë¹„ì–´ìˆëŠ” ê²½ìš° ë¬´ì‹œ
      console.log('ì •ê·œí™” ì´ë ¥ ì‹œíŠ¸ê°€ ì—†ê±°ë‚˜ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
    }

    const uniqueValues = Array.from(allValues).filter(value => value).sort();

    res.json({
      success: true,
      field,
      values: uniqueValues
    });
  } catch (error) {
    console.error('Error fetching field values:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to fetch field values',
      message: error.message
    });
  }
});

// ê²€ìˆ˜ ì™„ë£Œ ìƒíƒœ ì¡°íšŒ
app.get('/api/inspection/completion-status', async (req, res) => {
  try {
    const { userId } = req.query;

    if (!userId) {
      return res.status(400).json({
        success: false,
        error: 'User ID is required'
      });
    }

    // ê²€ìˆ˜ê²°ê³¼ ì‹œíŠ¸ì—ì„œ í•´ë‹¹ ì‚¬ìš©ìì˜ ì™„ë£Œ í•­ëª© ì¡°íšŒ
    let completionData = [];
    try {
      const response = await sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: `${INSPECTION_RESULT_SHEET_NAME}!A:E`
      });
      completionData = response.data.values || [];
    } catch (error) {
      // ì‹œíŠ¸ê°€ ì—†ê±°ë‚˜ ë¹„ì–´ìˆëŠ” ê²½ìš° ë¹ˆ ë°°ì—´ ë°˜í™˜
      console.log('ê²€ìˆ˜ê²°ê³¼ ì‹œíŠ¸ê°€ ì—†ê±°ë‚˜ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
    }

    // í—¤ë” ì œê±°í•˜ê³  í•´ë‹¹ ì‚¬ìš©ìì˜ ì™„ë£Œ í•­ëª©ë§Œ í•„í„°ë§
    const userCompletions = completionData
      .slice(1) // í—¤ë” ì œê±°
      .filter(row => row.length >= 3 && row[1] === userId) // ì²˜ë¦¬ì IDê°€ ì¼ì¹˜í•˜ëŠ” í•­ëª©
      .map(row => row[2]); // í•­ëª© IDë§Œ ì¶”ì¶œ

    res.json({
      success: true,
      completedItems: userCompletions
    });
  } catch (error) {
    console.error('Error fetching completion status:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to fetch completion status',
      message: error.message
    });
  }
});

// ì„œë²„ ì‹œì‘ ì½”ë“œëŠ” 1866ë²ˆì§¸ ì¤„ì— ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.
// ì¤‘ë³µëœ ì„œë²„ ì‹œì‘ ì½”ë“œ ì œê±° 

// ì‚¬ì „ì˜ˆì•½ ì„¤ì • ê´€ë ¨ API

// ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ëª¨ë¸/ìš©ëŸ‰/ìƒ‰ìƒ ë°ì´í„° API
app.get('/api/reservation-settings/model-data', async (req, res) => {
  try {
    // ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ëª¨ë¸/ìš©ëŸ‰/ìƒ‰ìƒ ë°ì´í„° ìš”ì²­

    // ìºì‹œ í‚¤ ìƒì„±
    const cacheKey = 'reservation_site_model_data';

    // ìºì‹œì—ì„œ ë¨¼ì € í™•ì¸ (10ë¶„ TTL)
    const cachedData = cacheUtils.get(cacheKey);
    if (cachedData) {
      // ìºì‹œëœ ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ëª¨ë¸ ë°ì´í„° ë°˜í™˜
      return res.json(cachedData);
    }

    // ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ì‹œíŠ¸ì—ì„œ P, Q, Rì—´ ë°ì´í„° ë¡œë“œ
    const reservationResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: 'ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸!P:R'
    });

    if (!reservationResponse.data.values || reservationResponse.data.values.length < 2) {
      throw new Error('ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    const rows = reservationResponse.data.values.slice(1); // í—¤ë” ì œê±°
    const models = new Set();
    const capacities = new Set();
    const colors = new Set();
    const modelCapacityColors = new Map();

    // ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ë°ì´í„° ì²˜ë¦¬

    rows.forEach((row, index) => {
      if (row.length < 3) return;

      const model = (row[0] || '').toString().trim(); // Pì—´: ëª¨ë¸
      const capacity = (row[1] || '').toString().trim(); // Qì—´: ìš©ëŸ‰
      const color = (row[2] || '').toString().trim(); // Rì—´: ìƒ‰ìƒ

      // ì²˜ìŒ 10ê°œ í–‰ì˜ ë°ì´í„° í™•ì¸
      if (index < 10) {
        console.log(`í–‰ ${index + 1}: ëª¨ë¸="${model}", ìš©ëŸ‰="${capacity}", ìƒ‰ìƒ="${color}"`);
      }

      if (model && capacity && color) {
        models.add(model);
        capacities.add(capacity);
        colors.add(color);

        // ëª¨ë¸ë³„ ìš©ëŸ‰-ìƒ‰ìƒ ì¡°í•© ì €ì¥
        if (!modelCapacityColors.has(model)) {
          modelCapacityColors.set(model, new Map());
        }

        if (!modelCapacityColors.get(model).has(capacity)) {
          modelCapacityColors.get(model).set(capacity, new Set());
        }

        modelCapacityColors.get(model).get(capacity).add(color);
      }
    });

    // Map ê°ì²´ë¥¼ ì¼ë°˜ ê°ì²´ë¡œ ë³€í™˜í•˜ì—¬ JSON ì§ë ¬í™” ê°€ëŠ¥í•˜ê²Œ ë§Œë“¤ê¸°
    const modelCapacityColorsObj = {};
    Array.from(modelCapacityColors.entries()).forEach(([model, capacityMap]) => {
      modelCapacityColorsObj[model] = {};
      Array.from(capacityMap.entries()).forEach(([capacity, colorSet]) => {
        modelCapacityColorsObj[model][capacity] = Array.from(colorSet).sort();
      });
    });

    const result = {
      success: true,
      models: Array.from(models).sort(),
      capacities: Array.from(capacities).sort(),
      colors: Array.from(colors).sort(),
      modelCapacityColors: modelCapacityColorsObj,
      stats: {
        totalModels: models.size,
        totalCapacities: capacities.size,
        totalColors: colors.size,
        totalCombinations: Array.from(modelCapacityColors.values()).reduce((sum, capacityMap) => {
          return sum + Array.from(capacityMap.values()).reduce((sum2, colorSet) => sum2 + colorSet.size, 0);
        }, 0)
      }
    };

    // ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ëª¨ë¸ ë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ

    // ê²°ê³¼ ìºì‹± (10ë¶„ TTL)
    cacheUtils.set(cacheKey, result, 600);

    res.json(result);

  } catch (error) {
    console.error('ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ëª¨ë¸ ë°ì´í„° ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to load reservation site model data',
      message: error.message
    });
  }
});

// ì‚¬ì „ì˜ˆì•½ ì„¤ì • ë°ì´í„° ë¡œë“œ API
app.get('/api/reservation-settings/data', async (req, res) => {
  try {
    // ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ì‹œíŠ¸ì—ì„œ P, Q, Rì—´ ë°ì´í„° ë¡œë“œ
    let reservationSiteData = { pColumn: [], qColumn: [], rColumn: [] };
    try {
      const reservationResponse = await sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸!P:R'
      });

      if (reservationResponse.data.values && reservationResponse.data.values.length > 1) {
        const rows = reservationResponse.data.values.slice(1); // í—¤ë” ì œê±°
        const pValues = new Set();
        const qValues = new Set();
        const rValues = new Set();

        rows.forEach(row => {
          if (row.length > 0 && row[0]) pValues.add(row[0].toString().trim());
          if (row.length > 1 && row[1]) qValues.add(row[1].toString().trim());
          if (row.length > 2 && row[2]) rValues.add(row[2].toString().trim());
        });

        reservationSiteData = {
          pColumn: Array.from(pValues).filter(v => v).sort(),
          qColumn: Array.from(qValues).filter(v => v).sort(),
          rColumn: Array.from(rValues).filter(v => v).sort()
        };
      }
    } catch (error) {
      // ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ì‹œíŠ¸ ë¡œë“œ ì‹¤íŒ¨
    }

    // í°í´ì¬ê³ ë°ì´í„° ì‹œíŠ¸ì—ì„œ F, Gì—´ ë°ì´í„° ë¡œë“œ
    let phoneklData = { fColumn: [], gColumn: [] };
    try {
      const phoneklResponse = await sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: 'í°í´ì¬ê³ ë°ì´í„°!F:G'
      });

      if (phoneklResponse.data.values && phoneklResponse.data.values.length > 1) {
        const rows = phoneklResponse.data.values.slice(1); // í—¤ë” ì œê±°
        const fValues = new Set();
        const gValues = new Set();

        rows.forEach(row => {
          if (row.length > 0 && row[0]) fValues.add(row[0].toString().trim());
          if (row.length > 1 && row[1]) gValues.add(row[1].toString().trim());
        });

        phoneklData = {
          fColumn: Array.from(fValues).filter(v => v).sort(),
          gColumn: Array.from(gValues).filter(v => v).sort()
        };
      }
    } catch (error) {
      console.log('í°í´ì¬ê³ ë°ì´í„° ì‹œíŠ¸ ë¡œë“œ ì‹¤íŒ¨:', error.message);
    }

    res.json({
      success: true,
      reservationSite: reservationSiteData,
      phonekl: phoneklData
    });
  } catch (error) {
    console.error('ì‚¬ì „ì˜ˆì•½ ì„¤ì • ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to load reservation settings data',
      message: error.message
    });
  }
});

// ë°°ì • ìƒíƒœ ë©”ëª¨ë¦¬ ì €ì¥ì†Œ (ì„œë²„ ì¬ì‹œì‘ ì‹œ ì´ˆê¸°í™”ë¨)
const assignmentMemory = new Map(); // key: reservationNumber, value: { serialNumber, timestamp }

// ë°°ì • ìƒíƒœ ì €ì¥ API
app.post('/api/reservation/save-assignment-memory', async (req, res) => {
  try {
    const { assignments } = req.body;

    if (!Array.isArray(assignments)) {
      throw new Error('ë°°ì • ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    }

    // ë©”ëª¨ë¦¬ì— ë°°ì • ìƒíƒœ ì €ì¥
    assignments.forEach(assignment => {
      if (assignment.reservationNumber && assignment.assignedSerialNumber) {
        assignmentMemory.set(assignment.reservationNumber, {
          serialNumber: assignment.assignedSerialNumber,
          timestamp: Date.now()
        });
      }
    });

    console.log(`ğŸ’¾ [ë°°ì •ë©”ëª¨ë¦¬] ${assignments.length}ê°œ ë°°ì • ìƒíƒœ ì €ì¥ë¨`);

    res.json({
      success: true,
      message: `${assignments.length}ê°œ ë°°ì • ìƒíƒœê°€ ë©”ëª¨ë¦¬ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`,
      memorySize: assignmentMemory.size
    });

  } catch (error) {
    console.error('âŒ [ë°°ì •ë©”ëª¨ë¦¬] ì €ì¥ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: 'ë°°ì • ìƒíƒœ ì €ì¥ ì‹¤íŒ¨',
      message: error.message
    });
  }
});

// ë°°ì • ìƒíƒœ ì¡°íšŒ API
app.get('/api/reservation/assignment-memory', async (req, res) => {
  try {
    const memoryData = Array.from(assignmentMemory.entries()).map(([reservationNumber, data]) => ({
      reservationNumber,
      serialNumber: data.serialNumber,
      timestamp: data.timestamp
    }));

    res.json({
      success: true,
      memorySize: assignmentMemory.size,
      data: memoryData
    });

  } catch (error) {
    console.error('âŒ [ë°°ì •ë©”ëª¨ë¦¬] ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: 'ë°°ì • ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨',
      message: error.message
    });
  }
});

// ë°°ì • ìƒíƒœ ë³€ê²½ ê°ì§€ API OPTIONS ìš”ì²­ ì²˜ë¦¬
app.options('/api/reservation/assignment-changes', (req, res) => {
  const allowedOrigins = [
    'https://vipmobile.vercel.app',
    'https://vipmobile.vercel.app/',
    'http://localhost:3000'
  ];

  const origin = req.headers.origin;
  if (origin && allowedOrigins.includes(origin)) {
    res.header('Access-Control-Allow-Origin', origin);
  } else {
    res.header('Access-Control-Allow-Origin', '*');
  }

  res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
  res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With, Origin, Accept');
  res.header('Access-Control-Allow-Credentials', 'true');
  res.status(200).end();
});

// ë°°ì • ìƒíƒœ ë³€ê²½ ê°ì§€ API (ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ìš© - ìµœì í™”)
app.get('/api/reservation/assignment-changes', async (req, res) => {
  // CORS í—¤ë” ì„¤ì •
  const allowedOrigins = [
    'https://vipmobile.vercel.app',
    'https://vipmobile.vercel.app/',
    'http://localhost:3000'
  ];

  const origin = req.headers.origin;
  if (origin && allowedOrigins.includes(origin)) {
    res.header('Access-Control-Allow-Origin', origin);
  } else {
    res.header('Access-Control-Allow-Origin', '*');
  }

  res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
  res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With, Origin, Accept');
  res.header('Access-Control-Allow-Credentials', 'true');

  try {
    const { lastCheck } = req.query;
    const lastCheckTime = lastCheck ? new Date(parseInt(lastCheck)) : new Date(0);

    console.log(`ğŸ” [ì‹¤ì‹œê°„ê°ì§€] ë°°ì • ìƒíƒœ ë³€ê²½ í™•ì¸: ${lastCheckTime.toISOString()}`);

    // ìºì‹œ í‚¤ ìƒì„±
    const cacheKey = 'assignment_changes_check';

    // ìºì‹œì—ì„œ ë¨¼ì € í™•ì¸ (2ë¶„ TTL)
    const cachedData = cacheUtils.get(cacheKey);
    if (cachedData && cachedData.lastCheckTime > lastCheckTime.getTime()) {
      console.log('ğŸ“‹ [ì‹¤ì‹œê°„ê°ì§€] ìºì‹œëœ ê²°ê³¼ ë°˜í™˜');
      return res.json(cachedData);
    }

    // ë°°ì • ìƒíƒœ ê³„ì‚° API í˜¸ì¶œ
    const assignmentResponse = await fetch(`${process.env.REACT_APP_API_URL || 'http://localhost:4000'}/api/inventory/assignment-status`);

    if (!assignmentResponse.ok) {
      throw new Error('ë°°ì • ìƒíƒœë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    const assignmentResult = await assignmentResponse.json();

    if (!assignmentResult.success) {
      throw new Error('ë°°ì • ìƒíƒœ ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    }

    // ì‹¤ì œ ë³€ê²½ì‚¬í•­ë§Œ í•„í„°ë§ (ë°°ì •ì™„ë£Œëœ í•­ëª© ì¤‘ì—ì„œ ìµœê·¼ì— ë³€ê²½ëœ ê²ƒë§Œ)
    const currentTime = Date.now();

    // Google Sheetsì˜ ìˆ˜ì • ì‹œê°„ì„ í™•ì¸í•˜ì—¬ ì‹¤ì œ ë³€ê²½ì‚¬í•­ë§Œ ê°ì§€
    try {
      const sheets = google.sheets({ version: 'v4', auth });
      const spreadsheetId = process.env.GOOGLE_SHEET_ID || process.env.SHEET_ID;

      if (spreadsheetId) {
        const metadataResponse = await sheets.spreadsheets.get({
          spreadsheetId,
          ranges: ['ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸!G:G'], // ë°°ì •ì¼ë ¨ë²ˆí˜¸ ì—´ë§Œ í™•ì¸
          fields: 'sheets.properties.sheetId,sheets.properties.title,sheets.properties.updated'
        });

        const sheetUpdated = metadataResponse.data.sheets?.[0]?.properties?.updated;
        if (sheetUpdated) {
          const sheetUpdateTime = new Date(sheetUpdated).getTime();

          // ì‹œíŠ¸ê°€ ë§ˆì§€ë§‰ ì²´í¬ ì‹œê°„ ì´í›„ì— ì—…ë°ì´íŠ¸ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ë³€ê²½ì‚¬í•­ ì—†ìŒ
          if (sheetUpdateTime <= lastCheckTime.getTime()) {
            console.log('ğŸ“‹ [ì‹¤ì‹œê°„ê°ì§€] ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì—†ìŒ - ë³€ê²½ì‚¬í•­ ì—†ìŒ');
            const responseData = {
              success: true,
              hasChanges: false,
              changeCount: 0,
              lastCheckTime: new Date().toISOString(),
              changes: []
            };
            cacheUtils.set(cacheKey, responseData, 2 * 60 * 1000);
            return res.json(responseData);
          }
        }
      }
    } catch (error) {
      console.log('âš ï¸ [ì‹¤ì‹œê°„ê°ì§€] ì‹œíŠ¸ ë©”íƒ€ë°ì´í„° í™•ì¸ ì‹¤íŒ¨, ê¸°ë³¸ ë¡œì§ ì‚¬ìš©:', error.message);
    }

    // ì‹œíŠ¸ ë©”íƒ€ë°ì´í„° í™•ì¸ì´ ì‹¤íŒ¨í•œ ê²½ìš° ê¸°ë³¸ ë¡œì§ ì‚¬ìš©
    const recentChanges = assignmentResult.data.filter(item => {
      // ë°°ì •ì™„ë£Œëœ í•­ëª©ë§Œ í™•ì¸
      return item.assignmentStatus === 'ë°°ì •ì™„ë£Œ' && item.assignedSerialNumber;
    });

    const hasChanges = recentChanges.length > 0;

    console.log(`ğŸ” [ì‹¤ì‹œê°„ê°ì§€] ë³€ê²½ì‚¬í•­ ë°œê²¬: ${hasChanges ? 'ìˆìŒ' : 'ì—†ìŒ'} (${recentChanges.length}ê°œ)`);

    const responseData = {
      success: true,
      hasChanges,
      changeCount: recentChanges.length,
      lastCheckTime: new Date().toISOString(),
      changes: hasChanges ? recentChanges.slice(0, 10) : [] // ìµœëŒ€ 10ê°œë§Œ ë°˜í™˜
    };

    // ê²°ê³¼ ìºì‹± (2ë¶„ TTL)
    cacheUtils.set(cacheKey, responseData, 2 * 60 * 1000);

    res.json(responseData);

  } catch (error) {
    console.error('âŒ [ì‹¤ì‹œê°„ê°ì§€] ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: 'ë°°ì • ìƒíƒœ ë³€ê²½ ê°ì§€ ì‹¤íŒ¨',
      message: error.message
    });
  }
});



// ì‚¬ì „ì˜ˆì•½ ì¬ê³  í˜„í™© API
app.get('/api/reservation-inventory-status', async (req, res) => {
  try {
    console.log('ğŸ” [ì‚¬ì „ì˜ˆì•½ì¬ê³ ] ì‚¬ì „ì˜ˆì•½ ì¬ê³  í˜„í™© ìš”ì²­');

    // í°í´ì¬ê³ ë°ì´í„°ì—ì„œ ì¬ê³  ì •ë³´ ìˆ˜ì§‘
    const inventoryValues = await getSheetValues('í°í´ì¬ê³ ë°ì´í„°');

    if (!inventoryValues || inventoryValues.length < 4) {
      throw new Error('í°í´ì¬ê³ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    console.log(`ğŸ“Š [ì‚¬ì „ì˜ˆì•½ì¬ê³ ] í°í´ì¬ê³ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${inventoryValues.length}í–‰`);

    // ì‚¬ë¬´ì‹¤ë³„ ì¬ê³  ì¹´ìš´íŒ…
    const officeInventory = {
      'í‰íƒì‚¬ë¬´ì‹¤': {},
      'ì¸ì²œì‚¬ë¬´ì‹¤': {},
      'êµ°ì‚°ì‚¬ë¬´ì‹¤': {},
      'ì•ˆì‚°ì‚¬ë¬´ì‹¤': {}
    };

    let processedCount = 0;
    let totalCount = 0;

    // 3í–‰ í—¤ë”ë¥¼ ì œì™¸í•˜ê³  ë°ì´í„° ì²˜ë¦¬ (4í–‰ë¶€í„° ì‹œì‘)
    inventoryValues.slice(3).forEach((row, index) => {
      if (row.length >= 14) {
        totalCount++;
        const model = (row[5] || '').toString().trim(); // Fì—´: ëª¨ë¸ëª…
        const color = (row[6] || '').toString().trim(); // Gì—´: ìƒ‰ìƒ
        const status = (row[7] || '').toString().trim(); // Hì—´: ìƒíƒœ
        const storeName = (row[13] || '').toString().trim(); // Nì—´: ì¶œê³ ì²˜(ì‚¬ë¬´ì‹¤ëª…)

        // ì •ìƒ ìƒíƒœì´ê³  ëª¨ë¸, ìƒ‰ìƒ, ì‚¬ë¬´ì‹¤ëª…ì´ ìˆëŠ” ê²½ìš°ë§Œ ì²˜ë¦¬
        if (model && color && storeName && status === 'ì •ìƒ') {
          const combinedModel = `${model} | ${color}`;

          // ì‚¬ë¬´ì‹¤ëª… ì¶”ì¶œ
          let officeName = '';
          if (storeName.includes('í‰íƒì‚¬ë¬´ì‹¤')) {
            officeName = 'í‰íƒì‚¬ë¬´ì‹¤';
          } else if (storeName.includes('ì¸ì²œì‚¬ë¬´ì‹¤')) {
            officeName = 'ì¸ì²œì‚¬ë¬´ì‹¤';
          } else if (storeName.includes('êµ°ì‚°ì‚¬ë¬´ì‹¤')) {
            officeName = 'êµ°ì‚°ì‚¬ë¬´ì‹¤';
          } else if (storeName.includes('ì•ˆì‚°ì‚¬ë¬´ì‹¤')) {
            officeName = 'ì•ˆì‚°ì‚¬ë¬´ì‹¤';
          }

          if (officeName && officeInventory[officeName]) {
            if (!officeInventory[officeName][combinedModel]) {
              officeInventory[officeName][combinedModel] = 0;
            }
            officeInventory[officeName][combinedModel]++;
            processedCount++;
          }
        }
      }
    });

    console.log(`ğŸ“Š [ì‚¬ì „ì˜ˆì•½ì¬ê³ ] ì´ ë°ì´í„°: ${totalCount}ê°œ, ì²˜ë¦¬ëœ ì¬ê³ : ${processedCount}ê°œ`);

    // í†µê³„ ê³„ì‚°
    const stats = {
      totalInventory: 0,
      officeStats: {},
      processedCount,
      totalCount
    };

    Object.entries(officeInventory).forEach(([officeName, inventory]) => {
      const officeTotal = Object.values(inventory).reduce((sum, count) => sum + count, 0);
      const modelCount = Object.keys(inventory).length;

      stats.officeStats[officeName] = {
        totalInventory: officeTotal,
        modelCount: modelCount
      };

      stats.totalInventory += officeTotal;
    });

    const result = {
      success: true,
      officeInventory,
      stats,
      lastUpdated: new Date().toISOString()
    };

    console.log('âœ… [ì‚¬ì „ì˜ˆì•½ì¬ê³ ] ì²˜ë¦¬ ì™„ë£Œ:', stats);
    res.json(result);

  } catch (error) {
    console.error('âŒ [ì‚¬ì „ì˜ˆì•½ì¬ê³ ] ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: 'ì‚¬ì „ì˜ˆì•½ ì¬ê³  ì¡°íšŒ ì‹¤íŒ¨',
      message: error.message
    });
  }
});

// ë¯¸ë§¤ì¹­ ê³ ê° í™•ì¸ API
app.get('/api/unmatched-customers', async (req, res) => {
  try {
    console.log('ğŸ” [ë¯¸ë§¤ì¹­ê³ ê°] ë¯¸ë§¤ì¹­ ê³ ê° í™•ì¸ ìš”ì²­');

    // ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ë°ì´í„° ë¡œë“œ (ê¸°ì¤€ ë°ì´í„°)
    const reservationData = await getSheetValues('ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸');
    if (!reservationData || reservationData.length < 2) {
      throw new Error('ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    // ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ì˜ ê³ ìœ  ì‹ë³„ì ì¶”ì¶œ (ì˜ˆì•½ë²ˆí˜¸ ë˜ëŠ” ì „í™”ë²ˆí˜¸)
    const reservationIds = new Set();
    reservationData.slice(1).forEach(row => {
      if (row.length >= 3) {
        const reservationNumber = (row[2] || '').toString().trim(); // Cì—´: ì˜ˆì•½ë²ˆí˜¸
        const phoneNumber = (row[3] || '').toString().trim(); // Dì—´: ì „í™”ë²ˆí˜¸
        if (reservationNumber) reservationIds.add(reservationNumber);
        if (phoneNumber) reservationIds.add(phoneNumber);
      }
    });

    console.log(`ğŸ“‹ [ë¯¸ë§¤ì¹­ê³ ê°] ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ê¸°ì¤€ ID: ${reservationIds.size}ê°œ`);

    // ê° ì‹œíŠ¸ë³„ ë°ì´í„° ë¡œë“œ ë° ë¯¸ë§¤ì¹­ ì°¾ê¸°
    const unmatchedData = {
      yard: [],
      onSale: [],
      mobile: []
    };

    // 1. ë§ˆë‹¹ì ‘ìˆ˜ ë¯¸ë§¤ì¹­ í™•ì¸
    try {
      console.log('ğŸ”„ [ë¯¸ë§¤ì¹­ê³ ê°] ë§ˆë‹¹ì ‘ìˆ˜ ë°ì´í„° ë¡œë“œ ì¤‘...');
      const yardData = await getSheetValues('ë§ˆë‹¹ì ‘ìˆ˜');
      console.log(`ğŸ“‹ [ë¯¸ë§¤ì¹­ê³ ê°] ë§ˆë‹¹ì ‘ìˆ˜ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${yardData ? yardData.length : 0}í–‰`);

      if (yardData && yardData.length > 1) {
        yardData.slice(1).forEach(row => {
          if (row.length >= 3) {
            const customerName = (row[1] || '').toString().trim(); // Bì—´: ê³ ê°ëª…
            const phoneNumber = (row[2] || '').toString().trim(); // Cì—´: ì „í™”ë²ˆí˜¸
            const receptionDate = (row[3] || '').toString().trim(); // Dì—´: ì ‘ìˆ˜ì¼
            const model = (row[4] || '').toString().trim(); // Eì—´: ëª¨ë¸
            const memo = (row[5] || '').toString().trim(); // Fì—´: ë©”ëª¨

            // ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ì— ì—†ëŠ” ê³ ê°ë§Œ ì¶”ê°€
            if (customerName && phoneNumber && !reservationIds.has(phoneNumber)) {
              unmatchedData.yard.push({
                customerName,
                phoneNumber,
                receptionDate,
                model,
                memo
              });
            }
          }
        });
        console.log(`âœ… [ë¯¸ë§¤ì¹­ê³ ê°] ë§ˆë‹¹ì ‘ìˆ˜ ë¯¸ë§¤ì¹­: ${unmatchedData.yard.length}ê±´`);
      } else {
        console.log('âš ï¸ [ë¯¸ë§¤ì¹­ê³ ê°] ë§ˆë‹¹ì ‘ìˆ˜ ë°ì´í„°ê°€ ì—†ê±°ë‚˜ í—¤ë”ë§Œ ì¡´ì¬');
      }
    } catch (error) {
      console.error('âŒ [ë¯¸ë§¤ì¹­ê³ ê°] ë§ˆë‹¹ì ‘ìˆ˜ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
      // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ë‹¤ë¥¸ ì‹œíŠ¸ëŠ” ê³„ì† ì²˜ë¦¬
    }

    // 2. ì˜¨ì„¸ì¼ ë¯¸ë§¤ì¹­ í™•ì¸
    try {
      console.log('ğŸ”„ [ë¯¸ë§¤ì¹­ê³ ê°] ì˜¨ì„¸ì¼ ë°ì´í„° ë¡œë“œ ì¤‘...');
      const onSaleData = await getSheetValues('ì˜¨ì„¸ì¼');
      console.log(`ğŸ“‹ [ë¯¸ë§¤ì¹­ê³ ê°] ì˜¨ì„¸ì¼ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${onSaleData ? onSaleData.length : 0}í–‰`);

      if (onSaleData && onSaleData.length > 1) {
        onSaleData.slice(1).forEach(row => {
          if (row.length >= 3) {
            const customerName = (row[1] || '').toString().trim(); // Bì—´: ê³ ê°ëª…
            const phoneNumber = (row[2] || '').toString().trim(); // Cì—´: ì „í™”ë²ˆí˜¸
            const receptionDate = (row[3] || '').toString().trim(); // Dì—´: ì ‘ìˆ˜ì¼
            const model = (row[4] || '').toString().trim(); // Eì—´: ëª¨ë¸
            const memo = (row[5] || '').toString().trim(); // Fì—´: ë©”ëª¨

            // ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ì— ì—†ëŠ” ê³ ê°ë§Œ ì¶”ê°€
            if (customerName && phoneNumber && !reservationIds.has(phoneNumber)) {
              unmatchedData.onSale.push({
                customerName,
                phoneNumber,
                receptionDate,
                model,
                memo
              });
            }
          }
        });
        console.log(`âœ… [ë¯¸ë§¤ì¹­ê³ ê°] ì˜¨ì„¸ì¼ ë¯¸ë§¤ì¹­: ${unmatchedData.onSale.length}ê±´`);
      } else {
        console.log('âš ï¸ [ë¯¸ë§¤ì¹­ê³ ê°] ì˜¨ì„¸ì¼ ë°ì´í„°ê°€ ì—†ê±°ë‚˜ í—¤ë”ë§Œ ì¡´ì¬');
      }
    } catch (error) {
      console.error('âŒ [ë¯¸ë§¤ì¹­ê³ ê°] ì˜¨ì„¸ì¼ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
      // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ë‹¤ë¥¸ ì‹œíŠ¸ëŠ” ê³„ì† ì²˜ë¦¬
    }

    // 3. ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ ë¯¸ë§¤ì¹­ í™•ì¸
    try {
      console.log('ğŸ”„ [ë¯¸ë§¤ì¹­ê³ ê°] ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ ë°ì´í„° ë¡œë“œ ì¤‘...');
      const mobileData = await getSheetValues('ëª¨ë°”ì¼ê°€ì…ë‚´ì—­');
      console.log(`ğŸ“‹ [ë¯¸ë§¤ì¹­ê³ ê°] ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${mobileData ? mobileData.length : 0}í–‰`);

      if (mobileData && mobileData.length > 1) {
        mobileData.slice(1).forEach(row => {
          if (row.length >= 3) {
            const customerName = (row[1] || '').toString().trim(); // Bì—´: ê³ ê°ëª…
            const phoneNumber = (row[2] || '').toString().trim(); // Cì—´: ì „í™”ë²ˆí˜¸
            const joinDate = (row[3] || '').toString().trim(); // Dì—´: ê°€ì…ì¼
            const model = (row[4] || '').toString().trim(); // Eì—´: ëª¨ë¸
            const memo = (row[5] || '').toString().trim(); // Fì—´: ë©”ëª¨

            // ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ì— ì—†ëŠ” ê³ ê°ë§Œ ì¶”ê°€
            if (customerName && phoneNumber && !reservationIds.has(phoneNumber)) {
              unmatchedData.mobile.push({
                customerName,
                phoneNumber,
                joinDate,
                model,
                memo
              });
            }
          }
        });
        console.log(`âœ… [ë¯¸ë§¤ì¹­ê³ ê°] ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ ë¯¸ë§¤ì¹­: ${unmatchedData.mobile.length}ê±´`);
      } else {
        console.log('âš ï¸ [ë¯¸ë§¤ì¹­ê³ ê°] ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ ë°ì´í„°ê°€ ì—†ê±°ë‚˜ í—¤ë”ë§Œ ì¡´ì¬');
      }
    } catch (error) {
      console.error('âŒ [ë¯¸ë§¤ì¹­ê³ ê°] ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
      // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ë‹¤ë¥¸ ì‹œíŠ¸ëŠ” ê³„ì† ì²˜ë¦¬
    }

    const totalUnmatched = unmatchedData.yard.length + unmatchedData.onSale.length + unmatchedData.mobile.length;

    console.log(`ğŸ“Š [ë¯¸ë§¤ì¹­ê³ ê°] ë¯¸ë§¤ì¹­ í˜„í™©: ë§ˆë‹¹ì ‘ìˆ˜ ${unmatchedData.yard.length}ê±´, ì˜¨ì„¸ì¼ ${unmatchedData.onSale.length}ê±´, ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ ${unmatchedData.mobile.length}ê±´ (ì´ ${totalUnmatched}ê±´)`);

    const result = {
      success: true,
      data: unmatchedData,
      stats: {
        totalUnmatched,
        yardCount: unmatchedData.yard.length,
        onSaleCount: unmatchedData.onSale.length,
        mobileCount: unmatchedData.mobile.length,
        reservationBaseCount: reservationIds.size
      },
      lastUpdated: new Date().toISOString()
    };

    res.json(result);

  } catch (error) {
    console.error('âŒ [ë¯¸ë§¤ì¹­ê³ ê°] ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: 'ë¯¸ë§¤ì¹­ ê³ ê° ì¡°íšŒ ì‹¤íŒ¨',
      message: error.message
    });
  }
});

// ë¯¸ë§¤ì¹­ ê³ ê° ì—‘ì…€ ë‹¤ìš´ë¡œë“œ API
app.get('/api/unmatched-customers/excel', async (req, res) => {
  try {
    console.log('ğŸ“Š [ë¯¸ë§¤ì¹­ê³ ê°] ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ìš”ì²­');

    // ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ë°ì´í„° ë¡œë“œ (ê¸°ì¤€ ë°ì´í„°)
    const reservationData = await getSheetValues('ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸');
    if (!reservationData || reservationData.length < 2) {
      throw new Error('ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    // ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ì˜ ê³ ìœ  ì‹ë³„ì ì¶”ì¶œ (ì˜ˆì•½ë²ˆí˜¸ ë˜ëŠ” ì „í™”ë²ˆí˜¸)
    const reservationIds = new Set();
    reservationData.slice(1).forEach(row => {
      if (row.length >= 3) {
        const reservationNumber = (row[2] || '').toString().trim(); // Cì—´: ì˜ˆì•½ë²ˆí˜¸
        const phoneNumber = (row[3] || '').toString().trim(); // Dì—´: ì „í™”ë²ˆí˜¸
        if (reservationNumber) reservationIds.add(reservationNumber);
        if (phoneNumber) reservationIds.add(phoneNumber);
      }
    });

    console.log(`ğŸ“‹ [ë¯¸ë§¤ì¹­ê³ ê°] ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ê¸°ì¤€ ID: ${reservationIds.size}ê°œ`);

    // ê° ì‹œíŠ¸ë³„ ë°ì´í„° ë¡œë“œ ë° ë¯¸ë§¤ì¹­ ì°¾ê¸°
    const unmatchedData = {
      yard: [],
      onSale: [],
      mobile: []
    };

    // 1. ë§ˆë‹¹ì ‘ìˆ˜ ë¯¸ë§¤ì¹­ í™•ì¸
    try {
      const yardData = await getSheetValues('ë§ˆë‹¹ì ‘ìˆ˜');
      if (yardData && yardData.length > 1) {
        yardData.slice(1).forEach(row => {
          if (row.length >= 3) {
            const customerName = (row[1] || '').toString().trim(); // Bì—´: ê³ ê°ëª…
            const phoneNumber = (row[2] || '').toString().trim(); // Cì—´: ì „í™”ë²ˆí˜¸
            const receptionDate = (row[3] || '').toString().trim(); // Dì—´: ì ‘ìˆ˜ì¼
            const model = (row[4] || '').toString().trim(); // Eì—´: ëª¨ë¸
            const memo = (row[5] || '').toString().trim(); // Fì—´: ë©”ëª¨

            // ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ì— ì—†ëŠ” ê³ ê°ë§Œ ì¶”ê°€
            if (customerName && phoneNumber && !reservationIds.has(phoneNumber)) {
              unmatchedData.yard.push({
                customerName,
                phoneNumber,
                receptionDate,
                model,
                memo
              });
            }
          }
        });
      }
    } catch (error) {
      console.error('ë§ˆë‹¹ì ‘ìˆ˜ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
    }

    // 2. ì˜¨ì„¸ì¼ ë¯¸ë§¤ì¹­ í™•ì¸
    try {
      const onSaleData = await getSheetValues('ì˜¨ì„¸ì¼');
      if (onSaleData && onSaleData.length > 1) {
        onSaleData.slice(1).forEach(row => {
          if (row.length >= 3) {
            const customerName = (row[1] || '').toString().trim(); // Bì—´: ê³ ê°ëª…
            const phoneNumber = (row[2] || '').toString().trim(); // Cì—´: ì „í™”ë²ˆí˜¸
            const receptionDate = (row[3] || '').toString().trim(); // Dì—´: ì ‘ìˆ˜ì¼
            const model = (row[4] || '').toString().trim(); // Eì—´: ëª¨ë¸
            const memo = (row[5] || '').toString().trim(); // Fì—´: ë©”ëª¨

            // ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ì— ì—†ëŠ” ê³ ê°ë§Œ ì¶”ê°€
            if (customerName && phoneNumber && !reservationIds.has(phoneNumber)) {
              unmatchedData.onSale.push({
                customerName,
                phoneNumber,
                receptionDate,
                model,
                memo
              });
            }
          }
        });
      }
    } catch (error) {
      console.error('ì˜¨ì„¸ì¼ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
    }

    // 3. ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ ë¯¸ë§¤ì¹­ í™•ì¸
    try {
      const mobileData = await getSheetValues('ëª¨ë°”ì¼ê°€ì…ë‚´ì—­');
      if (mobileData && mobileData.length > 1) {
        mobileData.slice(1).forEach(row => {
          if (row.length >= 3) {
            const customerName = (row[1] || '').toString().trim(); // Bì—´: ê³ ê°ëª…
            const phoneNumber = (row[2] || '').toString().trim(); // Cì—´: ì „í™”ë²ˆí˜¸
            const joinDate = (row[3] || '').toString().trim(); // Dì—´: ê°€ì…ì¼
            const model = (row[4] || '').toString().trim(); // Eì—´: ëª¨ë¸
            const memo = (row[5] || '').toString().trim(); // Fì—´: ë©”ëª¨

            // ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ì— ì—†ëŠ” ê³ ê°ë§Œ ì¶”ê°€
            if (customerName && phoneNumber && !reservationIds.has(phoneNumber)) {
              unmatchedData.mobile.push({
                customerName,
                phoneNumber,
                joinDate,
                model,
                memo
              });
            }
          }
        });
      }
    } catch (error) {
      console.error('ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
    }

    // Excel íŒŒì¼ ìƒì„±
    const workbook = new ExcelJS.Workbook();
    const dateStr = new Date().toISOString().split('T')[0];
    workbook.creator = 'VIP Plus';
    workbook.lastModifiedBy = 'VIP Plus';
    workbook.created = new Date();
    workbook.modified = new Date();

    // 1. ë§ˆë‹¹ì ‘ìˆ˜ ë¯¸ë§¤ì¹­ ì‹œíŠ¸
    const yardSheet = workbook.addWorksheet('ë§ˆë‹¹ì ‘ìˆ˜ë¯¸ë§¤ì¹­');
    yardSheet.columns = [
      { header: 'ê³ ê°ëª…', key: 'customerName', width: 15 },
      { header: 'ì „í™”ë²ˆí˜¸', key: 'phoneNumber', width: 15 },
      { header: 'ì ‘ìˆ˜ì¼', key: 'receptionDate', width: 12 },
      { header: 'ëª¨ë¸', key: 'model', width: 20 },
      { header: 'ë©”ëª¨', key: 'memo', width: 30 }
    ];

    unmatchedData.yard.forEach(item => {
      yardSheet.addRow(item);
    });

    // 2. ì˜¨ì„¸ì¼ ë¯¸ë§¤ì¹­ ì‹œíŠ¸
    const onSaleSheet = workbook.addWorksheet('ì˜¨ì„¸ì¼ë¯¸ë§¤ì¹­');
    onSaleSheet.columns = [
      { header: 'ê³ ê°ëª…', key: 'customerName', width: 15 },
      { header: 'ì „í™”ë²ˆí˜¸', key: 'phoneNumber', width: 15 },
      { header: 'ì ‘ìˆ˜ì¼', key: 'receptionDate', width: 12 },
      { header: 'ëª¨ë¸', key: 'model', width: 20 },
      { header: 'ë©”ëª¨', key: 'memo', width: 30 }
    ];

    unmatchedData.onSale.forEach(item => {
      onSaleSheet.addRow(item);
    });

    // 3. ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ ë¯¸ë§¤ì¹­ ì‹œíŠ¸
    const mobileSheet = workbook.addWorksheet('ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ë¯¸ë§¤ì¹­');
    mobileSheet.columns = [
      { header: 'ê³ ê°ëª…', key: 'customerName', width: 15 },
      { header: 'ì „í™”ë²ˆí˜¸', key: 'phoneNumber', width: 15 },
      { header: 'ê°€ì…ì¼', key: 'joinDate', width: 12 },
      { header: 'ëª¨ë¸', key: 'model', width: 20 },
      { header: 'ë©”ëª¨', key: 'memo', width: 30 }
    ];

    unmatchedData.mobile.forEach(item => {
      mobileSheet.addRow(item);
    });

    // 4. ìš”ì•½ ì‹œíŠ¸
    const summarySheet = workbook.addWorksheet('ìš”ì•½');
    summarySheet.columns = [
      { header: 'êµ¬ë¶„', key: 'category', width: 20 },
      { header: 'ë¯¸ë§¤ì¹­ ê±´ìˆ˜', key: 'count', width: 15 },
      { header: 'ë¹„ê³ ', key: 'note', width: 30 }
    ];

    summarySheet.addRow({ category: 'ë§ˆë‹¹ì ‘ìˆ˜ ë¯¸ë§¤ì¹­', count: unmatchedData.yard.length, note: 'ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ì— ì—†ëŠ” ê³ ê°' });
    summarySheet.addRow({ category: 'ì˜¨ì„¸ì¼ ë¯¸ë§¤ì¹­', count: unmatchedData.onSale.length, note: 'ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ì— ì—†ëŠ” ê³ ê°' });
    summarySheet.addRow({ category: 'ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ ë¯¸ë§¤ì¹­', count: unmatchedData.mobile.length, note: 'ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ì— ì—†ëŠ” ê³ ê°' });
    summarySheet.addRow({ category: 'ì´ ë¯¸ë§¤ì¹­ ê±´ìˆ˜', count: unmatchedData.yard.length + unmatchedData.onSale.length + unmatchedData.mobile.length, note: 'ì „ì²´ ë¯¸ë§¤ì¹­ í•©ê³„' });
    summarySheet.addRow({ category: 'ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ê¸°ì¤€', count: reservationIds.size, note: 'ë§¤ì¹­ ê¸°ì¤€ì´ ë˜ëŠ” ê³ ê° ìˆ˜' });

    // ìŠ¤íƒ€ì¼ ì ìš©
    [yardSheet, onSaleSheet, mobileSheet, summarySheet].forEach(sheet => {
      // í—¤ë” ìŠ¤íƒ€ì¼
      sheet.getRow(1).font = { bold: true };
      sheet.getRow(1).fill = {
        type: 'pattern',
        pattern: 'solid',
        fgColor: { argb: 'FFE0E0E0' }
      };

      // í…Œë‘ë¦¬ ìŠ¤íƒ€ì¼
      sheet.eachRow((row, rowNumber) => {
        row.eachCell((cell) => {
          cell.border = {
            top: { style: 'thin' },
            left: { style: 'thin' },
            bottom: { style: 'thin' },
            right: { style: 'thin' }
          };
        });
      });
    });

    // íŒŒì¼ ìƒì„±
    const buffer = await workbook.xlsx.writeBuffer();

    // ì‘ë‹µ í—¤ë” ì„¤ì •
    res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
    const filename = `unmatched_customers_${dateStr}.xlsx`;
    res.setHeader('Content-Disposition', `attachment; filename="${filename}"; filename*=UTF-8''${encodeURIComponent(`ë¯¸ë§¤ì¹­ê³ ê°í˜„í™©_${dateStr}.xlsx`)}`);

    console.log(`ğŸ“Š [ë¯¸ë§¤ì¹­ê³ ê°] ì—‘ì…€ íŒŒì¼ ìƒì„± ì™„ë£Œ: ë§ˆë‹¹ì ‘ìˆ˜ ${unmatchedData.yard.length}ê±´, ì˜¨ì„¸ì¼ ${unmatchedData.onSale.length}ê±´, ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ ${unmatchedData.mobile.length}ê±´`);

    res.send(buffer);

  } catch (error) {
    console.error('âŒ [ë¯¸ë§¤ì¹­ê³ ê°] ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: 'ì—‘ì…€ íŒŒì¼ ìƒì„± ì‹¤íŒ¨',
      message: error.message
    });
  }
});

// ì·¨ì†Œ ì²´í¬ ë°ì´í„° ì €ì¥ API
app.post('/api/cancel-check/save', async (req, res) => {
  try {
    console.log('ğŸ“ [ì·¨ì†Œì²´í¬] ì·¨ì†Œ ì²´í¬ ë°ì´í„° ì €ì¥ ìš”ì²­:', req.body);

    // Google Sheets API ì¸ì¦ ë° sheets ê°ì²´ ìƒì„±
    const auth = new google.auth.GoogleAuth({
      credentials: {
        client_email: GOOGLE_SERVICE_ACCOUNT_EMAIL,
        private_key: GOOGLE_PRIVATE_KEY.replace(/\\n/g, '\n')
      },
      scopes: ['https://www.googleapis.com/auth/spreadsheets']
    });

    const sheets = google.sheets({ version: 'v4', auth });

    const { reservationNumbers } = req.body;

    if (!Array.isArray(reservationNumbers)) {
      return res.status(400).json({
        success: false,
        error: 'ì˜ˆì•½ë²ˆí˜¸ ë°°ì—´ì´ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }

    // ê¸°ì¡´ ì·¨ì†Œ ë°ì´í„° ë¡œë“œ (ìºì‹œ ë¬´ì‹œ)
    let existingData = [];
    let hasHeader = false;
    try {
      const currentData = await getSheetValuesWithoutCache('ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ì·¨ì†Œë°ì´í„°');
      console.log(`ğŸ“ [ì·¨ì†Œì²´í¬] ì‹œíŠ¸ì—ì„œ ì§ì ‘ ë¡œë“œí•œ ë°ì´í„°: ${currentData ? currentData.length : 0}í–‰`);
      if (currentData && currentData.length > 0) {
        // í—¤ë” í™•ì¸ (ì˜ˆì•½ë²ˆí˜¸, ë“±ë¡ì¼ì‹œ, ìƒíƒœ)
        const firstRow = currentData[0];
        if (firstRow && firstRow.length >= 3 &&
          firstRow[0] === 'ì˜ˆì•½ë²ˆí˜¸' &&
          firstRow[1] === 'ë“±ë¡ì¼ì‹œ' &&
          firstRow[2] === 'ìƒíƒœ') {
          hasHeader = true;
          if (currentData.length > 1) {
            existingData = currentData.slice(1); // í—¤ë” ì œì™¸
          }
        } else {
          // í—¤ë”ê°€ ì—†ìœ¼ë©´ ëª¨ë“  ë°ì´í„°ë¥¼ ê¸°ì¡´ ë°ì´í„°ë¡œ ì²˜ë¦¬
          existingData = currentData;
        }
      }
    } catch (error) {
      console.log('ê¸°ì¡´ ì·¨ì†Œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œ ìƒì„±í•©ë‹ˆë‹¤.');
    }

    // ìƒˆë¡œìš´ ì·¨ì†Œ ë°ì´í„° ì¶”ê°€
    const newCancelData = reservationNumbers.map(reservationNumber => [
      reservationNumber,
      new Date().toISOString(),
      'ì·¨ì†Œì²´í¬'
    ]);

    // ì¤‘ë³µ ì œê±° (ì˜ˆì•½ë²ˆí˜¸ ê¸°ì¤€)
    const existingReservationNumbers = new Set(existingData.map(row => row[0]));
    const uniqueNewData = newCancelData.filter(row => !existingReservationNumbers.has(row[0]));

    console.log(`ğŸ“ [ì·¨ì†Œì²´í¬] ê¸°ì¡´ ì˜ˆì•½ë²ˆí˜¸: ${Array.from(existingReservationNumbers).join(', ')}`);
    console.log(`ğŸ“ [ì·¨ì†Œì²´í¬] ìƒˆ ì˜ˆì•½ë²ˆí˜¸: ${reservationNumbers.join(', ')}`);
    console.log(`ğŸ“ [ì·¨ì†Œì²´í¬] ì¤‘ë³µ ì œê±° í›„ ì €ì¥í•  ë°ì´í„°: ${uniqueNewData.length}ê±´`);

    if (uniqueNewData.length === 0) {
      console.log('ğŸ“ [ì·¨ì†Œì²´í¬] ì´ë¯¸ ì²´í¬ëœ ì˜ˆì•½ë²ˆí˜¸ë“¤ì…ë‹ˆë‹¤.');
      return res.json({
        success: true,
        message: 'ì´ë¯¸ ì²´í¬ëœ ì˜ˆì•½ë²ˆí˜¸ë“¤ì…ë‹ˆë‹¤.',
        savedCount: 0
      });
    }

    // í—¤ë”ê°€ ì—†ìœ¼ë©´ ë¨¼ì € í—¤ë” ì¶”ê°€
    if (!hasHeader) {
      console.log('ğŸ“ [ì·¨ì†Œì²´í¬] í—¤ë”ê°€ ì—†ìŠµë‹ˆë‹¤. í—¤ë”ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.');
      const headerRow = [['ì˜ˆì•½ë²ˆí˜¸', 'ë“±ë¡ì¼ì‹œ', 'ìƒíƒœ']];

      // ì‹œíŠ¸ë¥¼ ì™„ì „íˆ ë¹„ìš°ê³  í—¤ë” ì¶”ê°€
      await sheets.spreadsheets.values.clear({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ì·¨ì†Œë°ì´í„°'
      });

      await sheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ì·¨ì†Œë°ì´í„°!A1:C1',
        valueInputOption: 'RAW',
        resource: {
          values: headerRow
        }
      });

      console.log('ğŸ“ [ì·¨ì†Œì²´í¬] í—¤ë” ì¶”ê°€ ì™„ë£Œ');
    }

    // Google Sheetsì— ë°ì´í„° ì¶”ê°€ (í—¤ë”ê°€ ìˆìœ¼ë©´ append, ì—†ìœ¼ë©´ update)
    let response;
    if (hasHeader) {
      // í—¤ë”ê°€ ìˆìœ¼ë©´ append ì‚¬ìš©
      response = await sheets.spreadsheets.values.append({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ì·¨ì†Œë°ì´í„°!A:C',
        valueInputOption: 'RAW',
        insertDataOption: 'INSERT_ROWS',
        resource: {
          values: uniqueNewData
        }
      });
    } else {
      // í—¤ë”ê°€ ì—†ì—ˆìœ¼ë©´ í—¤ë”ì™€ ë°ì´í„°ë¥¼ í•¨ê»˜ update
      const allData = [['ì˜ˆì•½ë²ˆí˜¸', 'ë“±ë¡ì¼ì‹œ', 'ìƒíƒœ'], ...uniqueNewData];
      response = await sheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ì·¨ì†Œë°ì´í„°!A:C',
        valueInputOption: 'RAW',
        resource: {
          values: allData
        }
      });
    }

    console.log(`ğŸ“ [ì·¨ì†Œì²´í¬] ì·¨ì†Œ ë°ì´í„° ì €ì¥ ì™„ë£Œ: ${uniqueNewData.length}ê±´`);

    res.json({
      success: true,
      message: 'ì·¨ì†Œ ì²´í¬ ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.',
      savedCount: uniqueNewData.length,
      data: response.data
    });

  } catch (error) {
    console.error('âŒ [ì·¨ì†Œì²´í¬] ì €ì¥ ì˜¤ë¥˜:', error);
    console.error('âŒ [ì·¨ì†Œì²´í¬] ì—ëŸ¬ ìŠ¤íƒ:', error.stack);
    res.status(500).json({
      success: false,
      error: 'ì·¨ì†Œ ì²´í¬ ë°ì´í„° ì €ì¥ ì‹¤íŒ¨',
      message: error.message,
      stack: error.stack
    });
  }
});

// ì·¨ì†Œ ì²´í¬ ë°ì´í„° ì¡°íšŒ API
app.get('/api/cancel-check/list', async (req, res) => {
  try {
    console.log('ğŸ“‹ [ì·¨ì†Œì²´í¬] ì·¨ì†Œ ì²´í¬ ë°ì´í„° ì¡°íšŒ ìš”ì²­');

    const cancelData = await getSheetValuesWithoutCache('ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ì·¨ì†Œë°ì´í„°');
    console.log(`ğŸ“‹ [ì·¨ì†Œì²´í¬] ì‹œíŠ¸ì—ì„œ ì§ì ‘ ë¡œë“œí•œ ë°ì´í„°: ${cancelData ? cancelData.length : 0}í–‰`);

    if (!cancelData || cancelData.length <= 1) {
      return res.json({
        success: true,
        data: [],
        count: 0
      });
    }

    // í—¤ë” í™•ì¸ ë° ë°ì´í„° ì¶”ì¶œ
    const firstRow = cancelData[0];
    let dataRows;

    if (firstRow && firstRow.length >= 3 &&
      firstRow[0] === 'ì˜ˆì•½ë²ˆí˜¸' &&
      firstRow[1] === 'ë“±ë¡ì¼ì‹œ' &&
      firstRow[2] === 'ìƒíƒœ') {
      // í—¤ë”ê°€ ìˆìœ¼ë©´ í—¤ë” ì œì™¸
      dataRows = cancelData.slice(1);
    } else {
      // í—¤ë”ê°€ ì—†ìœ¼ë©´ ëª¨ë“  ë°ì´í„° ì‚¬ìš©
      dataRows = cancelData;
    }

    const cancelReservationNumbers = dataRows.map(row => row[0]); // ì˜ˆì•½ë²ˆí˜¸ë§Œ ì¶”ì¶œ

    console.log(`ğŸ“‹ [ì·¨ì†Œì²´í¬] ì·¨ì†Œ ì²´í¬ ë°ì´í„° ì¡°íšŒ ì™„ë£Œ: ${cancelReservationNumbers.length}ê±´`);

    res.json({
      success: true,
      data: cancelReservationNumbers,
      count: cancelReservationNumbers.length
    });

  } catch (error) {
    console.error('âŒ [ì·¨ì†Œì²´í¬] ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: 'ì·¨ì†Œ ì²´í¬ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨',
      message: error.message
    });
  }
});

// ì·¨ì†Œ ì²´í¬ ë°ì´í„° ì‚­ì œ API
app.delete('/api/cancel-check/delete', async (req, res) => {
  try {
    console.log('ğŸ—‘ï¸ [ì·¨ì†Œì²´í¬] ì·¨ì†Œ ì²´í¬ ë°ì´í„° ì‚­ì œ ìš”ì²­ ì‹œì‘');
    console.log('ğŸ—‘ï¸ [ì·¨ì†Œì²´í¬] ìš”ì²­ body:', req.body);
    console.log('ğŸ—‘ï¸ [ì·¨ì†Œì²´í¬] ìš”ì²­ headers:', req.headers);

    // Google Sheets API ì¸ì¦ ë° sheets ê°ì²´ ìƒì„±
    const auth = new google.auth.GoogleAuth({
      credentials: {
        client_email: GOOGLE_SERVICE_ACCOUNT_EMAIL,
        private_key: GOOGLE_PRIVATE_KEY.replace(/\\n/g, '\n')
      },
      scopes: ['https://www.googleapis.com/auth/spreadsheets']
    });

    const sheets = google.sheets({ version: 'v4', auth });

    const { reservationNumbers } = req.body || {};

    if (!Array.isArray(reservationNumbers)) {
      return res.status(400).json({
        success: false,
        error: 'ì˜ˆì•½ë²ˆí˜¸ ë°°ì—´ì´ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }

    if (reservationNumbers.length === 0) {
      return res.json({
        success: true,
        message: 'ì‚­ì œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.',
        deletedCount: 0
      });
    }

    console.log(`ğŸ—‘ï¸ [ì·¨ì†Œì²´í¬] ì‚­ì œ ëŒ€ìƒ ì˜ˆì•½ë²ˆí˜¸: ${reservationNumbers.join(', ')}`);

    // í˜„ì¬ ì·¨ì†Œ ë°ì´í„° ë¡œë“œ (ìºì‹œ ë¬´ì‹œ)
    const currentData = await getSheetValuesWithoutCache('ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ì·¨ì†Œë°ì´í„°');
    console.log(`ğŸ—‘ï¸ [ì·¨ì†Œì²´í¬] ì‹œíŠ¸ì—ì„œ ì§ì ‘ ë¡œë“œí•œ ë°ì´í„°: ${currentData ? currentData.length : 0}í–‰`);

    if (!currentData || currentData.length === 0) {
      console.log('ğŸ—‘ï¸ [ì·¨ì†Œì²´í¬] ì‚­ì œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤ (ì‹œíŠ¸ê°€ ë¹„ì–´ìˆìŒ)');
      return res.json({
        success: true,
        message: 'ì‚­ì œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.',
        deletedCount: 0
      });
    }

    console.log(`ğŸ—‘ï¸ [ì·¨ì†Œì²´í¬] í˜„ì¬ ì‹œíŠ¸ ë°ì´í„°: ${currentData.length}í–‰`);

    // í—¤ë” í™•ì¸ ë° ì²˜ë¦¬
    let header, dataRows;
    const firstRow = currentData[0];

    if (firstRow && firstRow.length >= 3 &&
      firstRow[0] === 'ì˜ˆì•½ë²ˆí˜¸' &&
      firstRow[1] === 'ë“±ë¡ì¼ì‹œ' &&
      firstRow[2] === 'ìƒíƒœ') {
      // í—¤ë”ê°€ ìˆìŒ
      header = firstRow;
      dataRows = currentData.slice(1);
    } else {
      // í—¤ë”ê°€ ì—†ìŒ - í—¤ë” ì¶”ê°€
      header = ['ì˜ˆì•½ë²ˆí˜¸', 'ë“±ë¡ì¼ì‹œ', 'ìƒíƒœ'];
      dataRows = currentData;
    }

    console.log(`ğŸ—‘ï¸ [ì·¨ì†Œì²´í¬] ê¸°ì¡´ ë°ì´í„° í–‰: ${dataRows.length}ê°œ`);
    console.log(`ğŸ—‘ï¸ [ì·¨ì†Œì²´í¬] ê¸°ì¡´ ì˜ˆì•½ë²ˆí˜¸ë“¤: ${dataRows.map(row => row[0]).join(', ')}`);

    const filteredData = dataRows.filter(row => {
      const reservationNumber = row[0];
      const shouldKeep = !reservationNumbers.includes(reservationNumber);
      if (!shouldKeep) {
        console.log(`ğŸ—‘ï¸ [ì·¨ì†Œì²´í¬] ì‚­ì œ ëŒ€ìƒ ë°œê²¬: ${reservationNumber}`);
      }
      return shouldKeep;
    });

    const deletedCount = dataRows.length - filteredData.length;

    console.log(`ğŸ—‘ï¸ [ì·¨ì†Œì²´í¬] í•„í„°ë§ í›„ ë°ì´í„°: ${filteredData.length}ê°œ, ì‚­ì œ ì˜ˆì •: ${deletedCount}ê°œ`);

    if (deletedCount === 0) {
      console.log('ğŸ—‘ï¸ [ì·¨ì†Œì²´í¬] ì‚­ì œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤ (ë§¤ì¹­ë˜ëŠ” ì˜ˆì•½ë²ˆí˜¸ ì—†ìŒ)');
      return res.json({
        success: true,
        message: 'ì‚­ì œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.',
        deletedCount: 0
      });
    }

    // ì „ì²´ ë°ì´í„°ë¥¼ ìƒˆë¡œ ì“°ê¸° (í—¤ë” + í•„í„°ë§ëœ ë°ì´í„°)
    const newData = [header, ...filteredData];

    console.log(`ğŸ—‘ï¸ [ì·¨ì†Œì²´í¬] ì‚­ì œ ì „ ë°ì´í„°: ${dataRows.length}ê±´, ì‚­ì œ í›„ ë°ì´í„°: ${filteredData.length}ê±´`);
    console.log(`ğŸ—‘ï¸ [ì·¨ì†Œì²´í¬] ìƒˆ ë°ì´í„° êµ¬ì¡°:`, newData);

    let sheetResponse;
    try {
      // ë¨¼ì € ì‹œíŠ¸ë¥¼ ì™„ì „íˆ ë¹„ìš°ê³  ìƒˆ ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸
      console.log('ğŸ—‘ï¸ [ì·¨ì†Œì²´í¬] ì‹œíŠ¸ ì´ˆê¸°í™” ì‹œì‘...');
      await sheets.spreadsheets.values.clear({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ì·¨ì†Œë°ì´í„°'
      });
      console.log('ğŸ—‘ï¸ [ì·¨ì†Œì²´í¬] ì‹œíŠ¸ ì´ˆê¸°í™” ì™„ë£Œ');

      console.log('ğŸ—‘ï¸ [ì·¨ì†Œì²´í¬] ìƒˆ ë°ì´í„° ì“°ê¸° ì‹œì‘...');
      sheetResponse = await sheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ì·¨ì†Œë°ì´í„°!A:C',
        valueInputOption: 'RAW',
        resource: {
          values: newData
        }
      });
      console.log('ğŸ—‘ï¸ [ì·¨ì†Œì²´í¬] ìƒˆ ë°ì´í„° ì“°ê¸° ì™„ë£Œ:', sheetResponse.data);

      console.log(`ğŸ—‘ï¸ [ì·¨ì†Œì²´í¬] ì·¨ì†Œ ë°ì´í„° ì‚­ì œ ì™„ë£Œ: ${deletedCount}ê±´`);
    } catch (sheetError) {
      console.error('ğŸ—‘ï¸ [ì·¨ì†Œì²´í¬] ì‹œíŠ¸ ì‘ì—… ì¤‘ ì˜¤ë¥˜:', sheetError);
      throw sheetError;
    }

    res.json({
      success: true,
      message: 'ì·¨ì†Œ ì²´í¬ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.',
      deletedCount,
      data: sheetResponse.data
    });

  } catch (error) {
    console.error('âŒ [ì·¨ì†Œì²´í¬] ì‚­ì œ ì˜¤ë¥˜:', error);
    console.error('âŒ [ì·¨ì†Œì²´í¬] ì—ëŸ¬ ìŠ¤íƒ:', error.stack);
    res.status(500).json({
      success: false,
      error: 'ì·¨ì†Œ ì²´í¬ ë°ì´í„° ì‚­ì œ ì‹¤íŒ¨',
      message: error.message,
      stack: error.stack
    });
  }
});

// ì‚¬ë¬´ì‹¤ë³„ ë³´ìœ ì¬ê³  í˜„í™© API (ì •ê·œí™”ì‘ì—…ì‹œíŠ¸ Cì—´ í•„í„°ë§ ì ìš©)
app.get('/api/office-inventory', async (req, res) => {
  try {
    console.log('ğŸ” [ì‚¬ë¬´ì‹¤ì¬ê³ ] ì‚¬ë¬´ì‹¤ë³„ ë³´ìœ ì¬ê³  í˜„í™© ìš”ì²­');

    // ì •ê·œí™”ì‘ì—…ì‹œíŠ¸ì—ì„œ í—ˆìš©ëœ ëª¨ë¸ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    const normalizedValues = await getSheetValues('ì •ê·œí™”ì‘ì—…');
    const allowedModels = new Set();

    if (normalizedValues && normalizedValues.length > 1) {
      // Cì—´(ì¸ë±ìŠ¤ 2)ì—ì„œ í—ˆìš©ëœ ëª¨ë¸ëª… ì¶”ì¶œ
      normalizedValues.slice(1).forEach(row => {
        if (row.length > 2 && row[2]) {
          const normalizedModel = row[2].toString().trim();
          if (normalizedModel) {
            allowedModels.add(normalizedModel);
          }
        }
      });
    }

    console.log(`ğŸ“‹ [ì‚¬ë¬´ì‹¤ì¬ê³ ] ì •ê·œí™”ì‘ì—…ì‹œíŠ¸ Cì—´ í—ˆìš© ëª¨ë¸: ${allowedModels.size}ê°œ`);
    console.log('ğŸ“‹ [ì‚¬ë¬´ì‹¤ì¬ê³ ] í—ˆìš© ëª¨ë¸ ëª©ë¡:', Array.from(allowedModels));

    // í°í´ì¬ê³ ë°ì´í„°ì—ì„œ ì¬ê³  ì •ë³´ ìˆ˜ì§‘
    const inventoryValues = await getSheetValues('í°í´ì¬ê³ ë°ì´í„°');

    if (!inventoryValues || inventoryValues.length < 2) {
      throw new Error('í°í´ì¬ê³ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    console.log(`ğŸ“Š [ì‚¬ë¬´ì‹¤ì¬ê³ ] í°í´ì¬ê³ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${inventoryValues.length}í–‰`);

    // ì‚¬ë¬´ì‹¤ë³„ ì¬ê³  ì¹´ìš´íŒ…
    const officeInventory = {
      'í‰íƒì‚¬ë¬´ì‹¤': {},
      'ì¸ì²œì‚¬ë¬´ì‹¤': {},
      'êµ°ì‚°ì‚¬ë¬´ì‹¤': {},
      'ì•ˆì‚°ì‚¬ë¬´ì‹¤': {}
    };

    let processedCount = 0;
    let filteredCount = 0;
    let totalCount = 0;

    // í—¤ë” ì œê±°í•˜ê³  ë°ì´í„° ì²˜ë¦¬ (2í–‰ë¶€í„° ì‹œì‘)
    inventoryValues.slice(1).forEach((row, index) => {
      if (row.length >= 14) {
        totalCount++;
        const model = (row[5] || '').toString().trim(); // Fì—´: ëª¨ë¸ëª…
        const color = (row[6] || '').toString().trim(); // Gì—´: ìƒ‰ìƒ
        const status = (row[7] || '').toString().trim(); // Hì—´: ìƒíƒœ
        const storeName = (row[13] || '').toString().trim(); // Nì—´: ì¶œê³ ì²˜(ì‚¬ë¬´ì‹¤ëª…)

        // ì •ìƒ ìƒíƒœì´ê³  ëª¨ë¸, ìƒ‰ìƒ, ì‚¬ë¬´ì‹¤ëª…ì´ ìˆëŠ” ê²½ìš°ë§Œ ì²˜ë¦¬
        if (model && color && storeName && status === 'ì •ìƒ') {
          const combinedModel = `${model} | ${color}`;

          // ì •ê·œí™”ì‘ì—…ì‹œíŠ¸ Cì—´ê³¼ ë§¤ì¹­ë˜ëŠ” ëª¨ë¸ë§Œ ì²˜ë¦¬
          if (allowedModels.has(combinedModel)) {
            // ì‚¬ë¬´ì‹¤ëª… ì¶”ì¶œ
            let officeName = '';
            if (storeName.includes('í‰íƒì‚¬ë¬´ì‹¤')) {
              officeName = 'í‰íƒì‚¬ë¬´ì‹¤';
            } else if (storeName.includes('ì¸ì²œì‚¬ë¬´ì‹¤')) {
              officeName = 'ì¸ì²œì‚¬ë¬´ì‹¤';
            } else if (storeName.includes('êµ°ì‚°ì‚¬ë¬´ì‹¤')) {
              officeName = 'êµ°ì‚°ì‚¬ë¬´ì‹¤';
            } else if (storeName.includes('ì•ˆì‚°ì‚¬ë¬´ì‹¤')) {
              officeName = 'ì•ˆì‚°ì‚¬ë¬´ì‹¤';
            }

            if (officeName && officeInventory[officeName]) {
              if (!officeInventory[officeName][combinedModel]) {
                officeInventory[officeName][combinedModel] = 0;
              }
              officeInventory[officeName][combinedModel]++;
              processedCount++;
            }
          } else {
            filteredCount++;
          }
        }
      }
    });

    console.log(`ğŸ“Š [ì‚¬ë¬´ì‹¤ì¬ê³ ] ì´ ë°ì´í„°: ${totalCount}ê°œ, ì²˜ë¦¬ëœ ì¬ê³ : ${processedCount}ê°œ, í•„í„°ë§ëœ í•­ëª©: ${filteredCount}ê°œ`);

    // í†µê³„ ê³„ì‚°
    const stats = {
      totalInventory: 0,
      officeStats: {},
      allowedModelsCount: allowedModels.size,
      processedCount,
      filteredCount,
      totalCount
    };

    Object.entries(officeInventory).forEach(([officeName, inventory]) => {
      const officeTotal = Object.values(inventory).reduce((sum, count) => sum + count, 0);
      const modelCount = Object.keys(inventory).length;

      stats.officeStats[officeName] = {
        totalInventory: officeTotal,
        modelCount: modelCount
      };

      stats.totalInventory += officeTotal;
    });

    const result = {
      success: true,
      officeInventory,
      stats,
      allowedModels: Array.from(allowedModels),
      lastUpdated: new Date().toISOString()
    };

    console.log('âœ… [ì‚¬ë¬´ì‹¤ì¬ê³ ] ì²˜ë¦¬ ì™„ë£Œ:', stats);
    res.json(result);

  } catch (error) {
    console.error('âŒ [ì‚¬ë¬´ì‹¤ì¬ê³ ] ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: 'ì‚¬ë¬´ì‹¤ë³„ ì¬ê³  ì¡°íšŒ ì‹¤íŒ¨',
      message: error.message
    });
  }
});

// ì‚¬ì „ì˜ˆì•½ ì„¤ì • ì €ì¥ API
app.post('/api/reservation-settings/save', async (req, res) => {
  try {
    const { selectedValues, matchingResult } = req.body;

    console.log('ì €ì¥ ìš”ì²­ ë°›ìŒ:', { selectedValues, matchingResult });

    // ë” ì½ê¸° ì‰¬ìš´ í˜•ì‹ìœ¼ë¡œ ë°ì´í„° ì •ë¦¬
    const reservationSiteText = [
      selectedValues.reservationSite.p,
      selectedValues.reservationSite.q,
      selectedValues.reservationSite.r
    ].filter(v => v).join(' | ');

    const phoneklText = [
      selectedValues.phonekl.f,
      selectedValues.phonekl.g
    ].filter(v => v).join(' | ');

    console.log('ì •ë¦¬ëœ ë°ì´í„°:', { reservationSiteText, phoneklText });

    // ì •ê·œí™”ì‘ì—… ì‹œíŠ¸ì— ì €ì¥
    const saveData = [
      [
        new Date().toISOString(), // ì €ì¥ì¼ì‹œ
        reservationSiteText || 'ì„ íƒëœ ê°’ ì—†ìŒ', // ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ì„ íƒê°’
        phoneklText || 'ì„ íƒëœ ê°’ ì—†ìŒ', // í°í´ ì„ íƒê°’
        matchingResult.normalizedModel || 'ì •ê·œí™”ëœ ê°’ ì—†ìŒ', // ì •ê·œí™”ëœ ëª¨ë¸ëª…
        matchingResult.matchingStatus || 'ë§¤ì¹­ ìƒíƒœ ì—†ìŒ', // ë§¤ì¹­ ìƒíƒœ
        matchingResult.isMatched ? 'ì™„ë£Œ' : 'ë¯¸ì™„ë£Œ', // ì™„ë£Œ ì—¬ë¶€
        'ì‚¬ì „ì˜ˆì•½ ëª¨ë¸ëª… ì •ê·œí™”' // ë¹„ê³ 
      ]
    ];

    console.log('Google Sheetsì— ì €ì¥í•  ë°ì´í„°:', saveData);

    await sheets.spreadsheets.values.append({
      spreadsheetId: SPREADSHEET_ID,
      range: 'ì •ê·œí™”ì‘ì—…!A:G',
      valueInputOption: 'USER_ENTERED',
      resource: {
        values: saveData
      }
    });

    console.log('Google Sheets ì €ì¥ ì™„ë£Œ');

    res.json({
      success: true,
      message: 'ì •ê·œí™” ì„¤ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'
    });
  } catch (error) {
    console.error('ì‚¬ì „ì˜ˆì•½ ì„¤ì • ì €ì¥ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to save reservation settings',
      message: error.message
    });
  }
});

// ì €ì¥ëœ ì •ê·œí™” ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° API
app.get('/api/reservation-settings/list', async (req, res) => {
  try {
    // ì •ê·œí™”ì‘ì—… ì‹œíŠ¸ì—ì„œ ëª¨ë“  ì •ê·œí™” ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    try {
      const response = await sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ì •ê·œí™”ì‘ì—…!A:G'
      });

      if (response.data.values && response.data.values.length > 1) {
        // í—¤ë” ì œê±°í•˜ê³  ë°ì´í„° ì •ë¦¬
        const normalizationList = response.data.values.slice(1).map((row, index) => ({
          id: index + 1,
          timestamp: row[0] || '',
          reservationSite: row[1] || '',
          phonekl: row[2] || '',
          normalizedModel: row[3] || '',
          matchingStatus: row[4] || '',
          isCompleted: row[5] === 'ì™„ë£Œ',
          note: row[6] || ''
        }));

        res.json({
          success: true,
          normalizationList: normalizationList.reverse() // ìµœì‹  í•­ëª©ì´ ìœ„ë¡œ ì˜¤ë„ë¡
        });
        return;
      }
    } catch (error) {
      console.log('ì •ê·œí™”ì‘ì—… ì‹œíŠ¸ ë¡œë“œ ì‹¤íŒ¨:', error.message);
    }

    // ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° ë¹ˆ ë°°ì—´ ë°˜í™˜
    res.json({
      success: true,
      normalizationList: []
    });
  } catch (error) {
    console.error('ì •ê·œí™” ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to load normalization list',
      message: error.message
    });
  }
});

// ì‚¬ì „ì˜ˆì•½ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° API
app.get('/api/reservation-settings/load', async (req, res) => {
  try {
    // ì •ê·œí™”ì‘ì—… ì‹œíŠ¸ì—ì„œ ìµœì‹  ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
    try {
      const response = await sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ì •ê·œí™”ì‘ì—…!A:G'
      });

      if (response.data.values && response.data.values.length > 1) {
        // ìµœì‹  ì„¤ì • (ë§ˆì§€ë§‰ í–‰) ë¶ˆëŸ¬ì˜¤ê¸°
        const latestRow = response.data.values[response.data.values.length - 1];

        if (latestRow.length >= 3) {
          // í…ìŠ¤íŠ¸ í˜•íƒœì˜ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ê°ì²´ë¡œ ë³€í™˜
          const reservationSiteParts = (latestRow[1] || '').split(' | ');
          const phoneklParts = (latestRow[2] || '').split(' | ');

          const selectedValues = {
            reservationSite: {
              p: reservationSiteParts[0] || '',
              q: reservationSiteParts[1] || '',
              r: reservationSiteParts[2] || ''
            },
            phonekl: {
              f: phoneklParts[0] || '',
              g: phoneklParts[1] || ''
            }
          };

          const matchingResult = {
            normalizedModel: latestRow[3] || '',
            matchingStatus: latestRow[4] || '',
            isMatched: latestRow[5] === 'ì™„ë£Œ'
          };

          res.json({
            success: true,
            selectedValues,
            matchingResult
          });
          return;
        }
      }
    } catch (error) {
      console.log('ì •ê·œí™”ì‘ì—… ì‹œíŠ¸ ë¡œë“œ ì‹¤íŒ¨:', error.message);
    }

    // ì €ì¥ëœ ì„¤ì •ì´ ì—†ëŠ” ê²½ìš° ê¸°ë³¸ê°’ ë°˜í™˜
    res.json({
      success: true,
      selectedValues: {
        reservationSite: { p: '', q: '', r: '' },
        phonekl: { f: '', g: '' }
      },
      matchingResult: {
        normalizedModel: '',
        matchingStatus: '',
        isMatched: false
      }
    });
  } catch (error) {
    console.error('ì‚¬ì „ì˜ˆì•½ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to load reservation settings',
      message: error.message
    });
  }
});

// ì •ê·œí™”ëœ ë°ì´í„° ì¡°íšŒ API
app.get('/api/reservation-settings/normalized-data', async (req, res) => {
  try {
    // 1. ì •ê·œí™” ê·œì¹™ë“¤ì„ ë¶ˆëŸ¬ì˜¤ê¸°
    let normalizationRules = [];
    try {
      const rulesResponse = await sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ì •ê·œí™”ì‘ì—…!A:G'
      });

      if (rulesResponse.data.values && rulesResponse.data.values.length > 1) {
        // í—¤ë” ì œê±°í•˜ê³  ì™„ë£Œëœ ê·œì¹™ë§Œ í•„í„°ë§
        normalizationRules = rulesResponse.data.values.slice(1)
          .filter(row => row.length >= 6 && row[5] === 'ì™„ë£Œ')
          .map(row => ({
            reservationSite: row[1] || '',
            phonekl: row[2] || '',
            normalizedModel: row[3] || '',
            note: row[6] || ''
          }));
      }
    } catch (error) {
      console.log('ì •ê·œí™” ê·œì¹™ ë¡œë“œ ì‹¤íŒ¨:', error.message);
    }

    // 2. ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ì‹œíŠ¸ì˜ ì›ë³¸ ë°ì´í„° ì½ê¸°
    let reservationSiteOriginalData = [];
    try {
      const reservationResponse = await sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸!A:AA' // ì „ì²´ ë°ì´í„° ì½ê¸°
      });

      if (reservationResponse.data.values && reservationResponse.data.values.length > 1) {
        const headers = reservationResponse.data.values[0];
        const dataRows = reservationResponse.data.values.slice(1);

        reservationSiteOriginalData = dataRows.map((row, index) => {
          const rowData = {};
          headers.forEach((header, colIndex) => {
            rowData[header] = row[colIndex] || '';
          });

          // P, Q, Rì—´ ê°’ ì¶”ì¶œ
          const pValue = row[15] || ''; // Pì—´ (16ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
          const qValue = row[16] || ''; // Qì—´ (17ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
          const rValue = row[17] || ''; // Rì—´ (18ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)

          // ì •ê·œí™” ê·œì¹™ ì ìš©
          let normalizedModel = '';
          let appliedRule = null;

          for (const rule of normalizationRules) {
            const ruleParts = rule.reservationSite.split(' | ');
            if (ruleParts.length >= 3) {
              const ruleP = ruleParts[0];
              const ruleQ = ruleParts[1];
              const ruleR = ruleParts[2];

              // ê³µë°± ì œê±°í•˜ì—¬ ì •í™•í•œ ë§¤ì¹­ í™•ì¸
              const normalizedPValue = pValue.replace(/\s+/g, '');
              const normalizedQValue = qValue.replace(/\s+/g, '');
              const normalizedRValue = rValue.replace(/\s+/g, '');
              const normalizedRuleP = ruleP.replace(/\s+/g, '');
              const normalizedRuleQ = ruleQ.replace(/\s+/g, '');
              const normalizedRuleR = ruleR.replace(/\s+/g, '');

              // ì •í™•í•œ ë§¤ì¹­ í™•ì¸
              const pMatch = !normalizedRuleP || normalizedPValue === normalizedRuleP;
              const qMatch = !normalizedRuleQ || normalizedQValue === normalizedRuleQ;
              const rMatch = !normalizedRuleR || normalizedRValue === normalizedRuleR;

              if (pMatch && qMatch && rMatch) {
                normalizedModel = rule.normalizedModel;
                appliedRule = rule;
                break;
              }
            }
          }

          return {
            ...rowData,
            originalP: pValue,
            originalQ: qValue,
            originalR: rValue,
            normalizedModel: normalizedModel,
            appliedRule: appliedRule,
            rowIndex: index + 2 // ì‹¤ì œ í–‰ ë²ˆí˜¸ (í—¤ë” ì œì™¸)
          };
        });
      }
    } catch (error) {
      // ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ì‹œíŠ¸ ë¡œë“œ ì‹¤íŒ¨
    }

    // 3. í°í´ì¬ê³ ë°ì´í„° ì‹œíŠ¸ì˜ ì›ë³¸ ë°ì´í„° ì½ê¸°
    let phoneklOriginalData = [];
    try {
      const phoneklResponse = await sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: 'í°í´ì¬ê³ ë°ì´í„°!A:AA' // ì „ì²´ ë°ì´í„° ì½ê¸°
      });

      if (phoneklResponse.data.values && phoneklResponse.data.values.length > 1) {
        const headers = phoneklResponse.data.values[0];
        const dataRows = phoneklResponse.data.values.slice(1);

        phoneklOriginalData = dataRows.map((row, index) => {
          const rowData = {};
          headers.forEach((header, colIndex) => {
            rowData[header] = row[colIndex] || '';
          });

          // F, Gì—´ ê°’ ì¶”ì¶œ
          const fValue = row[5] || ''; // Fì—´ (6ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
          const gValue = row[6] || ''; // Gì—´ (7ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)

          // ì •ê·œí™” ê·œì¹™ ì ìš©
          let normalizedModel = '';
          let appliedRule = null;

          for (const rule of normalizationRules) {
            const ruleParts = rule.phonekl.split(' | ');
            if (ruleParts.length >= 2) {
              const ruleF = ruleParts[0];
              const ruleG = ruleParts[1];

              // ê³µë°± ì œê±°í•˜ì—¬ ì •í™•í•œ ë§¤ì¹­ í™•ì¸
              const normalizedFValue = fValue.replace(/\s+/g, '');
              const normalizedGValue = gValue.replace(/\s+/g, '');
              const normalizedRuleF = ruleF.replace(/\s+/g, '');
              const normalizedRuleG = ruleG.replace(/\s+/g, '');

              // ì •í™•í•œ ë§¤ì¹­ í™•ì¸
              const fMatch = !normalizedRuleF || normalizedFValue === normalizedRuleF;
              const gMatch = !normalizedRuleG || normalizedGValue === normalizedRuleG;

              if (fMatch && gMatch) {
                normalizedModel = rule.normalizedModel;
                appliedRule = rule;
                break;
              }
            }
          }

          return {
            ...rowData,
            originalF: fValue,
            originalG: gValue,
            normalizedModel: normalizedModel,
            appliedRule: appliedRule,
            rowIndex: index + 2 // ì‹¤ì œ í–‰ ë²ˆí˜¸ (í—¤ë” ì œì™¸)
          };
        });
      }
    } catch (error) {
      console.log('í°í´ì¬ê³ ë°ì´í„° ì‹œíŠ¸ ë¡œë“œ ì‹¤íŒ¨:', error.message);
    }

    // 4. í†µê³„ ì •ë³´ ê³„ì‚° - ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ê¸°ì¤€ìœ¼ë¡œ ì™„ë£Œìœ¨ ê³„ì‚°
    const uniqueReservationModels = new Set();
    const uniqueNormalizedModels = new Set();

    // ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ì˜ ê³ ìœ  ëª¨ë¸ ì¡°í•© ì¶”ì¶œ (P+Q+R) - ê³µë°± ì œê±°
    reservationSiteOriginalData.forEach(item => {
      const modelKey = `${item.originalP}|${item.originalQ}|${item.originalR}`.replace(/\s+/g, '');
      if (modelKey && modelKey !== '||') {
        uniqueReservationModels.add(modelKey);
      }
    });

    // ì •ê·œí™”ëœ ê³ ìœ  ëª¨ë¸ ì¶”ì¶œ
    reservationSiteOriginalData.forEach(item => {
      if (item.normalizedModel) {
        uniqueNormalizedModels.add(item.normalizedModel);
      }
    });

    const stats = {
      totalRules: normalizationRules.length,
      reservationSiteTotal: uniqueReservationModels.size,
      reservationSiteNormalized: uniqueNormalizedModels.size,
      phoneklTotal: phoneklOriginalData.length,
      phoneklNormalized: phoneklOriginalData.filter(item => item.normalizedModel).length,
      // ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ê¸°ì¤€ ì™„ë£Œìœ¨ (100% ì™„ë£Œ ì‹œ ì •ê·œí™”ì‘ì—… ì™„ë£Œë¡œ ê°„ì£¼)
      completionRate: uniqueReservationModels.size > 0
        ? Math.round((uniqueNormalizedModels.size / uniqueReservationModels.size) * 100)
        : 0,
      isCompleted: uniqueReservationModels.size > 0 && uniqueNormalizedModels.size >= uniqueReservationModels.size
    };

    res.json({
      success: true,
      normalizationRules: normalizationRules,
      reservationSiteData: reservationSiteOriginalData,
      phoneklData: phoneklOriginalData,
      stats: stats
    });
  } catch (error) {
    console.error('ì •ê·œí™”ëœ ë°ì´í„° ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to load normalized data',
      message: error.message
    });
  }
});

// íŒë§¤ì²˜ë³„ì •ë¦¬ ê´€ë ¨ APIë“¤

// ëŒ€ë¦¬ì ì½”ë“œë³„ ë°ì´í„° ë¡œë“œ API (ìºì‹œ ì ìš©)
app.get('/api/sales-by-store/data', async (req, res) => {
  try {
    const cacheKey = 'sales_by_store_data';
    const cachedData = cacheUtils.get(cacheKey);

    if (cachedData) {
      console.log('íŒë§¤ì²˜ë³„ì •ë¦¬ ë°ì´í„° ìºì‹œì—ì„œ ë¡œë“œ');
      return res.json(cachedData);
    }

    console.log('íŒë§¤ì²˜ë³„ì •ë¦¬ ë°ì´í„° êµ¬ê¸€ì‹œíŠ¸ì—ì„œ ë¡œë“œ');

    // 1. ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ì‹œíŠ¸ ë°ì´í„° ë¡œë“œ
    const reservationResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: 'ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸!A:AA'
    });

    // 2. í°í´ì¶œê³ ì²˜ë°ì´í„° ì‹œíŠ¸ ë¡œë“œ (ë‹´ë‹¹ì ë§¤ì¹­ìš©)
    const phoneklResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: 'í°í´ì¶œê³ ì²˜ë°ì´í„°!A:V'
    });

    // 3. ë§ˆë‹¹ì ‘ìˆ˜ ì‹œíŠ¸ ë¡œë“œ (ì„œë¥˜ì ‘ìˆ˜ ìƒíƒœ í™•ì¸ìš©)
    const yardResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: 'ë§ˆë‹¹ì ‘ìˆ˜!A:X'
    });

    // 4. ì˜¨ì„¸ì¼ ì‹œíŠ¸ ë¡œë“œ (ì˜¨ì„¸ì¼ ì ‘ìˆ˜ ìƒíƒœ í™•ì¸ìš©)
    const onSaleResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: 'ì˜¨ì„¸ì¼!A:AA'
    });

    // 5. POSì½”ë“œë³€ê²½ì„¤ì • ì‹œíŠ¸ ë¡œë“œ (ì„ íƒì‚¬í•­ - ì—†ì–´ë„ ì—ëŸ¬ ë°œìƒí•˜ì§€ ì•ŠìŒ)
    let posCodeMappingResponse = null;
    try {
      posCodeMappingResponse = await sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: 'POSì½”ë“œë³€ê²½ì„¤ì •!A:H'
      });
      console.log('POSì½”ë“œë³€ê²½ì„¤ì • ì‹œíŠ¸ ë¡œë“œ ì„±ê³µ');
    } catch (error) {
      console.log('POSì½”ë“œë³€ê²½ì„¤ì • ì‹œíŠ¸ ë¡œë“œ ì‹¤íŒ¨ (ë¬´ì‹œë¨):', error.message);
      posCodeMappingResponse = { data: { values: null } };
    }

    if (!reservationResponse.data.values || !phoneklResponse.data.values || !yardResponse.data.values || !onSaleResponse.data.values) {
      throw new Error('ì‹œíŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    const reservationHeaders = reservationResponse.data.values[0];
    const reservationData = reservationResponse.data.values.slice(1);

    const phoneklHeaders = phoneklResponse.data.values[0];
    const phoneklData = phoneklResponse.data.values.slice(3); // í—¤ë”ê°€ 3í–‰ì´ë¯€ë¡œ 4í–‰ë¶€í„° ì‹œì‘

    const yardHeaders = yardResponse.data.values[0];
    const yardData = yardResponse.data.values.slice(1);

    const onSaleHeaders = onSaleResponse.data.values[0];
    const onSaleData = onSaleResponse.data.values.slice(1);

    const posCodeMappingHeaders = posCodeMappingResponse.data.values ? posCodeMappingResponse.data.values[0] : [];
    const posCodeMappingData = posCodeMappingResponse.data.values ? posCodeMappingResponse.data.values.slice(1) : [];

    // POSì½”ë“œ ë§¤í•‘ í…Œì´ë¸” ìƒì„± (ì ‘ìˆ˜ìë³„ ë§¤í•‘ ì§€ì›)
    const posCodeMapping = new Map();
    const posCodeMappingWithReceiver = new Map(); // ì ‘ìˆ˜ìë³„ ë§¤í•‘

    // POSëª… ë§¤í•‘ í…Œì´ë¸” ìƒì„± (ì ‘ìˆ˜ìë³„ ë§¤í•‘ ì§€ì›)
    const posNameMapping = new Map();
    const posNameMappingWithReceiver = new Map(); // ì ‘ìˆ˜ìë³„ ë§¤í•‘

    if (posCodeMappingData && posCodeMappingData.length > 0) {
      posCodeMappingData.forEach((row, index) => {
        // POSì½”ë“œ ë§¤í•‘ ì²˜ë¦¬
        const originalCode = row[0] || ''; // Aì—´: ì›ë³¸ POSì½”ë“œ
        const receiverCode = row[1] || ''; // Bì—´: ì ‘ìˆ˜ìëª… (POSì½”ë“œìš©)
        const mappedCode = row[2] || '';   // Cì—´: ë³€ê²½ë  POSì½”ë“œ
        const descriptionCode = row[3] || ''; // Dì—´: ì„¤ëª… (POSì½”ë“œìš©)

        if (originalCode && mappedCode) {
          if (receiverCode) {
            // ì ‘ìˆ˜ìë³„ ë§¤í•‘
            const key = `${originalCode}_${receiverCode}`;
            posCodeMappingWithReceiver.set(key, mappedCode);
            console.log(`POSì½”ë“œ ì ‘ìˆ˜ìë³„ ë§¤í•‘ ${index + 2}: ${key} -> ${mappedCode} (${descriptionCode})`);
          } else {
            // ì¼ë°˜ ë§¤í•‘
            posCodeMapping.set(originalCode, mappedCode);
            console.log(`POSì½”ë“œ ì¼ë°˜ ë§¤í•‘ ${index + 2}: ${originalCode} -> ${mappedCode} (${descriptionCode})`);
          }
        }

        // POSëª… ë§¤í•‘ ì²˜ë¦¬
        const originalName = row[4] || ''; // Eì—´: ì›ë³¸ POSëª…
        const receiverName = row[5] || ''; // Fì—´: ì ‘ìˆ˜ìëª… (POSëª…ìš©)
        const mappedName = row[6] || '';   // Gì—´: ë³€ê²½ë  POSëª…
        const descriptionName = row[7] || ''; // Hì—´: ì„¤ëª… (POSëª…ìš©)

        if (originalName && mappedName) {
          if (receiverName) {
            // ì ‘ìˆ˜ìë³„ ë§¤í•‘
            const key = `${originalName}_${receiverName}`;
            posNameMappingWithReceiver.set(key, mappedName);
            console.log(`POSëª… ì ‘ìˆ˜ìë³„ ë§¤í•‘ ${index + 2}: ${key} -> ${mappedName} (${descriptionName})`);
          } else {
            // ì¼ë°˜ ë§¤í•‘
            posNameMapping.set(originalName, mappedName);
            console.log(`POSëª… ì¼ë°˜ ë§¤í•‘ ${index + 2}: ${originalName} -> ${mappedName} (${descriptionName})`);
          }
        }
      });

      console.log('ë§¤í•‘ í…Œì´ë¸” ìƒì„± ì™„ë£Œ:', {
        POSì½”ë“œ_ì¼ë°˜ë§¤í•‘: posCodeMapping.size,
        POSì½”ë“œ_ì ‘ìˆ˜ìë³„ë§¤í•‘: posCodeMappingWithReceiver.size,
        POSëª…_ì¼ë°˜ë§¤í•‘: posNameMapping.size,
        POSëª…_ì ‘ìˆ˜ìë³„ë§¤í•‘: posNameMappingWithReceiver.size
      });
    } else {
      console.log('ë§¤í•‘ í…Œì´ë¸”: ë§¤í•‘ ë°ì´í„° ì—†ìŒ (ì›ë³¸ ê°’ ê·¸ëŒ€ë¡œ ì‚¬ìš©)');
    }

    // ë‹´ë‹¹ì ì´ë¦„ ì •ê·œí™” í•¨ìˆ˜ (ê´„í˜¸ ì•ˆ ë¶€ì„œ ì •ë³´ ì œê±°)
    const normalizeAgentName = (agentName) => {
      if (!agentName) return '';
      // ê´„í˜¸ì™€ ê·¸ ì•ˆì˜ ë‚´ìš© ì œê±° (ì˜ˆ: í™ê¸°í˜„(ë³„ë„) -> í™ê¸°í˜„)
      return agentName.replace(/\([^)]*\)/g, '').trim();
    };

    // í°í´ì¶œê³ ì²˜ë°ì´í„°ì—ì„œ Pì—´(ë§¤ì¥ì½”ë“œ)ê³¼ Vì—´(ë‹´ë‹¹ì) ë§¤í•‘ ìƒì„±
    const storeAgentMap = new Map();
    const agentNormalizationMap = new Map(); // ì •ê·œí™”ëœ ì´ë¦„ -> ì›ë³¸ ì´ë¦„ ë§¤í•‘

    phoneklData.forEach(row => {
      const storeCode = row[15] || ''; // Pì—´ (16ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
      const agent = row[21] || ''; // Vì—´ (22ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
      if (storeCode && agent) {
        const normalizedAgent = normalizeAgentName(agent);

        // ì •ê·œí™”ëœ ì´ë¦„ìœ¼ë¡œ ë§¤í•‘ ì €ì¥
        storeAgentMap.set(storeCode, normalizedAgent);

        // ì •ê·œí™”ëœ ì´ë¦„ -> ì›ë³¸ ì´ë¦„ ë§¤í•‘ ì €ì¥ (ì²« ë²ˆì§¸ ë°œê²¬ëœ ì›ë³¸ ì´ë¦„ ì‚¬ìš©)
        if (!agentNormalizationMap.has(normalizedAgent)) {
          agentNormalizationMap.set(normalizedAgent, agent);
        }
      }
    });

    console.log('ë‹´ë‹¹ì ì •ê·œí™” ë§¤í•‘:', Object.fromEntries(agentNormalizationMap));

    // ë§ˆë‹¹ì ‘ìˆ˜ì—ì„œ ì˜ˆì•½ë²ˆí˜¸ ì¶”ì¶œ (ì •ê·œí‘œí˜„ì‹ ì‚¬ìš©)
    const yardReservationMap = new Set();
    yardData.forEach((row, index) => {
      const uValue = row[20] || ''; // Uì—´ (21ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
      const vValue = row[21] || ''; // Vì—´ (22ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)

      // ì˜ˆì•½ë²ˆí˜¸ íŒ¨í„´ ì°¾ê¸° (ì˜ˆ: PK590797, XJ766583 ë“±)
      const reservationPattern = /[A-Z]{2}\d{6}/g;
      const uMatches = uValue.match(reservationPattern) || [];
      const vMatches = vValue.match(reservationPattern) || [];

      // ëª¨ë“  ì˜ˆì•½ë²ˆí˜¸ë¥¼ Setì— ì¶”ê°€
      [...uMatches, ...vMatches].forEach(match => {
        yardReservationMap.add(match);
        // ì²˜ìŒ 5ê°œë§Œ ë””ë²„ê¹… ë¡œê·¸
        if (index < 5) {
          console.log(`ë§ˆë‹¹ì ‘ìˆ˜ í–‰ ${index + 2}: U=${uValue}, V=${vValue}, ì¶”ì¶œëœì˜ˆì•½ë²ˆí˜¸=${match}`);
        }
      });
    });

    console.log('ë§ˆë‹¹ì ‘ìˆ˜ ì˜ˆì•½ë²ˆí˜¸ ê°œìˆ˜:', yardReservationMap.size);
    console.log('ë§ˆë‹¹ì ‘ìˆ˜ ì˜ˆì•½ë²ˆí˜¸ ìƒ˜í”Œ:', Array.from(yardReservationMap).slice(0, 5));

    // ì˜¨ì„¸ì¼ ë°ì´í„° ì¸ë±ì‹± (ê³ ê°ëª… + ëŒ€ë¦¬ì ì½”ë“œ ê¸°ì¤€)
    const onSaleIndex = new Map();
    const unmatchedOnSaleData = [];
    let onSaleIndexCount = 0;

    onSaleData.forEach((row, index) => {
      const customerName = row[2] || ''; // Cì—´ (3ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
      const storeCode = row[12] || ''; // Mì—´ (13ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
      const receivedDate = row[5] || ''; // Fì—´ (6ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)

      if (customerName && storeCode) {
        const key = `${customerName}_${storeCode}`;
        onSaleIndex.set(key, receivedDate);
        onSaleIndexCount++;

        // ì²˜ìŒ 5ê°œë§Œ ë””ë²„ê¹… ë¡œê·¸
        if (index < 5) {
          console.log(`ì˜¨ì„¸ì¼ í–‰ ${index + 2}: ê³ ê°ëª…="${customerName}", ëŒ€ë¦¬ì ì½”ë“œ="${storeCode}", ì ‘ìˆ˜ì¼="${receivedDate}"`);
        }
      }
    });

    console.log('ì˜¨ì„¸ì¼ ë°ì´í„° ì¸ë±ì‹± ì™„ë£Œ:', onSaleIndex.size, 'ê°œ ê³ ê°-ëŒ€ë¦¬ì  ì¡°í•© (ì´', onSaleIndexCount, 'ê°œ ì²˜ë¦¬)');
    console.log('ì˜¨ì„¸ì¼ ë°ì´í„° ìƒ˜í”Œ:', Array.from(onSaleIndex.entries()).slice(0, 5));

    // ì˜¨ì„¸ì¼ ë§¤ì¹­ ì‹¤íŒ¨ ë°ì´í„° ìˆ˜ì§‘ (ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ì— ì—†ëŠ” ì˜¨ì„¸ì¼ ë°ì´í„°)
    onSaleData.forEach((row, index) => {
      const customerName = row[2] || ''; // Cì—´ (3ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
      const storeCode = row[12] || ''; // Mì—´ (13ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
      const receivedDate = row[5] || ''; // Fì—´ (6ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)

      if (customerName && storeCode) {
        // ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ì—ì„œ í•´ë‹¹ ê³ ê°ëª…+ëŒ€ë¦¬ì ì½”ë“œ ì¡°í•©ì´ ìˆëŠ”ì§€ í™•ì¸
        const isMatched = reservationData.some(reservationRow => {
          const reservationCustomerName = (reservationRow[7] || '').toString().trim(); // Hì—´: ê³ ê°ëª…
          const reservationStoreCode = (reservationRow[23] || '').toString().trim(); // Xì—´: ëŒ€ë¦¬ì ì½”ë“œ
          return reservationCustomerName === customerName && reservationStoreCode === storeCode;
        });

        if (!isMatched) {
          unmatchedOnSaleData.push({
            customerName,
            storeCode,
            receivedDate,
            key: `${customerName}_${storeCode}`
          });
        }
      }
    });

    console.log('ì˜¨ì„¸ì¼ ë§¤ì¹­ ì‹¤íŒ¨ ë°ì´í„°:', unmatchedOnSaleData.length, 'ê±´');
    if (unmatchedOnSaleData.length > 0) {
      console.log('ì˜¨ì„¸ì¼ ë§¤ì¹­ ì‹¤íŒ¨ ìƒ˜í”Œ:', unmatchedOnSaleData.slice(0, 5));
    }

    // ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ë°ì´í„° ì²˜ë¦¬
    const processedData = reservationData.map((row, index) => {
      const posName = row[22] || ''; // Wì—´ (23ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
      const storeCode = row[23] || ''; // Xì—´ (24ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
      const reservationNumber = row[8] || ''; // Iì—´ (9ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
      const storeCodeForLookup = row[21] || ''; // Vì—´ (22ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
      const receiver = row[25] || ''; // Zì—´ (26ë²ˆì§¸, 0ë¶€í„° ì‹œì‘): ì ‘ìˆ˜ìëª…

      // POSì½”ë“œ ë§¤í•‘ ì ìš© (ì ‘ìˆ˜ìë³„ ë§¤í•‘ ìš°ì„ , ì¼ë°˜ ë§¤í•‘ ì°¨ì„ )
      let mappedStoreCode = storeCodeForLookup;
      const receiverKey = `${storeCodeForLookup}_${receiver}`;

      if (posCodeMappingWithReceiver.has(receiverKey)) {
        mappedStoreCode = posCodeMappingWithReceiver.get(receiverKey);
        console.log(`POSì½”ë“œ ì ‘ìˆ˜ìë³„ ë§¤í•‘ ì ìš©: ${storeCodeForLookup}(${receiver}) -> ${mappedStoreCode}`);
      } else if (posCodeMapping.has(storeCodeForLookup)) {
        mappedStoreCode = posCodeMapping.get(storeCodeForLookup);
        console.log(`POSì½”ë“œ ì¼ë°˜ ë§¤í•‘ ì ìš©: ${storeCodeForLookup} -> ${mappedStoreCode}`);
      }

      // POSëª… ë§¤í•‘ ì ìš© (ì ‘ìˆ˜ìë³„ ë§¤í•‘ ìš°ì„ , ì¼ë°˜ ë§¤í•‘ ì°¨ì„ )
      let mappedPosName = posName;
      const posNameReceiverKey = `${posName}_${receiver}`;

      if (posNameMappingWithReceiver.has(posNameReceiverKey)) {
        mappedPosName = posNameMappingWithReceiver.get(posNameReceiverKey);
        console.log(`POSëª… ì ‘ìˆ˜ìë³„ ë§¤í•‘ ì ìš©: ${posName}(${receiver}) -> ${mappedPosName}`);
      } else if (posNameMapping.has(posName)) {
        mappedPosName = posNameMapping.get(posName);
        console.log(`POSëª… ì¼ë°˜ ë§¤í•‘ ì ìš©: ${posName} -> ${mappedPosName}`);
      }

      // ë‹´ë‹¹ì ë§¤ì¹­ (ë§¤í•‘ëœ POSì½”ë“œ ì‚¬ìš©)
      let agent = storeAgentMap.get(mappedStoreCode) || '';

      // ì„œë¥˜ì ‘ìˆ˜ ìƒíƒœ í™•ì¸ (ë§ˆë‹¹ì ‘ìˆ˜ OR ì˜¨ì„¸ì¼ ì ‘ìˆ˜)
      const normalizedReservationNumber = reservationNumber.replace(/-/g, '');
      const customerName = (row[7] || '').toString().trim(); // Hì—´: ê³ ê°ëª…

      const isYardReceived = yardReservationMap.has(normalizedReservationNumber);
      const isOnSaleReceived = onSaleIndex.has(`${customerName}_${storeCode}`);
      const isDocumentReceived = isYardReceived || isOnSaleReceived;

      // ë””ë²„ê¹…ìš© ë¡œê·¸ (ì²˜ìŒ 10ê°œë§Œ)
      if (index < 10) {
        console.log(`ì‚¬ì „ì˜ˆì•½ í–‰ ${index + 2}: ì˜ˆì•½ë²ˆí˜¸=${reservationNumber}, ì •ê·œí™”=${normalizedReservationNumber}, ë§ˆë‹¹ì ‘ìˆ˜=${isYardReceived}, ì˜¨ì„¸ì¼ì ‘ìˆ˜=${isOnSaleReceived}, ìµœì¢…ì ‘ìˆ˜=${isDocumentReceived}, ë‹´ë‹¹ì=${agent}`);
      }

      return {
        rowIndex: index + 2,
        posName: mappedPosName, // ë§¤í•‘ëœ POSëª… ì‚¬ìš©
        storeName: mappedPosName, // í´ë¼ì´ì–¸íŠ¸ í˜¸í™˜ì„±
        storeCode,
        reservationNumber,
        storeCodeForLookup,
        agent,
        isDocumentReceived,
        originalRow: row
      };
    });

    console.log('ì´ ì²˜ë¦¬ëœ ë°ì´í„°:', processedData.length);
    console.log('ì„œë¥˜ì ‘ìˆ˜ëœ ë°ì´í„°:', processedData.filter(item => item.isDocumentReceived).length);

    // ì„œë¥˜ì ‘ìˆ˜ ë§¤ì¹­ ìƒì„¸ ë¶„ì„
    const receivedItems = processedData.filter(item => item.isDocumentReceived);
    const notReceivedItems = processedData.filter(item => !item.isDocumentReceived);

    console.log('ì„œë¥˜ì ‘ìˆ˜ëœ í•­ëª© ìƒ˜í”Œ:', receivedItems.slice(0, 3).map(item => ({
      ì˜ˆì•½ë²ˆí˜¸: item.reservationNumber,
      ì •ê·œí™”: item.reservationNumber.replace(/-/g, ''),
      ë‹´ë‹¹ì: item.agent,
      POSëª…: item.posName
    })));

    console.log('ì„œë¥˜ë¯¸ì ‘ìˆ˜ í•­ëª© ìƒ˜í”Œ:', notReceivedItems.slice(0, 3).map(item => ({
      ì˜ˆì•½ë²ˆí˜¸: item.reservationNumber,
      ì •ê·œí™”: item.reservationNumber.replace(/-/g, ''),
      ë‹´ë‹¹ì: item.agent,
      POSëª…: item.posName
    })));

    // ë§¤ì¹­ ì‹¤íŒ¨ í†µê³„ ë¶„ì„
    const matchingFailures = processedData.filter(item => !item.agent);
    const failureStats = {};
    const failureByPosCode = {};

    matchingFailures.forEach(item => {
      const posCode = item.storeCodeForLookup;
      const posName = item.posName;

      // POSì½”ë“œë³„ ì‹¤íŒ¨ í†µê³„
      failureStats[posCode] = (failureStats[posCode] || 0) + 1;

      // POSëª…ë³„ ì‹¤íŒ¨ í†µê³„
      if (!failureByPosCode[posCode]) {
        failureByPosCode[posCode] = {
          posName: posName,
          count: 0,
          items: []
        };
      }
      failureByPosCode[posCode].count++;
      failureByPosCode[posCode].items.push({
        reservationNumber: item.reservationNumber,
        customerName: item.originalRow[7] || '',
        receiver: item.originalRow[25] || ''
      });
    });

    console.log('ë§¤ì¹­ ì‹¤íŒ¨ í†µê³„:', {
      ì´ì‹¤íŒ¨ê±´ìˆ˜: matchingFailures.length,
      ì‹¤íŒ¨ìœ¨: ((matchingFailures.length / processedData.length) * 100).toFixed(1) + '%',
      ì‹¤íŒ¨POSì½”ë“œìˆ˜: Object.keys(failureStats).length,
      ìƒìœ„ì‹¤íŒ¨POSì½”ë“œ: Object.entries(failureStats)
        .sort(([, a], [, b]) => b - a)
        .slice(0, 10)
        .map(([code, count]) => ({ code, count }))
    });

    // ëŒ€ë¦¬ì ì½”ë“œë³„ë¡œ ê·¸ë£¹í™”
    const groupedByStore = {};
    processedData.forEach(item => {
      if (item.storeCode) {
        if (!groupedByStore[item.storeCode]) {
          groupedByStore[item.storeCode] = [];
        }
        groupedByStore[item.storeCode].push(item);
      }
    });

    // ëŒ€ë¦¬ì ì½”ë“œë³„ë¡œ ë‹´ë‹¹ìë³„ ê·¸ë£¹í™” ë° ì¹´ìš´íŒ…
    const groupedByStoreWithAgent = {};

    Object.keys(groupedByStore).forEach(storeCode => {
      const storeData = groupedByStore[storeCode];
      groupedByStoreWithAgent[storeCode] = {};

      storeData.forEach(item => {
        const agent = item.agent || 'ë¯¸ë°°ì •';

        if (!groupedByStoreWithAgent[storeCode][agent]) {
          groupedByStoreWithAgent[storeCode][agent] = {
            received: 0,
            notReceived: 0,
            total: 0,
            items: []
          };
        }

        // ì„œë¥˜ì ‘ìˆ˜ ìƒíƒœì— ë”°ë¼ ì¹´ìš´íŒ…
        if (item.isDocumentReceived) {
          groupedByStoreWithAgent[storeCode][agent].received++;
        } else {
          groupedByStoreWithAgent[storeCode][agent].notReceived++;
        }

        groupedByStoreWithAgent[storeCode][agent].total++;
        groupedByStoreWithAgent[storeCode][agent].items.push(item);
      });
    });

    // ë‹´ë‹¹ìë³„ë¡œ ê·¸ë£¹í™”í•˜ê³  POSëª…ë³„ë¡œ ì„œë¸Œ ê·¸ë£¹í™”
    const groupedByAgent = {};

    // ëª¨ë“  ë°ì´í„°ë¥¼ ë‹´ë‹¹ìë³„ë¡œ ê·¸ë£¹í™” (ì •ê·œí™”ëœ ì´ë¦„ ì‚¬ìš©)
    processedData.forEach(item => {
      const agent = item.agent || 'ë¯¸ë°°ì •';
      const posName = item.posName || 'ë¯¸ì§€ì •';

      if (!groupedByAgent[agent]) {
        groupedByAgent[agent] = {};
      }

      if (!groupedByAgent[agent][posName]) {
        groupedByAgent[agent][posName] = {
          received: 0,
          notReceived: 0,
          total: 0,
          items: []
        };
      }

      // ì„œë¥˜ì ‘ìˆ˜ ìƒíƒœì— ë”°ë¼ ì¹´ìš´íŒ…
      if (item.isDocumentReceived) {
        groupedByAgent[agent][posName].received++;
      } else {
        groupedByAgent[agent][posName].notReceived++;
      }

      groupedByAgent[agent][posName].total++;
      groupedByAgent[agent][posName].items.push(item);
    });

    // ë””ë²„ê¹…ìš©: ë‹´ë‹¹ìë³„ POS ê°œìˆ˜ í™•ì¸
    Object.entries(groupedByAgent).forEach(([agent, agentData]) => {
      const totalItems = Object.values(agentData).reduce((sum, posData) => sum + posData.total, 0);
      const totalReceived = Object.values(agentData).reduce((sum, posData) => sum + posData.received, 0);
      console.log(`${agent} ë‹´ë‹¹ì: ${Object.keys(agentData).length}ê°œ POS, ì´ ${totalItems}ê±´, ì ‘ìˆ˜ ${totalReceived}ê±´`);

      // POSëª… ìƒì„¸ ë¡œê·¸ (ì²˜ìŒ 10ê°œë§Œ)
      const posNames = Object.keys(agentData);
      console.log(`  POSëª… ëª©ë¡: ${posNames.slice(0, 10).join(', ')}${posNames.length > 10 ? `... (ì´ ${posNames.length}ê°œ)` : ''}`);

      // ì„œë¥˜ì ‘ìˆ˜ ìƒì„¸ ë¡œê·¸
      posNames.slice(0, 5).forEach(posName => {
        const posData = agentData[posName];
        console.log(`    ${posName}: ì ‘ìˆ˜ ${posData.received}, ë¯¸ì ‘ìˆ˜ ${posData.notReceived}, ì´ ${posData.total}`);
      });
    });

    const result = {
      success: true,
      data: {
        byStore: groupedByStoreWithAgent,
        byAgent: groupedByAgent
      },
      stats: {
        totalStores: Object.keys(groupedByStore).length,
        totalAgents: Object.keys(groupedByAgent).length,
        totalItems: processedData.length,
        totalWithAgent: processedData.filter(item => item.agent).length,
        totalDocumentReceived: processedData.filter(item => item.isDocumentReceived).length,
        matchingSuccessRate: ((processedData.filter(item => item.agent).length / processedData.length) * 100).toFixed(1)
      },
      matchingFailures: {
        totalFailures: matchingFailures.length,
        failureRate: ((matchingFailures.length / processedData.length) * 100).toFixed(1),
        failureByPosCode: failureByPosCode,
        topFailurePosCodes: Object.entries(failureStats)
          .sort(([, a], [, b]) => b - a)
          .slice(0, 10)
          .map(([code, count]) => ({ code, count, posName: failureByPosCode[code]?.posName || '' }))
      },
      unmatchedOnSaleData: unmatchedOnSaleData // ì˜¨ì„¸ì¼ ë§¤ì¹­ ì‹¤íŒ¨ ë°ì´í„° ì¶”ê°€
    };

    // ìºì‹œì— ì €ì¥ (10ë¶„)
    cacheUtils.set(cacheKey, result, 10 * 60 * 1000);

    res.json(result);
  } catch (error) {
    console.error('íŒë§¤ì²˜ë³„ì •ë¦¬ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to load sales by store data',
      message: error.message
    });
  }
});

// ë‹´ë‹¹ìë³„ ê³ ê° ë¦¬ìŠ¤íŠ¸ API
app.get('/api/reservation-sales/customer-list/by-agent/:agentName', async (req, res) => {
  try {
    const { agentName } = req.params;
    console.log(`ë‹´ë‹¹ìë³„ ê³ ê° ë¦¬ìŠ¤íŠ¸ ìš”ì²­: ${agentName}`);

    // ìºì‹œ í‚¤ ìƒì„±
    const cacheKey = `agent_customer_list_${agentName}`;

    // ìºì‹œì—ì„œ ë¨¼ì € í™•ì¸ (5ë¶„ TTL)
    const cachedData = cacheUtils.get(cacheKey);
    if (cachedData) {
      console.log(`ìºì‹œëœ ë‹´ë‹¹ìë³„ ê³ ê° ë¦¬ìŠ¤íŠ¸ ë°˜í™˜: ${agentName}`);
      return res.json(cachedData);
    }

    // 1. ì •ê·œí™”ëœ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ìºì‹œ í™œìš©)
    const normalizedCacheKey = 'normalized_data_cache';
    let normalizedData = cacheUtils.get(normalizedCacheKey);

    if (!normalizedData) {
      const normalizedResponse = await fetch(`${process.env.REACT_APP_API_URL || 'http://localhost:4000'}/api/reservation-settings/normalized-data`);
      if (!normalizedResponse.ok) {
        throw new Error('ì •ê·œí™”ëœ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      }
      normalizedData = await normalizedResponse.json();

      if (!normalizedData.success) {
        throw new Error('ì •ê·œí™”ëœ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨');
      }

      // ì •ê·œí™” ë°ì´í„° ìºì‹± (10ë¶„ TTL)
      cacheUtils.set(normalizedCacheKey, normalizedData, 600);
    }

    // 2. ë³‘ë ¬ë¡œ ì‹œíŠ¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì˜¨ì„¸ì¼, ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ í¬í•¨)
    const [reservationSiteValues, yardValues, onSaleValues, mobileJoinValues] = await Promise.all([
      getSheetValues('ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸'),
      getSheetValues('ë§ˆë‹¹ì ‘ìˆ˜'),
      getSheetValues('ì˜¨ì„¸ì¼'),
      getSheetValues('ëª¨ë°”ì¼ê°€ì…ë‚´ì—­')
    ]);

    // 3. POSì½”ë“œë³€ê²½ì„¤ì • ì‹œíŠ¸ ë¡œë“œ (ì„ íƒì‚¬í•­ - ì—†ì–´ë„ ì—ëŸ¬ ë°œìƒí•˜ì§€ ì•ŠìŒ)
    let posCodeMappingValues = null;
    try {
      posCodeMappingValues = await getSheetValues('POSì½”ë“œë³€ê²½ì„¤ì •');
      console.log('ë‹´ë‹¹ìë³„ ê³ ê°ë¦¬ìŠ¤íŠ¸: POSì½”ë“œë³€ê²½ì„¤ì • ì‹œíŠ¸ ë¡œë“œ ì„±ê³µ');
    } catch (error) {
      console.log('ë‹´ë‹¹ìë³„ ê³ ê°ë¦¬ìŠ¤íŠ¸: POSì½”ë“œë³€ê²½ì„¤ì • ì‹œíŠ¸ ë¡œë“œ ì‹¤íŒ¨ (ë¬´ì‹œë¨):', error.message);
      posCodeMappingValues = [];
    }

    if (!reservationSiteValues || reservationSiteValues.length < 2) {
      throw new Error('ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    if (!yardValues || yardValues.length < 2) {
      throw new Error('ë§ˆë‹¹ì ‘ìˆ˜ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    if (!onSaleValues || onSaleValues.length < 2) {
      throw new Error('ì˜¨ì„¸ì¼ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    if (!mobileJoinValues || mobileJoinValues.length < 2) {
      console.log('ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ë¬´ì‹œë¨)');
    }

    // 4. ì •ê·œí™” ê·œì¹™ ë§¤í•‘ ìƒì„±
    const normalizationRules = normalizedData.normalizationRules || [];
    const ruleMap = new Map();

    normalizationRules.forEach(rule => {
      const key = rule.reservationSite.replace(/\s+/g, '');
      ruleMap.set(key, rule.normalizedModel);
    });

    // 5. POSì½”ë“œ ë§¤í•‘ í…Œì´ë¸” ìƒì„± (ì ‘ìˆ˜ìë³„ ë§¤í•‘ ì§€ì›)
    const posCodeMapping = new Map();
    const posCodeMappingWithReceiver = new Map(); // ì ‘ìˆ˜ìë³„ ë§¤í•‘

    // POSëª… ë§¤í•‘ í…Œì´ë¸” ìƒì„± (ì ‘ìˆ˜ìë³„ ë§¤í•‘ ì§€ì›)
    const posNameMapping = new Map();
    const posNameMappingWithReceiver = new Map(); // ì ‘ìˆ˜ìë³„ ë§¤í•‘

    if (posCodeMappingValues && posCodeMappingValues.length > 1) {
      const posCodeMappingData = posCodeMappingValues.slice(1);

      posCodeMappingData.forEach((row, index) => {
        // POSì½”ë“œ ë§¤í•‘ ì²˜ë¦¬
        const originalCode = row[0] || ''; // Aì—´: ì›ë³¸ POSì½”ë“œ
        const receiverCode = row[1] || ''; // Bì—´: ì ‘ìˆ˜ìëª… (POSì½”ë“œìš©)
        const mappedCode = row[2] || '';   // Cì—´: ë³€ê²½ë  POSì½”ë“œ
        const descriptionCode = row[3] || ''; // Dì—´: ì„¤ëª… (POSì½”ë“œìš©)

        if (originalCode && mappedCode) {
          if (receiverCode) {
            // ì ‘ìˆ˜ìë³„ ë§¤í•‘
            const key = `${originalCode}_${receiverCode}`;
            posCodeMappingWithReceiver.set(key, mappedCode);
          } else {
            // ì¼ë°˜ ë§¤í•‘
            posCodeMapping.set(originalCode, mappedCode);
          }
        }

        // POSëª… ë§¤í•‘ ì²˜ë¦¬
        const originalName = row[4] || ''; // Eì—´: ì›ë³¸ POSëª…
        const receiverName = row[5] || ''; // Fì—´: ì ‘ìˆ˜ìëª… (POSëª…ìš©)
        const mappedName = row[6] || '';   // Gì—´: ë³€ê²½ë  POSëª…
        const descriptionName = row[7] || ''; // Hì—´: ì„¤ëª… (POSëª…ìš©)

        if (originalName && mappedName) {
          if (receiverName) {
            // ì ‘ìˆ˜ìë³„ ë§¤í•‘
            const key = `${originalName}_${receiverName}`;
            posNameMappingWithReceiver.set(key, mappedName);
          } else {
            // ì¼ë°˜ ë§¤í•‘
            posNameMapping.set(originalName, mappedName);
          }
        }
      });

      console.log('ë‹´ë‹¹ìë³„ ê³ ê°ë¦¬ìŠ¤íŠ¸: POSì½”ë“œ ë§¤í•‘ í…Œì´ë¸” ìƒì„± ì™„ë£Œ:', {
        POSì½”ë“œ_ì¼ë°˜ë§¤í•‘: posCodeMapping.size,
        POSì½”ë“œ_ì ‘ìˆ˜ìë³„ë§¤í•‘: posCodeMappingWithReceiver.size,
        POSëª…_ì¼ë°˜ë§¤í•‘: posNameMapping.size,
        POSëª…_ì ‘ìˆ˜ìë³„ë§¤í•‘: posNameMappingWithReceiver.size
      });
    } else {
      console.log('ë‹´ë‹¹ìë³„ ê³ ê°ë¦¬ìŠ¤íŠ¸: POSì½”ë“œ ë§¤í•‘ í…Œì´ë¸”: ë§¤í•‘ ë°ì´í„° ì—†ìŒ (ì›ë³¸ ê°’ ê·¸ëŒ€ë¡œ ì‚¬ìš©)');
    }

    // 6. ë‹´ë‹¹ì ë§¤í•‘ ìƒì„±
    const storeAgentMap = new Map();
    const normalizeAgentName = (agentName) => {
      if (!agentName) return '';
      return agentName.replace(/\([^)]*\)/g, '').trim();
    };

    onSaleValues.slice(1).forEach(row => {
      const storeCode = row[12] || ''; // Lì—´ (13ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
      const agent = row[2] || ''; // Cì—´ (3ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
      if (storeCode && agent) {
        const normalizedAgent = normalizeAgentName(agent);
        storeAgentMap.set(storeCode, normalizedAgent);
      }
    });

    // 5. ë§ˆë‹¹ì ‘ìˆ˜ ë°ì´í„° ì¸ë±ì‹± (ì˜ˆì•½ë²ˆí˜¸ë³„ ë¹ ë¥¸ ê²€ìƒ‰ì„ ìœ„í•´)
    const yardIndex = new Map();
    let yardIndexCount = 0;
    yardValues.slice(1).forEach((yardRow, index) => {
      if (yardRow.length >= 22) { // Vì—´ê¹Œì§€ í•„ìš”í•˜ë¯€ë¡œ ìµœì†Œ 22ê°œ ì»¬ëŸ¼
        const uValue = (yardRow[20] || '').toString().trim(); // Uì—´ (21ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
        const vValue = (yardRow[21] || '').toString().trim(); // Vì—´ (22ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
        const receivedDateTime = (yardRow[11] || '').toString().trim(); // Lì—´ (12ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
        const receivedMemo = (yardRow[20] || '').toString().trim(); // Uì—´ (21ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)

        // ì˜ˆì•½ë²ˆí˜¸ íŒ¨í„´ ì°¾ê¸° (í•˜ì´í”ˆì´ ì—†ëŠ” í˜•íƒœ: XX000000)
        const reservationPattern = /[A-Z]{2}\d{6}/g;
        const uMatches = uValue.match(reservationPattern) || [];
        const vMatches = vValue.match(reservationPattern) || [];

        // ëª¨ë“  ì˜ˆì•½ë²ˆí˜¸ë¥¼ ì¸ë±ìŠ¤ì— ì¶”ê°€ (ì´ë¯¸ í•˜ì´í”ˆì´ ì—†ëŠ” í˜•íƒœ)
        [...uMatches, ...vMatches].forEach(match => {
          const normalizedReservationNumber = match;
          yardIndex.set(normalizedReservationNumber, {
            receivedDateTime,
            receivedMemo
          });
          yardIndexCount++;

          // ì²˜ìŒ 5ê°œ ë§ˆë‹¹ì ‘ìˆ˜ ë°ì´í„° ë¡œê·¸
          if (index < 5) {
            console.log(`ë‹´ë‹¹ìë³„ ë§ˆë‹¹ì ‘ìˆ˜ ì¸ë±ì‹±: ì›ë³¸="${match}" -> ì •ê·œí™”="${normalizedReservationNumber}"`);
            console.log(`  Uì—´: "${uValue}", Vì—´: "${vValue}"`);
            console.log(`  ì ‘ìˆ˜ì¼ì‹œ: "${receivedDateTime}", ì ‘ìˆ˜ë©”ëª¨: "${receivedMemo}"`);
          }
        });
      }
    });

    console.log(`ë‹´ë‹¹ìë³„ ë§ˆë‹¹ì ‘ìˆ˜ ë°ì´í„° ì¸ë±ì‹± ì™„ë£Œ: ${yardIndex.size}ê°œ ì˜ˆì•½ë²ˆí˜¸ (ì´ ${yardIndexCount}ê°œ ì²˜ë¦¬)`);
    console.log(`ë‹´ë‹¹ìë³„ ë§ˆë‹¹ì ‘ìˆ˜ ì˜ˆì•½ë²ˆí˜¸ ìƒ˜í”Œ:`, Array.from(yardIndex.keys()).slice(0, 5));

    // 6. ì˜¨ì„¸ì¼ ë°ì´í„° ì¸ë±ì‹± (ê³ ê°ëª…+ëŒ€ë¦¬ì ì½”ë“œë³„ ë¹ ë¥¸ ê²€ìƒ‰ì„ ìœ„í•´)
    const onSaleIndex = new Map();
    onSaleValues.slice(1).forEach(row => {
      if (row.length >= 13) { // Lì—´ê¹Œì§€ í•„ìš”í•˜ë¯€ë¡œ ìµœì†Œ 13ê°œ ì»¬ëŸ¼
        const customerName = (row[1] || '').toString().trim(); // Bì—´ (2ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
        const storeCode = (row[12] || '').toString().trim(); // Lì—´ (13ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
        const receivedDate = (row[0] || '').toString().trim(); // Aì—´ (1ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)

        if (customerName && storeCode) {
          const key = `${customerName}_${storeCode}`;
          onSaleIndex.set(key, receivedDate);
        }
      }
    });

    console.log(`ë‹´ë‹¹ìë³„ ì˜¨ì„¸ì¼ ë°ì´í„° ì¸ë±ì‹± ì™„ë£Œ: ${onSaleIndex.size}ê°œ ê³ ê°-ëŒ€ë¦¬ì  ì¡°í•©`);

    // 6-1. ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ ë°ì´í„° ì¸ë±ì‹± (ì˜ˆì•½ë²ˆí˜¸ ê¸°ì¤€)
    const mobileJoinIndex = new Map();
    let mobileJoinIndexCount = 0;

    if (mobileJoinValues && mobileJoinValues.length > 1) {
      mobileJoinValues.slice(1).forEach((row, index) => {
        const reservationNumber = (row[6] || '').toString().trim(); // Gì—´ (7ë²ˆì§¸, 0ë¶€í„° ì‹œì‘): ì˜ˆì•½ë²ˆí˜¸
        const reservationDateTime = (row[9] || '').toString().trim(); // Jì—´ (10ë²ˆì§¸, 0ë¶€í„° ì‹œì‘): ì˜ˆì•½ì¼ì‹œ

        if (reservationNumber) {
          // ì˜ˆì•½ë²ˆí˜¸ ì •ê·œí™” (í•˜ì´í”ˆ ì œê±°)
          const normalizedReservationNumber = reservationNumber.replace(/-/g, '');
          mobileJoinIndex.set(normalizedReservationNumber, reservationDateTime);
          mobileJoinIndexCount++;

          // ì²˜ìŒ 5ê°œë§Œ ë””ë²„ê¹… ë¡œê·¸
          if (index < 5) {
            console.log(`ë‹´ë‹¹ìë³„ ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ í–‰ ${index + 2}: ì˜ˆì•½ë²ˆí˜¸="${reservationNumber}", ì •ê·œí™”="${normalizedReservationNumber}", ì˜ˆì•½ì¼ì‹œ="${reservationDateTime}"`);
          }
        }
      });
    }

    console.log(`ë‹´ë‹¹ìë³„ ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ ë°ì´í„° ì¸ë±ì‹± ì™„ë£Œ: ${mobileJoinIndex.size}ê°œ ì˜ˆì•½ë²ˆí˜¸ (ì´ ${mobileJoinIndexCount}ê°œ ì²˜ë¦¬)`);

    // 7. ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ë°ì´í„° ì²˜ë¦¬ (ë‹´ë‹¹ìë³„ í•„í„°ë§)
    const reservationSiteRows = reservationSiteValues.slice(1);
    const customerList = [];

    reservationSiteRows.forEach((row, index) => {
      if (row.length < 30) return;

      const reservationNumber = (row[8] || '').toString().trim(); // Iì—´: ì˜ˆì•½ë²ˆí˜¸
      const customerName = (row[7] || '').toString().trim(); // Hì—´: ê³ ê°ëª…
      const reservationDateTime = (row[14] || '').toString().trim(); // Oì—´: ì˜ˆì•½ì¼ì‹œ
      const model = (row[15] || '').toString().trim(); // Pì—´: ëª¨ë¸
      const capacity = (row[16] || '').toString().trim(); // Qì—´: ìš©ëŸ‰
      const color = (row[17] || '').toString().trim(); // Rì—´: ìƒ‰ìƒ
      const type = (row[18] || '').toString().trim(); // Sì—´: ìœ í˜•
      const storeCode = (row[23] || '').toString().trim(); // Xì—´: ëŒ€ë¦¬ì ì½”ë“œ
      const posName = (row[22] || '').toString().trim(); // Wì—´: POSëª…
      const reservationMemo = (row[34] || '').toString().trim(); // AIì—´: ì˜ˆì•½ë©”ëª¨
      const receiver = (row[25] || '').toString().trim(); // Zì—´: ì ‘ìˆ˜ì
      const storeCodeForLookup = (row[21] || '').toString().trim(); // Vì—´: ëŒ€ë¦¬ì ì½”ë“œ(ì¡°íšŒìš©)

      if (!reservationNumber || !customerName || !model || !capacity || !color) return;

      // ë‹´ë‹¹ì ë§¤ì¹­ (VLOOKUP ë°©ì‹) - ì •ê·œí™”ëœ ì´ë¦„ ì‚¬ìš©
      const agent = storeAgentMap.get(storeCodeForLookup) || '';

      // ë‹´ë‹¹ì í•„í„°ë§
      if (normalizeAgentName(agent) !== agentName) return;

      // ì„œë¥˜ì ‘ìˆ˜ ì •ë³´ ì°¾ê¸° (ì¸ë±ìŠ¤ í™œìš©ìœ¼ë¡œ ë¹ ë¥¸ ê²€ìƒ‰)
      // ì˜ˆì•½ë²ˆí˜¸ë„ í•˜ì´í”ˆ ì œê±°í•˜ì—¬ ì •ê·œí™”ëœ í˜•íƒœë¡œ ë¹„êµ
      const normalizedReservationNumber = reservationNumber.replace(/-/g, '');
      const yardData = yardIndex.get(normalizedReservationNumber) || {};
      const receivedDateTime = yardData.receivedDateTime || '';
      const receivedMemo = yardData.receivedMemo || '';

      // ì²˜ìŒ 5ê°œ ê³ ê°ì˜ ì ‘ìˆ˜ì •ë³´ ë””ë²„ê¹… ë¡œê·¸
      if (index < 5) {
        console.log(`ë‹´ë‹¹ìë³„ ê³ ê°ë¦¬ìŠ¤íŠ¸ ì ‘ìˆ˜ì •ë³´ ë§¤ì¹­: ê³ ê°ëª…="${customerName}", ì˜ˆì•½ë²ˆí˜¸="${reservationNumber}"`);
        console.log(`  ì •ê·œí™”ëœ ì˜ˆì•½ë²ˆí˜¸: "${normalizedReservationNumber}"`);
        console.log(`  ë§ˆë‹¹ì ‘ìˆ˜ ì¸ë±ìŠ¤ ì¡´ì¬: ${yardIndex.has(normalizedReservationNumber)}`);
        console.log(`  ë§ˆë‹¹ì ‘ìˆ˜ì¼: "${receivedDateTime}"`);
        console.log(`  ë§ˆë‹¹ë©”ëª¨: "${receivedMemo}"`);
        console.log(`  ëª¨ë¸ëª…: "${model}"`);
        console.log(`  ë‹´ë‹¹ì: "${agent}"`);
      }

      // ì˜¨ì„¸ì¼ ì ‘ìˆ˜ì¼ ì°¾ê¸° (ì˜¨ì„¸ì¼ â†’ ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ ìˆœì„œë¡œ ì°¾ê¸°)
      const onSaleKey = `${customerName}_${storeCode}`;
      let onSaleReceivedDate = onSaleIndex.get(onSaleKey) || '';

      // ì˜¨ì„¸ì¼ì—ì„œ ì°¾ì§€ ëª»í•œ ê²½ìš° ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ì—ì„œ ì°¾ê¸°
      if (!onSaleReceivedDate && mobileJoinIndex.has(normalizedReservationNumber)) {
        onSaleReceivedDate = mobileJoinIndex.get(normalizedReservationNumber);
        if (index < 5) {
          console.log(`  ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ì—ì„œ ì˜¨ì„¸ì¼ì ‘ìˆ˜ì¼ ì°¾ìŒ: "${onSaleReceivedDate}"`);
        }
      }

      // POSëª… ë§¤í•‘ ì ìš© (ì ‘ìˆ˜ìë³„ ë§¤í•‘ ìš°ì„ , ì¼ë°˜ ë§¤í•‘ ì°¨ì„ )
      let mappedPosName = posName;
      if (posName && receiver) {
        // ì ‘ìˆ˜ìë³„ ë§¤í•‘ ë¨¼ì € í™•ì¸
        const receiverKey = `${posName}_${receiver}`;
        if (posNameMappingWithReceiver.has(receiverKey)) {
          mappedPosName = posNameMappingWithReceiver.get(receiverKey);
        } else if (posNameMapping.has(posName)) {
          // ì¼ë°˜ ë§¤í•‘ í™•ì¸
          mappedPosName = posNameMapping.get(posName);
        }
      } else if (posName && posNameMapping.has(posName)) {
        // ì¼ë°˜ ë§¤í•‘ë§Œ í™•ì¸
        mappedPosName = posNameMapping.get(posName);
      }

      // ëª¨ë¸/ìš©ëŸ‰/ìƒ‰ìƒ ì¡°í•©
      const modelCapacityColor = [model, capacity, color].filter(Boolean).join('/');

      customerList.push({
        customerName,
        reservationNumber,
        reservationDateTime,
        receivedDateTime,
        modelCapacityColor,
        type,
        storeCode,
        posName: mappedPosName, // ë§¤í•‘ëœ POSëª… ì‚¬ìš©
        reservationMemo,
        receivedMemo,
        receiver,
        agent,
        onSaleReceivedDate
      });
    });

    // 8. ì˜ˆì•½ì¼ì‹œë¡œ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬
    customerList.sort((a, b) => {
      const dateA = new Date(a.reservationDateTime);
      const dateB = new Date(b.reservationDateTime);
      return dateA - dateB;
    });

    console.log(`ë‹´ë‹¹ìë³„ ê³ ê° ë¦¬ìŠ¤íŠ¸ ìƒì„± ì™„ë£Œ: ${customerList.length}ê°œ ê³ ê°`);

    const result = {
      success: true,
      data: customerList,
      total: customerList.length,
      agentName: agentName
    };

    // ê²°ê³¼ ìºì‹± (5ë¶„ TTL)
    cacheUtils.set(cacheKey, result, 300);

    res.json(result);

  } catch (error) {
    console.error('ë‹´ë‹¹ìë³„ ê³ ê° ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to load customer list by agent',
      message: error.message
    });
  }
});

// ë‹´ë‹¹ìë³„ ëª¨ë¸/ìƒ‰ìƒ ë°ì´í„° API
app.get('/api/reservation-sales/model-color/by-agent/:agentName', async (req, res) => {
  try {
    const { agentName } = req.params;

    // 1. ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ë°ì´í„° ë¡œë“œ
    const reservationResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: 'ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸!A:AA'
    });

    // 2. í°í´ì¶œê³ ì²˜ë°ì´í„° ì‹œíŠ¸ ë¡œë“œ (ë‹´ë‹¹ì ë§¤ì¹­ìš©)
    const phoneklResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: 'í°í´ì¶œê³ ì²˜ë°ì´í„°!A:V'
    });

    if (!reservationResponse.data.values || !phoneklResponse.data.values) {
      throw new Error('ì‹œíŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    const reservationHeaders = reservationResponse.data.values[0];
    const reservationData = reservationResponse.data.values.slice(1);

    const phoneklHeaders = phoneklResponse.data.values[0];
    const phoneklData = phoneklResponse.data.values.slice(3); // í—¤ë”ê°€ 3í–‰ì´ë¯€ë¡œ 4í–‰ë¶€í„° ì‹œì‘

    // ë‹´ë‹¹ì ì´ë¦„ ì •ê·œí™” í•¨ìˆ˜
    const normalizeAgentName = (agentName) => {
      if (!agentName) return '';
      return agentName.replace(/\([^)]*\)/g, '').trim();
    };

    // í°í´ì¶œê³ ì²˜ë°ì´í„°ì—ì„œ Pì—´(ë§¤ì¥ì½”ë“œ)ê³¼ Vì—´(ë‹´ë‹¹ì) ë§¤í•‘ ìƒì„±
    const storeAgentMap = new Map();

    phoneklData.forEach(row => {
      const storeCode = row[15] || ''; // Pì—´ (16ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
      const agent = row[21] || ''; // Vì—´ (22ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
      if (storeCode && agent) {
        const normalizedAgent = normalizeAgentName(agent);
        storeAgentMap.set(storeCode, normalizedAgent);
      }
    });

    // í•´ë‹¹ ë‹´ë‹¹ìì˜ ëª¨ë¸/ìƒ‰ìƒ ë°ì´í„° í•„í„°ë§
    const modelColorData = reservationData
      .map((row, index) => {
        const reservationNumber = row[8] || ''; // Iì—´ (9ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
        const customerName = row[9] || ''; // Jì—´ (10ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
        const model = row[15] || ''; // Pì—´ (16ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
        const color = row[16] || ''; // Qì—´ (17ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
        const type = row[17] || ''; // Rì—´ (18ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
        const storeCodeForLookup = row[21] || ''; // Vì—´ (22ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
        const posName = row[22] || ''; // Wì—´ (23ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)

        // ë‹´ë‹¹ì ë§¤ì¹­
        const agent = storeAgentMap.get(storeCodeForLookup) || '';

        return {
          reservationNumber,
          customerName,
          model,
          color,
          type,
          storeCode: storeCodeForLookup,
          posName,
          agent,
          rowIndex: index + 2
        };
      })
      .filter(item => normalizeAgentName(item.agent) === agentName);

    res.json({
      success: true,
      data: modelColorData,
      stats: {
        totalItems: modelColorData.length,
        agentName: agentName
      }
    });
  } catch (error) {
    console.error('ë‹´ë‹¹ìë³„ ëª¨ë¸/ìƒ‰ìƒ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to load model-color data by agent',
      message: error.message
    });
  }
});

// ì „ì²´ ê³ ê°ë¦¬ìŠ¤íŠ¸ API
app.get('/api/reservation-sales/all-customers', async (req, res) => {
  try {
    console.log('ì „ì²´ ê³ ê°ë¦¬ìŠ¤íŠ¸ ìš”ì²­');

    // ìºì‹œ í™•ì¸
    const cacheKey = 'all_customer_list';
    const cachedData = cacheUtils.get(cacheKey);
    if (cachedData) {
      console.log('ìºì‹œëœ ì „ì²´ ê³ ê°ë¦¬ìŠ¤íŠ¸ ë°˜í™˜');
      // ìºì‹œ ì •ë³´ ì—…ë°ì´íŠ¸
      cachedData.stats.cacheInfo = {
        cached: true,
        timestamp: new Date().toISOString(),
        ttl: 300
      };
      return res.json(cachedData);
    }

    // 1. ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ë°ì´í„° ë¡œë“œ
    const reservationResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: 'ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸!A:AI'
    });

    // 2. ë§ˆë‹¹ì ‘ìˆ˜ ë°ì´í„° ë¡œë“œ
    const yardResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: 'ë§ˆë‹¹ì ‘ìˆ˜!A:AI'
    });

    // 3. ì˜¨ì„¸ì¼ ë°ì´í„° ë¡œë“œ
    const onSaleResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: 'ì˜¨ì„¸ì¼!A:AA'
    });

    // 3-1. ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ ë°ì´í„° ë¡œë“œ
    let mobileJoinResponse = null;
    try {
      mobileJoinResponse = await sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ëª¨ë°”ì¼ê°€ì…ë‚´ì—­!A:AA'
      });
      console.log('ì „ì²´ê³ ê°ë¦¬ìŠ¤íŠ¸: ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ ì‹œíŠ¸ ë¡œë“œ ì„±ê³µ');
    } catch (error) {
      console.log('ì „ì²´ê³ ê°ë¦¬ìŠ¤íŠ¸: ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ ì‹œíŠ¸ ë¡œë“œ ì‹¤íŒ¨ (ë¬´ì‹œë¨):', error.message);
      mobileJoinResponse = { data: { values: null } };
    }

    // 4. í°í´ì¶œê³ ì²˜ë°ì´í„° ì‹œíŠ¸ ë¡œë“œ (ë‹´ë‹¹ì ë§¤ì¹­ìš©)
    const storeResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: 'í°í´ì¶œê³ ì²˜ë°ì´í„°!A:V'
    });

    // 5. POSì½”ë“œë³€ê²½ì„¤ì • ì‹œíŠ¸ ë¡œë“œ (ì„ íƒì‚¬í•­ - ì—†ì–´ë„ ì—ëŸ¬ ë°œìƒí•˜ì§€ ì•ŠìŒ)
    let posCodeMappingResponse = null;
    try {
      posCodeMappingResponse = await sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: 'POSì½”ë“œë³€ê²½ì„¤ì •!A:J' // I, Jì—´ ì¶”ê°€ (ë‹´ë‹¹ì ë§¤í•‘ìš©)
      });
      console.log('ì „ì²´ê³ ê°ë¦¬ìŠ¤íŠ¸: POSì½”ë“œë³€ê²½ì„¤ì • ì‹œíŠ¸ ë¡œë“œ ì„±ê³µ');
    } catch (error) {
      console.log('ì „ì²´ê³ ê°ë¦¬ìŠ¤íŠ¸: POSì½”ë“œë³€ê²½ì„¤ì • ì‹œíŠ¸ ë¡œë“œ ì‹¤íŒ¨ (ë¬´ì‹œë¨):', error.message);
      posCodeMappingResponse = { data: { values: null } };
    }

    if (!reservationResponse.data.values || !yardResponse.data.values || !onSaleResponse.data.values || !storeResponse.data.values) {
      throw new Error('ì‹œíŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    const reservationHeaders = reservationResponse.data.values[0];
    const reservationData = reservationResponse.data.values.slice(1);

    const yardHeaders = yardResponse.data.values[0];
    const yardData = yardResponse.data.values.slice(1);

    const onSaleHeaders = onSaleResponse.data.values[0];
    const onSaleData = onSaleResponse.data.values.slice(1);

    // ë‹´ë‹¹ì ë§¤í•‘ í…Œì´ë¸” ìƒì„± (ë§¤ì¥ì½”ë“œ -> ë‹´ë‹¹ì)
    const managerMapping = new Map();
    const storeHeaders = storeResponse.data.values[0];
    const storeData = storeResponse.data.values.slice(3); // í—¤ë”ê°€ 3í–‰ì´ë¯€ë¡œ 4í–‰ë¶€í„° ì‹œì‘

    console.log(`í°í´ì¶œê³ ì²˜ë°ì´í„° ì´ í–‰ ìˆ˜: ${storeData.length}`);

    let processedRows = 0;
    let validRows = 0;
    let emptyStoreCode = 0;
    let emptyManager = 0;

    storeData.forEach((row, index) => {
      processedRows++;

      // ì²˜ìŒ 5ê°œ í–‰ì˜ ìƒì„¸ ë””ë²„ê¹…
      if (index < 5) {
        console.log(`=== í°í´ì¶œê³ ì²˜ë°ì´í„° ${index + 1}ë²ˆì§¸ í–‰ ë””ë²„ê¹… ===`);
        console.log(`í–‰ ê¸¸ì´: ${row.length}`);
        console.log(`Mì—´(12ë²ˆì¸ë±ìŠ¤): "${row[12] || ''}"`);
        console.log(`Pì—´(15ë²ˆì¸ë±ìŠ¤): "${row[15] || ''}"`);
        console.log(`Vì—´(21ë²ˆì¸ë±ìŠ¤): "${row[21] || ''}"`);
        console.log(`=== í°í´ì¶œê³ ì²˜ë°ì´í„° ë””ë²„ê¹… ë ===`);
      }

      if (row.length >= 22) { // Vì—´ê¹Œì§€ í•„ìš”
        const status = (row[12] || '').toString().trim(); // Mì—´: ì‚¬ìš©/ë¯¸ì‚¬ìš© ìƒíƒœ
        const storeCode = (row[15] || '').toString().trim(); // Pì—´: ë§¤ì¥ì½”ë“œ
        const manager = (row[21] || '').toString().trim(); // Vì—´: ë‹´ë‹¹ì

        if (!storeCode) {
          emptyStoreCode++;
        }
        if (!manager) {
          emptyManager++;
        }

        // Mì—´ ìƒíƒœê°€ "ì‚¬ìš©"ì¸ ê²½ìš°ì—ë§Œ ë§¤í•‘ (ë§¤ì¥ì½”ë“œ ì¤‘ë³µ ì²˜ë¦¬)
        if (storeCode && manager && status === "ì‚¬ìš©") {
          validRows++;
          // ë‹´ë‹¹ì ì´ë¦„ì—ì„œ ê´„í˜¸ ë¶€ë¶„ ì œê±° (ì˜ˆ: "í™ê¸°í˜„(ë³„ë„)" â†’ "í™ê¸°í˜„")
          const cleanManager = manager.replace(/\([^)]*\)/g, '').trim();
          managerMapping.set(storeCode, cleanManager);

          // ì²˜ìŒ 5ê°œ ìœ íš¨í•œ ë§¤í•‘ ë¡œê·¸
          if (validRows <= 5) {
            console.log(`ë§¤í•‘ ì¶”ê°€: "${storeCode}" -> "${cleanManager}" (ìƒíƒœ: ${status})`);
          }
        } else if (storeCode && manager && status !== "ì‚¬ìš©") {
          // ë¯¸ì‚¬ìš© ìƒíƒœì¸ ê²½ìš° ë¡œê·¸ ì¶œë ¥
          if (index < 10) {
            console.log(`ë¯¸ì‚¬ìš© ìƒíƒœë¡œ ì œì™¸: "${storeCode}" -> "${manager}" (ìƒíƒœ: ${status})`);
          }
        }
      }
    });

    console.log(`í°í´ì¶œê³ ì²˜ë°ì´í„° ì²˜ë¦¬ í†µê³„:`);
    console.log(`- ì´ ì²˜ë¦¬ëœ í–‰: ${processedRows}`);
    console.log(`- ìœ íš¨í•œ í–‰(22ì—´ ì´ìƒ): ${storeData.filter(row => row.length >= 22).length}`);
    console.log(`- ë§¤ì¥ì½”ë“œê°€ ìˆëŠ” í–‰: ${processedRows - emptyStoreCode}`);
    console.log(`- ë‹´ë‹¹ìê°€ ìˆëŠ” í–‰: ${processedRows - emptyManager}`);
    console.log(`- ìœ íš¨í•œ ë§¤í•‘: ${validRows}`);

    console.log(`ë‹´ë‹¹ì ë§¤í•‘ í…Œì´ë¸” ìƒì„± ì™„ë£Œ: ${managerMapping.size}ê°œ ë§¤ì¥-ë‹´ë‹¹ì ë§¤í•‘`);

    // ë””ë²„ê¹…: ë§¤í•‘ í…Œì´ë¸” ë‚´ìš© ì¶œë ¥ (ì²˜ìŒ 5ê°œë§Œ)
    console.log('=== ë‹´ë‹¹ì ë§¤í•‘ í…Œì´ë¸” ë””ë²„ê¹… ===');
    let debugCount = 0;
    for (const [storeCode, manager] of managerMapping) {
      if (debugCount < 5) {
        console.log(`ë§¤ì¥ì½”ë“œ: "${storeCode}" -> ë‹´ë‹¹ì: "${manager}"`);
        debugCount++;
      }
    }
    console.log('=== ë§¤í•‘ í…Œì´ë¸” ë””ë²„ê¹… ë ===');

    // POSì½”ë“œ ë§¤í•‘ í…Œì´ë¸” ìƒì„± (ì ‘ìˆ˜ìë³„ ë§¤í•‘ ì§€ì›)
    const posCodeMapping = new Map();
    const posCodeMappingWithReceiver = new Map(); // ì ‘ìˆ˜ìë³„ ë§¤í•‘

    // POSëª… ë§¤í•‘ í…Œì´ë¸” ìƒì„± (ì ‘ìˆ˜ìë³„ ë§¤í•‘ ì§€ì›)
    const posNameMapping = new Map();
    const posNameMappingWithReceiver = new Map(); // ì ‘ìˆ˜ìë³„ ë§¤í•‘

    const posCodeMappingHeaders = posCodeMappingResponse.data.values ? posCodeMappingResponse.data.values[0] : [];
    const posCodeMappingData = posCodeMappingResponse.data.values ? posCodeMappingResponse.data.values.slice(1) : [];

    if (posCodeMappingData && posCodeMappingData.length > 0) {
      posCodeMappingData.forEach((row, index) => {
        // POSì½”ë“œ ë§¤í•‘ ì²˜ë¦¬
        const originalCode = row[0] || ''; // Aì—´: ì›ë³¸ POSì½”ë“œ
        const receiverCode = row[1] || ''; // Bì—´: ì ‘ìˆ˜ìëª… (POSì½”ë“œìš©)
        const mappedCode = row[2] || '';   // Cì—´: ë³€ê²½ë  POSì½”ë“œ
        const descriptionCode = row[3] || ''; // Dì—´: ì„¤ëª… (POSì½”ë“œìš©)

        if (originalCode && mappedCode) {
          if (receiverCode) {
            // ì ‘ìˆ˜ìë³„ ë§¤í•‘
            const key = `${originalCode}_${receiverCode}`;
            posCodeMappingWithReceiver.set(key, mappedCode);
          } else {
            // ì¼ë°˜ ë§¤í•‘
            posCodeMapping.set(originalCode, mappedCode);
          }
        }

        // POSëª… ë§¤í•‘ ì²˜ë¦¬
        const originalName = row[4] || ''; // Eì—´: ì›ë³¸ POSëª…
        const receiverName = row[5] || ''; // Fì—´: ì ‘ìˆ˜ìëª… (POSëª…ìš©)
        const mappedName = row[6] || '';   // Gì—´: ë³€ê²½ë  POSëª…
        const descriptionName = row[7] || ''; // Hì—´: ì„¤ëª… (POSëª…ìš©)

        if (originalName && mappedName) {
          if (receiverName) {
            // ì ‘ìˆ˜ìë³„ ë§¤í•‘
            const key = `${originalName}_${receiverName}`;
            posNameMappingWithReceiver.set(key, mappedName);
          } else {
            // ì¼ë°˜ ë§¤í•‘
            posNameMapping.set(originalName, mappedName);
          }
        }
      });

      console.log('ì „ì²´ê³ ê°ë¦¬ìŠ¤íŠ¸: POSì½”ë“œ ë§¤í•‘ í…Œì´ë¸” ìƒì„± ì™„ë£Œ:', {
        POSì½”ë“œ_ì¼ë°˜ë§¤í•‘: posCodeMapping.size,
        POSì½”ë“œ_ì ‘ìˆ˜ìë³„ë§¤í•‘: posCodeMappingWithReceiver.size,
        POSëª…_ì¼ë°˜ë§¤í•‘: posNameMapping.size,
        POSëª…_ì ‘ìˆ˜ìë³„ë§¤í•‘: posNameMappingWithReceiver.size
      });
    } else {
      console.log('ì „ì²´ê³ ê°ë¦¬ìŠ¤íŠ¸: POSì½”ë“œ ë§¤í•‘ í…Œì´ë¸”: ë§¤í•‘ ë°ì´í„° ì—†ìŒ (ì›ë³¸ ê°’ ê·¸ëŒ€ë¡œ ì‚¬ìš©)');
    }

    // ì˜ˆì•½ë²ˆí˜¸ ì •ê·œí™” í•¨ìˆ˜
    const normalizeReservationNumber = (number) => {
      if (!number) return '';
      return number.toString().replace(/[-\s]/g, '').trim();
    };



    // ë§ˆë‹¹ì ‘ìˆ˜ ë°ì´í„° ì¸ë±ì‹± (ì˜ˆì•½ë²ˆí˜¸ ê¸°ì¤€)
    const yardIndex = new Map();
    let yardIndexCount = 0;

    yardData.forEach((row, index) => {
      if (row.length >= 22) { // Vì—´ê¹Œì§€ í•„ìš”í•˜ë¯€ë¡œ ìµœì†Œ 22ê°œ ì»¬ëŸ¼
        const uValue = (row[20] || '').toString().trim(); // Uì—´ (21ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
        const vValue = (row[21] || '').toString().trim(); // Vì—´ (22ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
        const receivedDate = (row[11] || '').toString().trim(); // Lì—´ (12ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
        const receivedMemo = (row[20] || '').toString().trim(); // Uì—´ (21ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
        const receiver = (row[24] || '').toString().trim(); // Yì—´ (25ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)

        // ì˜ˆì•½ë²ˆí˜¸ íŒ¨í„´ ì°¾ê¸° (í•˜ì´í”ˆì´ ì—†ëŠ” í˜•íƒœ: XX000000)
        const reservationPattern = /[A-Z]{2}\d{6}/g;
        const uMatches = uValue.match(reservationPattern) || [];
        const vMatches = vValue.match(reservationPattern) || [];

        // ëª¨ë“  ì˜ˆì•½ë²ˆí˜¸ë¥¼ ì¸ë±ìŠ¤ì— ì¶”ê°€ (ì´ë¯¸ í•˜ì´í”ˆì´ ì—†ëŠ” í˜•íƒœ)
        [...uMatches, ...vMatches].forEach(match => {
          const normalizedReservationNumber = match;
          yardIndex.set(normalizedReservationNumber, {
            receivedDate,
            receivedMemo,
            receiver
          });
          yardIndexCount++;

          // ì²˜ìŒ 5ê°œ ë§ˆë‹¹ì ‘ìˆ˜ ë°ì´í„° ë¡œê·¸
          if (index < 5) {
            console.log(`ì „ì²´ê³ ê°ë¦¬ìŠ¤íŠ¸ ë§ˆë‹¹ì ‘ìˆ˜ ì¸ë±ì‹±: ì›ë³¸="${match}" -> ì •ê·œí™”="${normalizedReservationNumber}"`);
            console.log(`  Uì—´: "${uValue}", Vì—´: "${vValue}"`);
            console.log(`  ì ‘ìˆ˜ì¼ì‹œ: "${receivedDate}", ì ‘ìˆ˜ë©”ëª¨: "${receivedMemo}"`);
          }
        });
      }
    });

    console.log(`ë§ˆë‹¹ì ‘ìˆ˜ ë°ì´í„° ì¸ë±ì‹± ì™„ë£Œ: ${yardIndex.size}ê°œ ì˜ˆì•½ë²ˆí˜¸ (ì´ ${yardIndexCount}ê°œ ì²˜ë¦¬)`);

    // ì˜¨ì„¸ì¼ ë°ì´í„° ì¸ë±ì‹± (ê³ ê°ëª… + ëŒ€ë¦¬ì ì½”ë“œ ê¸°ì¤€)
    const onSaleIndex = new Map();
    let onSaleIndexCount = 0;

    onSaleData.forEach(row => {
      const customerName = row[2] || ''; // Cì—´ (3ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
      const storeCode = row[12] || ''; // Mì—´ (13ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
      const receivedDate = row[5] || ''; // Fì—´ (6ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)

      if (customerName && storeCode) {
        const key = `${customerName}_${storeCode}`;
        onSaleIndex.set(key, receivedDate);
        onSaleIndexCount++;
      }
    });

    console.log(`ì˜¨ì„¸ì¼ ë°ì´í„° ì¸ë±ì‹± ì™„ë£Œ: ${onSaleIndex.size}ê°œ ê³ ê°-ëŒ€ë¦¬ì  ì¡°í•© (ì´ ${onSaleIndexCount}ê°œ ì²˜ë¦¬)`);

    // ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ ë°ì´í„° ì¸ë±ì‹± (ì˜ˆì•½ë²ˆí˜¸ ê¸°ì¤€)
    const mobileJoinIndex = new Map();
    let mobileJoinIndexCount = 0;

    if (mobileJoinResponse && mobileJoinResponse.data.values && mobileJoinResponse.data.values.length > 1) {
      const mobileJoinData = mobileJoinResponse.data.values.slice(1);
      mobileJoinData.forEach((row, index) => {
        const reservationNumber = (row[6] || '').toString().trim(); // Gì—´ (7ë²ˆì§¸, 0ë¶€í„° ì‹œì‘): ì˜ˆì•½ë²ˆí˜¸
        const reservationDateTime = (row[9] || '').toString().trim(); // Jì—´ (10ë²ˆì§¸, 0ë¶€í„° ì‹œì‘): ì˜ˆì•½ì¼ì‹œ

        if (reservationNumber) {
          // ì˜ˆì•½ë²ˆí˜¸ ì •ê·œí™” (í•˜ì´í”ˆ ì œê±°)
          const normalizedReservationNumber = reservationNumber.replace(/-/g, '');
          mobileJoinIndex.set(normalizedReservationNumber, reservationDateTime);
          mobileJoinIndexCount++;

          // ì²˜ìŒ 5ê°œë§Œ ë””ë²„ê¹… ë¡œê·¸
          if (index < 5) {
            console.log(`ì „ì²´ê³ ê°ë¦¬ìŠ¤íŠ¸ ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ í–‰ ${index + 2}: ì˜ˆì•½ë²ˆí˜¸="${reservationNumber}", ì •ê·œí™”="${normalizedReservationNumber}", ì˜ˆì•½ì¼ì‹œ="${reservationDateTime}"`);
          }
        }
      });
    }

    console.log(`ì „ì²´ê³ ê°ë¦¬ìŠ¤íŠ¸ ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ ë°ì´í„° ì¸ë±ì‹± ì™„ë£Œ: ${mobileJoinIndex.size}ê°œ ì˜ˆì•½ë²ˆí˜¸ (ì´ ${mobileJoinIndexCount}ê°œ ì²˜ë¦¬)`);

    // ì „ì²´ ê³ ê°ë¦¬ìŠ¤íŠ¸ ìƒì„±
    const customerList = reservationData.map((row, index) => {
      const reservationNumber = row[8] || ''; // Iì—´ (9ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
      const customerName = row[7] || ''; // Hì—´ (8ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
      const reservationDateTime = row[14] || ''; // Oì—´ (15ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
      const model = row[15] || ''; // Pì—´ (16ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
      const capacity = row[16] || ''; // Qì—´ (17ë²ˆì§¸, 0ë¶€í„° ì‹œì‘) - ìš©ëŸ‰
      const color = row[17] || ''; // Rì—´ (18ë²ˆì§¸, 0ë¶€í„° ì‹œì‘) - ìƒ‰ìƒ
      const type = row.length > 31 ? (row[31] || '') : ''; // AFì—´ (32ë²ˆì§¸, 0ë¶€í„° ì‹œì‘) - ìœ í˜•
      const reservationMemo = row.length > 34 ? (row[34] || '') : ''; // AIì—´ (35ë²ˆì§¸, 0ë¶€í„° ì‹œì‘) - ì‚¬ì´íŠ¸ë©”ëª¨
      const storeCode = row[23] || ''; // Xì—´ (24ë²ˆì§¸, 0ë¶€í„° ì‹œì‘) - ëŒ€ë¦¬ì  ì½”ë“œ
      const posName = row[22] || ''; // Wì—´ (23ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
      const receiver = row[25] || ''; // Zì—´ (26ë²ˆì§¸, 0ë¶€í„° ì‹œì‘) - ì ‘ìˆ˜ì

      // ë‹´ë‹¹ì ì •ë³´ ë§¤í•‘ (Vì—´ ë§¤ì¥ì½”ë“œ ê¸°ì¤€ + POSì½”ë“œ ë³€í™˜ ì ìš©)
      const originalManagerCode = row[21] || ''; // Vì—´ (22ë²ˆì§¸, 0ë¶€í„° ì‹œì‘) - ì›ë³¸ ë§¤ì¥ì½”ë“œ

      // POSì½”ë“œ ë³€í™˜ ì ìš© (ì ‘ìˆ˜ìë³„ ë§¤í•‘ ìš°ì„ , ì¼ë°˜ ë§¤í•‘ ì°¨ì„ )
      let mappedManagerCode = originalManagerCode;
      const managerCodeReceiverKey = `${originalManagerCode}_${receiver}`;

      if (posCodeMappingWithReceiver.has(managerCodeReceiverKey)) {
        mappedManagerCode = posCodeMappingWithReceiver.get(managerCodeReceiverKey);
        console.log(`ì „ì²´ê³ ê°ë¦¬ìŠ¤íŠ¸: ë§¤ì¥ì½”ë“œ ì ‘ìˆ˜ìë³„ ë§¤í•‘ ì ìš©: ${originalManagerCode}(${receiver}) -> ${mappedManagerCode}`);
      } else if (posCodeMapping.has(originalManagerCode)) {
        mappedManagerCode = posCodeMapping.get(originalManagerCode);
        console.log(`ì „ì²´ê³ ê°ë¦¬ìŠ¤íŠ¸: ë§¤ì¥ì½”ë“œ ì¼ë°˜ ë§¤í•‘ ì ìš©: ${originalManagerCode} -> ${mappedManagerCode}`);
      }

      // ë³€í™˜ëœ ë§¤ì¥ì½”ë“œë¡œ ë‹´ë‹¹ì ì°¾ê¸°
      const manager = managerMapping.get(mappedManagerCode) || '';

      // ë””ë²„ê¹…: ì²˜ìŒ 5ê°œ ê³ ê°ì˜ ë‹´ë‹¹ì ë§¤ì¹­ ê³¼ì • ì¶œë ¥
      if (index < 5) {
        console.log(`=== ë‹´ë‹¹ì ë§¤ì¹­ ë””ë²„ê¹… ${index + 1}ë²ˆì§¸ ê³ ê° ===`);
        console.log(`ê³ ê°ëª…: "${customerName}"`);
        console.log(`ì›ë³¸ ë§¤ì¥ì½”ë“œ(Vì—´): "${originalManagerCode}"`);
        console.log(`ë³€í™˜ëœ ë§¤ì¥ì½”ë“œ: "${mappedManagerCode}"`);
        console.log(`ë§¤ì¹­ëœ ë‹´ë‹¹ì: "${manager}"`);
        console.log(`ë§¤í•‘ í…Œì´ë¸”ì— ì¡´ì¬í•˜ëŠ”ê°€: ${managerMapping.has(mappedManagerCode)}`);
        console.log(`=== ë‹´ë‹¹ì ë§¤ì¹­ ë””ë²„ê¹… ë ===`);
      }

      // POSëª… ë§¤í•‘ ì ìš© (ì ‘ìˆ˜ìë³„ ë§¤í•‘ ìš°ì„ , ì¼ë°˜ ë§¤í•‘ ì°¨ì„ )
      let mappedPosName = posName;
      const posNameReceiverKey = `${posName}_${receiver}`;

      if (posNameMappingWithReceiver.has(posNameReceiverKey)) {
        mappedPosName = posNameMappingWithReceiver.get(posNameReceiverKey);
        console.log(`ì „ì²´ê³ ê°ë¦¬ìŠ¤íŠ¸: POSëª… ì ‘ìˆ˜ìë³„ ë§¤í•‘ ì ìš©: ${posName}(${receiver}) -> ${mappedPosName}`);
      } else if (posNameMapping.has(posName)) {
        mappedPosName = posNameMapping.get(posName);
        console.log(`ì „ì²´ê³ ê°ë¦¬ìŠ¤íŠ¸: POSëª… ì¼ë°˜ ë§¤í•‘ ì ìš©: ${posName} -> ${mappedPosName}`);
      }

      // ëª¨ë¸/ìš©ëŸ‰/ìƒ‰ìƒ ì¡°í•©
      const modelCapacityColor = [model, capacity, color].filter(Boolean).join('/');

      // ì²˜ìŒ 5ê°œ ê³ ê°ì˜ ìƒì„¸ ë””ë²„ê¹… ë¡œê·¸
      if (index < 5) {
        console.log(`=== ì „ì²´ê³ ê°ë¦¬ìŠ¤íŠ¸ ë””ë²„ê¹… ${index + 1}ë²ˆì§¸ ê³ ê° ===`);
        console.log(`ê³ ê°ëª…: "${customerName}", ì˜ˆì•½ë²ˆí˜¸: "${reservationNumber}"`);
        console.log(`í–‰ ê¸¸ì´: ${row.length}`);
        console.log(`--- ì „ì²´ ì»¬ëŸ¼ ê°’ í™•ì¸ ---`);
        for (let i = 0; i < Math.min(row.length, 40); i++) {
          if (row[i] && row[i].toString().trim() !== '') {
            console.log(`  ${i}ë²ˆì§¸ ì»¬ëŸ¼: "${row[i]}"`);
          }
        }
        console.log(`--- í˜„ì¬ ë§¤í•‘ í™•ì¸ ---`);
        console.log(`  Pì—´(16ë²ˆì§¸, index 15): ëª¨ë¸ = "${row[15]}"`);
        console.log(`  Qì—´(17ë²ˆì§¸, index 16): ìƒ‰ìƒ = "${row[16]}"`);
        console.log(`  Rì—´(18ë²ˆì§¸, index 17): ìš©ëŸ‰ = "${row[17]}"`);
        console.log(`  AFì—´(32ë²ˆì§¸, index 31): ìœ í˜• = "${row.length > 31 ? row[31] : 'ì»¬ëŸ¼ ì—†ìŒ'}"`);
        console.log(`  AIì—´(35ë²ˆì§¸, index 34): ì‚¬ì´íŠ¸ë©”ëª¨ = "${row.length > 34 ? row[34] : 'ì»¬ëŸ¼ ì—†ìŒ'}"`);
        console.log(`  Zì—´(26ë²ˆì§¸, index 25): ì ‘ìˆ˜ì = "${row[25]}"`);
        console.log(`--- ì²˜ë¦¬ëœ ê°’ ---`);
        console.log(`  ëª¨ë¸: "${model}"`);
        console.log(`  ìƒ‰ìƒ: "${color}"`);
        console.log(`  ìš©ëŸ‰: "${capacity}"`);
        console.log(`  ìœ í˜•: "${type}"`);
        console.log(`  ì‚¬ì´íŠ¸ë©”ëª¨: "${reservationMemo}"`);
        console.log(`  ì ‘ìˆ˜ì: "${receiver}"`);
        console.log(`  ëª¨ë¸/ìš©ëŸ‰/ìƒ‰ìƒ: "${modelCapacityColor}"`);
        console.log(`=== ë””ë²„ê¹… ë ===`);
      }

      // ë§ˆë‹¹ì ‘ìˆ˜ ì •ë³´ ë§¤ì¹­
      const normalizedReservationNumber = normalizeReservationNumber(reservationNumber);
      const yardInfo = yardIndex.get(normalizedReservationNumber) || {};

      // ì˜¨ì„¸ì¼ì ‘ìˆ˜ ì •ë³´ ë§¤ì¹­ (ì˜¨ì„¸ì¼ â†’ ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ ìˆœì„œë¡œ ì°¾ê¸°)
      const onSaleKey = `${customerName}_${storeCode}`;
      let onSaleReceivedDate = onSaleIndex.get(onSaleKey) || '';

      // ì˜¨ì„¸ì¼ì—ì„œ ì°¾ì§€ ëª»í•œ ê²½ìš° ëª¨ë°”ì¼ê°€ì…ë‚´ì—­ì—ì„œ ì°¾ê¸°
      if (!onSaleReceivedDate && mobileJoinIndex.has(normalizedReservationNumber)) {
        onSaleReceivedDate = mobileJoinIndex.get(normalizedReservationNumber);
      }

      return {
        reservationNumber,
        customerName,
        reservationDateTime,
        modelCapacityColor, // ëª¨ë¸&ìš©ëŸ‰&ìƒ‰ìƒìœ¼ë¡œ ë³€ê²½
        type,
        reservationMemo,
        storeCode,
        posName: mappedPosName, // ë§¤í•‘ëœ POSëª… ì‚¬ìš©
        manager, // ë‹´ë‹¹ì ì •ë³´ ì¶”ê°€
        yardReceivedDate: yardInfo.receivedDate || '',
        yardReceivedMemo: yardInfo.receivedMemo || '',
        onSaleReceivedDate,
        receiver: receiver, // ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ Zì—´ì—ì„œ ê°€ì ¸ì˜¨ ì ‘ìˆ˜ì
        rowIndex: index + 2,
        // ì¬ê³ ë°°ì • ìƒíƒœëŠ” ë³„ë„ APIì—ì„œ ê°€ì ¸ì˜¬ ì˜ˆì •
        assignmentStatus: 'ë¡œë”©ì¤‘...',
        activationStatus: 'ë¡œë”©ì¤‘...'
      };
    });

    console.log(`ì „ì²´ ê³ ê°ë¦¬ìŠ¤íŠ¸ ìƒì„± ì™„ë£Œ: ${customerList.length}ê°œ ê³ ê°`);

    // ì‚¬ì´íŠ¸ì˜ˆì•½(ì˜ˆì•½ì¼ì‹œ) ê¸°ì¤€ìœ¼ë¡œ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬
    customerList.sort((a, b) => {
      const dateA = new Date(a.reservationDateTime);
      const dateB = new Date(b.reservationDateTime);
      return dateA - dateB;
    });

    const result = {
      success: true,
      data: customerList,
      stats: {
        totalCustomers: customerList.length,
        totalYardReceived: customerList.filter(c => c.yardReceivedDate).length,
        totalOnSaleReceived: customerList.filter(c => c.onSaleReceivedDate).length,
        cacheInfo: {
          cached: false,
          timestamp: new Date().toISOString(),
          ttl: 300
        }
      }
    };

    // ìºì‹œ ì €ì¥ (5ë¶„)
    cacheUtils.set(cacheKey, result, 300);

    res.json(result);
  } catch (error) {
    console.error('ì „ì²´ ê³ ê°ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to load all customer list',
      message: error.message
    });
  }
});

// ë‹´ë‹¹ì ìˆ˜ë™ ë§¤ì¹­ ì €ì¥ API
app.post('/api/sales-by-store/update-agent', async (req, res) => {
  try {
    const { storeCode, posName, agent } = req.body;

    // ì—¬ê¸°ì„œëŠ” ì„ì‹œë¡œ ì„±ê³µ ì‘ë‹µë§Œ ë°˜í™˜
    // ì‹¤ì œë¡œëŠ” êµ¬ê¸€ì‹œíŠ¸ì— ì €ì¥í•˜ê±°ë‚˜ ë³„ë„ ì €ì¥ì†Œì— ì €ì¥í•  ìˆ˜ ìˆìŒ

    // ìºì‹œ ë¬´íš¨í™”
    cacheUtils.deletePattern('sales_by_store');

    res.json({
      success: true,
      message: 'ë‹´ë‹¹ìê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.'
    });
  } catch (error) {
    console.error('ë‹´ë‹¹ì ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to update agent',
      message: error.message
    });
  }
});

// POSì½”ë“œë³€ê²½ì„¤ì • ì¡°íšŒ API
app.get('/api/pos-code-mappings', async (req, res) => {
  try {
    console.log('POSì½”ë“œë³€ê²½ì„¤ì • ì¡°íšŒ ìš”ì²­');

    // POSì½”ë“œë³€ê²½ì„¤ì • ì‹œíŠ¸ì—ì„œ ë°ì´í„° ë¡œë“œ
    const posCodeMappingResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: 'POSì½”ë“œë³€ê²½ì„¤ì •!A:H'
    });

    if (!posCodeMappingResponse.data.values) {
      return res.json({
        success: true,
        mappings: []
      });
    }

    const posCodeMappingData = posCodeMappingResponse.data.values.slice(1); // í—¤ë” ì œê±°

    // ë§¤í•‘ ë°ì´í„° ë³€í™˜
    const mappings = posCodeMappingData.map((row, index) => ({
      id: index + 1,
      originalCode: row[0] || '', // Aì—´: ì›ë³¸ POSì½”ë“œ
      receiverCode: row[1] || '', // Bì—´: ì ‘ìˆ˜ìëª… (POSì½”ë“œìš©)
      mappedCode: row[2] || '',   // Cì—´: ë³€ê²½ë  POSì½”ë“œ
      descriptionCode: row[3] || '', // Dì—´: ì„¤ëª… (POSì½”ë“œìš©)
      originalName: row[4] || '', // Eì—´: ì›ë³¸ POSëª…
      receiverName: row[5] || '', // Fì—´: ì ‘ìˆ˜ìëª… (POSëª…ìš©)
      mappedName: row[6] || '',   // Gì—´: ë³€ê²½ë  POSëª…
      descriptionName: row[7] || '' // Hì—´: ì„¤ëª… (POSëª…ìš©)
    })).filter(mapping => (mapping.originalCode && mapping.mappedCode) || (mapping.originalName && mapping.mappedName)); // ë¹ˆ ë°ì´í„° ì œê±°

    console.log(`POSì½”ë“œë³€ê²½ì„¤ì • ë¡œë“œ ì™„ë£Œ: ${mappings.length}ê°œ ë§¤í•‘`);

    res.json({
      success: true,
      mappings
    });
  } catch (error) {
    console.error('POSì½”ë“œë³€ê²½ì„¤ì • ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to load POS code mappings',
      message: error.message
    });
  }
});

// POSì½”ë“œë³€ê²½ì„¤ì • ì €ì¥ API
app.post('/api/pos-code-mappings', async (req, res) => {
  try {
    const { mappings } = req.body;
    console.log('POSì½”ë“œë³€ê²½ì„¤ì • ì €ì¥ ìš”ì²­:', mappings.length, 'ê°œ ë§¤í•‘');

    // ë°ì´í„° ê²€ì¦
    if (!Array.isArray(mappings)) {
      throw new Error('ë§¤í•‘ ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    }

    // ì‹œíŠ¸ì— ì €ì¥í•  ë°ì´í„° ì¤€ë¹„ (í—¤ë” í¬í•¨)
    const sheetData = [
      ['ì›ë³¸ POSì½”ë“œ', 'ì ‘ìˆ˜ìëª…', 'ë³€ê²½ë  POSì½”ë“œ', 'ì„¤ëª…', 'ì›ë³¸ POSëª…', 'ì ‘ìˆ˜ìëª…', 'ë³€ê²½ë  POSëª…', 'ì„¤ëª…'] // í—¤ë”
    ];

    // ë§¤í•‘ ë°ì´í„° ì¶”ê°€
    mappings.forEach(mapping => {
      sheetData.push([
        mapping.originalCode || '',
        mapping.receiverCode || '',
        mapping.mappedCode || '',
        mapping.descriptionCode || '',
        mapping.originalName || '',
        mapping.receiverName || '',
        mapping.mappedName || '',
        mapping.descriptionName || ''
      ]);
    });

    // Google Sheetsì— ì €ì¥
    await sheets.spreadsheets.values.update({
      spreadsheetId: SPREADSHEET_ID,
      range: 'POSì½”ë“œë³€ê²½ì„¤ì •!A:H',
      valueInputOption: 'RAW',
      resource: {
        values: sheetData
      }
    });

    console.log('POSì½”ë“œë³€ê²½ì„¤ì • ì €ì¥ ì™„ë£Œ');

    // ìºì‹œ ë¬´íš¨í™”
    cacheUtils.deletePattern('sales_by_store');

    res.json({
      success: true,
      message: 'POSì½”ë“œë³€ê²½ì„¤ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.',
      savedCount: mappings.length
    });
  } catch (error) {
    console.error('POSì½”ë“œë³€ê²½ì„¤ì • ì €ì¥ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to save POS code mappings',
      message: error.message
    });
  }
});

// ê°œë³„ POSì½”ë“œ ë§¤í•‘ ì¶”ê°€ API
app.post('/api/pos-code-mapping', async (req, res) => {
  try {
    const { posCode, storeCode } = req.body;

    if (!posCode || !storeCode) {
      return res.status(400).json({
        success: false,
        message: 'POSì½”ë“œì™€ ë§¤ì¥ì½”ë“œë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.'
      });
    }

    // ê¸°ì¡´ ë§¤í•‘ ë°ì´í„° ë¡œë“œ
    const existingResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: 'POSì½”ë“œë³€ê²½ì„¤ì •!A:H'
    });

    let existingMappings = [];
    if (existingResponse.data.values && existingResponse.data.values.length > 1) {
      existingMappings = existingResponse.data.values.slice(1).map(row => ({
        originalCode: row[0] || '',
        receiverCode: row[1] || '',
        mappedCode: row[2] || '',
        description: row[3] || '',
        originalName: row[4] || '',
        receiverName: row[5] || '',
        mappedName: row[6] || '',
        nameDescription: row[7] || ''
      }));
    }

    // ì¤‘ë³µ í™•ì¸
    const isDuplicate = existingMappings.some(mapping =>
      mapping.originalCode === posCode && mapping.mappedCode === storeCode
    );

    if (isDuplicate) {
      return res.status(400).json({
        success: false,
        message: 'ì´ë¯¸ ë™ì¼í•œ ë§¤í•‘ì´ ì¡´ì¬í•©ë‹ˆë‹¤.'
      });
    }

    // ìƒˆ ë§¤í•‘ ì¶”ê°€
    const newMapping = {
      originalCode: posCode,
      receiverCode: '',
      mappedCode: storeCode,
      description: 'ë§¤í•‘ ì‹¤íŒ¨ ëª¨ë‹¬ì—ì„œ ì¶”ê°€ë¨',
      originalName: '',
      receiverName: '',
      mappedName: '',
      nameDescription: ''
    };

    existingMappings.push(newMapping);

    // ì‹œíŠ¸ì— ì €ì¥í•  ë°ì´í„° ì¤€ë¹„
    const sheetData = [
      ['ì›ë³¸ POSì½”ë“œ', 'ì ‘ìˆ˜ìëª…', 'ë³€ê²½ë  POSì½”ë“œ', 'ì„¤ëª…', 'ì›ë³¸ POSëª…', 'ì ‘ìˆ˜ìëª…', 'ë³€ê²½ë  POSëª…', 'ì„¤ëª…']
    ];

    existingMappings.forEach(mapping => {
      sheetData.push([
        mapping.originalCode,
        mapping.receiverCode,
        mapping.mappedCode,
        mapping.description,
        mapping.originalName,
        mapping.receiverName,
        mapping.mappedName,
        mapping.nameDescription
      ]);
    });

    // ì‹œíŠ¸ì— ì €ì¥
    await sheets.spreadsheets.values.update({
      spreadsheetId: SPREADSHEET_ID,
      range: 'POSì½”ë“œë³€ê²½ì„¤ì •!A:H',
      valueInputOption: 'RAW',
      resource: {
        values: sheetData
      }
    });

    console.log(`POSì½”ë“œ ë§¤í•‘ ì¶”ê°€: ${posCode} -> ${storeCode}`);

    res.json({
      success: true,
      message: 'ë§¤í•‘ì´ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.',
      mapping: newMapping
    });

  } catch (error) {
    console.error('POSì½”ë“œ ë§¤í•‘ ì¶”ê°€ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      message: 'ë§¤í•‘ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message
    });
  }
});

// ë§¤í•‘ ì‹¤íŒ¨ ì›ì¸ ë¶„ì„ API
app.get('/api/mapping-failure-analysis', async (req, res) => {
  try {
    const { posCode } = req.query;

    if (!posCode) {
      return res.status(400).json({
        success: false,
        message: 'POSì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'
      });
    }

    // 1. í°í´ì¶œê³ ì²˜ë°ì´í„°ì—ì„œ í•´ë‹¹ POSì½”ë“œê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
    const phoneklResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: 'í°í´ì¶œê³ ì²˜ë°ì´í„°!A:V'
    });

    let phoneklHasCode = false;
    let phoneklManager = '';
    if (phoneklResponse.data.values && phoneklResponse.data.values.length > 3) {
      const phoneklData = phoneklResponse.data.values.slice(3);
      const foundRow = phoneklData.find(row =>
        row.length >= 22 && (row[15] || '').toString().trim() === posCode
      );

      if (foundRow) {
        phoneklHasCode = true;
        phoneklManager = (foundRow[21] || '').toString().trim();
      }
    }

    // 2. POSì½”ë“œë³€ê²½ì„¤ì •ì—ì„œ ë§¤í•‘ì´ ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
    const mappingResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: 'POSì½”ë“œë³€ê²½ì„¤ì •!A:H'
    });

    let hasMapping = false;
    let mappedCode = '';
    if (mappingResponse.data.values && mappingResponse.data.values.length > 1) {
      const mappingData = mappingResponse.data.values.slice(1);
      const foundMapping = mappingData.find(row =>
        (row[0] || '').toString().trim() === posCode
      );

      if (foundMapping) {
        hasMapping = true;
        mappedCode = (foundMapping[2] || '').toString().trim();
      }
    }

    // 3. ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ì—ì„œ í•´ë‹¹ POSì½”ë“œ ì‚¬ìš© í˜„í™© í™•ì¸
    const reservationResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: 'ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸!A:AA'
    });

    let reservationUsage = [];
    if (reservationResponse.data.values && reservationResponse.data.values.length > 1) {
      const reservationData = reservationResponse.data.values.slice(1);
      reservationUsage = reservationData
        .filter(row => row.length >= 26 && (row[25] || '').toString().trim() === posCode)
        .slice(0, 3) // ìµœëŒ€ 3ê°œë§Œ í‘œì‹œ
        .map(row => ({
          customerName: (row[7] || '').toString().trim(),
          reservationNumber: (row[8] || '').toString().trim(),
          receiver: (row[25] || '').toString().trim()
        }));
    }

    // 4. ì‹¤íŒ¨ ì›ì¸ ë¶„ì„
    const reasons = [];

    if (!phoneklHasCode) {
      reasons.push(`í°í´ì¶œê³ ì²˜ë°ì´í„°ì— ë§¤ì¥ì½”ë“œ "${posCode}"ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ`);
    } else {
      reasons.push(`í°í´ì¶œê³ ì²˜ë°ì´í„°ì— ë§¤ì¥ì½”ë“œ "${posCode}" ì¡´ì¬ (ë‹´ë‹¹ì: ${phoneklManager || 'ì—†ìŒ'})`);
    }

    if (!hasMapping) {
      reasons.push(`POSì½”ë“œë³€ê²½ì„¤ì •ì— "${posCode}" ë§¤í•‘ì´ ì„¤ì •ë˜ì§€ ì•ŠìŒ`);
    } else {
      reasons.push(`POSì½”ë“œë³€ê²½ì„¤ì •ì— "${posCode}" â†’ "${mappedCode}" ë§¤í•‘ ì¡´ì¬`);
    }

    if (reservationUsage.length === 0) {
      reasons.push(`ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ì—ì„œ "${posCode}" ì‚¬ìš© ë‚´ì—­ ì—†ìŒ`);
    } else {
      reasons.push(`ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ì—ì„œ "${posCode}" ì‚¬ìš©: ${reservationUsage.length}ê±´`);
      reasons.push(`ì‚¬ìš© ì˜ˆì‹œ: ${reservationUsage.map(item => `${item.customerName}(${item.reservationNumber})`).join(', ')}`);
    }

    // 5. í•´ê²° ë°©ì•ˆ ì œì‹œ
    const solutions = [];

    if (!phoneklHasCode && !hasMapping) {
      solutions.push(`1. í°í´ì¶œê³ ì²˜ë°ì´í„°ì— "${posCode}" ë§¤ì¥ì½”ë“œ ì¶”ê°€`);
      solutions.push(`2. ë˜ëŠ” POSì½”ë“œë³€ê²½ì„¤ì •ì—ì„œ ë‹¤ë¥¸ ë§¤ì¥ì½”ë“œë¡œ ë§¤í•‘`);
    } else if (phoneklHasCode && !hasMapping) {
      solutions.push(`1. POSì½”ë“œë³€ê²½ì„¤ì •ì—ì„œ "${posCode}" â†’ "${posCode}" ë§¤í•‘ ì¶”ê°€`);
    } else if (!phoneklHasCode && hasMapping) {
      solutions.push(`1. í°í´ì¶œê³ ì²˜ë°ì´í„°ì— "${mappedCode}" ë§¤ì¥ì½”ë“œ í™•ì¸`);
    }

    res.json({
      success: true,
      posCode,
      reasons,
      solutions,
      details: {
        phoneklHasCode,
        phoneklManager,
        hasMapping,
        mappedCode,
        reservationUsageCount: reservationUsage.length,
        reservationUsage
      }
    });

  } catch (error) {
    console.error('ë§¤í•‘ ì‹¤íŒ¨ ì›ì¸ ë¶„ì„ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      message: 'ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message
    });
  }
});

// ë§ˆë‹¹ì ‘ìˆ˜ ë°ì´í„° ëˆ„ë½ ë¶„ì„ API
app.get('/api/yard-receipt-missing-analysis', async (req, res) => {
  try {
    console.log('ë§ˆë‹¹ì ‘ìˆ˜ ë°ì´í„° ëˆ„ë½ ë¶„ì„ ì‹œì‘');

    // 1. ë§ˆë‹¹ì ‘ìˆ˜ ì‹œíŠ¸ ë°ì´í„° ë¡œë“œ
    const yardResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: 'ë§ˆë‹¹ì ‘ìˆ˜!A:X'
    });

    // 2. ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ë°ì´í„° ë¡œë“œ
    const reservationResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: 'ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸!A:AA'
    });

    // 3. ì˜¨ì„¸ì¼ ë°ì´í„° ë¡œë“œ
    const onSaleResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: 'ì˜¨ì„¸ì¼!A:AA'
    });

    if (!yardResponse.data.values || !reservationResponse.data.values || !onSaleResponse.data.values) {
      throw new Error('ì‹œíŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    // ë§ˆë‹¹ì ‘ìˆ˜ ë°ì´í„° ì²˜ë¦¬ (í—¤ë” ì œì™¸) - ë§ˆë‹¹ì ‘ìˆ˜ëŠ” í—¤ë”ê°€ 1í–‰, ë°ì´í„°ê°€ 2í–‰ë¶€í„°
    const yardData = yardResponse.data.values.slice(1);
    const reservationData = reservationResponse.data.values.slice(1);

    console.log(`ë§ˆë‹¹ì ‘ìˆ˜ ì›ë³¸ ë°ì´í„° í–‰ ìˆ˜: ${yardResponse.data.values.length}`);
    console.log(`ë§ˆë‹¹ì ‘ìˆ˜ ì²˜ë¦¬ í›„ ë°ì´í„° í–‰ ìˆ˜: ${yardData.length}`);
    console.log(`ë§ˆë‹¹ì ‘ìˆ˜ ì²« ë²ˆì§¸ ë°ì´í„° í–‰:`, yardData[0]?.slice(0, 5));

    // ë§ˆë‹¹ì ‘ìˆ˜ì—ì„œ ì˜ˆì•½ë²ˆí˜¸ ì¶”ì¶œ (ì •ê·œí™”) - ë§¤ì¹­ìš©
    const yardReservationNumbers = new Set();
    yardData.forEach(row => {
      if (row.length >= 8) {
        const reservationNumber = (row[7] || '').toString().trim(); // Hì—´: ì˜ˆì•½ë²ˆí˜¸
        if (reservationNumber) {
          yardReservationNumbers.add(reservationNumber.replace(/-/g, ''));
        }
      }
    });

    // ì˜¨ì„¸ì¼ ë°ì´í„°ì—ì„œ ê³ ê°ëª…_ë§¤ì¥ì½”ë“œ ì¡°í•© ì¶”ì¶œ
    const onSaleIndex = new Set();
    onSaleResponse.data.values.slice(1).forEach(row => {
      if (row.length >= 3) {
        const customerName = (row[0] || '').toString().trim();
        const storeCode = (row[2] || '').toString().trim();
        if (customerName && storeCode) {
          onSaleIndex.add(`${customerName}_${storeCode}`);
        }
      }
    });

    // ë§ˆë‹¹ì ‘ìˆ˜ ë°ì´í„° ë¶„ì„
    const yardAnalysis = {
      total: 0,
      matched: 0,
      unmatched: 0,
      missingDetails: []
    };

    // ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ì—ì„œ ì˜ˆì•½ë²ˆí˜¸ ì¶”ì¶œ (ì •ê·œí™”) - ë§¤ì¹­ í™•ì¸ìš©
    const reservationNumbers = new Set();
    reservationData.forEach(row => {
      if (row.length >= 9) {
        const reservationNumber = (row[8] || '').toString().trim();
        if (reservationNumber) {
          reservationNumbers.add(reservationNumber.replace(/-/g, ''));
        }
      }
    });

    yardData.forEach((row, index) => {
      if (row.length < 22) {
        console.log(`í–‰ ${index + 2}: ì»¬ëŸ¼ ìˆ˜ ë¶€ì¡± (${row.length}ê°œ, ìµœì†Œ 22ê°œ í•„ìš”)`);
        return; // Vì—´ê¹Œì§€ í•„ìš”í•˜ë¯€ë¡œ ìµœì†Œ 22ê°œ ì»¬ëŸ¼
      }

      // Hì—´ì—ì„œ "ì—´ëŒ" í…ìŠ¤íŠ¸ í™•ì¸ (ì´ì „ ë°©ì‹)
      const hValue = (row[7] || '').toString().trim(); // Hì—´: "ì—´ëŒ" í…ìŠ¤íŠ¸
      console.log(`í–‰ ${index + 2}: Hì—´="${hValue}"`);

      if (hValue !== 'ì—´ëŒ') {
        console.log(`í–‰ ${index + 2}: Hì—´ì´ "ì—´ëŒ"ì´ ì•„ë‹˜`);
        return; // "ì—´ëŒ"ì´ ì•„ë‹ˆë©´ ê±´ë„ˆë›°ê¸°
      }

      yardAnalysis.total++;

      // Uì—´, Vì—´ì—ì„œ ì˜ˆì•½ë²ˆí˜¸ ì¶”ì¶œ
      const uValue = (row[20] || '').toString().trim(); // Uì—´
      const vValue = (row[21] || '').toString().trim(); // Vì—´

      // ì˜ˆì•½ë²ˆí˜¸ íŒ¨í„´ ì°¾ê¸° (í•˜ì´í”ˆì´ ì—†ëŠ” í˜•íƒœ: XX000000)
      const reservationPattern = /[A-Z]{2}\d{6}/g;
      const uMatches = uValue.match(reservationPattern) || [];
      const vMatches = vValue.match(reservationPattern) || [];
      const allMatches = [...uMatches, ...vMatches];

      const normalizedReservationNumber = allMatches.length > 0 ? allMatches[0] : '';
      const isMatched = normalizedReservationNumber && reservationNumbers.has(normalizedReservationNumber);

      if (isMatched) {
        yardAnalysis.matched++;
      } else {
        yardAnalysis.unmatched++;
        yardAnalysis.missingDetails.push({
          rowIndex: index + 2, // ì‹¤ì œ í–‰ ë²ˆí˜¸
          reservationNumber: normalizedReservationNumber || 'ì˜ˆì•½ë²ˆí˜¸ ì—†ìŒ',
          posCode: (row[17] || '').toString().trim(), // Rì—´: POSì½”ë“œ
          storeName: (row[18] || '').toString().trim(), // Sì—´: ìƒí˜¸ëª…
          customerName: (row[23] || '').toString().trim(), // Xì—´: ê³ ê°ëª…
          receivedDateTime: (row[11] || '').toString().trim(), // Lì—´: ì ‘ìˆ˜ì‹œê°„
          receivedMemo: (row[20] || '').toString().trim(), // Uì—´: ìˆ˜ì‹ ì ë©”ëª¨
          reason: normalizedReservationNumber ? 'ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ì— ì˜ˆì•½ë²ˆí˜¸ ì—†ìŒ' : 'ì˜ˆì•½ë²ˆí˜¸ ì¶”ì¶œ ì‹¤íŒ¨'
        });
      }
    });

    // ëŒ€ì‹œë³´ë“œì—ì„œ ì‚¬ìš©í•˜ëŠ” ì •í™•í•œ ì„œë¥˜ì ‘ìˆ˜ ì™„ë£Œ ê±´ìˆ˜ ê°€ì ¸ì˜¤ê¸°
    let appCalculatedCount = 0;

    try {
      // ê¸°ì¡´ ëŒ€ì‹œë³´ë“œ APIì™€ ë™ì¼í•œ ë¡œì§ ì‚¬ìš©
      const salesResponse = await fetch(`${process.env.REACT_APP_API_URL || 'http://localhost:4000'}/api/sales-by-store/data`);
      if (salesResponse.ok) {
        const salesResult = await salesResponse.json();
        if (salesResult.success) {
          appCalculatedCount = salesResult.stats?.totalDocumentReceived || 0;
          console.log(`ëŒ€ì‹œë³´ë“œ APIì—ì„œ ê°€ì ¸ì˜¨ ì„œë¥˜ì ‘ìˆ˜ ì™„ë£Œ ê±´ìˆ˜: ${appCalculatedCount}ê±´`);
        }
      }
    } catch (error) {
      console.error('ëŒ€ì‹œë³´ë“œ API í˜¸ì¶œ ì‹¤íŒ¨:', error);
      // ëŒ€ì‹œë³´ë“œ API ì‹¤íŒ¨ ì‹œ ì§ì ‘ ê³„ì‚°
      reservationData.forEach((row, index) => {
        if (row.length < 26) return;

        const reservationNumber = (row[8] || '').toString().trim();
        const customerName = (row[7] || '').toString().trim();
        const storeCode = (row[25] || '').toString().trim();

        if (!reservationNumber) return;

        const normalizedReservationNumber = reservationNumber.replace(/-/g, '');
        const isYardReceived = yardReservationNumbers.has(normalizedReservationNumber);
        const isOnSaleReceived = onSaleIndex.has(`${customerName}_${storeCode}`);

        if (isYardReceived || isOnSaleReceived) {
          appCalculatedCount++;
        }
      });
      console.log(`ì§ì ‘ ê³„ì‚°í•œ ì„œë¥˜ì ‘ìˆ˜ ì™„ë£Œ ê±´ìˆ˜: ${appCalculatedCount}ê±´`);
    }

    const result = {
      success: true,
      analysis: {
        yardReceipt: {
          total: yardAnalysis.total,
          matched: yardAnalysis.matched,
          unmatched: yardAnalysis.unmatched,
          missingDetails: yardAnalysis.missingDetails.slice(0, 50) // ìµœëŒ€ 50ê°œë§Œ ë°˜í™˜
        },
        appCalculation: {
          totalReservations: reservationData.length,
          calculatedReceived: appCalculatedCount
        },
        difference: {
          yardTotal: yardAnalysis.total,
          appCalculated: appCalculatedCount,
          difference: yardAnalysis.unmatched // ì‹¤ì œ ëˆ„ë½ëœ ìƒì„¸ í•­ëª© ìˆ˜
        }
      }
    };

    console.log('ë§ˆë‹¹ì ‘ìˆ˜ ëˆ„ë½ ë¶„ì„ ì™„ë£Œ:', {
      ë§ˆë‹¹ì ‘ìˆ˜ì´ê±´ìˆ˜: yardAnalysis.total,
      ì•±ê³„ì‚°ê±´ìˆ˜: appCalculatedCount,
      ì°¨ì´: yardAnalysis.total - appCalculatedCount,
      ë§¤ì¹­ëœê±´ìˆ˜: yardAnalysis.matched,
      ë§¤ì¹­ì•ˆëœê±´ìˆ˜: yardAnalysis.unmatched,
      ëˆ„ë½ìƒì„¸ê±´ìˆ˜: yardAnalysis.missingDetails.length
    });

    console.log('ëˆ„ë½ ìƒì„¸ ë¶„ì„:');
    const reasonCounts = {};
    yardAnalysis.missingDetails.forEach(item => {
      reasonCounts[item.reason] = (reasonCounts[item.reason] || 0) + 1;
    });
    console.log('ì›ì¸ë³„ ê±´ìˆ˜:', reasonCounts);

    // ì¤‘ë³µ ì˜ˆì•½ë²ˆí˜¸ í™•ì¸
    const missingReservationNumbers = new Set();
    const duplicateReservations = new Set();
    yardAnalysis.missingDetails.forEach(item => {
      if (missingReservationNumbers.has(item.reservationNumber)) {
        duplicateReservations.add(item.reservationNumber);
      } else {
        missingReservationNumbers.add(item.reservationNumber);
      }
    });
    console.log('ì¤‘ë³µëœ ì˜ˆì•½ë²ˆí˜¸:', Array.from(duplicateReservations));
    console.log('ê³ ìœ  ì˜ˆì•½ë²ˆí˜¸ ìˆ˜:', missingReservationNumbers.size);
    console.log('ì´ ëˆ„ë½ ìƒì„¸ í•­ëª© ìˆ˜:', yardAnalysis.missingDetails.length);

    res.json(result);

  } catch (error) {
    console.error('ë§ˆë‹¹ì ‘ìˆ˜ ëˆ„ë½ ë¶„ì„ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      message: 'ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message
    });
  }
});

// ì¬ê³  í˜„í™© ë¶„ì„ API (ëŒ€ë¦¬ì ë³„ ë¶„ë¦¬)
app.get('/api/inventory-analysis', async (req, res) => {
  const { storeCode } = req.query; // ëŒ€ë¦¬ì  ì½”ë“œ í•„í„°ë§ (ì„ íƒì‚¬í•­)

  try {
    // 1. ëŒ€ë¦¬ì  ì½”ë“œ ë§¤í•‘ ì •ë³´ ë¡œë“œ
    let storeCodeMapping = {};
    try {
      const mappingResponse = await sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: 'í°í´ì¬ê³ ë°ì´í„°!K:K'
      });

      if (mappingResponse.data.values && mappingResponse.data.values.length > 1) {
        // Kì—´ì—ì„œ ëŒ€ë¦¬ì ëª…ê³¼ ì½”ë“œ ë§¤í•‘ ì •ë³´ ì¶”ì¶œ
        const mappingData = mappingResponse.data.values.slice(1);
        mappingData.forEach((row, index) => {
          const storeName = row[0] || '';
          if (storeName) {
            // ë§¤í•‘ ê·œì¹™ ì ìš©
            if (storeName.includes('LGì‚¬ì—…ìí°(ê²½ìˆ˜)')) {
              storeCodeMapping['306891'] = storeName;
            } else if (storeName.includes('LGì‚¬ì—…ìí°(êµ°ì‚°)')) {
              storeCodeMapping['314942'] = storeName;
            } else if (storeName.includes('LGì‚¬ì—…ìí°(ì¸ì²œ)')) {
              storeCodeMapping['315835'] = storeName;
            }
          }
        });
      }
    } catch (error) {
      console.log('ëŒ€ë¦¬ì  ì½”ë“œ ë§¤í•‘ ë¡œë“œ ì‹¤íŒ¨:', error.message);
    }

    console.log('ëŒ€ë¦¬ì  ì½”ë“œ ë§¤í•‘:', storeCodeMapping);

    // 2. ì •ê·œí™” ê·œì¹™ ë¡œë“œ
    let normalizationRules = [];
    try {
      const rulesResponse = await sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ì •ê·œí™”ì‘ì—…!A:G'
      });

      if (rulesResponse.data.values && rulesResponse.data.values.length > 1) {
        normalizationRules = rulesResponse.data.values.slice(1)
          .filter(row => row.length >= 6 && row[5] === 'ì™„ë£Œ')
          .map(row => ({
            reservationSite: row[1] || '',
            phonekl: row[2] || '',
            normalizedModel: row[3] || '',
            note: row[6] || ''
          }));
      }
    } catch (error) {
      console.log('ì •ê·œí™” ê·œì¹™ ë¡œë“œ ì‹¤íŒ¨:', error.message);
    }

    // 2. ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ë°ì´í„° ë¡œë“œ (ëŒ€ë¦¬ì ë³„ í•„í„°ë§)
    let reservationData = [];
    try {
      const reservationResponse = await sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸!A:AA'
      });

      if (reservationResponse.data.values && reservationResponse.data.values.length > 1) {
        const headers = reservationResponse.data.values[0];
        const dataRows = reservationResponse.data.values.slice(1);

        reservationData = dataRows.map((row, index) => {
          const pValue = row[15] || ''; // Pì—´ (16ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
          const qValue = row[16] || ''; // Qì—´ (17ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
          const rValue = row[17] || ''; // Rì—´ (18ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
          const storeCode = row[23] || ''; // Xì—´ (24ë²ˆì§¸, 0ë¶€í„° ì‹œì‘) - ëŒ€ë¦¬ì ì½”ë“œ

          // ì •ê·œí™” ê·œì¹™ ì ìš©
          let normalizedModel = '';
          for (const rule of normalizationRules) {
            const ruleParts = rule.reservationSite.split(' | ');
            if (ruleParts.length >= 3) {
              const ruleP = ruleParts[0];
              const ruleQ = ruleParts[1];
              const ruleR = ruleParts[2];

              const pMatch = !ruleP || pValue.includes(ruleP) || ruleP.includes(pValue);
              const qMatch = !ruleQ || qValue.includes(ruleQ) || ruleQ.includes(qValue);
              const rMatch = !ruleR || rValue.includes(ruleR) || ruleR.includes(rValue);

              if (pMatch && qMatch && rMatch) {
                normalizedModel = rule.normalizedModel;
                break;
              }
            }
          }

          return {
            reservationNumber: row[8] || '', // Iì—´ (9ë²ˆì§¸, 0ë¶€í„° ì‹œì‘)
            originalP: pValue,
            originalQ: qValue,
            originalR: rValue,
            normalizedModel: normalizedModel,
            storeCode: storeCode,
            rowIndex: index + 2
          };
        });

        // ëŒ€ë¦¬ì  ì½”ë“œë³„ í•„í„°ë§ ì ìš©
        if (storeCode) {
          reservationData = reservationData.filter(item => item.storeCode === storeCode);
          // ëŒ€ë¦¬ì  ì½”ë“œ í•„í„°ë§ ì ìš©
        }
      }
    } catch (error) {
      // ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ì‹œíŠ¸ ë¡œë“œ ì‹¤íŒ¨
    }

    // 3. í°í´ì¬ê³ ë°ì´í„° ë¡œë“œ (ì¬ê³  ìˆ˜ëŸ‰ í¬í•¨, ëŒ€ë¦¬ì ë³„ í•„í„°ë§)
    let inventoryData = [];
    try {
      const inventoryResponse = await sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: 'í°í´ì¬ê³ ë°ì´í„°!A:AA'
      });

      if (inventoryResponse.data.values && inventoryResponse.data.values.length > 1) {
        const headers = inventoryResponse.data.values[0];
        const dataRows = inventoryResponse.data.values.slice(1);

        inventoryData = dataRows.map((row, index) => {
          const fValue = row[5] || ''; // Fì—´ (6ë²ˆì§¸, 0ë¶€í„° ì‹œì‘) - ëª¨ë¸
          const gValue = row[6] || ''; // Gì—´ (7ë²ˆì§¸, 0ë¶€í„° ì‹œì‘) - ìƒ‰ìƒ
          const storeName = row[10] || ''; // Kì—´ (11ë²ˆì§¸, 0ë¶€í„° ì‹œì‘) - ëŒ€ë¦¬ì ëª…

          // ì—¬ëŸ¬ ì—´ì—ì„œ ìˆ˜ëŸ‰ í™•ì¸ (H, I, J, K, Lì—´)
          const quantityH = parseInt(row[7] || '0') || 0; // Hì—´
          const quantityI = parseInt(row[8] || '0') || 0; // Iì—´
          const quantityJ = parseInt(row[9] || '0') || 0; // Jì—´
          const quantityK = parseInt(row[10] || '0') || 0; // Kì—´
          const quantityL = parseInt(row[11] || '0') || 0; // Lì—´

          // ì²« ë²ˆì§¸ë¡œ 0ì´ ì•„ë‹Œ ìˆ˜ëŸ‰ì„ ì‚¬ìš©
          const quantity = quantityH || quantityI || quantityJ || quantityK || quantityL;

          // ëŒ€ë¦¬ì  ì½”ë“œ ê²°ì •
          let storeCode = '';
          if (storeName.includes('LGì‚¬ì—…ìí°(ê²½ìˆ˜)')) {
            storeCode = '306891';
          } else if (storeName.includes('LGì‚¬ì—…ìí°(êµ°ì‚°)')) {
            storeCode = '314942';
          } else if (storeName.includes('LGì‚¬ì—…ìí°(ì¸ì²œ)')) {
            storeCode = '315835';
          }

          // ë””ë²„ê¹…: ì²˜ìŒ 5ê°œ í–‰ì˜ ëª¨ë“  ì—´ ê°’ í™•ì¸
          if (index < 5) {
            console.log(`í–‰ ${index + 2}: F="${fValue}", G="${gValue}", ëŒ€ë¦¬ì ="${storeName}", ì½”ë“œ="${storeCode}", H=${quantityH}, I=${quantityI}, J=${quantityJ}, K=${quantityK}, L=${quantityL}, ìµœì¢…ìˆ˜ëŸ‰=${quantity}`);
          }

          // í°í´ì¬ê³ ë°ì´í„°ì˜ Fì—´, Gì—´ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì—¬ ì •ê·œí™” ê·œì¹™ê³¼ ë§¤ì¹­
          let normalizedModel = '';

          // ë¹ˆ ê°’ì´ë‚˜ í—¤ë” í–‰ì€ ì •ê·œí™”í•˜ì§€ ì•ŠìŒ
          if (!fValue.trim() || !gValue.trim() ||
            fValue.trim() === 'ëª¨ë¸ëª…' || gValue.trim() === 'ìƒ‰ìƒ') {
            normalizedModel = '';
          } else {
            for (const rule of normalizationRules) {
              const ruleParts = rule.phonekl.split(' | ');
              if (ruleParts.length >= 2) {
                const ruleF = ruleParts[0]; // ì •ê·œí™” ê·œì¹™ì˜ Fì—´ ê°’
                const ruleG = ruleParts[1]; // ì •ê·œí™” ê·œì¹™ì˜ Gì—´ ê°’

                // ë¹ˆ ê·œì¹™ ê°’ì€ ë§¤ì¹­í•˜ì§€ ì•ŠìŒ
                if (!ruleF.trim() || !ruleG.trim()) continue;

                // ë” ìœ ì—°í•œ ë§¤ì¹­: ë¶€ë¶„ ë¬¸ìì—´ í¬í•¨ ë˜ëŠ” ì •í™•í•œ ì¼ì¹˜
                const fMatch = fValue.trim() === ruleF.trim() ||
                  fValue.trim().includes(ruleF.trim()) ||
                  ruleF.trim().includes(fValue.trim());
                const gMatch = gValue.trim() === ruleG.trim() ||
                  gValue.trim().includes(ruleG.trim()) ||
                  ruleG.trim().includes(gValue.trim());

                if (fMatch && gMatch) {
                  normalizedModel = rule.normalizedModel;
                  break;
                }
              }
            }
          }

          return {
            originalF: fValue,
            originalG: gValue,
            normalizedModel: normalizedModel,
            quantity: quantity,
            storeName: storeName,
            storeCode: storeCode,
            rowIndex: index + 2
          };
        });

        // ëŒ€ë¦¬ì  ì½”ë“œë³„ í•„í„°ë§ ì ìš©
        if (storeCode) {
          inventoryData = inventoryData.filter(item => item.storeCode === storeCode);
          // ëŒ€ë¦¬ì  ì½”ë“œ í•„í„°ë§ ì ìš©
        }
      }
    } catch (error) {
      console.log('í°í´ì¬ê³ ë°ì´í„° ì‹œíŠ¸ ë¡œë“œ ì‹¤íŒ¨:', error.message);
    }

    // í°í´ì¬ê³ ë°ì´í„° ìˆ˜ëŸ‰ í†µê³„
    const totalQuantity = inventoryData.reduce((sum, item) => sum + item.quantity, 0);
    const itemsWithQuantity = inventoryData.filter(item => item.quantity > 0).length;
    console.log('í°í´ì¬ê³ ë°ì´í„° ìˆ˜ëŸ‰ í†µê³„:', {
      ì´ìˆ˜ëŸ‰: totalQuantity,
      ìˆ˜ëŸ‰ìˆëŠ”í•­ëª©ìˆ˜: itemsWithQuantity,
      ì „ì²´í•­ëª©ìˆ˜: inventoryData.length,
      í‰ê· ìˆ˜ëŸ‰: inventoryData.length > 0 ? (totalQuantity / inventoryData.length).toFixed(2) : 0
    });

    // 4. ì¬ê³  í˜„í™© ë¶„ì„
    const inventoryAnalysis = {};

    // ë””ë²„ê¹…: ì •ê·œí™” ê·œì¹™ ë¡œê·¸
    console.log('=== ì¬ê³  í˜„í™© ë¶„ì„ ë””ë²„ê¹… ===');
    console.log('ì •ê·œí™” ê·œì¹™ ê°œìˆ˜:', normalizationRules.length);
    console.log('ì •ê·œí™” ê·œì¹™ ìƒ˜í”Œ:', normalizationRules.slice(0, 3));

    // ë””ë²„ê¹…: í°í´ì¬ê³ ë°ì´í„° ì •ê·œí™” ê²°ê³¼
    console.log('í°í´ì¬ê³ ë°ì´í„° ì´ ê°œìˆ˜:', inventoryData.length);
    const normalizedInventoryCount = inventoryData.filter(item => item.normalizedModel).length;
    console.log('ì •ê·œí™”ëœ ì¬ê³  ë°ì´í„° ê°œìˆ˜:', normalizedInventoryCount);
    console.log('ì •ê·œí™”ë˜ì§€ ì•Šì€ ì¬ê³  ë°ì´í„° ìƒ˜í”Œ:',
      inventoryData.filter(item => !item.normalizedModel).slice(0, 5).map(item => ({
        F: item.originalF,
        G: item.originalG,
        ìˆ˜ëŸ‰: item.quantity
      }))
    );

    // ì •ê·œí™” ê·œì¹™ê³¼ ì‹¤ì œ ë°ì´í„° ë¹„êµ ë””ë²„ê¹…
    console.log('=== ì •ê·œí™” ê·œì¹™ vs ì‹¤ì œ ë°ì´í„° ë¹„êµ ===');
    const sampleUnnormalized = inventoryData.filter(item => !item.normalizedModel).slice(0, 3);
    sampleUnnormalized.forEach((item, index) => {
      console.log(`ìƒ˜í”Œ ${index + 1}: F="${item.originalF}", G="${item.originalG}"`);
      console.log('ë§¤ì¹­ ì‹œë„í•œ ê·œì¹™ë“¤:');
      normalizationRules.slice(0, 3).forEach((rule, ruleIndex) => {
        const ruleParts = rule.phonekl.split(' | ');
        if (ruleParts.length >= 2) {
          const ruleF = ruleParts[0];
          const ruleG = ruleParts[1];
          console.log(`  ê·œì¹™ ${ruleIndex + 1}: F="${ruleF}", G="${ruleG}"`);
        }
      });
    });

    // ì •ê·œí™”ë˜ì§€ ì•Šì€ ëª¨ë¸ë“¤ì˜ í†µê³„
    const unnormalizedModels = new Set();
    inventoryData.filter(item => !item.normalizedModel).forEach(item => {
      unnormalizedModels.add(`${item.originalF} | ${item.originalG}`);
    });
    console.log('ì •ê·œí™”ë˜ì§€ ì•Šì€ ëª¨ë¸ ì¡°í•© ê°œìˆ˜:', unnormalizedModels.size);
    console.log('ì •ê·œí™”ë˜ì§€ ì•Šì€ ëª¨ë¸ ì¡°í•© ìƒ˜í”Œ:', Array.from(unnormalizedModels).slice(0, 10));

    // ì •ê·œí™”ëœ ëª¨ë¸ë“¤ì˜ í†µê³„
    const normalizedModels = new Set();
    inventoryData.filter(item => item.normalizedModel).forEach(item => {
      normalizedModels.add(`${item.originalF} | ${item.originalG} -> ${item.normalizedModel}`);
    });
    console.log('ì •ê·œí™”ëœ ëª¨ë¸ ì¡°í•© ê°œìˆ˜:', normalizedModels.size);
    console.log('ì •ê·œí™”ëœ ëª¨ë¸ ì¡°í•© ìƒ˜í”Œ:', Array.from(normalizedModels).slice(0, 10));

    // ì •ê·œí™”ëœ ëª¨ë¸ë³„ë¡œ ì¬ê³  ìˆ˜ëŸ‰ ì§‘ê³„
    const inventoryByModel = {};
    const quantityDebug = [];

    // ì •ê·œí™”ëœ ëª¨ë¸ëª…ì—ì„œ Fì—´, Gì—´ ê°’ ì¶”ì¶œí•˜ì—¬ ì¬ê³  ìˆ˜ëŸ‰ ì°¾ê¸°
    const uniqueNormalizedModels = new Set();
    inventoryData.filter(item => item.normalizedModel).forEach(item => {
      uniqueNormalizedModels.add(item.normalizedModel);
    });

    uniqueNormalizedModels.forEach(normalizedModel => {
      // ì •ê·œí™”ëœ ëª¨ë¸ëª…ì—ì„œ Fì—´, Gì—´ ê°’ ì¶”ì¶œ
      // ì˜ˆ: "Z Fold7 512G ì‹¤ë²„ ì‰ë„ìš° SM-F966N_512G ì‹¤ë²„ ì‰ë„ìš°" -> F="SM-F966N_512G", G="ì‹¤ë²„ ì‰ë„ìš°"
      const modelParts = normalizedModel.split(' ');
      let extractedF = '';
      let extractedG = '';

      // ë§ˆì§€ë§‰ ë¶€ë¶„ì—ì„œ Fì—´ ê°’ ì¶”ì¶œ (SM-ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ë¶€ë¶„)
      for (let i = modelParts.length - 1; i >= 0; i--) {
        if (modelParts[i].startsWith('SM-')) {
          extractedF = modelParts[i];
          // Fì—´ ê°’ ì•ì˜ ìƒ‰ìƒ ë¶€ë¶„ì„ Gì—´ ê°’ìœ¼ë¡œ ì¶”ì¶œ
          if (i > 0) {
            extractedG = modelParts[i - 1];
            // ìƒ‰ìƒì´ ë‘ ë‹¨ì–´ì¼ ìˆ˜ ìˆìŒ (ì˜ˆ: "ì‹¤ë²„ ì‰ë„ìš°")
            if (i > 1 && !modelParts[i - 2].startsWith('SM-') && !modelParts[i - 2].includes('G')) {
              extractedG = modelParts[i - 2] + ' ' + modelParts[i - 1];
            }
          }
          break;
        }
      }

      console.log(`ì •ê·œí™”ëœ ëª¨ë¸ "${normalizedModel}" -> F="${extractedF}", G="${extractedG}"`);

      // í•´ë‹¹ F, G ì¡°í•©ì˜ ì´ í–‰ ìˆ˜ í™•ì¸
      const matchingRows = inventoryData.filter(item => item.originalF === extractedF && item.originalG === extractedG);
      console.log(`  ë§¤ì¹­ëœ í–‰ ìˆ˜: ${matchingRows.length}, ì´ ìˆ˜ëŸ‰: ${matchingRows.reduce((sum, item) => sum + item.quantity, 0)}`);

      // ì¶”ì¶œëœ Fì—´, Gì—´ ê°’ìœ¼ë¡œ í°í´ì¬ê³ ë°ì´í„°ì—ì„œ í•´ë‹¹ ì¡°í•©ì˜ ê°œìˆ˜ ì„¸ê¸°
      const matchingItems = inventoryData.filter(item =>
        item.originalF === extractedF && item.originalG === extractedG
      );

      const totalCount = matchingItems.length; // í•´ë‹¹ ì¡°í•©ì˜ ì´ ê°œìˆ˜

      console.log(`  ${extractedF} | ${extractedG} ì¡°í•© ê°œìˆ˜: ${totalCount}ê°œ`);

      inventoryByModel[normalizedModel] = totalCount;
    });

    console.log('ìˆ˜ëŸ‰ì´ ìˆëŠ” ì •ê·œí™”ëœ ì¬ê³  í•­ëª©ë“¤:', quantityDebug.slice(0, 10));
    console.log('ì „ì²´ ì¬ê³  ìˆ˜ëŸ‰ ë¶„í¬:', {
      ì´í•­ëª©ìˆ˜: inventoryData.length,
      ì •ê·œí™”ëœí•­ëª©ìˆ˜: inventoryData.filter(item => item.normalizedModel).length,
      ìˆ˜ëŸ‰ìˆëŠ”í•­ëª©ìˆ˜: inventoryData.filter(item => item.quantity > 0).length,
      ì •ê·œí™”ë˜ê³ ìˆ˜ëŸ‰ìˆëŠ”í•­ëª©ìˆ˜: inventoryData.filter(item => item.normalizedModel && item.quantity > 0).length
    });

    console.log('ì¬ê³  ëª¨ë¸ë³„ ì§‘ê³„ ê²°ê³¼:', Object.keys(inventoryByModel).length, 'ê°œ ëª¨ë¸');
    console.log('ì¬ê³  ëª¨ë¸ë³„ ì§‘ê³„ ìƒ˜í”Œ:', Object.entries(inventoryByModel).slice(0, 5));

    // ì •ê·œí™”ëœ ëª¨ë¸ë³„ë¡œ ì‚¬ì „ì˜ˆì•½ ê±´ìˆ˜ ì§‘ê³„
    const reservationByModel = {};
    reservationData.forEach(item => {
      if (item.normalizedModel) {
        if (!reservationByModel[item.normalizedModel]) {
          reservationByModel[item.normalizedModel] = 0;
        }
        reservationByModel[item.normalizedModel]++;
      }
    });

    // ì¬ê³  í˜„í™© ë¶„ì„ ê²°ê³¼ ìƒì„±
    const allModels = new Set([
      ...Object.keys(inventoryByModel),
      ...Object.keys(reservationByModel)
    ]);

    allModels.forEach(model => {
      const inventory = inventoryByModel[model] || 0;
      const reservations = reservationByModel[model] || 0;
      const remainingStock = inventory - reservations;

      inventoryAnalysis[model] = {
        inventory: inventory,
        reservations: reservations,
        remainingStock: remainingStock,
        status: remainingStock > 0 ? 'ì¶©ë¶„' : remainingStock === 0 ? 'ë¶€ì¡±' : 'ì´ˆê³¼ì˜ˆì•½'
      };
    });

    // 5. í†µê³„ ì •ë³´
    const totalInventory = Object.values(inventoryByModel).reduce((sum, qty) => sum + qty, 0);
    const totalReservations = Object.values(reservationByModel).reduce((sum, count) => sum + count, 0);
    const totalRemainingStock = Object.values(inventoryAnalysis).reduce((sum, item) => sum + item.remainingStock, 0);

    const stats = {
      totalModels: allModels.size,
      totalInventory: totalInventory,
      totalReservations: totalReservations,
      totalRemainingStock: totalRemainingStock,
      modelsWithSufficientStock: Object.values(inventoryAnalysis).filter(item => item.status === 'ì¶©ë¶„').length,
      modelsWithInsufficientStock: Object.values(inventoryAnalysis).filter(item => item.status === 'ë¶€ì¡±').length,
      modelsWithOverReservation: Object.values(inventoryAnalysis).filter(item => item.status === 'ì´ˆê³¼ì˜ˆì•½').length
    };

    res.json({
      success: true,
      inventoryAnalysis: inventoryAnalysis,
      stats: stats,
      inventoryByModel: inventoryByModel,
      reservationByModel: reservationByModel,
      storeCode: storeCode || 'all',
      storeCodeMapping: storeCodeMapping
    });
  } catch (error) {
    console.error('ì¬ê³  í˜„í™© ë¶„ì„ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to analyze inventory',
      message: error.message
    });
  }
});

// ì •ê·œí™” ìƒíƒœ í™•ì¸ API
app.get('/api/reservation-settings/normalization-status', async (req, res) => {
  try {
    console.log('ì •ê·œí™” ìƒíƒœ í™•ì¸ ìš”ì²­');

    // ì •ê·œí™” ê·œì¹™ë“¤ì„ ë¶ˆëŸ¬ì˜¤ê¸°
    let normalizationRules = [];
    try {
      const rulesResponse = await sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ì •ê·œí™”ì‘ì—…!A:G'
      });

      if (rulesResponse.data.values && rulesResponse.data.values.length > 1) {
        normalizationRules = rulesResponse.data.values.slice(1)
          .filter(row => row.length >= 6 && row[5] === 'ì™„ë£Œ')
          .map(row => ({
            reservationSite: row[1] || '',
            phonekl: row[2] || '',
            normalizedModel: row[3] || '',
            note: row[6] || ''
          }));
      }
    } catch (error) {
      console.log('ì •ê·œí™” ê·œì¹™ ë¡œë“œ ì‹¤íŒ¨:', error.message);
    }

    // ì •ê·œí™” ìƒíƒœ íŒë‹¨
    const isNormalized = normalizationRules.length > 0;
    const totalRules = normalizationRules.length;
    const completedRules = normalizationRules.filter(rule => rule.normalizedModel).length;

    console.log(`ì •ê·œí™” ìƒíƒœ í™•ì¸ ì™„ë£Œ: ${isNormalized ? 'ì™„ë£Œ' : 'ë¯¸ì™„ë£Œ'} (ì´ ${totalRules}ê°œ ê·œì¹™, ì™„ë£Œ ${completedRules}ê°œ)`);

    res.json({
      success: true,
      isNormalized,
      totalRules,
      completedRules,
      rules: normalizationRules
    });
  } catch (error) {
    console.error('ì •ê·œí™” ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to check normalization status',
      message: error.message
    });
  }
});

// ì •ê·œí™” ê·œì¹™ ì ìš© í…ŒìŠ¤íŠ¸ API
app.post('/api/reservation-settings/test-normalization', async (req, res) => {
  try {
    const { testData, dataType } = req.body; // dataType: 'reservationSite' ë˜ëŠ” 'phonekl'

    // ì •ê·œí™” ê·œì¹™ë“¤ì„ ë¶ˆëŸ¬ì˜¤ê¸°
    let normalizationRules = [];
    try {
      const rulesResponse = await sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ì •ê·œí™”ì‘ì—…!A:G'
      });

      if (rulesResponse.data.values && rulesResponse.data.values.length > 1) {
        normalizationRules = rulesResponse.data.values.slice(1)
          .filter(row => row.length >= 6 && row[5] === 'ì™„ë£Œ')
          .map(row => ({
            reservationSite: row[1] || '',
            phonekl: row[2] || '',
            normalizedModel: row[3] || '',
            note: row[6] || ''
          }));
      }
    } catch (error) {
      console.log('ì •ê·œí™” ê·œì¹™ ë¡œë“œ ì‹¤íŒ¨:', error.message);
    }

    // í…ŒìŠ¤íŠ¸ ë°ì´í„°ì— ì •ê·œí™” ê·œì¹™ ì ìš©
    const testResults = testData.map(item => {
      let normalizedModel = '';
      let appliedRule = null;

      if (dataType === 'reservationSite') {
        const { p, q, r } = item;

        for (const rule of normalizationRules) {
          const ruleParts = rule.reservationSite.split(' | ');
          if (ruleParts.length >= 3) {
            const ruleP = ruleParts[0];
            const ruleQ = ruleParts[1];
            const ruleR = ruleParts[2];

            const pMatch = !ruleP || p.includes(ruleP) || ruleP.includes(p);
            const qMatch = !ruleQ || q.includes(ruleQ) || ruleQ.includes(q);
            const rMatch = !ruleR || r.includes(ruleR) || ruleR.includes(r);

            if (pMatch && qMatch && rMatch) {
              normalizedModel = rule.normalizedModel;
              appliedRule = rule;
              break;
            }
          }
        }
      } else if (dataType === 'phonekl') {
        const { f, g } = item;

        for (const rule of normalizationRules) {
          const ruleParts = rule.phonekl.split(' | ');
          if (ruleParts.length >= 2) {
            const ruleF = ruleParts[0];
            const ruleG = ruleParts[1];

            const fMatch = !ruleF || f.includes(ruleF) || ruleF.includes(f);
            const gMatch = !ruleG || g.includes(ruleG) || ruleG.includes(g);

            if (fMatch && gMatch) {
              normalizedModel = rule.normalizedModel;
              appliedRule = rule;
              break;
            }
          }
        }
      }

      return {
        ...item,
        normalizedModel,
        appliedRule
      };
    });

    res.json({
      success: true,
      testResults,
      appliedRules: normalizationRules
    });
  } catch (error) {
    console.error('ì •ê·œí™” í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to test normalization',
      message: error.message
    });
  }
});

// ì‚¬ì „ì˜ˆì•½ ë°ì´í„° API ì—”ë“œí¬ì¸íŠ¸ë“¤
app.get('/api/reservation-data/on-sale-receipt', async (req, res) => {
  try {
    console.log('ì˜¨ì„¸ì¼ì ‘ìˆ˜ ë°ì´í„° ìš”ì²­');

    // ì˜¨ì„¸ì¼ ì‹œíŠ¸ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ê³ ê°ëª… + ëŒ€ë¦¬ì ì½”ë“œ ë§¤ì¹­ìš©)
    const sheetName = 'ì˜¨ì„¸ì¼';
    const values = await getSheetValues(sheetName);

    if (!values || values.length === 0) {
      console.log('ì˜¨ì„¸ì¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return res.json({ success: true, data: [] });
    }

    // í—¤ë” ì œê±°í•˜ê³  ë°ì´í„° ì²˜ë¦¬
    const headers = values[0];
    const dataRows = values.slice(1);

    const processedData = dataRows
      .filter(row => row.length > 0 && row.some(cell => cell && cell.toString().trim() !== ''))
      .map((row, index) => {
        // ê³ ê°ëª… (Cì—´)
        const customerName = row[2] ? row[2].toString().trim() : '';

        // ê°€ì…ëŒ€ë¦¬ì ì½”ë“œ (Mì—´)
        const storeCode = row[12] ? row[12].toString().trim() : '';

        // ëª¨ë¸ëª… (Dì—´)
        const model = row[3] ? row[3].toString().trim() : '';

        // ìƒ‰ìƒ (Eì—´)
        const color = row[4] ? row[4].toString().trim() : '';

        // ì ‘ìˆ˜ì‹œê°„ (Fì—´)
        const receiptTime = row[5] ? row[5].toString().trim() : '';

        // ìœ íš¨í•œ ë°ì´í„°ë§Œ ë°˜í™˜
        if (customerName && storeCode && model && color) {
          return {
            customerName,
            storeCode,
            model,
            color,
            receiptTime,
            source: 'onSale'
          };
        }
        return null;
      })
      .filter(item => item !== null);

    console.log(`ì˜¨ì„¸ì¼ ë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ: ${processedData.length}ê±´`);

    res.json({ success: true, data: processedData });

  } catch (error) {
    console.error('ì˜¨ì„¸ì¼ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

app.get('/api/reservation-data/yard-receipt', async (req, res) => {
  try {
    console.log('ë§ˆë‹¹ì ‘ìˆ˜ ë°ì´í„° ìš”ì²­');

    // ë§ˆë‹¹ì ‘ìˆ˜ ì‹œíŠ¸ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const sheetName = 'ë§ˆë‹¹ì ‘ìˆ˜';
    const values = await getSheetValues(sheetName);

    if (!values || values.length === 0) {
      console.log('ë§ˆë‹¹ì ‘ìˆ˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return res.json({ success: true, data: [] });
    }

    // í—¤ë” ì œê±°í•˜ê³  ë°ì´í„° ì²˜ë¦¬
    const headers = values[0];
    const dataRows = values.slice(1);

    const processedData = dataRows
      .filter(row => row.length > 0 && row.some(cell => cell && cell.toString().trim() !== ''))
      .map((row, index) => {
        // ì˜ˆì•½ë²ˆí˜¸ (U, Vì—´ì—ì„œ ì¶”ì¶œ)
        let reservationNumber = '';
        if (row[20]) { // Uì—´
          const match = row[20].toString().match(/[A-Z]{2}\d+/);
          if (match) reservationNumber = match[0];
        }
        if (!reservationNumber && row[21]) { // Vì—´
          const match = row[21].toString().match(/[A-Z]{2}\d+/);
          if (match) reservationNumber = match[0];
        }

        // ê³ ê°ëª… (Bì—´)
        const customerName = row[1] ? row[1].toString().trim() : '';

        // ëª¨ë¸ëª… (Cì—´)
        const model = row[2] ? row[2].toString().trim() : '';

        // ìƒ‰ìƒ (Dì—´)
        const color = row[3] ? row[3].toString().trim() : '';

        // ì ‘ìˆ˜ì‹œê°„ (Lì—´)
        const receiptTime = row[11] ? row[11].toString().trim() : '';

        // ìœ íš¨í•œ ë°ì´í„°ë§Œ ë°˜í™˜
        if (reservationNumber && customerName && model && color) {
          return {
            reservationNumber,
            customerName,
            model,
            color,
            receiptTime,
            source: 'yard'
          };
        }
        return null;
      })
      .filter(item => item !== null);

    console.log(`ë§ˆë‹¹ì ‘ìˆ˜ ë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ: ${processedData.length}ê±´`);

    res.json({ success: true, data: processedData });

  } catch (error) {
    console.error('ë§ˆë‹¹ì ‘ìˆ˜ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

app.get('/api/reservation-data/reservation-site', async (req, res) => {
  try {
    // ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ë°ì´í„° ìš”ì²­

    // ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ì‹œíŠ¸ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const sheetName = 'ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸';
    const values = await getSheetValues(sheetName);

    if (!values || values.length === 0) {
      console.log('ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return res.json({ success: true, data: [] });
    }

    // í—¤ë” ì œê±°í•˜ê³  ë°ì´í„° ì²˜ë¦¬
    const headers = values[0];
    const dataRows = values.slice(1);

    const processedData = dataRows
      .filter(row => row.length > 0 && row.some(cell => cell && cell.toString().trim() !== ''))
      .map((row, index) => {
        // ì˜ˆì•½ë²ˆí˜¸ (Iì—´)
        const reservationNumber = row[8] ? row[8].toString().replace(/-/g, '') : '';

        // ê³ ê°ëª… (Hì—´)
        const customerName = row[7] ? row[7].toString().trim() : '';

        // ëŒ€ë¦¬ì ì½”ë“œ (Xì—´)
        const storeCode = row[23] ? row[23].toString().trim() : '';

        // ëª¨ë¸ëª… (P, Q, Rì—´ ì¡°í•©)
        const pValue = row[15] ? row[15].toString().trim() : '';
        const qValue = row[16] ? row[16].toString().trim() : '';
        const rValue = row[17] ? row[17].toString().trim() : '';

        // ìƒ‰ìƒ (Qì—´)
        const color = qValue;

        // ì ‘ìˆ˜ì‹œê°„ (Oì—´)
        const receiptTime = row[14] ? row[14].toString().trim() : '';

        // ìœ íš¨í•œ ë°ì´í„°ë§Œ ë°˜í™˜
        if (reservationNumber && customerName && pValue && qValue && rValue) {
          return {
            reservationNumber,
            customerName,
            storeCode,
            model: `${pValue} ${qValue} ${rValue}`.trim(),
            color,
            receiptTime,
            source: 'site'
          };
        }
        return null;
      })
      .filter(item => item !== null);

    console.log(`ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ: ${processedData.length}ê±´`);

    res.json({ success: true, data: processedData });

  } catch (error) {
    console.error('ì‚¬ì „ì˜ˆì•½ì‚¬ì´íŠ¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// ì›”ê°„ì‹œìƒ API ë¼ìš°íŠ¸
app.get('/api/monthly-award/data', monthlyAwardAPI.getMonthlyAwardData);
app.post('/api/monthly-award/settings', monthlyAwardAPI.saveMonthlyAwardSettings);

// ì–´í”Œì—…ë°ì´íŠ¸ API ë¼ìš°íŠ¸
app.get('/api/app-updates', async (req, res) => {
  try {
    console.log('ì–´í”Œì—…ë°ì´íŠ¸ ë°ì´í„° ìš”ì²­');

    const values = await getSheetValues(UPDATE_SHEET_NAME);

    if (!values || values.length === 0) {
      console.log('ì–´í”Œì—…ë°ì´íŠ¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return res.json({ success: true, data: [] });
    }

    // í—¤ë” 2í–‰ ì œê±°í•˜ê³  ë°ì´í„° ë°˜í™˜ (3í–‰ë¶€í„° ì‹œì‘)
    const dataRows = values.slice(2);

    // ë¹ˆ í–‰ ì œê±°
    const filteredData = dataRows.filter(row =>
      row.length > 0 && row.some(cell => cell && cell.toString().trim() !== '')
    );

    console.log(`ì–´í”Œì—…ë°ì´íŠ¸ ë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ: ${filteredData.length}ê±´`);

    res.json({ success: true, data: filteredData });

  } catch (error) {
    console.error('ì–´í”Œì—…ë°ì´íŠ¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

app.post('/api/app-updates', async (req, res) => {
  try {
    console.log('ìƒˆ ì–´í”Œì—…ë°ì´íŠ¸ ì¶”ê°€ ìš”ì²­:', req.body);

    // í™˜ê²½ ë³€ìˆ˜ ì²´í¬
    if (!SPREADSHEET_ID) {
      console.error('âŒ [ì–´í”Œì—…ë°ì´íŠ¸] SHEET_ID í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ');
      return res.status(500).json({
        success: false,
        error: 'ì„œë²„ ì„¤ì • ì˜¤ë¥˜: SHEET_IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'
      });
    }

    const { mode, date, content } = req.body;

    if (!mode || !date || !content) {
      return res.status(400).json({
        success: false,
        error: 'ëª¨ë“œ, ë‚ ì§œ, ë‚´ìš©ì´ ëª¨ë‘ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }

    // ëª¨ë“œë³„ ì»¬ëŸ¼ ë§¤í•‘
    const modeColumnMap = {
      'general': 2,              // Cì—´: ì¼ë°˜ëª¨ë“œ
      'basicMode': 2,            // Cì—´: ê¸°ë³¸ ëª¨ë“œ (ë³„ì¹­)
      'basic': 2,                // Cì—´: ê¸°ë³¸ ëª¨ë“œ (ë³„ì¹­)
      'agent': 3,                // Dì—´: ê´€ë¦¬ìëª¨ë“œ
      'inventory': 4,            // Eì—´: ì¬ê³ ê´€ë¦¬ëª¨ë“œ
      'settlement': 5,           // Fì—´: ì •ì‚°ëª¨ë“œ
      'inspection': 6,           // Gì—´: ê²€ìˆ˜ëª¨ë“œ
      'policy': 7,               // Hì—´: ì •ì±…ëª¨ë“œ
      'meeting': 8,              // Iì—´: íšŒì˜ëª¨ë“œ
      'reservation': 9,          // Jì—´: ì‚¬ì „ì˜ˆì•½ëª¨ë“œ
      'chart': 10,               // Kì—´: ì¥í‘œëª¨ë“œ
      'budget': 11,              // Lì—´: ì˜ˆì‚°ëª¨ë“œ
      'sales': 12,               // Mì—´: ì˜ì—…ëª¨ë“œ
      'inventoryRecovery': 13,   // Nì—´: ì¬ê³ íšŒìˆ˜ëª¨ë“œ
      'inventory-recovery': 13,  // ë³„ì¹­
      'dataCollection': 14,      // Oì—´: ì •ë³´ìˆ˜ì§‘ëª¨ë“œ
      'data-collection': 14,     // ë³„ì¹­
      'smsManagement': 15,       // Pì—´: SMS ê´€ë¦¬ëª¨ë“œ
      'sms-management': 15,      // ë³„ì¹­
      'obManagement': 16,        // Qì—´: OB ê´€ë¦¬ëª¨ë“œ
      'ob-management': 16,       // ë³„ì¹­
      'onSaleManagement': 17,    // Rì—´: ì˜¨ì„¸ì¼ê´€ë¦¬ëª¨ë“œ
      'onsale-management': 17,   // ë³„ì¹­
      'onSaleReception': 18,     // Sì—´: ì˜¨ì„¸ì¼ì ‘ìˆ˜ëª¨ë“œ
      'onsale-reception': 18,    // ë³„ì¹­
      'mealAllowance': 19,       // Tì—´: ì‹ëŒ€ ëª¨ë“œ
      'attendance': 20,          // Uì—´: ê·¼í‡´ ëª¨ë“œ
      'riskManagement': 21,      // Vì—´: ë¦¬ìŠ¤í¬ ê´€ë¦¬ ëª¨ë“œ
      'directStoreManagement': 22, // Wì—´: ì§ì˜ì  ê´€ë¦¬ ëª¨ë“œ
      'directStore': 23,         // Xì—´: ì§ì˜ì  ëª¨ë“œ (ì¼ë°˜)
      'quickServiceManagement': 24 // Yì—´: í€µì„œë¹„ìŠ¤ ê´€ë¦¬ ëª¨ë“œ
    };

    const columnIndex = modeColumnMap[mode];
    if (columnIndex === undefined) {
      return res.status(400).json({
        success: false,
        error: 'ìœ íš¨í•˜ì§€ ì•Šì€ ëª¨ë“œì…ë‹ˆë‹¤.'
      });
    }

    // ìƒˆ í–‰ ë°ì´í„° ìƒì„±
    const newRow = new Array(25).fill(''); // A~Yì—´ (25ê°œ ì»¬ëŸ¼)
    newRow[0] = date;  // Aì—´: ë‚ ì§œ
    newRow[columnIndex] = content;  // í•´ë‹¹ ëª¨ë“œ ì»¬ëŸ¼ì— ë‚´ìš©

    // Google Sheetsì— ìƒˆ í–‰ ì¶”ê°€
    const response = await sheets.spreadsheets.values.append({
      spreadsheetId: SPREADSHEET_ID,
      range: `${UPDATE_SHEET_NAME}!A:Y`,
      valueInputOption: 'RAW',
      insertDataOption: 'INSERT_ROWS',
      resource: {
        values: [newRow]
      }
    });

    console.log('ì–´í”Œì—…ë°ì´íŠ¸ ì¶”ê°€ ì™„ë£Œ:', response.data);

    res.json({
      success: true,
      message: 'ì—…ë°ì´íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.',
      data: response.data
    });

  } catch (error) {
    console.error('ì–´í”Œì—…ë°ì´íŠ¸ ì¶”ê°€ ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// ì •ì±… ì·¨ì†Œ API
app.put('/api/policies/:policyId/cancel', async (req, res) => {
  try {
    const { policyId } = req.params;
    const { cancelReason, userId, userName } = req.body;

    console.log('ì •ì±… ì·¨ì†Œ ìš”ì²­:', { policyId, cancelReason, userId, userName });

    if (!cancelReason || !userId) {
      return res.status(400).json({
        success: false,
        error: 'ì·¨ì†Œ ì‚¬ìœ ì™€ ì‚¬ìš©ì ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }

    // ì •ì±…_ê¸°ë³¸ì •ë³´ ì‹œíŠ¸ì—ì„œ í•´ë‹¹ ì •ì±… ì°¾ê¸°
    const values = await getSheetValues('ì •ì±…_ê¸°ë³¸ì •ë³´ ');

    if (!values || values.length <= 1) {
      return res.status(404).json({
        success: false,
        error: 'ì •ì±…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }

    const dataRows = values.slice(1);
    const policyRowIndex = dataRows.findIndex(row => row[0] === policyId);

    if (policyRowIndex === -1) {
      return res.status(404).json({
        success: false,
        error: 'ì •ì±…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }

    const policyRow = dataRows[policyRowIndex];
    const inputUserId = policyRow[9]; // Jì—´: ì…ë ¥ìID

    // ë³¸ì¸ì´ ì…ë ¥í•œ ì •ì±…ì¸ì§€ í™•ì¸
    if (inputUserId !== userId) {
      return res.status(403).json({
        success: false,
        error: 'ë³¸ì¸ì´ ì…ë ¥í•œ ì •ì±…ë§Œ ì·¨ì†Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'
      });
    }

    // ì •ì±… ìƒíƒœë¥¼ ì·¨ì†Œë¡œ ë³€ê²½
    const updatedRow = [...policyRow];
    updatedRow[15] = 'ì·¨ì†Œë¨'; // Pì—´: ì •ì±…ìƒíƒœ
    updatedRow[16] = cancelReason; // Qì—´: ì·¨ì†Œì‚¬ìœ 
    updatedRow[17] = new Date().toISOString(); // Rì—´: ì·¨ì†Œì¼ì‹œ
    updatedRow[18] = userName; // Sì—´: ì·¨ì†Œìëª…

    // Google Sheets ì—…ë°ì´íŠ¸
    const response = await sheets.spreadsheets.values.update({
      spreadsheetId: SPREADSHEET_ID,
      range: `ì •ì±…_ê¸°ë³¸ì •ë³´ !A${policyRowIndex + 2}:X${policyRowIndex + 2}`,
      valueInputOption: 'RAW',
      resource: {
        values: [updatedRow]
      }
    });

    // ì·¨ì†Œ ì•Œë¦¼ ìƒì„±
    await createPolicyNotification(policyId, userId, 'policy_cancelled', { cancelReason });

    // ì •ì±…_ê¸°ë³¸ì •ë³´ ì‹œíŠ¸ ìºì‹œ ë¬´íš¨í™”
    cacheUtils.delete('sheet_ì •ì±…_ê¸°ë³¸ì •ë³´ ');

    console.log('ì •ì±… ì·¨ì†Œ ì™„ë£Œ:', response.data);

    res.json({
      success: true,
      message: 'ì •ì±…ì´ ì„±ê³µì ìœ¼ë¡œ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.'
    });

  } catch (error) {
    console.error('ì •ì±… ì·¨ì†Œ ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// ìŠ¹ì¸ ì·¨ì†Œ API
app.put('/api/policies/:policyId/approval-cancel', async (req, res) => {
  try {
    const { policyId } = req.params;
    const { cancelReason, userId, userName, approvalType } = req.body;

    console.log('ìŠ¹ì¸ ì·¨ì†Œ ìš”ì²­:', { policyId, cancelReason, userId, userName, approvalType });

    if (!cancelReason || !userId || !approvalType) {
      return res.status(400).json({
        success: false,
        error: 'ì·¨ì†Œ ì‚¬ìœ , ì‚¬ìš©ì ì •ë³´, ìŠ¹ì¸ ìœ í˜•ì´ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }

    // ì •ì±…_ê¸°ë³¸ì •ë³´ ì‹œíŠ¸ì—ì„œ í•´ë‹¹ ì •ì±… ì°¾ê¸°
    const values = await getSheetValues('ì •ì±…_ê¸°ë³¸ì •ë³´ ');

    if (!values || values.length <= 1) {
      return res.status(404).json({
        success: false,
        error: 'ì •ì±…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }

    const dataRows = values.slice(1);
    const policyRowIndex = dataRows.findIndex(row => row[0] === policyId);

    if (policyRowIndex === -1) {
      return res.status(404).json({
        success: false,
        error: 'ì •ì±…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }

    const policyRow = dataRows[policyRowIndex];

    // ìŠ¹ì¸ ìƒíƒœ í™•ì¸ ë° ì—…ë°ì´íŠ¸
    const updatedRow = [...policyRow];
    let approvalColumn = '';

    switch (approvalType) {
      case 'total':
        approvalColumn = 'M'; // Mì—´: ìŠ¹ì¸ìƒíƒœ_ì´ê´„
        break;
      case 'settlement':
        approvalColumn = 'N'; // Nì—´: ìŠ¹ì¸ìƒíƒœ_ì •ì‚°íŒ€
        break;
      case 'team':
        approvalColumn = 'O'; // Oì—´: ìŠ¹ì¸ìƒíƒœ_ì†Œì†íŒ€
        break;
      default:
        return res.status(400).json({
          success: false,
          error: 'ì˜ëª»ëœ ìŠ¹ì¸ ìœ í˜•ì…ë‹ˆë‹¤.'
        });
    }

    // ìŠ¹ì¸ ìƒíƒœë¥¼ ëŒ€ê¸°ë¡œ ë³€ê²½
    const columnIndex = approvalColumn === 'M' ? 12 : approvalColumn === 'N' ? 13 : 14;
    updatedRow[columnIndex] = 'ëŒ€ê¸°';

    // ì·¨ì†Œ ì´ë ¥ì„ ì •ì±…_ìŠ¹ì¸ì´ë ¥ ì‹œíŠ¸ì— ê¸°ë¡
    const approvalHistoryRow = [
      policyId,                    // Aì—´: ì •ì±…ID
      approvalType,                // Bì—´: ìŠ¹ì¸ìœ í˜•
      'ì·¨ì†Œ',                      // Cì—´: ìŠ¹ì¸ìƒíƒœ
      cancelReason,                // Dì—´: ì‚¬ìœ 
      new Date().toISOString(),    // Eì—´: ì²˜ë¦¬ì¼ì‹œ
      userName,                    // Fì—´: ì²˜ë¦¬ìëª…
      userId                       // Gì—´: ì²˜ë¦¬ìID
    ];

    await sheets.spreadsheets.values.append({
      spreadsheetId: SPREADSHEET_ID,
      range: 'ì •ì±…_ìŠ¹ì¸ì´ë ¥ !A:G',
      valueInputOption: 'RAW',
      insertDataOption: 'INSERT_ROWS',
      resource: {
        values: [approvalHistoryRow]
      }
    });

    // Google Sheets ì—…ë°ì´íŠ¸
    const response = await sheets.spreadsheets.values.update({
      spreadsheetId: SPREADSHEET_ID,
      range: `ì •ì±…_ê¸°ë³¸ì •ë³´ !A${policyRowIndex + 2}:X${policyRowIndex + 2}`,
      valueInputOption: 'RAW',
      resource: {
        values: [updatedRow]
      }
    });

    // ìŠ¹ì¸ ì·¨ì†Œ ì•Œë¦¼ ìƒì„±
    await createPolicyNotification(policyId, userId, 'approval_cancelled', {
      approvalType,
      cancelReason
    });

    // ì •ì±…_ê¸°ë³¸ì •ë³´ ì‹œíŠ¸ ìºì‹œ ë¬´íš¨í™”
    cacheUtils.delete('sheet_ì •ì±…_ê¸°ë³¸ì •ë³´ ');

    console.log('ìŠ¹ì¸ ì·¨ì†Œ ì™„ë£Œ:', response.data);

    res.json({
      success: true,
      message: 'ìŠ¹ì¸ì´ ì„±ê³µì ìœ¼ë¡œ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.'
    });

  } catch (error) {
    console.error('ìŠ¹ì¸ ì·¨ì†Œ ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// ì •ì‚° ë°˜ì˜ API
app.put('/api/policies/:policyId/settlement-reflect', async (req, res) => {
  try {
    const { policyId } = req.params;
    const { userId, userName, isReflected } = req.body;

    console.log('ì •ì‚° ë°˜ì˜ ìš”ì²­:', { policyId, userId, userName, isReflected });

    if (!userId || !userName) {
      return res.status(400).json({
        success: false,
        error: 'ì‚¬ìš©ì ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }

    // ì •ì±…_ê¸°ë³¸ì •ë³´ ì‹œíŠ¸ì—ì„œ í•´ë‹¹ ì •ì±… ì°¾ê¸°
    const values = await getSheetValues('ì •ì±…_ê¸°ë³¸ì •ë³´ ');

    if (!values || values.length <= 1) {
      return res.status(404).json({
        success: false,
        error: 'ì •ì±…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }

    const dataRows = values.slice(1);
    const policyRowIndex = dataRows.findIndex(row => row[0] === policyId);

    if (policyRowIndex === -1) {
      return res.status(404).json({
        success: false,
        error: 'ì •ì±…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }

    const policyRow = dataRows[policyRowIndex];

    // ì •ì‚° ë°˜ì˜ ìƒíƒœ ì—…ë°ì´íŠ¸
    // A:X ë²”ìœ„(24ê°œ ì»¬ëŸ¼)ì— ë§ì¶° ë°°ì—´ì„ 24ê°œë¡œ ì œí•œ
    const updatedRow = [...policyRow].slice(0, 24);
    updatedRow[19] = isReflected ? 'ë°˜ì˜ë¨' : 'ë¯¸ë°˜ì˜'; // Tì—´: ì •ì‚°ë°˜ì˜ìƒíƒœ
    updatedRow[20] = isReflected ? userName : ''; // Uì—´: ì •ì‚°ë°˜ì˜ìëª…
    updatedRow[21] = isReflected ? new Date().toISOString() : ''; // Vì—´: ì •ì‚°ë°˜ì˜ì¼ì‹œ
    updatedRow[22] = isReflected ? userId : ''; // Wì—´: ì •ì‚°ë°˜ì˜ìID

    // Google Sheets ì—…ë°ì´íŠ¸
    const response = await sheets.spreadsheets.values.update({
      spreadsheetId: SPREADSHEET_ID,
      range: `ì •ì±…_ê¸°ë³¸ì •ë³´ !A${policyRowIndex + 2}:X${policyRowIndex + 2}`,
      valueInputOption: 'RAW',
      resource: {
        values: [updatedRow]
      }
    });

    // ì •ì‚° ë°˜ì˜ ì•Œë¦¼ ìƒì„±
    await createPolicyNotification(policyId, userId, 'settlement_reflected', {
      isReflected,
      userName
    });

    // ì •ì±…_ê¸°ë³¸ì •ë³´ ì‹œíŠ¸ ìºì‹œ ë¬´íš¨í™”
    cacheUtils.delete('sheet_ì •ì±…_ê¸°ë³¸ì •ë³´ ');

    console.log('ì •ì‚° ë°˜ì˜ ì™„ë£Œ:', response.data);

    res.json({
      success: true,
      message: `ì •ì±…ì´ ì •ì‚°ì— ${isReflected ? 'ë°˜ì˜' : 'ë¯¸ë°˜ì˜'} ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`
    });

  } catch (error) {
    console.error('ì •ì‚° ë°˜ì˜ ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// ì •ì±… ê´€ë ¨ API ë¼ìš°íŠ¸
app.get('/api/policies', async (req, res) => {
  try {
    console.log('ì •ì±… ëª©ë¡ ì¡°íšŒ ìš”ì²­:', req.query);

    const { yearMonth, policyType, category, userId, approvalStatus } = req.query;

    // ì •ì±…_ê¸°ë³¸ì •ë³´ ì‹œíŠ¸ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ìºì‹œ ë¬´ì‹œí•˜ê³  ì§ì ‘ ì¡°íšŒ)
    const values = await getSheetValuesWithoutCache('ì •ì±…_ê¸°ë³¸ì •ë³´ ');

    console.log(`ğŸ“Š [ì •ì±…ì¡°íšŒ] ì‹œíŠ¸ì—ì„œ ê°€ì ¸ì˜¨ ë°ì´í„°:`, {
      totalRows: values ? values.length : 0,
      firstRow: values && values.length > 0 ? values[0] : null,
      lastRow: values && values.length > 1 ? values[values.length - 1] : null
    });

    if (!values || values.length === 0) {
      console.log('ì •ì±… ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return res.json({ success: true, policies: [] });
    }

    // í—¤ë”ê°€ ìˆëŠ” ê²½ìš° í—¤ë” ì œê±°
    const dataRows = values.length > 1 ? values.slice(1) : values;

    if (dataRows.length === 0) {
      console.log('ì •ì±… ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return res.json({ success: true, policies: [] });
    }



    // í•„í„°ë§ ì ìš©
    let filteredPolicies = dataRows.filter(row => {
      if (row.length < 24) return false; // ìµœì†Œ ì»¬ëŸ¼ ìˆ˜ í™•ì¸ (A~Xì—´, ê¸°ì¡´ ë°ì´í„° í˜¸í™˜ì„±)

      const policyYearMonth = row[23] || ''; // Xì—´: ëŒ€ìƒë…„ì›”
      const policyTypeData = row[6];   // Gì—´: ì •ì±…ìœ í˜•
      const categoryData = row[7];     // Hì—´: ë¬´ì„ /ìœ ì„ 
      const subCategory = row[8];      // Iì—´: í•˜ìœ„ì¹´í…Œê³ ë¦¬
      const inputUserId = row[9];      // Jì—´: ì…ë ¥ìID
      const totalApproval = row[12];   // Mì—´: ìŠ¹ì¸ìƒíƒœ_ì´ê´„
      const settlementApproval = row[13]; // Nì—´: ìŠ¹ì¸ìƒíƒœ_ì •ì‚°íŒ€
      const teamApproval = row[14];    // Oì—´: ìŠ¹ì¸ìƒíƒœ_ì†Œì†íŒ€

      // console.log(`ğŸ” [ì •ì±…í•„í„°] ì •ì±… í•„í„°ë§:`, {
      //   rowId: row[0], // Aì—´: ì •ì±…ID
      //   policyYearMonth,
      //   policyTypeData,
      //   categoryData,
      //   subCategory,
      //   inputUserId,
      //   filters: { yearMonth, policyType, category, userId, approvalStatus }
      // });

      // ì •ì±…ì´ í†µê³¼í–ˆëŠ”ì§€ í™•ì¸
      const passed = true; // ê¸°ë³¸ì ìœ¼ë¡œ í†µê³¼
      if (passed) {
        // console.log(`âœ… [ì •ì±…í•„í„°] ì •ì±… í†µê³¼: ${row[0]}`);
      }

      // ë…„ì›” í•„í„°
      if (yearMonth && policyYearMonth && policyYearMonth !== yearMonth) {
        // console.log(`âŒ [ì •ì±…í•„í„°] yearMonth ë¶ˆì¼ì¹˜: ${policyYearMonth} !== ${yearMonth}`);
        return false;
      }

      // ë…„ì›” í•„í„° í†µê³¼ ë¡œê·¸
      if (yearMonth && policyYearMonth && policyYearMonth === yearMonth) {
        console.log(`âœ… [ì •ì±…í•„í„°] yearMonth ì¼ì¹˜: ${policyYearMonth} === ${yearMonth}`);
      }

      // ì •ì±…ìœ í˜• í•„í„° (URL ë””ì½”ë”© ë° ì²˜ë¦¬)
      if (policyType) {
        const decodedPolicyType = decodeURIComponent(policyType);
        // "ë¬´ì„ :1" í˜•íƒœì—ì„œ "ë¬´ì„ " ë¶€ë¶„ë§Œ ì¶”ì¶œ
        const cleanPolicyType = decodedPolicyType.split(':')[0];
        if (policyTypeData !== cleanPolicyType) {
          // console.log(`âŒ [ì •ì±…í•„í„°] policyType ë¶ˆì¼ì¹˜: ${policyTypeData} !== ${cleanPolicyType}`);
          return false;
        }
      }

      // ì¹´í…Œê³ ë¦¬ í•„í„°
      if (category && subCategory !== category) {
        // console.log(`âŒ [ì •ì±…í•„í„°] category ë¶ˆì¼ì¹˜: ${subCategory} !== ${category}`);
        return false;
      }

      // ì‚¬ìš©ì í•„í„°
      if (userId && inputUserId !== userId) {
        // console.log(`âŒ [ì •ì±…í•„í„°] userId ë¶ˆì¼ì¹˜: ${inputUserId} !== ${userId}`);
        return false;
      }

      // ìŠ¹ì¸ìƒíƒœ í•„í„°
      if (approvalStatus) {
        const hasApprovalStatus = [totalApproval, settlementApproval, teamApproval].includes(approvalStatus);
        if (!hasApprovalStatus) {
          // console.log(`âŒ [ì •ì±…í•„í„°] approvalStatus ë¶ˆì¼ì¹˜`);
          return false;
        }
      }

      // console.log(`âœ… [ì •ì±…í•„í„°] ì •ì±… í†µê³¼: ${row[0]}`);
      return true;
    });

    // ë§¤ì¥ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì—…ì²´ëª… ë§¤í•‘ìš©)
    let storeData = [];
    try {
      const storeValues = await getSheetValuesWithoutCache(STORE_SHEET_NAME);
      if (storeValues && storeValues.length > 1) {
        const storeRows = storeValues.slice(1);
        storeData = storeRows
          .filter(row => {
            const name = (row[14] || '').toString().trim();  // Oì—´: ì—…ì²´ëª… (14ì¸ë±ìŠ¤)
            const status = row[12];                          // Mì—´: ê±°ë˜ìƒíƒœ (12ë²ˆì§¸ ì»¬ëŸ¼)
            return name && status === "ì‚¬ìš©";
          })
          .map(row => ({
            id: row[15],                        // Pì—´: ë§¤ì¥ì½”ë“œ (15ì¸ë±ìŠ¤)
            name: row[14].toString().trim()   // Oì—´: ì—…ì²´ëª… (14ì¸ë±ìŠ¤)
          }));
      }
    } catch (error) {
      console.warn('ë§¤ì¥ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error.message);
    }

    // ë§¤ì¥ IDë¡œ ì—…ì²´ëª…ì„ ì°¾ëŠ” í•¨ìˆ˜
    const getStoreNameById = (storeId) => {
      if (!storeId || !storeData.length) return '';
      const store = storeData.find(s => s.id && s.id.toString() === storeId.toString());
      return store ? store.name : '';
    };

    // ì •ì±… ë°ì´í„° ë³€í™˜
    const policies = filteredPolicies.map(row => {
      const policyStore = row[3]; // Dì—´: ì •ì±…ì ìš©ì 
      const storeName = getStoreNameById(policyStore);

      return {
        id: row[0],                    // Aì—´: ì •ì±…ID
        policyName: row[1],            // Bì—´: ì •ì±…ëª…
        policyDate: row[2],            // Cì—´: ì •ì±…ì ìš©ì¼ (ì‹œì‘ì¼~ì¢…ë£Œì¼)
        policyStore: policyStore,      // Dì—´: ì •ì±…ì ìš©ì  (ì½”ë“œ)
        policyStoreName: storeName,    // ë§¤ì¥ëª… (ë§¤í•‘ëœ ì—…ì²´ëª…)
        policyContent: row[4],         // Eì—´: ì •ì±…ë‚´ìš©
        policyAmount: (() => {         // Fì—´: ê¸ˆì•¡ (ê¸ˆì•¡ + ìœ í˜•)
          const amountStr = row[5] || '';
          // "100,000ì› (ì´ê¸ˆì•¡)" í˜•ì‹ì—ì„œ ìˆ«ìë§Œ ì¶”ì¶œ
          const match = amountStr.match(/^([\d,]+)ì›/);
          if (match) {
            return match[1].replace(/,/g, ''); // ì‰¼í‘œ ì œê±°í•˜ê³  ìˆ«ìë§Œ ë°˜í™˜
          }
          return amountStr;
        })(),
        amountType: (() => {           // Fì—´ì—ì„œ ê¸ˆì•¡ ìœ í˜• ì¶”ì¶œ
          const amountStr = row[5] || '';
          if (amountStr.includes('ì´ê¸ˆì•¡')) return 'total';
          if (amountStr.includes('ê±´ë‹¹ê¸ˆì•¡')) return 'per_case';
          if (amountStr.includes('ë‚´ìš©ì— ì§ì ‘ì…ë ¥')) return 'in_content';
          return 'total';
        })(),
        policyType: row[6],            // Gì—´: ì •ì±…ìœ í˜•
        wirelessWired: row[7],         // Hì—´: ë¬´ì„ /ìœ ì„ 
        category: row[8],              // Iì—´: í•˜ìœ„ì¹´í…Œê³ ë¦¬
        inputUserId: row[9],           // Jì—´: ì…ë ¥ìID
        inputUserName: row[10],        // Kì—´: ì…ë ¥ìëª…
        inputDateTime: row[11],        // Lì—´: ì…ë ¥ì¼ì‹œ
        approvalStatus: {
          total: row[12] || 'ëŒ€ê¸°',     // Mì—´: ìŠ¹ì¸ìƒíƒœ_ì´ê´„
          settlement: row[13] || 'ëŒ€ê¸°', // Nì—´: ìŠ¹ì¸ìƒíƒœ_ì •ì‚°íŒ€
          team: row[14] || 'ëŒ€ê¸°'       // Oì—´: ìŠ¹ì¸ìƒíƒœ_ì†Œì†íŒ€
        },
        // ì·¨ì†Œ ê´€ë ¨ ì •ë³´ ì¶”ê°€
        policyStatus: row[15] || 'í™œì„±', // Pì—´: ì •ì±…ìƒíƒœ
        cancelReason: row[16] || '',    // Qì—´: ì·¨ì†Œì‚¬ìœ 
        cancelDateTime: row[17] || '',  // Rì—´: ì·¨ì†Œì¼ì‹œ
        cancelUserName: row[18] || '',  // Sì—´: ì·¨ì†Œìëª…
        // ì •ì‚° ë°˜ì˜ ê´€ë ¨ ì •ë³´ ì¶”ê°€
        settlementStatus: row[19] || 'ë¯¸ë°˜ì˜', // Tì—´: ì •ì‚°ë°˜ì˜ìƒíƒœ
        settlementUserName: row[20] || '',     // Uì—´: ì •ì‚°ë°˜ì˜ìëª…
        settlementDateTime: row[21] || '',     // Vì—´: ì •ì‚°ë°˜ì˜ì¼ì‹œ
        settlementUserId: row[22] || '',       // Wì—´: ì •ì‚°ë°˜ì˜ìID
        yearMonth: row[23] || '',               // Xì—´: ëŒ€ìƒë…„ì›”
        multipleStoreName: (() => {
          const value = row[24];
          // ìƒˆë¡œ ì €ì¥ëœ ì •ì±… ë¡œê·¸ ì¶œë ¥
          if (row[0] === 'POL_1760243517056_ushvjqq8t') {
            console.log('ğŸ” [ì •ì±…ì¡°íšŒ] Yì—´(24ì¸ë±ìŠ¤) ë³µìˆ˜ì ëª… í™•ì¸:', {
              policyId: row[0],
              rowLength: row.length,
              row24Value: value,
              row24Type: typeof value,
              row24IsEmpty: value === '',
              row23: row[23], // Xì—´
              row25: row[25], // Zì—´
              row26: row[26]  // AAì—´
            });
          }
          return value || null;
        })(),       // Yì—´: ë³µìˆ˜ì ëª…
        isMultiple: (row[24] && row[24].trim()) ? true : false, // ë³µìˆ˜ì ëª…ì´ ìˆìœ¼ë©´ ë³µìˆ˜ì 
        storeNameFromSheet: row[25] || '',       // Zì—´: ì—…ì²´ëª… (ì‹œíŠ¸ì—ì„œ ì§ì ‘ ì½ì€ ê°’)
        activationTypeFromSheet: row[26] || '',   // AAì—´: ê°œí†µìœ í˜• (ì‹œíŠ¸ì—ì„œ ì§ì ‘ ì½ì€ ê°’)
        amount95Above: row[27] || '',            // ABì—´: 95êµ°ì´ìƒê¸ˆì•¡
        amount95Below: row[28] || '',            // ACì—´: 95êµ°ë¯¸ë§Œê¸ˆì•¡
        team: (() => {
          const teamValue = row[29];
          console.log('ğŸ” [ì •ì±…ëª©ë¡] ADì—´ ì†Œì†íŒ€ ê°’:', teamValue, 'ì •ì±…ID:', row[0], 'ì „ì²´ row ê¸¸ì´:', row.length);

          // ê¸°ì¡´ ì •ì±…ë“¤ (24ê°œ ì»¬ëŸ¼)ì€ ì†Œì†íŒ€ ì •ë³´ê°€ ì—†ìœ¼ë¯€ë¡œ 'ë¯¸ì§€ì •'
          if (row.length < 30) {
            return 'ë¯¸ì§€ì •';
          }

          // JSON ë¬¸ìì—´ì¸ì§€ í™•ì¸ (ì˜ëª» ì €ì¥ëœ ë°ì´í„° ì²˜ë¦¬)
          if (teamValue && typeof teamValue === 'string') {
            // JSON ê°ì²´ í˜•íƒœì˜ ë¬¸ìì—´ì¸ì§€ í™•ì¸
            if (teamValue.trim().startsWith('{') && teamValue.trim().endsWith('}')) {
              console.warn('âš ï¸ [ì •ì±…ëª©ë¡] ADì—´ì— JSON ë¬¸ìì—´ì´ ì €ì¥ë˜ì–´ ìˆìŒ:', teamValue, 'ì •ì±…ID:', row[0]);
              return 'ë¯¸ì§€ì •'; // JSON ë¬¸ìì—´ì´ë©´ ë¬´ì‹œí•˜ê³  'ë¯¸ì§€ì •' ë°˜í™˜
            }
          }

          // ìƒˆ ì •ì±…ë“¤ (36ê°œ ì»¬ëŸ¼)ì€ ADì—´ì—ì„œ ì†Œì†íŒ€ ì •ë³´ ì½ê¸°
          return teamValue || 'ë¯¸ì§€ì •';
        })(),         // ADì—´: ì†Œì†íŒ€ (ê¸°ì¡´ ë°ì´í„°ëŠ” ë¯¸ì§€ì •)
        teamName: (() => {
          const teamValue = row[29];

          // ê¸°ì¡´ ì •ì±…ë“¤ (24ê°œ ì»¬ëŸ¼)ì€ ì†Œì†íŒ€ ì •ë³´ê°€ ì—†ìœ¼ë¯€ë¡œ 'ë¯¸ì§€ì •'
          if (row.length < 30) {
            return 'ë¯¸ì§€ì •';
          }

          // JSON ë¬¸ìì—´ì¸ì§€ í™•ì¸ (ì˜ëª» ì €ì¥ëœ ë°ì´í„° ì²˜ë¦¬)
          if (teamValue && typeof teamValue === 'string') {
            // JSON ê°ì²´ í˜•íƒœì˜ ë¬¸ìì—´ì¸ì§€ í™•ì¸
            if (teamValue.trim().startsWith('{') && teamValue.trim().endsWith('}')) {
              console.warn('âš ï¸ [ì •ì±…ëª©ë¡] ADì—´ì— JSON ë¬¸ìì—´ì´ ì €ì¥ë˜ì–´ ìˆìŒ:', teamValue, 'ì •ì±…ID:', row[0]);
              return 'ë¯¸ì§€ì •'; // JSON ë¬¸ìì—´ì´ë©´ ë¬´ì‹œí•˜ê³  'ë¯¸ì§€ì •' ë°˜í™˜
            }
          }

          // íŒ€ ì½”ë“œê°€ 'AA'ì¸ ê²½ìš°, ëŒ€ë¦¬ì ì•„ì´ë””ê´€ë¦¬ ì‹œíŠ¸ì—ì„œ ì‹¤ì œ íŒ€ì¥ ì´ë¦„ì„ ì°¾ì•„ì„œ ë°˜í™˜
          // ì„ì‹œë¡œ íŒ€ ì½”ë“œë¥¼ ê·¸ëŒ€ë¡œ ë°˜í™˜ (ë‚˜ì¤‘ì— ì‹¤ì œ íŒ€ì¥ ì´ë¦„ìœ¼ë¡œ ë§¤í•‘)
          return teamValue || 'ë¯¸ì§€ì •';
        })(),         // íŒ€ ì´ë¦„ (ì½”ë“œ ë³€í™˜)
        // ë¶€ê°€ì°¨ê°ì§€ì›ì •ì±… ê´€ë ¨ ë°ì´í„°
        deductSupport: {
          addServiceAmount: row[30] || '',        // AEì—´: ë¶€ê°€ë¯¸ìœ ì¹˜ê¸ˆì•¡
          insuranceAmount: row[31] || '',         // AFì—´: ë³´í—˜ë¯¸ìœ ì¹˜ê¸ˆì•¡
          connectionAmount: row[32] || ''         // AGì—´: ì—°ê²°ìŒë¯¸ìœ ì¹˜ê¸ˆì•¡
        },
        conditionalOptions: {
          addServiceAcquired: row[33] === 'Y',    // AHì—´: ë¶€ê°€ìœ ì¹˜ì‹œì¡°ê±´
          insuranceAcquired: row[34] === 'Y',     // AIì—´: ë³´í—˜ìœ ì¹˜ì‹œì¡°ê±´
          connectionAcquired: row[35] === 'Y'     // AJì—´: ì—°ê²°ìŒìœ ì¹˜ì‹œì¡°ê±´
        },
        // ë¶€ê°€ì¶”ê°€ì§€ì›ì •ì±… ê´€ë ¨ ë°ì´í„°
        addSupport: {
          uplayPremiumAmount: row[36] || '',      // AKì—´: ìœ í”Œë ˆì´(í”„ë¦¬ë¯¸ì—„) ìœ ì¹˜ê¸ˆì•¡
          phoneExchangePassAmount: row[37] || '', // ALì—´: í°êµì²´íŒ¨ìŠ¤ ìœ ì¹˜ê¸ˆì•¡
          musicAmount: row[38] || '',             // AMì—´: ìŒì•…ê°ìƒ ìœ ì¹˜ê¸ˆì•¡
          numberFilteringAmount: row[39] || ''    // ANì—´: ì§€ì •ë²ˆí˜¸í•„í„°ë§ ìœ ì¹˜ê¸ˆì•¡
        },
        supportConditionalOptions: {
          vas2Both: row[40] === 'Y',              // AOì—´: VAS 2ì¢… ë™ì‹œìœ ì¹˜ ì¡°ê±´
          vas2Either: row[41] === 'Y',            // APì—´: VAS 2ì¢…ì¤‘ 1ê°œìœ ì¹˜ ì¡°ê±´
          addon3All: row[42] === 'Y'              // AQì—´: ë¶€ê°€3ì¢… ëª¨ë‘ìœ ì¹˜ ì¡°ê±´
        },
        // ìš”ê¸ˆì œìœ í˜•ë³„ì •ì±… ê´€ë ¨ ë°ì´í„°
        rateSupports: (() => {
          try {
            return JSON.parse(row[43] || '[]');  // ARì—´: ìš”ê¸ˆì œìœ í˜•ë³„ì •ì±… ì§€ì›ì‚¬í•­ (JSON)
          } catch (error) {
            return [];
          }
        })(),
        // isDirectInput: AYì—´ì—ì„œ ì½ê±°ë‚˜, ì—†ìœ¼ë©´ rateSupportsì™€ policyContentë¡œ íŒë‹¨
        isDirectInput: (() => {
          // AYì—´ì´ ìˆìœ¼ë©´ Y/Nì„ booleanìœ¼ë¡œ ë³€í™˜
          if (row.length >= 51 && row[50] !== undefined && row[50] !== null && row[50] !== '') {
            const ayValue = row[50].toString().trim();
            console.log('ğŸ” [ì •ì±…ì¡°íšŒ] AYì—´ ì§ì ‘ì…ë ¥ì—¬ë¶€ ê°’:', {
              policyId: row[0],
              ayValue,
              ayValueType: typeof row[50],
              result: ayValue === 'Y' || ayValue === 'true'
            });
            return ayValue === 'Y' || ayValue === 'true';
          }
          // ê¸°ì¡´ ë°ì´í„°ëŠ” AYì—´ì´ ì—†ìœ¼ë¯€ë¡œ rateSupportsì™€ policyContentë¡œ íŒë‹¨
          const category = row[8]; // Iì—´: í•˜ìœ„ì¹´í…Œê³ ë¦¬
          if (category === 'wireless_rate' || category === 'wired_rate') {
            try {
              const rateSupports = JSON.parse(row[43] || '[]');
              const hasRateSupports = Array.isArray(rateSupports) && rateSupports.length > 0;
              const hasPolicyContent = row[4] && row[4].toString().trim(); // Eì—´: ì •ì±…ë‚´ìš©
              // rateSupportsê°€ ì—†ê³  policyContentê°€ ìˆìœ¼ë©´ ì§ì ‘ì…ë ¥
              const result = !hasRateSupports && !!hasPolicyContent;
              if (row[0] === 'POL_1758709000782_o32vwgmfj' || row[0] === 'POL_1758709081080_j2h0146uj') {
                console.log('ğŸ” [ì •ì±…ì¡°íšŒ] isDirectInput ì¶”ë¡ :', {
                  policyId: row[0],
                  category,
                  hasRateSupports,
                  hasPolicyContent,
                  result
                });
              }
              return result;
            } catch (error) {
              // íŒŒì‹± ì‹¤íŒ¨ ì‹œ policyContentê°€ ìˆìœ¼ë©´ ì§ì ‘ì…ë ¥ìœ¼ë¡œ ê°„ì£¼
              const hasPolicyContent = row[4] && row[4].toString().trim();
              return !!hasPolicyContent;
            }
          }
          return false;
        })(),
        // ì—°í•©ì •ì±… ê´€ë ¨ ë°ì´í„°
        unionSettlementStore: row[44] || '',  // ASì—´: ì •ì‚° ì…ê¸ˆì²˜
        unionTargetStores: (() => {
          try {
            return JSON.parse(row[45] || '[]');  // ATì—´: ì—°í•©ëŒ€ìƒí•˜ë¶€ì  (JSON)
          } catch (error) {
            return [];
          }
        })(),
        unionConditions: (() => {
          try {
            return JSON.parse(row[46] || '{}');  // AUì—´: ì¡°ê±´ (JSON)
          } catch (error) {
            return {};
          }
        })(),
        // ê°œë³„ì†Œê¸‰ì •ì±… ê´€ë ¨ ë°ì´í„°
        individualTarget: (() => {
          try {
            return JSON.parse(row[47] || '{}');  // AVì—´: ì ìš©ëŒ€ìƒ (JSON)
          } catch (error) {
            return {};
          }
        })(),
        individualActivationType: row[48] || '',  // AWì—´: ê°œí†µìœ í˜•
        manager: row[49] || '',  // AXì—´: ë‹´ë‹¹ìëª…
        // activationTypeì„ ê°ì²´ë¡œ íŒŒì‹±
        activationType: (() => {
          const activationTypeStr = row[26] || '';
          if (!activationTypeStr) return { new010: false, mnp: false, change: false };

          const hasNew010 = activationTypeStr.includes('010ì‹ ê·œ');
          const hasMnp = activationTypeStr.includes('MNP');
          const hasChange = activationTypeStr.includes('ê¸°ë³€');

          return {
            new010: hasNew010,
            mnp: hasMnp,
            change: hasChange
          };
        })()
      };
    });

    // ë³µìˆ˜ì  ì •ì±… ê·¸ë£¹í™” ë° ë³µìˆ˜ì ëª… ì¶”ê°€
    const policyGroups = new Map();
    const processedPolicies = [];

    policies.forEach(policy => {
      // ì •ì±…ëª…ê³¼ ì…ë ¥ìIDë¡œ ê·¸ë£¹í™” (ê°™ì€ ì •ì±…ëª…ê³¼ ì…ë ¥ìIDë¥¼ ê°€ì§„ ì •ì±…ë“¤ì„ ê·¸ë£¹í™”)
      const groupKey = `${policy.policyName}_${policy.inputUserId}_${policy.inputDateTime}`;

      if (!policyGroups.has(groupKey)) {
        policyGroups.set(groupKey, {
          policies: [],
          groupName: policy.policyName
        });
      }

      policyGroups.get(groupKey).policies.push(policy);
    });

    // ê° ê·¸ë£¹ì—ì„œ ë³µìˆ˜ì ëª… ì¶”ê°€
    policyGroups.forEach((group, groupKey) => {
      if (group.policies.length > 1) {
        // ë³µìˆ˜ì  ì •ì±…ì¸ ê²½ìš° - ì‹œíŠ¸ì—ì„œ ì½ì€ ë³µìˆ˜ì ëª… ì‚¬ìš©
        const multipleStoreName = group.policies[0].multipleStoreName || 'ë³µìˆ˜ì ';

        group.policies.forEach(policy => {
          processedPolicies.push({
            ...policy,
            isMultiple: true,
            multipleStoreName: multipleStoreName
          });
        });
      } else {
        // ë‹¨ì¼ ê·¸ë£¹ì´ì§€ë§Œ ë³µìˆ˜ì ëª…ì´ ìˆëŠ” ê²½ìš° (ì‹œíŠ¸ì— ë³µìˆ˜ì ëª…ì´ ì €ì¥ëœ ê²½ìš°)
        group.policies.forEach(policy => {
          const hasMultipleStoreName = policy.multipleStoreName && policy.multipleStoreName.trim();
          processedPolicies.push({
            ...policy,
            isMultiple: hasMultipleStoreName ? true : false,
            multipleStoreName: hasMultipleStoreName ? policy.multipleStoreName : null
          });
        });
      }
    });

    console.log(`ì •ì±… ëª©ë¡ ì¡°íšŒ ì™„ë£Œ: ${processedPolicies.length}ê±´`);

    res.json({ success: true, policies: processedPolicies });

  } catch (error) {
    console.error('ì •ì±… ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

app.post('/api/policies', async (req, res) => {
  try {
    console.log('ğŸ“¡ [2025-12-04T' + new Date().toISOString().split('T')[1] + '] POST /api/policies - IP: ' + (req.ip || req.connection.remoteAddress) + ' - UA: ' + (req.get('user-agent') || 'Unknown'));
    console.log('ìƒˆ ì •ì±… ìƒì„± ìš”ì²­:', req.body);

    // ë””ë²„ê¹…: isDirectInput í•„ë“œ í™•ì¸
    console.log('ğŸ” [ì •ì±…ìƒì„±-ìš”ì²­ë°ì´í„°] isDirectInput í•„ë“œ í™•ì¸:', {
      isDirectInput: req.body.isDirectInput,
      isDirectInputType: typeof req.body.isDirectInput,
      category: req.body.category,
      rateSupports: req.body.rateSupports,
      rateSupportsLength: Array.isArray(req.body.rateSupports) ? req.body.rateSupports.length : 'N/A',
      hasPolicyContent: !!(req.body.policyContent && req.body.policyContent.trim())
    });

    // ì¹´í…Œê³ ë¦¬ë³„ ë¡œê·¸ ì¶œë ¥
    const policyCategory = req.body.category;
    const isShoePolicyForLog = policyCategory === 'wireless_shoe' || policyCategory === 'wired_shoe';
    const isAddDeductPolicyForLog = policyCategory === 'wireless_add_deduct' || policyCategory === 'wired_add_deduct';

    if (isShoePolicyForLog) {
      console.log('ğŸ“ [ì •ì±…ìƒì„±-êµ¬ë‘ì •ì±…] ìš”ì²­ ë°ì´í„° ìƒì„¸:', {
        policyName: req.body.policyName,
        policyStartDate: req.body.policyStartDate,
        policyEndDate: req.body.policyEndDate,
        policyStore: req.body.policyStore,
        policyContent: req.body.policyContent,
        policyAmount: req.body.policyAmount,
        amountType: req.body.amountType,
        category: req.body.category,
        yearMonth: req.body.yearMonth,
        activationType: req.body.activationType,
        amount95Above: req.body.amount95Above,
        amount95Below: req.body.amount95Below,
        multipleStoreName: req.body.multipleStoreName,
        isDirectInput: req.body.isDirectInput
      });
    } else if (isAddDeductPolicyForLog) {
      console.log('ğŸ“ [ì •ì±…ìƒì„±-ë¶€ê°€ì°¨ê°ì§€ì›ì •ì±…] ìš”ì²­ ë°ì´í„° ìƒì„¸:', {
        policyName: req.body.policyName,
        policyStartDate: req.body.policyStartDate,
        policyEndDate: req.body.policyEndDate,
        policyStore: req.body.policyStore,
        policyContent: req.body.policyContent,
        category: req.body.category,
        yearMonth: req.body.yearMonth,
        activationType: req.body.activationType,
        deductSupport: req.body.deductSupport,
        conditionalOptions: req.body.conditionalOptions,
        multipleStoreName: req.body.multipleStoreName,
        isDirectInput: req.body.isDirectInput
      });
    } else {
      console.log('ğŸ“ [ì •ì±…ìƒì„±-ì¼ë°˜ì •ì±…] ìš”ì²­ ë°ì´í„° ìƒì„¸:', {
        policyName: req.body.policyName,
        policyStartDate: req.body.policyStartDate,
        policyEndDate: req.body.policyEndDate,
        policyStore: req.body.policyStore,
        policyContent: req.body.policyContent,
        policyAmount: req.body.policyAmount,
        amountType: req.body.amountType,
        category: req.body.category,
        yearMonth: req.body.yearMonth,
        activationType: req.body.activationType,
        multipleStoreName: req.body.multipleStoreName,
        isDirectInput: req.body.isDirectInput,
        rateSupports: req.body.rateSupports,
        rateSupportsLength: Array.isArray(req.body.rateSupports) ? req.body.rateSupports.length : 'N/A'
      });
    }

    const {
      policyName,
      policyStartDate,
      policyEndDate,
      policyStore,
      policyContent,
      policyAmount,
      amountType,
      policyType,
      category,
      yearMonth,
      inputUserId,
      inputUserName,
      policyTeam // ì†Œì†íŒ€ ì •ë³´ ì¶”ê°€
    } = req.body;

    // êµ¬ë‘ì •ì±… ì—¬ë¶€ í™•ì¸ (ë¡œê·¸ ì¶œë ¥ìš© ë³€ìˆ˜ ì¬ì‚¬ìš©)
    const isShoePolicy = isShoePolicyForLog;
    const isAddDeductPolicy = isAddDeductPolicyForLog;
    console.log('êµ¬ë‘ì •ì±… ì—¬ë¶€:', isShoePolicy, 'ë¶€ê°€ì°¨ê°ì§€ì›ì •ì±… ì—¬ë¶€:', isAddDeductPolicy, 'category:', category);
    console.log('ğŸ” [ì •ì±…ìƒì„±] policyTeam ê°’:', policyTeam);

    // í•„ìˆ˜ í•„ë“œ ê²€ì¦ (êµ¬ë‘ì •ì±…ì´ë‚˜ ë¶€ê°€ì°¨ê°ì§€ì›ì •ì±…ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ amountType í•„ìˆ˜)
    const missingFields = [];
    if (!policyName) missingFields.push('policyName');
    if (!policyStartDate) missingFields.push('policyStartDate');
    if (!policyEndDate) missingFields.push('policyEndDate');
    // ì—°í•©ì •ì±…ì´ ì•„ë‹ ë•Œë§Œ policyStore ê²€ì¦
    const isUnionPolicy = category === 'wireless_union' || category === 'wired_union';
    if (!isUnionPolicy && !policyStore) missingFields.push('policyStore');
    if (!policyTeam || !policyTeam.trim()) missingFields.push('policyTeam');

    // êµ¬ë‘ì •ì±…ì´ë‚˜ ë¶€ê°€ì°¨ê°ì§€ì›ì •ì±…ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ policyContent í•„ìˆ˜
    // ë¶€ê°€ì°¨ê°ì§€ì›ì •ì±…ì€ ìë™ ìƒì„±ë˜ë¯€ë¡œ policyContent ê²€ì¦ ì œì™¸
    const isAddSupportPolicyForValidation = category === 'wireless_add_support' || category === 'wired_add_support';
    const isRatePolicyForValidation = category === 'wireless_rate' || category === 'wired_rate';
    if (!isShoePolicy && !isAddDeductPolicy && !isAddSupportPolicyForValidation && !isRatePolicyForValidation && !policyContent) missingFields.push('policyContent');

    // êµ¬ë‘ì •ì±… ì „ìš© ê²€ì¦
    if (isShoePolicy) {
      console.log('ğŸ” [êµ¬ë‘ì •ì±…] ì „ìš© ê²€ì¦ ì‹œì‘');
      // 95êµ°ì´ìƒ/ë¯¸ë§Œ ê¸ˆì•¡ ì¤‘ í•˜ë‚˜ë¼ë„ ìˆì–´ì•¼ í•¨
      if (!req.body.amount95Above && !req.body.amount95Below && !policyContent) {
        missingFields.push('amount95Above ë˜ëŠ” amount95Below ë˜ëŠ” policyContent');
      }
      console.log('âœ… [êµ¬ë‘ì •ì±…] ê²€ì¦ ì™„ë£Œ');
    }

    // ë¶€ê°€ì°¨ê°ì§€ì›ì •ì±… ì „ìš© ê²€ì¦
    if (isAddDeductPolicy) {
      console.log('ğŸ” [ë¶€ê°€ì°¨ê°ì§€ì›ì •ì±…] ì „ìš© ê²€ì¦ ì‹œì‘');
      const deductSupport = req.body.deductSupport || {};

      console.log('ğŸ” [ë¶€ê°€ì°¨ê°ì§€ì›ì •ì±…] ê²€ì¦ ë°ì´í„°:', {
        deductSupport,
        addServiceAmount: deductSupport.addServiceAmount,
        insuranceAmount: deductSupport.insuranceAmount,
        connectionAmount: deductSupport.connectionAmount
      });

      // ì°¨ê°ì§€ì› ê¸ˆì•¡ ì¤‘ ìµœì†Œ í•˜ë‚˜ëŠ” ì…ë ¥ë˜ì–´ì•¼ í•¨ (ì§€ì›í•  í•­ëª©ì´ ìˆì–´ì•¼ í•¨)
      const hasAnyAmount = (deductSupport.addServiceAmount && deductSupport.addServiceAmount.trim()) ||
        (deductSupport.insuranceAmount && deductSupport.insuranceAmount.trim()) ||
        (deductSupport.connectionAmount && deductSupport.connectionAmount.trim());

      console.log('ğŸ” [ë¶€ê°€ì°¨ê°ì§€ì›ì •ì±…] hasAnyAmount:', hasAnyAmount);

      if (!hasAnyAmount) {
        console.log('âŒ [ë¶€ê°€ì°¨ê°ì§€ì›ì •ì±…] ì°¨ê°ì§€ì› ê¸ˆì•¡ ëˆ„ë½');
        missingFields.push('ì°¨ê°ì§€ì› ê¸ˆì•¡');
      } else {
        console.log('âœ… [ë¶€ê°€ì°¨ê°ì§€ì›ì •ì±…] ì°¨ê°ì§€ì› ê¸ˆì•¡ ê²€ì¦ í†µê³¼');
      }

      // ì¡°ê±´ë¶€ ì˜µì…˜ì€ ì„ íƒì‚¬í•­ì´ë¯€ë¡œ ê²€ì¦í•˜ì§€ ì•ŠìŒ
      console.log('âœ… [ë¶€ê°€ì°¨ê°ì§€ì›ì •ì±…] ê²€ì¦ ì™„ë£Œ');
    }

    // ë¶€ê°€ì¶”ê°€ì§€ì›ì •ì±… ì „ìš© ê²€ì¦
    const isAddSupportPolicy = category === 'wireless_add_support' || category === 'wired_add_support';
    if (isAddSupportPolicy) {
      console.log('ğŸ” [ë¶€ê°€ì¶”ê°€ì§€ì›ì •ì±…] ì „ìš© ê²€ì¦ ì‹œì‘');
      const addSupport = req.body.addSupport || {};

      console.log('ğŸ” [ë¶€ê°€ì¶”ê°€ì§€ì›ì •ì±…] ê²€ì¦ ë°ì´í„°:', {
        addSupport,
        uplayPremiumAmount: addSupport.uplayPremiumAmount,
        phoneExchangePassAmount: addSupport.phoneExchangePassAmount,
        musicAmount: addSupport.musicAmount,
        numberFilteringAmount: addSupport.numberFilteringAmount
      });

      // ì¶”ê°€ì§€ì› ê¸ˆì•¡ ì¤‘ ìµœì†Œ í•˜ë‚˜ëŠ” ì…ë ¥ë˜ì–´ì•¼ í•¨ (ì§€ì›í•  í•­ëª©ì´ ìˆì–´ì•¼ í•¨)
      const hasAnyAmount = (addSupport.uplayPremiumAmount && addSupport.uplayPremiumAmount.trim()) ||
        (addSupport.phoneExchangePassAmount && addSupport.phoneExchangePassAmount.trim()) ||
        (addSupport.musicAmount && addSupport.musicAmount.trim()) ||
        (addSupport.numberFilteringAmount && addSupport.numberFilteringAmount.trim());

      console.log('ğŸ” [ë¶€ê°€ì¶”ê°€ì§€ì›ì •ì±…] hasAnyAmount:', hasAnyAmount);

      if (!hasAnyAmount) {
        console.log('âŒ [ë¶€ê°€ì¶”ê°€ì§€ì›ì •ì±…] ì¶”ê°€ì§€ì› ê¸ˆì•¡ ëˆ„ë½');
        missingFields.push('ì¶”ê°€ì§€ì› ê¸ˆì•¡');
      } else {
        console.log('âœ… [ë¶€ê°€ì¶”ê°€ì§€ì›ì •ì±…] ì¶”ê°€ì§€ì› ê¸ˆì•¡ ê²€ì¦ í†µê³¼');
      }

      // ì¡°ê±´ë¶€ ì˜µì…˜ì€ ì„ íƒì‚¬í•­ì´ë¯€ë¡œ ê²€ì¦í•˜ì§€ ì•ŠìŒ
      console.log('âœ… [ë¶€ê°€ì¶”ê°€ì§€ì›ì •ì±…] ê²€ì¦ ì™„ë£Œ');
    }

    // ìš”ê¸ˆì œìœ í˜•ë³„ì •ì±… ì „ìš© ê²€ì¦
    const isRatePolicy = category === 'wireless_rate' || category === 'wired_rate';
    if (isRatePolicy) {
      console.log('ğŸ” [ìš”ê¸ˆì œìœ í˜•ë³„ì •ì±…] ì „ìš© ê²€ì¦ ì‹œì‘');
      const rateSupports = req.body.rateSupports || [];
      const isDirectInput = req.body.isDirectInput === true || req.body.isDirectInput === 'true';

      console.log('ğŸ” [ìš”ê¸ˆì œìœ í˜•ë³„ì •ì±…] ê²€ì¦ ë°ì´í„°:', {
        rateSupports,
        count: rateSupports.length,
        isDirectInput,
        isDirectInputType: typeof req.body.isDirectInput,
        hasPolicyContent: !!(req.body.policyContent && req.body.policyContent.trim())
      });

      // isDirectInputì´ trueì´ë©´ rateSupports ê²€ì¦ ìƒëµ
      if (isDirectInput) {
        console.log('âœ… [ìš”ê¸ˆì œìœ í˜•ë³„ì •ì±…] ì§ì ‘ì…ë ¥ ëª¨ë“œ - rateSupports ê²€ì¦ ìƒëµ');
      } else {
        // ì§€ì›ì‚¬í•­ ìµœì†Œ 1ê°œëŠ” ì…ë ¥ë˜ì–´ì•¼ í•¨
        if (rateSupports.length === 0) {
          console.log('âŒ [ìš”ê¸ˆì œìœ í˜•ë³„ì •ì±…] ì§€ì›ì‚¬í•­ ëˆ„ë½');
          missingFields.push('ì§€ì›ì‚¬í•­');
        } else {
          // ê° í•­ëª©ì˜ í•„ë“œ ê²€ì¦ (rateRangeëŠ” ì„ íƒì‚¬í•­ì´ë¯€ë¡œ ì œì™¸)
          const hasIncompleteItem = rateSupports.some(item =>
            !item.modelType || !item.rateGrade || !item.activationType || !item.amount
          );
          if (hasIncompleteItem) {
            console.log('âŒ [ìš”ê¸ˆì œìœ í˜•ë³„ì •ì±…] ë¶ˆì™„ì „í•œ ì§€ì›ì‚¬í•­ ì¡´ì¬');
            missingFields.push('ì§€ì›ì‚¬í•­ í•„ë“œ');
          } else {
            console.log('âœ… [ìš”ê¸ˆì œìœ í˜•ë³„ì •ì±…] ì§€ì›ì‚¬í•­ ê²€ì¦ í†µê³¼');
          }
        }
      }

      console.log('âœ… [ìš”ê¸ˆì œìœ í˜•ë³„ì •ì±…] ê²€ì¦ ì™„ë£Œ');
    }

    // ì¼ë°˜ ì •ì±… ê²€ì¦ (êµ¬ë‘ì •ì±…, ë¶€ê°€ì°¨ê°ì§€ì›ì •ì±…, ë¶€ê°€ì¶”ê°€ì§€ì›ì •ì±…, ìš”ê¸ˆì œìœ í˜•ë³„ì •ì±…ì´ ì•„ë‹Œ ê²½ìš°)
    if (!isShoePolicy && !isAddDeductPolicy && !isAddSupportPolicy && !isRatePolicy) {
      console.log('ğŸ” [ì¼ë°˜ì •ì±…] ê²€ì¦ ì‹œì‘');
      if (!amountType) missingFields.push('amountType');
      console.log('âœ… [ì¼ë°˜ì •ì±…] ê²€ì¦ ì™„ë£Œ');
    }

    console.log('ğŸ” [ì „ì²´ ê²€ì¦] missingFields:', missingFields);
    console.log('ğŸ” [ì „ì²´ ê²€ì¦] missingFields.length:', missingFields.length);

    if (missingFields.length > 0) {
      console.log('âŒ [ì „ì²´ ê²€ì¦] ëˆ„ë½ëœ í•„ë“œ:', missingFields);

      // í•„ë“œëª…ì„ í•œêµ­ì–´ë¡œ ë³€í™˜
      const fieldNames = {
        'policyName': 'ì •ì±…ëª…',
        'policyStartDate': 'ì •ì±… ì‹œì‘ì¼',
        'policyEndDate': 'ì •ì±… ì¢…ë£Œì¼',
        'policyStore': 'ì •ì±…ì ìš©ì ',
        'policyContent': 'ì •ì±…ë‚´ìš©',
        'amountType': 'ê¸ˆì•¡ ìœ í˜•',
        'amount95Above ë˜ëŠ” amount95Below ë˜ëŠ” policyContent': '95êµ°ì´ìƒ/ë¯¸ë§Œ ê¸ˆì•¡ ë˜ëŠ” ì •ì±…ë‚´ìš©',
        'ì°¨ê°ì§€ì› ê¸ˆì•¡': 'ì°¨ê°ì§€ì› ê¸ˆì•¡'
      };

      const missingFieldNames = missingFields.map(field => fieldNames[field] || field);
      const errorMessage = `ë‹¤ìŒ í•„ìˆ˜ í•­ëª©ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤: ${missingFieldNames.join(', ')}`;

      return res.status(400).json({
        success: false,
        error: errorMessage,
        missingFields: missingFields,
        missingFieldNames: missingFieldNames,
        received: { policyName, policyStartDate, policyEndDate, policyStore, policyContent, amountType, isShoePolicy }
      });
    }

    // amountTypeì´ 'in_content'ê°€ ì•„ë‹ ë•Œë§Œ policyAmount í•„ìˆ˜ (êµ¬ë‘ì •ì±…, ë¶€ê°€ì°¨ê°ì§€ì›ì •ì±…ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ)
    if (!isShoePolicy && !isAddDeductPolicy && !isAddSupportPolicy && !isRatePolicy && amountType !== 'in_content' && !policyAmount) {
      return res.status(400).json({
        success: false,
        error: 'ê¸ˆì•¡ì´ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.',
        received: { policyAmount, amountType }
      });
    }

    // ì •ì±… ID ìƒì„±
    const policyId = `POL_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

    // ì •ì±… ì ìš©ì¼ì„ ì‹œì‘ì¼~ì¢…ë£Œì¼ í˜•íƒœë¡œ ë³€í™˜
    const startDate = new Date(policyStartDate).toLocaleDateString('ko-KR');
    const endDate = new Date(policyEndDate).toLocaleDateString('ko-KR');
    const policyDateRange = `${startDate} ~ ${endDate}`;

    // ê¸ˆì•¡ ì •ë³´ì— ìœ í˜• ì¶”ê°€
    const amountWithType = amountType === 'in_content'
      ? 'ë‚´ìš©ì— ì§ì ‘ì…ë ¥'
      : `${policyAmount}ì› (${amountType === 'total' ? 'ì´ê¸ˆì•¡' : 'ê±´ë‹¹ê¸ˆì•¡'})`;

    // ë¨¼ì € ì‹œíŠ¸ì— ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸ (ìºì‹œ ì‚¬ìš©í•˜ì—¬ ì¿¼í„° ì ˆì•½)
    const existingData = await getSheetValues('ì •ì±…_ê¸°ë³¸ì •ë³´ ');

    // í—¤ë” ì •ì˜
    const headerRow = [
      'ì •ì±…ID',           // Aì—´
      'ì •ì±…ëª…',           // Bì—´
      'ì •ì±…ì ìš©ì¼',       // Cì—´
      'ì •ì±…ì ìš©ì ',       // Dì—´
      'ì •ì±…ë‚´ìš©',         // Eì—´
      'ê¸ˆì•¡',             // Fì—´
      'ì •ì±…ìœ í˜•',         // Gì—´
      'ë¬´ì„ /ìœ ì„ ',        // Hì—´
      'í•˜ìœ„ì¹´í…Œê³ ë¦¬',     // Iì—´
      'ì…ë ¥ìID',         // Jì—´
      'ì…ë ¥ìëª…',         // Kì—´
      'ì…ë ¥ì¼ì‹œ',         // Lì—´
      'ìŠ¹ì¸ìƒíƒœ_ì´ê´„',     // Mì—´
      'ìŠ¹ì¸ìƒíƒœ_ì •ì‚°íŒ€',   // Nì—´
      'ìŠ¹ì¸ìƒíƒœ_ì†Œì†íŒ€',   // Oì—´
      'ì •ì±…ìƒíƒœ',         // Pì—´
      'ì·¨ì†Œì‚¬ìœ ',         // Qì—´
      'ì·¨ì†Œì¼ì‹œ',         // Rì—´
      'ì·¨ì†Œìëª…',         // Sì—´
      'ì •ì‚°ë°˜ì˜ìƒíƒœ',     // Tì—´
      'ì •ì‚°ë°˜ì˜ìëª…',     // Uì—´
      'ì •ì‚°ë°˜ì˜ì¼ì‹œ',     // Vì—´
      'ì •ì‚°ë°˜ì˜ìID',     // Wì—´
      'ëŒ€ìƒë…„ì›”',                   // Xì—´
      'ë³µìˆ˜ì ëª…',                   // Yì—´
      'ì—…ì²´ëª…',                     // Zì—´
      'ê°œí†µìœ í˜•',                   // AAì—´
      '95êµ°ì´ìƒê¸ˆì•¡',               // ABì—´
      '95êµ°ë¯¸ë§Œê¸ˆì•¡',               // ACì—´
      'ì†Œì†íŒ€',                     // ADì—´
      'ë¶€ê°€ë¯¸ìœ ì¹˜ê¸ˆì•¡',             // AEì—´
      'ë³´í—˜ë¯¸ìœ ì¹˜ê¸ˆì•¡',             // AFì—´
      'ì—°ê²°ìŒë¯¸ìœ ì¹˜ê¸ˆì•¡',           // AGì—´
      'ë¶€ê°€ìœ ì¹˜ì‹œì¡°ê±´',             // AHì—´
      'ë³´í—˜ìœ ì¹˜ì‹œì¡°ê±´',             // AIì—´
      'ì—°ê²°ìŒìœ ì¹˜ì‹œì¡°ê±´',           // AJì—´
      'ìœ í”Œë ˆì´í”„ë¦¬ë¯¸ì—„ê¸ˆì•¡',       // AKì—´
      'í°êµì²´íŒ¨ìŠ¤ê¸ˆì•¡',             // ALì—´
      'ìŒì•…ê°ìƒê¸ˆì•¡',               // AMì—´
      'ì§€ì •ë²ˆí˜¸í•„í„°ë§ê¸ˆì•¡',         // ANì—´
      'VAS2ì¢…ë™ì‹œìœ ì¹˜',             // AOì—´
      'VAS2ì¢…ì¤‘1ê°œìœ ì¹˜',            // APì—´
      'ë¶€ê°€3ì¢…ëª¨ë‘ìœ ì¹˜',            // AQì—´
      'ìš”ê¸ˆì œìœ í˜•ë³„ì§€ì›ì‚¬í•­',       // ARì—´
      'ì—°í•©ì •ì‚°ì…ê¸ˆì²˜',             // ASì—´
      'ì—°í•©ëŒ€ìƒí•˜ë¶€ì ',             // ATì—´
      'ì—°í•©ì¡°ê±´',                   // AUì—´
      'ê°œë³„ì†Œê¸‰ì ìš©ëŒ€ìƒ',           // AVì—´
      'ê°œë³„ì†Œê¸‰ê°œí†µìœ í˜•',           // AWì—´
      'ë‹´ë‹¹ì',                     // AXì—´
      'ì§ì ‘ì…ë ¥ì—¬ë¶€'                // AYì—´
    ];

    // ë§¤ì¥ ë°ì´í„°ì—ì„œ ì—…ì²´ëª… ì¡°íšŒ (ìºì‹œ ì‚¬ìš©í•˜ì—¬ ì¿¼í„° ì ˆì•½)
    let storeName = '';
    try {
      const storeValues = await getSheetValues(STORE_SHEET_NAME);
      if (storeValues && storeValues.length > 1) {
        const storeRows = storeValues.slice(1);
        const store = storeRows.find(row => {
          const storeId = row[15]; // Pì—´: ë§¤ì¥ì½”ë“œ (15ì¸ë±ìŠ¤)
          return storeId && storeId.toString() === policyStore.toString();
        });
        if (store) {
          storeName = store[14] ? store[14].toString().trim() : ''; // Oì—´: ì—…ì²´ëª… (14ì¸ë±ìŠ¤)
        }
      }
    } catch (error) {
      console.warn('ë§¤ì¥ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨:', error.message);
    }

    // ìƒˆ ì •ì±… ë°ì´í„° ìƒì„±
    const newPolicyRow = [
      policyId,                    // Aì—´: ì •ì±…ID
      policyName,                  // Bì—´: ì •ì±…ëª…
      policyDateRange,             // Cì—´: ì •ì±…ì ìš©ì¼ (ì‹œì‘ì¼~ì¢…ë£Œì¼)
      policyStore,                 // Dì—´: ì •ì±…ì ìš©ì 
      policyContent,               // Eì—´: ì •ì±…ë‚´ìš©
      amountWithType,              // Fì—´: ê¸ˆì•¡ (ê¸ˆì•¡ + ìœ í˜•)
      policyType,                  // Gì—´: ì •ì±…ìœ í˜•
      category.startsWith('wireless') ? 'ë¬´ì„ ' : 'ìœ ì„ ', // Hì—´: ë¬´ì„ /ìœ ì„ 
      category,                    // Iì—´: í•˜ìœ„ì¹´í…Œê³ ë¦¬
      inputUserId,                 // Jì—´: ì…ë ¥ìID
      inputUserName,               // Kì—´: ì…ë ¥ìëª…
      new Date().toISOString(),    // Lì—´: ì…ë ¥ì¼ì‹œ
      'ëŒ€ê¸°',                      // Mì—´: ìŠ¹ì¸ìƒíƒœ_ì´ê´„
      'ëŒ€ê¸°',                      // Nì—´: ìŠ¹ì¸ìƒíƒœ_ì •ì‚°íŒ€
      'ëŒ€ê¸°',                      // Oì—´: ìŠ¹ì¸ìƒíƒœ_ì†Œì†íŒ€
      'í™œì„±',                      // Pì—´: ì •ì±…ìƒíƒœ
      '',                          // Qì—´: ì·¨ì†Œì‚¬ìœ 
      '',                          // Rì—´: ì·¨ì†Œì¼ì‹œ
      '',                          // Sì—´: ì·¨ì†Œìëª…
      'ë¯¸ë°˜ì˜',                    // Tì—´: ì •ì‚°ë°˜ì˜ìƒíƒœ
      '',                          // Uì—´: ì •ì‚°ë°˜ì˜ìëª…
      '',                          // Vì—´: ì •ì‚°ë°˜ì˜ì¼ì‹œ
      '',                          // Wì—´: ì •ì‚°ë°˜ì˜ìID
      yearMonth,                   // Xì—´: ëŒ€ìƒë…„ì›”
      req.body.multipleStoreName || '', // Yì—´: ë³µìˆ˜ì ëª…
      storeName,                   // Zì—´: ì—…ì²´ëª…
      (() => {                     // AAì—´: ê°œí†µìœ í˜•
        // ë¶€ê°€ì°¨ê°/ì¶”ê°€ì§€ì›ì •ì±…, ìš”ê¸ˆì œìœ í˜•ë³„ì •ì±…ì€ ê°œí†µìœ í˜• ì„ íƒ í•„ë“œê°€ ì—†ìœ¼ë¯€ë¡œ "ì „ìœ í˜•"ìœ¼ë¡œ ì„¤ì •
        if (category === 'wireless_add_deduct' || category === 'wired_add_deduct' ||
          category === 'wireless_add_support' || category === 'wired_add_support' ||
          category === 'wireless_rate' || category === 'wired_rate') {
          return 'ì „ìœ í˜•';
        }

        if (!req.body.activationType) return '';
        const { new010, mnp, change } = req.body.activationType;
        const types = [];
        if (new010) types.push('010ì‹ ê·œ');
        if (mnp) types.push('MNP');
        if (change) types.push('ê¸°ë³€');
        if (types.length === 3) return 'ì „ìœ í˜•';
        return types.join(', ');
      })(),
      // ABì—´: 95êµ°ì´ìƒê¸ˆì•¡ (êµ¬ë‘ì •ì±…ì—ì„œë§Œ ì‚¬ìš©)
      (category === 'wireless_shoe' || category === 'wired_shoe') ? (req.body.amount95Above || '') : '',
      // ACì—´: 95êµ°ë¯¸ë§Œê¸ˆì•¡ (êµ¬ë‘ì •ì±…ì—ì„œë§Œ ì‚¬ìš©)
      (category === 'wireless_shoe' || category === 'wired_shoe') ? (req.body.amount95Below || '') : '',
      (policyTeam && policyTeam.trim()) || 'ë¯¸ì§€ì •',       // ADì—´: ì†Œì†íŒ€
      // AEì—´: ë¶€ê°€ë¯¸ìœ ì¹˜ê¸ˆì•¡ (ë¶€ê°€ì°¨ê°ì§€ì›ì •ì±…ì—ì„œë§Œ ì‚¬ìš©)
      (category === 'wireless_add_deduct' || category === 'wired_add_deduct') ? (req.body.deductSupport?.addServiceAmount || '') : '',
      // AFì—´: ë³´í—˜ë¯¸ìœ ì¹˜ê¸ˆì•¡ (ë¶€ê°€ì°¨ê°ì§€ì›ì •ì±…ì—ì„œë§Œ ì‚¬ìš©)
      (category === 'wireless_add_deduct' || category === 'wired_add_deduct') ? (req.body.deductSupport?.insuranceAmount || '') : '',
      // AGì—´: ì—°ê²°ìŒë¯¸ìœ ì¹˜ê¸ˆì•¡ (ë¶€ê°€ì°¨ê°ì§€ì›ì •ì±…ì—ì„œë§Œ ì‚¬ìš©)
      (category === 'wireless_add_deduct' || category === 'wired_add_deduct') ? (req.body.deductSupport?.connectionAmount || '') : '',
      // AHì—´: ë¶€ê°€ìœ ì¹˜ì‹œì¡°ê±´ (ë¶€ê°€ì°¨ê°ì§€ì›ì •ì±…ì—ì„œë§Œ ì‚¬ìš©)
      (category === 'wireless_add_deduct' || category === 'wired_add_deduct') ? (req.body.conditionalOptions?.addServiceAcquired ? 'Y' : 'N') : '',
      // AIì—´: ë³´í—˜ìœ ì¹˜ì‹œì¡°ê±´ (ë¶€ê°€ì°¨ê°ì§€ì›ì •ì±…ì—ì„œë§Œ ì‚¬ìš©)
      (category === 'wireless_add_deduct' || category === 'wired_add_deduct') ? (req.body.conditionalOptions?.insuranceAcquired ? 'Y' : 'N') : '',
      // AJì—´: ì—°ê²°ìŒìœ ì¹˜ì‹œì¡°ê±´ (ë¶€ê°€ì°¨ê°ì§€ì›ì •ì±…ì—ì„œë§Œ ì‚¬ìš©)
      (category === 'wireless_add_deduct' || category === 'wired_add_deduct') ? (req.body.conditionalOptions?.connectionAcquired ? 'Y' : 'N') : '',
      // AKì—´: ìœ í”Œë ˆì´(í”„ë¦¬ë¯¸ì—„) ìœ ì¹˜ê¸ˆì•¡ (ë¶€ê°€ì¶”ê°€ì§€ì›ì •ì±…ì—ì„œë§Œ ì‚¬ìš©)
      (category === 'wireless_add_support' || category === 'wired_add_support') ? (req.body.addSupport?.uplayPremiumAmount || '') : '',
      // ALì—´: í°êµì²´íŒ¨ìŠ¤ ìœ ì¹˜ê¸ˆì•¡ (ë¶€ê°€ì¶”ê°€ì§€ì›ì •ì±…ì—ì„œë§Œ ì‚¬ìš©)
      (category === 'wireless_add_support' || category === 'wired_add_support') ? (req.body.addSupport?.phoneExchangePassAmount || '') : '',
      // AMì—´: ìŒì•…ê°ìƒ ìœ ì¹˜ê¸ˆì•¡ (ë¶€ê°€ì¶”ê°€ì§€ì›ì •ì±…ì—ì„œë§Œ ì‚¬ìš©)
      (category === 'wireless_add_support' || category === 'wired_add_support') ? (req.body.addSupport?.musicAmount || '') : '',
      // ANì—´: ì§€ì •ë²ˆí˜¸í•„í„°ë§ ìœ ì¹˜ê¸ˆì•¡ (ë¶€ê°€ì¶”ê°€ì§€ì›ì •ì±…ì—ì„œë§Œ ì‚¬ìš©)
      (category === 'wireless_add_support' || category === 'wired_add_support') ? (req.body.addSupport?.numberFilteringAmount || '') : '',
      // AOì—´: VAS 2ì¢… ë™ì‹œìœ ì¹˜ ì¡°ê±´ (ë¶€ê°€ì¶”ê°€ì§€ì›ì •ì±…ì—ì„œë§Œ ì‚¬ìš©)
      (category === 'wireless_add_support' || category === 'wired_add_support') ? (req.body.supportConditionalOptions?.vas2Both ? 'Y' : 'N') : '',
      // APì—´: VAS 2ì¢…ì¤‘ 1ê°œìœ ì¹˜ ì¡°ê±´ (ë¶€ê°€ì¶”ê°€ì§€ì›ì •ì±…ì—ì„œë§Œ ì‚¬ìš©)
      (category === 'wireless_add_support' || category === 'wired_add_support') ? (req.body.supportConditionalOptions?.vas2Either ? 'Y' : 'N') : '',
      // AQì—´: ë¶€ê°€3ì¢… ëª¨ë‘ìœ ì¹˜ ì¡°ê±´ (ë¶€ê°€ì¶”ê°€ì§€ì›ì •ì±…ì—ì„œë§Œ ì‚¬ìš©)
      (category === 'wireless_add_support' || category === 'wired_add_support') ? (req.body.supportConditionalOptions?.addon3All ? 'Y' : 'N') : '',
      // ARì—´: ìš”ê¸ˆì œìœ í˜•ë³„ì •ì±… ì§€ì›ì‚¬í•­ (JSON ë¬¸ìì—´)
      (category === 'wireless_rate' || category === 'wired_rate') ? JSON.stringify(req.body.rateSupports || []) : '',
      // ASì—´: ì—°í•©ì •ì±… ì •ì‚° ì…ê¸ˆì²˜
      (category === 'wireless_union' || category === 'wired_union') ? (req.body.unionSettlementStore || '') : '',
      // ATì—´: ì—°í•©ì •ì±… ì—°í•©ëŒ€ìƒí•˜ë¶€ì  (JSON ë¬¸ìì—´)
      (category === 'wireless_union' || category === 'wired_union') ? JSON.stringify(req.body.unionTargetStores || []) : '',
      // AUì—´: ì—°í•©ì •ì±… ì¡°ê±´ (JSON ë¬¸ìì—´)
      (category === 'wireless_union' || category === 'wired_union') ? JSON.stringify(req.body.unionConditions || {}) : '',
      // AVì—´: ê°œë³„ì†Œê¸‰ì •ì±… ì ìš©ëŒ€ìƒ (JSON ë¬¸ìì—´)
      (category === 'wireless_individual' || category === 'wired_individual') ? JSON.stringify(req.body.individualTarget || {}) : '',
      // AWì—´: ê°œë³„ì†Œê¸‰ì •ì±… ê°œí†µìœ í˜•
      (category === 'wireless_individual' || category === 'wired_individual') ? (req.body.individualActivationType || '') : '',
      // AXì—´: ë‹´ë‹¹ìëª…
      req.body.manager || '',
      // AYì—´: ì§ì ‘ì…ë ¥ì—¬ë¶€ (true/falseë¥¼ ë¬¸ìì—´ë¡œ ì €ì¥)
      (req.body.isDirectInput === true || req.body.isDirectInput === 'true') ? 'Y' : 'N'
    ];

    console.log('ğŸ“ [ì •ì±…ìƒì„±] êµ¬ê¸€ì‹œíŠ¸ ì €ì¥ ë°ì´í„°:', {
      policyId,
      policyName,
      policyContent,
      amount95Above: req.body.amount95Above,
      amount95Below: req.body.amount95Below,
      activationType: req.body.activationType,
      multipleStoreName: req.body.multipleStoreName,
      storeName,
      arrayLength: newPolicyRow.length
    });

    console.log('ğŸ” [ì •ì±…ìƒì„±] newPolicyRow Yì—´(24ì¸ë±ìŠ¤) í™•ì¸:', newPolicyRow[24]);

    let response;

    // ì‹œíŠ¸ê°€ ë¹„ì–´ìˆìœ¼ë©´ í—¤ë”ì™€ í•¨ê»˜ ë°ì´í„° ì¶”ê°€
    try {
      if (!existingData || existingData.length === 0) {
        console.log('ğŸ“ [ì •ì±…ìƒì„±] ì‹œíŠ¸ê°€ ë¹„ì–´ìˆì–´ í—¤ë”ì™€ í•¨ê»˜ ë°ì´í„° ì¶”ê°€');
        response = await sheets.spreadsheets.values.append({
          spreadsheetId: SPREADSHEET_ID,
          range: 'ì •ì±…_ê¸°ë³¸ì •ë³´ !A:AY',
          valueInputOption: 'RAW',
          insertDataOption: 'INSERT_ROWS',
          resource: {
            values: [headerRow, newPolicyRow]
          }
        });
      } else {
        // ê¸°ì¡´ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°
        // 1. í—¤ë”ê°€ ëˆ„ë½ë˜ì–´ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸
        const currentHeader = existingData[0];
        const needsHeaderUpdate = !currentHeader[24] || !currentHeader[25] || !currentHeader[26]; // Y, Z, AAì—´ í™•ì¸

        if (needsHeaderUpdate) {
          console.log('ğŸ“ [ì •ì±…ìƒì„±] í—¤ë” ì—…ë°ì´íŠ¸ í•„ìš” - Y~AYì—´ í—¤ë” ì¶”ê°€');
          await sheets.spreadsheets.values.update({
            spreadsheetId: SPREADSHEET_ID,
            range: 'ì •ì±…_ê¸°ë³¸ì •ë³´ !A1:AY1',
            valueInputOption: 'RAW',
            resource: {
              values: [headerRow]
            }
          });
        }

        // 2. ì •ì±… ë°ì´í„° ì¶”ê°€ (ë‹¤ìŒ í–‰ì˜ Aì—´ë¶€í„° ì •í™•íˆ ê¸°ë¡)
        console.log('ğŸ“ [ì •ì±…ìƒì„±] ê¸°ì¡´ ë°ì´í„°ì— ì •ì±… ì¶”ê°€');
        // existingDataì—ëŠ” í—¤ë”ë¥¼ í¬í•¨í•œ ì „ì²´ í–‰ì´ ë“¤ì–´ìˆë‹¤ê³  ê°€ì •
        const nextRowIndex = existingData.length + 1; // 1-based index
        const targetRange = `ì •ì±…_ê¸°ë³¸ì •ë³´ !A${nextRowIndex}:AY${nextRowIndex}`;
        response = await sheets.spreadsheets.values.update({
          spreadsheetId: SPREADSHEET_ID,
          range: targetRange,
          valueInputOption: 'RAW',
          resource: {
            values: [newPolicyRow]
          }
        });
      }
      console.log('âœ… [ì •ì±…ìƒì„±] Google Sheets ì €ì¥ ì„±ê³µ:', response.data);
    } catch (sheetsError) {
      console.error('âŒ [ì •ì±…ìƒì„±] Google Sheets ì €ì¥ ì‹¤íŒ¨:', sheetsError);
      return res.status(400).json({
        success: false,
        error: 'Google Sheets ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
        details: sheetsError.message
      });
    }

    // ì•Œë¦¼ ìƒì„±
    await createPolicyNotification(policyId, inputUserId, 'new_policy');

    // ì •ì±…_ê¸°ë³¸ì •ë³´ ì‹œíŠ¸ ìºì‹œ ë¬´íš¨í™”
    cacheUtils.delete('sheet_ì •ì±…_ê¸°ë³¸ì •ë³´ ');

    console.log('ì •ì±… ìƒì„± ì™„ë£Œ:', response.data);

    res.json({
      success: true,
      message: 'ì •ì±…ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.',
      policyId: policyId
    });

  } catch (error) {
    console.error('ì •ì±… ìƒì„± ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// ì •ì±… ì‚­ì œ API (ë¼ìš°í„° ìˆœì„œ ë¬¸ì œ í•´ê²°ì„ ìœ„í•´ ê°€ì¥ ì•ì— ë°°ì¹˜)
app.delete('/api/policies/:policyId', async (req, res) => {
  console.log('ğŸ”¥ [DELETE API] ìš”ì²­ ë°›ìŒ:', req.method, req.url);
  console.log('ğŸ”¥ [DELETE API] ìš”ì²­ í—¤ë”:', req.headers);
  console.log('ğŸ”¥ [DELETE API] ìš”ì²­ íŒŒë¼ë¯¸í„°:', req.params);
  try {
    const { policyId } = req.params;
    console.log('ğŸ”¥ [DELETE API] ì •ì±… ì‚­ì œ ìš”ì²­:', { policyId });

    // ì •ì±…_ê¸°ë³¸ì •ë³´ ì‹œíŠ¸ì—ì„œ í•´ë‹¹ ì •ì±… ì°¾ê¸°
    const values = await getSheetValuesWithoutCache('ì •ì±…_ê¸°ë³¸ì •ë³´ ');

    if (!values || values.length <= 1) {
      return res.status(404).json({ success: false, error: 'ì •ì±…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
    }

    // í—¤ë” ì œê±°
    const dataRows = values.slice(1);
    const policyRowIndex = dataRows.findIndex(row => row[0] === policyId);

    if (policyRowIndex === -1) {
      return res.status(404).json({ success: false, error: 'ì •ì±…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
    }

    // Google Sheetsì—ì„œ í•´ë‹¹ í–‰ ì‚­ì œ
    const sheetId = await getSheetIdByName('ì •ì±…_ê¸°ë³¸ì •ë³´ ');
    console.log('ğŸ”¥ [DELETE API] ì •ì±…_ê¸°ë³¸ì •ë³´ ì‹œíŠ¸ ID:', sheetId);

    const response = await sheets.spreadsheets.batchUpdate({
      spreadsheetId: SPREADSHEET_ID,
      resource: {
        requests: [{
          deleteDimension: {
            range: {
              sheetId: sheetId, // ì •ì±…_ê¸°ë³¸ì •ë³´ ì‹œíŠ¸ ID
              dimension: 'ROWS',
              startIndex: policyRowIndex + 1, // 0-based index, +1 for header
              endIndex: policyRowIndex + 2
            }
          }
        }]
      }
    });

    // ì •ì±…_ê¸°ë³¸ì •ë³´ ì‹œíŠ¸ ìºì‹œ ë¬´íš¨í™”
    cacheUtils.delete('sheet_ì •ì±…_ê¸°ë³¸ì •ë³´ ');

    console.log('ì •ì±… ì‚­ì œ ì™„ë£Œ:', response.data);

    res.json({ success: true, message: 'ì •ì±…ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.' });

  } catch (error) {
    console.error('ì •ì±… ì‚­ì œ ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// ì •ì±… ìˆ˜ì • API
app.put('/api/policies/:policyId', async (req, res) => {
  try {
    const { policyId } = req.params;
    console.log('ì •ì±… ìˆ˜ì • ìš”ì²­:', { policyId, body: req.body });

    const {
      policyName,
      policyStartDate,
      policyEndDate,
      policyStore,
      policyContent,
      policyAmount,
      amountType,
      policyType,
      category,
      yearMonth,
      team,
      inputUserId,
      inputUserName
    } = req.body;
    // ì •ì±…íŒ€ ê°’ ì •ê·œí™”: í”„ë¡ íŠ¸ëŠ” policyTeam(ì´ë¦„) ë˜ëŠ” team(ì½”ë“œ/ì´ë¦„)ë¡œ ë³´ë‚¼ ìˆ˜ ìˆìŒ
    const policyTeam = (req.body.policyTeam ?? team ?? '').toString();

    // êµ¬ë‘ì •ì±… ì—¬ë¶€ í™•ì¸
    const isShoePolicy = category === 'wireless_shoe' || category === 'wired_shoe';
    const isAddDeductPolicy = category === 'wireless_add_deduct' || category === 'wired_add_deduct';
    console.log('ì •ì±… ìˆ˜ì • - êµ¬ë‘ì •ì±… ì—¬ë¶€:', isShoePolicy, 'ë¶€ê°€ì°¨ê°ì§€ì›ì •ì±… ì—¬ë¶€:', isAddDeductPolicy, 'category:', category);

    // í•„ìˆ˜ í•„ë“œ ê²€ì¦ (êµ¬ë‘ì •ì±…ì´ë‚˜ ë¶€ê°€ì°¨ê°ì§€ì›ì •ì±…ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ amountType í•„ìˆ˜)
    const missingFields = [];
    if (!policyName) missingFields.push('policyName');
    if (!policyStartDate) missingFields.push('policyStartDate');
    if (!policyEndDate) missingFields.push('policyEndDate');
    // ì—°í•©ì •ì±…ì´ ì•„ë‹ ë•Œë§Œ policyStore ê²€ì¦
    const isUnionPolicyForUpdate = category === 'wireless_union' || category === 'wired_union';
    if (!isUnionPolicyForUpdate && !policyStore) missingFields.push('policyStore');
    if (!policyTeam || !policyTeam.trim()) missingFields.push('policyTeam');

    // êµ¬ë‘ì •ì±…ì´ë‚˜ ë¶€ê°€ì°¨ê°ì§€ì›ì •ì±…ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ policyContent í•„ìˆ˜
    // ë¶€ê°€ì°¨ê°ì§€ì›ì •ì±…ì€ ìë™ ìƒì„±ë˜ë¯€ë¡œ policyContent ê²€ì¦ ì œì™¸
    const isAddSupportPolicyForValidation = category === 'wireless_add_support' || category === 'wired_add_support';
    const isRatePolicyForValidation = category === 'wireless_rate' || category === 'wired_rate';
    if (!isShoePolicy && !isAddDeductPolicy && !isAddSupportPolicyForValidation && !isRatePolicyForValidation && !policyContent) missingFields.push('policyContent');

    // êµ¬ë‘ì •ì±… ì „ìš© ê²€ì¦
    if (isShoePolicy) {
      console.log('ğŸ” [ì •ì±…ìˆ˜ì •-êµ¬ë‘ì •ì±…] ì „ìš© ê²€ì¦ ì‹œì‘');
      // 95êµ°ì´ìƒ/ë¯¸ë§Œ ê¸ˆì•¡ ì¤‘ í•˜ë‚˜ë¼ë„ ìˆì–´ì•¼ í•¨
      if (!req.body.amount95Above && !req.body.amount95Below && !policyContent) {
        missingFields.push('amount95Above ë˜ëŠ” amount95Below ë˜ëŠ” policyContent');
      }
      console.log('âœ… [ì •ì±…ìˆ˜ì •-êµ¬ë‘ì •ì±…] ê²€ì¦ ì™„ë£Œ');
    }

    // ë¶€ê°€ì°¨ê°ì§€ì›ì •ì±… ì „ìš© ê²€ì¦
    if (isAddDeductPolicy) {
      console.log('ğŸ” [ì •ì±…ìˆ˜ì •-ë¶€ê°€ì°¨ê°ì§€ì›ì •ì±…] ì „ìš© ê²€ì¦ ì‹œì‘');
      const deductSupport = req.body.deductSupport || {};

      // ì°¨ê°ì§€ì› ê¸ˆì•¡ ì¤‘ ìµœì†Œ í•˜ë‚˜ëŠ” ì…ë ¥ë˜ì–´ì•¼ í•¨ (ì§€ì›í•  í•­ëª©ì´ ìˆì–´ì•¼ í•¨)
      const hasAnyAmount = (deductSupport.addServiceAmount && deductSupport.addServiceAmount.trim()) ||
        (deductSupport.insuranceAmount && deductSupport.insuranceAmount.trim()) ||
        (deductSupport.connectionAmount && deductSupport.connectionAmount.trim());

      if (!hasAnyAmount) {
        missingFields.push('ì°¨ê°ì§€ì› ê¸ˆì•¡');
      }

      // ì¡°ê±´ë¶€ ì˜µì…˜ì€ ì„ íƒì‚¬í•­ì´ë¯€ë¡œ ê²€ì¦í•˜ì§€ ì•ŠìŒ
      console.log('âœ… [ì •ì±…ìˆ˜ì •-ë¶€ê°€ì°¨ê°ì§€ì›ì •ì±…] ê²€ì¦ ì™„ë£Œ');
    }

    // ë¶€ê°€ì¶”ê°€ì§€ì›ì •ì±… ì „ìš© ê²€ì¦
    const isAddSupportPolicy = category === 'wireless_add_support' || category === 'wired_add_support';
    if (isAddSupportPolicy) {
      console.log('ğŸ” [ì •ì±…ìˆ˜ì •-ë¶€ê°€ì¶”ê°€ì§€ì›ì •ì±…] ì „ìš© ê²€ì¦ ì‹œì‘');
      const addSupport = req.body.addSupport || {};

      // ì¶”ê°€ì§€ì› ê¸ˆì•¡ ì¤‘ ìµœì†Œ í•˜ë‚˜ëŠ” ì…ë ¥ë˜ì–´ì•¼ í•¨ (ì§€ì›í•  í•­ëª©ì´ ìˆì–´ì•¼ í•¨)
      const hasAnyAmount = (addSupport.uplayPremiumAmount && addSupport.uplayPremiumAmount.trim()) ||
        (addSupport.phoneExchangePassAmount && addSupport.phoneExchangePassAmount.trim()) ||
        (addSupport.musicAmount && addSupport.musicAmount.trim()) ||
        (addSupport.numberFilteringAmount && addSupport.numberFilteringAmount.trim());

      if (!hasAnyAmount) {
        missingFields.push('ì¶”ê°€ì§€ì› ê¸ˆì•¡');
      }

      // ì¡°ê±´ë¶€ ì˜µì…˜ì€ ì„ íƒì‚¬í•­ì´ë¯€ë¡œ ê²€ì¦í•˜ì§€ ì•ŠìŒ
      console.log('âœ… [ì •ì±…ìˆ˜ì •-ë¶€ê°€ì¶”ê°€ì§€ì›ì •ì±…] ê²€ì¦ ì™„ë£Œ');
    }

    // ìš”ê¸ˆì œìœ í˜•ë³„ì •ì±… ì „ìš© ê²€ì¦
    const isRatePolicyForUpdate = category === 'wireless_rate' || category === 'wired_rate';
    if (isRatePolicyForUpdate) {
      console.log('ğŸ” [ì •ì±…ìˆ˜ì •-ìš”ê¸ˆì œìœ í˜•ë³„ì •ì±…] ì „ìš© ê²€ì¦ ì‹œì‘');
      const rateSupports = req.body.rateSupports || [];
      const isDirectInput = req.body.isDirectInput === true || req.body.isDirectInput === 'true';

      console.log('ğŸ” [ì •ì±…ìˆ˜ì •-ìš”ê¸ˆì œìœ í˜•ë³„ì •ì±…] ê²€ì¦ ë°ì´í„°:', {
        rateSupports,
        count: rateSupports.length,
        isDirectInput,
        isDirectInputType: typeof req.body.isDirectInput,
        hasPolicyContent: !!(req.body.policyContent && req.body.policyContent.trim())
      });

      // isDirectInputì´ trueì´ë©´ rateSupports ê²€ì¦ ìƒëµ
      if (isDirectInput) {
        console.log('âœ… [ì •ì±…ìˆ˜ì •-ìš”ê¸ˆì œìœ í˜•ë³„ì •ì±…] ì§ì ‘ì…ë ¥ ëª¨ë“œ - rateSupports ê²€ì¦ ìƒëµ');
      } else {
        // ì§€ì›ì‚¬í•­ ìµœì†Œ 1ê°œëŠ” ì…ë ¥ë˜ì–´ì•¼ í•¨
        if (rateSupports.length === 0) {
          console.log('âŒ [ì •ì±…ìˆ˜ì •-ìš”ê¸ˆì œìœ í˜•ë³„ì •ì±…] ì§€ì›ì‚¬í•­ ëˆ„ë½');
          missingFields.push('ì§€ì›ì‚¬í•­');
        } else {
          // ê° í•­ëª©ì˜ í•„ë“œ ê²€ì¦ (rateRangeëŠ” ì„ íƒì‚¬í•­ì´ë¯€ë¡œ ì œì™¸)
          const hasIncompleteItem = rateSupports.some(item =>
            !item.modelType || !item.rateGrade || !item.activationType || !item.amount
          );
          if (hasIncompleteItem) {
            console.log('âŒ [ì •ì±…ìˆ˜ì •-ìš”ê¸ˆì œìœ í˜•ë³„ì •ì±…] ë¶ˆì™„ì „í•œ ì§€ì›ì‚¬í•­ ì¡´ì¬');
            missingFields.push('ì§€ì›ì‚¬í•­ í•„ë“œ');
          } else {
            console.log('âœ… [ì •ì±…ìˆ˜ì •-ìš”ê¸ˆì œìœ í˜•ë³„ì •ì±…] ì§€ì›ì‚¬í•­ ê²€ì¦ í†µê³¼');
          }
        }
      }

      console.log('âœ… [ì •ì±…ìˆ˜ì •-ìš”ê¸ˆì œìœ í˜•ë³„ì •ì±…] ê²€ì¦ ì™„ë£Œ');
    }

    // ì¼ë°˜ ì •ì±… ê²€ì¦ (êµ¬ë‘ì •ì±…, ë¶€ê°€ì°¨ê°ì§€ì›ì •ì±…, ë¶€ê°€ì¶”ê°€ì§€ì›ì •ì±…, ìš”ê¸ˆì œìœ í˜•ë³„ì •ì±…ì´ ì•„ë‹Œ ê²½ìš°)
    if (!isShoePolicy && !isAddDeductPolicy && !isAddSupportPolicy && !isRatePolicyForUpdate) {
      console.log('ğŸ” [ì •ì±…ìˆ˜ì •-ì¼ë°˜ì •ì±…] ê²€ì¦ ì‹œì‘');
      if (!amountType) missingFields.push('amountType');
      console.log('âœ… [ì •ì±…ìˆ˜ì •-ì¼ë°˜ì •ì±…] ê²€ì¦ ì™„ë£Œ');
    }

    if (missingFields.length > 0) {
      console.log('ì •ì±… ìˆ˜ì • - ëˆ„ë½ëœ í•„ë“œ:', missingFields);

      // í•„ë“œëª…ì„ í•œêµ­ì–´ë¡œ ë³€í™˜
      const fieldNames = {
        'policyName': 'ì •ì±…ëª…',
        'policyStartDate': 'ì •ì±… ì‹œì‘ì¼',
        'policyEndDate': 'ì •ì±… ì¢…ë£Œì¼',
        'policyStore': 'ì •ì±…ì ìš©ì ',
        'policyContent': 'ì •ì±…ë‚´ìš©',
        'amountType': 'ê¸ˆì•¡ ìœ í˜•',
        'amount95Above ë˜ëŠ” amount95Below ë˜ëŠ” policyContent': '95êµ°ì´ìƒ/ë¯¸ë§Œ ê¸ˆì•¡ ë˜ëŠ” ì •ì±…ë‚´ìš©',
        'ì°¨ê°ì§€ì› ê¸ˆì•¡': 'ì°¨ê°ì§€ì› ê¸ˆì•¡'
      };

      const missingFieldNames = missingFields.map(field => fieldNames[field] || field);
      const errorMessage = `ë‹¤ìŒ í•„ìˆ˜ í•­ëª©ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤: ${missingFieldNames.join(', ')}`;

      return res.status(400).json({
        success: false,
        error: errorMessage,
        missingFields: missingFields,
        missingFieldNames: missingFieldNames,
        received: { policyName, policyStartDate, policyEndDate, policyStore, policyContent, amountType, isShoePolicy }
      });
    }

    // amountTypeì´ 'in_content'ê°€ ì•„ë‹ ë•Œë§Œ policyAmount í•„ìˆ˜ (êµ¬ë‘ì •ì±…, ë¶€ê°€ì°¨ê°ì§€ì›ì •ì±…ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ)
    if (!isShoePolicy && !isAddDeductPolicy && !isAddSupportPolicy && !isRatePolicyForUpdate && amountType !== 'in_content' && !policyAmount) {
      return res.status(400).json({
        success: false,
        error: 'ê¸ˆì•¡ì´ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.',
        received: { policyAmount, amountType }
      });
    }

    // ì •ì±…_ê¸°ë³¸ì •ë³´ ì‹œíŠ¸ì—ì„œ í•´ë‹¹ ì •ì±… ì°¾ê¸°
    const values = await getSheetValuesWithoutCache('ì •ì±…_ê¸°ë³¸ì •ë³´ ');

    if (!values || values.length <= 1) {
      return res.status(404).json({ success: false, error: 'ì •ì±…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
    }

    // ì •ì±… ì°¾ê¸° (í—¤ë” ì œì™¸)
    const dataRows = values.slice(1);
    const policyIndex = dataRows.findIndex(row => row[0] === policyId);

    if (policyIndex === -1) {
      return res.status(404).json({ success: false, error: 'ì •ì±…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
    }

    const policyRow = dataRows[policyIndex];
    const rowNumber = policyIndex + 2; // í—¤ë” + 1ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ +2

    // ì •ì±… ì ìš©ì¼ì„ ì‹œì‘ì¼~ì¢…ë£Œì¼ í˜•íƒœë¡œ ë³€í™˜
    const startDate = new Date(policyStartDate).toLocaleDateString('ko-KR');
    const endDate = new Date(policyEndDate).toLocaleDateString('ko-KR');
    const policyDateRange = `${startDate} ~ ${endDate}`;

    // ê¸ˆì•¡ ì •ë³´ì— ìœ í˜• ì¶”ê°€
    const amountWithType = amountType === 'in_content'
      ? 'ë‚´ìš©ì— ì§ì ‘ì…ë ¥'
      : `${policyAmount}ì› (${amountType === 'total' ? 'ì´ê¸ˆì•¡' : 'ê±´ë‹¹ê¸ˆì•¡'})`;

    // ë§¤ì¥ëª… ì¡°íšŒ
    let storeName = '';
    try {
      const storeValues = await getSheetValues(STORE_SHEET_NAME);
      if (storeValues && storeValues.length > 1) {
        const storeRows = storeValues.slice(1);
        const store = storeRows.find(row => {
          const storeId = row[15]; // Pì—´: ë§¤ì¥ì½”ë“œ (15ì¸ë±ìŠ¤)
          return storeId && storeId.toString() === policyStore.toString();
        });
        if (store) {
          storeName = store[14] ? store[14].toString().trim() : ''; // Oì—´: ì—…ì²´ëª… (14ì¸ë±ìŠ¤)
        }
      }
    } catch (error) {
      console.warn('ë§¤ì¥ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨:', error.message);
    }

    // ê¸°ì¡´ í–‰ ë°ì´í„°ë¥¼ ìœ ì§€í•˜ë©´ì„œ ìˆ˜ì •í•  í•„ë“œë§Œ ì—…ë°ì´íŠ¸
    // ê¸°ì¡´ í–‰ì´ 24ê°œ ì»¬ëŸ¼ë³´ë‹¤ ì ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ìµœì†Œ 51ê°œê¹Œì§€ í™•ì¥ (AYì—´ í¬í•¨)
    const updatedRow = [...policyRow];
    while (updatedRow.length < 51) {
      updatedRow.push('');
    }

    // B~Lì—´ ì—…ë°ì´íŠ¸ (ê¸°ë³¸ ì •ë³´)
    updatedRow[1] = policyName;                  // Bì—´: ì •ì±…ëª…
    updatedRow[2] = policyDateRange;             // Cì—´: ì •ì±…ì ìš©ì¼
    updatedRow[3] = policyStore;                 // Dì—´: ì •ì±…ì ìš©ì 
    updatedRow[4] = policyContent;               // Eì—´: ì •ì±…ë‚´ìš©
    updatedRow[5] = amountWithType;              // Fì—´: ê¸ˆì•¡
    updatedRow[6] = policyType;                  // Gì—´: ì •ì±…ìœ í˜•
    updatedRow[7] = (category && category.startsWith('wireless')) ? 'ë¬´ì„ ' : 'ìœ ì„ '; // Hì—´: ë¬´ì„ /ìœ ì„ 
    updatedRow[8] = category || '';              // Iì—´: í•˜ìœ„ì¹´í…Œê³ ë¦¬
    updatedRow[9] = inputUserId;                 // Jì—´: ì…ë ¥ìID
    updatedRow[10] = inputUserName;              // Kì—´: ì…ë ¥ìëª…
    updatedRow[11] = new Date().toISOString();   // Lì—´: ì…ë ¥ì¼ì‹œ (ìˆ˜ì •ì¼ì‹œë¡œ ì—…ë°ì´íŠ¸)
    // M~Wì—´ì€ ìŠ¹ì¸ìƒíƒœ, ì·¨ì†Œ, ì •ì‚°ë°˜ì˜ ì •ë³´ì´ë¯€ë¡œ ìœ ì§€ (ê¸°ì¡´ ê°’ ìœ ì§€)
    updatedRow[23] = yearMonth;                  // Xì—´: ëŒ€ìƒë…„ì›”
    updatedRow[24] = req.body.multipleStoreName || ''; // Yì—´: ë³µìˆ˜ì ëª…
    updatedRow[25] = storeName;                  // Zì—´: ì—…ì²´ëª…
    updatedRow[26] = (() => {                    // AAì—´: ê°œí†µìœ í˜•
      if (category === 'wireless_add_deduct' || category === 'wired_add_deduct' ||
        category === 'wireless_add_support' || category === 'wired_add_support' ||
        category === 'wireless_rate' || category === 'wired_rate') {
        return 'ì „ìœ í˜•';
      }
      if (!req.body.activationType) return '';
      const { new010, mnp, change } = req.body.activationType;
      const types = [];
      if (new010) types.push('010ì‹ ê·œ');
      if (mnp) types.push('MNP');
      if (change) types.push('ê¸°ë³€');
      if (types.length === 3) return 'ì „ìœ í˜•';
      return types.join(', ');
    })();
    updatedRow[27] = (category === 'wireless_shoe' || category === 'wired_shoe') ? (req.body.amount95Above || '') : ''; // ABì—´: 95êµ°ì´ìƒê¸ˆì•¡
    updatedRow[28] = (category === 'wireless_shoe' || category === 'wired_shoe') ? (req.body.amount95Below || '') : ''; // ACì—´: 95êµ°ë¯¸ë§Œê¸ˆì•¡
    updatedRow[29] = (policyTeam && policyTeam.trim()) || 'ë¯¸ì§€ì •'; // ADì—´: ì†Œì†íŒ€ (ì¤‘ìš”: JSONì´ ì•„ë‹Œ ì†Œì†íŒ€ ê°’)
    // AE~AGì—´: ë¶€ê°€ì°¨ê°ì§€ì›ì •ì±… ë°ì´í„° (ê°œë³„ í•„ë“œë¡œ ì €ì¥)
    updatedRow[30] = (category === 'wireless_add_deduct' || category === 'wired_add_deduct') ? (req.body.deductSupport?.addServiceAmount || '') : ''; // AEì—´: ë¶€ê°€ë¯¸ìœ ì¹˜ê¸ˆì•¡
    updatedRow[31] = (category === 'wireless_add_deduct' || category === 'wired_add_deduct') ? (req.body.deductSupport?.insuranceAmount || '') : ''; // AFì—´: ë³´í—˜ë¯¸ìœ ì¹˜ê¸ˆì•¡
    updatedRow[32] = (category === 'wireless_add_deduct' || category === 'wired_add_deduct') ? (req.body.deductSupport?.connectionAmount || '') : ''; // AGì—´: ì—°ê²°ìŒë¯¸ìœ ì¹˜ê¸ˆì•¡
    // AH~AQì—´: ë¶€ê°€ì¶”ê°€ì§€ì›ì •ì±… ë°ì´í„°
    updatedRow[33] = (category === 'wireless_add_deduct' || category === 'wired_add_deduct') ? (req.body.conditionalOptions?.addServiceAcquired ? 'Y' : 'N') : ''; // AHì—´: ë¶€ê°€ìœ ì¹˜ì‹œì¡°ê±´
    updatedRow[34] = (category === 'wireless_add_deduct' || category === 'wired_add_deduct') ? (req.body.conditionalOptions?.insuranceAcquired ? 'Y' : 'N') : ''; // AIì—´: ë³´í—˜ìœ ì¹˜ì‹œì¡°ê±´
    updatedRow[35] = (category === 'wireless_add_deduct' || category === 'wired_add_deduct') ? (req.body.conditionalOptions?.connectionAcquired ? 'Y' : 'N') : ''; // AJì—´: ì—°ê²°ìŒìœ ì¹˜ì‹œì¡°ê±´
    updatedRow[36] = (category === 'wireless_add_support' || category === 'wired_add_support') ? (req.body.addSupport?.uplayPremiumAmount || '') : ''; // AKì—´: ìœ í”Œë ˆì´(í”„ë¦¬ë¯¸ì—„) ìœ ì¹˜ê¸ˆì•¡
    updatedRow[37] = (category === 'wireless_add_support' || category === 'wired_add_support') ? (req.body.addSupport?.phoneExchangePassAmount || '') : ''; // ALì—´: í°êµì²´íŒ¨ìŠ¤ ìœ ì¹˜ê¸ˆì•¡
    updatedRow[38] = (category === 'wireless_add_support' || category === 'wired_add_support') ? (req.body.addSupport?.musicAmount || '') : ''; // AMì—´: ìŒì•…ê°ìƒ ìœ ì¹˜ê¸ˆì•¡
    updatedRow[39] = (category === 'wireless_add_support' || category === 'wired_add_support') ? (req.body.addSupport?.numberFilteringAmount || '') : ''; // ANì—´: ì§€ì •ë²ˆí˜¸í•„í„°ë§ ìœ ì¹˜ê¸ˆì•¡
    updatedRow[40] = (category === 'wireless_add_support' || category === 'wired_add_support') ? (req.body.supportConditionalOptions?.vas2Both ? 'Y' : 'N') : ''; // AOì—´: VAS 2ì¢… ë™ì‹œìœ ì¹˜ ì¡°ê±´
    updatedRow[41] = (category === 'wireless_add_support' || category === 'wired_add_support') ? (req.body.supportConditionalOptions?.vas2Either ? 'Y' : 'N') : ''; // APì—´: VAS 2ì¢…ì¤‘ 1ê°œìœ ì¹˜ ì¡°ê±´
    updatedRow[42] = (category === 'wireless_add_support' || category === 'wired_add_support') ? (req.body.supportConditionalOptions?.addon3All ? 'Y' : 'N') : ''; // AQì—´: ë¶€ê°€3ì¢… ëª¨ë‘ìœ ì¹˜ ì¡°ê±´
    // AR~AXì—´: ê¸°íƒ€ ì •ì±… ë°ì´í„°
    updatedRow[43] = (category === 'wireless_rate' || category === 'wired_rate') ? JSON.stringify(req.body.rateSupports || []) : ''; // ARì—´: ìš”ê¸ˆì œìœ í˜•ë³„ì •ì±… ì§€ì›ì‚¬í•­
    updatedRow[44] = (category === 'wireless_union' || category === 'wired_union') ? (req.body.unionSettlementStore || '') : ''; // ASì—´: ì—°í•©ì •ì±… ì •ì‚° ì…ê¸ˆì²˜
    updatedRow[45] = (category === 'wireless_union' || category === 'wired_union') ? JSON.stringify(req.body.unionTargetStores || []) : ''; // ATì—´: ì—°í•©ì •ì±… ì—°í•©ëŒ€ìƒí•˜ë¶€ì 
    updatedRow[46] = (category === 'wireless_union' || category === 'wired_union') ? JSON.stringify(req.body.unionConditions || {}) : ''; // AUì—´: ì—°í•©ì •ì±… ì¡°ê±´
    updatedRow[47] = (category === 'wireless_individual' || category === 'wired_individual') ? JSON.stringify(req.body.individualTarget || {}) : ''; // AVì—´: ê°œë³„ì†Œê¸‰ì •ì±… ì ìš©ëŒ€ìƒ
    updatedRow[48] = (category === 'wireless_individual' || category === 'wired_individual') ? (req.body.individualActivationType || '') : ''; // AWì—´: ê°œë³„ì†Œê¸‰ì •ì±… ê°œí†µìœ í˜•
    updatedRow[49] = req.body.manager || ''; // AXì—´: ë‹´ë‹¹ìëª…
    // AYì—´: ì§ì ‘ì…ë ¥ì—¬ë¶€ (true/falseë¥¼ Y/Nìœ¼ë¡œ ì €ì¥)
    if (updatedRow.length < 51) {
      updatedRow.push('');
    }
    updatedRow[50] = (req.body.isDirectInput === true || req.body.isDirectInput === 'true') ? 'Y' : 'N'; // AYì—´: ì§ì ‘ì…ë ¥ì—¬ë¶€

    // ì „ì²´ í–‰ì„ í•œ ë²ˆì— ì—…ë°ì´íŠ¸ (A~AY ì—´, 51ê°œ ì»¬ëŸ¼)
    await sheets.spreadsheets.values.update({
      spreadsheetId: SPREADSHEET_ID,
      range: `ì •ì±…_ê¸°ë³¸ì •ë³´ !A${rowNumber}:AY${rowNumber}`,
      valueInputOption: 'RAW',
      resource: {
        values: [updatedRow]
      }
    });

    // ì •ì±…_ê¸°ë³¸ì •ë³´ ì‹œíŠ¸ ìºì‹œ ë¬´íš¨í™”
    cacheUtils.delete('sheet_ì •ì±…_ê¸°ë³¸ì •ë³´ ');

    console.log('ì •ì±… ìˆ˜ì • ì™„ë£Œ:', policyId);

    res.json({
      success: true,
      message: 'ì •ì±…ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.',
      policyId: policyId
    });

  } catch (error) {
    console.error('ì •ì±… ìˆ˜ì • ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});


// DELETE ë©”ì„œë“œ í…ŒìŠ¤íŠ¸ API
app.delete('/api/test-delete', (req, res) => {
  console.log('DELETE í…ŒìŠ¤íŠ¸ ìš”ì²­ ë°›ìŒ');
  res.json({ success: true, message: 'DELETE ë©”ì„œë“œê°€ ì‘ë™í•©ë‹ˆë‹¤.' });
});

// ì •ì±… ì‚­ì œ í…ŒìŠ¤íŠ¸ API (ë” ê°„ë‹¨í•œ ë²„ì „)
app.delete('/api/policies-delete/:policyId', async (req, res) => {
  console.log('ğŸ”¥ [DELETE TEST API] ìš”ì²­ ë°›ìŒ:', req.method, req.url);
  try {
    const { policyId } = req.params;
    console.log('ğŸ”¥ [DELETE TEST API] ì •ì±… ì‚­ì œ ìš”ì²­:', { policyId });

    res.json({ success: true, message: 'DELETE í…ŒìŠ¤íŠ¸ APIê°€ ì‘ë™í•©ë‹ˆë‹¤.', policyId });
  } catch (error) {
    console.error('DELETE í…ŒìŠ¤íŠ¸ API ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// ì •ì±… ìŠ¹ì¸ API
app.put('/api/policies/:policyId/approve', async (req, res) => {
  try {
    const { policyId } = req.params;
    const { approvalType, comment, userId, userName } = req.body;

    console.log('ì •ì±… ìŠ¹ì¸ ìš”ì²­:', { policyId, approvalType, comment, userId, userName });

    // ì •ì±…_ê¸°ë³¸ì •ë³´ ì‹œíŠ¸ì—ì„œ í•´ë‹¹ ì •ì±… ì°¾ê¸°
    const values = await getSheetValuesWithoutCache('ì •ì±…_ê¸°ë³¸ì •ë³´ ');

    if (!values || values.length <= 1) {
      return res.status(404).json({ success: false, error: 'ì •ì±…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
    }

    // ì •ì±… ì°¾ê¸° (í—¤ë” ì œì™¸)
    const dataRows = values.slice(1);
    const policyIndex = dataRows.findIndex(row => row[0] === policyId);

    if (policyIndex === -1) {
      return res.status(404).json({ success: false, error: 'ì •ì±…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
    }

    const policyRow = dataRows[policyIndex];
    const rowNumber = policyIndex + 2; // í—¤ë” + 1ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ +2

    // ìŠ¹ì¸ ìƒíƒœ ì—…ë°ì´íŠ¸
    let updateRange, updateValues;

    if (approvalType === 'total') {
      updateRange = `'ì •ì±…_ê¸°ë³¸ì •ë³´ '!M${rowNumber}`;
      updateValues = [['ìŠ¹ì¸']];
    } else if (approvalType === 'settlement') {
      updateRange = `'ì •ì±…_ê¸°ë³¸ì •ë³´ '!N${rowNumber}`;
      updateValues = [['ìŠ¹ì¸']];
    } else if (approvalType === 'team') {
      updateRange = `'ì •ì±…_ê¸°ë³¸ì •ë³´ '!O${rowNumber}`;
      updateValues = [['ìŠ¹ì¸']];
    } else {
      return res.status(400).json({ success: false, error: 'ì˜ëª»ëœ ìŠ¹ì¸ ìœ í˜•ì…ë‹ˆë‹¤.' });
    }

    // Google Sheets ì—…ë°ì´íŠ¸
    const response = await sheets.spreadsheets.values.update({
      spreadsheetId: SPREADSHEET_ID,
      range: updateRange,
      valueInputOption: 'RAW',
      resource: {
        values: updateValues
      }
    });

    // ìŠ¹ì¸ ì´ë ¥ ì €ì¥
    const approvalHistoryRow = [
      `HIST_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`, // Aì—´: ì´ë ¥ID
      policyId,                                                         // Bì—´: ì •ì±…ID
      approvalType,                                                     // Cì—´: ìŠ¹ì¸ìœ í˜•
      'ìŠ¹ì¸',                                                           // Dì—´: ìŠ¹ì¸ìƒíƒœ
      userId,                                                           // Eì—´: ìŠ¹ì¸ìID
      userName,                                                         // Fì—´: ìŠ¹ì¸ìëª…
      comment || '',                                                    // Gì—´: ìŠ¹ì¸ì½”ë©˜íŠ¸
      new Date().toISOString()                                         // Hì—´: ìŠ¹ì¸ì¼ì‹œ
    ];

    // ì‹œíŠ¸ì— ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
    const existingHistoryData = await getSheetValuesWithoutCache('ì •ì±…_ìŠ¹ì¸ì´ë ¥');

    // í—¤ë” ì •ì˜
    const historyHeaderRow = [
      'ì´ë ¥ID',           // Aì—´
      'ì •ì±…ID',           // Bì—´
      'ìŠ¹ì¸ìœ í˜•',         // Cì—´
      'ìŠ¹ì¸ìƒíƒœ',         // Dì—´
      'ìŠ¹ì¸ìID',         // Eì—´
      'ìŠ¹ì¸ìëª…',         // Fì—´
      'ìŠ¹ì¸ì½”ë©˜íŠ¸',       // Gì—´
      'ìŠ¹ì¸ì¼ì‹œ'          // Hì—´
    ];

    // ì‹œíŠ¸ê°€ ë¹„ì–´ìˆê±°ë‚˜ í—¤ë”ê°€ ì—†ìœ¼ë©´ í—¤ë”ì™€ í•¨ê»˜ ë°ì´í„° ì¶”ê°€
    if (!existingHistoryData || existingHistoryData.length === 0 ||
      !existingHistoryData[0] || existingHistoryData[0][0] !== 'ì´ë ¥ID') {
      console.log('ğŸ“ [ìŠ¹ì¸ì´ë ¥] ì‹œíŠ¸ê°€ ë¹„ì–´ìˆê±°ë‚˜ í—¤ë”ê°€ ì—†ì–´ í—¤ë”ì™€ í•¨ê»˜ ë°ì´í„° ì¶”ê°€');
      await sheets.spreadsheets.values.append({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ì •ì±…_ìŠ¹ì¸ì´ë ¥!A:H',
        valueInputOption: 'RAW',
        insertDataOption: 'INSERT_ROWS',
        resource: {
          values: [historyHeaderRow, approvalHistoryRow]
        }
      });
    } else {
      // ê¸°ì¡´ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì´ë ¥ë§Œ ì¶”ê°€
      console.log('ğŸ“ [ìŠ¹ì¸ì´ë ¥] ê¸°ì¡´ ë°ì´í„°ì— ì´ë ¥ ì¶”ê°€');
      await sheets.spreadsheets.values.append({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ì •ì±…_ìŠ¹ì¸ì´ë ¥!A:H',
        valueInputOption: 'RAW',
        insertDataOption: 'INSERT_ROWS',
        resource: {
          values: [approvalHistoryRow]
        }
      });
    }

    // ìŠ¹ì¸ ì•Œë¦¼ ìƒì„±
    await createPolicyNotification(policyId, userId, 'policy_approved', {
      approvalType,
      comment
    });

    // ì •ì±…_ê¸°ë³¸ì •ë³´ ì‹œíŠ¸ ìºì‹œ ë¬´íš¨í™”
    cacheUtils.delete('sheet_ì •ì±…_ê¸°ë³¸ì •ë³´ ');

    console.log('ì •ì±… ìŠ¹ì¸ ì™„ë£Œ:', response.data);

    res.json({
      success: true,
      message: 'ì •ì±…ì´ ì„±ê³µì ìœ¼ë¡œ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.',
      approvalType,
      approvedBy: userName
    });

  } catch (error) {
    console.error('ì •ì±… ìŠ¹ì¸ ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// ê³µì§€ì‚¬í•­ ê´€ë¦¬ API
const NOTICE_SHEET_NAME = 'ì •ì±…ëª¨ë“œê³µì§€ì‚¬í•­';
const NOTICE_HEADERS = [
  'ì—°ì›”',
  'ì¹´í…Œê³ ë¦¬',
  'ì œëª©',
  'ë‚´ìš©',
  'ì‘ì„±ì',
  'ì‘ì„±ì¼ì‹œ',
  'ìˆ˜ì •ì¼ì‹œ',
  'ID',
  'ë¹„ê³ '
];

// ê³µì§€ì‚¬í•­ ì‹œíŠ¸ êµ¬ì¡° í™•ì¸ ë° ì´ˆê¸°í™”
async function ensureNoticeSheetStructure() {
  try {
    const spreadsheetMeta = await sheets.spreadsheets.get({
      spreadsheetId: SPREADSHEET_ID
    });
    const sheetExists = (spreadsheetMeta.data.sheets || []).some(
      (sheet) => sheet.properties && sheet.properties.title === NOTICE_SHEET_NAME
    );

    if (!sheetExists) {
      await sheets.spreadsheets.batchUpdate({
        spreadsheetId: SPREADSHEET_ID,
        resource: {
          requests: [
            {
              addSheet: {
                properties: {
                  title: NOTICE_SHEET_NAME
                }
              }
            }
          ]
        }
      });
    }

    // í—¤ë”ëŠ” 1í–‰: ë¹ˆ í–‰, 2í–‰: ì‹¤ì œ í—¤ë”
    const headerRange = `${NOTICE_SHEET_NAME}!A1:${String.fromCharCode(65 + NOTICE_HEADERS.length - 1)}2`;
    const headerResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: headerRange
    });
    const headerValues = headerResponse.data.values || [];
    const firstRow = headerValues[0] || [];
    const secondRow = headerValues[1] || [];

    const isFirstRowBlank = firstRow.length === 0 || firstRow.every((cell) => !cell || String(cell).trim() === '');
    const isSecondRowHeader = NOTICE_HEADERS.every(
      (header, index) => (secondRow[index] || '') === header
    );

    if (!isFirstRowBlank || !isSecondRowHeader) {
      const values = [
        new Array(NOTICE_HEADERS.length).fill(''),
        NOTICE_HEADERS
      ];
      await sheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: headerRange,
        valueInputOption: 'RAW',
        resource: {
          values
        }
      });
    }
  } catch (error) {
    console.error('ê³µì§€ì‚¬í•­ ì‹œíŠ¸ êµ¬ì¡° í™•ì¸ ì‹¤íŒ¨:', error);
    throw error;
  }
}

// GET /api/policy-notices - ê³µì§€ì‚¬í•­ ëª©ë¡ ì¡°íšŒ
app.get('/api/policy-notices', async (req, res) => {
  try {
    const { yearMonth, category } = req.query;

    console.log('ğŸ“¢ [ê³µì§€ì‚¬í•­] ëª©ë¡ ì¡°íšŒ ìš”ì²­:', { yearMonth, category });

    await ensureNoticeSheetStructure();

    const values = await getSheetValuesWithoutCache(NOTICE_SHEET_NAME);

    console.log('ğŸ“¢ [ê³µì§€ì‚¬í•­] ì‹œíŠ¸ ë°ì´í„°:', {
      totalRows: values ? values.length : 0,
      hasData: values && values.length > 2
    });

    if (!values || values.length <= 2) {
      console.log('ğŸ“¢ [ê³µì§€ì‚¬í•­] ë°ì´í„° ì—†ìŒ (í—¤ë”ë§Œ ìˆê±°ë‚˜ ë¹ˆ ì‹œíŠ¸)');
      return res.json({ success: true, notices: [] });
    }

    // í—¤ë” ì œì™¸ (1í–‰: ë¹ˆ í–‰, 2í–‰: í—¤ë”)
    const dataRows = values.slice(2);

    console.log('ğŸ“¢ [ê³µì§€ì‚¬í•­] ë°ì´í„° í–‰ ìˆ˜:', dataRows.length);

    // í•„í„°ë§ ì ìš©
    let filteredNotices = dataRows
      .map((row, index) => {
        // êµ¬ê¸€ì‹œíŠ¸ì—ì„œ ë§ˆì§€ë§‰ ì»¬ëŸ¼ì´ ë¹„ì–´ìˆìœ¼ë©´ ë°°ì—´ ê¸¸ì´ê°€ ì§§ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ
        // ìµœì†Œ 9ê°œ ì»¬ëŸ¼ì´ ë˜ë„ë¡ ë¹ˆ ê°’ìœ¼ë¡œ ì±„ì›€
        while (row.length < 9) {
          row.push('');
        }
        return row;
      })
      .filter((row, index) => {
        // ìµœì†Œ í•„ìˆ˜ ì»¬ëŸ¼ í™•ì¸ (ì—°ì›”, ì¹´í…Œê³ ë¦¬, ì œëª©, ë‚´ìš©, ì‘ì„±ì - 5ê°œ ì´ìƒ)
        // IDëŠ” ì—†ì–´ë„ ìë™ ìƒì„± ê°€ëŠ¥í•˜ë¯€ë¡œ 5ê°œ ì´ìƒì´ë©´ OK
        if (row.length < 5) {
          console.log(`ğŸ“¢ [ê³µì§€ì‚¬í•­] í–‰ ${index + 3} í•„ìˆ˜ ì»¬ëŸ¼ ìˆ˜ ë¶€ì¡±:`, row.length);
          return false;
        }

        const noticeYearMonth = (row[0] || '').toString().trim(); // ì—°ì›”
        const noticeCategory = (row[1] || '').toString().trim(); // ì¹´í…Œê³ ë¦¬

        // ì—°ì›”ê³¼ ì¹´í…Œê³ ë¦¬ê°€ ëª¨ë‘ ë¹„ì–´ìˆìœ¼ë©´ ìœ íš¨í•˜ì§€ ì•Šì€ ë°ì´í„°ë¡œ ê°„ì£¼
        if (!noticeYearMonth && !noticeCategory) {
          console.log(`ğŸ“¢ [ê³µì§€ì‚¬í•­] í–‰ ${index + 3} ì—°ì›”/ì¹´í…Œê³ ë¦¬ ëª¨ë‘ ë¹„ì–´ìˆìŒ`);
          return false;
        }

        console.log(`ğŸ“¢ [ê³µì§€ì‚¬í•­] í–‰ ${index + 3} í•„í„°ë§:`, {
          noticeYearMonth,
          noticeCategory,
          requestYearMonth: yearMonth,
          requestCategory: category,
          rowLength: row.length
        });

        // ì—°ì›” í•„í„°
        if (yearMonth && noticeYearMonth !== yearMonth) {
          console.log(`ğŸ“¢ [ê³µì§€ì‚¬í•­] í–‰ ${index + 3} ì—°ì›” ë¶ˆì¼ì¹˜ë¡œ ì œì™¸`);
          return false;
        }

        // ì¹´í…Œê³ ë¦¬ í•„í„°
        if (category) {
          // "ì „ì²´"ì´ê±°ë‚˜ ë¹ˆ ê°’ì´ë©´ ëª¨ë“  ì¹´í…Œê³ ë¦¬ì— í‘œì‹œ
          if (noticeCategory === 'ì „ì²´' || noticeCategory === '' || !noticeCategory) {
            console.log(`ğŸ“¢ [ê³µì§€ì‚¬í•­] í–‰ ${index + 3} ì „ì²´ ì¹´í…Œê³ ë¦¬ë¡œ í¬í•¨ (ì¹´í…Œê³ ë¦¬: "${noticeCategory}")`);
            return true;
          }
          // ì¹´í…Œê³ ë¦¬ê°€ ì¼ì¹˜í•˜ë©´ í¬í•¨
          if (noticeCategory === category) {
            console.log(`ğŸ“¢ [ê³µì§€ì‚¬í•­] í–‰ ${index + 3} ì¹´í…Œê³ ë¦¬ ì¼ì¹˜ë¡œ í¬í•¨ (${noticeCategory} === ${category})`);
            return true;
          }
          // ê·¸ ì™¸ëŠ” ì œì™¸
          console.log(`ğŸ“¢ [ê³µì§€ì‚¬í•­] í–‰ ${index + 3} ì¹´í…Œê³ ë¦¬ ë¶ˆì¼ì¹˜ë¡œ ì œì™¸ (${noticeCategory} !== ${category})`);
          return false;
        }

        // ì¹´í…Œê³ ë¦¬ í•„í„°ê°€ ì—†ìœ¼ë©´ ëª¨ë‘ í¬í•¨
        console.log(`ğŸ“¢ [ê³µì§€ì‚¬í•­] í–‰ ${index + 3} í•„í„° ì—†ìŒìœ¼ë¡œ í¬í•¨`);
        return true;
      })
      .map((row, index) => {
        // IDëŠ” 7ë²ˆì§¸ ì»¬ëŸ¼(ì¸ë±ìŠ¤ 7)ì´ì§€ë§Œ, ì»¬ëŸ¼ì´ ë¶€ì¡±í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
        const noticeId = (row[7] || '').toString().trim() || `NOTICE_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        return {
          id: noticeId,
          yearMonth: (row[0] || '').toString().trim(),
          category: (row[1] || '').toString().trim(),
          title: (row[2] || '').toString().trim(),
          content: (row[3] || '').toString().trim(),
          author: (row[4] || '').toString().trim(),
          createdAt: (row[5] || '').toString().trim(),
          updatedAt: (row[6] || '').toString().trim(),
          note: (row[8] || '').toString().trim(), // 8ë²ˆì§¸ ì»¬ëŸ¼(ì¸ë±ìŠ¤ 8) - ë¹„ê³ 
          rowIndex: index + 3 // ì‹¤ì œ ì‹œíŠ¸ í–‰ ë²ˆí˜¸ (1í–‰ ë¹ˆ í–‰, 2í–‰ í—¤ë”, 3í–‰ë¶€í„° ë°ì´í„°)
        };
      });

    console.log('ğŸ“¢ [ê³µì§€ì‚¬í•­] í•„í„°ë§ ê²°ê³¼:', {
      total: dataRows.length,
      filtered: filteredNotices.length,
      notices: filteredNotices.map(n => ({ id: n.id, title: n.title, category: n.category, yearMonth: n.yearMonth }))
    });

    res.json({
      success: true,
      notices: filteredNotices
    });

  } catch (error) {
    console.error('âŒ [ê³µì§€ì‚¬í•­] ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// POST /api/policy-notices - ê³µì§€ì‚¬í•­ ìƒì„±
app.post('/api/policy-notices', async (req, res) => {
  try {
    const { yearMonth, category, title, content, author, note } = req.body;

    console.log('ê³µì§€ì‚¬í•­ ìƒì„± ìš”ì²­:', { yearMonth, category, title, author });

    if (!yearMonth || !title || !content || !author) {
      return res.status(400).json({
        success: false,
        error: 'í•„ìˆ˜ í•„ë“œê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤. (ì—°ì›”, ì œëª©, ë‚´ìš©, ì‘ì„±ì)'
      });
    }

    await ensureNoticeSheetStructure();

    const noticeId = `NOTICE_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    const now = new Date().toISOString().replace('T', ' ').substring(0, 19);

    // ì¹´í…Œê³ ë¦¬ ì²˜ë¦¬: ë¹ˆ ë¬¸ìì—´ì´ë©´ ê·¸ëŒ€ë¡œ ì €ì¥ (ëª¨ë“  ì¹´í…Œê³ ë¦¬ì— í‘œì‹œ)
    const categoryValue = category === 'ì „ì²´' ? '' : (category || '');

    console.log('ğŸ“¢ [ê³µì§€ì‚¬í•­] ìƒì„± ë°ì´í„°:', {
      yearMonth,
      category: categoryValue,
      title,
      author
    });

    const newNoticeRow = [
      yearMonth || '',
      categoryValue, // ë¹ˆ ë¬¸ìì—´ì´ë©´ ëª¨ë“  ì¹´í…Œê³ ë¦¬ì— í‘œì‹œ
      title || '',
      content || '',
      author || '',
      now, // ì‘ì„±ì¼ì‹œ
      now, // ìˆ˜ì •ì¼ì‹œ
      noticeId,
      note || ''
    ];

    await sheets.spreadsheets.values.append({
      spreadsheetId: SPREADSHEET_ID,
      range: `${NOTICE_SHEET_NAME}!A3:I3`,
      valueInputOption: 'RAW',
      insertDataOption: 'INSERT_ROWS',
      resource: {
        values: [newNoticeRow]
      }
    });

    // ìºì‹œ ë¬´íš¨í™”
    cacheUtils.delete(`sheet_${NOTICE_SHEET_NAME}_${SPREADSHEET_ID}`);

    res.json({
      success: true,
      message: 'ê³µì§€ì‚¬í•­ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.',
      notice: {
        id: noticeId,
        yearMonth,
        category: category || 'ì „ì²´',
        title,
        content,
        author,
        createdAt: now,
        updatedAt: now,
        note: note || ''
      }
    });

  } catch (error) {
    console.error('ê³µì§€ì‚¬í•­ ìƒì„± ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// PUT /api/policy-notices/:id - ê³µì§€ì‚¬í•­ ìˆ˜ì •
app.put('/api/policy-notices/:id', async (req, res) => {
  try {
    const { id } = req.params;
    const { yearMonth, category, title, content, author, note } = req.body;

    console.log('ê³µì§€ì‚¬í•­ ìˆ˜ì • ìš”ì²­:', { id, title, author });

    await ensureNoticeSheetStructure();

    const values = await getSheetValuesWithoutCache(NOTICE_SHEET_NAME);

    if (!values || values.length <= 2) {
      return res.status(404).json({
        success: false,
        error: 'ê³µì§€ì‚¬í•­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }

    const dataRows = values.slice(2);
    const noticeIndex = dataRows.findIndex(row => (row[7] || '').toString() === id);

    if (noticeIndex === -1) {
      return res.status(404).json({
        success: false,
        error: 'ê³µì§€ì‚¬í•­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }

    const noticeRow = dataRows[noticeIndex];
    const rowNumber = noticeIndex + 3; // 1í–‰ ë¹ˆ í–‰, 2í–‰ í—¤ë”, 3í–‰ë¶€í„° ë°ì´í„°

    const now = new Date().toISOString().replace('T', ' ').substring(0, 19);

    // ì¹´í…Œê³ ë¦¬ ì²˜ë¦¬: "ì „ì²´"ë©´ ë¹ˆ ë¬¸ìì—´ë¡œ ì €ì¥
    const categoryValue = category !== undefined
      ? (category === 'ì „ì²´' ? '' : category)
      : (noticeRow[1] || '');

    console.log('ğŸ“¢ [ê³µì§€ì‚¬í•­] ìˆ˜ì • ë°ì´í„°:', {
      id,
      yearMonth: yearMonth !== undefined ? yearMonth : noticeRow[0],
      category: categoryValue,
      title: title !== undefined ? title : noticeRow[2]
    });

    const updatedRow = [
      yearMonth !== undefined ? yearMonth : noticeRow[0] || '',
      categoryValue, // ë¹ˆ ë¬¸ìì—´ì´ë©´ ëª¨ë“  ì¹´í…Œê³ ë¦¬ì— í‘œì‹œ
      title !== undefined ? title : noticeRow[2] || '',
      content !== undefined ? content : noticeRow[3] || '',
      author !== undefined ? author : noticeRow[4] || '',
      noticeRow[5] || now, // ì‘ì„±ì¼ì‹œëŠ” ìœ ì§€
      now, // ìˆ˜ì •ì¼ì‹œ ì—…ë°ì´íŠ¸
      id, // ID ìœ ì§€
      note !== undefined ? note : noticeRow[8] || ''
    ];

    await sheets.spreadsheets.values.update({
      spreadsheetId: SPREADSHEET_ID,
      range: `${NOTICE_SHEET_NAME}!A${rowNumber}:I${rowNumber}`,
      valueInputOption: 'RAW',
      resource: {
        values: [updatedRow]
      }
    });

    // ìºì‹œ ë¬´íš¨í™”
    cacheUtils.delete(`sheet_${NOTICE_SHEET_NAME}_${SPREADSHEET_ID}`);

    res.json({
      success: true,
      message: 'ê³µì§€ì‚¬í•­ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.',
      notice: {
        id,
        yearMonth: updatedRow[0],
        category: updatedRow[1],
        title: updatedRow[2],
        content: updatedRow[3],
        author: updatedRow[4],
        createdAt: updatedRow[5],
        updatedAt: updatedRow[6],
        note: updatedRow[8]
      }
    });

  } catch (error) {
    console.error('ê³µì§€ì‚¬í•­ ìˆ˜ì • ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// DELETE /api/policy-notices/:id - ê³µì§€ì‚¬í•­ ì‚­ì œ
app.delete('/api/policy-notices/:id', async (req, res) => {
  try {
    const { id } = req.params;

    console.log('ê³µì§€ì‚¬í•­ ì‚­ì œ ìš”ì²­:', { id });

    await ensureNoticeSheetStructure();

    const values = await getSheetValuesWithoutCache(NOTICE_SHEET_NAME);

    if (!values || values.length <= 2) {
      return res.status(404).json({
        success: false,
        error: 'ê³µì§€ì‚¬í•­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }

    const dataRows = values.slice(2);
    const noticeIndex = dataRows.findIndex(row => (row[7] || '').toString() === id);

    if (noticeIndex === -1) {
      return res.status(404).json({
        success: false,
        error: 'ê³µì§€ì‚¬í•­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }

    const rowNumber = noticeIndex + 3; // 1í–‰ ë¹ˆ í–‰, 2í–‰ í—¤ë”, 3í–‰ë¶€í„° ë°ì´í„°

    // í–‰ ì‚­ì œ
    await sheets.spreadsheets.batchUpdate({
      spreadsheetId: SPREADSHEET_ID,
      resource: {
        requests: [
          {
            deleteDimension: {
              range: {
                sheetId: (await sheets.spreadsheets.get({ spreadsheetId: SPREADSHEET_ID })).data.sheets.find(
                  s => s.properties.title === NOTICE_SHEET_NAME
                ).properties.sheetId,
                dimension: 'ROWS',
                startIndex: rowNumber - 1, // 0-based index
                endIndex: rowNumber
              }
            }
          }
        ]
      }
    });

    // ìºì‹œ ë¬´íš¨í™”
    cacheUtils.delete(`sheet_${NOTICE_SHEET_NAME}_${SPREADSHEET_ID}`);

    res.json({
      success: true,
      message: 'ê³µì§€ì‚¬í•­ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.'
    });

  } catch (error) {
    console.error('ê³µì§€ì‚¬í•­ ì‚­ì œ ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// ì¹´í…Œê³ ë¦¬ ê´€ë¦¬ API
app.get('/api/policy-categories', async (req, res) => {
  try {
    console.log('ì¹´í…Œê³ ë¦¬ ëª©ë¡ ì¡°íšŒ ìš”ì²­');

    const values = await getSheetValuesWithoutCache('ì •ì±…_ì¹´í…Œê³ ë¦¬');

    if (!values || values.length === 0) {
      // ì¹´í…Œê³ ë¦¬ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ì¹´í…Œê³ ë¦¬ ìƒì„±
      await initializeDefaultCategories();
      const defaultValues = await getSheetValuesWithoutCache('ì •ì±…_ì¹´í…Œê³ ë¦¬');
      const categories = defaultValues.slice(1).map(row => ({
        id: row[0],
        name: row[1],
        policyType: row[2],
        icon: row[3],
        isActive: row[4] === 'í™œì„±',
        sortOrder: parseInt(row[5]) || 0,
        createdAt: row[6],
        updatedAt: row[7]
      }));

      return res.json({ success: true, categories });
    }

    const categories = values.slice(1).map(row => ({
      id: row[0],
      name: row[1],
      policyType: row[2],
      icon: row[3],
      isActive: row[4] === 'í™œì„±',
      sortOrder: parseInt(row[5]) || 0,
      createdAt: row[6],
      updatedAt: row[7]
    }));

    console.log(`ì¹´í…Œê³ ë¦¬ ëª©ë¡ ì¡°íšŒ ì™„ë£Œ: ${categories.length}ê±´`);
    res.json({ success: true, categories });

  } catch (error) {
    console.error('ì¹´í…Œê³ ë¦¬ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// ì¹´í…Œê³ ë¦¬ ì¶”ê°€ API
app.post('/api/policy-categories', async (req, res) => {
  try {
    const { name, policyType, icon, sortOrder } = req.body;

    console.log('ìƒˆ ì¹´í…Œê³ ë¦¬ ìƒì„± ìš”ì²­:', req.body);

    // í•„ìˆ˜ í•„ë“œ ê²€ì¦
    if (!name || !policyType || !icon) {
      return res.status(400).json({
        success: false,
        error: 'í•„ìˆ˜ í•„ë“œê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.'
      });
    }

    // ì¹´í…Œê³ ë¦¬ ID ìƒì„±
    const categoryId = `${policyType}_${name.replace(/\s+/g, '_').toLowerCase()}`;

    // ìƒˆ ì¹´í…Œê³ ë¦¬ ë°ì´í„° ìƒì„±
    const newCategoryRow = [
      categoryId,                    // Aì—´: ì¹´í…Œê³ ë¦¬ID
      name,                          // Bì—´: ì¹´í…Œê³ ë¦¬ëª…
      policyType,                    // Cì—´: ì •ì±…íƒ€ì…
      icon,                          // Dì—´: ì•„ì´ì½˜
      'í™œì„±',                        // Eì—´: í™œì„±í™”ì—¬ë¶€
      sortOrder || 0,                // Fì—´: ì •ë ¬ìˆœì„œ
      new Date().toISOString(),      // Gì—´: ìƒì„±ì¼ì‹œ
      new Date().toISOString()       // Hì—´: ìˆ˜ì •ì¼ì‹œ
    ];

    // ì‹œíŠ¸ì— ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
    const existingData = await getSheetValuesWithoutCache('ì •ì±…_ì¹´í…Œê³ ë¦¬');

    // í—¤ë” ì •ì˜
    const headerRow = [
      'ì¹´í…Œê³ ë¦¬ID',      // Aì—´
      'ì¹´í…Œê³ ë¦¬ëª…',      // Bì—´
      'ì •ì±…íƒ€ì…',        // Cì—´
      'ì•„ì´ì½˜',          // Dì—´
      'í™œì„±í™”ì—¬ë¶€',      // Eì—´
      'ì •ë ¬ìˆœì„œ',        // Fì—´
      'ìƒì„±ì¼ì‹œ',        // Gì—´
      'ìˆ˜ì •ì¼ì‹œ'         // Hì—´
    ];

    let response;

    // ì‹œíŠ¸ê°€ ë¹„ì–´ìˆê±°ë‚˜ í—¤ë”ê°€ ì—†ìœ¼ë©´ í—¤ë”ì™€ í•¨ê»˜ ë°ì´í„° ì¶”ê°€
    if (!existingData || existingData.length === 0 ||
      !existingData[0] || existingData[0][0] !== 'ì¹´í…Œê³ ë¦¬ID') {
      console.log('ğŸ“ [ì¹´í…Œê³ ë¦¬ìƒì„±] ì‹œíŠ¸ê°€ ë¹„ì–´ìˆê±°ë‚˜ í—¤ë”ê°€ ì—†ì–´ í—¤ë”ì™€ í•¨ê»˜ ë°ì´í„° ì¶”ê°€');
      response = await sheets.spreadsheets.values.append({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ì •ì±…_ì¹´í…Œê³ ë¦¬!A:H',
        valueInputOption: 'RAW',
        insertDataOption: 'INSERT_ROWS',
        resource: {
          values: [headerRow, newCategoryRow]
        }
      });
    } else {
      // ê¸°ì¡´ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì¹´í…Œê³ ë¦¬ë§Œ ì¶”ê°€
      console.log('ğŸ“ [ì¹´í…Œê³ ë¦¬ìƒì„±] ê¸°ì¡´ ë°ì´í„°ì— ì¹´í…Œê³ ë¦¬ ì¶”ê°€');
      response = await sheets.spreadsheets.values.append({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ì •ì±…_ì¹´í…Œê³ ë¦¬!A:H',
        valueInputOption: 'RAW',
        insertDataOption: 'INSERT_ROWS',
        resource: {
          values: [newCategoryRow]
        }
      });
    }

    // ì •ì±…_ì¹´í…Œê³ ë¦¬ ì‹œíŠ¸ ìºì‹œ ë¬´íš¨í™”
    cacheUtils.delete('sheet_ì •ì±…_ì¹´í…Œê³ ë¦¬');

    console.log('ì¹´í…Œê³ ë¦¬ ìƒì„± ì™„ë£Œ:', response.data);

    res.json({
      success: true,
      message: 'ì¹´í…Œê³ ë¦¬ê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.',
      categoryId: categoryId
    });

  } catch (error) {
    console.error('ì¹´í…Œê³ ë¦¬ ìƒì„± ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// ê¸°ë³¸ ì¹´í…Œê³ ë¦¬ ì´ˆê¸°í™” í•¨ìˆ˜
async function initializeDefaultCategories() {
  const defaultCategories = [
    ['wireless_shoe', 'êµ¬ë‘ì •ì±…', 'wireless', 'ğŸ‘', 'í™œì„±', 1, new Date().toISOString(), new Date().toISOString()],
    ['wireless_union', 'ì—°í•©ì •ì±…', 'wireless', 'ğŸ¤', 'í™œì„±', 2, new Date().toISOString(), new Date().toISOString()],
    ['wireless_rate', 'ìš”ê¸ˆì œìœ í˜•ë³„ì •ì±…', 'wireless', 'ğŸ’°', 'í™œì„±', 3, new Date().toISOString(), new Date().toISOString()],
    ['wireless_add_support', 'ë¶€ê°€ì¶”ê°€ì§€ì›ì •ì±…', 'wireless', 'â•', 'í™œì„±', 4, new Date().toISOString(), new Date().toISOString()],
    ['wireless_add_deduct', 'ë¶€ê°€ì°¨ê°ì§€ì›ì •ì±…', 'wireless', 'â–', 'í™œì„±', 5, new Date().toISOString(), new Date().toISOString()],
    ['wireless_grade', 'ê·¸ë ˆì´ë“œì •ì±…', 'wireless', 'â­', 'í™œì„±', 6, new Date().toISOString(), new Date().toISOString()],
    ['wireless_individual', 'ê°œë³„ì†Œê¸‰ì •ì±…', 'wireless', 'ğŸ“‹', 'í™œì„±', 7, new Date().toISOString(), new Date().toISOString()],
    ['wired_shoe', 'êµ¬ë‘ì •ì±…', 'wired', 'ğŸ‘', 'í™œì„±', 1, new Date().toISOString(), new Date().toISOString()],
    ['wired_union', 'ì—°í•©ì •ì±…', 'wired', 'ğŸ¤', 'í™œì„±', 2, new Date().toISOString(), new Date().toISOString()],
    ['wired_rate', 'ìš”ê¸ˆì œìœ í˜•ë³„ì •ì±…', 'wired', 'ğŸ’°', 'í™œì„±', 3, new Date().toISOString(), new Date().toISOString()],
    ['wired_add_support', 'ë¶€ê°€ì¶”ê°€ì§€ì›ì •ì±…', 'wired', 'â•', 'í™œì„±', 4, new Date().toISOString(), new Date().toISOString()],
    ['wired_add_deduct', 'ë¶€ê°€ì°¨ê°ì§€ì›ì •ì±…', 'wired', 'â–', 'í™œì„±', 5, new Date().toISOString(), new Date().toISOString()],
    ['wired_grade', 'ê·¸ë ˆì´ë“œì •ì±…', 'wired', 'â­', 'í™œì„±', 6, new Date().toISOString(), new Date().toISOString()],
    ['wired_individual', 'ê°œë³„ì†Œê¸‰ì •ì±…', 'wired', 'ğŸ“‹', 'í™œì„±', 7, new Date().toISOString(), new Date().toISOString()]
  ];

  const headerRow = [
    'ì¹´í…Œê³ ë¦¬ID',      // Aì—´
    'ì¹´í…Œê³ ë¦¬ëª…',      // Bì—´
    'ì •ì±…íƒ€ì…',        // Cì—´
    'ì•„ì´ì½˜',          // Dì—´
    'í™œì„±í™”ì—¬ë¶€',      // Eì—´
    'ì •ë ¬ìˆœì„œ',        // Fì—´
    'ìƒì„±ì¼ì‹œ',        // Gì—´
    'ìˆ˜ì •ì¼ì‹œ'         // Hì—´
  ];

  await sheets.spreadsheets.values.append({
    spreadsheetId: SPREADSHEET_ID,
    range: 'ì •ì±…_ì¹´í…Œê³ ë¦¬!A:H',
    valueInputOption: 'RAW',
    insertDataOption: 'INSERT_ROWS',
    resource: {
      values: [headerRow, ...defaultCategories]
    }
  });

  console.log('ê¸°ë³¸ ì¹´í…Œê³ ë¦¬ ì´ˆê¸°í™” ì™„ë£Œ');
}

// ê³µì§€ì‚¬í•­ ì‹œíŠ¸ êµ¬ì¡° í™•ì¸ ë° ì´ˆê¸°í™” í•¨ìˆ˜
async function ensurePolicyNoticeSheetStructure() {
  try {
    const sheetName = 'ì •ì±…ëª¨ë“œê³µì§€ì‚¬í•­';
    const spreadsheetMeta = await sheets.spreadsheets.get({
      spreadsheetId: SPREADSHEET_ID
    });

    const sheetExists = (spreadsheetMeta.data.sheets || []).some(
      (sheet) => sheet.properties && sheet.properties.title === sheetName
    );

    if (!sheetExists) {
      // ì‹œíŠ¸ê°€ ì—†ìœ¼ë©´ ìƒì„±
      await sheets.spreadsheets.batchUpdate({
        spreadsheetId: SPREADSHEET_ID,
        resource: {
          requests: [
            {
              addSheet: {
                properties: {
                  title: sheetName
                }
              }
            }
          ]
        }
      });
      console.log(`ğŸ“‹ [ê³µì§€ì‚¬í•­] ì‹œíŠ¸ ìƒì„±: ${sheetName}`);
    }

    // í—¤ë” êµ¬ì¡° í™•ì¸ (1í–‰ì€ ë¹„ì›Œë‘ê³  2í–‰ì— í—¤ë”)
    const headerRange = `${sheetName}!A1:I2`;
    const headerResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: headerRange
    });
    const headerValues = headerResponse.data.values || [];
    const firstRow = headerValues[0] || [];
    const secondRow = headerValues[1] || [];

    const headers = ['ì—°ì›”', 'ì¹´í…Œê³ ë¦¬', 'ì œëª©', 'ë‚´ìš©', 'ì‘ì„±ì', 'ì‘ì„±ì¼ì‹œ', 'ìˆ˜ì •ì¼ì‹œ', 'ID', 'ë¹„ê³ '];
    const isFirstRowBlank = firstRow.length === 0 || firstRow.every((cell) => !cell || String(cell).trim() === '');
    const isSecondRowHeader = headers.every((header, index) => (secondRow[index] || '') === header);

    if (!isFirstRowBlank || !isSecondRowHeader) {
      const values = [
        new Array(headers.length).fill(''), // 1í–‰: ë¹ˆ í–‰
        headers // 2í–‰: í—¤ë”
      ];
      await sheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: headerRange,
        valueInputOption: 'RAW',
        resource: {
          values
        }
      });
      console.log(`ğŸ“‹ [ê³µì§€ì‚¬í•­] í—¤ë” ì„¤ì • ì™„ë£Œ: ${sheetName}`);
    }

    return true;
  } catch (error) {
    console.error('ê³µì§€ì‚¬í•­ ì‹œíŠ¸ êµ¬ì¡° í™•ì¸ ì‹¤íŒ¨:', error);
    throw error;
  }
}

// ê³µì§€ì‚¬í•­ ëª©ë¡ ì¡°íšŒ API
app.get('/api/policy/notices', async (req, res) => {
  try {
    console.log('ê³µì§€ì‚¬í•­ ëª©ë¡ ì¡°íšŒ ìš”ì²­:', req.query);

    const { yearMonth, category } = req.query;

    // ì‹œíŠ¸ êµ¬ì¡° í™•ì¸
    await ensurePolicyNoticeSheetStructure();

    // ê³µì§€ì‚¬í•­ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const values = await getSheetValuesWithoutCache('ì •ì±…ëª¨ë“œê³µì§€ì‚¬í•­');

    if (!values || values.length <= 2) {
      return res.json({ success: true, notices: [] });
    }

    // í—¤ë” ì œì™¸ (1í–‰ ë¹ˆ í–‰, 2í–‰ í—¤ë” ì œì™¸)
    const dataRows = values.slice(2);

    // í•„í„°ë§ ì ìš©
    let filteredNotices = dataRows.filter(row => {
      if (row.length < 9) return false;

      const noticeYearMonth = row[0] || ''; // Aì—´: ì—°ì›”
      const noticeCategory = row[1] || '';  // Bì—´: ì¹´í…Œê³ ë¦¬
      const noticeId = row[7] || '';        // Hì—´: ID

      // IDê°€ ì—†ìœ¼ë©´ ì œì™¸
      if (!noticeId) return false;

      // ì—°ì›” í•„í„°
      if (yearMonth && noticeYearMonth !== yearMonth) {
        return false;
      }

      // ì¹´í…Œê³ ë¦¬ í•„í„° (ì „ì²´ ë˜ëŠ” íŠ¹ì • ì¹´í…Œê³ ë¦¬)
      if (category && noticeCategory !== 'ì „ì²´' && noticeCategory !== category) {
        return false;
      }

      return true;
    });

    // ê³µì§€ì‚¬í•­ ëª©ë¡ ë³€í™˜
    const notices = filteredNotices.map(row => ({
      id: row[7] || '',              // Hì—´: ID
      yearMonth: row[0] || '',       // Aì—´: ì—°ì›”
      category: row[1] || '',        // Bì—´: ì¹´í…Œê³ ë¦¬
      title: row[2] || '',           // Cì—´: ì œëª©
      content: row[3] || '',         // Dì—´: ë‚´ìš©
      author: row[4] || '',          // Eì—´: ì‘ì„±ì
      createdAt: row[5] || '',       // Fì—´: ì‘ì„±ì¼ì‹œ
      updatedAt: row[6] || '',       // Gì—´: ìˆ˜ì •ì¼ì‹œ
      note: row[8] || ''             // Iì—´: ë¹„ê³ 
    }));

    // ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬ (ìˆ˜ì •ì¼ì‹œ ê¸°ì¤€)
    notices.sort((a, b) => {
      const dateA = new Date(a.updatedAt || a.createdAt);
      const dateB = new Date(b.updatedAt || b.createdAt);
      return dateB - dateA;
    });

    console.log(`ê³µì§€ì‚¬í•­ ëª©ë¡ ì¡°íšŒ ì™„ë£Œ: ${notices.length}ê±´`);
    res.json({ success: true, notices });

  } catch (error) {
    console.error('ê³µì§€ì‚¬í•­ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// ê³µì§€ì‚¬í•­ ìƒì„± API
app.post('/api/policy/notices', async (req, res) => {
  try {
    console.log('ê³µì§€ì‚¬í•­ ìƒì„± ìš”ì²­:', req.body);

    const { yearMonth, category, title, content, author, note } = req.body;

    // í•„ìˆ˜ í•„ë“œ ê²€ì¦
    if (!yearMonth || !title || !content || !author) {
      return res.status(400).json({
        success: false,
        error: 'í•„ìˆ˜ í•„ë“œê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.'
      });
    }

    // ì‹œíŠ¸ êµ¬ì¡° í™•ì¸
    await ensurePolicyNoticeSheetStructure();

    // ê³µì§€ì‚¬í•­ ID ìƒì„±
    const noticeId = `NOTICE_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    const now = new Date().toISOString();

    // ìƒˆ ê³µì§€ì‚¬í•­ ë°ì´í„° ìƒì„±
    const newNoticeRow = [
      yearMonth,           // Aì—´: ì—°ì›”
      category || 'ì „ì²´',  // Bì—´: ì¹´í…Œê³ ë¦¬
      title,               // Cì—´: ì œëª©
      content,             // Dì—´: ë‚´ìš©
      author,              // Eì—´: ì‘ì„±ì
      now,                 // Fì—´: ì‘ì„±ì¼ì‹œ
      now,                 // Gì—´: ìˆ˜ì •ì¼ì‹œ
      noticeId,            // Hì—´: ID
      note || ''           // Iì—´: ë¹„ê³ 
    ];

    // ì‹œíŠ¸ì— ì¶”ê°€
    await sheets.spreadsheets.values.append({
      spreadsheetId: SPREADSHEET_ID,
      range: 'ì •ì±…ëª¨ë“œê³µì§€ì‚¬í•­!A:I',
      valueInputOption: 'RAW',
      insertDataOption: 'INSERT_ROWS',
      resource: {
        values: [newNoticeRow]
      }
    });

    // ìºì‹œ ë¬´íš¨í™”
    cacheUtils.delete('sheet_ì •ì±…ëª¨ë“œê³µì§€ì‚¬í•­');

    console.log('ê³µì§€ì‚¬í•­ ìƒì„± ì™„ë£Œ:', noticeId);
    res.json({
      success: true,
      message: 'ê³µì§€ì‚¬í•­ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.',
      notice: {
        id: noticeId,
        yearMonth,
        category: category || 'ì „ì²´',
        title,
        content,
        author,
        createdAt: now,
        updatedAt: now,
        note: note || ''
      }
    });

  } catch (error) {
    console.error('ê³µì§€ì‚¬í•­ ìƒì„± ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// ê³µì§€ì‚¬í•­ ìˆ˜ì • API
app.put('/api/policy/notices/:id', async (req, res) => {
  try {
    console.log('ê³µì§€ì‚¬í•­ ìˆ˜ì • ìš”ì²­:', req.params.id, req.body);

    const { id } = req.params;
    const { title, content, author, note, category } = req.body;

    // í•„ìˆ˜ í•„ë“œ ê²€ì¦
    if (!title || !content || !author) {
      return res.status(400).json({
        success: false,
        error: 'í•„ìˆ˜ í•„ë“œê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.'
      });
    }

    // ì‹œíŠ¸ êµ¬ì¡° í™•ì¸
    await ensurePolicyNoticeSheetStructure();

    // ê³µì§€ì‚¬í•­ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const values = await getSheetValuesWithoutCache('ì •ì±…ëª¨ë“œê³µì§€ì‚¬í•­');

    if (!values || values.length <= 2) {
      return res.status(404).json({ success: false, error: 'ê³µì§€ì‚¬í•­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
    }

    // í—¤ë” ì œì™¸
    const dataRows = values.slice(2);
    const noticeIndex = dataRows.findIndex(row => row[7] === id); // Hì—´: ID

    if (noticeIndex === -1) {
      return res.status(404).json({ success: false, error: 'ê³µì§€ì‚¬í•­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
    }

    const noticeRow = dataRows[noticeIndex];
    const rowNumber = noticeIndex + 3; // 1í–‰ ë¹ˆ í–‰ + 2í–‰ í—¤ë” + ë°ì´í„° ì‹œì‘ (1-based)

    // ìˆ˜ì •í•  ë°ì´í„° ì¤€ë¹„
    const updatedAt = new Date().toISOString();
    const updateValues = [
      [
        noticeRow[0],                    // Aì—´: ì—°ì›” (ë³€ê²½ ë¶ˆê°€)
        category !== undefined ? category : noticeRow[1], // Bì—´: ì¹´í…Œê³ ë¦¬
        title,                           // Cì—´: ì œëª©
        content,                         // Dì—´: ë‚´ìš©
        author,                          // Eì—´: ì‘ì„±ì
        noticeRow[5],                    // Fì—´: ì‘ì„±ì¼ì‹œ (ë³€ê²½ ë¶ˆê°€)
        updatedAt,                       // Gì—´: ìˆ˜ì •ì¼ì‹œ
        id,                              // Hì—´: ID (ë³€ê²½ ë¶ˆê°€)
        note !== undefined ? note : noticeRow[8] // Iì—´: ë¹„ê³ 
      ]
    ];

    // ì‹œíŠ¸ ì—…ë°ì´íŠ¸
    await sheets.spreadsheets.values.update({
      spreadsheetId: SPREADSHEET_ID,
      range: `ì •ì±…ëª¨ë“œê³µì§€ì‚¬í•­!A${rowNumber}:I${rowNumber}`,
      valueInputOption: 'RAW',
      resource: {
        values: updateValues
      }
    });

    // ìºì‹œ ë¬´íš¨í™”
    cacheUtils.delete('sheet_ì •ì±…ëª¨ë“œê³µì§€ì‚¬í•­');

    console.log('ê³µì§€ì‚¬í•­ ìˆ˜ì • ì™„ë£Œ:', id);
    res.json({
      success: true,
      message: 'ê³µì§€ì‚¬í•­ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.',
      notice: {
        id,
        yearMonth: noticeRow[0],
        category: category !== undefined ? category : noticeRow[1],
        title,
        content,
        author,
        createdAt: noticeRow[5],
        updatedAt,
        note: note !== undefined ? note : noticeRow[8]
      }
    });

  } catch (error) {
    console.error('ê³µì§€ì‚¬í•­ ìˆ˜ì • ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// ê³µì§€ì‚¬í•­ ì‚­ì œ API
app.delete('/api/policy/notices/:id', async (req, res) => {
  try {
    console.log('ê³µì§€ì‚¬í•­ ì‚­ì œ ìš”ì²­:', req.params.id);

    const { id } = req.params;

    // ì‹œíŠ¸ êµ¬ì¡° í™•ì¸
    await ensurePolicyNoticeSheetStructure();

    // ê³µì§€ì‚¬í•­ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const values = await getSheetValuesWithoutCache('ì •ì±…ëª¨ë“œê³µì§€ì‚¬í•­');

    if (!values || values.length <= 2) {
      return res.status(404).json({ success: false, error: 'ê³µì§€ì‚¬í•­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
    }

    // í—¤ë” ì œì™¸
    const dataRows = values.slice(2);
    const noticeIndex = dataRows.findIndex(row => row[7] === id); // Hì—´: ID

    if (noticeIndex === -1) {
      return res.status(404).json({ success: false, error: 'ê³µì§€ì‚¬í•­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
    }

    const rowNumber = noticeIndex + 3; // 1í–‰ ë¹ˆ í–‰ + 2í–‰ í—¤ë” + ë°ì´í„° ì‹œì‘ (1-based)

    // ì‹œíŠ¸ì—ì„œ í–‰ ì‚­ì œ
    await sheets.spreadsheets.batchUpdate({
      spreadsheetId: SPREADSHEET_ID,
      resource: {
        requests: [
          {
            deleteDimension: {
              range: {
                sheetId: (await sheets.spreadsheets.get({
                  spreadsheetId: SPREADSHEET_ID
                })).data.sheets.find(s => s.properties.title === 'ì •ì±…ëª¨ë“œê³µì§€ì‚¬í•­').properties.sheetId,
                dimension: 'ROWS',
                startIndex: rowNumber - 1, // 0-based
                endIndex: rowNumber
              }
            }
          }
        ]
      }
    });

    // ìºì‹œ ë¬´íš¨í™”
    cacheUtils.delete('sheet_ì •ì±…ëª¨ë“œê³µì§€ì‚¬í•­');

    console.log('ê³µì§€ì‚¬í•­ ì‚­ì œ ì™„ë£Œ:', id);
    res.json({
      success: true,
      message: 'ê³µì§€ì‚¬í•­ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.'
    });

  } catch (error) {
    console.error('ê³µì§€ì‚¬í•­ ì‚­ì œ ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// ìš´ì˜ëª¨ë¸ ì‹œíŠ¸ì—ì„œ ëª¨ë¸ ìˆœì„œ ê°€ì ¸ì˜¤ê¸° API
app.get('/api/operation-models', async (req, res) => {
  try {
    const cacheKey = 'operation_models_order';

    // ìºì‹œì—ì„œ ë¨¼ì € í™•ì¸ (1ì‹œê°„ TTL)
    const cachedData = cacheUtils.get(cacheKey);
    if (cachedData) {
      return res.json(cachedData);
    }

    const operationModelValues = await getSheetValues('ìš´ì˜ëª¨ë¸');

    if (!operationModelValues || operationModelValues.length < 4) {
      throw new Error('ìš´ì˜ëª¨ë¸ ì‹œíŠ¸ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    // 3í–‰ í—¤ë”ë¥¼ ì œì™¸í•˜ê³  4í–‰ë¶€í„° ë°ì´í„° ì²˜ë¦¬
    const modelOrder = {};
    operationModelValues.slice(3).forEach((row, index) => {
      if (row.length >= 3) {
        const modelName = (row[2] || '').toString().trim(); // Cì—´: ëª¨ë¸ëª…
        if (modelName && modelName !== 'ëª¨ë¸ëª…') {
          modelOrder[modelName] = index;
        }
      }
    });

    const result = {
      success: true,
      data: modelOrder,
      count: Object.keys(modelOrder).length
    };

    // ìºì‹œì— ì €ì¥ (1ì‹œê°„ TTL)
    cacheUtils.set(cacheKey, result, 60 * 60 * 1000);

    res.json(result);
  } catch (error) {
    console.error('Error fetching operation models:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to fetch operation models',
      message: error.message
    });
  }
});

// ì¬ê³ ì¥í‘œ API - ëª¨ë¸ë³„ ì¬ê³  í˜„í™©
app.get('/api/inventory/status', async (req, res) => {
  try {
    const { agent, office, department } = req.query;

    // ìºì‹œ í‚¤ ìƒì„±
    const cacheKey = `inventory_status_${agent || 'all'}_${office || 'all'}_${department || 'all'}`;

    // ìºì‹œì—ì„œ ë¨¼ì € í™•ì¸ (30ë¶„ TTL)
    const cachedData = cacheUtils.get(cacheKey);
    if (cachedData) {
      return res.json(cachedData);
    }

    // í°í´ì¬ê³ ë°ì´í„°ì™€ í°í´ê°œí†µë°ì´í„° ë³‘ë ¬ë¡œ ê°€ì ¸ì˜¤ê¸°
    const [inventoryValues, activationValues] = await Promise.all([
      getSheetValues('í°í´ì¬ê³ ë°ì´í„°'),
      getSheetValues('í°í´ê°œí†µë°ì´í„°')
    ]);

    if (!inventoryValues || inventoryValues.length < 4) {
      throw new Error('í°í´ì¬ê³ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    if (!activationValues || activationValues.length < 4) {
      throw new Error('í°í´ê°œí†µë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    // ì¬ê³  ë°ì´í„° ì²˜ë¦¬ (ëª¨ë¸ë³„ ì§‘ê³„)
    const inventoryMap = new Map(); // key: "ëª¨ë¸ëª…", value: { ì¬ê³ ìˆ˜ëŸ‰, ë‹´ë‹¹ì, ì‚¬ë¬´ì‹¤, ì†Œì†, êµ¬ë¶„ }

    console.log(`ğŸ“Š [ì¬ê³ ë°°ì • ë””ë²„ê¹…] ì¬ê³  ë°ì´í„° í–‰ ìˆ˜: ${inventoryValues.length}`);
    let processedRows = 0;
    let validModels = 0;

    inventoryValues.slice(3).forEach((row, index) => {
      if (row.length >= 23) {
        const modelName = (row[13] || '').toString().trim(); // Nì—´: ëª¨ë¸ëª…
        const color = (row[14] || '').toString().trim(); // Oì—´: ìƒ‰ìƒ
        const category = (row[5] || '').toString().trim(); // Fì—´: êµ¬ë¶„
        const office = (row[6] || '').toString().trim(); // Gì—´: ì‚¬ë¬´ì‹¤
        const department = (row[7] || '').toString().trim(); // Hì—´: ì†Œì†
        const agent = (row[8] || '').toString().trim(); // Iì—´: ë‹´ë‹¹ì
        const store = (row[21] || '').toString().trim(); // Vì—´: ì¶œê³ ì²˜

        // ë””ë²„ê¹…: ì²˜ìŒ 5ê°œ í–‰ì˜ ëª¨ë¸ëª… í™•ì¸
        if (index < 5) {
          console.log(`ì¬ê³  í–‰ ${index}: ëª¨ë¸ëª…="${modelName}", ìƒ‰ìƒ="${color}", êµ¬ë¶„="${category}", ê¸¸ì´=${row.length}`);
        }

        if (modelName && category !== '#N/A') {
          validModels++;
          // í•„í„°ë§ ì ìš©
          if (req.query.agent && req.query.agent !== agent) return;
          if (req.query.office && req.query.office !== office) return;
          if (req.query.department && req.query.department !== department) return;

          // ëª¨ë¸ë³„ì¬ê³ í˜„í™©ì—ì„œëŠ” ëª¨ë¸ëª…+ìƒ‰ìƒìœ¼ë¡œ ì§‘ê³„ (ì„œë²„ì—ì„œëŠ” ì›ë³¸ ë°ì´í„° ìœ ì§€)
          const key = `${modelName}|${color}`;
          if (!inventoryMap.has(key)) {
            inventoryMap.set(key, {
              modelName,
              color,
              category,
              store,
              agent,
              office,
              department,
              inventoryCount: 0,
              monthlyActivation: 0,
              dailyActivation: Array(31).fill(0)
            });
          }

          inventoryMap.get(key).inventoryCount++;
        }
      }
    });

    // ê°œí†µ ë°ì´í„° ì²˜ë¦¬
    const currentMonth = new Date().getMonth() + 1;
    const currentYear = new Date().getFullYear();

    activationValues.slice(3).forEach(row => {
      if (row.length >= 23) {
        const activationDate = (row[9] || '').toString().trim(); // Jì—´: ê°œí†µì¼
        const modelName = (row[21] || '').toString().trim(); // Vì—´: ëª¨ë¸ëª…
        const color = (row[22] || '').toString().trim(); // Wì—´: ìƒ‰ìƒ
        const store = (row[14] || '').toString().trim(); // Oì—´: ì¶œê³ ì²˜
        const agent = (row[8] || '').toString().trim(); // Iì—´: ë‹´ë‹¹ì
        const office = (row[6] || '').toString().trim(); // Gì—´: ì‚¬ë¬´ì‹¤
        const department = (row[7] || '').toString().trim(); // Hì—´: ì†Œì†

        if (activationDate && modelName) {
          // ë‚ ì§œ íŒŒì‹± (2025-08-02 í˜•ì‹ì—ì„œ ë‚ ì§œ ì¶”ì¶œ)
          const dateMatch = activationDate.match(/(\d{4})-(\d{2})-(\d{2})/);
          if (dateMatch) {
            const [, year, month, day] = dateMatch;
            const activationYear = parseInt(year);
            const activationMonth = parseInt(month);
            const activationDay = parseInt(day);

            // í˜„ì¬ ì›”ì˜ ë°ì´í„°ë§Œ ì²˜ë¦¬
            if (activationYear === currentYear && activationMonth === currentMonth) {
              // í•„í„°ë§ ì ìš©
              if (req.query.agent && req.query.agent !== agent) return;
              if (req.query.office && req.query.office !== office) return;
              if (req.query.department && req.query.department !== department) return;

              // ëª¨ë¸ë³„ì¬ê³ í˜„í™©ì—ì„œëŠ” ëª¨ë¸ëª…+ìƒ‰ìƒìœ¼ë¡œ ë§¤ì¹­ (ì„œë²„ì—ì„œëŠ” ì›ë³¸ ë°ì´í„° ìœ ì§€)
              const key = `${modelName}|${color}`;
              const inventoryItem = inventoryMap.get(key);
              if (inventoryItem) {
                inventoryItem.monthlyActivation++;

                // ì¼ë³„ ê°œí†µ í˜„í™© (1ì¼~31ì¼)
                if (activationDay >= 1 && activationDay <= 31) {
                  inventoryItem.dailyActivation[activationDay - 1]++;
                }
              }
            }
          }
        }
      }
    });

    // ê²°ê³¼ ë°ì´í„° êµ¬ì„±
    const result = {
      success: true,
      data: Array.from(inventoryMap.values()).map(item => ({
        ...item,
        dailyActivation: item.dailyActivation.map((count, index) => ({
          day: String(index + 1).padStart(2, '0'),
          count
        }))
      }))
    };

    // ìºì‹œì— ì €ì¥
    cacheUtils.set(cacheKey, result);

    res.json(result);

  } catch (error) {
    console.error('ì¬ê³  í˜„í™© ì¡°íšŒ ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// ì¬ê³ ì¥í‘œ API - ë‹´ë‹¹ì í•„í„° ì˜µì…˜ (ì‹¤ì œ ì¬ê³ ê°€ ìˆëŠ” ë‹´ë‹¹ìë§Œ)
app.get('/api/inventory/agent-filters', async (req, res) => {
  try {
    // ìºì‹œ í‚¤ ìƒì„±
    const cacheKey = 'inventory_agent_filters';

    // ìºì‹œì—ì„œ ë¨¼ì € í™•ì¸ (30ë¶„ TTL)
    const cachedData = cacheUtils.get(cacheKey);
    if (cachedData) {
      return res.json(cachedData);
    }

    // í°í´ì¬ê³ ë°ì´í„°ì™€ í°í´ê°œí†µë°ì´í„° ë³‘ë ¬ë¡œ ê°€ì ¸ì˜¤ê¸°
    const [inventoryValues, activationValues] = await Promise.all([
      getSheetValues('í°í´ì¬ê³ ë°ì´í„°'),
      getSheetValues('í°í´ê°œí†µë°ì´í„°')
    ]);

    if (!inventoryValues || inventoryValues.length < 4) {
      throw new Error('í°í´ì¬ê³ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    if (!activationValues || activationValues.length < 4) {
      throw new Error('í°í´ê°œí†µë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    // ì‹¤ì œ ì¬ê³ ê°€ ìˆëŠ” ë‹´ë‹¹ì ì¶”ì¶œ
    const agentsWithInventory = new Set();
    const agentsWithActivation = new Set();
    const agentInfo = new Map(); // key: ë‹´ë‹¹ìëª…, value: { office, department }

    // ì¬ê³  ë°ì´í„°ì—ì„œ ë‹´ë‹¹ì ì¶”ì¶œ
    inventoryValues.slice(3).forEach(row => {
      if (row.length >= 23) {
        const modelName = (row[13] || '').toString().trim(); // Nì—´: ëª¨ë¸ëª…
        const category = (row[5] || '').toString().trim(); // Fì—´: êµ¬ë¶„
        const office = (row[6] || '').toString().trim(); // Gì—´: ì‚¬ë¬´ì‹¤
        const department = (row[7] || '').toString().trim(); // Hì—´: ì†Œì†
        const agent = (row[8] || '').toString().trim(); // Iì—´: ë‹´ë‹¹ì

        if (modelName && category !== '#N/A' && agent) {
          agentsWithInventory.add(agent);
          if (!agentInfo.has(agent)) {
            agentInfo.set(agent, { office, department });
          }
        }
      }
    });

    // ê°œí†µ ë°ì´í„°ì—ì„œ ë‹´ë‹¹ì ì¶”ì¶œ (ë‹¹ì›”)
    const currentMonth = new Date().getMonth() + 1;
    const currentYear = new Date().getFullYear();

    activationValues.slice(3).forEach(row => {
      if (row.length >= 23) {
        const activationDate = (row[9] || '').toString().trim(); // Jì—´: ê°œí†µì¼
        const modelName = (row[21] || '').toString().trim(); // Vì—´: ëª¨ë¸ëª…
        const office = (row[6] || '').toString().trim(); // Gì—´: ì‚¬ë¬´ì‹¤
        const department = (row[7] || '').toString().trim(); // Hì—´: ì†Œì†
        const agent = (row[8] || '').toString().trim(); // Iì—´: ë‹´ë‹¹ì

        if (activationDate && modelName && agent) {
          // ë‚ ì§œ íŒŒì‹± (2025-08-02 í˜•ì‹ì—ì„œ ë‚ ì§œ ì¶”ì¶œ)
          const dateMatch = activationDate.match(/(\d{4})-(\d{2})-(\d{2})/);
          if (dateMatch) {
            const [, year, month] = dateMatch;
            const activationYear = parseInt(year);
            const activationMonth = parseInt(month);

            // í˜„ì¬ ì›”ì˜ ë°ì´í„°ë§Œ ì²˜ë¦¬
            if (activationYear === currentYear && activationMonth === currentMonth) {
              agentsWithActivation.add(agent);
              if (!agentInfo.has(agent)) {
                agentInfo.set(agent, { office, department });
              }
            }
          }
        }
      }
    });

    // ë³´ìœ ì¬ê³ ì™€ ê°œí†µì¬ê³ ê°€ ìˆëŠ” ë‹´ë‹¹ì í†µí•©
    const allAgentsWithData = new Set([...agentsWithInventory, ...agentsWithActivation]);

    // ê²°ê³¼ ë°ì´í„° êµ¬ì„±
    const result = {
      success: true,
      data: Array.from(allAgentsWithData).map(agent => ({
        target: agent,
        contactId: agent,
        office: agentInfo.get(agent)?.office || '',
        department: agentInfo.get(agent)?.department || '',
        hasInventory: agentsWithInventory.has(agent),
        hasActivation: agentsWithActivation.has(agent)
      })).sort((a, b) => a.target.localeCompare(b.target))
    };

    // ìºì‹œì— ì €ì¥ (30ë¶„ TTL)
    cacheUtils.set(cacheKey, result, 30 * 60 * 1000);

    res.json(result);

  } catch (error) {
    console.error('ì¬ê³ ì¥í‘œ ë‹´ë‹¹ì í•„í„° ì˜µì…˜ ì¡°íšŒ ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// ì¬ê³ ì¥í‘œ API - ìƒ‰ìƒë³„ ì¬ê³  í˜„í™©
app.get('/api/inventory/status-by-color', async (req, res) => {
  try {
    const { agent, office, department } = req.query;

    // ìºì‹œ í‚¤ ìƒì„±
    const cacheKey = `inventory_status_by_color_${agent || 'all'}_${office || 'all'}_${department || 'all'}`;

    // ìºì‹œì—ì„œ ë¨¼ì € í™•ì¸ (30ë¶„ TTL)
    const cachedData = cacheUtils.get(cacheKey);
    if (cachedData) {
      return res.json(cachedData);
    }

    // í°í´ì¬ê³ ë°ì´í„°ì™€ í°í´ê°œí†µë°ì´í„° ë³‘ë ¬ë¡œ ê°€ì ¸ì˜¤ê¸°
    const [inventoryValues, activationValues] = await Promise.all([
      getSheetValues('í°í´ì¬ê³ ë°ì´í„°'),
      getSheetValues('í°í´ê°œí†µë°ì´í„°')
    ]);

    if (!inventoryValues || inventoryValues.length < 4) {
      throw new Error('í°í´ì¬ê³ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    if (!activationValues || activationValues.length < 4) {
      throw new Error('í°í´ê°œí†µë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    // ì¬ê³  ë°ì´í„° ì²˜ë¦¬ (ëª¨ë¸ëª…+ìƒ‰ìƒë³„ ì§‘ê³„)
    const inventoryMap = new Map(); // key: "ëª¨ë¸ëª…|ìƒ‰ìƒ", value: { ëª¨ë¸ëª…, ìƒ‰ìƒ, ì¬ê³ ìˆ˜ëŸ‰, ë‹´ë‹¹ì, ì‚¬ë¬´ì‹¤, ì†Œì†, êµ¬ë¶„ }

    // ë¨¼ì € ëª¨ë¸ëª…ì´ ìˆëŠ” í–‰ë“¤ë§Œ ìˆ˜ì§‘
    const validRows = [];
    inventoryValues.slice(3).forEach(row => {
      if (row.length >= 23) {
        const modelName = (row[13] || '').toString().trim(); // Nì—´: ëª¨ë¸ëª…
        const color = (row[14] || '').toString().trim(); // Oì—´: ìƒ‰ìƒ
        const category = (row[5] || '').toString().trim(); // Fì—´: êµ¬ë¶„
        const office = (row[6] || '').toString().trim(); // Gì—´: ì‚¬ë¬´ì‹¤
        const department = (row[7] || '').toString().trim(); // Hì—´: ì†Œì†
        const agent = (row[8] || '').toString().trim(); // Iì—´: ë‹´ë‹¹ì
        const store = (row[21] || '').toString().trim(); // Vì—´: ì¶œê³ ì²˜

        // ëª¨ë¸ëª…ì´ ìˆê³ , ìƒ‰ìƒì´ ìˆê³ , êµ¬ë¶„ì´ #N/Aê°€ ì•„ë‹Œ ê²½ìš°ë§Œ ì²˜ë¦¬
        if (modelName && color && category !== '#N/A') {
          // í•„í„°ë§ ì ìš©
          if (req.query.agent && req.query.agent !== agent) return;
          if (req.query.office && req.query.office !== office) return;
          if (req.query.department && req.query.department !== department) return;

          validRows.push({
            modelName,
            color,
            category,
            store,
            agent,
            office,
            department
          });
        }
      }
    });

    // ëª¨ë¸ëª…ë³„ë¡œ ê·¸ë£¹í™”í•˜ì—¬ ì²˜ë¦¬
    const modelGroups = new Map();
    validRows.forEach(row => {
      if (!modelGroups.has(row.modelName)) {
        modelGroups.set(row.modelName, []);
      }
      modelGroups.get(row.modelName).push(row);
    });

    // ê° ëª¨ë¸ ê·¸ë£¹ì—ì„œ ìƒ‰ìƒë³„ë¡œ ì²˜ë¦¬
    modelGroups.forEach((rows, modelName) => {
      rows.forEach((row, index) => {
        const key = `${modelName}|${row.color}`;

        if (!inventoryMap.has(key)) {
          inventoryMap.set(key, {
            modelName: modelName, // ëª¨ë“  í–‰ì— ëª¨ë¸ëª… í‘œì‹œ (í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì²˜ë¦¬)
            color: row.color,
            category: row.category,
            store: row.store,
            agent: row.agent,
            office: row.office,
            department: row.department,
            inventoryCount: 0,
            monthlyActivation: 0,
            dailyActivation: Array(31).fill(0)
          });
        }

        inventoryMap.get(key).inventoryCount++;
      });
    });

    // ê°œí†µ ë°ì´í„° ì²˜ë¦¬
    const currentMonth = new Date().getMonth() + 1;
    const currentYear = new Date().getFullYear();

    activationValues.slice(3).forEach(row => {
      if (row.length >= 23) {
        const activationDate = (row[9] || '').toString().trim(); // Jì—´: ê°œí†µì¼
        const modelName = (row[21] || '').toString().trim(); // Vì—´: ëª¨ë¸ëª…
        const color = (row[22] || '').toString().trim(); // Wì—´: ìƒ‰ìƒ
        const store = (row[14] || '').toString().trim(); // Oì—´: ì¶œê³ ì²˜
        const agent = (row[8] || '').toString().trim(); // Iì—´: ë‹´ë‹¹ì
        const office = (row[6] || '').toString().trim(); // Gì—´: ì‚¬ë¬´ì‹¤
        const department = (row[7] || '').toString().trim(); // Hì—´: ì†Œì†

        if (activationDate && modelName && color) {
          // ë‚ ì§œ íŒŒì‹± (2025-08-02 í˜•ì‹ì—ì„œ ë‚ ì§œ ì¶”ì¶œ)
          const dateMatch = activationDate.match(/(\d{4})-(\d{2})-(\d{2})/);
          if (dateMatch) {
            const [, year, month, day] = dateMatch;
            const activationYear = parseInt(year);
            const activationMonth = parseInt(month);
            const activationDay = parseInt(day);

            // í˜„ì¬ ì›”ì˜ ë°ì´í„°ë§Œ ì²˜ë¦¬
            if (activationYear === currentYear && activationMonth === currentMonth) {
              // í•„í„°ë§ ì ìš©
              if (req.query.agent && req.query.agent !== agent) return;
              if (req.query.office && req.query.office !== office) return;
              if (req.query.department && req.query.department !== department) return;

              const key = `${modelName}|${color}`;
              const inventoryItem = inventoryMap.get(key);
              if (inventoryItem) {
                inventoryItem.monthlyActivation++;

                // ì¼ë³„ ê°œí†µ í˜„í™© (1ì¼~31ì¼)
                if (activationDay >= 1 && activationDay <= 31) {
                  inventoryItem.dailyActivation[activationDay - 1]++;
                }
              }
            }
          }
        }
      }
    });

    // ê²°ê³¼ ë°ì´í„° êµ¬ì„±
    const result = {
      success: true,
      data: Array.from(inventoryMap.values()).map(item => ({
        ...item,
        dailyActivation: item.dailyActivation.map((count, index) => ({
          day: String(index + 1).padStart(2, '0'),
          count
        }))
      }))
    };

    // ìºì‹œì— ì €ì¥
    cacheUtils.set(cacheKey, result);

    res.json(result);

  } catch (error) {
    console.error('ìƒ‰ìƒë³„ ì¬ê³  í˜„í™© ì¡°íšŒ ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// ì˜ˆì‚° ëŒ€ìƒì›” ê´€ë¦¬ API
app.get('/api/budget/month-sheets', async (req, res) => {
  try {
    const sheets = google.sheets({ version: 'v4', auth });
    const sheetsData = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: 'ì˜ˆì‚°_ëŒ€ìƒì›”ê´€ë¦¬!A:D',
    });

    const rows = sheetsData.data.values || [];

    // ì‹œíŠ¸ê°€ ë¹„ì–´ìˆê±°ë‚˜ í—¤ë”ê°€ ì—†ìœ¼ë©´ í—¤ë” ìƒì„±
    if (rows.length === 0 || !rows[0] || rows[0][0] !== 'ëŒ€ìƒì›”') {
      const headerRow = ['ëŒ€ìƒì›”', 'ì‹œíŠ¸ID', 'ìˆ˜ì •ì¼ì‹œ', 'ìˆ˜ì •ì'];
      await sheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ì˜ˆì‚°_ëŒ€ìƒì›”ê´€ë¦¬!A1:D1',
        valueInputOption: 'RAW',
        resource: {
          values: [headerRow]
        }
      });
      return res.json([]);
    }

    if (rows.length <= 1) {
      return res.json([]);
    }

    // í—¤ë” ì œì™¸í•˜ê³  ë°ì´í„°ë§Œ ë°˜í™˜
    const data = rows.slice(1).map(row => ({
      month: row[0] || '',
      sheetId: row[1] || '',
      updatedAt: row[2] || '',
      updatedBy: row[3] || ''
    }));

    res.json(data);
  } catch (error) {
    console.error('ì˜ˆì‚° ëŒ€ìƒì›” ê´€ë¦¬ ë°ì´í„° ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'ë°ì´í„° ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
  }
});

app.post('/api/budget/month-sheets', async (req, res) => {
  try {
    const { month, sheetId, updatedBy } = req.body;

    if (!month || !sheetId) {
      return res.status(400).json({ error: 'ëŒ€ìƒì›”ê³¼ ì‹œíŠ¸ IDëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.' });
    }

    const currentTime = new Date().toISOString();

    // ê¸°ì¡´ ë°ì´í„° í™•ì¸
    const sheets = google.sheets({ version: 'v4', auth });
    const existingSheets = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: 'ì˜ˆì‚°_ëŒ€ìƒì›”ê´€ë¦¬!A:D',
    });

    const rows = existingSheets.data.values || [];
    const existingRowIndex = rows.findIndex(row => row[0] === month);

    if (existingRowIndex > 0) { // 0ì€ í—¤ë”
      // ê¸°ì¡´ ë°ì´í„° ì—…ë°ì´íŠ¸
      await sheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: `ì˜ˆì‚°_ëŒ€ìƒì›”ê´€ë¦¬!B${existingRowIndex + 1}:D${existingRowIndex + 1}`,
        valueInputOption: 'RAW',
        resource: {
          values: [[sheetId, currentTime, updatedBy]]
        }
      });
    } else {
      // ìƒˆ ë°ì´í„° ì¶”ê°€
      await sheets.spreadsheets.values.append({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ì˜ˆì‚°_ëŒ€ìƒì›”ê´€ë¦¬!A:D',
        valueInputOption: 'RAW',
        insertDataOption: 'INSERT_ROWS',
        resource: {
          values: [[month, sheetId, currentTime, updatedBy]]
        }
      });
    }

    res.json({ message: 'ì›”ë³„ ì‹œíŠ¸ IDê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.' });
  } catch (error) {
    console.error('ì˜ˆì‚° ëŒ€ìƒì›” ê´€ë¦¬ ë°ì´í„° ì €ì¥ ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'ë°ì´í„° ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
  }
});

app.delete('/api/budget/month-sheets/:month', async (req, res) => {
  try {
    const { month } = req.params;

    // ê¸°ì¡´ ë°ì´í„° í™•ì¸
    const sheets = google.sheets({ version: 'v4', auth });
    const existingSheets = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: 'ì˜ˆì‚°_ëŒ€ìƒì›”ê´€ë¦¬!A:D',
    });

    const rows = existingSheets.data.values || [];
    const existingRowIndex = rows.findIndex(row => row[0] === month);

    if (existingRowIndex <= 0) { // 0ì€ í—¤ë”, -1ì€ ì°¾ì§€ ëª»í•¨
      return res.status(404).json({ error: 'í•´ë‹¹ ì›”ì˜ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
    }

    // í–‰ ì‚­ì œ
    await sheets.spreadsheets.batchUpdate({
      spreadsheetId: SPREADSHEET_ID,
      resource: {
        requests: [
          {
            deleteDimension: {
              range: {
                sheetId: await getSheetIdByName('ì˜ˆì‚°_ëŒ€ìƒì›”ê´€ë¦¬'),
                dimension: 'ROWS',
                startIndex: existingRowIndex,
                endIndex: existingRowIndex + 1
              }
            }
          }
        ]
      }
    });

    res.json({ message: 'ì›”ë³„ ì‹œíŠ¸ IDê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.' });
  } catch (error) {
    console.error('ì˜ˆì‚° ëŒ€ìƒì›” ê´€ë¦¬ ë°ì´í„° ì‚­ì œ ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'ë°ì´í„° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
  }
});

// ì‹œíŠ¸ ì´ë¦„ìœ¼ë¡œ ì‹œíŠ¸ IDë¥¼ ê°€ì ¸ì˜¤ëŠ” í—¬í¼ í•¨ìˆ˜
async function getSheetIdByName(sheetName) {
  try {
    const sheets = google.sheets({ version: 'v4', auth });
    const response = await sheets.spreadsheets.get({
      spreadsheetId: SPREADSHEET_ID
    });

    const sheet = response.data.sheets.find(s => s.properties.title === sheetName);
    return sheet ? sheet.properties.sheetId : null;
  } catch (error) {
    console.error('ì‹œíŠ¸ ID ì¡°íšŒ ì˜¤ë¥˜:', error);
    return null;
  }
}

// ì˜ˆì‚°_ì‚¬ìš©ìì‹œíŠ¸ê´€ë¦¬ ì‹œíŠ¸ ì¡´ì¬ í™•ì¸ ë° ìƒì„± í•¨ìˆ˜
async function ensureUserSheetManagementExists(sheets) {
  try {
    // ì‹œíŠ¸ ëª©ë¡ ì¡°íšŒ
    const spreadsheetResponse = await sheets.spreadsheets.get({
      spreadsheetId: SPREADSHEET_ID
    });

    const sheetExists = spreadsheetResponse.data.sheets.some(
      sheet => sheet.properties.title === 'ì˜ˆì‚°_ì‚¬ìš©ìì‹œíŠ¸ê´€ë¦¬'
    );

    if (!sheetExists) {
      console.log('ğŸ“‹ [ì‹œíŠ¸ê´€ë¦¬] ì˜ˆì‚°_ì‚¬ìš©ìì‹œíŠ¸ê´€ë¦¬ ì‹œíŠ¸ê°€ ì—†ì–´ ìƒˆë¡œ ìƒì„±í•©ë‹ˆë‹¤.');

      // ì‹œíŠ¸ ìƒì„±
      await sheets.spreadsheets.batchUpdate({
        spreadsheetId: SPREADSHEET_ID,
        resource: {
          requests: [
            {
              addSheet: {
                properties: {
                  title: 'ì˜ˆì‚°_ì‚¬ìš©ìì‹œíŠ¸ê´€ë¦¬',
                  gridProperties: {
                    rowCount: 1000,
                    columnCount: 10
                  }
                }
              }
            }
          ]
        }
      });

      // í—¤ë” ì¶”ê°€
      await sheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ì˜ˆì‚°_ì‚¬ìš©ìì‹œíŠ¸ê´€ë¦¬!A1:G1',
        valueInputOption: 'RAW',
        resource: {
          values: [['ì‚¬ìš©ìID', 'ì‹œíŠ¸ID', 'ì‹œíŠ¸ëª…', 'ìƒì„±ì¼ì‹œ', 'ìƒì„±ì', 'ëŒ€ìƒì›”', 'ì„ íƒëœì •ì±…ê·¸ë£¹']]
        }
      });

      console.log('âœ… [ì‹œíŠ¸ê´€ë¦¬] ì˜ˆì‚°_ì‚¬ìš©ìì‹œíŠ¸ê´€ë¦¬ ì‹œíŠ¸ ìƒì„± ë° í—¤ë” ì„¤ì • ì™„ë£Œ');
    }
  } catch (error) {
    console.error('ì˜ˆì‚°_ì‚¬ìš©ìì‹œíŠ¸ê´€ë¦¬ ì‹œíŠ¸ í™•ì¸/ìƒì„± ì‹¤íŒ¨:', error);
  }
}

// ìƒˆë¡œìš´ ì•ˆì „í•œ í°í´ê°œí†µë°ì´í„° ì—…ë°ì´íŠ¸ API
app.post('/api/budget/user-sheets/:sheetId/update-usage-safe', async (req, res) => {
  console.log('ğŸ”’ [SAFE-UPDATE] POST /api/budget/user-sheets/:sheetId/update-usage-safe í˜¸ì¶œë¨!');
  try {
    const { sheetId } = req.params;
    const { selectedPolicyGroups, dateRange, userName, budgetType } = req.body;

    if (!selectedPolicyGroups || !Array.isArray(selectedPolicyGroups)) {
      return res.status(400).json({ error: 'ì„ íƒëœ ì •ì±…ê·¸ë£¹ì´ í•„ìš”í•©ë‹ˆë‹¤.' });
    }

    // ì‚¬ìš©ì ì •ë³´ ì„¤ì •
    const userInfo = {
      userName: userName || 'Unknown',
      budgetType: budgetType || 'â… ',
      selectedPolicyGroups
    };

    console.log(`ğŸ”’ [SAFE-UPDATE] ì²˜ë¦¬ ì‹œì‘: ì‚¬ìš©ì=${userInfo.userName}, íƒ€ì…=${userInfo.budgetType}`);

    // 1. ê¸°ì¡´ calculateUsageBudget í•¨ìˆ˜ë¡œ ê³„ì‚° ìˆ˜í–‰ (ì‹¤ì œ ì—…ë°ì´íŠ¸ëŠ” í•˜ì§€ ì•ŠìŒ)
    const calculatedResult = await calculateUsageBudgetDryRun(sheetId, selectedPolicyGroups, dateRange, userName, budgetType);

    // 2. PhoneklDataManagerë¥¼ ì‚¬ìš©í•˜ì—¬ ì•ˆì „í•œ ì—…ë°ì´íŠ¸
    const updateResult = await phoneklDataManager.safeUpdateData(
      sheetId,
      budgetType,
      calculatedResult.dataMapping,
      userInfo,
      dateRange
    );

    console.log(`âœ… [SAFE-UPDATE] ì™„ë£Œ: ${updateResult.message}`);

    // ê³„ì‚° ê²°ê³¼ë¥¼ ë©”íƒ€ë°ì´í„°ì— ëˆ„ì  ì €ì¥ (Oì—´~Xì—´)
    try {
      console.log(`ğŸ’¾ [SAFE-UPDATE] ë©”íƒ€ë°ì´í„° ëˆ„ì  ì €ì¥ ì‹œì‘`);

      const sheets = google.sheets({ version: 'v4', auth });

      // ì‚¬ìš©ì ìê²© ì •ë³´ë¥¼ ëŒ€ë¦¬ì ì•„ì´ë””ê´€ë¦¬ì—ì„œ ê°€ì ¸ì˜¤ê¸°
      let userQualification = 'ì´ì‚¬'; // ê¸°ë³¸ê°’
      try {
        // ì‚¬ìš©ìëª…ì—ì„œ ê´„í˜¸ì™€ ê³µë°±ì„ ì™„ì „íˆ ì œê±°
        const baseUserName = userName.replace(/\([^)]+\)/g, '').trim();
        console.log(`ğŸ” [SAFE-UPDATE] ì‚¬ìš©ìëª… ì •ë¦¬: "${userName}" â†’ "${baseUserName}"`);

        const agentValues = await getSheetValues(AGENT_SHEET_NAME);
        if (agentValues) {
          const agentRows = agentValues.slice(1);
          const userAgent = agentRows.find(row => row[0] === baseUserName); // Aì—´: ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰
          if (userAgent) {
            userQualification = userAgent[1] || 'ì´ì‚¬'; // Bì—´: ìê²©
            console.log(`ğŸ“‹ [SAFE-UPDATE] ì‚¬ìš©ì ìê²© í™•ì¸: ${baseUserName} â†’ ${userQualification}`);
          } else {
            console.log(`âš ï¸ [SAFE-UPDATE] ëŒ€ë¦¬ì ì•„ì´ë””ê´€ë¦¬ì—ì„œ ${baseUserName} ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ ê¸°ë³¸ê°’ 'ì´ì‚¬' ì‚¬ìš©`);
          }
        }
      } catch (error) {
        console.error('ì‚¬ìš©ì ìê²© ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error);
      }

      // ì‚¬ìš©ì ì‹œíŠ¸ ì´ë¦„ ê°€ì ¸ì˜¤ê¸° (ë™ì  ìê²© ì‚¬ìš©, ì¤‘ë³µ ë°©ì§€)
      const cleanUserName = userName.replace(/\([^)]+\)/g, '').trim(); // ê´„í˜¸ ì™„ì „ ì œê±°
      const userSheetName = `ì•¡ë©´_${cleanUserName}(${budgetType || 'â… '}) (${userQualification})`;
      console.log(`ğŸ“ [SAFE-UPDATE] ì‹œíŠ¸ëª… ìƒì„±: "${userSheetName}"`);

      // ê¸°ì¡´ ë©”íƒ€ë°ì´í„° ì½ê¸° (Oì—´~Xì—´)
      let existingMetadata = [];
      try {
        const metadataResponse = await sheets.spreadsheets.values.get({
          spreadsheetId: sheetId,
          range: `${userSheetName}!O:X`
        });
        existingMetadata = metadataResponse.data.values || [];
      } catch (error) {
        console.log(`ğŸ“‹ [SAFE-UPDATE] ê¸°ì¡´ ë©”íƒ€ë°ì´í„° ì—†ìŒ, ìƒˆë¡œ ìƒì„±`);
      }

      // í—¤ë” ì„¤ì • (Oì—´~Xì—´)
      const metadataHeader = [
        'ì €ì¥ì¼ì‹œ', 'ì ‘ìˆ˜ì¼ë²”ìœ„', 'ê°œí†µì¼ë²”ìœ„', 'ì ‘ìˆ˜ì¼ì ìš©ì—¬ë¶€',
        'ê³„ì‚°ì¼ì‹œ', 'ê³„ì‚°ì', 'ì •ì±…ê·¸ë£¹', 'ì”ì•¡', 'í™•ë³´', 'ì‚¬ìš©'
      ];

      // ì‚¬ìš©ìì‹œíŠ¸ì˜ Aì—´(ì ‘ìˆ˜ì‹œì‘ì¼), Bì—´(ì ‘ìˆ˜ì¢…ë£Œì¼) ë°ì´í„° ì½ê¸°
      let receiptDateRange = 'ë¯¸ì„¤ì •';
      let receiptDateApplied = 'ë¯¸ì ìš©';

      try {
        const userSheetData = await sheets.spreadsheets.values.get({
          spreadsheetId: sheetId,
          range: `${userSheetName}!A:B`
        });

        const userSheetRows = userSheetData.data.values || [];
        if (userSheetRows.length > 1) { // í—¤ë” ì œì™¸í•˜ê³  ë°ì´í„° í–‰ í™•ì¸
          // ì²« ë²ˆì§¸ ë°ì´í„° í–‰ (í—¤ë” ë‹¤ìŒ í–‰)ì˜ Aì—´(ì ‘ìˆ˜ì‹œì‘ì¼), Bì—´(ì ‘ìˆ˜ì¢…ë£Œì¼) í™•ì¸
          const firstDataRow = userSheetRows[1]; // ì¸ë±ìŠ¤ 1 = ë‘ ë²ˆì§¸ í–‰ (í—¤ë” ì œì™¸)
          if (firstDataRow && firstDataRow[0] && firstDataRow[1]) {
            // ì‹¤ì œ ë‚ ì§œ ë°ì´í„°ì¸ì§€ í™•ì¸ (í—¤ë” í…ìŠ¤íŠ¸ê°€ ì•„ë‹Œ)
            const startDate = firstDataRow[0];
            const endDate = firstDataRow[1];

            // í—¤ë” í…ìŠ¤íŠ¸ê°€ ì•„ë‹Œ ì‹¤ì œ ë‚ ì§œ ë°ì´í„°ì¸ ê²½ìš°ë§Œ ì ìš©
            if (startDate !== 'ì ‘ìˆ˜ì‹œì‘ì¼' && endDate !== 'ì ‘ìˆ˜ì¢…ë£Œì¼' &&
              startDate !== 'ì‹œì‘ì¼' && endDate !== 'ì¢…ë£Œì¼' &&
              startDate.trim() !== '' && endDate.trim() !== '') {
              receiptDateRange = `${startDate} ~ ${endDate}`;
              receiptDateApplied = 'ì ìš©';
              console.log(`ğŸ“… [SAFE-UPDATE] ì‚¬ìš©ìì‹œíŠ¸ ì ‘ìˆ˜ì¼ ë²”ìœ„ í™•ì¸: ${receiptDateRange}`);
            } else {
              console.log(`âš ï¸ [SAFE-UPDATE] ì‚¬ìš©ìì‹œíŠ¸ ì²« ë²ˆì§¸ í–‰ì´ í—¤ë”ì…ë‹ˆë‹¤: ${startDate}, ${endDate}`);
            }
          }
        }
      } catch (error) {
        console.log(`âš ï¸ [SAFE-UPDATE] ì‚¬ìš©ìì‹œíŠ¸ ì ‘ìˆ˜ì¼ ë°ì´í„° ì½ê¸° ì‹¤íŒ¨:`, error.message);
      }

      // ìƒˆ ì •ì±… ë°ì´í„° í–‰ ìƒì„±
      const newPolicyRow = [
        new Date().toISOString(),           // Oì—´: ì €ì¥ì¼ì‹œ
        receiptDateRange,                   // Pì—´: ì ‘ìˆ˜ì¼ë²”ìœ„ (ì‚¬ìš©ìì‹œíŠ¸ ë°ì´í„° ê¸°ë°˜)
        `${dateRange.startDate} ~ ${dateRange.endDate}`, // Qì—´: ê°œí†µì¼ë²”ìœ„
        receiptDateApplied,                 // Rì—´: ì ‘ìˆ˜ì¼ì ìš©ì—¬ë¶€ (ì‚¬ìš©ìì‹œíŠ¸ ë°ì´í„° ê¸°ë°˜)
        new Date().toISOString(),           // Sì—´: ê³„ì‚°ì¼ì‹œ
        userName,                           // Tì—´: ê³„ì‚°ì
        selectedPolicyGroups.join(','),     // Uì—´: ì •ì±…ê·¸ë£¹
        calculatedResult.totalRemainingBudget, // Vì—´: ì”ì•¡
        calculatedResult.totalSecuredBudget,   // Wì—´: í™•ë³´
        calculatedResult.totalUsedBudget       // Xì—´: ì‚¬ìš©
      ];

      // ë©”íƒ€ë°ì´í„° ì €ì¥ - í—¤ë”ê°€ ì—†ìœ¼ë©´ í—¤ë” ì¶”ê°€, ìƒˆ ì •ì±…ì€ appendë¡œ ì¶”ê°€

      // í—¤ë”ê°€ ì—†ìœ¼ë©´ í—¤ë” ì¶”ê°€
      if (existingMetadata.length === 0) {
        await sheets.spreadsheets.values.update({
          spreadsheetId: sheetId,
          range: `${userSheetName}!O1:X1`,
          valueInputOption: 'RAW',
          resource: {
            values: [metadataHeader]
          }
        });
        console.log(`ğŸ“ [SAFE-UPDATE] ${userSheetName}: ë©”íƒ€ë°ì´í„° í—¤ë” ìƒì„± ì™„ë£Œ`);
      }

      // ê¸°ì¡´ ë©”íƒ€ë°ì´í„° ë°±ì—… (ë¬¸ì œ ì§„ë‹¨ìš©)
      console.log(`ğŸ’¾ [SAFE-UPDATE] ê¸°ì¡´ ë©”íƒ€ë°ì´í„° ë°±ì—…:`, existingMetadata);

      // ìƒˆ ì •ì±… ë°ì´í„°ë¥¼ appendë¡œ ì¶”ê°€ (ê¸°ì¡´ ë°ì´í„° ë®ì–´ì“°ì§€ ì•ŠìŒ)
      console.log(`ğŸ“ [SAFE-UPDATE] ${userSheetName}: ìƒˆ ì •ì±… ë°ì´í„° appendë¡œ ì¶”ê°€`);
      await sheets.spreadsheets.values.append({
        spreadsheetId: sheetId,
        range: `${userSheetName}!O:X`,
        valueInputOption: 'RAW',
        resource: {
          values: [newPolicyRow]
        }
      });
      console.log(`âœ… [SAFE-UPDATE] ë©”íƒ€ë°ì´í„° ìƒˆ ì •ì±… ì¶”ê°€ ì™„ë£Œ (${existingMetadata.length + 1}ë²ˆì§¸ ì •ì±…)`);

      // ì €ì¥ í›„ ê²€ì¦ (ë¬¸ì œ ì§„ë‹¨ìš©)
      try {
        const verificationResponse = await sheets.spreadsheets.values.get({
          spreadsheetId: sheetId,
          range: `${userSheetName}!O:X`
        });
        const finalMetadata = verificationResponse.data.values || [];
        console.log(`ğŸ” [SAFE-UPDATE] ì €ì¥ í›„ ë©”íƒ€ë°ì´í„° ê²€ì¦: ${finalMetadata.length}í–‰`);
        console.log(`ğŸ“Š [SAFE-UPDATE] ìµœì¢… ë©”íƒ€ë°ì´í„°:`, finalMetadata);
      } catch (verificationError) {
        console.log(`âš ï¸ [SAFE-UPDATE] ë©”íƒ€ë°ì´í„° ê²€ì¦ ì‹¤íŒ¨:`, verificationError.message);
      }

      // ë©”íƒ€ë°ì´í„° ì •ë¦¬ ë¡œì§ ì œê±° - ê¸°ì¡´ ì •ì±…ì„ ë³´ì¡´í•˜ê³  ìƒˆ ì •ì±…ë§Œ ì¶”ê°€
      console.log(`âœ… [SAFE-UPDATE] ${userSheetName}: ë©”íƒ€ë°ì´í„° ì •ë¦¬ ë¡œì§ ì œê±°, ê¸°ì¡´ ì •ì±… ë³´ì¡´`);
    } catch (metadataError) {
      console.error(`âŒ [SAFE-UPDATE] ë©”íƒ€ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:`, metadataError.message);
    }

    res.json({
      message: 'ì•¡ë©´ì˜ˆì‚°ì´ ì•ˆì „í•˜ê²Œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.',
      result: updateResult,
      calculationSummary: {
        totalSecuredBudget: calculatedResult.totalSecuredBudget,
        totalUsedBudget: calculatedResult.totalUsedBudget,
        totalRemainingBudget: calculatedResult.totalRemainingBudget,
        processedRows: calculatedResult.processedRows,
        matchedItems: calculatedResult.matchedItems
      }
    });

  } catch (error) {
    console.error('[SAFE-UPDATE] ì•ˆì „ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'ì•ˆì „ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message });
  }
});

// ê¸°ì¡´ API (ë ˆê±°ì‹œ)
app.post('/api/budget/user-sheets/:sheetId/update-usage', async (req, res) => {
  try {
    const { sheetId } = req.params;
    const { selectedPolicyGroups, dateRange, userName, budgetType } = req.body;

    if (!selectedPolicyGroups || !Array.isArray(selectedPolicyGroups)) {
      return res.status(400).json({ error: 'ì„ íƒëœ ì •ì±…ê·¸ë£¹ì´ í•„ìš”í•©ë‹ˆë‹¤.' });
    }

    const sheets = google.sheets({ version: 'v4', auth });

    // ë¨¼ì € ì•¡ë©´ì˜ˆì‚° Cì—´ ì—…ë°ì´íŠ¸
    const calculateResult = await calculateUsageBudget(sheetId, selectedPolicyGroups, dateRange, userName, budgetType);

    // ì‚¬ìš©ì ì‹œíŠ¸ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const userSheetData = await sheets.spreadsheets.values.get({
      spreadsheetId: sheetId,
      range: 'A2:L', // ì‚¬ìš©ì ì‹œíŠ¸ ë°ì´í„° ë²”ìœ„ (12ê°œ ì»¬ëŸ¼)
    });

    const userSheetRows = userSheetData.data.values || [];

    // ì•¡ë©´ì˜ˆì‚° íƒ€ì…ì— ë”°ë¥¸ ì•¡ë©´ì˜ˆì‚° ë§¤í•‘ ì»¬ëŸ¼ ê²°ì •
    const currentBudgetType = budgetType || 'â… ';
    let phoneklColumns = {};

    if (currentBudgetType === 'â… ') {
      // ì•¡ë©´ì˜ˆì‚°(â… ): Lì—´(ì˜ˆì‚°ì”ì•¡), Mì—´(í™•ë³´ì˜ˆì‚°), Nì—´(ì‚¬ìš©ì˜ˆì‚°)
      phoneklColumns = {
        remainingBudget: 'L', // ì˜ˆì‚°ì”ì•¡
        securedBudget: 'M',   // í™•ë³´ì˜ˆì‚°
        usedBudget: 'N'       // ì‚¬ìš©ì˜ˆì‚°
      };
    } else if (currentBudgetType === 'â…¡') {
      // ì•¡ë©´ì˜ˆì‚°(â…¡): Iì—´(ì˜ˆì‚°ì”ì•¡), Jì—´(í™•ë³´ì˜ˆì‚°), Kì—´(ì‚¬ìš©ì˜ˆì‚°)
      phoneklColumns = {
        remainingBudget: 'I', // ì˜ˆì‚°ì”ì•¡
        securedBudget: 'J',   // í™•ë³´ì˜ˆì‚°
        usedBudget: 'K'       // ì‚¬ìš©ì˜ˆì‚°
      };
    }

    // ì•¡ë©´ì˜ˆì‚°ì—ì„œ ê³„ì‚°ëœ ë°ì´í„°ë¥¼ ì‚¬ìš©ì ì‹œíŠ¸ì˜ ì‚¬ìš©ì˜ˆì‚°ì— ë°˜ì˜
    const updateRequests = [];

    userSheetRows.forEach((row, index) => {
      if (row.length >= 12) {
        const armyType = row[6]; // êµ° (Gì—´ - ê¸°ì¡´ Dì—´ì—ì„œ 3ì—´ ë°€ë¦¼)
        const categoryType = row[7]; // ìœ í˜• (Hì—´ - ê¸°ì¡´ Eì—´ì—ì„œ 3ì—´ ë°€ë¦¼)

        // ì•¡ë©´ì˜ˆì‚°ì—ì„œ í•´ë‹¹ êµ°/ìœ í˜•ì— ë§ëŠ” ì‚¬ìš©ì˜ˆì‚° ì°¾ê¸°
        const matchingData = calculateResult.calculatedData.find(data =>
          data.armyType === armyType && data.categoryType === categoryType
        );

        if (matchingData) {
          // ì‚¬ìš©ì˜ˆì‚° ì—…ë°ì´íŠ¸ (Jì—´ - ê¸°ì¡´ Fì—´ì—ì„œ 3ì—´ ë°€ë¦¼)
          updateRequests.push({
            range: `J${index + 2}`,
            values: [[matchingData.budgetValue]]
          });

          // ì”ì•¡ ì—…ë°ì´íŠ¸ (Kì—´ - ê¸°ì¡´ Gì—´ì—ì„œ 3ì—´ ë°€ë¦¼) - ì˜ˆì‚°íƒ€ì…ì— ë”°ë¥¸ í™•ë³´ì˜ˆì‚°
          const defaultSecuredBudget = budgetType === 'â…¡' ? 0 : 40000;
          const securedBudget = defaultSecuredBudget;
          const remainingBudget = securedBudget - matchingData.budgetValue;
          updateRequests.push({
            range: `K${index + 2}`,
            values: [[remainingBudget]]
          });

          console.log(`ğŸ’¾ [ì‚¬ìš©ìì‹œíŠ¸] Row ${index + 2} ì—…ë°ì´íŠ¸: ì‚¬ìš©ì˜ˆì‚°=${matchingData.budgetValue}, ì”ì•¡=${remainingBudget}`);
        }
      }
    });

    // ì‚¬ìš©ì ì‹œíŠ¸ ì—…ë°ì´íŠ¸
    if (updateRequests.length > 0) {
      console.log(`ğŸš€ [ì‚¬ìš©ìì‹œíŠ¸] ë°°ì¹˜ ì—…ë°ì´íŠ¸ ì‹¤í–‰: ${updateRequests.length}ê°œ ì…€`);

      try {
        await sheets.spreadsheets.values.batchUpdate({
          spreadsheetId: sheetId,
          resource: {
            valueInputOption: 'RAW',
            data: updateRequests
          }
        });

        console.log(`âœ… [ì‚¬ìš©ìì‹œíŠ¸] ë°°ì¹˜ ì—…ë°ì´íŠ¸ ì„±ê³µ: ${updateRequests.length}ê°œ ì…€`);
      } catch (error) {
        console.error(`âŒ [ì‚¬ìš©ìì‹œíŠ¸] ë°°ì¹˜ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:`, error);
        throw error;
      }
    }

    // ê³„ì‚° ê²°ê³¼ë¥¼ ë©”íƒ€ë°ì´í„°ì— ëˆ„ì  ì €ì¥ (Oì—´~Xì—´)
    try {
      console.log(`ğŸ’¾ [updateUserSheetUsage] ë©”íƒ€ë°ì´í„° ëˆ„ì  ì €ì¥ ì‹œì‘`);

      // ì‚¬ìš©ì ìê²© ì •ë³´ë¥¼ ëŒ€ë¦¬ì ì•„ì´ë””ê´€ë¦¬ì—ì„œ ê°€ì ¸ì˜¤ê¸°
      let userQualification = 'ì´ì‚¬'; // ê¸°ë³¸ê°’
      try {
        // ì‚¬ìš©ìëª…ì—ì„œ ê´„í˜¸ì™€ ê³µë°±ì„ ì™„ì „íˆ ì œê±°
        const baseUserName = userName.replace(/\([^)]+\)/g, '').trim();
        console.log(`ğŸ” [updateUserSheetUsage] ì‚¬ìš©ìëª… ì •ë¦¬: "${userName}" â†’ "${baseUserName}"`);

        const agentValues = await getSheetValues(AGENT_SHEET_NAME);
        if (agentValues) {
          const agentRows = agentValues.slice(1);
          const userAgent = agentRows.find(row => row[0] === baseUserName); // Aì—´: ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰
          if (userAgent) {
            userQualification = userAgent[1] || 'ì´ì‚¬'; // Bì—´: ìê²©
            console.log(`ğŸ“‹ [updateUserSheetUsage] ì‚¬ìš©ì ìê²© í™•ì¸: ${baseUserName} â†’ ${userQualification}`);
          } else {
            console.log(`âš ï¸ [updateUserSheetUsage] ëŒ€ë¦¬ì ì•„ì´ë””ê´€ë¦¬ì—ì„œ ${baseUserName} ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ ê¸°ë³¸ê°’ 'ì´ì‚¬' ì‚¬ìš©`);
          }
        }
      } catch (error) {
        console.error('ì‚¬ìš©ì ìê²© ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error);
      }

      // ì‚¬ìš©ì ì‹œíŠ¸ ì´ë¦„ ê°€ì ¸ì˜¤ê¸° (ë™ì  ìê²© ì‚¬ìš©, ì¤‘ë³µ ë°©ì§€)
      const cleanUserName = userName.replace(/\([^)]+\)/g, '').trim(); // ê´„í˜¸ ì™„ì „ ì œê±°
      const userSheetName = `ì•¡ë©´_${cleanUserName}(${budgetType || 'â… '}) (${userQualification})`;
      console.log(`ğŸ“ [updateUserSheetUsage] ì‹œíŠ¸ëª… ìƒì„±: "${userSheetName}"`);

      // ê¸°ì¡´ ë©”íƒ€ë°ì´í„° ì½ê¸° (Oì—´~Xì—´)
      let existingMetadata = [];
      try {
        const metadataResponse = await sheets.spreadsheets.values.get({
          spreadsheetId: sheetId,
          range: `${userSheetName}!O:X`
        });
        existingMetadata = metadataResponse.data.values || [];
      } catch (error) {
        console.log(`ğŸ“‹ [updateUserSheetUsage] ê¸°ì¡´ ë©”íƒ€ë°ì´í„° ì—†ìŒ, ìƒˆë¡œ ìƒì„±`);
      }

      // í—¤ë” ì„¤ì • (Oì—´~Xì—´)
      const metadataHeader = [
        'ì €ì¥ì¼ì‹œ', 'ì ‘ìˆ˜ì¼ë²”ìœ„', 'ê°œí†µì¼ë²”ìœ„', 'ì ‘ìˆ˜ì¼ì ìš©ì—¬ë¶€',
        'ê³„ì‚°ì¼ì‹œ', 'ê³„ì‚°ì', 'ì •ì±…ê·¸ë£¹', 'ì”ì•¡', 'í™•ë³´', 'ì‚¬ìš©'
      ];

      // ì‚¬ìš©ìì‹œíŠ¸ì˜ Aì—´(ì ‘ìˆ˜ì‹œì‘ì¼), Bì—´(ì ‘ìˆ˜ì¢…ë£Œì¼) ë°ì´í„° ì½ê¸°
      let receiptDateRange = 'ë¯¸ì„¤ì •';
      let receiptDateApplied = 'ë¯¸ì ìš©';

      try {
        const userSheetData = await sheets.spreadsheets.values.get({
          spreadsheetId: sheetId,
          range: `${userSheetName}!A:B`
        });

        const userSheetRows = userSheetData.data.values || [];
        if (userSheetRows.length > 1) { // í—¤ë” ì œì™¸í•˜ê³  ë°ì´í„° í–‰ í™•ì¸
          // ì²« ë²ˆì§¸ ë°ì´í„° í–‰ (í—¤ë” ë‹¤ìŒ í–‰)ì˜ Aì—´(ì ‘ìˆ˜ì‹œì‘ì¼), Bì—´(ì ‘ìˆ˜ì¢…ë£Œì¼) í™•ì¸
          const firstDataRow = userSheetRows[1]; // ì¸ë±ìŠ¤ 1 = ë‘ ë²ˆì§¸ í–‰ (í—¤ë” ì œì™¸)
          if (firstDataRow && firstDataRow[0] && firstDataRow[1]) {
            // ì‹¤ì œ ë‚ ì§œ ë°ì´í„°ì¸ì§€ í™•ì¸ (í—¤ë” í…ìŠ¤íŠ¸ê°€ ì•„ë‹Œ)
            const startDate = firstDataRow[0];
            const endDate = firstDataRow[1];

            // í—¤ë” í…ìŠ¤íŠ¸ê°€ ì•„ë‹Œ ì‹¤ì œ ë‚ ì§œ ë°ì´í„°ì¸ ê²½ìš°ë§Œ ì ìš©
            if (startDate !== 'ì ‘ìˆ˜ì‹œì‘ì¼' && endDate !== 'ì ‘ìˆ˜ì¢…ë£Œì¼' &&
              startDate !== 'ì‹œì‘ì¼' && endDate !== 'ì¢…ë£Œì¼' &&
              startDate.trim() !== '' && endDate.trim() !== '') {
              receiptDateRange = `${startDate} ~ ${endDate}`;
              receiptDateApplied = 'ì ìš©';
              console.log(`ğŸ“… [updateUserSheetUsage] ì‚¬ìš©ìì‹œíŠ¸ ì ‘ìˆ˜ì¼ ë²”ìœ„ í™•ì¸: ${receiptDateRange}`);
            } else {
              console.log(`âš ï¸ [updateUserSheetUsage] ì‚¬ìš©ìì‹œíŠ¸ ì²« ë²ˆì§¸ í–‰ì´ í—¤ë”ì…ë‹ˆë‹¤: ${startDate}, ${endDate}`);
            }
          }
        }
      } catch (error) {
        console.log(`âš ï¸ [updateUserSheetUsage] ì‚¬ìš©ìì‹œíŠ¸ ì ‘ìˆ˜ì¼ ë°ì´í„° ì½ê¸° ì‹¤íŒ¨:`, error.message);
      }

      // ìƒˆ ì •ì±… ë°ì´í„° í–‰ ìƒì„±
      const newPolicyRow = [
        new Date().toISOString(),           // Oì—´: ì €ì¥ì¼ì‹œ
        receiptDateRange,                   // Pì—´: ì ‘ìˆ˜ì¼ë²”ìœ„ (ì‚¬ìš©ìì‹œíŠ¸ ë°ì´í„° ê¸°ë°˜)
        `${dateRange.startDate} ~ ${dateRange.endDate}`, // Qì—´: ê°œí†µì¼ë²”ìœ„
        receiptDateApplied,                 // Rì—´: ì ‘ìˆ˜ì¼ì ìš©ì—¬ë¶€ (ì‚¬ìš©ìì‹œíŠ¸ ë°ì´í„° ê¸°ë°˜)
        new Date().toISOString(),           // Sì—´: ê³„ì‚°ì¼ì‹œ
        userName,                           // Tì—´: ê³„ì‚°ì
        selectedPolicyGroups.join(','),     // Uì—´: ì •ì±…ê·¸ë£¹
        calculateResult.totalRemainingBudget, // Vì—´: ì”ì•¡
        calculateResult.totalSecuredBudget,   // Wì—´: í™•ë³´
        calculateResult.totalUsedBudget       // Xì—´: ì‚¬ìš©
      ];

      // ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸ (ê¸°ì¡´ ë°ì´í„° ìœ ì§€í•˜ê³  ìƒˆ í–‰ ì¶”ê°€)
      const metadataUpdateRequests = [];

      // í—¤ë”ê°€ ì—†ìœ¼ë©´ í—¤ë” ì¶”ê°€
      if (existingMetadata.length === 0) {
        metadataUpdateRequests.push({
          range: `${userSheetName}!O1:X1`,
          values: [metadataHeader]
        });
      }

      // ìƒˆ ì •ì±… ë°ì´í„° í–‰ ì¶”ê°€
      metadataUpdateRequests.push({
        range: `${userSheetName}!O${existingMetadata.length + 2}:X${existingMetadata.length + 2}`,
        values: [newPolicyRow]
      });

      // ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸ ì‹¤í–‰
      if (metadataUpdateRequests.length > 0) {
        await sheets.spreadsheets.values.batchUpdate({
          spreadsheetId: sheetId,
          resource: {
            valueInputOption: 'RAW',
            data: metadataUpdateRequests
          }
        });
        console.log(`âœ… [updateUserSheetUsage] ë©”íƒ€ë°ì´í„° ëˆ„ì  ì €ì¥ ì™„ë£Œ (${existingMetadata.length + 1}ë²ˆì§¸ ì •ì±…)`);
      }
    } catch (metadataError) {
      console.error(`âŒ [updateUserSheetUsage] ë©”íƒ€ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:`, metadataError.message);
    }

    res.json({
      message: 'ì‚¬ìš©ì ì‹œíŠ¸ì˜ ì‚¬ìš©ì˜ˆì‚°ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.',
      updatedRows: updateRequests.length,
      totalUsedBudget: calculateResult.totalUsedBudget
    });

  } catch (error) {
    console.error('ì‚¬ìš©ì ì‹œíŠ¸ ì‚¬ìš©ì˜ˆì‚° ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'ì‚¬ìš©ì ì‹œíŠ¸ ì‚¬ìš©ì˜ˆì‚° ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' });
  }
});

// ìƒˆë¡œìš´ ì‚¬ìš©ì ì‹œíŠ¸ ì¡°íšŒ API (UserSheetManager ì‚¬ìš©) - ê³„ì‚° ë¡œì§ ì œê±°
app.get('/api/budget/user-sheets-v2', async (req, res) => {
  // CORS í—¤ë” ëª…ì‹œì  ì„¤ì •
  res.header('Access-Control-Allow-Origin', 'https://vipmobile.vercel.app');
  res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
  res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With, Origin, Accept');
  res.header('Access-Control-Allow-Credentials', 'true');

  console.log('ğŸ” [NEW-API] GET /api/budget/user-sheets-v2 í˜¸ì¶œë¨!', req.query);
  try {
    const { userId, targetMonth, showAllUsers, budgetType } = req.query;

    await userSheetManager.ensureSheetExists();

    const options = {
      userId,
      targetMonth,
      showAllUsers: showAllUsers === 'true',
      budgetType: budgetType || null
    };

    const userSheets = await userSheetManager.getUserSheets(options);

    // ë””ë²„ê¹…: ì¤‘ë³µ í™•ì¸
    console.log(`ğŸ” [NEW-API] userSheets ë°°ì—´ ë‚´ìš©:`, userSheets.map(sheet => ({
      sheetName: sheet.sheetName,
      sheetId: sheet.sheetId,
      uuid: sheet.uuid
    })));

    // ì¤‘ë³µ ì œê±° (sheetId + sheetName ê¸°ì¤€) - ê° ì‚¬ìš©ìë³„ ì‹œíŠ¸ë¥¼ ê°œë³„ì ìœ¼ë¡œ í‘œì‹œ
    const uniqueSheets = userSheets.filter((sheet, index, self) =>
      index === self.findIndex(s => s.sheetId === sheet.sheetId && s.sheetName === sheet.sheetName)
    );

    console.log(`ğŸ” [NEW-API] ì¤‘ë³µ ì œê±° í›„: ${uniqueSheets.length}ê°œ`);

    // ê° ì‹œíŠ¸ì˜ ìš”ì•½ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const enrichedSheets = await Promise.all(uniqueSheets.map(async (sheet) => {
      let summary = {
        totalSecuredBudget: 0,
        totalUsedBudget: 0,
        totalRemainingBudget: 0,
        itemCount: 0,
        lastUpdated: sheet.createdAt,
        dateRange: '',
        applyReceiptDate: false
      };

      try {
        const sheets_api = google.sheets({ version: 'v4', auth });

        // ì‹œíŠ¸ì˜ ì˜ˆì‚° ë°ì´í„° ìš”ì•½ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const budgetTypeMatch = sheet.sheetName.match(/\(([Iâ… â…¡]+)\)/);
        const budgetType = budgetTypeMatch ? budgetTypeMatch[1] : 'â… ';

        // ì‚¬ìš©ì ì‹œíŠ¸ ë©”íƒ€ë°ì´í„°ì—ì„œ ê³„ì‚° ê²°ê³¼ ë¶ˆëŸ¬ì˜¤ê¸° (Oì—´~Xì—´)
        console.log(`ğŸ” [${sheet.sheetName}] ë©”íƒ€ë°ì´í„°ì—ì„œ ê³„ì‚° ê²°ê³¼ ë¶ˆëŸ¬ì˜¤ê¸° ì‹œì‘!`);

        try {
          // ì‚¬ìš©ì ì‹œíŠ¸ ë©”íƒ€ë°ì´í„°ì—ì„œ ê³„ì‚° ê²°ê³¼ ê°€ì ¸ì˜¤ê¸° (Oì—´~Xì—´)
          const metadataResponse = await sheets_api.spreadsheets.values.get({
            spreadsheetId: sheet.sheetId,
            range: `${sheet.sheetName}!O:X`
          });

          const metadata = metadataResponse.data.values || [];
          console.log(`ğŸ“Š [${sheet.sheetName}] ë©”íƒ€ë°ì´í„° ë°ì´í„° ë¡œë“œ: ${metadata.length}í–‰`);

          if (metadata.length > 1) { // í—¤ë” 1í–‰ ì œì™¸
            let totalRemainingBudget = 0;
            let totalSecuredBudget = 0;
            let totalUsedBudget = 0;
            let policyCount = 0;

            // ë©”íƒ€ë°ì´í„°ì˜ ê° ì •ì±… í–‰ì—ì„œ ì˜ˆì‚° ë°ì´í„° í•©ê³„ (ë¹ˆ í–‰ ì œì™¸)
            const validRows = metadata.slice(1).filter(row =>
              row.length >= 10 && row.some(cell => cell !== '' && cell !== null && cell !== undefined)
            );

            const policies = [];
            // ëª¨ë“  ì •ì±… í–‰ì„ ì²˜ë¦¬

            validRows.forEach((row, index) => {
              if (row.length >= 10) {
                // ê° ì •ì±…ë³„ë¡œ ê°œë³„ ì‹œíŠ¸ì—ì„œ ì‹¤ì œ ê°’ì„ ì½ì–´ì˜¤ê¸°
                // Vì—´: ì”ì•¡, Wì—´: í™•ë³´, Xì—´: ì‚¬ìš© (ë©”íƒ€ë°ì´í„°ì— ì €ì¥ëœ ê°’)
                const remainingBudget = parseFloat(row[7]) || 0; // Vì—´ (0-based index 7)
                const securedBudget = parseFloat(row[8]) || 0;   // Wì—´ (0-based index 8)
                const usedBudget = parseFloat(row[9]) || 0;      // Xì—´ (0-based index 9)

                // ë©”íƒ€ë°ì´í„° ë¶€ê°€ì •ë³´ (í‘œì‹œìš©)
                const savedAt = row[0] || '';
                const receiptDateRange = row[1] || '';
                const activationDateRange = row[2] || '';
                const receiptApplied = row[3] || '';
                const calculatedAt = row[4] || '';
                const calculator = row[5] || '';
                const policyGroups = row[6] || '';

                // ê° ì •ì±…ì„ ê°œë³„ì ìœ¼ë¡œ ì²˜ë¦¬ (ì¤‘ë³µ ì œê±°í•˜ì§€ ì•ŠìŒ)
                totalRemainingBudget += remainingBudget;
                totalSecuredBudget += securedBudget;
                totalUsedBudget += usedBudget;
                policyCount++;

                // ê° ì •ì±… ë°ì´í„°ë¥¼ policies ë°°ì—´ì— ì¶”ê°€
                policies.push({
                  securedBudget,
                  usedBudget,
                  remainingBudget,
                  savedAt,
                  receiptDateRange,
                  activationDateRange,
                  receiptApplied,
                  calculatedAt,
                  calculator,
                  policyGroups
                });

                console.log(`ğŸ“‹ [${sheet.sheetName}] ì •ì±… ${policyCount}: ì”ì•¡=${remainingBudget}, í™•ë³´=${securedBudget}, ì‚¬ìš©=${usedBudget}`);
              }
            });

            console.log(`ğŸ“Š [${sheet.sheetName}] ë©”íƒ€ë°ì´í„° ê³„ì‚° ì™„ë£Œ: ì”ì•¡=${totalRemainingBudget}, í™•ë³´=${totalSecuredBudget}, ì‚¬ìš©=${totalUsedBudget}, ì •ì±…ìˆ˜=${policyCount}`);

            summary.totalRemainingBudget = totalRemainingBudget;
            summary.totalSecuredBudget = totalSecuredBudget;
            summary.totalUsedBudget = totalUsedBudget;
            summary.itemCount = policyCount;
            summary.policies = policies; // ì •ì±…ë³„ ë°ì´í„° ì¶”ê°€

            console.log(`ğŸ“‹ [${sheet.sheetName}] policies ë°°ì—´:`, JSON.stringify(policies));
            console.log(`ğŸ“‹ [${sheet.sheetName}] policies ë°°ì—´ ê¸¸ì´:`, policies.length);
            console.log(`ğŸ“‹ [${sheet.sheetName}] validRows ê¸¸ì´:`, validRows.length);
          } else {
            console.log(`ğŸ“‹ [${sheet.sheetName}] ë©”íƒ€ë°ì´í„°ì— ì •ì±… ë°ì´í„° ì—†ìŒ`);
          }
        } catch (metadataError) {
          console.log(`âŒ [${sheet.sheetName}] ë©”íƒ€ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨:`, metadataError.message);

          // ë©”íƒ€ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨ ì‹œ ì•¡ë©´ì˜ˆì‚° ì‹œíŠ¸ì—ì„œ ê³„ì‚° (ê¸°ì¡´ ë°©ì‹)
          console.log(`ğŸ” [${sheet.sheetName}] ì•¡ë©´ì˜ˆì‚° ì‹œíŠ¸ì—ì„œ ê³„ì‚° ì‹œì‘!`);

          // ì•¡ë©´ì˜ˆì‚° ì‹œíŠ¸ì—ì„œ í•´ë‹¹ ë²”ìœ„ ê°€ì ¸ì˜¤ê¸°
          const activationDataResponse = await sheets_api.spreadsheets.values.get({
            spreadsheetId: sheet.sheetId,
            range: 'ì•¡ë©´ì˜ˆì‚°!A:AA' // Aì—´ë¶€í„° Zì—´ê¹Œì§€ (26ê°œ ì»¬ëŸ¼) - API ë¶€í•˜ ê°ì†Œ
          });

          const activationData = activationDataResponse.data.values || [];
          console.log(`ğŸ“Š [${sheet.sheetName}] ì•¡ë©´ì˜ˆì‚° ë°ì´í„° ë¡œë“œ: ${activationData.length}í–‰`);

          if (activationData.length > 4) { // í—¤ë” 4í–‰ ì œì™¸
            let totalRemainingBudget = 0;
            let totalSecuredBudget = 0;
            let totalUsedBudget = 0;

            // ì•¡ë©´ì˜ˆì‚° íƒ€ì…ì— ë”°ë¥¸ ì»¬ëŸ¼ ë§¤í•‘
            const inputUserCol = budgetType === 'â…¡' ? 1 : 3; // Bì—´ ë˜ëŠ” Dì—´

            // ë©”íƒ€ë°ì´í„°ì—ì„œ ìƒì„±ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            let creatorName = '';
            try {
              const creatorResponse = await sheets_api.spreadsheets.values.get({
                spreadsheetId: sheet.sheetId,
                range: `${sheet.sheetName}!O1:X2`
              });

              const creatorData = creatorResponse.data.values || [];
              if (creatorData.length >= 2 && creatorData[1].length >= 4) {
                creatorName = creatorData[1][3] || ''; // ìƒì„±ì ì´ë¦„ (Rì—´)
                console.log(`ğŸ” [${sheet.sheetName}] ìƒì„±ì: ${creatorName}`);
              }
            } catch (creatorError) {
              console.log(`âŒ [${sheet.sheetName}] ìƒì„±ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:`, creatorError.message);
            }

            activationData.slice(4).forEach((row, index) => { // 5í–‰ë¶€í„° ì‹œì‘ (í—¤ë” 4í–‰ ì œì™¸)
              if (row.length >= (budgetType === 'â…¡' ? 11 : 14)) { // ì¶©ë¶„í•œ ì—´ì´ ìˆëŠ”ì§€ í™•ì¸
                const inputUser = row[inputUserCol];

                // ìƒì„±ì ë§¤ì¹­ (ìƒì„±ìê°€ ì„¤ì •ëœ ê²½ìš°ì—ë§Œ)
                let isMatched = true;
                if (creatorName && inputUser && creatorName !== 'ë¯¸ì ìš©') {
                  isMatched = inputUser.includes(creatorName);
                }

                // ì¡°ê±´ì— ë§ëŠ” ë°ì´í„°ë§Œ í•©ê³„
                if (isMatched) {
                  if (budgetType === 'â…¡') {
                    // ì•¡ë©´ì˜ˆì‚°(â…¡): Iì—´(ì”ì•¡), Jì—´(í™•ë³´), Kì—´(ì‚¬ìš©)
                    if (row[8] !== '' && row[8] !== undefined && row[8] !== null) {
                      const value = parseFloat(row[8]) || 0;
                      totalRemainingBudget += value;
                    }
                    if (row[9] !== '' && row[9] !== undefined && row[9] !== null) {
                      const value = parseFloat(row[9]) || 0;
                      totalSecuredBudget += value;
                    }
                    if (row[10] !== '' && row[10] !== undefined && row[10] !== null) {
                      const value = parseFloat(row[10]) || 0;
                      totalUsedBudget += value;
                    }
                  } else {
                    // ì•¡ë©´ì˜ˆì‚°(â… ): Lì—´(ì”ì•¡), Mì—´(í™•ë³´), Nì—´(ì‚¬ìš©)
                    if (row[11] !== '' && row[11] !== undefined && row[11] !== null) {
                      const value = parseFloat(row[11]) || 0;
                      totalRemainingBudget += value;
                    }
                    if (row[12] !== '' && row[12] !== undefined && row[12] !== null) {
                      const value = parseFloat(row[12]) || 0;
                      totalSecuredBudget += value;
                    }
                    if (row[13] !== '' && row[13] !== undefined && row[13] !== null) {
                      const value = parseFloat(row[13]) || 0;
                      totalUsedBudget += value;
                    }
                  }
                }
              }
            });

            console.log(`ğŸ“Š [${sheet.sheetName}] ì•¡ë©´ì˜ˆì‚° ê³„ì‚° ì™„ë£Œ: ì”ì•¡=${totalRemainingBudget}, í™•ë³´=${totalSecuredBudget}, ì‚¬ìš©=${totalUsedBudget}`);

            summary.totalRemainingBudget = totalRemainingBudget;
            summary.totalSecuredBudget = totalSecuredBudget;
            summary.totalUsedBudget = totalUsedBudget;
            summary.itemCount = activationData.length - 4; // í—¤ë” 4í–‰ ì œì™¸
          } else {
            console.log(`âŒ [${sheet.sheetName}] ì•¡ë©´ì˜ˆì‚° ë°ì´í„° ë¶€ì¡±: ${activationData.length}í–‰`);
          }
        }

        // ë‚ ì§œ ë²”ìœ„ ì„¤ì •
        if (sheet.dateRange.receiptStartDate) {
          summary.dateRange = `ì ‘ìˆ˜ì¼ ${sheet.dateRange.receiptStartDate} ~ ${sheet.dateRange.receiptEndDate}<br/>ê°œí†µì¼ ${sheet.dateRange.activationStartDate} ~ ${sheet.dateRange.activationEndDate}`;
          summary.applyReceiptDate = true;
        } else {
          summary.dateRange = `ì ‘ìˆ˜ì¼ ë¯¸ì„¤ì •~ë¯¸ì„¤ì •<br/>ê°œí†µì¼ ${sheet.dateRange.activationStartDate} ~ ${sheet.dateRange.activationEndDate}`;
        }

      } catch (dataError) {
        console.log(`[NEW-API] ì‹œíŠ¸ ${sheet.sheetName} ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨:`, dataError.message);
      }

      return {
        id: sheet.sheetId,
        name: sheet.sheetName,
        createdAt: sheet.createdAt,
        createdBy: sheet.createdBy,
        month: sheet.targetMonth,
        summary,
        policies: summary.policies || [], // ì •ì±…ë³„ ë°ì´í„°ë¥¼ ìµœìƒìœ„ ë ˆë²¨ì— ì¶”ê°€
        uuid: sheet.uuid,
        userName: sheet.createdBy,
        creator: sheet.createdBy
      };
    }));

    console.log(`âœ… [NEW-API] ì‚¬ìš©ì ì‹œíŠ¸ ì¡°íšŒ ì™„ë£Œ: ${enrichedSheets.length}ê°œ`);
    res.json(enrichedSheets);

  } catch (error) {
    console.error('[NEW-API] ì‚¬ìš©ìë³„ ì‹œíŠ¸ ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'ì‚¬ìš©ìë³„ ì‹œíŠ¸ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
  }
});

// ì‚¬ìš©ì ì‹œíŠ¸ ì‚­ì œ API (ìƒˆë¡œ ì¶”ê°€)
app.delete('/api/budget/user-sheets-v2/:uuid', async (req, res) => {
  console.log('ğŸ—‘ï¸ [NEW-API] DELETE /api/budget/user-sheets-v2 í˜¸ì¶œë¨!', req.params);
  try {
    const { uuid } = req.params;
    const { userId } = req.query; // ìš”ì²­ì ID

    if (!userId) {
      return res.status(400).json({ error: 'ì‚¬ìš©ì IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' });
    }

    const result = await userSheetManager.deleteUserSheet(uuid, userId);

    console.log(`âœ… [NEW-API] ì‹œíŠ¸ ì‚­ì œ ì™„ë£Œ: ${result.deletedSheetName}`);
    res.json({
      message: 'ì‹œíŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.',
      deletedSheetName: result.deletedSheetName
    });

  } catch (error) {
    console.error('[NEW-API] ì‹œíŠ¸ ì‚­ì œ ì˜¤ë¥˜:', error);
    res.status(500).json({ error: error.message || 'ì‹œíŠ¸ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
  }
});

// ê¸°ì¡´ API (ë ˆê±°ì‹œ)
app.get('/api/budget/user-sheets', async (req, res) => {
  try {
    const { userId, targetMonth, showAllUsers, budgetType } = req.query;
    const sheets = google.sheets({ version: 'v4', auth });

    // ì‚¬ìš©ìë³„ ì‹œíŠ¸ ëª©ë¡ ì¡°íšŒ (ì˜ˆì‚°_ì‚¬ìš©ìì‹œíŠ¸ê´€ë¦¬ ì‹œíŠ¸ì—ì„œ)
    const sheetsData = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: 'ì˜ˆì‚°_ì‚¬ìš©ìì‹œíŠ¸ê´€ë¦¬!A:F', // ëŒ€ìƒì›” ì»¬ëŸ¼ ì¶”ê°€
    });

    const rows = sheetsData.data.values || [];

    // ì‹œíŠ¸ê°€ ë¹„ì–´ìˆê±°ë‚˜ í—¤ë”ê°€ ì—†ìœ¼ë©´ í—¤ë” ìƒì„±
    if (rows.length === 0 || !rows[0] || rows[0][0] !== 'ì‚¬ìš©ìID') {
      const headerRow = ['ì‚¬ìš©ìID', 'ì‹œíŠ¸ID', 'ì‹œíŠ¸ëª…', 'ìƒì„±ì¼ì‹œ', 'ìƒì„±ì', 'ëŒ€ìƒì›”'];
      await sheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ì˜ˆì‚°_ì‚¬ìš©ìì‹œíŠ¸ê´€ë¦¬!A1:F1',
        valueInputOption: 'RAW',
        resource: {
          values: [headerRow]
        }
      });
      return res.json([]);
    }

    if (rows.length <= 1) {
      return res.json([]);
    }

    // í•´ë‹¹ ì‚¬ìš©ìì˜ ì‹œíŠ¸ë§Œ í•„í„°ë§í•˜ê³  ì˜ˆì‚° ë°ì´í„° ìš”ì•½ ì •ë³´ ì¶”ê°€
    const userSheets = [];

    for (const row of rows.slice(1)) {
      // showAllUsersê°€ trueì´ë©´ ëª¨ë“  ì‚¬ìš©ìì˜ ì‹œíŠ¸ë¥¼ ë°˜í™˜, ì•„ë‹ˆë©´ í•´ë‹¹ ì‚¬ìš©ìì˜ ì‹œíŠ¸ë§Œ
      const shouldInclude = showAllUsers === 'true'
        ? (!targetMonth || row[5] === targetMonth) // ëª¨ë“  ì‚¬ìš©ì + ëŒ€ìƒì›” í•„í„°
        : (row[0] === userId && (!targetMonth || row[5] === targetMonth)); // íŠ¹ì • ì‚¬ìš©ì + ëŒ€ìƒì›” í•„í„°

      if (shouldInclude) {
        const sheetId = row[1] || '';
        const sheetName = row[2] || '';

        // ì˜ˆì‚° íƒ€ì…ë³„ í•„í„°ë§ (budgetType íŒŒë¼ë¯¸í„° ê¸°ì¤€)
        if (budgetType) {
          const requestedType = budgetType; // 'â… ' ë˜ëŠ” 'â…¡'
          const hasRequestedType = sheetName.includes(`(${requestedType})`);

          if (!hasRequestedType) {
            continue; // ìš”ì²­ëœ ì˜ˆì‚° íƒ€ì…ì´ ì•„ë‹Œ ì‹œíŠ¸ ì œì™¸
          }
        }

        // ì†Œìœ ê¶Œ ê¸°ë°˜ í•„í„°ë§
        const isTypeI = sheetName.includes('(â… )');
        const isTypeII = sheetName.includes('(â…¡)');
        const isOwnSheet = row[0] === userId;

        // ì•¡ë©´ì˜ˆì‚°(â… ): ëª¨ë“  ì‚¬ìš©ì ì‹œíŠ¸ í‘œì‹œ (í•„í„°ë§ ì—†ìŒ)
        // ì•¡ë©´ì˜ˆì‚°(â…¡): ë³¸ì¸ì˜ ì‹œíŠ¸ë§Œ í‘œì‹œ
        if (isTypeII && !isOwnSheet) {
          continue; // ì•¡ë©´ì˜ˆì‚°(â…¡)ì´ë©´ì„œ ë³¸ì¸ ì‹œíŠ¸ê°€ ì•„ë‹Œ ê²½ìš° ì œì™¸
        }
        const createdAt = row[3] || '';
        const createdBy = row[4] || '';
        const month = row[5] || '';

        // ê° ì‹œíŠ¸ì˜ ì˜ˆì‚° ë°ì´í„° ìš”ì•½ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        let summary = {
          totalSecuredBudget: 0,
          totalUsedBudget: 0,
          totalRemainingBudget: 0,
          itemCount: 0,
          lastUpdated: '',
          dateRange: '',
          applyReceiptDate: false
        };

        try {
          // ì‹œíŠ¸ ì´ë¦„ì—ì„œ ì•¡ë©´ì˜ˆì‚° íƒ€ì… ì¶”ì¶œ
          const budgetTypeMatch = sheetName.match(/ì•¡ë©´_.*?\(([â… â…¡])\)/);
          const budgetType = budgetTypeMatch ? budgetTypeMatch[1] : 'â… ';

          // ì•¡ë©´ì˜ˆì‚° íƒ€ì…ì— ë”°ë¥¸ ë²”ìœ„ ê²°ì •
          let phoneklRange, inputUserCol, inputDateCol;
          if (budgetType === 'â…¡') {
            // ì•¡ë©´ì˜ˆì‚°(â…¡): Bì—´(ì…ë ¥ì), Cì—´(ì…ë ¥ì¼ì‹œ), Iì—´(ì”ì•¡), Jì—´(í™•ë³´), Kì—´(ì‚¬ìš©)
            phoneklRange = 'ì•¡ë©´ì˜ˆì‚°!B:K';
            inputUserCol = 0; // Bì—´ (ì²« ë²ˆì§¸ ì»¬ëŸ¼)
            inputDateCol = 1; // Cì—´ (ë‘ ë²ˆì§¸ ì»¬ëŸ¼)
          } else {
            // ì•¡ë©´ì˜ˆì‚°(â… ): Dì—´(ì…ë ¥ì), Eì—´(ì…ë ¥ì¼ì‹œ), Lì—´(ì”ì•¡), Mì—´(í™•ë³´), Nì—´(ì‚¬ìš©)
            phoneklRange = 'ì•¡ë©´ì˜ˆì‚°!D:N';
            inputUserCol = 0; // Dì—´ (ì²« ë²ˆì§¸ ì»¬ëŸ¼)
            inputDateCol = 1; // Eì—´ (ë‘ ë²ˆì§¸ ì»¬ëŸ¼)
          }

          // ì•¡ë©´ì˜ˆì‚°ì—ì„œ í•´ë‹¹ ë²”ìœ„ ê°€ì ¸ì˜¤ê¸°
          const activationDataResponse = await sheets.spreadsheets.values.get({
            spreadsheetId: sheetId,
            range: phoneklRange
          });

          const activationData = activationDataResponse.data.values || [];

          // ìê°€ì—…ì ì •ë³´ ì¶”ì¶œ (ì‹œíŠ¸ ì´ë¦„ì—ì„œ) - ê´„í˜¸ì™€ ê³µë°± ì œê±°
          const ownerMatch = sheetName.match(/ì•¡ë©´_(.+?)\(/);
          const ownerName = ownerMatch ? ownerMatch[1].replace(/\([^)]+\)/g, '').trim() : '';

          // ë§ˆì§€ë§‰ìˆ˜ì •ì¼ì‹œ ê°€ì ¸ì˜¤ê¸° (ë©”íƒ€ë°ì´í„°ì—ì„œ)
          let lastModifiedDate = '';
          try {
            const metadataResponse = await sheets.spreadsheets.values.get({
              spreadsheetId: sheetId,
              range: `${sheetName}!O1:X2`
            });

            const metadata = metadataResponse.data.values || [];
            if (metadata.length >= 2 && metadata[1].length >= 2) {
              const rawDate = metadata[1][1] || ''; // ë§ˆì§€ë§‰ìˆ˜ì •ì¼ì‹œ

              // í•œêµ­ ì‹œê°„ í˜•ì‹ì„ ì„œë²„ ì‹œê°„ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
              if (rawDate && rawDate.includes('ì˜¤í›„')) {
                // "2025. 8. 28. ì˜¤í›„ 11:48:16" â†’ "2025-08-28 23:48:16"
                const match = rawDate.match(/(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})\.\s*(ì˜¤ì „|ì˜¤í›„)\s*(\d{1,2}):(\d{2}):(\d{2})/);
                if (match) {
                  const [, year, month, day, ampm, hour, minute, second] = match;
                  let adjustedHour = parseInt(hour);

                  // ì˜¤í›„ì¸ ê²½ìš° 12ë¥¼ ë”í•¨ (ë‹¨, 12ì‹œëŠ” ì œì™¸)
                  if (ampm === 'ì˜¤í›„' && hour !== '12') {
                    adjustedHour += 12;
                  }
                  // ì˜¤ì „ 12ì‹œëŠ” 0ì‹œë¡œ ë³€í™˜
                  if (ampm === 'ì˜¤ì „' && hour === '12') {
                    adjustedHour = 0;
                  }

                  lastModifiedDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')} ${adjustedHour.toString().padStart(2, '0')}:${minute}:${second}`;
                } else {
                  lastModifiedDate = rawDate; // ë³€í™˜ ì‹¤íŒ¨ì‹œ ì›ë³¸ ì‚¬ìš©
                }
              } else {
                lastModifiedDate = rawDate; // ì´ë¯¸ ì„œë²„ í˜•ì‹ì´ê±°ë‚˜ ë‹¤ë¥¸ í˜•ì‹
              }
            }
          } catch (metadataError) {
            console.log('ë©”íƒ€ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨:', metadataError.message);
          }

          console.log(`ğŸ” [${sheetName}] ì¡°ê±´ ë§¤ì¹­: ìê°€ì—…ì=${ownerName}, ë§ˆì§€ë§‰ìˆ˜ì •ì¼ì‹œ=${lastModifiedDate}`);

          // ì¡°ê±´ë¶€ í•©ê³„ ê³„ì‚° - ë‚ ì§œ ë²”ìœ„ì™€ ìƒì„±í•œ ì €ì¥ê°’ì— ë§ëŠ” ê¸ˆì•¡ë§Œ í•©ì‚°
          let totalRemainingBudget = 0;
          let totalSecuredBudget = 0;
          let totalUsedBudget = 0;

          // ë©”íƒ€ë°ì´í„°ì—ì„œ ë‚ ì§œ ë²”ìœ„ì™€ ìƒì„±ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          let receiptStartDate = '';
          let receiptEndDate = '';
          let activationStartDate = '';
          let activationEndDate = '';
          let creatorName = '';

          console.log(`ğŸ” [${sheetName}] ë©”íƒ€ë°ì´í„° ì¡°íšŒ ì‹œì‘: O1:X2`);

          try {
            const metadataResponse = await sheets.spreadsheets.values.get({
              spreadsheetId: sheetId,
              range: `${sheetName}!O1:X2`
            });

            const metadata = metadataResponse.data.values || [];
            console.log(`ğŸ” [${sheetName}] ë©”íƒ€ë°ì´í„° ì›ë³¸:`, JSON.stringify(metadata));

            if (metadata.length >= 2 && metadata[1].length >= 4) {
              const receiptRange = metadata[1][1] || ''; // ì ‘ìˆ˜ì¼ ë²”ìœ„
              const activationRange = metadata[1][2] || ''; // ê°œí†µì¼ ë²”ìœ„
              creatorName = metadata[1][0] || ''; // ìƒì„±ì ì´ë¦„

              console.log(`ğŸ” [${sheetName}] íŒŒì‹± ì „: receiptRange="${receiptRange}", activationRange="${activationRange}", creatorName="${creatorName}"`);

              // ì ‘ìˆ˜ì¼ ë²”ìœ„ íŒŒì‹± (ì˜ˆ: "2025.08.01~2025.08.31")
              if (receiptRange && receiptRange.includes('~')) {
                const [start, end] = receiptRange.split('~');
                receiptStartDate = start.trim();
                receiptEndDate = end.trim();
              }

              // ê°œí†µì¼ ë²”ìœ„ íŒŒì‹± (ì˜ˆ: "2025.08.01~2025.08.31")
              if (activationRange && activationRange.includes('~')) {
                const [start, end] = activationRange.split('~');
                activationStartDate = start.trim();
                activationEndDate = end.trim();
              }
            } else {
              console.log(`âŒ [${sheetName}] ë©”íƒ€ë°ì´í„° í˜•ì‹ ì˜¤ë¥˜: length=${metadata.length}, row1.length=${metadata[1]?.length}`);
            }
          } catch (metadataError) {
            console.log(`âŒ [${sheetName}] ë©”íƒ€ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨:`, metadataError.message);
          }

          console.log(`ğŸ“… [${sheetName}] íŒŒì‹± í›„ ì¡°ê±´: ìƒì„±ì="${creatorName}", ì ‘ìˆ˜ì¼="${receiptStartDate}~${receiptEndDate}", ê°œí†µì¼="${activationStartDate}~${activationEndDate}"`);

          activationData.slice(4).forEach((row, index) => { // 5í–‰ë¶€í„° ì‹œì‘ (í—¤ë” 4í–‰ ì œì™¸)
            if (row.length >= (budgetType === 'â…¡' ? 11 : 14)) { // ì¶©ë¶„í•œ ì—´ì´ ìˆëŠ”ì§€ í™•ì¸
              const inputUser = row[inputUserCol];
              const inputDate = row[inputDateCol];

              // ì¡°ê±´ ë§¤ì¹­ ì²´í¬
              let isMatched = true;
              let matchReason = [];

              console.log(`ğŸ” [${sheetName}] Row ${index + 5} ë§¤ì¹­ ì²´í¬: inputUser="${inputUser}", inputDate="${inputDate}"`);

              // 1. ìƒì„±ì ë§¤ì¹­ (ìƒì„±ìê°€ ì„¤ì •ëœ ê²½ìš°ì—ë§Œ)
              if (creatorName && inputUser) {
                const creatorMatch = inputUser.includes(creatorName);
                isMatched = isMatched && creatorMatch;
                matchReason.push(`ìƒì„±ì: ${creatorMatch ? 'ì„±ê³µ' : 'ì‹¤íŒ¨'} (${inputUser} vs ${creatorName})`);
              } else {
                matchReason.push(`ìƒì„±ì: ì¡°ê±´ì—†ìŒ`);
              }

              // 2. ë‚ ì§œ ë²”ìœ„ ë§¤ì¹­ (ë²”ìœ„ê°€ ì„¤ì •ëœ ê²½ìš°ì—ë§Œ)
              if (inputDate) {
                const inputDateStr = inputDate.toString().trim();

                // ì ‘ìˆ˜ì¼ ë²”ìœ„ ì²´í¬
                if (receiptStartDate && receiptEndDate) {
                  const receiptMatch = (inputDateStr >= receiptStartDate && inputDateStr <= receiptEndDate);
                  isMatched = isMatched && receiptMatch;
                  matchReason.push(`ì ‘ìˆ˜ì¼: ${receiptMatch ? 'ì„±ê³µ' : 'ì‹¤íŒ¨'} (${inputDateStr} vs ${receiptStartDate}~${receiptEndDate})`);
                } else {
                  matchReason.push(`ì ‘ìˆ˜ì¼: ì¡°ê±´ì—†ìŒ`);
                }

                // ê°œí†µì¼ ë²”ìœ„ ì²´í¬
                if (activationStartDate && activationEndDate) {
                  const activationMatch = (inputDateStr >= activationStartDate && inputDateStr <= activationEndDate);
                  isMatched = isMatched && activationMatch;
                  matchReason.push(`ê°œí†µì¼: ${activationMatch ? 'ì„±ê³µ' : 'ì‹¤íŒ¨'} (${inputDateStr} vs ${activationStartDate}~${activationEndDate})`);
                } else {
                  matchReason.push(`ê°œí†µì¼: ì¡°ê±´ì—†ìŒ`);
                }
              } else {
                matchReason.push(`ì…ë ¥ì¼: ë°ì´í„°ì—†ìŒ`);
              }

              console.log(`ğŸ” [${sheetName}] Row ${index + 5} ë§¤ì¹­ ê²°ê³¼: ${isMatched ? 'ì„±ê³µ' : 'ì‹¤íŒ¨'} - ${matchReason.join(', ')}`);

              // ì¡°ê±´ì— ë§ëŠ” ë°ì´í„°ë§Œ í•©ê³„
              if (isMatched) {
                if (budgetType === 'â…¡') {
                  // ì•¡ë©´ì˜ˆì‚°(â…¡): Iì—´(ì”ì•¡), Jì—´(í™•ë³´), Kì—´(ì‚¬ìš©)
                  if (row[8] !== '' && row[8] !== undefined && row[8] !== null) {
                    const value = parseFloat(row[8]) || 0;
                    totalRemainingBudget += value;
                    console.log(`ğŸ’° [${sheetName}] Row ${index + 5} ë§¤ì¹­ì„±ê³µ(â…¡): Iì—´=${row[8]} â†’ ì”ì•¡ ëˆ„ì =${totalRemainingBudget}`);
                  }
                  if (row[9] !== '' && row[9] !== undefined && row[9] !== null) {
                    const value = parseFloat(row[9]) || 0;
                    totalSecuredBudget += value;
                    console.log(`ğŸ’° [${sheetName}] Row ${index + 5} ë§¤ì¹­ì„±ê³µ(â…¡): Jì—´=${row[9]} â†’ í™•ë³´ ëˆ„ì =${totalSecuredBudget}`);
                  }
                  if (row[10] !== '' && row[10] !== undefined && row[10] !== null) {
                    const value = parseFloat(row[10]) || 0;
                    totalUsedBudget += value;
                    console.log(`ğŸ’° [${sheetName}] Row ${index + 5} ë§¤ì¹­ì„±ê³µ(â…¡): Kì—´=${row[10]} â†’ ì‚¬ìš© ëˆ„ì =${totalUsedBudget}`);
                  }
                } else if (budgetType === 'ì¢…í•©') {
                  // ì•¡ë©´ì˜ˆì‚°(ì¢…í•©): Fì—´(ì”ì•¡), Gì—´(í™•ë³´), Hì—´(ì‚¬ìš©)
                  if (row[5] !== '' && row[5] !== undefined && row[5] !== null) {
                    const value = parseFloat(row[5]) || 0;
                    totalRemainingBudget += value;
                    console.log(`ğŸ’° [${sheetName}] Row ${index + 5} ë§¤ì¹­ì„±ê³µ(ì¢…í•©): Fì—´=${row[5]} â†’ ì”ì•¡ ëˆ„ì =${totalRemainingBudget}`);
                  }
                  if (row[6] !== '' && row[6] !== undefined && row[6] !== null) {
                    const value = parseFloat(row[6]) || 0;
                    totalSecuredBudget += value;
                    console.log(`ğŸ’° [${sheetName}] Row ${index + 5} ë§¤ì¹­ì„±ê³µ(ì¢…í•©): Gì—´=${row[6]} â†’ í™•ë³´ ëˆ„ì =${totalSecuredBudget}`);
                  }
                  if (row[7] !== '' && row[7] !== undefined && row[7] !== null) {
                    const value = parseFloat(row[7]) || 0;
                    totalUsedBudget += value;
                    console.log(`ğŸ’° [${sheetName}] Row ${index + 5} ë§¤ì¹­ì„±ê³µ(ì¢…í•©): Hì—´=${row[7]} â†’ ì‚¬ìš© ëˆ„ì =${totalUsedBudget}`);
                  }
                } else {
                  // ì•¡ë©´ì˜ˆì‚°(â… ): Lì—´(ì”ì•¡), Mì—´(í™•ë³´), Nì—´(ì‚¬ìš©)
                  if (row[11] !== '' && row[11] !== undefined && row[11] !== null) {
                    const value = parseFloat(row[11]) || 0;
                    totalRemainingBudget += value;
                    console.log(`ğŸ’° [${sheetName}] Row ${index + 5} ë§¤ì¹­ì„±ê³µ(â… ): Lì—´=${row[11]} â†’ ì”ì•¡ ëˆ„ì =${totalRemainingBudget}`);
                  }
                  if (row[12] !== '' && row[12] !== undefined && row[12] !== null) {
                    const value = parseFloat(row[12]) || 0;
                    totalSecuredBudget += value;
                    console.log(`ğŸ’° [${sheetName}] Row ${index + 5} ë§¤ì¹­ì„±ê³µ(â… ): Mì—´=${row[12]} â†’ í™•ë³´ ëˆ„ì =${totalSecuredBudget}`);
                  }
                  if (row[13] !== '' && row[13] !== undefined && row[13] !== null) {
                    const value = parseFloat(row[13]) || 0;
                    totalUsedBudget += value;
                    console.log(`ğŸ’° [${sheetName}] Row ${index + 5} ë§¤ì¹­ì„±ê³µ(â… ): Nì—´=${row[13]} â†’ ì‚¬ìš© ëˆ„ì =${totalUsedBudget}`);
                  }
                }
              } else {
                console.log(`âŒ [${sheetName}] Row ${index + 5} ë§¤ì¹­ì‹¤íŒ¨ - ${matchReason.join(', ')}`);
              }
            }
          });

          console.log(`ğŸ“Š [${sheetName}] ì¡°ê±´ë¶€ í•©ê³„ ì™„ë£Œ: ì”ì•¡=${totalRemainingBudget}, í™•ë³´=${totalSecuredBudget}, ì‚¬ìš©=${totalUsedBudget}`);

          console.log(`ğŸ“Š [${sheetName}] ìµœì¢… í•©ê³„: ì˜ˆì‚°ì”ì•¡=${totalRemainingBudget}, í™•ë³´ì˜ˆì‚°=${totalSecuredBudget}, ì‚¬ìš©ì˜ˆì‚°=${totalUsedBudget}`);

          // ì› ë‹¨ìœ„ ê·¸ëŒ€ë¡œ í‘œì‹œ (ì•¡ë©´ì˜ˆì‚°ì—ì„œ ì§ì ‘ ì½ì€ ê°’)
          summary.totalRemainingBudget = totalRemainingBudget;
          summary.totalSecuredBudget = totalSecuredBudget;
          summary.totalUsedBudget = totalUsedBudget;

          console.log(`ğŸ“‹ [${sheetName}] ğŸ“‹ ì €ì¥ëœ ë°ì´í„° ëª©ë¡ í‘œì‹œê°’: í™•ë³´ì˜ˆì‚°=${totalSecuredBudget}, ì‚¬ìš©ì˜ˆì‚°=${totalUsedBudget}, ì˜ˆì‚°ì”ì•¡=${totalRemainingBudget}`);

          // ë©”íƒ€ë°ì´í„°ì—ì„œ ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„ê³¼ ë‚ ì§œ ë²”ìœ„ ê°€ì ¸ì˜¤ê¸° (O1:X2ë¡œ ì´ë™)
          try {
            const metadataResponse = await sheets.spreadsheets.values.get({
              spreadsheetId: sheetId,
              range: `${sheetName}!O1:X2`
            });

            const metadata = metadataResponse.data.values || [];
            if (metadata.length >= 2 && metadata[1].length >= 4) {
              summary.lastUpdated = metadata[1][0] || '';

              // ì˜ˆì‚°ì ìš©ì¼ í‘œì‹œ ê°œì„ 
              const receiptRange = metadata[1][1] || ''; // ì ‘ìˆ˜ì¼ ë²”ìœ„
              const activationRange = metadata[1][2] || ''; // ê°œí†µì¼ ë²”ìœ„

              if (receiptRange === 'ë¯¸ì ìš©') {
                summary.dateRange = `ì ‘ìˆ˜ì¼ ë¯¸ì„¤ì •~ë¯¸ì„¤ì •<br/>ê°œí†µì¼ ${activationRange}`;
              } else {
                summary.dateRange = `ì ‘ìˆ˜ì¼ ${receiptRange}<br/>ê°œí†µì¼ ${activationRange}`;
              }

              summary.applyReceiptDate = metadata[1][3] === 'ì ìš©'; // ì ‘ìˆ˜ì¼ ì ìš© ì—¬ë¶€
            }
          } catch (metadataError) {
            console.log('ë©”íƒ€ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨:', metadataError.message);
          }

        } catch (dataError) {
          console.log(`ì‹œíŠ¸ ${sheetName} ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨:`, dataError.message);
        }

        userSheets.push({
          id: sheetId,
          name: sheetName,
          createdAt,
          createdBy,
          month,
          summary
        });
      }
    }

    res.json(userSheets);
  } catch (error) {
    console.error('ì‚¬ìš©ìë³„ ì‹œíŠ¸ ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'ì‚¬ìš©ìë³„ ì‹œíŠ¸ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
  }
});

// ìƒˆë¡œìš´ ì‚¬ìš©ì ì‹œíŠ¸ ìƒì„± API (UserSheetManager ì‚¬ìš©)
app.post('/api/budget/user-sheets-v2', async (req, res) => {
  console.log('ğŸš€ [NEW-API] POST /api/budget/user-sheets-v2 í˜¸ì¶œë¨!', req.body);
  try {
    const { userId, userName, targetMonth, selectedPolicyGroups, budgetType, dateRange } = req.body;

    if (!userId || !userName || !targetMonth) {
      return res.status(400).json({ error: 'ì‚¬ìš©ì ID, ì´ë¦„, ëŒ€ìƒì›”ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.' });
    }

    // 1. ëŒ€ìƒì›”ì˜ ì‹œíŠ¸ ID ì¡°íšŒ
    const sheets = google.sheets({ version: 'v4', auth });
    const monthSheetsData = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: 'ì˜ˆì‚°_ëŒ€ìƒì›”ê´€ë¦¬!A:D',
    });

    const monthRows = monthSheetsData.data.values || [];
    const targetMonthRow = monthRows.find(row => row[0] === targetMonth);

    if (!targetMonthRow || !targetMonthRow[1]) {
      return res.status(400).json({ error: 'í•´ë‹¹ ì›”ì˜ ì‹œíŠ¸ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
    }

    const targetSheetId = targetMonthRow[1];

    // 2. ì‚¬ìš©ìì˜ ìê²© ì •ë³´ ì¡°íšŒ
    const baseUserName = userName.replace(/\([^)]+\)/, '').trim();
    let userQualification = 'ì´ì‚¬';

    try {
      const agentValues = await getSheetValues(AGENT_SHEET_NAME);
      if (agentValues) {
        const agentRows = agentValues.slice(1);
        const userAgent = agentRows.find(row => row[0] === baseUserName);
        if (userAgent) {
          userQualification = userAgent[1] || 'ì´ì‚¬';
          console.log(`ğŸ“‹ [NEW-API] ì‚¬ìš©ì ìê²© í™•ì¸: ${baseUserName} â†’ ${userQualification}`);
        }
      }
    } catch (error) {
      console.error('[NEW-API] ì‚¬ìš©ì ìê²© ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error);
    }

    // ì‚¬ìš©ìëª…ì—ì„œ ê´„í˜¸ì™€ ê³µë°±ì„ ì™„ì „íˆ ì œê±°í•˜ì—¬ ì‹œíŠ¸ëª… ìƒì„±
    const cleanUserName = baseUserName.replace(/\([^)]+\)/g, '').trim();
    const userSheetName = `ì•¡ë©´_${cleanUserName}(${budgetType}) (${userQualification})`;
    console.log(`ğŸ“ [NEW-API] ì‹œíŠ¸ëª… ìƒì„±: "${userSheetName}" (ì›ë³¸: "${baseUserName}")`);

    // 3. ì‚¬ìš©ì ì‹œíŠ¸ ìƒì„± (ì´ë¯¸ ì¡´ì¬í•˜ë©´ ë¬´ì‹œ)
    try {
      await sheets.spreadsheets.batchUpdate({
        spreadsheetId: targetSheetId,
        resource: {
          requests: [{
            addSheet: {
              properties: {
                title: userSheetName,
                gridProperties: {
                  rowCount: 1000,
                  columnCount: 24
                }
              }
            }
          }]
        }
      });
      console.log(`âœ… [NEW-API] ì‹œíŠ¸ "${userSheetName}" ìƒì„± ì™„ë£Œ`);
    } catch (addSheetError) {
      if (addSheetError.code === 400 && addSheetError.message.includes('already exists')) {
        console.log(`ğŸ“‹ [NEW-API] ì‹œíŠ¸ "${userSheetName}" ì´ë¯¸ ì¡´ì¬`);
      } else {
        throw addSheetError;
      }
    }

    // 4. í—¤ë” ì„¤ì •
    await sheets.spreadsheets.values.update({
      spreadsheetId: targetSheetId,
      range: `${userSheetName}!A1:I1`,
      valueInputOption: 'RAW',
      resource: {
        values: [['ì ìš©ì¼', 'ì…ë ¥ì(ê¶Œí•œë ˆë²¨)', 'ëª¨ë¸ëª…', 'êµ°', 'ìœ í˜•', 'í™•ë³´ëœ ì˜ˆì‚°', 'ì‚¬ìš©ëœ ì˜ˆì‚°', 'ì˜ˆì‚° ì”ì•¡', 'ìƒíƒœ']]
      }
    });

    // 4-1. ë©”íƒ€ë°ì´í„° í—¤ë” ì„¤ì • (Oì—´~Xì—´)
    await sheets.spreadsheets.values.update({
      spreadsheetId: targetSheetId,
      range: `${userSheetName}!O1:X1`,
      valueInputOption: 'RAW',
      resource: {
        values: [['ì €ì¥ì¼ì‹œ', 'ì ‘ìˆ˜ì¼ë²”ìœ„', 'ê°œí†µì¼ë²”ìœ„', 'ì ‘ìˆ˜ì¼ì ìš©ì—¬ë¶€', 'ê³„ì‚°ì¼ì‹œ', 'ê³„ì‚°ì', 'ì •ì±…ê·¸ë£¹', 'ì”ì•¡', 'í™•ë³´', 'ì‚¬ìš©']]
      }
    });

    // 5. UserSheetManagerë¥¼ ì‚¬ìš©í•˜ì—¬ ì˜ˆì‚°_ì‚¬ìš©ìì‹œíŠ¸ê´€ë¦¬ì— ë ˆì½”ë“œ ì¶”ê°€
    await userSheetManager.ensureSheetExists();

    const sheetData = {
      userId,
      targetSheetId,
      userSheetName,
      userName,
      targetMonth,
      selectedPolicyGroups,
      dateRange
    };

    const result = await userSheetManager.addUserSheet(sheetData);

    console.log(`âœ… [NEW-API] ì‚¬ìš©ì ì‹œíŠ¸ ë ˆì½”ë“œ ì¶”ê°€ ì™„ë£Œ: UUID=${result.uuid}`);

    const newSheet = {
      id: targetSheetId,
      name: userSheetName,
      createdAt: result.createdAt,
      createdBy: userName,
      uuid: result.uuid
    };

    res.json({
      message: 'ì‚¬ìš©ìë³„ ì‹œíŠ¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.',
      sheet: newSheet
    });

  } catch (error) {
    console.error('[NEW-API] ì‚¬ìš©ìë³„ ì‹œíŠ¸ ìƒì„± ì˜¤ë¥˜:', error);

    let errorMessage = 'ì‚¬ìš©ìë³„ ì‹œíŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
    if (error.code === 400) {
      if (error.message.includes('already exists')) {
        errorMessage = 'ì‹œíŠ¸ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.';
      } else if (error.message.includes('Invalid value')) {
        errorMessage = 'ì˜ëª»ëœ ê°’ì´ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.';
      }
    } else if (error.code === 403) {
      errorMessage = 'Google Sheets ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.';
    } else if (error.code === 404) {
      errorMessage = 'ëŒ€ìƒ ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
    }

    res.status(500).json({ error: errorMessage });
  }
});

// ê¸°ì¡´ API (ë ˆê±°ì‹œ)
app.post('/api/budget/user-sheets', async (req, res) => {
  console.log('ğŸš€ [DEBUG] POST /api/budget/user-sheets í˜¸ì¶œë¨!', {
    userId: req.body.userId,
    userName: req.body.userName,
    targetMonth: req.body.targetMonth,
    budgetType: req.body.budgetType
  });
  try {
    const { userId, userName, targetMonth, selectedPolicyGroups, budgetType } = req.body;

    if (!userId || !userName || !targetMonth) {
      return res.status(400).json({ error: 'ì‚¬ìš©ì ID, ì´ë¦„, ëŒ€ìƒì›”ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.' });
    }

    const sheets = google.sheets({ version: 'v4', auth });
    const currentTime = new Date().toISOString();

    // ëŒ€ìƒì›”ì˜ ì‹œíŠ¸ ID ì¡°íšŒ
    const monthSheetsData = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: 'ì˜ˆì‚°_ëŒ€ìƒì›”ê´€ë¦¬!A:D',
    });

    const monthRows = monthSheetsData.data.values || [];
    const targetMonthRow = monthRows.find(row => row[0] === targetMonth);

    if (!targetMonthRow || !targetMonthRow[1]) {
      return res.status(400).json({ error: 'í•´ë‹¹ ì›”ì˜ ì‹œíŠ¸ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
    }

    const targetSheetId = targetMonthRow[1];

    // userNameì—ì„œ ê´„í˜¸ ë¶€ë¶„ì„ ì œê±°í•˜ê³  ì‹¤ì œ ìê²© ì •ë³´ë¥¼ ëŒ€ë¦¬ì ì•„ì´ë””ê´€ë¦¬ì—ì„œ ê°€ì ¸ì˜¤ê¸°
    const baseUserName = userName.replace(/\([^)]+\)/, '').trim();

    // ì‚¬ìš©ìì˜ ìê²© ì •ë³´ë¥¼ ëŒ€ë¦¬ì ì•„ì´ë””ê´€ë¦¬ì—ì„œ ê°€ì ¸ì˜¤ê¸°
    let userQualification = 'ì´ì‚¬'; // ê¸°ë³¸ê°’
    try {
      const agentValues = await getSheetValues(AGENT_SHEET_NAME);
      if (agentValues) {
        const agentRows = agentValues.slice(1);
        const userAgent = agentRows.find(row => row[0] === baseUserName); // Aì—´: ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰
        if (userAgent) {
          userQualification = userAgent[1] || 'ì´ì‚¬'; // Bì—´: ìê²©
          console.log(`ğŸ“‹ [ì‹œíŠ¸ìƒì„±] ì‚¬ìš©ì ìê²© í™•ì¸: ${baseUserName} â†’ ${userQualification}`);
        } else {
          console.log(`âš ï¸ [ì‹œíŠ¸ìƒì„±] ëŒ€ë¦¬ì ì•„ì´ë””ê´€ë¦¬ì—ì„œ ${baseUserName} ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ ê¸°ë³¸ê°’ 'ì´ì‚¬' ì‚¬ìš©`);
        }
      }
    } catch (error) {
      console.error('ì‚¬ìš©ì ìê²© ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error);
    }

    // ì‚¬ìš©ìëª…ì—ì„œ ê´„í˜¸ì™€ ê³µë°±ì„ ì™„ì „íˆ ì œê±°í•˜ì—¬ ì‹œíŠ¸ëª… ìƒì„±
    const cleanUserName = baseUserName.replace(/\([^)]+\)/g, '').trim();
    const userSheetName = `ì•¡ë©´_${cleanUserName}(${budgetType}) (${userQualification})`;
    console.log(`ğŸ“ [ì‹œíŠ¸ìƒì„±] ì‹œíŠ¸ëª… ìƒì„±: "${userSheetName}" (ì›ë³¸: "${baseUserName}")`);

    // ê¸°ì¡´ ì‹œíŠ¸ì— ìƒˆë¡œìš´ ì‹œíŠ¸ ì¶”ê°€
    try {
      await sheets.spreadsheets.batchUpdate({
        spreadsheetId: targetSheetId,
        resource: {
          requests: [
            {
              addSheet: {
                properties: {
                  title: userSheetName,
                  gridProperties: {
                    rowCount: 1000,
                    columnCount: 24
                  }
                }
              }
            }
          ]
        }
      });
      console.log(`ì‹œíŠ¸ "${userSheetName}"ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    } catch (addSheetError) {
      // ì‹œíŠ¸ê°€ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê²½ìš° ë¬´ì‹œí•˜ê³  ê³„ì† ì§„í–‰
      if (addSheetError.code === 400 && addSheetError.message.includes('already exists')) {
        console.log(`ì‹œíŠ¸ "${userSheetName}"ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤. ê¸°ì¡´ ì‹œíŠ¸ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.`);
      } else {
        console.error('ì‹œíŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜:', addSheetError);
        throw addSheetError;
      }
    }

    // í—¤ë” ì¶”ê°€
    await sheets.spreadsheets.values.update({
      spreadsheetId: targetSheetId,
      range: `${userSheetName}!A1:I1`,
      valueInputOption: 'RAW',
      resource: {
        values: [['ì ìš©ì¼', 'ì…ë ¥ì(ê¶Œí•œë ˆë²¨)', 'ëª¨ë¸ëª…', 'êµ°', 'ìœ í˜•', 'í™•ë³´ëœ ì˜ˆì‚°', 'ì‚¬ìš©ëœ ì˜ˆì‚°', 'ì˜ˆì‚° ì”ì•¡', 'ìƒíƒœ']]
      }
    });

    // ì˜ˆì‚°_ì‚¬ìš©ìì‹œíŠ¸ê´€ë¦¬ ì‹œíŠ¸ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•˜ê³  ì—†ìœ¼ë©´ ìƒì„±
    await ensureUserSheetManagementExists(sheets);

    // ê¸°ì¡´ ì‚¬ìš©ì ì‹œíŠ¸ê°€ ìˆëŠ”ì§€ í™•ì¸ - ì •í™•í•œ ì¡°ê±´ìœ¼ë¡œ ìˆ˜ì •
    console.log('ğŸš¨ [TRACE] ì˜ˆì‚°_ì‚¬ìš©ìì‹œíŠ¸ê´€ë¦¬ ì½ê¸° ì‹œì‘:', new Date().toISOString());
    const existingSheetsData = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: 'ì˜ˆì‚°_ì‚¬ìš©ìì‹œíŠ¸ê´€ë¦¬!A:G',
    });
    console.log('ğŸš¨ [TRACE] ì˜ˆì‚°_ì‚¬ìš©ìì‹œíŠ¸ê´€ë¦¬ ì½ê¸° ì™„ë£Œ:', new Date().toISOString());

    const existingRows = existingSheetsData.data.values || [];
    // ë™ì¼í•œ ì‚¬ìš©ìID, ì‹œíŠ¸ID, ì‹œíŠ¸ëª…, ëŒ€ìƒì›”ì´ ì¼ì¹˜í•˜ëŠ” ê¸°ì¡´ ì‹œíŠ¸ëŠ” ì ˆëŒ€ ë®ì–´ì“°ì§€ ì•ŠìŒ
    // ëª¨ë“  ì €ì¥ì€ ìƒˆë¡œìš´ í–‰ìœ¼ë¡œ ì¶”ê°€ (ê³ ìœ ì„±ì€ ìƒì„±ì¼ì‹œë¡œ ìë™ ë³´ì¥)
    const existingSheet = null; // í•­ìƒ ìƒˆë¡œ ì¶”ê°€í•˜ë„ë¡ ìˆ˜ì •

    console.log(`ğŸ“‹ [ì‹œíŠ¸ìƒì„±] ê¸°ì¡´ ë°ì´í„° ë¶„ì„:`);
    console.log(`  - ì „ì²´ í–‰ ìˆ˜: ${existingRows.length}`);
    console.log(`  - ê¸°ì¡´ ë°ì´í„°:`, existingRows);
    console.log(`ğŸ“‹ [ì‹œíŠ¸ìƒì„±] ê¸°ì¡´ ì‹œíŠ¸ ê²€ìƒ‰: userId=${userId}, sheetId=${targetSheetId}, sheetName=${userSheetName}, createdAt=${currentTime}, month=${targetMonth}`);
    console.log(`ğŸ“‹ [ì‹œíŠ¸ìƒì„±] ê¸°ì¡´ ì‹œíŠ¸ ë°œê²¬: ${existingSheet ? 'YES' : 'NO'}`);

    // ê¸°ì¡´ ì‹œíŠ¸ê°€ ì—†ì„ ë•Œë§Œ ìƒˆë¡œ ì¶”ê°€
    if (!existingSheet) {
      try {
        // append ì‚¬ìš©í•˜ë˜ ìƒì„¸í•œ ì‘ë‹µ ë¡œê¹…
        console.log(`ğŸ“‹ [ì‹œíŠ¸ìƒì„±] append ì‹¤í–‰ ì „ - ê¸°ì¡´ í–‰ ìˆ˜: ${existingRows.length}`);
        console.log(`ğŸ“‹ [ì‹œíŠ¸ìƒì„±] ì¶”ê°€í•  ë°ì´í„°:`, [userId, targetSheetId, userSheetName, currentTime, userName, targetMonth, selectedPolicyGroups ? selectedPolicyGroups.join(',') : '']);

        console.log('ğŸš¨ [TRACE] ì˜ˆì‚°_ì‚¬ìš©ìì‹œíŠ¸ê´€ë¦¬ append ì‹œì‘:', new Date().toISOString());
        const appendResult = await sheets.spreadsheets.values.append({
          spreadsheetId: SPREADSHEET_ID,
          range: 'ì˜ˆì‚°_ì‚¬ìš©ìì‹œíŠ¸ê´€ë¦¬!A:G',
          valueInputOption: 'RAW',
          insertDataOption: 'INSERT_ROWS', // ìƒˆ í–‰ ì‚½ì… ë³´ì¥
          resource: {
            values: [[userId, targetSheetId, userSheetName, currentTime, userName, targetMonth, selectedPolicyGroups ? selectedPolicyGroups.join(',') : '']]
          }
        });
        console.log('ğŸš¨ [TRACE] ì˜ˆì‚°_ì‚¬ìš©ìì‹œíŠ¸ê´€ë¦¬ append ì™„ë£Œ:', new Date().toISOString());

        console.log(`ğŸ“‹ [ì‹œíŠ¸ìƒì„±] append ì‘ë‹µ:`, JSON.stringify(appendResult.data, null, 2));

        // append í›„ ì‹¤ì œ ë°ì´í„° ë‹¤ì‹œ í™•ì¸
        console.log('ğŸš¨ [TRACE] ì˜ˆì‚°_ì‚¬ìš©ìì‹œíŠ¸ê´€ë¦¬ ì¬í™•ì¸ ì‹œì‘:', new Date().toISOString());
        const afterAppendData = await sheets.spreadsheets.values.get({
          spreadsheetId: SPREADSHEET_ID,
          range: 'ì˜ˆì‚°_ì‚¬ìš©ìì‹œíŠ¸ê´€ë¦¬!A:G',
        });
        console.log('ğŸš¨ [TRACE] ì˜ˆì‚°_ì‚¬ìš©ìì‹œíŠ¸ê´€ë¦¬ ì¬í™•ì¸ ì™„ë£Œ:', new Date().toISOString());
        console.log(`ğŸ“‹ [ì‹œíŠ¸ìƒì„±] append í›„ ì‹¤ì œ ë°ì´í„°:`, afterAppendData.data.values);

        // 3ì´ˆ í›„ ë‹¤ì‹œ í•œ ë²ˆ í™•ì¸ (Google Sheets ë‚´ë¶€ ì²˜ë¦¬ í™•ì¸)
        setTimeout(async () => {
          try {
            console.log('ğŸš¨ [TRACE] ì˜ˆì‚°_ì‚¬ìš©ìì‹œíŠ¸ê´€ë¦¬ 3ì´ˆí›„ í™•ì¸ ì‹œì‘:', new Date().toISOString());
            const finalCheck = await sheets.spreadsheets.values.get({
              spreadsheetId: SPREADSHEET_ID,
              range: 'ì˜ˆì‚°_ì‚¬ìš©ìì‹œíŠ¸ê´€ë¦¬!A:G',
            });
            console.log('ğŸš¨ [TRACE] ì˜ˆì‚°_ì‚¬ìš©ìì‹œíŠ¸ê´€ë¦¬ 3ì´ˆí›„ í™•ì¸ ì™„ë£Œ:', new Date().toISOString());
            console.log(`ğŸ“‹ [ì‹œíŠ¸ìƒì„±] 3ì´ˆ í›„ ìµœì¢… í™•ì¸:`, finalCheck.data.values);
          } catch (error) {
            console.error('3ì´ˆ í›„ í™•ì¸ ì‹¤íŒ¨:', error);
          }
        }, 3000);
      } catch (appendError) {
        // ì‹œíŠ¸ê°€ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ìƒˆë¡œ ìƒì„±í•˜ê³  ë°ì´í„° ì¶”ê°€
        console.log('ì˜ˆì‚°_ì‚¬ìš©ìì‹œíŠ¸ê´€ë¦¬ ì‹œíŠ¸ê°€ ì¡´ì¬í•˜ì§€ ì•Šì•„ ìƒˆë¡œ ìƒì„±í•©ë‹ˆë‹¤.');
        try {
          await sheets.spreadsheets.batchUpdate({
            spreadsheetId: SPREADSHEET_ID,
            resource: {
              requests: [
                {
                  addSheet: {
                    properties: {
                      title: 'ì˜ˆì‚°_ì‚¬ìš©ìì‹œíŠ¸ê´€ë¦¬',
                      gridProperties: {
                        rowCount: 1000,
                        columnCount: 10
                      }
                    }
                  }
                }
              ]
            }
          });
        } catch (batchUpdateError) {
          console.error('ì‹œíŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜:', batchUpdateError);
          throw batchUpdateError;
        }
      }

      // í—¤ë”ì™€ ë°ì´í„° ì¶”ê°€
      const headerRow = ['ì‚¬ìš©ìID', 'ì‹œíŠ¸ID', 'ì‹œíŠ¸ëª…', 'ìƒì„±ì¼ì‹œ', 'ìƒì„±ì', 'ëŒ€ìƒì›”', 'ì„ íƒëœì •ì±…ê·¸ë£¹'];
      const dataRow = [userId, targetSheetId, userSheetName, currentTime, userName, targetMonth, selectedPolicyGroups ? selectedPolicyGroups.join(',') : ''];
      await sheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ì˜ˆì‚°_ì‚¬ìš©ìì‹œíŠ¸ê´€ë¦¬!A1:G2',
        valueInputOption: 'RAW',
        resource: {
          values: [headerRow, dataRow]
        }
      });
    }

    const newSheet = {
      id: targetSheetId,
      name: userSheetName,
      createdAt: currentTime,
      createdBy: userName
    };

    res.json({
      message: 'ì‚¬ìš©ìë³„ ì‹œíŠ¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.',
      sheet: newSheet
    });
  } catch (error) {
    console.error('ì‚¬ìš©ìë³„ ì‹œíŠ¸ ìƒì„± ì˜¤ë¥˜:', error);

    // ë” êµ¬ì²´ì ì¸ ì˜¤ë¥˜ ë©”ì‹œì§€ ì œê³µ
    let errorMessage = 'ì‚¬ìš©ìë³„ ì‹œíŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';

    if (error.code === 400) {
      if (error.message.includes('already exists')) {
        errorMessage = 'ì‹œíŠ¸ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.';
      } else if (error.message.includes('Invalid value')) {
        errorMessage = 'ì˜ëª»ëœ ê°’ì´ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.';
      }
    } else if (error.code === 403) {
      errorMessage = 'Google Sheets ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.';
    } else if (error.code === 404) {
      errorMessage = 'ëŒ€ìƒ ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
    } else if (error.message.includes('timeout')) {
      errorMessage = 'ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
    }

    res.status(500).json({ error: errorMessage });
  }
});

app.post('/api/budget/user-sheets/:sheetId/data', async (req, res) => {
  try {
    const { sheetId } = req.params;
    const { data, dateRange, userName, userLevel, budgetAmounts, budgetType } = req.body; // Added budgetAmounts, budgetType

    if (!data || !Array.isArray(data) || data.length === 0) {
      return res.status(400).json({ error: 'ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.' });
    }

    if (!userName) {
      return res.status(400).json({ error: 'ì‚¬ìš©ì ì´ë¦„ì´ í•„ìš”í•©ë‹ˆë‹¤.' });
    }

    const sheets = google.sheets({ version: 'v4', auth });
    const baseUserName = userName.replace(/\([^)]+\)/, '').trim();

    // ì‚¬ìš©ìì˜ ìê²© ì •ë³´ë¥¼ ëŒ€ë¦¬ì ì•„ì´ë””ê´€ë¦¬ì—ì„œ ê°€ì ¸ì˜¤ê¸°
    let userQualification = 'ì´ì‚¬'; // ê¸°ë³¸ê°’
    try {
      const agentValues = await getSheetValues(AGENT_SHEET_NAME);
      if (agentValues) {
        const agentRows = agentValues.slice(1);
        const userAgent = agentRows.find(row => row[0] === baseUserName); // Aì—´: ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰
        if (userAgent) {
          userQualification = userAgent[1] || 'ì´ì‚¬'; // Bì—´: ìê²©
          console.log(`ğŸ“‹ [ë°ì´í„°ì €ì¥] ì‚¬ìš©ì ìê²© í™•ì¸: ${baseUserName} â†’ ${userQualification}`);
        } else {
          console.log(`âš ï¸ [ë°ì´í„°ì €ì¥] ëŒ€ë¦¬ì ì•„ì´ë””ê´€ë¦¬ì—ì„œ ${baseUserName} ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ ê¸°ë³¸ê°’ 'ì´ì‚¬' ì‚¬ìš©`);
        }
      }
    } catch (error) {
      console.error('ì‚¬ìš©ì ìê²© ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error);
    }

    const userSheetName = `ì•¡ë©´_${baseUserName}(${budgetType || 'â… '}) (${userQualification})`;

    // ë°ì´í„°ë¥¼ ì‚¬ìš©ìê°€ ì›í•˜ëŠ” í˜•ì‹ìœ¼ë¡œ ë³€í™˜
    // ê° ëª¨ë¸ë³„ë¡œ êµ°/ìœ í˜•ë³„ ë°ì´í„°ë¥¼ ê°œë³„ í–‰ìœ¼ë¡œ ë¶„ë¦¬
    const rowsToSave = [];

    data.forEach(item => {
      if (item.modelName && item.expenditureValues) {
        // 18ê°œ ì»¬ëŸ¼ì˜ ì§€ì¶œì˜ˆì‚° ê°’ì„ ê°ê° ê°œë³„ í–‰ìœ¼ë¡œ ì €ì¥
        item.expenditureValues.forEach((expenditureValue, index) => {
          // ëª¨ë¸ëª…ì´ ìˆìœ¼ë©´ ëª¨ë“  í–‰ì„ ì €ì¥ (ê°’ì´ 0ì´ì–´ë„ í¬í•¨)
          const armyType = getArmyType(index + 1);
          const categoryType = getCategoryType(index + 1);

          // í•´ë‹¹ êµ°ì˜ ì˜ˆì‚°ê¸ˆì•¡ ê°€ì ¸ì˜¤ê¸° (ì˜ˆì‚°íƒ€ì…ì— ë”°ë¥¸ ê¸°ë³¸ê°’ ì ìš©)
          const defaultAmount = budgetType === 'â…¡' ? 0 : 40000;
          const securedBudget = budgetAmounts?.[armyType] || defaultAmount;

          // ì§€ì¶œì˜ˆì‚°ì„ 1ë§Œì› ë‹¨ìœ„ì—ì„œ ì› ë‹¨ìœ„ë¡œ ë³€í™˜ (ì˜ˆ: 2 -> 20000, -2 -> -20000)
          const usedBudget = expenditureValue * 10000; // Multiplied by 10000

          // ì˜ˆì‚° ì”ì•¡ ê³„ì‚°
          const remainingBudget = securedBudget - usedBudget;

          rowsToSave.push([
            dateRange.receiptStartDate || '', // Aì—´: ì ‘ìˆ˜ì¼ ì‹œì‘
            dateRange.receiptEndDate || '', // Bì—´: ì ‘ìˆ˜ì¼ ì¢…ë£Œ
            dateRange.activationStartDate || '', // Cì—´: ê°œí†µì¼ ì‹œì‘
            dateRange.activationEndDate || '', // Dì—´: ê°œí†µì¼ ì¢…ë£Œ
            `${userName}(ë ˆë²¨${userLevel || 'SS'})`, // Eì—´: ì…ë ¥ì(ê¶Œí•œë ˆë²¨)
            item.modelName, // Fì—´: ëª¨ë¸ëª…
            armyType, // Gì—´: êµ°
            categoryType, // Hì—´: ìœ í˜•
            securedBudget, // Iì—´: í™•ë³´ëœ ì˜ˆì‚° (ì› ë‹¨ìœ„)
            usedBudget, // Jì—´: ì‚¬ìš©ëœ ì˜ˆì‚° (ì› ë‹¨ìœ„)
            remainingBudget, // Kì—´: ì˜ˆì‚° ì”ì•¡ (ì› ë‹¨ìœ„)
            'ì •ìƒ' // Lì—´: ìƒíƒœ
          ]);
        });
      }
    });

    // í—¤ë” ì—…ë°ì´íŠ¸ (ìƒˆë¡œìš´ 12ê°œ ì»¬ëŸ¼ êµ¬ì¡°)
    const headerRow = [
      'ì ‘ìˆ˜ì‹œì‘ì¼', 'ì ‘ìˆ˜ì¢…ë£Œì¼', 'ê°œí†µì‹œì‘ì¼', 'ê°œí†µì¢…ë£Œì¼',
      'ì…ë ¥ì(ê¶Œí•œë ˆë²¨)', 'ëª¨ë¸ëª…', 'êµ°', 'ìœ í˜•',
      'í™•ë³´ëœ ì˜ˆì‚°', 'ì‚¬ìš©ëœ ì˜ˆì‚°', 'ì˜ˆì‚° ì”ì•¡', 'ìƒíƒœ'
    ];

    await sheets.spreadsheets.values.update({
      spreadsheetId: sheetId,
      range: `${userSheetName}!A1:L1`,
      valueInputOption: 'RAW',
      resource: {
        values: [headerRow]
      }
    });

    // ê¸°ì¡´ ë°ì´í„° ìœ ì§€í•˜ê³  ìƒˆ ë°ì´í„° ëˆ„ì  ì €ì¥ (append ë°©ì‹)
    let existingData = [];
    try {
      const existingResponse = await sheets.spreadsheets.values.get({
        spreadsheetId: sheetId,
        range: `${userSheetName}!A:L`
      });
      existingData = existingResponse.data.values || [];
    } catch (error) {
      console.log(`ğŸ“‹ [ë°ì´í„°ì €ì¥] ${userSheetName}: ê¸°ì¡´ ë°ì´í„° ì—†ìŒ, ìƒˆë¡œ ìƒì„±`);
    }

    // ìƒˆ ë°ì´í„°ë¥¼ ê¸°ì¡´ ë°ì´í„° ì•„ë˜ì— ì¶”ê°€ (append ë°©ì‹)
    if (rowsToSave.length > 0) {
      await sheets.spreadsheets.values.append({
        spreadsheetId: sheetId,
        range: `${userSheetName}!A:L`,
        valueInputOption: 'RAW',
        // insertDataOption ì œê±°ë¡œ ë¹ˆ í–‰ ìƒì„± ë°©ì§€
        resource: {
          values: rowsToSave
        }
      });
    }

    // ë©”íƒ€ë°ì´í„° ëˆ„ì  ì €ì¥ (Oì—´~Xì—´)
    let existingMetadata = [];
    try {
      const metadataResponse = await sheets.spreadsheets.values.get({
        spreadsheetId: sheetId,
        range: `${userSheetName}!O:X`
      });
      existingMetadata = metadataResponse.data.values || [];
    } catch (error) {
      console.log(`ğŸ“‹ [ë°ì´í„°ì €ì¥] ${userSheetName}: ê¸°ì¡´ ë©”íƒ€ë°ì´í„° ì—†ìŒ, ìƒˆë¡œ ìƒì„±`);
    }

    // í—¤ë”ê°€ ì—†ìœ¼ë©´ í—¤ë” ì¶”ê°€
    if (existingMetadata.length === 0) {
      // í—¤ë” ì¶”ê°€ ì „ ê¸°ì¡´ ì‹œíŠ¸ ì»¬ëŸ¼ í™•ì¥ í™•ì¸ ë° í™•ì¥ (Xì—´ê¹Œì§€)
      try {
        const sheetInfo = await sheets.spreadsheets.get({
          spreadsheetId: sheetId
        });

        const targetSheet = sheetInfo.data.sheets.find(s => s.properties.title === userSheetName);
        if (targetSheet && targetSheet.properties.gridProperties.columnCount < 24) {
          console.log(`ğŸ”„ [ë°ì´í„°ì €ì¥] ${userSheetName}: ì»¬ëŸ¼ ìˆ˜ í™•ì¥ í•„ìš” (í˜„ì¬: ${targetSheet.properties.gridProperties.columnCount}, ëª©í‘œ: 24)`);

          await sheets.spreadsheets.batchUpdate({
            spreadsheetId: sheetId,
            resource: {
              requests: [{
                updateDimensionProperties: {
                  range: {
                    sheetId: targetSheet.properties.sheetId,
                    dimension: 'COLUMNS',
                    startIndex: 0,
                    endIndex: 24
                  },
                  properties: {
                    pixelSize: 100
                  },
                  fields: 'pixelSize'
                }
              }]
            }
          });

          console.log(`âœ… [ë°ì´í„°ì €ì¥] ${userSheetName}: ì»¬ëŸ¼ ìˆ˜ í™•ì¥ ì™„ë£Œ (24ê°œ)`);
        }
      } catch (expandError) {
        console.log(`âš ï¸ [ë°ì´í„°ì €ì¥] ${userSheetName}: ì»¬ëŸ¼ í™•ì¥ ì‹¤íŒ¨ (ë¬´ì‹œí•˜ê³  ì§„í–‰):`, expandError.message);
      }

      const metadataHeader = [
        'ì €ì¥ì¼ì‹œ', 'ì ‘ìˆ˜ì¼ë²”ìœ„', 'ê°œí†µì¼ë²”ìœ„', 'ì ‘ìˆ˜ì¼ì ìš©ì—¬ë¶€',
        'ê³„ì‚°ì¼ì‹œ', 'ê³„ì‚°ì', 'ì •ì±…ê·¸ë£¹', 'ì”ì•¡', 'í™•ë³´', 'ì‚¬ìš©'
      ];

      await sheets.spreadsheets.values.update({
        spreadsheetId: sheetId,
        range: `${userSheetName}!O1:X1`,
        valueInputOption: 'RAW',
        resource: {
          values: [metadataHeader]
        }
      });
    }

    // ë©”íƒ€ë°ì´í„° ìƒì„±ì€ SAFE-UPDATEì—ì„œ ì²˜ë¦¬í•˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ì œê±°
    // ì‚¬ìš©ìì‹œíŠ¸ ë°ì´í„°ë§Œ ì €ì¥í•˜ê³ , ë©”íƒ€ë°ì´í„°ëŠ” ê³„ì‚° ì™„ë£Œ í›„ SAFE-UPDATEì—ì„œ ìƒì„±
    console.log(`ğŸ“ [ë°ì´í„°ì €ì¥] ${userSheetName}: ì‚¬ìš©ìì‹œíŠ¸ ë°ì´í„° ì €ì¥ ì™„ë£Œ, ë©”íƒ€ë°ì´í„°ëŠ” SAFE-UPDATEì—ì„œ ì²˜ë¦¬`);

    // ë°ì´í„° ì €ì¥ í›„ ë°”ë¡œ ê³„ì‚° ìˆ˜í–‰
    console.log(`ğŸ“Š [ë°ì´í„°ì €ì¥] ${userSheetName} ê³„ì‚° ì‹œì‘`);

    // ì•¡ë©´ì˜ˆì‚°ì—ì„œ í•´ë‹¹ ë²”ìœ„ ê°€ì ¸ì˜¤ê¸°
    const activationDataResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: sheetId,
      range: 'ì•¡ë©´ì˜ˆì‚°!A:AA' // Aì—´ë¶€í„° Zì—´ê¹Œì§€ (26ê°œ ì»¬ëŸ¼) - API ë¶€í•˜ ê°ì†Œ
    });

    const activationData = activationDataResponse.data.values || [];
    console.log(`ğŸ“Š [ë°ì´í„°ì €ì¥] ì•¡ë©´ì˜ˆì‚° ë°ì´í„° ë¡œë“œ: ${activationData.length}í–‰`);

    // ê³„ì‚° ê²°ê³¼ ì´ˆê¸°í™”
    let totalRemainingBudget = 0;
    let totalSecuredBudget = 0;
    let totalUsedBudget = 0;

    if (activationData.length > 4) {
      // ë©”íƒ€ë°ì´í„°ì—ì„œ ë‚ ì§œ ë²”ìœ„ì™€ ìƒì„±ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      let receiptStartDate = '';
      let receiptEndDate = '';
      let activationStartDate = '';
      let activationEndDate = '';
      let creatorName = '';

      // ë©”íƒ€ë°ì´í„° ì¡°íšŒ
      try {
        const metadataResponse = await sheets.spreadsheets.values.get({
          spreadsheetId: sheetId,
          range: `${userSheetName}!O1:X2`
        });

        const metadata = metadataResponse.data.values || [];
        if (metadata.length >= 2 && metadata[1].length >= 4) {
          const receiptRange = metadata[1][1] || ''; // ì ‘ìˆ˜ì¼ ë²”ìœ„
          const activationRange = metadata[1][2] || ''; // ê°œí†µì¼ ë²”ìœ„
          creatorName = metadata[1][3] || ''; // ìƒì„±ì ì´ë¦„ (Rì—´)

          // ì ‘ìˆ˜ì¼ ë²”ìœ„ íŒŒì‹±
          if (receiptRange && receiptRange.includes('~') && receiptRange !== 'ë¯¸ì ìš©') {
            const [start, end] = receiptRange.split('~');
            receiptStartDate = start.trim();
            receiptEndDate = end.trim();
          }

          // ê°œí†µì¼ ë²”ìœ„ íŒŒì‹±
          if (activationRange && activationRange.includes('~') && activationRange !== 'ë¯¸ì ìš©') {
            const [start, end] = activationRange.split('~');
            activationStartDate = start.trim();
            activationEndDate = end.trim();
          }
        }
      } catch (metadataError) {
        console.log(`âŒ [ë°ì´í„°ì €ì¥] ë©”íƒ€ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨:`, metadataError.message);
      }

      console.log(`ğŸ“… [ë°ì´í„°ì €ì¥] ì¡°ê±´: ìƒì„±ì="${creatorName}", ì ‘ìˆ˜ì¼="${receiptStartDate}~${receiptEndDate}", ê°œí†µì¼="${activationStartDate}~${activationEndDate}"`);

      // ì•¡ë©´ì˜ˆì‚° íƒ€ì…ì— ë”°ë¥¸ ì»¬ëŸ¼ ë§¤í•‘
      const inputUserCol = budgetType === 'â…¡' ? 1 : 3; // Bì—´ ë˜ëŠ” Dì—´
      const inputDateCol = budgetType === 'â…¡' ? 2 : 4; // Cì—´ ë˜ëŠ” Eì—´

      activationData.slice(4).forEach((row, index) => { // 5í–‰ë¶€í„° ì‹œì‘ (í—¤ë” 4í–‰ ì œì™¸)
        if (row.length >= (budgetType === 'â…¡' ? 11 : 14)) { // ì¶©ë¶„í•œ ì—´ì´ ìˆëŠ”ì§€ í™•ì¸
          const inputUser = row[inputUserCol];
          const inputDate = row[inputDateCol];

          // ì¡°ê±´ ë§¤ì¹­ ì²´í¬
          let isMatched = true;

          // 1. ìƒì„±ì ë§¤ì¹­ (ìƒì„±ìê°€ ì„¤ì •ëœ ê²½ìš°ì—ë§Œ)
          if (creatorName && inputUser && creatorName !== 'ë¯¸ì ìš©') {
            const creatorMatch = inputUser.includes(creatorName);
            isMatched = isMatched && creatorMatch;
          }

          // 2. ë‚ ì§œ ë²”ìœ„ ë§¤ì¹­ (ë²”ìœ„ê°€ ì„¤ì •ëœ ê²½ìš°ì—ë§Œ)
          if (inputDate) {
            let inputDateStr = inputDate.toString().trim();

            // (â… ) ì ‘ë¯¸ì‚¬ ì œê±°
            if (inputDateStr.includes('(â… )')) {
              inputDateStr = inputDateStr.replace('(â… )', '').trim();
            }
            if (inputDateStr.includes('(â…¡)')) {
              inputDateStr = inputDateStr.replace('(â…¡)', '').trim();
            }

            // ì ‘ìˆ˜ì¼ ë²”ìœ„ ì²´í¬ (ì ‘ìˆ˜ì¼ì´ ì„¤ì •ëœ ê²½ìš°ì—ë§Œ)
            if (receiptStartDate && receiptEndDate && receiptStartDate !== 'ë¯¸ì ìš©') {
              const receiptMatch = (inputDateStr >= receiptStartDate && inputDateStr <= receiptEndDate);
              isMatched = isMatched && receiptMatch;
            }

            // ê°œí†µì¼ ë²”ìœ„ ì²´í¬ (ê°œí†µì¼ì´ ì„¤ì •ëœ ê²½ìš°ì—ë§Œ)
            if (activationStartDate && activationEndDate && activationStartDate !== 'ë¯¸ì ìš©') {
              const activationMatch = (inputDateStr >= activationStartDate && inputDateStr <= activationEndDate);
              isMatched = isMatched && activationMatch;
            }
          }

          // ì¡°ê±´ì— ë§ëŠ” ë°ì´í„°ë§Œ í•©ê³„
          if (isMatched) {
            if (budgetType === 'â…¡') {
              // ì•¡ë©´ì˜ˆì‚°(â…¡): Iì—´(ì”ì•¡), Jì—´(í™•ë³´), Kì—´(ì‚¬ìš©)
              if (row[8] !== '' && row[8] !== undefined && row[8] !== null) {
                const value = parseFloat(row[8]) || 0;
                totalRemainingBudget += value;
              }
              if (row[9] !== '' && row[9] !== undefined && row[9] !== null) {
                const value = parseFloat(row[9]) || 0;
                totalSecuredBudget += value;
              }
              if (row[10] !== '' && row[10] !== undefined && row[10] !== null) {
                const value = parseFloat(row[10]) || 0;
                totalUsedBudget += value;
              }
            } else {
              // ì•¡ë©´ì˜ˆì‚°(â… ): Lì—´(ì”ì•¡), Mì—´(í™•ë³´), Nì—´(ì‚¬ìš©)
              if (row[11] !== '' && row[11] !== undefined && row[11] !== null) {
                const value = parseFloat(row[11]) || 0;
                totalRemainingBudget += value;
              }
              if (row[12] !== '' && row[12] !== undefined && row[12] !== null) {
                const value = parseFloat(row[12]) || 0;
                totalSecuredBudget += value;
              }
              if (row[13] !== '' && row[13] !== undefined && row[13] !== null) {
                const value = parseFloat(row[13]) || 0;
                totalUsedBudget += value;
              }
            }
          }
        }
      });

      console.log(`ğŸ“Š [ë°ì´í„°ì €ì¥] ${userSheetName} ê³„ì‚° ì™„ë£Œ: ì”ì•¡=${totalRemainingBudget}, í™•ë³´=${totalSecuredBudget}, ì‚¬ìš©=${totalUsedBudget}`);

      // ê³„ì‚° ê²°ê³¼ê°€ 0ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸ (0ê°’ ì •ì±… ìƒì„± ë°©ì§€)
      if (totalRemainingBudget > 0 || totalSecuredBudget > 0 || totalUsedBudget > 0) {
        try {
          const metadataUpdateResponse = await sheets.spreadsheets.values.get({
            spreadsheetId: sheetId,
            range: `${userSheetName}!O:X`
          });

          const metadata = metadataUpdateResponse.data.values || [];
          if (metadata.length > 1) { // í—¤ë” 1í–‰ + ë°ì´í„° 1í–‰ ì´ìƒ
            const lastRowIndex = metadata.length; // ë§ˆì§€ë§‰ í–‰ ì¸ë±ìŠ¤

            // Vì—´(ì”ì•¡), Wì—´(í™•ë³´), Xì—´(ì‚¬ìš©) ì—…ë°ì´íŠ¸
            const updateRequests = [
              {
                range: `${userSheetName}!V${lastRowIndex}`,
                values: [[totalRemainingBudget]]
              },
              {
                range: `${userSheetName}!W${lastRowIndex}`,
                values: [[totalSecuredBudget]]
              },
              {
                range: `${userSheetName}!X${lastRowIndex}`,
                values: [[totalUsedBudget]]
              }
            ];

            await sheets.spreadsheets.values.batchUpdate({
              spreadsheetId: sheetId,
              resource: {
                valueInputOption: 'RAW',
                data: updateRequests
              }
            });

            console.log(`âœ… [ë°ì´í„°ì €ì¥] ${userSheetName}: ë©”íƒ€ë°ì´í„° ê³„ì‚° ê²°ê³¼ ì—…ë°ì´íŠ¸ ì™„ë£Œ (ì”ì•¡=${totalRemainingBudget}, í™•ë³´=${totalSecuredBudget}, ì‚¬ìš©=${totalUsedBudget})`);
          }
        } catch (updateError) {
          console.error(`âŒ [ë°ì´í„°ì €ì¥] ${userSheetName}: ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:`, updateError.message);
        }
      } else {
        console.log(`âš ï¸ [ë°ì´í„°ì €ì¥] ${userSheetName}: ê³„ì‚° ê²°ê³¼ê°€ ëª¨ë‘ 0ì´ë¯€ë¡œ ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸ ê±´ë„ˆëœ€ (0ê°’ ì •ì±… ìƒì„± ë°©ì§€)`);
      }
    }

    res.json({
      message: 'ì˜ˆì‚° ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.',
      summary: {
        totalRemainingBudget,
        totalSecuredBudget,
        totalUsedBudget
      }
    });
  } catch (error) {
    console.error('ì˜ˆì‚° ë°ì´í„° ì €ì¥ ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'ì˜ˆì‚° ë°ì´í„° ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
  }
});

// êµ°ë³„ íƒ€ì… ë§¤í•‘ í•¨ìˆ˜
function getArmyType(columnIndex) {
  const armyTypes = ['Sêµ°', 'Sêµ°', 'Sêµ°', 'Aêµ°', 'Aêµ°', 'Aêµ°', 'Bêµ°', 'Bêµ°', 'Bêµ°', 'Cêµ°', 'Cêµ°', 'Cêµ°', 'Dêµ°', 'Dêµ°', 'Dêµ°', 'Eêµ°', 'Eêµ°', 'Eêµ°'];
  return armyTypes[columnIndex - 1] || 'Unknown';
}

// ì¹´í…Œê³ ë¦¬ íƒ€ì… ë§¤í•‘ í•¨ìˆ˜
function getCategoryType(columnIndex) {
  const categoryTypes = ['ì‹ ê·œ', 'MNP', 'ë³´ìƒ', 'ì‹ ê·œ', 'MNP', 'ë³´ìƒ', 'ì‹ ê·œ', 'MNP', 'ë³´ìƒ', 'ì‹ ê·œ', 'MNP', 'ë³´ìƒ', 'ì‹ ê·œ', 'MNP', 'ë³´ìƒ', 'ì‹ ê·œ', 'MNP', 'ë³´ìƒ'];
  return categoryTypes[columnIndex - 1] || 'Unknown';
}

// ì•¡ë©´ì˜ˆì‚° ì¢…í•© ê³„ì‚° API
app.get('/api/budget/summary/:targetMonth', async (req, res) => {
  try {
    const { targetMonth } = req.params;
    const { userId } = req.query;
    const sheets = google.sheets({ version: 'v4', auth });

    console.log(`ğŸ” [ì•¡ë©´ì˜ˆì‚°ì¢…í•©] ì‹œì‘: ${targetMonth}, ì‚¬ìš©ì: ${userId}`);

    // userId â†’ ì‚¬ìš©ì ì´ë¦„ ë§¤í•‘ (ëŒ€ë¦¬ì ì•„ì´ë””ê´€ë¦¬ Cì—´:ì—°ë½ì²˜ â†’ Aì—´:ì´ë¦„)
    let targetUserName = '';
    try {
      const agentSheetResponse = await sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: AGENT_SHEET_NAME + '!A:C'
      });
      const agentValues = agentSheetResponse.data.values || [];
      if (agentValues.length > 1) {
        const agentRows = agentValues.slice(1);
        const match = agentRows.find(row => row[2] === userId); // Cì—´: ì—°ë½ì²˜(ì•„ì´ë””)
        if (match) {
          targetUserName = (match[0] || '').trim(); // Aì—´: ì´ë¦„
        }
      }
    } catch (e) {
      console.log('âš ï¸ [ì•¡ë©´ì˜ˆì‚°ì¢…í•©] ì‚¬ìš©ì ì´ë¦„ ë§¤í•‘ ì‹¤íŒ¨:', e.message);
    }
    // ì •ê·œí™”ëœ ë¹„êµìš© ì´ë¦„ (ê´„í˜¸ ì œê±°)
    const targetUserNameClean = targetUserName ? targetUserName.replace(/\([^)]*\)/g, '').trim() : '';

    // ì˜ˆì‚°_ì‚¬ìš©ìì‹œíŠ¸ê´€ë¦¬ì—ì„œ í•´ë‹¹ ì›”ì˜ ëª¨ë“  ì‹œíŠ¸ ì¡°íšŒ
    const userSheetManagementResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: 'ì˜ˆì‚°_ì‚¬ìš©ìì‹œíŠ¸ê´€ë¦¬!A:G'
    });

    const userSheetManagementData = userSheetManagementResponse.data.values || [];
    if (userSheetManagementData.length <= 1) {
      return res.json({
        success: true,
        summary: {
          totalSecuredBudget: 0,
          totalUsedBudget: 0,
          totalRemainingBudget: 0,
          basicShoeAmount: 0
        }
      });
    }

    // ì‚¬ìš©ìë³„ ì˜ˆì‚° ë°ì´í„° ì €ì¥
    const userBudgets = {};

    // ì¤‘ë³µ ì œê±°: ê°™ì€ sheetIdëŠ” í•œ ë²ˆë§Œ ì²˜ë¦¬ (ì•¡ë©´ì˜ˆì‚°(ì¢…í•©)ì—ì„œëŠ” êµ¬ê¸€ ì‹œíŠ¸ ê¸°ì¤€)
    const processedSheetIds = new Set();

    // ê¸°ë³¸êµ¬ë‘ ë°ì´í„° ìˆ˜ì§‘ì„ ìœ„í•œ ë³€ìˆ˜
    let totalBasicShoeAmount = 0;
    const processedBasicShoeSheets = new Set();

    // í—¤ë” ì œì™¸í•˜ê³  ê° ì‹œíŠ¸ì˜ ì•¡ë©´ì˜ˆì‚° ì‹œíŠ¸ì—ì„œ ì‚¬ìš©ìë³„ íƒ€ì…ë³„ ì»¬ëŸ¼ í•©ê³„
    for (let i = 1; i < userSheetManagementData.length; i++) {
      const row = userSheetManagementData[i];
      if (row.length >= 6 && row[5] === targetMonth) { // Fì—´: ëŒ€ìƒì›”
        const sheetId = row[1]; // Bì—´: ì‹œíŠ¸ID
        const sheetName = row[2]; // Cì—´: ì‹œíŠ¸ëª…

        // ì´ë¯¸ ì²˜ë¦¬ëœ sheetIdëŠ” ê±´ë„ˆë›°ê¸° (ê°™ì€ êµ¬ê¸€ ì‹œíŠ¸ëŠ” í•œ ë²ˆë§Œ ì²˜ë¦¬)
        if (processedSheetIds.has(sheetId)) {
          console.log(`âš ï¸ [ì•¡ë©´ì˜ˆì‚°ì¢…í•©] ${sheetName} (${sheetId}) ì´ë¯¸ ì²˜ë¦¬ë¨, ê±´ë„ˆë›°ê¸°`);
          continue;
        }

        processedSheetIds.add(sheetId);
        console.log(`ğŸ” [ì•¡ë©´ì˜ˆì‚°ì¢…í•©] ${sheetName} ì²˜ë¦¬ ì‹œì‘`);

        // ê¸°ë³¸êµ¬ë‘ ìƒì„± ëª©ë¡ ì½ê¸° (í•œ ë²ˆë§Œ)
        if (!processedBasicShoeSheets.has(sheetId)) {
          try {
            // "ê¸°ë³¸êµ¬ë‘ìƒì„±ëª©ë¡" ì‹œíŠ¸ì—ì„œ ì‚¬ìš©ìê°€ ìƒì„±í•œ ê¸°ë³¸êµ¬ë‘ë§Œ ì½ê¸°
            const basicShoeCreationResponse = await sheets.spreadsheets.values.get({
              spreadsheetId: sheetId,
              range: 'ê¸°ë³¸êµ¬ë‘ìƒì„±ëª©ë¡!A:E'
            });

            const basicShoeCreationData = basicShoeCreationResponse.data.values || [];
            if (basicShoeCreationData.length > 1) {
              const rows = basicShoeCreationData.slice(1); // í—¤ë” ì œì™¸
              rows.forEach((creationRow) => {
                if (creationRow.length >= 4) {
                  const createdBy = creationRow[1] || ''; // Bì—´: ì‚¬ìš©ì
                  const policyGroups = creationRow[2] || ''; // Cì—´: ì •ì±…ê·¸ë£¹
                  const amount = parseFloat((creationRow[3] || '').toString().replace(/,/g, '')) || 0; // Dì—´: ê¸ˆì•¡

                  // í•´ë‹¹ ì‚¬ìš©ìê°€ ìƒì„±í•œ ê¸°ë³¸êµ¬ë‘ë§Œ í•©ì‚°
                  if (createdBy && amount > 0 && createdBy.includes(targetUserNameClean)) {
                    totalBasicShoeAmount += amount;
                    console.log(`ğŸ‘ [ì•¡ë©´ì˜ˆì‚°ì¢…í•©] ì‚¬ìš©ì ìƒì„± ê¸°ë³¸êµ¬ë‘: ${createdBy} - ${amount.toLocaleString()}ì›`);
                  }
                }
              });
            }

            // ê¸°ì¡´ "ê¸°ë³¸êµ¬ë‘" ì‹œíŠ¸ëŠ” ì½ì§€ ì•ŠìŒ (ì‚¬ìš©ìê°€ ìƒì„±í•œ ê¸°ë³¸êµ¬ë‘ë§Œ ê³„ì‚°)
            // í•˜ìœ„ í˜¸í™˜ì„±ì´ í•„ìš”í•œ ê²½ìš° ì•„ë˜ ì£¼ì„ì„ í•´ì œ
            /*
            try {
              const basicShoeResponse = await sheets.spreadsheets.values.get({
                spreadsheetId: sheetId,
                range: 'ê¸°ë³¸êµ¬ë‘!A:L'
              });
              
              const basicShoeData = basicShoeResponse.data.values || [];
              if (basicShoeData.length > 1) {
                const rows = basicShoeData.slice(1);
                rows.forEach((basicRow) => {
                  if (basicRow.length >= 12) {
                    const policyGroup = basicRow[11] || ''; // Lì—´(11ë²ˆì¸ë±ìŠ¤): ì •ì±…ê·¸ë£¹
                    const amount = parseFloat((basicRow[10] || '').toString().replace(/,/g, '')) || 0; // Kì—´(10ë²ˆì¸ë±ìŠ¤): ê¸°ë³¸êµ¬ë‘ ê¸ˆì•¡
                    
                    if (policyGroup && amount > 0) {
                      totalBasicShoeAmount += amount;
                    }
                  }
                });
              }
            } catch (basicShoeError) {
              console.log(`âš ï¸ [ì•¡ë©´ì˜ˆì‚°ì¢…í•©] ${sheetName} ê¸°ì¡´ ê¸°ë³¸êµ¬ë‘ ì‹œíŠ¸ ì¡°íšŒ ì‹¤íŒ¨:`, basicShoeError.message);
            }
            */

            processedBasicShoeSheets.add(sheetId);
            console.log(`âœ… [ì•¡ë©´ì˜ˆì‚°ì¢…í•©] ${sheetName} ê¸°ë³¸êµ¬ë‘ ë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ: ${totalBasicShoeAmount.toLocaleString()}ì›`);
          } catch (error) {
            console.log(`âš ï¸ [ì•¡ë©´ì˜ˆì‚°ì¢…í•©] ${sheetName} ê¸°ë³¸êµ¬ë‘ ìƒì„± ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:`, error.message);
          }
        }

        try {
          // ì•¡ë©´ì˜ˆì‚° ì‹œíŠ¸ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
          const activationResponse = await sheets.spreadsheets.values.get({
            spreadsheetId: sheetId,
            range: 'ì•¡ë©´ì˜ˆì‚°!A:AA' // Aì—´ë¶€í„° Zì—´ê¹Œì§€ (26ê°œ ì»¬ëŸ¼) - API ë¶€í•˜ ê°ì†Œ
          });

          const activationData = activationResponse.data.values || [];
          console.log(`ğŸ“Š [ì•¡ë©´ì˜ˆì‚°ì¢…í•©] ì•¡ë©´ì˜ˆì‚° ë°ì´í„° ë¡œë“œ: ${activationData.length}í–‰`);

          if (activationData.length > 4) { // í—¤ë” 4í–‰ ì œì™¸
            // ì‹œíŠ¸ì—ì„œ ì‚¬ìš©ìê°€ í¬í•¨ëœ ëª¨ë“  í–‰ì„ ì°¾ì•„ì„œ F/G/H ê°’ í•©ì‚° (SUMIF ë°©ì‹)
            for (let index = 0; index < activationData.slice(4).length; index++) {
              const row = activationData[index + 4]; // 5í–‰ë¶€í„° ì‹œì‘
              if (row.length >= 14 && targetUserNameClean) {
                const inputUserB = row[1] || ''; // Bì—´: ì…ë ¥ì
                const inputUserD = row[3] || ''; // Dì—´: ì…ë ¥ì
                const cleanB = inputUserB ? inputUserB.replace(/\([^)]*\)/g, '').trim() : '';
                const cleanD = inputUserD ? inputUserD.replace(/\([^)]*\)/g, '').trim() : '';

                // Bì—´ ë˜ëŠ” Dì—´ì— íƒ€ê²Ÿ ì‚¬ìš©ìê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
                const isMatched = (cleanB && cleanB.includes(targetUserNameClean)) || (cleanD && cleanD.includes(targetUserNameClean));
                if (isMatched) {
                  // F/G/H ì—´ì—ì„œ ì§ì ‘ í•©ê³„ ê°’ ì½ì–´ì˜¤ê¸° (SUMIF ë°©ì‹)
                  const remainingValue = row[5] !== '' && row[5] !== undefined && row[5] !== null ?
                    parseFloat(String(row[5]).replace(/,/g, '')) || 0 : 0;
                  const securedValue = row[6] !== '' && row[6] !== undefined && row[6] !== null ?
                    parseFloat(String(row[6]).replace(/,/g, '')) || 0 : 0;
                  const usedValue = row[7] !== '' && row[7] !== undefined && row[7] !== null ?
                    parseFloat(String(row[7]).replace(/,/g, '')) || 0 : 0;

                  // ì‚¬ìš©ì ì˜ˆì‚°ì— ì§ì ‘ ì¶”ê°€ (ì‹œíŠ¸ë³„ ê°œë³„ í•©ê³„ ì—†ì´)
                  const key = targetUserNameClean;
                  if (!userBudgets[key]) {
                    userBudgets[key] = { remainingBudget: 0, securedBudget: 0, usedBudget: 0 };
                  }
                  userBudgets[key].remainingBudget += remainingValue;
                  userBudgets[key].securedBudget += securedValue;
                  userBudgets[key].usedBudget += usedValue;

                  console.log(`ğŸ“Š [ì•¡ë©´ì˜ˆì‚°ì¢…í•©] ì‚¬ìš©ì ${targetUserNameClean} ë°œê²¬: F/G/Hì—´=${remainingValue}/${securedValue}/${usedValue}`);
                }
              }
            }
          }
        } catch (error) {
          console.log(`âš ï¸ [ì•¡ë©´ì˜ˆì‚°ì¢…í•©] ${sheetName} ì•¡ë©´ì˜ˆì‚° ì‹œíŠ¸ ì¡°íšŒ ì‹¤íŒ¨:`, error.message);
        }
      }
    }

    // ì „ì²´ í•©ê³„ ê³„ì‚°
    let totalSecuredBudget = 0;
    let totalUsedBudget = 0;
    let totalRemainingBudget = 0;

    Object.keys(userBudgets).forEach(user => {
      const budget = userBudgets[user];
      totalRemainingBudget += budget.remainingBudget;
      totalSecuredBudget += budget.securedBudget;
      totalUsedBudget += budget.usedBudget;

      console.log(`ğŸ“Š [ì•¡ë©´ì˜ˆì‚°ì¢…í•©] ì‚¬ìš©ì ${user}: ì”ì•¡=${budget.remainingBudget}, í™•ë³´=${budget.securedBudget}, ì‚¬ìš©=${budget.usedBudget}`);
    });

    // ê¸°ë³¸êµ¬ë‘ ê¸ˆì•¡ì„ ìµœì¢… ì˜ˆì‚° ì”ì•¡ì—ì„œ ì°¨ê°
    const finalRemainingBudget = totalRemainingBudget - totalBasicShoeAmount;

    console.log(`ğŸ“Š [ì•¡ë©´ì˜ˆì‚°ì¢…í•©] ì „ì²´ í•©ê³„: í™•ë³´=${totalSecuredBudget}, ì‚¬ìš©=${totalUsedBudget}, ì”ì•¡=${totalRemainingBudget}`);
    console.log(`ğŸ‘ [ì•¡ë©´ì˜ˆì‚°ì¢…í•©] ê¸°ë³¸êµ¬ë‘ ì°¨ê°: ${totalBasicShoeAmount.toLocaleString()}ì›`);
    console.log(`ğŸ¯ [ì•¡ë©´ì˜ˆì‚°ì¢…í•©] ìµœì¢… ì˜ˆì‚° ì”ì•¡: ${finalRemainingBudget.toLocaleString()}ì›`);

    res.json({
      success: true,
      summary: {
        totalSecuredBudget,
        totalUsedBudget,
        totalRemainingBudget: finalRemainingBudget, // ê¸°ë³¸êµ¬ë‘ ì°¨ê°ëœ ìµœì¢… ì”ì•¡
        originalRemainingBudget: totalRemainingBudget, // ê¸°ë³¸êµ¬ë‘ ì°¨ê° ì „ ì›ë³¸ ì”ì•¡
        basicShoeAmount: totalBasicShoeAmount,
        userBudgets // ì‚¬ìš©ìë³„ ìƒì„¸ ë°ì´í„° ì¶”ê°€
      }
    });

  } catch (error) {
    console.error('[ì•¡ë©´ì˜ˆì‚°ì¢…í•©] ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: 'ì•¡ë©´ì˜ˆì‚° ì¢…í•© ê³„ì‚° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
    });
  }
});

// ê¸°ë³¸êµ¬ë‘ ìƒì„± ëª©ë¡ ì €ì¥ API
app.post('/api/budget/basic-shoe/save-creation-list', async (req, res) => {
  try {
    const { sheetId, policyGroups, totalAmount, userName } = req.body;

    if (!sheetId || !policyGroups || !Array.isArray(policyGroups)) {
      return res.status(400).json({
        success: false,
        error: 'ì‹œíŠ¸ IDì™€ ì •ì±…ê·¸ë£¹ ëª©ë¡ì´ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }

    const sheets = google.sheets({ version: 'v4', auth });

    // "ê¸°ë³¸êµ¬ë‘ìƒì„±ëª©ë¡" ì‹œíŠ¸ê°€ ì—†ìœ¼ë©´ ìƒì„±
    try {
      await sheets.spreadsheets.values.get({
        spreadsheetId: sheetId,
        range: 'ê¸°ë³¸êµ¬ë‘ìƒì„±ëª©ë¡!A:A'
      });
    } catch (error) {
      // ì‹œíŠ¸ê°€ ì—†ìœ¼ë©´ ìƒì„±
      await sheets.spreadsheets.batchUpdate({
        spreadsheetId: sheetId,
        resource: {
          requests: [{
            addSheet: {
              properties: {
                title: 'ê¸°ë³¸êµ¬ë‘ìƒì„±ëª©ë¡',
                gridProperties: {
                  rowCount: 1000,
                  columnCount: 10
                }
              }
            }
          }]
        }
      });

      // í—¤ë” ì¶”ê°€
      await sheets.spreadsheets.values.update({
        spreadsheetId: sheetId,
        range: 'ê¸°ë³¸êµ¬ë‘ìƒì„±ëª©í•©!A1',
        valueInputOption: 'RAW',
        resource: {
          values: [['ìƒì„±ì¼ì‹œ', 'ì‚¬ìš©ì', 'ì •ì±…ê·¸ë£¹', 'ê¸ˆì•¡', 'ë¹„ê³ ']]
        }
      });
    }

    // ìƒˆ ë°ì´í„° ì¶”ê°€
    const currentTime = new Date().toISOString();
    const newRow = [
      currentTime,
      userName || 'ì•Œ ìˆ˜ ì—†ìŒ',
      policyGroups.join(', '),
      totalAmount,
      'ì‚¬ìš©ì ìƒì„±'
    ];

    await sheets.spreadsheets.values.append({
      spreadsheetId: sheetId,
      range: 'ê¸°ë³¸êµ¬ë‘ìƒì„±ëª©ë¡!A:E',
      valueInputOption: 'RAW',
      insertDataOption: 'INSERT_ROWS',
      resource: {
        values: [newRow]
      }
    });

    console.log(`âœ… [ê¸°ë³¸êµ¬ë‘] ìƒì„± ëª©ë¡ ì €ì¥ ì™„ë£Œ: ${policyGroups.length}ê°œ ê·¸ë£¹, ì´ ${totalAmount.toLocaleString()}ì›`);

    res.json({
      success: true,
      message: 'ê¸°ë³¸êµ¬ë‘ ìƒì„± ëª©ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.',
      savedData: {
        timestamp: currentTime,
        userName,
        policyGroups,
        totalAmount
      }
    });

  } catch (error) {
    console.error('âŒ [ê¸°ë³¸êµ¬ë‘] ìƒì„± ëª©ë¡ ì €ì¥ ì‹¤íŒ¨:', error);
    res.status(500).json({
      success: false,
      error: 'ê¸°ë³¸êµ¬ë‘ ìƒì„± ëª©ë¡ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
    });
  }
});

// ê¸°ë³¸êµ¬ë‘ ìƒì„± ëª©ë¡ ì¡°íšŒ API
app.get('/api/budget/basic-shoe/creation-list', async (req, res) => {
  try {
    const { sheetId } = req.query;

    if (!sheetId) {
      return res.status(400).json({
        success: false,
        error: 'ì‹œíŠ¸ IDê°€ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }

    const sheets = google.sheets({ version: 'v4', auth });

    // "ê¸°ë³¸êµ¬ë‘ìƒì„±ëª©ë¡" ì‹œíŠ¸ì—ì„œ ë°ì´í„° ì½ê¸°
    const response = await sheets.spreadsheets.values.get({
      spreadsheetId: sheetId,
      range: 'ê¸°ë³¸êµ¬ë‘ìƒì„±ëª©ë¡!A:E'
    });

    const data = response.data.values || [];
    if (data.length <= 1) {
      return res.json({
        success: true,
        creationList: [],
        totalAmount: 0
      });
    }

    // í—¤ë” ì œì™¸í•˜ê³  ë°ì´í„° ì²˜ë¦¬
    const rows = data.slice(1);
    const creationList = [];
    let totalAmount = 0;

    rows.forEach((row, index) => {
      if (row.length >= 4) {
        const timestamp = row[0] || ''; // Aì—´: ìƒì„±ì¼ì‹œ
        const userName = row[1] || ''; // Bì—´: ì‚¬ìš©ì
        const policyGroups = row[2] || ''; // Cì—´: ì •ì±…ê·¸ë£¹
        const amount = parseFloat((row[3] || '').toString().replace(/,/g, '')) || 0; // Dì—´: ê¸ˆì•¡
        const note = row[4] || ''; // Eì—´: ë¹„ê³ 

        if (amount > 0) {
          creationList.push({
            id: index,
            timestamp,
            userName,
            policyGroups,
            amount,
            note
          });
          totalAmount += amount;
        }
      }
    });

    console.log(`âœ… [ê¸°ë³¸êµ¬ë‘] ìƒì„± ëª©ë¡ ì¡°íšŒ: ì´ ${totalAmount.toLocaleString()}ì›, ${creationList.length}ê°œ í•­ëª©`);

    res.json({
      success: true,
      creationList,
      totalAmount
    });

  } catch (error) {
    console.error('âŒ [ê¸°ë³¸êµ¬ë‘] ìƒì„± ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: 'ê¸°ë³¸êµ¬ë‘ ìƒì„± ëª©ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
    });
  }
});

// ê¸°ë³¸êµ¬ë‘ ë°ì´í„° ì¡°íšŒ API
app.get('/api/budget/basic-shoe', async (req, res) => {
  try {
    const { sheetId, policyGroups } = req.query;

    if (!sheetId) {
      return res.status(400).json({
        success: false,
        error: 'ì‹œíŠ¸ IDê°€ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }

    const sheets = google.sheets({ version: 'v4', auth });

    // "ê¸°ë³¸êµ¬ë‘" ì‹œíŠ¸ì—ì„œ ë°ì´í„° ì½ê¸°
    const response = await sheets.spreadsheets.values.get({
      spreadsheetId: sheetId,
      range: 'ê¸°ë³¸êµ¬ë‘!A:L'
    });

    const data = response.data.values || [];
    if (data.length <= 1) {
      return res.json({
        success: true,
        basicShoeData: [],
        totalAmount: 0,
        policyGroupAmounts: {}
      });
    }

    // í—¤ë” ì œì™¸í•˜ê³  ë°ì´í„° ì²˜ë¦¬
    const rows = data.slice(1);
    const processedData = [];
    const policyGroupAmounts = {};
    let totalAmount = 0;

    // ì •ì±…ê·¸ë£¹ í•„í„°ë§ (ì½¤ë§ˆë¡œ êµ¬ë¶„ëœ ë¬¸ìì—´ì„ ë°°ì—´ë¡œ ë³€í™˜)
    const selectedPolicyGroups = policyGroups ? policyGroups.split(',') : [];

    rows.forEach((row, index) => {
      if (row.length >= 12) {
        const policyGroup = row[11] || ''; // Lì—´(11ë²ˆì¸ë±ìŠ¤): ì •ì±…ê·¸ë£¹
        const amount = parseFloat((row[10] || '').toString().replace(/,/g, '')) || 0; // Kì—´(10ë²ˆì¸ë±ìŠ¤): ê¸°ë³¸êµ¬ë‘ ê¸ˆì•¡

        // ì„ íƒëœ ì •ì±…ê·¸ë£¹ê³¼ ì¼ì¹˜í•˜ëŠ” ê²½ìš°ë§Œ ì²˜ë¦¬
        if (policyGroup && amount > 0 && selectedPolicyGroups.includes(policyGroup)) {
          processedData.push({
            id: index,
            policyGroup,
            amount,
            row: row
          });

          // ì •ì±…ê·¸ë£¹ë³„ ê¸ˆì•¡ í•©ì‚°
          if (!policyGroupAmounts[policyGroup]) {
            policyGroupAmounts[policyGroup] = 0;
          }
          policyGroupAmounts[policyGroup] += amount;
          totalAmount += amount;
        }
      }
    });

    console.log(`âœ… [ê¸°ë³¸êµ¬ë‘] API ì‘ë‹µ: ì´ ${totalAmount.toLocaleString()}ì›, ${Object.keys(policyGroupAmounts).length}ê°œ ê·¸ë£¹`);

    res.json({
      success: true,
      basicShoeData: processedData,
      totalAmount,
      policyGroupAmounts
    });

  } catch (error) {
    console.error('âŒ [ê¸°ë³¸êµ¬ë‘] API ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: 'ê¸°ë³¸êµ¬ë‘ ë°ì´í„° ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
    });
  }
});



// ì˜ˆì‚° ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° API
app.get('/api/budget/user-sheets/:sheetId/data', async (req, res) => {
  try {
    const { sheetId } = req.params;
    const { userName, currentUserId, budgetType } = req.query;
    const sheets = google.sheets({ version: 'v4', auth });

    if (!userName) {
      return res.status(400).json({ error: 'ì‚¬ìš©ì ì´ë¦„ì´ í•„ìš”í•©ë‹ˆë‹¤.' });
    }

    // í˜„ì¬ ì‚¬ìš©ìì˜ ê¶Œí•œ í™•ì¸ (ì•¡ë©´ì˜ˆì‚°(â… )ì—ì„œë§Œ ë‹¤ë¥¸ ì‚¬ìš©ì ë°ì´í„° ì¡°íšŒ í—ˆìš©)
    let canAccessOtherUserData = false;
    let actualSheetOwner = userName; // ê¸°ë³¸ê°’: ìš”ì²­ëœ ì‚¬ìš©ì ì´ë¦„

    if (currentUserId && budgetType === 'â… ') {
      try {
        // ëŒ€ë¦¬ì ì•„ì´ë””ê´€ë¦¬ ì‹œíŠ¸ì—ì„œ í˜„ì¬ ì‚¬ìš©ìì˜ ê¶Œí•œ ë ˆë²¨ í™•ì¸
        const agentValues = await getSheetValues(AGENT_SHEET_NAME);
        if (agentValues) {
          const agentRows = agentValues.slice(1);
          const currentUserAgent = agentRows.find(row => row[2] === currentUserId); // Cì—´: ì—°ë½ì²˜(ì•„ì´ë””)

          if (currentUserAgent) {
            const userRole = currentUserAgent[15] || ''; // Pì—´: ê¶Œí•œë ˆë²¨
            console.log(`ğŸ” [ì˜ˆì‚°ë°ì´í„°ì¡°íšŒ] ì‚¬ìš©ì ê¶Œí•œ í™•ì¸: ${currentUserId} â†’ ê¶Œí•œë ˆë²¨: ${userRole}`);

            // SS, S, AA, BB, CC, DD, EE, FF ê¶Œí•œì´ ìˆëŠ” ê²½ìš° ë‹¤ë¥¸ ì‚¬ìš©ì ë°ì´í„° ì¡°íšŒ í—ˆìš©
            if (['SS', 'S', 'AA', 'BB', 'CC', 'DD', 'EE', 'FF'].includes(userRole)) {
              canAccessOtherUserData = true;
              console.log(`âœ… [ì˜ˆì‚°ë°ì´í„°ì¡°íšŒ] ë‹¤ë¥¸ ì‚¬ìš©ì ë°ì´í„° ì¡°íšŒ ê¶Œí•œ ìˆìŒ: ${userRole}`);

              // ì˜ˆì‚°_ì‚¬ìš©ìì‹œíŠ¸ê´€ë¦¬ì—ì„œ ì‹¤ì œ ì‹œíŠ¸ ì†Œìœ ì í™•ì¸
              console.log('ğŸš¨ [TRACE] [ì˜ˆì‚°ë°ì´í„°ì¡°íšŒ] ì˜ˆì‚°_ì‚¬ìš©ìì‹œíŠ¸ê´€ë¦¬ ì½ê¸° ì‹œì‘:', new Date().toISOString());
              const userSheetManagementResponse = await sheets.spreadsheets.values.get({
                spreadsheetId: SPREADSHEET_ID,
                range: 'ì˜ˆì‚°_ì‚¬ìš©ìì‹œíŠ¸ê´€ë¦¬!A:G'
              });
              console.log('ğŸš¨ [TRACE] [ì˜ˆì‚°ë°ì´í„°ì¡°íšŒ] ì˜ˆì‚°_ì‚¬ìš©ìì‹œíŠ¸ê´€ë¦¬ ì½ê¸° ì™„ë£Œ:', new Date().toISOString());

              const userSheetManagementData = userSheetManagementResponse.data.values || [];
              if (userSheetManagementData.length > 1) {
                // í—¤ë” ì œì™¸í•˜ê³  í•´ë‹¹ ì‹œíŠ¸ IDë¡œ ì‹¤ì œ ì†Œìœ ì ì°¾ê¸°
                for (let i = 1; i < userSheetManagementData.length; i++) {
                  const row = userSheetManagementData[i];
                  if (row.length >= 6 && row[1] === sheetId) { // Bì—´: ì‹œíŠ¸ID
                    actualSheetOwner = row[4] || userName; // Eì—´: ìƒì„±ì (ì‹¤ì œ ì†Œìœ ì)
                    console.log(`ğŸ“‹ [ì˜ˆì‚°ë°ì´í„°ì¡°íšŒ] ì‹¤ì œ ì‹œíŠ¸ ì†Œìœ ì í™•ì¸: ${actualSheetOwner} (ì‹œíŠ¸ID: ${sheetId})`);
                    break;
                  }
                }
              }
            } else {
              console.log(`âŒ [ì˜ˆì‚°ë°ì´í„°ì¡°íšŒ] ê¶Œí•œ ë¶€ì¡±: ${userRole} (ì•¡ë©´ì˜ˆì‚°(â… ) ë‹¤ë¥¸ ì‚¬ìš©ì ì¡°íšŒ ê¶Œí•œ ì—†ìŒ)`);
            }
          } else {
            console.log(`âŒ [ì˜ˆì‚°ë°ì´í„°ì¡°íšŒ] ì‚¬ìš©ì ì •ë³´ ì—†ìŒ: ${currentUserId}`);
          }
        }
      } catch (error) {
        console.error('ê¶Œí•œ í™•ì¸ ì¤‘ ì˜¤ë¥˜:', error);
        // ê¶Œí•œ í™•ì¸ ì‹¤íŒ¨ ì‹œì—ë„ ê¸°ë³¸ ë¡œì§ ì§„í–‰ (ìì‹ ì˜ ë°ì´í„°ëŠ” ì¡°íšŒ ê°€ëŠ¥)
      }
    }

    // ì•¡ë©´ì˜ˆì‚°(â…¡)ì´ê±°ë‚˜ ê¶Œí•œì´ ì—†ëŠ” ê²½ìš°, ìš”ì²­ìì™€ ì‹œíŠ¸ ì†Œìœ ìê°€ ë‹¤ë¥´ë©´ ì ‘ê·¼ ê±°ë¶€
    if (budgetType === 'â…¡' || (!canAccessOtherUserData && actualSheetOwner !== userName)) {
      return res.status(403).json({
        error: 'í•´ë‹¹ ë°ì´í„°ì— ì ‘ê·¼í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.',
        details: budgetType === 'â…¡' ? 'ì•¡ë©´ì˜ˆì‚°(â…¡)ëŠ” ë³¸ì¸ ë°ì´í„°ë§Œ ì¡°íšŒ ê°€ëŠ¥í•©ë‹ˆë‹¤.' : 'ê¶Œí•œì´ ë¶€ì¡±í•©ë‹ˆë‹¤.'
      });
    }

    // ì‹¤ì œ ì‹œíŠ¸ ì†Œìœ ìì˜ ìê²© ì •ë³´ë¥¼ ëŒ€ë¦¬ì ì•„ì´ë””ê´€ë¦¬ì—ì„œ ê°€ì ¸ì˜¤ê¸°
    let userQualification = 'ì´ì‚¬'; // ê¸°ë³¸ê°’
    try {
      // ëŒ€ë¦¬ì ì•„ì´ë””ê´€ë¦¬ ì‹œíŠ¸ì—ì„œ ì†Œìœ ìì˜ ìê²© ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      const agentSheetResponse = await sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: AGENT_SHEET_NAME + '!A:B'
      });

      const agentValues = agentSheetResponse.data.values;
      if (agentValues && agentValues.length > 1) {
        const agentRows = agentValues.slice(1);
        // actualSheetOwnerì—ì„œ ì´ë¦„ë§Œ ì¶”ì¶œ (ì˜ˆ: "ê¹€ê¸°ì†¡ (ì˜ì—…ì‚¬ì›)" â†’ "ê¹€ê¸°ì†¡")
        const cleanOwnerName = actualSheetOwner.replace(/\([^)]+\)/, '').trim();
        const ownerAgent = agentRows.find(row => row[0] === cleanOwnerName); // Aì—´: ëŒ€ìƒ(ì´ë¦„)ìœ¼ë¡œ ê²€ìƒ‰
        if (ownerAgent) {
          userQualification = ownerAgent[1] || 'ì´ì‚¬'; // Bì—´: ìê²©
          console.log(`ğŸ“‹ [ì˜ˆì‚°ë°ì´í„°ì¡°íšŒ] ì‹œíŠ¸ ì†Œìœ ì ìê²© í™•ì¸: ${cleanOwnerName} â†’ ${userQualification}`);
        } else {
          console.log(`âš ï¸ [ì˜ˆì‚°ë°ì´í„°ì¡°íšŒ] ëŒ€ë¦¬ì ì•„ì´ë””ê´€ë¦¬ì—ì„œ ${cleanOwnerName} ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ ê¸°ë³¸ê°’ 'ì´ì‚¬' ì‚¬ìš©`);
        }
      }
    } catch (error) {
      console.error('ì‹œíŠ¸ ì†Œìœ ì ìê²© ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error);
    }

    // ì‹¤ì œ ì‹œíŠ¸ ì†Œìœ ì ì´ë¦„ì„ ì‚¬ìš©í•˜ì—¬ ì‹œíŠ¸ ì´ë¦„ êµ¬ì„±
    const baseUserName = actualSheetOwner.replace(/\([â… â…¡]\)/, '').replace(/\([^)]+\)/, '').trim();
    const requestedBudgetType = budgetType || 'â… '; // ìš”ì²­ëœ ì˜ˆì‚° íƒ€ì… ì‚¬ìš©

    const userSheetName = `ì•¡ë©´_${baseUserName}(${requestedBudgetType}) (${userQualification})`;

    console.log(`ğŸ“Š [ì˜ˆì‚°ë°ì´í„°ì¡°íšŒ] ì‹œíŠ¸ëª… êµ¬ì„±: ${userSheetName} (ì†Œìœ ì: ${actualSheetOwner}, íƒ€ì…: ${requestedBudgetType}, ìê²©: ${userQualification})`);

    // ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (A2:L) - ìƒˆë¡œìš´ í˜•ì‹ì— ë§ì¶° 12ê°œ ì»¬ëŸ¼
    const dataResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: sheetId,
      range: `${userSheetName}!A2:L`
    });

    // ë©”íƒ€ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (O1:X1) - ìƒˆë¡œìš´ 10ê°œ ì»¬ëŸ¼ êµ¬ì¡°
    const metadataResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: sheetId,
      range: `${userSheetName}!O1:X1`
    });

    const data = dataResponse.data.values || [];
    const metadata = metadataResponse.data.values || [];

    // ë°ì´í„° íŒŒì‹± - ìƒˆë¡œìš´ í˜•ì‹ì— ë§ì¶° ìˆ˜ì • (12ê°œ ì»¬ëŸ¼)
    const parsedData = data.map((row, index) => {
      if (row.length >= 12) {
        const [receiptStartDate, receiptEndDate, activationStartDate, activationEndDate, inputUserInfo, modelName, armyType, categoryType, securedBudget, usedBudget, remainingBudget, status] = row;

        // ì…ë ¥ì ì •ë³´ íŒŒì‹± (ì˜ˆ: "í™ê¸¸ë™(ë ˆë²¨3)" -> "í™ê¸¸ë™", "3")
        const userMatch = inputUserInfo.match(/^(.+?)\(ë ˆë²¨(\d+)\)$/);
        const inputUser = userMatch ? userMatch[1] : inputUserInfo;
        const userLevel = userMatch ? parseInt(userMatch[2]) : 1;

        // ìˆ«ì ê°’ íŒŒì‹± ê°œì„ 
        const parseBudgetValue = (value) => {
          if (!value || value === '') return 0;
          const parsed = parseFloat(value.toString().replace(/[^\d.-]/g, ''));
          return isNaN(parsed) ? 0 : parsed;
        };

        // ë””ë²„ê¹…ì„ ìœ„í•œ ë¡œê·¸ ì¶”ê°€
        console.log(`Row ${index + 2} parsing:`, {
          securedBudget: { original: securedBudget, parsed: parseBudgetValue(securedBudget) },
          usedBudget: { original: usedBudget, parsed: parseBudgetValue(usedBudget) },
          remainingBudget: { original: remainingBudget, parsed: parseBudgetValue(remainingBudget) }
        });

        return {
          id: `loaded-${index}`,
          receiptStartDate,
          receiptEndDate,
          activationStartDate,
          activationEndDate,
          inputUser,
          userLevel,
          modelName,
          armyType,
          categoryType,
          securedBudget: parseBudgetValue(securedBudget),
          usedBudget: parseBudgetValue(usedBudget),
          remainingBudget: parseBudgetValue(remainingBudget),
          status,
          budgetValue: parseBudgetValue(securedBudget) // ì›ë³¸ ì˜ˆì‚° ê°’
        };
      }
      return null;
    }).filter(item => item !== null);

    // ë©”íƒ€ë°ì´í„° íŒŒì‹± - ìƒˆë¡œìš´ 10ê°œ ì»¬ëŸ¼ êµ¬ì¡°
    let dateRange = {
      receiptStartDate: '',
      receiptEndDate: '',
      activationStartDate: '',
      activationEndDate: ''
    };

    if (metadata.length >= 2 && metadata[1].length >= 10) {
      // ìƒˆë¡œìš´ ë©”íƒ€ë°ì´í„° êµ¬ì¡°: [ì €ì¥ì¼ì‹œ, ì ‘ìˆ˜ì¼ë²”ìœ„, ê°œí†µì¼ë²”ìœ„, ì ‘ìˆ˜ì¼ì ìš©ì—¬ë¶€, ê³„ì‚°ì¼ì‹œ, ê³„ì‚°ì, ì •ì±…ê·¸ë£¹, ì”ì•¡, í™•ë³´, ì‚¬ìš©]
      const receiptRange = metadata[1][1] || ''; // Pì—´: ì ‘ìˆ˜ì¼ë²”ìœ„
      const activationRange = metadata[1][2] || ''; // Qì—´: ê°œí†µì¼ë²”ìœ„
      const applyReceiptDate = metadata[1][3] || ''; // Rì—´: ì ‘ìˆ˜ì¼ì ìš©ì—¬ë¶€
      const calculationDate = metadata[1][4] || ''; // Sì—´: ê³„ì‚°ì¼ì‹œ
      const calculator = metadata[1][5] || ''; // Tì—´: ê³„ì‚°ì
      const policyGroups = metadata[1][6] || ''; // Uì—´: ì •ì±…ê·¸ë£¹
      const totalRemaining = metadata[1][7] || ''; // Vì—´: ì”ì•¡
      const totalSecured = metadata[1][8] || ''; // Wì—´: í™•ë³´
      const totalUsed = metadata[1][9] || ''; // Xì—´: ì‚¬ìš©

      // "2024-01-01 ~ 2024-01-31" í˜•ì‹ íŒŒì‹±
      const receiptMatch = receiptRange.match(/^(.+?)\s*~\s*(.+)$/);
      const activationMatch = activationRange.match(/^(.+?)\s*~\s*(.+)$/);

      if (receiptMatch) {
        dateRange.receiptStartDate = receiptMatch[1].trim();
        dateRange.receiptEndDate = receiptMatch[2].trim();
      }

      if (activationMatch) {
        dateRange.activationStartDate = activationMatch[1].trim();
        dateRange.activationEndDate = activationMatch[2].trim();
      }

      console.log(`ğŸ“‹ [ë©”íƒ€ë°ì´í„°íŒŒì‹±] ìƒˆë¡œìš´ êµ¬ì¡°: ì ‘ìˆ˜ì¼=${receiptRange}, ê°œí†µì¼=${activationRange}, ì ìš©ì—¬ë¶€=${applyReceiptDate}, ê³„ì‚°ì=${calculator}, ì •ì±…ê·¸ë£¹=${policyGroups}`);
    }

    // ì •ì±…ê·¸ë£¹ ì •ë³´ ê°€ì ¸ì˜¤ê¸° - "ì˜ˆì‚°_ì‚¬ìš©ìì‹œíŠ¸ê´€ë¦¬" ì‹œíŠ¸ì—ì„œ
    let selectedPolicyGroups = [];
    try {
      // ìœ„ì—ì„œ ì´ë¯¸ ê°€ì ¸ì˜¨ userSheetManagementDataê°€ ìˆìœ¼ë©´ ì¬ì‚¬ìš©
      let userSheetManagementData = [];
      if (canAccessOtherUserData) {
        // ì´ë¯¸ ê¶Œí•œ í™•ì¸ ì‹œ ê°€ì ¸ì˜¨ ë°ì´í„° ì¬ì‚¬ìš©
        console.log('ğŸš¨ [TRACE] [ì •ì±…ê·¸ë£¹ì¡°íšŒ1] ì˜ˆì‚°_ì‚¬ìš©ìì‹œíŠ¸ê´€ë¦¬ ì½ê¸° ì‹œì‘:', new Date().toISOString());
        const userSheetManagementResponse = await sheets.spreadsheets.values.get({
          spreadsheetId: SPREADSHEET_ID,
          range: 'ì˜ˆì‚°_ì‚¬ìš©ìì‹œíŠ¸ê´€ë¦¬!A:G'
        });
        console.log('ğŸš¨ [TRACE] [ì •ì±…ê·¸ë£¹ì¡°íšŒ1] ì˜ˆì‚°_ì‚¬ìš©ìì‹œíŠ¸ê´€ë¦¬ ì½ê¸° ì™„ë£Œ:', new Date().toISOString());
        userSheetManagementData = userSheetManagementResponse.data.values || [];
      } else {
        console.log('ğŸš¨ [TRACE] [ì •ì±…ê·¸ë£¹ì¡°íšŒ2] ì˜ˆì‚°_ì‚¬ìš©ìì‹œíŠ¸ê´€ë¦¬ ì½ê¸° ì‹œì‘:', new Date().toISOString());
        const userSheetManagementResponse = await sheets.spreadsheets.values.get({
          spreadsheetId: SPREADSHEET_ID,
          range: 'ì˜ˆì‚°_ì‚¬ìš©ìì‹œíŠ¸ê´€ë¦¬!A:G'
        });
        console.log('ğŸš¨ [TRACE] [ì •ì±…ê·¸ë£¹ì¡°íšŒ2] ì˜ˆì‚°_ì‚¬ìš©ìì‹œíŠ¸ê´€ë¦¬ ì½ê¸° ì™„ë£Œ:', new Date().toISOString());
        userSheetManagementData = userSheetManagementResponse.data.values || [];
      }

      if (userSheetManagementData.length > 1) {
        // í—¤ë” ì œì™¸í•˜ê³  ë°ì´í„° ê²€ìƒ‰ - ì‹œíŠ¸ IDë¡œ ì°¾ê¸°
        for (let i = 1; i < userSheetManagementData.length; i++) {
          const row = userSheetManagementData[i];
          if (row.length >= 7 && row[1] === sheetId) { // Bì—´: ì‹œíŠ¸IDë¡œ ê²€ìƒ‰
            // Gì—´ì— ì •ì±…ê·¸ë£¹ ì •ë³´ê°€ ì €ì¥ë˜ì–´ ìˆìŒ
            const policyGroupsStr = row[6] || '';
            if (policyGroupsStr) {
              selectedPolicyGroups = policyGroupsStr.split(',').map(group => group.trim()).filter(group => group);
            }
            console.log(`ğŸ“‹ [ì˜ˆì‚°ë°ì´í„°ì¡°íšŒ] ì •ì±…ê·¸ë£¹ ì •ë³´ ë¡œë“œ: ${selectedPolicyGroups.join(', ')}`);
            break;
          }
        }
      }
    } catch (error) {
      console.error('ì •ì±…ê·¸ë£¹ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
      // ì •ì±…ê·¸ë£¹ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨ëŠ” ì „ì²´ API ì‹¤íŒ¨ë¡œ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
    }

    // ë‹¤ë¥¸ ì‚¬ìš©ì ë°ì´í„° ì¡°íšŒ ì‹œ ë¡œê·¸ ê¸°ë¡
    if (canAccessOtherUserData && actualSheetOwner !== userName) {
      console.log(`ğŸ“Š [ì ‘ê·¼ë¡œê·¸] ${currentUserId}ë‹˜ì´ ${actualSheetOwner}ë‹˜ì˜ ì˜ˆì‚° ë°ì´í„°ë¥¼ ì¡°íšŒí–ˆìŠµë‹ˆë‹¤. (ì‹œíŠ¸ID: ${sheetId}, íƒ€ì…: ${requestedBudgetType})`);
    }

    res.json({
      data: parsedData,
      dateRange,
      selectedPolicyGroups,
      metadata: metadata.length >= 2 ? metadata[1] : [],
      accessInfo: {
        originalRequester: userName,
        actualDataOwner: actualSheetOwner,
        accessedBy: currentUserId,
        isAccessedByOtherUser: canAccessOtherUserData && actualSheetOwner !== userName
      }
    });
  } catch (error) {
    console.error('ì˜ˆì‚° ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
    res.status(500).json({ error: 'ì˜ˆì‚° ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' });
  }
});

// ì •ì±… ì•Œë¦¼ ìƒì„± í•¨ìˆ˜
async function createPolicyNotification(policyId, userId, notificationType, approvalStatus = null) {
  try {
    const notificationId = `NOTI_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

    const notificationRow = [
      notificationId,           // Aì—´: ì•Œë¦¼ID
      policyId,                 // Bì—´: ì •ì±…ID
      notificationType,         // Cì—´: ì•Œë¦¼ìœ í˜•
      userId,                   // Dì—´: ëŒ€ìƒìID
      'ì½ì§€ì•ŠìŒ',               // Eì—´: ì½ìŒìƒíƒœ
      new Date().toISOString()  // Fì—´: ìƒì„±ì¼ì‹œ
    ];

    // ì‹œíŠ¸ì— ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
    const existingNotificationData = await getSheetValuesWithoutCache('ì •ì±…_ì•Œë¦¼ê´€ë¦¬');

    // í—¤ë” ì •ì˜
    const notificationHeaderRow = [
      'ì•Œë¦¼ID',           // Aì—´
      'ì •ì±…ID',           // Bì—´
      'ì•Œë¦¼ìœ í˜•',         // Cì—´
      'ëŒ€ìƒìID',         // Dì—´
      'ì½ìŒìƒíƒœ',         // Eì—´
      'ìƒì„±ì¼ì‹œ'          // Fì—´
    ];

    // ì‹œíŠ¸ê°€ ë¹„ì–´ìˆê±°ë‚˜ í—¤ë”ê°€ ì—†ìœ¼ë©´ í—¤ë”ì™€ í•¨ê»˜ ë°ì´í„° ì¶”ê°€
    if (!existingNotificationData || existingNotificationData.length === 0 ||
      !existingNotificationData[0] || existingNotificationData[0][0] !== 'ì•Œë¦¼ID') {
      console.log('ğŸ“ [ì•Œë¦¼ê´€ë¦¬] ì‹œíŠ¸ê°€ ë¹„ì–´ìˆê±°ë‚˜ í—¤ë”ê°€ ì—†ì–´ í—¤ë”ì™€ í•¨ê»˜ ë°ì´í„° ì¶”ê°€');
      await sheets.spreadsheets.values.append({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ì •ì±…_ì•Œë¦¼ê´€ë¦¬!A:F',
        valueInputOption: 'RAW',
        insertDataOption: 'INSERT_ROWS',
        resource: {
          values: [notificationHeaderRow, notificationRow]
        }
      });
    } else {
      // ê¸°ì¡´ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì•Œë¦¼ë§Œ ì¶”ê°€
      console.log('ğŸ“ [ì•Œë¦¼ê´€ë¦¬] ê¸°ì¡´ ë°ì´í„°ì— ì•Œë¦¼ ì¶”ê°€');
      await sheets.spreadsheets.values.append({
        spreadsheetId: SPREADSHEET_ID,
        range: 'ì •ì±…_ì•Œë¦¼ê´€ë¦¬!A:F',
        valueInputOption: 'RAW',
        insertDataOption: 'INSERT_ROWS',
        resource: {
          values: [notificationRow]
        }
      });
    }

    console.log('ì •ì±… ì•Œë¦¼ ìƒì„± ì™„ë£Œ:', notificationId);
  } catch (error) {
    console.error('ì •ì±… ì•Œë¦¼ ìƒì„± ì‹¤íŒ¨:', error);
  }
}

// ========================================
// ë§ˆê°ì¥í‘œ API
// ========================================

// ë§ˆê°ì¥í‘œ ë°ì´í„° ì¡°íšŒ API
app.get('/api/closing-chart', async (req, res) => {
  try {
    const { date } = req.query;
    const targetDate = date || new Date().toISOString().split('T')[0];

    console.log(`ë§ˆê°ì¥í‘œ ë°ì´í„° ì¡°íšŒ ì‹œì‘: ${targetDate}`);

    // í°í´ê°œí†µë°ì´í„° ìºì‹œ ë¬´íš¨í™” (BZì—´ ë°ì´í„° í¬í•¨í•˜ë„ë¡)
    invalidatePhoneklActivationCache();

    // ìºì‹œ í‚¤ ìƒì„±
    const cacheKey = `closing_chart_${targetDate}`;

    // ìºì‹œ í™•ì¸
    if (cache.has(cacheKey)) {
      console.log('ìºì‹œëœ ë§ˆê°ì¥í‘œ ë°ì´í„° ë°˜í™˜');
      return res.json(cache.get(cacheKey));
    }

    // í•„ìš”í•œ ì‹œíŠ¸ ë°ì´í„° ë¡œë“œ (ë³‘ë ¬ ì²˜ë¦¬)
    const [
      phoneklData,
      storeData,
      inventoryData,
      operationModelData,
      customerData,
      salesTargetData,
      phoneklHomeData
    ] = await Promise.all([
      getSheetValues('í°í´ê°œí†µë°ì´í„°'),
      getSheetValues('í°í´ì¶œê³ ì²˜ë°ì´í„°'),
      getSheetValues('í°í´ì¬ê³ ë°ì´í„°'),
      getSheetValues('ìš´ì˜ëª¨ë¸'),
      getSheetValues('ê±°ë˜ì²˜ì •ë³´'),
      getSheetValues('ì˜ì—…ì‚¬ì›ëª©í‘œ'),
      getSheetValues('í°í´í™ˆë°ì´í„°')
    ]);

    // ì œì™¸ ì¡°ê±´ ì„¤ì •
    const excludedAgents = getExcludedAgents(salesTargetData);
    const excludedStores = getExcludedStores(inventoryData);

    // ë°ì´í„° ì²˜ë¦¬
    const processedData = processClosingChartData({
      phoneklData,
      storeData,
      inventoryData,
      operationModelData,
      customerData,
      salesTargetData,
      phoneklHomeData,
      targetDate,
      excludedAgents,
      excludedStores
    });

    // ìºì‹œ ì €ì¥ (1ë¶„ìœ¼ë¡œ ë‹¨ì¶• - ë¹ ë¥¸ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´)
    cache.set(cacheKey, processedData, 60);

    console.log('ë§ˆê°ì¥í‘œ ë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ');
    res.json(processedData);

  } catch (error) {
    console.error('ë§ˆê°ì¥í‘œ ë°ì´í„° ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'ë§ˆê°ì¥í‘œ ë°ì´í„° ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
  }
});

// ì œì™¸ëœ ë‹´ë‹¹ì ëª©ë¡ ì¡°íšŒ
function getExcludedAgents(salesTargetData) {
  if (!salesTargetData || salesTargetData.length < 2) return [];

  const excluded = [];
  for (let i = 1; i < salesTargetData.length; i++) {
    const row = salesTargetData[i];
    if (row.length > 2 && row[2] === 'Y') { // Cì—´: ì œì™¸ì—¬ë¶€
      excluded.push(row[0]); // Aì—´: ë‹´ë‹¹ìëª…
    }
  }
  return excluded;
}

// ì œì™¸ëœ ì¶œê³ ì²˜ ëª©ë¡ ì¡°íšŒ
function getExcludedStores(inventoryData) {
  if (!inventoryData || inventoryData.length < 7) return [];

  const excluded = [];
  for (let i = 6; i < inventoryData.length; i++) { // E7:Eë¶€í„° ì‹œì‘
    const row = inventoryData[i];
    if (row.length > 4) {
      const storeName = (row[4] || '').toString(); // Eì—´
      if (storeName.includes('ì‚¬ë¬´ì‹¤') || storeName.includes('ê±°ë˜ì¢…ë£Œ') || storeName.includes('ë³¸ì íŒë§¤')) {
        excluded.push(storeName);
      }
    }
  }
  return excluded;
}

// ë§ˆê°ì¥í‘œ ë°ì´í„° ì²˜ë¦¬
function processClosingChartData({ phoneklData, storeData, inventoryData, operationModelData, customerData, salesTargetData, phoneklHomeData, targetDate, excludedAgents, excludedStores }) {
  // ìš´ì˜ëª¨ë¸ í•„í„°ë§ (íœ´ëŒ€í°ë§Œ)
  const phoneModels = new Set();

  if (operationModelData && operationModelData.length > 0) {
    operationModelData.forEach((row, index) => {
      if (row.length > 0) {
        const category = (row[0] || '').toString(); // Aì—´: êµ¬ë¶„ (íœ´ëŒ€í°/ì›Œì¹˜/TAB)
        const modelName = (row[2] || '').toString(); // Cì—´: ëª¨ë¸ëª…

        if (category === 'íœ´ëŒ€í°' && modelName) {
          phoneModels.add(modelName);
        }
      }
    });
  }

  // ê°œí†µ ë°ì´í„° í•„í„°ë§
  const dataRows = phoneklData.slice(3); // í—¤ë” ì œì™¸
  console.log('ğŸ” [CS ë””ë²„ê¹…] ì›ë³¸ ë°ì´í„° í–‰ ìˆ˜:', dataRows.length);

  let filteredCount = 0;
  let lengthFilteredCount = 0;
  let dateFilteredCount = 0;
  let modelFilteredCount = 0;
  let planFilteredCount = 0;
  let conditionFilteredCount = 0;
  let typeFilteredCount = 0;

  const filteredPhoneklData = dataRows.filter(row => {
    if (row.length < 10) {
      lengthFilteredCount++;
      return false;
    }

    const activationDate = (row[9] || '').toString(); // Jì—´: ê°œí†µì¼
    const model = (row[21] || '').toString(); // Vì—´: ëª¨ë¸ëª…
    const planType = (row[19] || '').toString(); // Tì—´: ìš”ê¸ˆì œ
    const condition = (row[12] || '').toString(); // Mì—´: ìƒíƒœ
    const type = (row[16] || '').toString(); // Qì—´: ìœ í˜•

    // ë‚ ì§œ í•„í„°ë§
    const targetDateObj = new Date(targetDate);
    const activationDateObj = new Date(activationDate);
    if (isNaN(activationDateObj.getTime()) || activationDateObj > targetDateObj) {
      dateFilteredCount++;
      return false;
    }

    // ëª¨ë¸ í•„í„°ë§ (íœ´ëŒ€í°ë§Œ)
    if (!phoneModels.has(model)) {
      modelFilteredCount++;
      return false;
    }

    // ì œì™¸ ì¡°ê±´
    if (planType.includes('ì„ ë¶ˆ')) {
      planFilteredCount++;
      return false;
    }
    if (condition.includes('ì¤‘ê³ ')) {
      conditionFilteredCount++;
      return false;
    }
    if (type.includes('ì¤‘ê³ ') || type.includes('ìœ ì‹¬')) {
      typeFilteredCount++;
      return false;
    }

    filteredCount++;
    return true;
  });

  console.log('ğŸ” [CS ë””ë²„ê¹…] í•„í„°ë§ ê²°ê³¼:');
  console.log('ğŸ” [CS ë””ë²„ê¹…] - ì›ë³¸ í–‰ ìˆ˜:', dataRows.length);
  console.log('ğŸ” [CS ë””ë²„ê¹…] - í•„í„°ë§ëœ í–‰ ìˆ˜:', filteredPhoneklData.length);
  console.log('ğŸ” [CS ë””ë²„ê¹…] - í–‰ ê¸¸ì´ ë¶€ì¡±ìœ¼ë¡œ ì œì™¸:', lengthFilteredCount);
  console.log('ğŸ” [CS ë””ë²„ê¹…] - ë‚ ì§œ ì¡°ê±´ìœ¼ë¡œ ì œì™¸:', dateFilteredCount);
  console.log('ğŸ” [CS ë””ë²„ê¹…] - ëª¨ë¸ ì¡°ê±´ìœ¼ë¡œ ì œì™¸:', modelFilteredCount);
  console.log('ğŸ” [CS ë””ë²„ê¹…] - ìš”ê¸ˆì œ ì¡°ê±´ìœ¼ë¡œ ì œì™¸:', planFilteredCount);
  console.log('ğŸ” [CS ë””ë²„ê¹…] - ìƒíƒœ ì¡°ê±´ìœ¼ë¡œ ì œì™¸:', conditionFilteredCount);
  console.log('ğŸ” [CS ë””ë²„ê¹…] - ìœ í˜• ì¡°ê±´ìœ¼ë¡œ ì œì™¸:', typeFilteredCount);

  // ì§€ì›ê¸ˆ ê³„ì‚°
  const supportBonusData = calculateSupportBonus(filteredPhoneklData, excludedAgents);

  // í†µí•© ë§¤ì¹­ í‚¤ ì‹œìŠ¤í…œìœ¼ë¡œ ë°ì´í„° ì§‘ê³„


  // ëª©í‘œê°’ ë°ì´í„° ì²˜ë¦¬
  const targets = new Map();
  if (salesTargetData && salesTargetData.length > 1) {
    salesTargetData.slice(1).forEach(row => {
      const agent = row[0] || '';
      const code = row[1] || '';
      const target = parseInt(row[2]) || 0;
      const excluded = row[3] === 'Y';
      const key = `${agent}|${code}`;
      targets.set(key, { agent, code, target, excluded });
    });
  }

  // í†µí•© ë§¤ì¹­ í‚¤ ë°ì´í„° ìƒì„±
  const { matchingKeyMap, matchingMismatches } = createUnifiedMatchingKeyData(filteredPhoneklData, storeData, inventoryData, excludedAgents, excludedStores, targets, customerData);

  // ê° ì§‘ê³„ë³„ë¡œ ë°ì´í„° ì¶”ì¶œ (Map.values()ë¡œ ë°°ì—´ ë³€í™˜)
  const codeData = aggregateByCodeFromUnified(Array.from(matchingKeyMap.values()), supportBonusData.codeSupportMap);
  const officeData = aggregateByOfficeFromUnified(Array.from(matchingKeyMap.values()), supportBonusData.officeSupportMap);
  const departmentData = aggregateByDepartmentFromUnified(Array.from(matchingKeyMap.values()), supportBonusData.departmentSupportMap);
  const agentData = aggregateByAgentFromUnified(Array.from(matchingKeyMap.values()), supportBonusData.agentSupportMap);



  // CS ê°œí†µ ìš”ì•½
  const csSummary = calculateCSSummary(filteredPhoneklData, phoneklHomeData, targetDate, phoneModels, excludedAgents);

  // ë§¤í•‘ ì‹¤íŒ¨ ë°ì´í„°
  const mappingFailures = findMappingFailures(filteredPhoneklData, storeData);



  return {
    date: targetDate,
    codeData,
    officeData,
    departmentData,
    agentData,
    csSummary,
    mappingFailures,
    excludedAgents,
    excludedStores,
    matchingMismatches // ë§¤ì¹­ ë¶ˆì¼ì¹˜ ë°ì´í„° ì¶”ê°€
  };
}

// í†µí•© ë§¤ì¹­ í‚¤ ìƒì„± í•¨ìˆ˜
function createMatchingKey(row) {
  const agent = (row[8] || '').toString();        // Iì—´: ë‹´ë‹¹ì
  const department = (row[7] || '').toString();   // Hì—´: ì†Œì†
  const office = (row[6] || '').toString();       // Gì—´: ì‚¬ë¬´ì‹¤
  const code = (row[4] || '').toString();         // Eì—´: ì½”ë“œëª…

  return `${agent}|${department}|${office}|${code}`;
}

// í†µí•© ë§¤ì¹­ í‚¤ ë°ì´í„° ìƒì„±
function createUnifiedMatchingKeyData(phoneklData, storeData, inventoryData, excludedAgents, excludedStores, targets, customerData) {
  const matchingKeyMap = new Map();

  // 1ë‹¨ê³„: ê°œí†µ ë°ì´í„°ë¡œ ê¸°ë³¸ ì •ë³´ ìƒì„±
  phoneklData.forEach(row => {
    const agent = (row[8] || '').toString();
    if (excludedAgents.includes(agent)) return;

    const key = createMatchingKey(row);

    if (!matchingKeyMap.has(key)) {
      matchingKeyMap.set(key, {
        agent: row[8],           // Iì—´: ë‹´ë‹¹ì
        department: row[7],      // Hì—´: ì†Œì†
        office: row[6],          // Gì—´: ì‚¬ë¬´ì‹¤
        code: row[4],            // Eì—´: ì½”ë“œ
        performance: 0,           // ê°œí†µ ê±´ìˆ˜
        fee: 0,                  // ìˆ˜ìˆ˜ë£Œ
        registeredStores: 0,     // ë“±ë¡ì 
        activeStores: 0,         // ê°€ë™ì 
        devices: 0,              // ë³´ìœ ë‹¨ë§
        sims: 0,                 // ë³´ìœ ìœ ì‹¬
        target: 0,               // ëª©í‘œê°’
        support: 0               // ì§€ì›ê¸ˆ
      });
    }

    const data = matchingKeyMap.get(key);
    data.performance++;

    // ìˆ˜ìˆ˜ë£Œ ì²˜ë¦¬
    const rawFee = row[3];
    if (rawFee && rawFee !== '#N/A' && rawFee !== 'N/A') {
      data.fee += parseFloat(rawFee) || 0;
    }
  });

  // 2ë‹¨ê³„: ëª©í‘œê°’ ì ìš©
  targets.forEach((targetInfo, targetKey) => {
    if (targetInfo.excluded) return;

    // í•´ë‹¹ ë‹´ë‹¹ì-ì½”ë“œ ì¡°í•©ì— ëª©í‘œê°’ ì ìš©
    matchingKeyMap.forEach((data, key) => {
      if (data.agent === targetInfo.agent && data.code === targetInfo.code) {
        data.target += targetInfo.target;
      }
    });
  });

  // 3ë‹¨ê³„: ì¶œê³ ì²˜ ë°ì´í„°ë¡œ ë“±ë¡ì  ê³„ì‚° (ê±°ë˜ì²˜ì •ë³´ ê¸°ë°˜)
  console.log('ğŸ” [ë””ë²„ê¹…] customerData í™•ì¸:', {
    customerDataExists: !!customerData,
    customerDataLength: customerData ? customerData.length : 'undefined',
    customerDataSample: customerData && customerData.length > 0 ? customerData[0] : 'empty'
  });

  // ë§¤ì¹­ ë¶ˆì¼ì¹˜ ë°ì´í„° ìˆ˜ì§‘
  const matchingMismatches = [];

  if (storeData && customerData && customerData.length > 0) {
    // ê° ë§¤ì¹­í‚¤ë³„ë¡œ ì •í™•í•œ ì¶œê³ ì²˜ ì°¾ê¸°
    matchingKeyMap.forEach((data, key) => {
      const matchingStores = new Set();

      // ê¹€ìˆ˜ë¹ˆ ì „ìš© ë””ë²„ê¹…: customerData ì „ì²´ í™•ì¸
      if (data.agent === 'ê¹€ìˆ˜ë¹ˆ') {
        console.log('ğŸ” [ê¹€ìˆ˜ë¹ˆ] customerData ì „ì²´ í™•ì¸:', {
          customerDataLength: customerData.length,
          customerDataSample: customerData.slice(0, 5).map(row => ({
            ë‹´ë‹¹ì: row[3] || 'undefined',
            ì½”ë“œ: row[1] || 'undefined',
            ì¶œê³ ì²˜: row[2] || 'undefined'
          }))
        });
      }

      // ê±°ë˜ì²˜ì •ë³´ì—ì„œ í•´ë‹¹ ë§¤ì¹­í‚¤(ë‹´ë‹¹ì+ì½”ë“œ)ì— í•´ë‹¹í•˜ëŠ” ì¶œê³ ì²˜ ì°¾ê¸°
      customerData.forEach(ê±°ë˜ì²˜Row => {
        if (ê±°ë˜ì²˜Row.length > 3) {
          const ê±°ë˜ì²˜ì½”ë“œ = (ê±°ë˜ì²˜Row[1] || '').toString(); // Bì—´: ì½”ë“œëª…
          const ê±°ë˜ì²˜ì¶œê³ ì²˜ = (ê±°ë˜ì²˜Row[2] || '').toString(); // Cì—´: ì¶œê³ ì²˜ëª…
          const ê±°ë˜ì²˜ë‹´ë‹¹ì = (ê±°ë˜ì²˜Row[3] || '').toString().replace(/\([^)]*\)/g, ''); // Dì—´: ë‹´ë‹¹ìëª… (ê´„í˜¸ì™€ ë‚´ìš© ëª¨ë‘ ì œê±°)

          // ê¹€ìˆ˜ë¹ˆ ì „ìš© ë””ë²„ê¹…: ì§€ìš°ëª¨ë°”ì¼ ê´€ë ¨ë§Œ ë¡œê·¸ ì¶œë ¥
          if (data.agent === 'ê¹€ìˆ˜ë¹ˆ' && ê±°ë˜ì²˜ì¶œê³ ì²˜.includes('ì§€ìš°ëª¨ë°”ì¼')) {
            console.log('ğŸ” [ê¹€ìˆ˜ë¹ˆ] ì§€ìš°ëª¨ë°”ì¼ ë§¤ì¹­ ì¡°ê±´ í™•ì¸:', {
              ê±°ë˜ì²˜ë‹´ë‹¹ì,
              dataAgent: data.agent,
              ê±°ë˜ì²˜ì½”ë“œ,
              dataCode: data.code,
              ê±°ë˜ì²˜ì¶œê³ ì²˜,
              ë‹´ë‹¹ìë§¤ì¹­: ê±°ë˜ì²˜ë‹´ë‹¹ì === data.agent,
              ì½”ë“œë§¤ì¹­: ê±°ë˜ì²˜ì½”ë“œ === data.code,
              ì¶œê³ ì²˜ì¡´ì¬: !!ê±°ë˜ì²˜ì¶œê³ ì²˜
            });
          }

          // í•´ë‹¹ ë§¤ì¹­í‚¤ì™€ ì •í™•íˆ ë§¤ì¹­ë˜ëŠ” ë°ì´í„°ë§Œ ì²˜ë¦¬
          if (ê±°ë˜ì²˜ë‹´ë‹¹ì === data.agent && ê±°ë˜ì²˜ì½”ë“œ === data.code && ê±°ë˜ì²˜ì¶œê³ ì²˜) {

            // ê¹€ìˆ˜ë¹ˆ ì „ìš© ìƒì„¸ ë””ë²„ê¹…
            if (data.agent === 'ê¹€ìˆ˜ë¹ˆ') {
              console.log('ğŸ” [ê¹€ìˆ˜ë¹ˆ] ê±°ë˜ì²˜ì •ë³´ ë§¤ì¹­ ì„±ê³µ:', {
                ê±°ë˜ì²˜ë‹´ë‹¹ì,
                ê±°ë˜ì²˜ì½”ë“œ,
                ê±°ë˜ì²˜ì¶œê³ ì²˜,
                ë§¤ì¹­í‚¤: key
              });
            }

            // í°í´ì¶œê³ ì²˜ë°ì´í„°ì—ì„œ í•´ë‹¹ ì¶œê³ ì²˜ê°€ ë“±ë¡ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸ (ì½”ë“œëª…ê¹Œì§€ ë§¤ì¹­)
            const isRegistered = storeData.some(storeRow => {
              if (storeRow.length > 21) {
                const storeAgent = (storeRow[21] || '').toString().replace(/\([^)]*\)/g, ''); // Vì—´: ë‹´ë‹¹ì (ê´„í˜¸ì™€ ë‚´ìš© ëª¨ë‘ ì œê±°)
                const storeCodeName = (storeRow[7] || '').toString(); // Hì—´: ì½”ë“œëª…
                const storeCode = (storeRow[14] || '').toString(); // Oì—´: ì¶œê³ ì²˜ì½”ë“œ

                // ë‹´ë‹¹ìëª… ë§¤ì¹­: ì •í™•íˆ ì¼ì¹˜í•˜ê±°ë‚˜ í¬í•¨ ê´€ê³„
                const agentMatches = storeAgent === ê±°ë˜ì²˜ë‹´ë‹¹ì ||
                  storeAgent.includes(ê±°ë˜ì²˜ë‹´ë‹¹ì) ||
                  ê±°ë˜ì²˜ë‹´ë‹¹ì.includes(storeAgent);

                // ê¹€ìˆ˜ë¹ˆ ì „ìš© ë””ë²„ê¹…: ë§¤ì¹­ ê³¼ì • ìƒì„¸ ì¶”ì 
                if (data.agent === 'ê¹€ìˆ˜ë¹ˆ') {
                  console.log('ğŸ” [ê¹€ìˆ˜ë¹ˆ] ë§¤ì¹­ ê³¼ì • ìƒì„¸:', {
                    ì¶œê³ ì²˜: ê±°ë˜ì²˜ì¶œê³ ì²˜,
                    ê±°ë˜ì²˜ë‹´ë‹¹ì,
                    ê±°ë˜ì²˜ì½”ë“œ,
                    storeCode,
                    storeAgent,
                    storeCodeName,
                    agentMatches,
                    codeMatches: storeCode === ê±°ë˜ì²˜ì¶œê³ ì²˜,
                    nameMatches: storeCodeName === ê±°ë˜ì²˜ì½”ë“œ
                  });
                }

                return storeCode === ê±°ë˜ì²˜ì¶œê³ ì²˜ && agentMatches && storeCodeName === ê±°ë˜ì²˜ì½”ë“œ;
              }
              return false;
            });

            if (isRegistered) {
              matchingStores.add(ê±°ë˜ì²˜ì¶œê³ ì²˜);

              // ê¹€ìˆ˜ë¹ˆ ì „ìš© ë””ë²„ê¹…: ë§¤ì¹­ ì„±ê³µ
              if (data.agent === 'ê¹€ìˆ˜ë¹ˆ') {
                console.log('ğŸ” [ê¹€ìˆ˜ë¹ˆ] í°í´ì¶œê³ ì²˜ë°ì´í„° ë§¤ì¹­ ì„±ê³µ:', {
                  ì¶œê³ ì²˜: ê±°ë˜ì²˜ì¶œê³ ì²˜,
                  ê±°ë˜ì²˜ë‹´ë‹¹ì,
                  ê±°ë˜ì²˜ì½”ë“œ
                });
              }
            } else {
              // ë§¤ì¹­ ë¶ˆì¼ì¹˜ ë°ì´í„° ìˆ˜ì§‘
              const storeMismatch = storeData.find(row =>
                row.length > 21 && (row[14] || '').toString() === ê±°ë˜ì²˜ì¶œê³ ì²˜
              );

              if (storeMismatch) {
                const storeAgent = (storeMismatch[21] || '').toString();
                const storeCodeName = (storeMismatch[7] || '').toString();

                matchingMismatches.push({
                  type: 'ì¶œê³ ì²˜',
                  ê±°ë˜ì²˜ì •ë³´: {
                    ë‹´ë‹¹ì: ê±°ë˜ì²˜ë‹´ë‹¹ì,
                    ì½”ë“œ: ê±°ë˜ì²˜ì½”ë“œ,
                    ì¶œê³ ì²˜: ê±°ë˜ì²˜ì¶œê³ ì²˜
                  },
                  í°í´ì¶œê³ ì²˜ë°ì´í„°: {
                    ë‹´ë‹¹ì: storeAgent,
                    ì½”ë“œ: storeCodeName,
                    ì¶œê³ ì²˜: (storeMismatch[14] || '').toString()
                  }
                });
              }

              // ê¹€ìˆ˜ë¹ˆ ì „ìš© ë””ë²„ê¹…: ë§¤ì¹­ ì‹¤íŒ¨ ì›ì¸ í™•ì¸
              if (data.agent === 'ê¹€ìˆ˜ë¹ˆ') {
                console.log('ğŸ” [ê¹€ìˆ˜ë¹ˆ] ì¶œê³ ì²˜ ë§¤ì¹­ ì‹¤íŒ¨:', {
                  ê±°ë˜ì²˜ì¶œê³ ì²˜: ê±°ë˜ì²˜ì¶œê³ ì²˜,
                  ê±°ë˜ì²˜ë‹´ë‹¹ì: ê±°ë˜ì²˜ë‹´ë‹¹ì,
                  í°í´ì¶œê³ ì²˜ë°ì´í„°_ë‹´ë‹¹ìë“¤: storeData
                    .filter(row => row.length > 21 && (row[14] || '').toString() === ê±°ë˜ì²˜ì¶œê³ ì²˜)
                    .map(row => (row[21] || '').toString())
                });
              }
            }
          }
        }
      });

      data.registeredStores = matchingStores.size;

      // ê°€ë™ì  ê³„ì‚° (ë“±ë¡ì  ì¤‘ì—ì„œ ê°œí†µ ì‹¤ì ì´ ìˆëŠ” ì¶œê³ ì²˜)
      let activeCount = 0;
      matchingStores.forEach(storeCode => {
        const hasPerformance = phoneklData.some(performanceRow => {
          if (performanceRow.length > 14) {
            const performanceStoreCode = (performanceRow[14] || '').toString(); // Oì—´: ì¶œê³ ì²˜
            const performanceAgent = (performanceRow[8] || '').toString(); // Iì—´: ë‹´ë‹¹ì
            const performanceDepartment = (performanceRow[7] || '').toString(); // Hì—´: ì†Œì†
            const performanceOffice = (performanceRow[6] || '').toString(); // Gì—´: ì‚¬ë¬´ì‹¤
            const performanceCode = (performanceRow[4] || '').toString(); // Eì—´: ì½”ë“œ

            // ì½”ë“œê°€ ë¹„ì–´ìˆê±°ë‚˜ ë‹´ë‹¹ìê°€ ë¹„ì–´ìˆìœ¼ë©´ ì œì™¸
            if (!performanceCode.trim() || !performanceAgent.trim()) return false;

            // í•´ë‹¹ ë§¤ì¹­í‚¤ì™€ ì •í™•íˆ ë§¤ì¹­ë˜ê³ , ë“±ë¡ì ì— í¬í•¨ëœ ì¶œê³ ì²˜ì¸ì§€ í™•ì¸
            return performanceStoreCode === storeCode &&
              performanceAgent === data.agent &&
              performanceDepartment === data.department &&
              performanceOffice === data.office &&
              performanceCode === data.code;
          }
          return false;
        });

        if (hasPerformance) {
          activeCount++;
        }
      });
      data.activeStores = activeCount;

      // ê¹€ìˆ˜ë¹ˆ ì „ìš© ë””ë²„ê¹…: ì¶œê³ ì²˜ ê²°ê³¼ í™•ì¸
      if (data.agent === 'ê¹€ìˆ˜ë¹ˆ') {
        console.log('ğŸ” [ê¹€ìˆ˜ë¹ˆ] ì¶œê³ ì²˜ ê²°ê³¼:', {
          ë§¤ì¹­í‚¤: key,
          ë“±ë¡ì : data.registeredStores,
          ê°€ë™ì : data.activeStores,
          ì¶œê³ ì²˜ëª©ë¡: Array.from(matchingStores)
        });
      }
    });
  }

  // ë§¤ì¹­ ë¶ˆì¼ì¹˜ ë°ì´í„° ë¡œê·¸ ì¶œë ¥
  if (matchingMismatches.length > 0) {
    // ë§¤ì¹­ ë¶ˆì¼ì¹˜ ë°ì´í„° ìˆ˜ì§‘ ì™„ë£Œ (ë¡œê·¸ ì œê±°)
  }

  // 4ë‹¨ê³„: ì¬ê³  ë°ì´í„°ë¡œ ë³´ìœ ë‹¨ë§/ìœ ì‹¬ ê³„ì‚° (ê±°ë˜ì²˜ì •ë³´ ê¸°ë°˜)
  if (inventoryData && customerData && customerData.length > 0) {
    // ê° ë§¤ì¹­í‚¤ë³„ë¡œ ì •í™•í•œ ì¬ê³  ì°¾ê¸°
    matchingKeyMap.forEach((data, key) => {
      let devices = 0;
      let sims = 0;

      // ê±°ë˜ì²˜ì •ë³´ì—ì„œ í•´ë‹¹ ë§¤ì¹­í‚¤(ë‹´ë‹¹ì+ì½”ë“œ)ì— í•´ë‹¹í•˜ëŠ” ì¶œê³ ì²˜ ì°¾ê¸°
      customerData.forEach(ê±°ë˜ì²˜Row => {
        if (ê±°ë˜ì²˜Row.length > 3) {
          const ê±°ë˜ì²˜ì½”ë“œ = (ê±°ë˜ì²˜Row[1] || '').toString(); // Bì—´: ì½”ë“œëª…
          const ê±°ë˜ì²˜ì¶œê³ ì²˜ = (ê±°ë˜ì²˜Row[2] || '').toString(); // Cì—´: ì¶œê³ ì²˜ëª…
          const ê±°ë˜ì²˜ë‹´ë‹¹ì = (ê±°ë˜ì²˜Row[3] || '').toString().replace(/\([^)]*\)/g, ''); // Dì—´: ë‹´ë‹¹ìëª… (ê´„í˜¸ì™€ ë‚´ìš© ëª¨ë‘ ì œê±°)

          // í•´ë‹¹ ë§¤ì¹­í‚¤ì™€ ì •í™•íˆ ë§¤ì¹­ë˜ëŠ” ë°ì´í„°ë§Œ ì²˜ë¦¬
          if (ê±°ë˜ì²˜ë‹´ë‹¹ì === data.agent && ê±°ë˜ì²˜ì½”ë“œ === data.code && ê±°ë˜ì²˜ì¶œê³ ì²˜) {
            // í°í´ì¬ê³ ë°ì´í„°ì—ì„œ í•´ë‹¹ ì¶œê³ ì²˜ì˜ ì¬ê³  ì°¾ê¸° (ì½”ë“œëª…ê¹Œì§€ ë§¤ì¹­)
            inventoryData.forEach(inventoryRow => {
              if (inventoryRow.length > 8) {
                const inventoryAgent = (inventoryRow[8] || '').toString().replace(/\([^)]*\)/g, ''); // Iì—´: ë‹´ë‹¹ì (ê´„í˜¸ì™€ ë‚´ìš© ëª¨ë‘ ì œê±°)
                const inventoryCodeName = (inventoryRow[3] || '').toString(); // Dì—´: ì½”ë“œëª…
                const inventoryType = (inventoryRow[12] || '').toString(); // Mì—´: ìœ í˜•
                const inventoryStore = (inventoryRow[21] || '').toString(); // Vì—´: ì¶œê³ ì²˜

                if (excludedAgents.includes(inventoryAgent)) return;
                if (excludedStores.includes(inventoryStore)) return;

                // í•´ë‹¹ ë§¤ì¹­í‚¤ì™€ ì •í™•íˆ ë§¤ì¹­ë˜ëŠ” ì¬ê³ ë§Œ ì¶”ê°€ (ì½”ë“œëª…ê¹Œì§€ í™•ì¸)
                // ë‹´ë‹¹ìëª… ë§¤ì¹­: ì •í™•íˆ ì¼ì¹˜í•˜ê±°ë‚˜ í¬í•¨ ê´€ê³„
                const agentMatches = inventoryAgent === ê±°ë˜ì²˜ë‹´ë‹¹ì ||
                  inventoryAgent.includes(ê±°ë˜ì²˜ë‹´ë‹¹ì) ||
                  ê±°ë˜ì²˜ë‹´ë‹¹ì.includes(inventoryAgent);

                if (agentMatches && inventoryStore === ê±°ë˜ì²˜ì¶œê³ ì²˜ && inventoryCodeName === ê±°ë˜ì²˜ì½”ë“œ) {
                  if (inventoryType === 'ìœ ì‹¬') {
                    sims++;
                  } else {
                    devices++;
                  }
                }
              }
            });
          }
        }
      });

      data.devices = devices;
      data.sims = sims;

      // ê¹€ìˆ˜ë¹ˆ ì „ìš© ë””ë²„ê¹…: ì¬ê³  ê²°ê³¼ í™•ì¸
      if (data.agent === 'ê¹€ìˆ˜ë¹ˆ') {
        console.log('ğŸ” [ê¹€ìˆ˜ë¹ˆ] ì¬ê³  ê²°ê³¼:', {
          ë§¤ì¹­í‚¤: key,
          ë³´ìœ ë‹¨ë§: data.devices,
          ë³´ìœ ìœ ì‹¬: data.sims
        });
      }
    });
  }

  // 5ë‹¨ê³„: ì¶”ê°€ ê³„ì‚°
  const today = new Date();
  const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();

  matchingKeyMap.forEach(data => {
    data.expectedClosing = Math.round(data.performance / today.getDate() * daysInMonth);
    data.achievement = data.target > 0 ? Math.round((data.expectedClosing / data.target) * 100) : 0;
    data.utilization = data.registeredStores > 0 ? Math.round((data.activeStores / data.registeredStores) * 100) : 0;
    data.rotation = (data.expectedClosing + data.devices) > 0 ? Math.round((data.expectedClosing / (data.expectedClosing + data.devices)) * 100) : 0;
  });


  return { matchingKeyMap, matchingMismatches };
}

// ì§€ì›ê¸ˆ ê³„ì‚° í•¨ìˆ˜
function calculateSupportBonus(phoneklData, excludedAgents) {
  // 1ë‹¨ê³„: ë‹´ë‹¹ìë³„ ì´ìˆ˜ìˆ˜ë£Œ ì§‘ê³„ (ì¡°í•©ë³„)
  const agentCombinationMap = new Map();

  phoneklData.forEach(row => {
    const agent = (row[8] || '').toString(); // Iì—´: ë‹´ë‹¹ì
    const code = (row[4] || '').toString(); // Eì—´: ì½”ë“œ
    const office = (row[6] || '').toString(); // Gì—´: ì‚¬ë¬´ì‹¤
    const department = (row[7] || '').toString(); // Hì—´: ì†Œì†

    if (!agent || excludedAgents.includes(agent)) return;

    const combinationKey = `${agent}|${code}|${office}|${department}`;

    // #N/A ê°’ ì²˜ë¦¬
    const rawFee = row[3];
    let fee = 0;

    if (rawFee && rawFee !== '#N/A' && rawFee !== 'N/A') {
      fee = parseFloat(rawFee) || 0;
    }

    if (!agentCombinationMap.has(combinationKey)) {
      agentCombinationMap.set(combinationKey, {
        agent,
        code,
        office,
        department,
        fee: 0
      });
    }

    agentCombinationMap.get(combinationKey).fee += fee;
  });

  // 2ë‹¨ê³„: ë‹´ë‹¹ìë³„ ì´ìˆ˜ìˆ˜ë£Œ ì§‘ê³„
  const agentTotalMap = new Map();

  agentCombinationMap.forEach((data, key) => {
    const agent = data.agent;

    if (!agentTotalMap.has(agent)) {
      agentTotalMap.set(agent, {
        agent,
        totalFee: 0,
        combinations: []
      });
    }

    agentTotalMap.get(agent).totalFee += data.fee;
    agentTotalMap.get(agent).combinations.push(data);
  });

  // 3ë‹¨ê³„: ë‹´ë‹¹ìë³„ ì´ìˆ˜ìˆ˜ë£Œ ê¸°ì¤€ ìƒìœ„ 1~5ìœ„ ì„ ì •
  const sortedAgents = Array.from(agentTotalMap.values())
    .sort((a, b) => b.totalFee - a.totalFee)
    .slice(0, 5);

  // 4ë‹¨ê³„: ê° ì¡°í•©ë³„ ì§€ì›ê¸ˆ ê³„ì‚°
  const supportRates = [0.10, 0.08, 0.06, 0.04, 0.02]; // 10%, 8%, 6%, 4%, 2%

  sortedAgents.forEach((agentData, index) => {
    const supportRate = supportRates[index];

    agentData.combinations.forEach(combination => {
      combination.support = combination.fee * supportRate;
    });
  });

  // 5ë‹¨ê³„: ê·¸ë£¹ë³„ ì§€ì›ê¸ˆ í•©ê³„ ê³„ì‚°
  const officeSupportMap = new Map();
  const departmentSupportMap = new Map();
  const agentSupportMap = new Map();
  const codeSupportMap = new Map();

  agentCombinationMap.forEach((data, key) => {
    const support = data.support || 0;

    // ì½”ë“œë³„ í•©ê³„
    if (data.code) {
      if (!codeSupportMap.has(data.code)) {
        codeSupportMap.set(data.code, 0);
      }
      codeSupportMap.set(data.code, codeSupportMap.get(data.code) + support);
    }

    // ì‚¬ë¬´ì‹¤ë³„ í•©ê³„
    if (data.office) {
      if (!officeSupportMap.has(data.office)) {
        officeSupportMap.set(data.office, 0);
      }
      officeSupportMap.set(data.office, officeSupportMap.get(data.office) + support);
    }

    // ì†Œì†ë³„ í•©ê³„
    if (data.department) {
      if (!departmentSupportMap.has(data.department)) {
        departmentSupportMap.set(data.department, 0);
      }
      departmentSupportMap.set(data.department, departmentSupportMap.get(data.department) + support);
    }

    // ë‹´ë‹¹ìë³„ í•©ê³„
    if (data.agent) {
      if (!agentSupportMap.has(data.agent)) {
        agentSupportMap.set(data.agent, 0);
      }
      agentSupportMap.set(data.agent, agentSupportMap.get(data.agent) + support);
    }
  });



  return {
    codeSupportMap,
    officeSupportMap,
    departmentSupportMap,
    agentSupportMap
  };
}

// ì½”ë“œë³„ ì§‘ê³„


// ì‚¬ë¬´ì‹¤ë³„ ì§‘ê³„
function aggregateByOffice(phoneklData, storeData, inventoryData, excludedAgents, excludedStores, officeSupportMap, targets, filteredPhoneklData) {


  const officeMap = new Map();

  phoneklData.forEach(row => {
    const office = (row[6] || '').toString(); // Gì—´: ì‚¬ë¬´ì‹¤
    const agent = (row[8] || '').toString(); // Iì—´: ë‹´ë‹¹ì

    if (!office || excludedAgents.includes(agent)) return;

    if (!officeMap.has(office)) {
      officeMap.set(office, {
        office,
        performance: 0,
        fee: 0,
        support: 0,
        target: 0,
        achievement: 0,
        expectedClosing: 0,
        rotation: 0
      });
    }

    const data = officeMap.get(office);
    data.performance++;

    // #N/A ê°’ ì²˜ë¦¬
    const rawFee = row[3];
    let fee = 0;

    if (rawFee && rawFee !== '#N/A' && rawFee !== 'N/A') {
      fee = parseFloat(rawFee) || 0;
    }

    data.fee += fee;
  });





  // ì¶”ê°€ ê³„ì‚°
  const today = new Date();
  const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();

  officeMap.forEach(data => {
    data.expectedClosing = Math.round(data.performance / today.getDate() * daysInMonth);

    // ëª©í‘œê°’ ì ìš© (í•´ë‹¹ ì‚¬ë¬´ì‹¤ì˜ ëª¨ë“  ë‹´ë‹¹ì-ì½”ë“œ ì¡°í•© ëª©í‘œê°’ í•©ê³„)
    let totalTarget = 0;
    targets.forEach((targetInfo, key) => {
      if (!targetInfo.excluded) {
        // í•´ë‹¹ ì‚¬ë¬´ì‹¤ì˜ ë‹´ë‹¹ìì¸ì§€ í™•ì¸
        const agentData = phoneklData.find(row =>
          (row[8] || '').toString() === targetInfo.agent &&
          (row[6] || '').toString() === data.office
        );
        if (agentData) {
          totalTarget += targetInfo.target;
        }
      }
    });
    data.target = totalTarget;

    data.achievement = data.target > 0 ? Math.round((data.expectedClosing / data.target) * 100) : 0;

    // ë“±ë¡ì , ê°€ë™ì , ë³´ìœ ë‹¨ë§, ë³´ìœ ìœ ì‹¬ ê³„ì‚° (ë‹´ë‹¹ìë³„ ë°©ì‹ìœ¼ë¡œ í†µì¼)
    let totalRegisteredStores = 0;
    let totalActiveStores = 0;
    let totalDevices = 0;
    let totalSims = 0;

    // í•´ë‹¹ ì‚¬ë¬´ì‹¤ì˜ ëª¨ë“  ë‹´ë‹¹ìë“¤ì˜ ê³ ìœ  ì¶œê³ ì²˜ ëª©ë¡ ìƒì„±
    const agentStores = new Map(); // ë‹´ë‹¹ìë³„ ê³ ìœ  ì¶œê³ ì²˜ ëª©ë¡
    const agentInventory = new Map(); // ë‹´ë‹¹ìë³„ ì¬ê³  ë°ì´í„°

    // 1ë‹¨ê³„: í•´ë‹¹ ì‚¬ë¬´ì‹¤ì˜ ë‹´ë‹¹ìë“¤ì˜ ê³ ìœ  ì¶œê³ ì²˜ ìˆ˜ì§‘
    if (storeData) {
      storeData.forEach(storeRow => {
        if (storeRow.length > 21) {
          const storeAgent = (storeRow[21] || '').toString(); // Vì—´: ë‹´ë‹¹ì
          const storeCode = (storeRow[14] || '').toString(); // Oì—´: ì¶œê³ ì²˜ì½”ë“œ

          // í•´ë‹¹ ì‚¬ë¬´ì‹¤ì˜ ë‹´ë‹¹ìì¸ì§€ í™•ì¸
          const isOfficeAgent = phoneklData.some(row => {
            const rowOffice = (row[6] || '').toString(); // Gì—´: ì‚¬ë¬´ì‹¤
            const rowAgent = (row[8] || '').toString(); // Iì—´: ë‹´ë‹¹ì
            return rowOffice === data.office && rowAgent === storeAgent && !excludedAgents.includes(rowAgent);
          });

          if (isOfficeAgent && storeCode) {
            // ì œì™¸ ì¡°ê±´ë“¤
            if (storeCode.includes('ì‚¬ë¬´ì‹¤')) return;
            if (storeCode === storeAgent) return;
            if (storeAgent.includes('ê±°ë˜ì¢…ë£Œ')) return;

            if (!agentStores.has(storeAgent)) {
              agentStores.set(storeAgent, new Set());
            }
            agentStores.get(storeAgent).add(storeCode);
          }
        }
      });
    }

    // 2ë‹¨ê³„: ì¬ê³  ë°ì´í„° ìˆ˜ì§‘
    if (inventoryData) {
      inventoryData.forEach(inventoryRow => {
        if (inventoryRow.length > 8) {
          const inventoryAgent = (inventoryRow[8] || '').toString(); // Iì—´: ë‹´ë‹¹ì
          const inventoryType = (inventoryRow[12] || '').toString(); // Mì—´: ìœ í˜•
          const inventoryStore = (inventoryRow[21] || '').toString(); // Vì—´: ì¶œê³ ì²˜

          // í•´ë‹¹ ì‚¬ë¬´ì‹¤ì˜ ë‹´ë‹¹ìì¸ì§€ í™•ì¸
          const isOfficeAgent = phoneklData.some(row => {
            const rowOffice = (row[6] || '').toString(); // Gì—´: ì‚¬ë¬´ì‹¤
            const rowAgent = (row[8] || '').toString(); // Iì—´: ë‹´ë‹¹ì
            return rowOffice === data.office && rowAgent === inventoryAgent && !excludedAgents.includes(rowAgent);
          });

          if (isOfficeAgent && !excludedStores.includes(inventoryStore)) {
            if (!agentInventory.has(inventoryAgent)) {
              agentInventory.set(inventoryAgent, { devices: 0, sims: 0 });
            }
            if (inventoryType === 'ìœ ì‹¬') {
              agentInventory.get(inventoryAgent).sims++;
            } else {
              agentInventory.get(inventoryAgent).devices++;
            }
          }
        }
      });
    }

    // 3ë‹¨ê³„: ë“±ë¡ì , ê°€ë™ì , ì¬ê³  ê³„ì‚°
    agentStores.forEach((stores, agent) => {
      totalRegisteredStores += stores.size;

      // ê°€ë™ì  ê³„ì‚° (ê° ì¶œê³ ì²˜ë³„ë¡œ ì‹¤ì  í™•ì¸)
      stores.forEach(storeCode => {
        const hasPerformance = filteredPhoneklData.some(performanceRow => {
          const performanceStoreCode = (performanceRow[14] || '').toString();
          const performanceAgent = (performanceRow[8] || '').toString();
          return performanceStoreCode === storeCode && performanceAgent === agent;
        });

        if (hasPerformance) {
          totalActiveStores++;
        }
      });
    });

    // 4ë‹¨ê³„: ì¬ê³  í•©ê³„
    agentInventory.forEach((inventory) => {
      totalDevices += inventory.devices;
      totalSims += inventory.sims;
    });

    data.registeredStores = totalRegisteredStores;
    data.activeStores = totalActiveStores;
    data.utilization = data.registeredStores > 0 ? Math.round((data.activeStores / data.registeredStores) * 100) : 0;
    data.inactiveStores = data.registeredStores - data.activeStores;
    data.devices = totalDevices;
    data.sims = totalSims;
    data.rotation = (data.expectedClosing + data.devices) > 0 ? Math.round((data.expectedClosing / (data.expectedClosing + data.devices)) * 100) : 0;

    // ì§€ì›ê¸ˆ ì ìš©
    data.support = officeSupportMap ? (officeSupportMap.get(data.office) || 0) : 0;
  });

  return Array.from(officeMap.values()).sort((a, b) => b.performance - a.performance);
}

// ì½”ë“œë³„ ì§‘ê³„
function aggregateByCode(phoneklData, storeData, inventoryData, excludedAgents, excludedStores, codeSupportMap, targets, filteredPhoneklData) {


  const codeMap = new Map();
  let excludedCount = 0;
  let noCodeCount = 0;

  phoneklData.forEach(row => {
    const code = (row[4] || '').toString(); // Eì—´: ì½”ë“œ
    const agent = (row[8] || '').toString(); // Iì—´: ë‹´ë‹¹ì

    if (!code) {
      noCodeCount++;
      return;
    }

    if (excludedAgents.includes(agent)) {
      excludedCount++;
      return;
    }

    if (!codeMap.has(code)) {
      codeMap.set(code, {
        code,
        performance: 0,
        fee: 0,
        support: 0,
        target: 0,
        achievement: 0,
        expectedClosing: 0,
        rotation: 0,
        registeredStores: 0,
        activeStores: 0,
        devices: 0,
        sims: 0,
        utilization: 0
      });
    }

    const data = codeMap.get(code);
    data.performance++;

    // #N/A ê°’ ì²˜ë¦¬
    const rawFee = row[3];
    let fee = 0;

    if (rawFee && rawFee !== '#N/A' && rawFee !== 'N/A') {
      fee = parseFloat(rawFee) || 0;
    }

    data.fee += fee;
  });



  // ì¶”ê°€ ê³„ì‚°
  const today = new Date();
  const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();

  codeMap.forEach(data => {
    data.expectedClosing = Math.round(data.performance / today.getDate() * daysInMonth);

    // ëª©í‘œê°’ ì ìš© (í•´ë‹¹ ì½”ë“œì˜ ëª¨ë“  ë‹´ë‹¹ì-ì½”ë“œ ì¡°í•© ëª©í‘œê°’ í•©ê³„)
    let totalTarget = 0;
    targets.forEach((targetInfo, key) => {
      if (!targetInfo.excluded) {
        // í•´ë‹¹ ì½”ë“œì˜ ë‹´ë‹¹ìì¸ì§€ í™•ì¸
        const agentData = phoneklData.find(row =>
          (row[8] || '').toString() === targetInfo.agent &&
          (row[4] || '').toString() === data.code
        );
        if (agentData) {
          totalTarget += targetInfo.target;
        }
      }
    });
    data.target = totalTarget;

    data.achievement = data.target > 0 ? Math.round((data.expectedClosing / data.target) * 100) : 0;

    // ë“±ë¡ì , ê°€ë™ì , ë³´ìœ ë‹¨ë§, ë³´ìœ ìœ ì‹¬ ê³„ì‚° (ë‹´ë‹¹ìë³„ ë°©ì‹ìœ¼ë¡œ í†µì¼)
    let totalRegisteredStores = 0;
    let totalActiveStores = 0;
    let totalDevices = 0;
    let totalSims = 0;

    // í•´ë‹¹ ì½”ë“œì˜ ëª¨ë“  ë‹´ë‹¹ìë“¤ì˜ ê³ ìœ  ì¶œê³ ì²˜ ëª©ë¡ ìƒì„±
    const agentStores = new Map(); // ë‹´ë‹¹ìë³„ ê³ ìœ  ì¶œê³ ì²˜ ëª©ë¡
    const agentInventory = new Map(); // ë‹´ë‹¹ìë³„ ì¬ê³  ë°ì´í„°

    // 1ë‹¨ê³„: í•´ë‹¹ ì½”ë“œì˜ ë‹´ë‹¹ìë“¤ì˜ ê³ ìœ  ì¶œê³ ì²˜ ìˆ˜ì§‘
    if (storeData) {
      storeData.forEach(storeRow => {
        if (storeRow.length > 21) {
          const storeAgent = (storeRow[21] || '').toString(); // Vì—´: ë‹´ë‹¹ì
          const storeCode = (storeRow[14] || '').toString(); // Oì—´: ì¶œê³ ì²˜ì½”ë“œ

          // í•´ë‹¹ ì½”ë“œì˜ ë‹´ë‹¹ìì¸ì§€ í™•ì¸
          const isCodeAgent = phoneklData.some(row => {
            const rowCode = (row[4] || '').toString(); // Eì—´: ì½”ë“œ
            const rowAgent = (row[8] || '').toString(); // Iì—´: ë‹´ë‹¹ì
            return rowCode === data.code && rowAgent === storeAgent && !excludedAgents.includes(rowAgent);
          });

          if (isCodeAgent && storeCode) {
            // ì œì™¸ ì¡°ê±´ë“¤
            if (storeCode.includes('ì‚¬ë¬´ì‹¤')) return;
            if (storeCode === storeAgent) return;
            if (storeAgent.includes('ê±°ë˜ì¢…ë£Œ')) return;

            if (!agentStores.has(storeAgent)) {
              agentStores.set(storeAgent, new Set());
            }
            agentStores.get(storeAgent).add(storeCode);
          }
        }
      });
    }

    // 2ë‹¨ê³„: ì¬ê³  ë°ì´í„° ìˆ˜ì§‘
    if (inventoryData) {
      inventoryData.forEach(inventoryRow => {
        if (inventoryRow.length > 8) {
          const inventoryAgent = (inventoryRow[8] || '').toString(); // Iì—´: ë‹´ë‹¹ì
          const inventoryType = (inventoryRow[12] || '').toString(); // Mì—´: ìœ í˜•
          const inventoryStore = (inventoryRow[21] || '').toString(); // Vì—´: ì¶œê³ ì²˜

          // í•´ë‹¹ ì½”ë“œì˜ ë‹´ë‹¹ìì¸ì§€ í™•ì¸
          const isCodeAgent = phoneklData.some(row => {
            const rowCode = (row[4] || '').toString(); // Eì—´: ì½”ë“œ
            const rowAgent = (row[8] || '').toString(); // Iì—´: ë‹´ë‹¹ì
            return rowCode === data.code && rowAgent === inventoryAgent && !excludedAgents.includes(rowAgent);
          });

          if (isCodeAgent && !excludedStores.includes(inventoryStore)) {
            if (!agentInventory.has(inventoryAgent)) {
              agentInventory.set(inventoryAgent, { devices: 0, sims: 0 });
            }
            if (inventoryType === 'ìœ ì‹¬') {
              agentInventory.get(inventoryAgent).sims++;
            } else {
              agentInventory.get(inventoryAgent).devices++;
            }
          }
        }
      });
    }

    // 3ë‹¨ê³„: ë“±ë¡ì , ê°€ë™ì , ì¬ê³  ê³„ì‚°
    agentStores.forEach((stores, agent) => {
      totalRegisteredStores += stores.size;

      // ê°€ë™ì  ê³„ì‚° (ê° ì¶œê³ ì²˜ë³„ë¡œ ì‹¤ì  í™•ì¸)
      stores.forEach(storeCode => {
        const hasPerformance = filteredPhoneklData.some(performanceRow => {
          const performanceStoreCode = (performanceRow[14] || '').toString();
          const performanceAgent = (performanceRow[8] || '').toString();
          return performanceStoreCode === storeCode && performanceAgent === agent;
        });

        if (hasPerformance) {
          totalActiveStores++;
        }
      });
    });

    // 4ë‹¨ê³„: ì¬ê³  í•©ê³„
    agentInventory.forEach((inventory) => {
      totalDevices += inventory.devices;
      totalSims += inventory.sims;
    });

    data.registeredStores = totalRegisteredStores;
    data.activeStores = totalActiveStores;
    data.utilization = data.registeredStores > 0 ? Math.round((data.activeStores / data.registeredStores) * 100) : 0;
    data.inactiveStores = data.registeredStores - totalActiveStores;
    data.devices = totalDevices;
    data.sims = totalSims;
    data.rotation = (data.expectedClosing + data.devices) > 0 ? Math.round((data.expectedClosing / (data.expectedClosing + data.devices)) * 100) : 0;

    // ì§€ì›ê¸ˆ ì ìš©
    data.support = codeSupportMap ? (codeSupportMap.get(data.code) || 0) : 0;
  });



  return Array.from(codeMap.values()).sort((a, b) => b.fee - a.fee);
}

// í†µí•© ë°ì´í„°ì—ì„œ ì½”ë“œë³„ ì§‘ê³„ ì¶”ì¶œ
function aggregateByCodeFromUnified(unifiedData, codeSupportMap) {
  const codeMap = new Map();

  unifiedData.forEach((data, key) => {
    const code = data.code;

    if (!codeMap.has(code)) {
      codeMap.set(code, {
        code,
        performance: 0,
        fee: 0,
        support: 0,
        target: 0,
        achievement: 0,
        expectedClosing: 0,
        rotation: 0,
        registeredStores: 0,
        activeStores: 0,
        devices: 0,
        sims: 0,
        utilization: 0
      });
    }

    const codeData = codeMap.get(code);
    codeData.performance += data.performance;
    codeData.fee += data.fee;
    codeData.target += data.target;
    codeData.registeredStores += data.registeredStores;
    codeData.activeStores += data.activeStores;
    codeData.devices += data.devices;
    codeData.sims += data.sims;
  });

  // ì¶”ê°€ ê³„ì‚°
  codeMap.forEach(data => {
    data.expectedClosing = Math.round(data.performance / new Date().getDate() * new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate());
    data.achievement = data.target > 0 ? Math.round((data.expectedClosing / data.target) * 100) : 0;
    data.utilization = data.registeredStores > 0 ? Math.round((data.activeStores / data.registeredStores) * 100) : 0;
    data.rotation = (data.expectedClosing + data.devices) > 0 ? Math.round((data.expectedClosing / (data.expectedClosing + data.devices)) * 100) : 0;
    data.support = codeSupportMap ? (codeSupportMap.get(data.code) || 0) : 0;
  });

  return Array.from(codeMap.values()).sort((a, b) => b.fee - a.fee);
}

// í†µí•© ë°ì´í„°ì—ì„œ ì‚¬ë¬´ì‹¤ë³„ ì§‘ê³„ ì¶”ì¶œ
function aggregateByOfficeFromUnified(unifiedData, officeSupportMap) {
  const officeMap = new Map();

  unifiedData.forEach((data, key) => {
    const office = data.office;

    if (!officeMap.has(office)) {
      officeMap.set(office, {
        office,
        performance: 0,
        fee: 0,
        support: 0,
        target: 0,
        achievement: 0,
        expectedClosing: 0,
        rotation: 0,
        registeredStores: 0,
        activeStores: 0,
        devices: 0,
        sims: 0,
        utilization: 0
      });
    }

    const officeData = officeMap.get(office);
    officeData.performance += data.performance;
    officeData.fee += data.fee;
    officeData.target += data.target;
    officeData.registeredStores += data.registeredStores;
    officeData.activeStores += data.activeStores;
    officeData.devices += data.devices;
    officeData.sims += data.sims;
  });

  // ì¶”ê°€ ê³„ì‚°
  officeMap.forEach(data => {
    data.expectedClosing = Math.round(data.performance / new Date().getDate() * new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate());
    data.achievement = data.target > 0 ? Math.round((data.expectedClosing / data.target) * 100) : 0;
    data.utilization = data.registeredStores > 0 ? Math.round((data.activeStores / data.registeredStores) * 100) : 0;
    data.rotation = (data.expectedClosing + data.devices) > 0 ? Math.round((data.expectedClosing / (data.expectedClosing + data.devices)) * 100) : 0;
    data.support = officeSupportMap ? (officeSupportMap.get(data.office) || 0) : 0;
  });

  return Array.from(officeMap.values()).sort((a, b) => b.performance - a.performance);
}

// í†µí•© ë°ì´í„°ì—ì„œ ì†Œì†ë³„ ì§‘ê³„ ì¶”ì¶œ
function aggregateByDepartmentFromUnified(unifiedData, departmentSupportMap) {
  const departmentMap = new Map();

  unifiedData.forEach((data, key) => {
    const department = data.department;

    if (!departmentMap.has(department)) {
      departmentMap.set(department, {
        department,
        performance: 0,
        fee: 0,
        support: 0,
        target: 0,
        achievement: 0,
        expectedClosing: 0,
        rotation: 0,
        registeredStores: 0,
        activeStores: 0,
        devices: 0,
        sims: 0,
        utilization: 0
      });
    }

    const deptData = departmentMap.get(department);
    deptData.performance += data.performance;
    deptData.fee += data.fee;
    deptData.target += data.target;
    deptData.registeredStores += data.registeredStores;
    deptData.activeStores += data.activeStores;
    deptData.devices += data.devices;
    deptData.sims += data.sims;
  });

  // ì¶”ê°€ ê³„ì‚°
  departmentMap.forEach(data => {
    data.expectedClosing = Math.round(data.performance / new Date().getDate() * new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate());
    data.achievement = data.target > 0 ? Math.round((data.expectedClosing / data.target) * 100) : 0;
    data.utilization = data.registeredStores > 0 ? Math.round((data.activeStores / data.registeredStores) * 100) : 0;
    data.rotation = (data.expectedClosing + data.devices) > 0 ? Math.round((data.expectedClosing / (data.expectedClosing + data.devices)) * 100) : 0;
    data.support = departmentSupportMap ? (departmentSupportMap.get(data.department) || 0) : 0;
  });

  return Array.from(departmentMap.values()).sort((a, b) => b.fee - a.fee);
}

// í†µí•© ë°ì´í„°ì—ì„œ ë‹´ë‹¹ìë³„ ì§‘ê³„ ì¶”ì¶œ
function aggregateByAgentFromUnified(unifiedData, agentSupportMap) {
  const agentMap = new Map();

  unifiedData.forEach((data, key) => {
    const agent = data.agent;

    if (!agentMap.has(agent)) {
      agentMap.set(agent, {
        agent,
        performance: 0,
        fee: 0,
        support: 0,
        target: 0,
        achievement: 0,
        expectedClosing: 0,
        rotation: 0,
        registeredStores: 0,
        activeStores: 0,
        devices: 0,
        sims: 0,
        utilization: 0
      });
    }

    const agentData = agentMap.get(agent);
    agentData.performance += data.performance;
    agentData.fee += data.fee;
    agentData.target += data.target;
    agentData.registeredStores += data.registeredStores;
    agentData.activeStores += data.activeStores;
    agentData.devices += data.devices;
    agentData.sims += data.sims;
  });

  // ì¶”ê°€ ê³„ì‚°
  agentMap.forEach(data => {
    data.expectedClosing = Math.round(data.performance / new Date().getDate() * new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate());
    data.achievement = data.target > 0 ? Math.round((data.expectedClosing / data.target) * 100) : 0;
    data.utilization = data.registeredStores > 0 ? Math.round((data.activeStores / data.registeredStores) * 100) : 0;
    data.rotation = (data.expectedClosing + data.devices) > 0 ? Math.round((data.expectedClosing / (data.expectedClosing + data.devices)) * 100) : 0;
    data.support = agentSupportMap ? (agentSupportMap.get(data.agent) || 0) : 0;
  });

  return Array.from(agentMap.values()).sort((a, b) => b.fee - a.fee);
}

// ì†Œì†ë³„ ì§‘ê³„
function aggregateByDepartment(phoneklData, storeData, inventoryData, excludedAgents, excludedStores, departmentSupportMap, targets, filteredPhoneklData) {


  const departmentMap = new Map();
  let excludedCount = 0;
  let noDepartmentCount = 0;

  phoneklData.forEach(row => {
    const department = (row[7] || '').toString(); // Hì—´: ì†Œì†
    const agent = (row[8] || '').toString(); // Iì—´: ë‹´ë‹¹ì

    if (!department) {
      noDepartmentCount++;
      return;
    }

    if (excludedAgents.includes(agent)) {
      excludedCount++;
      return;
    }

    if (!departmentMap.has(department)) {
      departmentMap.set(department, {
        department,
        performance: 0,
        fee: 0,
        support: 0,
        target: 0,
        achievement: 0,
        expectedClosing: 0,
        rotation: 0,
        registeredStores: 0,
        activeStores: 0,
        devices: 0,
        sims: 0,
        utilization: 0
      });
    }

    const data = departmentMap.get(department);
    data.performance++;

    // #N/A ê°’ ì²˜ë¦¬
    const rawFee = row[3];
    let fee = 0;

    if (rawFee && rawFee !== '#N/A' && rawFee !== 'N/A') {
      fee = parseFloat(rawFee) || 0;
    }

    data.fee += fee;
  });



  // ì¶”ê°€ ê³„ì‚°
  const today = new Date();
  const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();

  departmentMap.forEach(data => {
    data.expectedClosing = Math.round(data.performance / today.getDate() * daysInMonth);

    // ëª©í‘œê°’ ì ìš© (í•´ë‹¹ ì†Œì†ì˜ ëª¨ë“  ë‹´ë‹¹ì-ì½”ë“œ ì¡°í•© ëª©í‘œê°’ í•©ê³„)
    let totalTarget = 0;
    targets.forEach((targetInfo, key) => {
      if (!targetInfo.excluded) {
        // í•´ë‹¹ ì†Œì†ì˜ ë‹´ë‹¹ìì¸ì§€ í™•ì¸
        const agentData = phoneklData.find(row =>
          (row[8] || '').toString() === targetInfo.agent &&
          (row[7] || '').toString() === data.department
        );
        if (agentData) {
          totalTarget += targetInfo.target;
        }
      }
    });
    data.target = totalTarget;

    data.achievement = data.target > 0 ? Math.round((data.expectedClosing / data.target) * 100) : 0;

    // ë“±ë¡ì , ê°€ë™ì , ë³´ìœ ë‹¨ë§, ë³´ìœ ìœ ì‹¬ ê³„ì‚° (ë‹´ë‹¹ìë³„ ë°©ì‹ìœ¼ë¡œ í†µì¼)
    let totalRegisteredStores = 0;
    let totalActiveStores = 0;
    let totalDevices = 0;
    let totalSims = 0;

    // í•´ë‹¹ ì†Œì†ì˜ ëª¨ë“  ë‹´ë‹¹ìë“¤ì˜ ê³ ìœ  ì¶œê³ ì²˜ ëª©ë¡ ìƒì„±
    const agentStores = new Map(); // ë‹´ë‹¹ìë³„ ê³ ìœ  ì¶œê³ ì²˜ ëª©ë¡
    const agentInventory = new Map(); // ë‹´ë‹¹ìë³„ ì¬ê³  ë°ì´í„°

    // 1ë‹¨ê³„: í•´ë‹¹ ì†Œì†ì˜ ë‹´ë‹¹ìë“¤ì˜ ê³ ìœ  ì¶œê³ ì²˜ ìˆ˜ì§‘
    if (storeData) {
      storeData.forEach(storeRow => {
        if (storeRow.length > 21) {
          const storeAgent = (storeRow[21] || '').toString(); // Vì—´: ë‹´ë‹¹ì
          const storeCode = (storeRow[14] || '').toString(); // Oì—´: ì¶œê³ ì²˜ì½”ë“œ

          // í•´ë‹¹ ì†Œì†ì˜ ë‹´ë‹¹ìì¸ì§€ í™•ì¸
          const isDepartmentAgent = phoneklData.some(row => {
            const rowDepartment = (row[7] || '').toString(); // Hì—´: ì†Œì†
            const rowAgent = (row[8] || '').toString(); // Iì—´: ë‹´ë‹¹ì
            return rowDepartment === data.department && rowAgent === storeAgent && !excludedAgents.includes(rowAgent);
          });

          if (isDepartmentAgent && storeCode) {
            // ì œì™¸ ì¡°ê±´ë“¤
            if (storeCode.includes('ì‚¬ë¬´ì‹¤')) return;
            if (storeCode === storeAgent) return;
            if (storeAgent.includes('ê±°ë˜ì¢…ë£Œ')) return;

            if (!agentStores.has(storeAgent)) {
              agentStores.set(storeAgent, new Set());
            }
            agentStores.get(storeAgent).add(storeCode);
          }
        }
      });
    }

    // 2ë‹¨ê³„: ì¬ê³  ë°ì´í„° ìˆ˜ì§‘
    if (inventoryData) {
      inventoryData.forEach(inventoryRow => {
        if (inventoryRow.length > 8) {
          const inventoryAgent = (inventoryRow[8] || '').toString(); // Iì—´: ë‹´ë‹¹ì
          const inventoryType = (inventoryRow[12] || '').toString(); // Mì—´: ìœ í˜•
          const inventoryStore = (inventoryRow[21] || '').toString(); // Vì—´: ì¶œê³ ì²˜

          // í•´ë‹¹ ì†Œì†ì˜ ë‹´ë‹¹ìì¸ì§€ í™•ì¸
          const isDepartmentAgent = phoneklData.some(row => {
            const rowDepartment = (row[7] || '').toString(); // Hì—´: ì†Œì†
            const rowAgent = (row[8] || '').toString(); // Iì—´: ë‹´ë‹¹ì
            return rowDepartment === data.department && rowAgent === inventoryAgent && !excludedAgents.includes(rowAgent);
          });

          if (isDepartmentAgent && !excludedStores.includes(inventoryStore)) {
            if (!agentInventory.has(inventoryAgent)) {
              agentInventory.set(inventoryAgent, { devices: 0, sims: 0 });
            }
            if (inventoryType === 'ìœ ì‹¬') {
              agentInventory.get(inventoryAgent).sims++;
            } else {
              agentInventory.get(inventoryAgent).devices++;
            }
          }
        }
      });
    }

    // 3ë‹¨ê³„: ë“±ë¡ì , ê°€ë™ì , ì¬ê³  ê³„ì‚°
    agentStores.forEach((stores, agent) => {
      totalRegisteredStores += stores.size;

      // ê°€ë™ì  ê³„ì‚° (ê° ì¶œê³ ì²˜ë³„ë¡œ ì‹¤ì  í™•ì¸)
      stores.forEach(storeCode => {
        const hasPerformance = filteredPhoneklData.some(performanceRow => {
          const performanceStoreCode = (performanceRow[14] || '').toString();
          const performanceAgent = (performanceRow[8] || '').toString();
          return performanceStoreCode === storeCode && performanceAgent === agent;
        });

        if (hasPerformance) {
          totalActiveStores++;
        }
      });
    });

    // 4ë‹¨ê³„: ì¬ê³  í•©ê³„
    agentInventory.forEach((inventory) => {
      totalDevices += inventory.devices;
      totalSims += inventory.sims;
    });

    data.registeredStores = totalRegisteredStores;
    data.activeStores = totalActiveStores;
    data.utilization = data.registeredStores > 0 ? Math.round((data.activeStores / data.registeredStores) * 100) : 0;
    data.inactiveStores = data.registeredStores - data.activeStores;
    data.devices = totalDevices;
    data.sims = totalSims;
    data.rotation = (data.expectedClosing + data.devices) > 0 ? Math.round((data.expectedClosing / (data.expectedClosing + data.devices)) * 100) : 0;

    // ì§€ì›ê¸ˆ ì ìš©
    data.support = departmentSupportMap ? (departmentSupportMap.get(data.department) || 0) : 0;
  });



  return Array.from(departmentMap.values()).sort((a, b) => b.fee - a.fee);
}

// ì†Œì†ë³„ ìƒì„¸ ì •ë³´ ê³„ì‚°
function calculateDepartmentDetails(departmentMap, storeData, inventoryData, excludedStores) {
  // ë“±ë¡ì  ê³„ì‚° (í°í´ì¶œê³ ì²˜ë°ì´í„°)
  if (storeData) {
    storeData.forEach(row => {
      if (row.length > 21) {
        const agent = (row[21] || '').toString(); // Vì—´: ë‹´ë‹¹ì
        const storeCode = (row[14] || '').toString(); // Oì—´: ì¶œê³ ì²˜ì½”ë“œ

        if (agent && storeCode) {
          // ë‹´ë‹¹ìë¡œë¶€í„° ì†Œì† ì°¾ê¸°
          departmentMap.forEach((data, department) => {
            // ì‹¤ì œë¡œëŠ” ë‹´ë‹¹ì-ì†Œì† ë§¤í•‘ì´ í•„ìš”í•˜ì§€ë§Œ, ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ ì²˜ë¦¬
            if (agent.includes(department) || department.includes(agent)) {
              data.registeredStores++;
            }
          });
        }
      }
    });
  }

  // ê°€ë™ì  ê³„ì‚°
  departmentMap.forEach((data, department) => {
    let activeCount = 0;
    if (storeData) {
      storeData.forEach(row => {
        if (row.length > 21) {
          const agent = (row[21] || '').toString();
          if (agent.includes(department) || department.includes(agent)) {
            const storeCode = (row[14] || '').toString();
            if (storeCode && data.performance > 0) {
              activeCount++;
            }
          }
        }
      });
    }
    data.activeStores = activeCount;
  });

  // ë³´ìœ ë‹¨ë§, ë³´ìœ ìœ ì‹¬ ê³„ì‚° (í°í´ì¬ê³ ë°ì´í„°)
  if (inventoryData) {
    inventoryData.forEach(row => {
      if (row.length > 8) {
        const agent = (row[8] || '').toString(); // Iì—´: ë‹´ë‹¹ì
        const type = (row[12] || '').toString(); // Mì—´: ìœ í˜•
        const store = (row[21] || '').toString(); // Vì—´: ì¶œê³ ì²˜

        if (agent && !excludedStores.includes(store)) {
          departmentMap.forEach((data, department) => {
            if (agent.includes(department) || department.includes(agent)) {
              if (type === 'ìœ ì‹¬') {
                data.sims++;
              } else {
                data.devices++;
              }
            }
          });
        }
      }
    });
  }
}

// ë‹´ë‹¹ìë³„ ì§‘ê³„
function aggregateByAgent(phoneklData, storeData, inventoryData, excludedAgents, excludedStores, agentSupportMap, targets, filteredPhoneklData) {
  const agentMap = new Map();

  phoneklData.forEach(row => {
    const agent = (row[8] || '').toString(); // Iì—´: ë‹´ë‹¹ì

    if (!agent || excludedAgents.includes(agent)) return;

    if (!agentMap.has(agent)) {
      agentMap.set(agent, {
        agent,
        performance: 0,
        fee: 0,
        support: 0,
        target: 0,
        achievement: 0,
        expectedClosing: 0,
        rotation: 0,
        registeredStores: 0,
        activeStores: 0,
        devices: 0,
        sims: 0,
        utilization: 0
      });
    }

    const data = agentMap.get(agent);
    data.performance++;

    // #N/A ê°’ ì²˜ë¦¬
    const rawFee = row[3];
    let fee = 0;

    if (rawFee && rawFee !== '#N/A' && rawFee !== 'N/A') {
      fee = parseFloat(rawFee) || 0;
    }

    data.fee += fee;
  });

  // ë“±ë¡ì , ê°€ë™ì , ë³´ìœ ë‹¨ë§, ë³´ìœ ìœ ì‹¬ ê³„ì‚°
  calculateAgentDetails(agentMap, storeData, inventoryData, excludedStores, filteredPhoneklData);

  // ì¶”ê°€ ê³„ì‚°
  const today = new Date();
  const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();

  agentMap.forEach(data => {
    data.expectedClosing = Math.round(data.performance / today.getDate() * daysInMonth);

    // ëª©í‘œê°’ ì ìš© (í•´ë‹¹ ë‹´ë‹¹ìì˜ ëª¨ë“  ì½”ë“œ ëª©í‘œê°’ í•©ê³„)
    let totalTarget = 0;
    targets.forEach((targetInfo, key) => {
      if (!targetInfo.excluded && targetInfo.agent === data.agent) {
        totalTarget += targetInfo.target;
      }
    });
    data.target = totalTarget;

    data.achievement = data.target > 0 ? Math.round((data.expectedClosing / data.target) * 100) : 0;
    data.utilization = data.registeredStores > 0 ? Math.round((data.activeStores / data.registeredStores) * 100) : 0;
    data.rotation = (data.devices + data.expectedClosing) > 0 ? Math.round((data.expectedClosing / (data.devices + data.expectedClosing)) * 100) : 0;

    // ì§€ì›ê¸ˆ ì ìš©
    data.support = agentSupportMap ? (agentSupportMap.get(data.agent) || 0) : 0;
  });

  return Array.from(agentMap.values()).sort((a, b) => b.fee - a.fee);
}

// ë‹´ë‹¹ì ìƒì„¸ ì •ë³´ ê³„ì‚°
function calculateAgentDetails(agentMap, storeData, inventoryData, excludedStores, filteredPhoneklData) {
  // ë“±ë¡ì  ê³„ì‚° (í°í´ì¶œê³ ì²˜ë°ì´í„°)
  if (storeData) {
    storeData.forEach(row => {
      if (row.length > 21) {
        const agent = (row[21] || '').toString(); // Vì—´: ë‹´ë‹¹ì
        const storeCode = (row[14] || '').toString(); // Oì—´: ì¶œê³ ì²˜ì½”ë“œ

        // ì œì™¸ ì¡°ê±´ë“¤
        if (storeCode.includes('ì‚¬ë¬´ì‹¤')) return; // ì¶œê³ ì²˜ì½”ë“œì— "ì‚¬ë¬´ì‹¤" í¬í•¨ ì‹œ ì œì™¸
        if (storeCode === agent) return; // ì¶œê³ ì²˜ì½”ë“œì™€ ë‹´ë‹¹ìê°€ ë™ì¼í•œ í…ìŠ¤íŠ¸ ì‹œ ì œì™¸
        if (agent.includes('ê±°ë˜ì¢…ë£Œ')) return; // ë‹´ë‹¹ìì— "ê±°ë˜ì¢…ë£Œ" í¬í•¨ ì‹œ ì œì™¸

        if (agent && agentMap.has(agent) && storeCode) {
          agentMap.get(agent).registeredStores++;
        }
      }
    });
  }

  // ê°€ë™ì  ê³„ì‚°
  agentMap.forEach((data, agent) => {
    // ê°€ë™ì  = ë“±ë¡ì  ì¤‘ì—ì„œ ì‹¤ì ì´ ìˆëŠ” ê³³
    let activeCount = 0;
    if (storeData) {
      storeData.forEach(row => {
        if (row.length > 21 && row[21] === agent) {
          const storeCode = (row[14] || '').toString();

          // ì œì™¸ ì¡°ê±´ë“¤ (ë“±ë¡ì ê³¼ ë™ì¼)
          if (storeCode.includes('ì‚¬ë¬´ì‹¤')) return; // ì¶œê³ ì²˜ì½”ë“œì— "ì‚¬ë¬´ì‹¤" í¬í•¨ ì‹œ ì œì™¸
          if (storeCode === agent) return; // ì¶œê³ ì²˜ì½”ë“œì™€ ë‹´ë‹¹ìê°€ ë™ì¼í•œ í…ìŠ¤íŠ¸ ì‹œ ì œì™¸
          if (agent.includes('ê±°ë˜ì¢…ë£Œ')) return; // ë‹´ë‹¹ìì— "ê±°ë˜ì¢…ë£Œ" í¬í•¨ ì‹œ ì œì™¸

          // í•´ë‹¹ ì¶œê³ ì²˜ì—ì„œ ë‹¹ì›”ì‹¤ì ì´ ìˆëŠ”ì§€ í™•ì¸
          const hasPerformance = filteredPhoneklData.some(performanceRow => {
            const performanceStoreCode = (performanceRow[14] || '').toString(); // Oì—´: ì¶œê³ ì²˜ì½”ë“œ
            const performanceAgent = (performanceRow[8] || '').toString(); // Iì—´: ë‹´ë‹¹ì
            return performanceStoreCode === storeCode && performanceAgent === agent;
          });

          if (storeCode && hasPerformance) {
            activeCount++;
          }
        }
      });
    }
    data.activeStores = activeCount;
  });

  // ë³´ìœ ë‹¨ë§, ë³´ìœ ìœ ì‹¬ ê³„ì‚° (í°í´ì¬ê³ ë°ì´í„°)
  if (inventoryData) {
    inventoryData.forEach(row => {
      if (row.length > 8) {
        const agent = (row[8] || '').toString(); // Iì—´: ë‹´ë‹¹ì
        const type = (row[12] || '').toString(); // Mì—´: ìœ í˜•
        const store = (row[21] || '').toString(); // Vì—´: ì¶œê³ ì²˜

        if (agent && agentMap.has(agent) && !excludedStores.includes(store)) {
          if (type === 'ìœ ì‹¬') {
            agentMap.get(agent).sims++;
          } else {
            agentMap.get(agent).devices++;
          }
        }
      }
    });
  }
}

// CS ê°œí†µ ìš”ì•½ ê³„ì‚° (ë¬´ì„  + ìœ ì„ )
function calculateCSSummary(filteredPhoneklData, phoneklHomeData, targetDate, phoneModels, excludedAgents) {
  console.log('ğŸ” [CS ë””ë²„ê¹…] calculateCSSummary ì‹œì‘');
  console.log('ğŸ” [CS ë””ë²„ê¹…] filteredPhoneklData ê¸¸ì´:', filteredPhoneklData.length);
  console.log('ğŸ” [CS ë””ë²„ê¹…] targetDate:', targetDate);
  console.log('ğŸ” [CS ë””ë²„ê¹…] phoneModels í¬ê¸°:', phoneModels.size);

  const csAgents = new Map();
  let totalWireless = 0;
  let totalWired = 0;

  // BZì—´ì—ì„œ CS ì§ì›ë“¤ ëª…ë‹¨ ì¶”ì¶œ (ê³ ìœ ê°’) - ë¬´ì„ 
  const csEmployeeSet = new Set();
  let bzColumnEmptyCount = 0;
  let bzColumnNCount = 0;
  let bzColumnValidCount = 0;

  filteredPhoneklData.forEach((row, index) => {
    const csEmployee = (row[77] || '').toString().trim(); // BZì—´: CSì§ì›

    if (!csEmployee || csEmployee === '') {
      bzColumnEmptyCount++;
    } else if (csEmployee === 'N' || csEmployee === 'NO') {
      bzColumnNCount++;
    } else {
      bzColumnValidCount++;
      csEmployeeSet.add(csEmployee);

      // ì²˜ìŒ 5ê°œ CS ì§ì›ëª…ë§Œ ë¡œê·¸ ì¶œë ¥
      if (bzColumnValidCount <= 5) {
        console.log(`ğŸ” [CS ë””ë²„ê¹…] ìœ íš¨í•œ CS ì§ì› ${bzColumnValidCount}: "${csEmployee}" (í–‰ ${index + 4})`);
      }
    }
  });

  console.log('ğŸ” [CS ë””ë²„ê¹…] BZì—´ ë¶„ì„ ê²°ê³¼:');
  console.log('ğŸ” [CS ë””ë²„ê¹…] - ë¹ˆ ê°’:', bzColumnEmptyCount);
  console.log('ğŸ” [CS ë””ë²„ê¹…] - N/NO ê°’:', bzColumnNCount);
  console.log('ğŸ” [CS ë””ë²„ê¹…] - ìœ íš¨í•œ CS ì§ì›:', bzColumnValidCount);
  console.log('ğŸ” [CS ë””ë²„ê¹…] - ê³ ìœ  CS ì§ì› ìˆ˜:', csEmployeeSet.size);
  console.log('ğŸ” [CS ë””ë²„ê¹…] - ê³ ìœ  CS ì§ì› ëª©ë¡:', Array.from(csEmployeeSet));



  // CNì—´ì—ì„œ CS ì§ì›ë“¤ ëª…ë‹¨ ì¶”ì¶œ (ê³ ìœ ê°’) - ìœ ì„ 
  const wiredCSEmployees = new Set();
  if (phoneklHomeData) {


    // í—¤ë” ì œì™¸ (3í–‰ê¹Œì§€ ì œì™¸, 4í–‰ë¶€í„° ë°ì´í„°)
    const dataRows = phoneklHomeData.slice(3);




    // CNì—´ì—ì„œ CS ì§ì› ì¶”ì¶œ
    dataRows.forEach((row, index) => {
      const csEmployee = (row[91] || '').toString().trim(); // CNì—´: CS ì§ì›
      if (csEmployee && csEmployee !== '' && csEmployee !== 'N' && csEmployee !== 'NO' &&
        (csEmployee.includes('MIN') || csEmployee.includes('VIP') || csEmployee.includes('ë“±ë¡'))) {
        wiredCSEmployees.add(csEmployee);

      }
    });


  } else {

  }

  // ëª¨ë“  CS ì§ì› í†µí•©
  csEmployeeSet.forEach(employee => wiredCSEmployees.add(employee));


  // ê° CS ì§ì›ë³„ë¡œ ì‹¤ì  ê³„ì‚° ì´ˆê¸°í™”
  wiredCSEmployees.forEach(csEmployee => {
    csAgents.set(csEmployee, { wireless: 0, wired: 0, total: 0 });
  });

  // ë¬´ì„  ê°œí†µ ë°ì´í„° ì²˜ë¦¬ (filteredPhoneklData ì‚¬ìš©) - ëª¨ë“  í•„í„°ë§ì´ ì´ë¯¸ ì ìš©ëœ ë°ì´í„°
  let wirelessProcessed = 0;
  let rowLengthIssueCount = 0;
  let csEmployeeValidCount = 0;

  filteredPhoneklData.forEach((row, index) => {
    // ì²˜ìŒ 5ê°œ í–‰ì˜ ê¸¸ì´ì™€ BZì—´ ê°’ í™•ì¸
    if (index < 5) {
      console.log(`ğŸ” [CS ë””ë²„ê¹…] í–‰ ${index + 1} ê¸¸ì´: ${row.length}, BZì—´(77): "${row[77] || 'ì—†ìŒ'}"`);
    }

    if (row.length < 78) {
      rowLengthIssueCount++;
      return; // ìµœì†Œí•œ BZì—´ê¹Œì§€ ìˆëŠ”ì§€ í™•ì¸
    }

    const csEmployee = (row[77] || '').toString().trim(); // BZì—´: CSì§ì›

    // CS ì§ì› í•„í„°ë§ (BZì—´ì— ê°’ì´ ìˆìœ¼ë©´ CS ê°œí†µìœ¼ë¡œ ê°„ì£¼)
    if (csEmployee && csEmployee !== '' && csEmployee !== 'N' && csEmployee !== 'NO') {
      totalWireless++;
      wirelessProcessed++;
      csEmployeeValidCount++;

      if (csAgents.has(csEmployee)) {
        csAgents.get(csEmployee).wireless++;
        csAgents.get(csEmployee).total++;
      }

      // ì²˜ìŒ 3ê°œ CS ê°œí†µë§Œ ìƒì„¸ ë¡œê·¸ ì¶œë ¥
      if (csEmployeeValidCount <= 3) {
        const activationDate = (row[9] || '').toString(); // Jì—´: ê°œí†µì¼
        const model = (row[21] || '').toString(); // Vì—´: ëª¨ë¸ëª…
        console.log(`ğŸ” [CS ë””ë²„ê¹…] CS ê°œí†µ ${csEmployeeValidCount}: "${csEmployee}" - ${activationDate} - ${model} (í–‰ ${index + 4})`);
      }
    }
  });

  console.log('ğŸ” [CS ë””ë²„ê¹…] ë¬´ì„  ê°œí†µ ì²˜ë¦¬ ê²°ê³¼:');
  console.log('ğŸ” [CS ë””ë²„ê¹…] - í–‰ ê¸¸ì´ ë¶€ì¡±:', rowLengthIssueCount);
  console.log('ğŸ” [CS ë””ë²„ê¹…] - ìœ íš¨í•œ CS ê°œí†µ:', csEmployeeValidCount);
  console.log('ğŸ” [CS ë””ë²„ê¹…] - ì´ ë¬´ì„  ê°œí†µ:', totalWireless);



  // ìœ ì„  ê°œí†µ ë°ì´í„° ì²˜ë¦¬ (í°í´í™ˆë°ì´í„°)
  let wiredProcessed = 0;
  if (phoneklHomeData) {
    // í—¤ë” ì œì™¸ (3í–‰ê¹Œì§€ ì œì™¸, 4í–‰ë¶€í„° ë°ì´í„°)
    const dataRows = phoneklHomeData.slice(3);

    dataRows.forEach((row, index) => {
      // CNì—´ì—ì„œ CS ì§ì› ì •ë³´ ì¶”ì¶œ
      const csEmployee = (row[91] || '').toString().trim(); // CNì—´: CS ì§ì›

      // CMì—´ì—ì„œ ì ‘ìˆ˜ì¼ ì¶”ì¶œ
      const receiptDate = (row[90] || '').toString().trim(); // CMì—´: ì ‘ìˆ˜ì¼

      // ë‚ ì§œ í•„í„°ë§ (í•´ë‹¹ ë‚ ì§œê¹Œì§€ì˜ ëˆ„ì  ë°ì´í„°)
      const targetDateObj = new Date(targetDate);
      const receiptDateObj = new Date(receiptDate);

      if (!isNaN(receiptDateObj.getTime()) && receiptDateObj <= targetDateObj &&
        csEmployee && csEmployee !== '' && csEmployee !== 'N' && csEmployee !== 'NO' &&
        (csEmployee.includes('MIN') || csEmployee.includes('VIP') || csEmployee.includes('ë“±ë¡'))) {
        totalWired++;
        wiredProcessed++;

        if (csAgents.has(csEmployee)) {
          csAgents.get(csEmployee).wired++;
          csAgents.get(csEmployee).total++;
        }
      }


    });


  }

  const result = {
    totalWireless,
    totalWired,
    total: totalWireless + totalWired,
    agents: Array.from(csAgents.entries())
      .filter(([agent, data]) => data.total > 0) // ì‹¤ì ì´ ìˆëŠ” ì§ì›ë§Œ
      .sort((a, b) => b[1].total - a[1].total) // ì´ ì‹¤ì  ìˆœìœ¼ë¡œ ì •ë ¬
      .map(([agent, data]) => ({
        agent,
        wireless: data.wireless,
        wired: data.wired,
        total: data.total
      }))
  };

  console.log('ğŸ” [CS ë””ë²„ê¹…] ìµœì¢… ê²°ê³¼:');
  console.log('ğŸ” [CS ë””ë²„ê¹…] - ì´ ë¬´ì„  ê°œí†µ:', result.totalWireless);
  console.log('ğŸ” [CS ë””ë²„ê¹…] - ì´ ìœ ì„  ê°œí†µ:', result.totalWired);
  console.log('ğŸ” [CS ë””ë²„ê¹…] - ì´ ê°œí†µ:', result.total);
  console.log('ğŸ” [CS ë””ë²„ê¹…] - CS ì§ì› ìˆ˜:', result.agents.length);
  console.log('ğŸ” [CS ë””ë²„ê¹…] - CS ì§ì› ëª©ë¡:', result.agents.map(a => `${a.agent}(${a.total}ê±´)`));

  return result;
}

// ë“±ë¡ì  ê³„ì‚° í•¨ìˆ˜
function calculateRegisteredStores(code, storeData) {
  if (!storeData) return 0;

  let count = 0;
  console.log(`ğŸ” [ë“±ë¡ì ê³„ì‚°] ${code} ê²€ìƒ‰ ì‹œì‘`);

  storeData.forEach((row, index) => {
    if (row.length > 14) {
      const storeCode = (row[14] || '').toString(); // Oì—´: ì¶œê³ ì²˜ì½”ë“œ
      const storeName = (row[4] || '').toString(); // Eì—´: ì¶œê³ ì²˜ëª…

      // ë” ì •í™•í•œ ë§¤ì¹­ ë¡œì§
      const isMatch = storeCode.includes(code) ||
        storeName.includes(code) ||
        (code === 'VIP(ê²½ìˆ˜)' && (storeName.includes('ê²½ìˆ˜') || storeCode.includes('ê²½ìˆ˜'))) ||
        (code === 'VIP(ê²½ì¸)' && (storeName.includes('ê²½ì¸') || storeCode.includes('ê²½ì¸'))) ||
        (code === 'VIP(í˜¸ë‚¨)' && (storeName.includes('í˜¸ë‚¨') || storeCode.includes('í˜¸ë‚¨')));

      if (isMatch) {
        count++;
        if (index < 5) {
          console.log(`ğŸ” [ë“±ë¡ì ê³„ì‚°] ${code} ë§¤ì¹­ (í–‰ ${index}):`, { storeCode, storeName });
        }
      }
    }
  });

  console.log(`ğŸ” [ë“±ë¡ì ê³„ì‚°] ${code}: ${count}ê°œ`);
  return count;
}

// ê°€ë™ì  ê³„ì‚° í•¨ìˆ˜
function calculateActiveStores(code, inventoryData) {
  if (!inventoryData) return 0;

  const activeStores = new Set();
  console.log(`ğŸ” [ê°€ë™ì ê³„ì‚°] ${code} ê²€ìƒ‰ ì‹œì‘`);

  inventoryData.forEach((row, index) => {
    if (row.length > 4) {
      const storeName = (row[4] || '').toString(); // Eì—´: ì¶œê³ ì²˜ëª…
      const quantity = parseFloat(row[5] || 0); // Fì—´: ìˆ˜ëŸ‰

      // ë” ì •í™•í•œ ë§¤ì¹­ ë¡œì§
      const isMatch = storeName.includes(code) ||
        (code === 'VIP(ê²½ìˆ˜)' && storeName.includes('ê²½ìˆ˜')) ||
        (code === 'VIP(ê²½ì¸)' && storeName.includes('ê²½ì¸')) ||
        (code === 'VIP(í˜¸ë‚¨)' && storeName.includes('í˜¸ë‚¨'));

      if (isMatch && quantity > 0) {
        activeStores.add(storeName);
        if (index < 5) {
          console.log(`ğŸ” [ê°€ë™ì ê³„ì‚°] ${code} ë§¤ì¹­ (í–‰ ${index}):`, { storeName, quantity });
        }
      }
    }
  });

  console.log(`ğŸ” [ê°€ë™ì ê³„ì‚°] ${code}: ${activeStores.size}ê°œ`);
  return activeStores.size;
}

// ë³´ìœ ë‹¨ë§, ë³´ìœ ìœ ì‹¬ ê³„ì‚° í•¨ìˆ˜
function calculateDeviceSimData(code, inventoryData) {
  if (!inventoryData) return { devices: 0, sims: 0 };

  let devices = 0;
  let sims = 0;

  inventoryData.forEach(row => {
    if (row.length > 4) {
      const storeName = (row[4] || '').toString(); // Eì—´: ì¶œê³ ì²˜ëª…
      const quantity = parseFloat(row[5] || 0); // Fì—´: ìˆ˜ëŸ‰

      if (storeName.includes(code)) {
        // ë‹¨ë§ê¸°ì™€ ìœ ì‹¬ êµ¬ë¶„ (ì„ì‹œë¡œ ë‹¨ë§ê¸°ë¡œ ê³„ì‚°)
        devices += quantity;
        sims += quantity; // ì‹¤ì œë¡œëŠ” ìœ ì‹¬ ë°ì´í„°ê°€ ë³„ë„ë¡œ ìˆì–´ì•¼ í•¨
      }
    }
  });

  console.log(`ğŸ” [ë³´ìœ ë‹¨ë§ê³„ì‚°] ${code}: ë‹¨ë§ ${devices}ê°œ, ìœ ì‹¬ ${sims}ê°œ`);
  return { devices, sims };
}

// ë§¤í•‘ ì‹¤íŒ¨ ë°ì´í„° ì°¾ê¸°
function findMappingFailures(phoneklData, storeData) {
  const failures = [];
  const failureMap = new Map();

  phoneklData.forEach(row => {
    if (row.length > 14) {
      const storeCode = (row[14] || '').toString(); // Oì—´: ì¶œê³ ì²˜
      const agent = (row[8] || '').toString(); // Iì—´: ë‹´ë‹¹ì

      if (storeCode && !findStoreInData(storeCode, storeData)) {
        const key = `${storeCode}_${agent}`;
        if (!failureMap.has(key)) {
          failureMap.set(key, {
            storeCode,
            agent,
            reason: 'ì¶œê³ ì²˜ ë§¤í•‘ ì‹¤íŒ¨',
            count: 0
          });
        }
        failureMap.get(key).count++;
      }
    }
  });

  return Array.from(failureMap.values());
}

// ì‹¤ì œ ë°ì´í„°ì—ì„œ ë‹´ë‹¹ì-ì½”ë“œ ì¡°í•© ì¶”ì¶œ
function extractAgentCodeCombinations(phoneklData) {
  const combinations = new Map();

  phoneklData.forEach(row => {
    const agent = (row[8] || '').toString().trim(); // Iì—´: ë‹´ë‹¹ì
    const code = (row[4] || '').toString().trim(); // Eì—´: ì½”ë“œëª…

    // í—¤ë” ì œì™¸
    if (agent === 'ë‹´ë‹¹ì' || code === 'ì½”ë“œëª…') return;

    if (agent && code) {
      const key = `${agent}|${code}`;
      if (!combinations.has(key)) {
        combinations.set(key, {
          agent,
          code,
          displayName: `${agent} (${code})`
        });
      }
    }
  });

  return Array.from(combinations.values());
}

// ì¶œê³ ì²˜ ë°ì´í„°ì—ì„œ ë§¤ì¹­ ì°¾ê¸°
function findStoreInData(storeCode, storeData) {
  if (!storeData) return false;

  return storeData.some(row => {
    if (row.length > 14) {
      const code = (row[14] || '').toString(); // Oì—´: ì¶œê³ ì²˜ì½”ë“œ
      return code === storeCode;
    }
    return false;
  });
}

// ëª©í‘œ ì„¤ì • API
app.post('/api/closing-chart/targets', async (req, res) => {
  try {
    const { targets } = req.body;

    if (!targets || !Array.isArray(targets)) {
      return res.status(400).json({ error: 'ëª©í‘œ ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.' });
    }

    // í—¤ë” ì„¤ì •
    const headerData = [
      ['ë‹´ë‹¹ìëª…', 'ì½”ë“œëª…', 'ëª©í‘œê°’', 'ì œì™¸ì—¬ë¶€']
    ];

    // í—¤ë” ë¨¼ì € ì €ì¥
    await sheets.spreadsheets.values.update({
      spreadsheetId: SPREADSHEET_ID,
      range: 'ì˜ì—…ì‚¬ì›ëª©í‘œ!A1',
      valueInputOption: 'USER_ENTERED',
      resource: {
        values: headerData
      }
    });

    // ì˜ì—…ì‚¬ì›ëª©í‘œ ì‹œíŠ¸ì— ì €ì¥
    const targetData = targets.map(target => [
      target.agent, // Aì—´: ë‹´ë‹¹ìëª…
      target.code, // Bì—´: ì½”ë“œëª…
      target.target, // Cì—´: ëª©í‘œê°’
      target.excluded ? 'Y' : 'N' // Dì—´: ì œì™¸ì—¬ë¶€
    ]);

    await sheets.spreadsheets.values.update({
      spreadsheetId: SPREADSHEET_ID,
      range: 'ì˜ì—…ì‚¬ì›ëª©í‘œ!A2',
      valueInputOption: 'USER_ENTERED',
      resource: {
        values: targetData
      }
    });

    // ìºì‹œ ë¬´íš¨í™”
    cacheUtils.cleanup();

    res.json({ success: true, message: 'ëª©í‘œê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.' });

  } catch (error) {
    console.error('ëª©í‘œ ì„¤ì • ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'ëª©í‘œ ì„¤ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
  }
});

// ë§¤í•‘ ì‹¤íŒ¨ ë°ì´í„° ì¡°íšŒ API
app.get('/api/closing-chart/mapping-failures', async (req, res) => {
  try {
    const { date } = req.query;
    const targetDate = date || new Date().toISOString().split('T')[0];

    const phoneklData = await getSheetValues('í°í´ê°œí†µë°ì´í„°');
    const storeData = await getSheetValues('í°í´ì¶œê³ ì²˜ë°ì´í„°');

    const failures = findMappingFailures(phoneklData, storeData);

    res.json({ failures });

  } catch (error) {
    console.error('ë§¤í•‘ ì‹¤íŒ¨ ë°ì´í„° ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'ë§¤í•‘ ì‹¤íŒ¨ ë°ì´í„° ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
  }
});

// ë‹´ë‹¹ì-ì½”ë“œ ì¡°í•© ì¶”ì¶œ API
app.get('/api/closing-chart/agent-code-combinations', async (req, res) => {
  try {
    const { date } = req.query;
    const targetDate = date || new Date().toISOString().split('T')[0];

    // í°í´ê°œí†µë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const phoneklData = await getSheetValues('í°í´ê°œí†µë°ì´í„°');

    if (!phoneklData || phoneklData.length < 2) {
      return res.json({ combinations: [] });
    }

    // í—¤ë” ì œì™¸í•˜ê³  ë°ì´í„°ë§Œ ì²˜ë¦¬
    const dataRows = phoneklData.slice(1);

    // ì‹¤ì œ ë°ì´í„°ì—ì„œ ë‹´ë‹¹ì-ì½”ë“œ ì¡°í•© ì¶”ì¶œ
    const combinations = extractAgentCodeCombinations(dataRows);

    // ê¸°ì¡´ ëª©í‘œê°’ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const targetData = await getSheetValues('ì˜ì—…ì‚¬ì›ëª©í‘œ');
    const existingTargets = new Map();

    if (targetData && targetData.length > 1) {
      targetData.slice(1).forEach(row => {
        const agent = row[0] || '';
        const code = row[1] || '';
        const target = parseInt(row[2]) || 0;
        const excluded = row[3] === 'Y';
        const key = `${agent}|${code}`;
        existingTargets.set(key, { agent, code, target, excluded });
      });
    }

    // ì¡°í•©ì— ê¸°ì¡´ ëª©í‘œê°’ ë³‘í•©
    const result = combinations.map(combo => {
      const key = `${combo.agent}|${combo.code}`;
      const existing = existingTargets.get(key);

      return {
        agent: combo.agent,
        code: combo.code,
        target: existing ? existing.target : 0,
        excluded: existing ? existing.excluded : false
      };
    });

    // ë‹´ë‹¹ì-ì½”ë“œì¡°í•© ì¶”ì¶œ ì™„ë£Œ (ë¡œê·¸ ì œê±°)

    res.json({ combinations: result });

  } catch (error) {
    console.error('ë‹´ë‹¹ì-ì½”ë“œ ì¡°í•© ì¶”ì¶œ ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'ë‹´ë‹¹ì-ì½”ë“œ ì¡°í•© ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
  }
});

// ì „ì²´ ì¬ê³„ì‚° API - ê¸°ì¡´ ì €ì¥ ë²„íŠ¼ ë¡œì§ì„ ë°°ì¹˜ë¡œ ì¬ì‹¤í–‰ (SS ë ˆë²¨ ì´ìƒë§Œ ì ‘ê·¼ ê°€ëŠ¥)
app.post('/api/budget/recalculate-all', async (req, res) => {
  try {
    console.log('ğŸ”„ [ì „ì²´ì¬ê³„ì‚°] ì‹œì‘ - ê¸°ì¡´ ì €ì¥ ë²„íŠ¼ ë¡œì§ ë°°ì¹˜ ì‹¤í–‰');

    // ê¶Œí•œ ì²´í¬: SS ë ˆë²¨ ì´ìƒë§Œ ì „ì²´ì¬ê³„ì‚° ê°€ëŠ¥
    const { userId } = req.body;
    if (!userId) {
      return res.status(400).json({ error: 'ì‚¬ìš©ì IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' });
    }

    // ì‚¬ìš©ì ê¶Œí•œ í™•ì¸
    const userRole = await getUserRole(userId);
    if (!userRole || (userRole !== 'SS' && userRole !== 'S')) {
      console.log(`âš ï¸ [ì „ì²´ì¬ê³„ì‚°] ê¶Œí•œ ë¶€ì¡±: ${userId} (${userRole})`);
      return res.status(403).json({
        error: 'ì „ì²´ì¬ê³„ì‚°ì€ SS ë ˆë²¨ ì´ìƒë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.',
        userRole: userRole
      });
    }

    console.log(`âœ… [ì „ì²´ì¬ê³„ì‚°] ê¶Œí•œ í™•ì¸ ì™„ë£Œ: ${userId} (${userRole})`);

    const sheets = google.sheets({ version: 'v4', auth });

    // 1. ëª¨ë“  ëŒ€ìƒì›” ì‹œíŠ¸ ì¡°íšŒ
    const monthSheetsData = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: 'ì˜ˆì‚°_ëŒ€ìƒì›”ê´€ë¦¬!A:D',
    });

    const monthRows = monthSheetsData.data.values || [];
    const results = [];

    // 2. ê° ëŒ€ìƒì›”ë³„ë¡œ ì²˜ë¦¬ (í—¤ë” ì œì™¸)
    for (const monthRow of monthRows.slice(1)) { // ì²« ë²ˆì§¸ í–‰(í—¤ë”) ì œì™¸
      if (!monthRow[0] || !monthRow[1]) continue; // ë¹ˆ í–‰ ìŠ¤í‚µ

      const targetMonth = monthRow[0];
      const sheetId = monthRow[1];

      console.log(`ğŸ”„ [ì „ì²´ì¬ê³„ì‚°] ${targetMonth}ì›” ì²˜ë¦¬ ì‹œì‘ (ì‹œíŠ¸ID: ${sheetId})`);

      try {
        // 3. ë©”ì¸ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì—ì„œ í•´ë‹¹ ì›”ì˜ ëª¨ë“  ì‚¬ìš©ì ì‹œíŠ¸ ì¡°íšŒ
        const userSheetsResponse = await sheets.spreadsheets.values.get({
          spreadsheetId: SPREADSHEET_ID,
          range: 'ì˜ˆì‚°_ì‚¬ìš©ìì‹œíŠ¸ê´€ë¦¬!A:AA',
        });

        const userSheetRows = userSheetsResponse.data.values || [];

        // 4. í•´ë‹¹ ì›”ì˜ ì‚¬ìš©ì ì‹œíŠ¸ë§Œ í•„í„°ë§
        const targetMonthUserSheets = userSheetRows.filter(row => {
          if (!row[0] || !row[1] || !row[5]) return false; // ì‚¬ìš©ìID, ì‹œíŠ¸ID, ëŒ€ìƒì›”ì´ ìˆëŠ”ì§€ í™•ì¸
          return row[5] === targetMonth; // ëŒ€ìƒì›”ì´ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
        });

        console.log(`ğŸ”„ [ì „ì²´ì¬ê³„ì‚°] ${targetMonth}ì›” - ${targetMonthUserSheets.length}ê°œ ì‚¬ìš©ì ì‹œíŠ¸ ë°œê²¬`);

        // 5. ê° ì‚¬ìš©ì ì‹œíŠ¸ë³„ë¡œ ì¬ê³„ì‚°
        for (const userRow of targetMonthUserSheets) {
          if (!userRow[0] || !userRow[1]) continue; // ë¹ˆ í–‰ ìŠ¤í‚µ

          const sheetName = userRow[2]; // Cì—´: ì‹œíŠ¸ëª…
          // ì‹œíŠ¸ ì´ë¦„ì—ì„œ ì˜ˆì‚° íƒ€ì… ì¶”ì¶œ (ì˜ˆ: "ì•¡ë©´_í™ê¸°í˜„(â… ) (íŒ€ì¥)" â†’ "â… ")
          let budgetType = 'â… '; // ê¸°ë³¸ê°’
          if (sheetName && sheetName.includes('(') && sheetName.includes(')')) {
            const match = sheetName.match(/\(([â… â…¡ì¢…í•©]+)\)/);
            if (match) {
              budgetType = match[1];
            }
          }

          console.log(`ğŸ”„ [ì „ì²´ì¬ê³„ì‚°] ${targetMonth}ì›” - ${sheetName} (${budgetType}) ê¸°ì¡´ ì €ì¥ ë²„íŠ¼ ë¡œì§ ì¬ì‹¤í–‰`);

          try {
            // 5. ì‚¬ìš©ì ì‹œíŠ¸ì—ì„œ ì…ë ¥ ë°ì´í„° ë¡œë“œ (ê¸°ì¡´ ì €ì¥ ë²„íŠ¼ê³¼ ë™ì¼í•œ ë°©ì‹)
            const userSheetDataResponse = await sheets.spreadsheets.values.get({
              spreadsheetId: sheetId,
              range: `${sheetName}!A:L`
            });

            const userSheetData = userSheetDataResponse.data.values || [];

            if (userSheetData.length <= 1) {
              console.log(`âš ï¸ [ì „ì²´ì¬ê³„ì‚°] ${sheetName}: ì‚¬ìš©ì ì‹œíŠ¸ ë°ì´í„° ë¶€ì¡±`);
              continue;
            }

            // 6. ê¸°ì¡´ ì €ì¥ ë²„íŠ¼ê³¼ ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ ë°ì´í„° ë³€í™˜
            const data = [];
            const modelGroups = {};

            // í—¤ë” ì œì™¸í•˜ê³  ë°ì´í„° ì²˜ë¦¬
            userSheetData.slice(1).forEach(row => {
              if (row.length >= 12) {
                const modelName = row[5]; // Fì—´: ëª¨ë¸ëª…
                const armyType = row[6]; // Gì—´: êµ°
                const categoryType = row[7]; // Hì—´: ìœ í˜•
                const usedBudget = parseFloat((row[9] || '').toString().replace(/,/g, '')) || 0; // Jì—´: ì‚¬ìš©ëœ ì˜ˆì‚°

                if (modelName && armyType && categoryType) {
                  if (!modelGroups[modelName]) {
                    modelGroups[modelName] = {
                      modelName,
                      expenditureValues: new Array(18).fill(0)
                    };
                  }

                  // êµ°/ìœ í˜•ë³„ ì¸ë±ìŠ¤ ê³„ì‚°
                  const armyIndex = ['Sêµ°', 'Aêµ°', 'Bêµ°', 'Cêµ°', 'Dêµ°', 'Eêµ°'].indexOf(armyType);
                  const categoryIndex = ['ì‹ ê·œ', 'MNP', 'ë³´ìƒ'].indexOf(categoryType);

                  if (armyIndex !== -1 && categoryIndex !== -1) {
                    const columnIndex = armyIndex * 3 + categoryIndex;
                    modelGroups[modelName].expenditureValues[columnIndex] = Math.round(usedBudget / 10000);
                  }
                }
              }
            });

            // ëª¨ë¸ ê·¸ë£¹ì„ ë°°ì—´ë¡œ ë³€í™˜
            Object.values(modelGroups).forEach(group => {
              data.push(group);
            });

            if (data.length === 0) {
              console.log(`âš ï¸ [ì „ì²´ì¬ê³„ì‚°] ${sheetName}: ë³€í™˜ëœ ë°ì´í„° ì—†ìŒ`);
              continue;
            }

            // 7. ë©”íƒ€ë°ì´í„° ì¶”ì¶œ (ê¸°ì¡´ ì €ì¥ ë²„íŠ¼ê³¼ ë™ì¼)
            let dateRange = {
              receiptStartDate: '',
              receiptEndDate: '',
              activationStartDate: '',
              activationEndDate: ''
            };

            // ì²« ë²ˆì§¸ ë°ì´í„° í–‰ì—ì„œ ë‚ ì§œ ì •ë³´ ì¶”ì¶œ
            if (userSheetData.length > 1) {
              const firstDataRow = userSheetData[1];
              if (firstDataRow.length >= 4) {
                dateRange.receiptStartDate = firstDataRow[0] || ''; // Aì—´: ì ‘ìˆ˜ì‹œì‘ì¼
                dateRange.receiptEndDate = firstDataRow[1] || ''; // Bì—´: ì ‘ìˆ˜ì¢…ë£Œì¼
                dateRange.activationStartDate = firstDataRow[2] || ''; // Cì—´: ê°œí†µì‹œì‘ì¼
                dateRange.activationEndDate = firstDataRow[3] || ''; // Dì—´: ê°œí†µì¢…ë£Œì¼
              }
            }

            // calculateUsageBudget í•¨ìˆ˜ê°€ ê¸°ëŒ€í•˜ëŠ” í˜•ì‹ìœ¼ë¡œ ë³€í™˜
            const calculateDateRange = {
              startDate: dateRange.receiptStartDate || dateRange.activationStartDate,
              endDate: dateRange.receiptEndDate || dateRange.activationEndDate
            };

            // ì…ë ¥ì ì •ë³´ ì¶”ì¶œ
            let inputUserName = '';
            if (userSheetData.length > 1) {
              const firstDataRow = userSheetData[1];
              if (firstDataRow.length >= 5) {
                const inputUser = firstDataRow[4]; // Eì—´: ì…ë ¥ì(ê¶Œí•œë ˆë²¨)
                if (inputUser) {
                  // "í™ê¸°í˜„(ë ˆë²¨SS)" í˜•íƒœì—ì„œ "í™ê¸°í˜„" ì¶”ì¶œ
                  inputUserName = inputUser.replace(/\(ë ˆë²¨[^)]+\)/, '').trim();
                }
              }
            }

            // 8. ê¸°ì¡´ ì €ì¥ ë²„íŠ¼ê³¼ ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ ì‚¬ìš©ì ì‹œíŠ¸ì— ë°ì´í„° ì €ì¥
            console.log(`ğŸ”„ [ì „ì²´ì¬ê³„ì‚°] ${sheetName}: ì‚¬ìš©ì ì‹œíŠ¸ ë°ì´í„° ì €ì¥ ì‹œì‘`);

            // ê¸°ì¡´ ì €ì¥ ë²„íŠ¼ê³¼ ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ ë°ì´í„° ë³€í™˜
            const rowsToSave = [];

            data.forEach(item => {
              if (item.modelName && item.expenditureValues) {
                // 18ê°œ ì»¬ëŸ¼ì˜ ì§€ì¶œì˜ˆì‚° ê°’ì„ ê°ê° ê°œë³„ í–‰ìœ¼ë¡œ ì €ì¥
                item.expenditureValues.forEach((expenditureValue, index) => {
                  // ëª¨ë¸ëª…ì´ ìˆìœ¼ë©´ ëª¨ë“  í–‰ì„ ì €ì¥ (ê°’ì´ 0ì´ì–´ë„ í¬í•¨)
                  const armyType = getArmyType(index + 1);
                  const categoryType = getCategoryType(index + 1);

                  // í•´ë‹¹ êµ°ì˜ ì˜ˆì‚°ê¸ˆì•¡ ê°€ì ¸ì˜¤ê¸° (ì˜ˆì‚°íƒ€ì…ì— ë”°ë¥¸ ê¸°ë³¸ê°’ ì ìš©)
                  const defaultAmount = budgetType === 'â…¡' ? 0 : 40000;
                  const securedBudget = defaultAmount;

                  // ì§€ì¶œì˜ˆì‚°ì„ 1ë§Œì› ë‹¨ìœ„ì—ì„œ ì› ë‹¨ìœ„ë¡œ ë³€í™˜ (ì˜ˆ: 2 -> 20000, -2 -> -20000)
                  const usedBudget = expenditureValue * 10000;

                  // ì˜ˆì‚° ì”ì•¡ ê³„ì‚°
                  const remainingBudget = securedBudget - usedBudget;

                  rowsToSave.push([
                    dateRange.receiptStartDate || '', // Aì—´: ì ‘ìˆ˜ì¼ ì‹œì‘
                    dateRange.receiptEndDate || '', // Bì—´: ì ‘ìˆ˜ì¼ ì¢…ë£Œ
                    dateRange.activationStartDate || '', // Cì—´: ê°œí†µì¼ ì‹œì‘
                    dateRange.activationEndDate || '', // Dì—´: ê°œí†µì¼ ì¢…ë£Œ
                    `${inputUserName}(ë ˆë²¨SS)`, // Eì—´: ì…ë ¥ì(ê¶Œí•œë ˆë²¨)
                    item.modelName, // Fì—´: ëª¨ë¸ëª…
                    armyType, // Gì—´: êµ°
                    categoryType, // Hì—´: ìœ í˜•
                    securedBudget, // Iì—´: í™•ë³´ëœ ì˜ˆì‚° (ì› ë‹¨ìœ„)
                    usedBudget, // Jì—´: ì‚¬ìš©ëœ ì˜ˆì‚° (ì› ë‹¨ìœ„)
                    remainingBudget, // Kì—´: ì˜ˆì‚° ì”ì•¡ (ì› ë‹¨ìœ„)
                    'ì •ìƒ' // Lì—´: ìƒíƒœ
                  ]);
                });
              }
            });

            // ì‚¬ìš©ì ì‹œíŠ¸ì— ë°ì´í„° ëˆ„ì  ì €ì¥ (ê¸°ì¡´ ë°ì´í„° ìœ ì§€í•˜ê³  ìƒˆ ë°ì´í„° ì¶”ê°€)
            if (rowsToSave.length > 0) {
              // í—¤ë”ê°€ ì—†ìœ¼ë©´ í—¤ë” ì¶”ê°€
              let existingData = [];
              try {
                const existingResponse = await sheets.spreadsheets.values.get({
                  spreadsheetId: sheetId,
                  range: `${sheetName}!A:L`
                });
                existingData = existingResponse.data.values || [];
              } catch (error) {
                console.log(`ğŸ“‹ [ì „ì²´ì¬ê³„ì‚°] ${sheetName}: ê¸°ì¡´ ë°ì´í„° ì—†ìŒ, ìƒˆë¡œ ìƒì„±`);
              }

              // í—¤ë”ê°€ ì—†ìœ¼ë©´ í—¤ë” ì¶”ê°€
              if (existingData.length === 0) {
                const headerRow = [
                  'ì ‘ìˆ˜ì‹œì‘ì¼', 'ì ‘ìˆ˜ì¢…ë£Œì¼', 'ê°œí†µì‹œì‘ì¼', 'ê°œí†µì¢…ë£Œì¼',
                  'ì…ë ¥ì(ê¶Œí•œë ˆë²¨)', 'ëª¨ë¸ëª…', 'êµ°', 'ìœ í˜•',
                  'í™•ë³´ëœ ì˜ˆì‚°', 'ì‚¬ìš©ëœ ì˜ˆì‚°', 'ì˜ˆì‚° ì”ì•¡', 'ìƒíƒœ'
                ];

                await sheets.spreadsheets.values.update({
                  spreadsheetId: sheetId,
                  range: `${sheetName}!A1:L1`,
                  valueInputOption: 'RAW',
                  resource: {
                    values: [headerRow]
                  }
                });
              }

              // ìƒˆ ë°ì´í„°ë¥¼ ê¸°ì¡´ ë°ì´í„° ì•„ë˜ì— ì¶”ê°€ (append ë°©ì‹)
              await sheets.spreadsheets.values.append({
                spreadsheetId: sheetId,
                range: `${sheetName}!A:L`,
                valueInputOption: 'RAW',
                insertDataOption: 'INSERT_ROWS',
                resource: {
                  values: rowsToSave
                }
              });

              console.log(`âœ… [ì „ì²´ì¬ê³„ì‚°] ${sheetName}: ì‚¬ìš©ì ì‹œíŠ¸ ë°ì´í„° ëˆ„ì  ì €ì¥ ì™„ë£Œ (ê¸°ì¡´ ${existingData.length}í–‰ + ìƒˆ ${rowsToSave.length}í–‰)`);
            }

            // 8-1. ê¸°ì¡´ ì‹œíŠ¸ ì»¬ëŸ¼ í™•ì¥ í™•ì¸ ë° í™•ì¥ (Xì—´ê¹Œì§€)
            try {
              const sheetInfo = await sheets.spreadsheets.get({
                spreadsheetId: sheetId
              });

              const targetSheet = sheetInfo.data.sheets.find(s => s.properties.title === sheetName);
              if (targetSheet && targetSheet.properties.gridProperties.columnCount < 24) {
                console.log(`ğŸ”„ [ì „ì²´ì¬ê³„ì‚°] ${sheetName}: ì»¬ëŸ¼ ìˆ˜ í™•ì¥ í•„ìš” (í˜„ì¬: ${targetSheet.properties.gridProperties.columnCount}, ëª©í‘œ: 24)`);

                await sheets.spreadsheets.batchUpdate({
                  spreadsheetId: sheetId,
                  resource: {
                    requests: [{
                      updateDimensionProperties: {
                        range: {
                          sheetId: targetSheet.properties.sheetId,
                          dimension: 'COLUMNS',
                          startIndex: 0,
                          endIndex: 24
                        },
                        properties: {
                          pixelSize: 100
                        },
                        fields: 'pixelSize'
                      }
                    }]
                  }
                });

                console.log(`âœ… [ì „ì²´ì¬ê³„ì‚°] ${sheetName}: ì»¬ëŸ¼ ìˆ˜ í™•ì¥ ì™„ë£Œ (24ê°œ)`);
              }
            } catch (expandError) {
              console.log(`âš ï¸ [ì „ì²´ì¬ê³„ì‚°] ${sheetName}: ì»¬ëŸ¼ í™•ì¥ ì‹¤íŒ¨ (ë¬´ì‹œí•˜ê³  ì§„í–‰):`, expandError.message);
            }

            // 8-2. ë©”íƒ€ë°ì´í„° ì €ì¥ (ê¸°ì¡´ ê°’ ë³´ì¡´, ì˜ˆì‚° ê´€ë ¨ ì»¬ëŸ¼ë§Œ ì—…ë°ì´íŠ¸)
            console.log(`ğŸ’¾ [ì „ì²´ì¬ê³„ì‚°] ${sheetName}: ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸ ì‹œì‘`);

            // ê¸°ì¡´ ë©”íƒ€ë°ì´í„° ì½ê¸° (Oì—´~Xì—´)
            let existingMetadataForUpdate = [];
            try {
              const existingMetadataResponse = await sheets.spreadsheets.values.get({
                spreadsheetId: sheetId,
                range: `${sheetName}!O:X`
              });
              existingMetadataForUpdate = existingMetadataResponse.data.values || [];
            } catch (error) {
              console.log(`ğŸ“‹ [ì „ì²´ì¬ê³„ì‚°] ${sheetName}: ê¸°ì¡´ ë©”íƒ€ë°ì´í„° ì—†ìŒ, ìƒˆë¡œ ìƒì„±`);
            }

            // í—¤ë”ê°€ ì—†ìœ¼ë©´ í—¤ë” ì¶”ê°€
            if (existingMetadataForUpdate.length === 0) {
              existingMetadataForUpdate = [
                ['ì €ì¥ì¼ì‹œ', 'ì ‘ìˆ˜ì¼ë²”ìœ„', 'ê°œí†µì¼ë²”ìœ„', 'ì ‘ìˆ˜ì¼ì ìš©ì—¬ë¶€', 'ê³„ì‚°ì¼ì‹œ', 'ê³„ì‚°ì', 'ì •ì±…ê·¸ë£¹', 'ì”ì•¡', 'í™•ë³´', 'ì‚¬ìš©']
              ];
            }

            // ê¸°ì¡´ ë°ì´í„° í–‰ì´ ì—†ìœ¼ë©´ ë¹ˆ í–‰ ì¶”ê°€
            if (existingMetadataForUpdate.length === 1) {
              existingMetadataForUpdate.push(['', '', '', '', '', '', '', '', '', '']);
            }

            // ê¸°ì¡´ ë©”íƒ€ë°ì´í„° ë³´ì¡´í•˜ë©´ì„œ í•„ìš”í•œ ë¶€ë¶„ë§Œ ì—…ë°ì´íŠ¸
            const updatedMetadata = [
              existingMetadataForUpdate[0], // í—¤ë”ëŠ” ê·¸ëŒ€ë¡œ
              [
                existingMetadataForUpdate[1]?.[0] || new Date().toISOString(), // Oì—´: ì €ì¥ì¼ì‹œ (ê¸°ì¡´ ê°’ ë³´ì¡´, ì—†ìœ¼ë©´ í˜„ì¬ ì‹œê°„)
                existingMetadataForUpdate[1]?.[1] || `${dateRange.receiptStartDate} ~ ${dateRange.receiptEndDate}`, // Pì—´: ì ‘ìˆ˜ì¼ë²”ìœ„ (ê¸°ì¡´ ê°’ ë³´ì¡´)
                existingMetadataForUpdate[1]?.[2] || `${dateRange.activationStartDate} ~ ${dateRange.activationEndDate}`, // Qì—´: ê°œí†µì¼ë²”ìœ„ (ê¸°ì¡´ ê°’ ë³´ì¡´)
                existingMetadataForUpdate[1]?.[3] || 'ì ìš©', // Rì—´: ì ‘ìˆ˜ì¼ì ìš©ì—¬ë¶€ (ê¸°ì¡´ ê°’ ë³´ì¡´)
                new Date().toISOString(), // Sì—´: ê³„ì‚°ì¼ì‹œ (í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸)
                existingMetadataForUpdate[1]?.[5] || inputUserName, // Tì—´: ê³„ì‚°ì (ê¸°ì¡´ ê°’ ë³´ì¡´, ì—†ìœ¼ë©´ í˜„ì¬ ì‚¬ìš©ì)
                existingMetadataForUpdate[1]?.[6] || policyGroupString, // Uì—´: ì •ì±…ê·¸ë£¹ (ê¸°ì¡´ ê°’ ë³´ì¡´, ì—†ìœ¼ë©´ í˜„ì¬ ì •ì±…ê·¸ë£¹)
                '', // Vì—´: ì”ì•¡ (ë‚˜ì¤‘ì— ê³„ì‚° ê²°ê³¼ë¡œ ì—…ë°ì´íŠ¸)
                '', // Wì—´: í™•ë³´ (ë‚˜ì¤‘ì— ê³„ì‚° ê²°ê³¼ë¡œ ì—…ë°ì´íŠ¸)
                ''  // Xì—´: ì‚¬ìš© (ë‚˜ì¤‘ì— ê³„ì‚° ê²°ê³¼ë¡œ ì—…ë°ì´íŠ¸)
              ]
            ];

            // ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸
            await sheets.spreadsheets.values.update({
              spreadsheetId: sheetId,
              range: `${sheetName}!O1:X2`,
              valueInputOption: 'RAW',
              resource: {
                values: updatedMetadata
              }
            });

            console.log(`âœ… [ì „ì²´ì¬ê³„ì‚°] ${sheetName}: ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸ ì™„ë£Œ (ê¸°ì¡´ ê°’ ë³´ì¡´)`);

            // 9. ì•¡ë©´ì˜ˆì‚° ì‹œíŠ¸ ë¶€ë¶„ ì˜ì—­ ì´ˆê¸°í™” (ì˜¬ë°”ë¥¸ ì»¬ëŸ¼ ë²”ìœ„)
            console.log(`ğŸ”„ [ì „ì²´ì¬ê³„ì‚°] ${sheetName}: ì•¡ë©´ì˜ˆì‚° ì‹œíŠ¸ ë¶€ë¶„ ì˜ì—­ ì´ˆê¸°í™” ì‹œì‘`);

            if (budgetType === 'â…¡') {
              // ì•¡ë©´ì˜ˆì‚°(â…¡): B5:Cì—´(ì…ë ¥ì/ì…ë ¥ì¼ì‹œ), I5:Kì—´(ì˜ˆì‚° ê´€ë ¨)
              await sheets.spreadsheets.values.clear({
                spreadsheetId: sheetId,
                range: 'ì•¡ë©´ì˜ˆì‚°!B5:C'
              });
              await sheets.spreadsheets.values.clear({
                spreadsheetId: sheetId,
                range: 'ì•¡ë©´ì˜ˆì‚°!I5:K'
              });
              console.log(`ğŸ§¹ [ì „ì²´ì¬ê³„ì‚°] ${sheetName}: ì•¡ë©´ì˜ˆì‚° ì‹œíŠ¸ B5:Cì—´, I5:Kì—´ ì´ˆê¸°í™” ì™„ë£Œ`);
            } else {
              // ì•¡ë©´ì˜ˆì‚°(â… ): D5:Eì—´(ì…ë ¥ì/ì…ë ¥ì¼ì‹œ), L5:Nì—´(ì˜ˆì‚° ê´€ë ¨)
              await sheets.spreadsheets.values.clear({
                spreadsheetId: sheetId,
                range: 'ì•¡ë©´ì˜ˆì‚°!D5:E'
              });
              await sheets.spreadsheets.values.clear({
                spreadsheetId: sheetId,
                range: 'ì•¡ë©´ì˜ˆì‚°!L5:N'
              });
              console.log(`ğŸ§¹ [ì „ì²´ì¬ê³„ì‚°] ${sheetName}: ì•¡ë©´ì˜ˆì‚° ì‹œíŠ¸ D5:Eì—´, L5:Nì—´ ì´ˆê¸°í™” ì™„ë£Œ`);
            }

            // 10. ê¸°ì¡´ calculateUsageBudget í•¨ìˆ˜ í˜¸ì¶œ (ì•¡ë©´ì˜ˆì‚° ê³„ì‚° + ì…ë ¥)
            console.log(`ğŸ”„ [ì „ì²´ì¬ê³„ì‚°] ${sheetName}: ì•¡ë©´ì˜ˆì‚° ê³„ì‚° ì‹œì‘`);

            // ê¸°ì¡´ ì €ì¥ ë²„íŠ¼ê³¼ ë™ì¼í•œ ë§¤ê°œë³€ìˆ˜ë¡œ calculateUsageBudget í˜¸ì¶œ
            // ì •ì±…ê·¸ë£¹ì„ ì‹¤ì œ ì‚¬ìš©ì ì‹œíŠ¸ì—ì„œ ì½ì–´ì˜¤ê¸°
            let policyGroupString = userRow[6]; // Gì—´: ì„ íƒëœì •ì±…ê·¸ë£¹
            if (!policyGroupString) {
              // ì •ì±…ê·¸ë£¹ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš© (ë””ë²„ê¹…ìš©)
              policyGroupString = 'í™ê¸°í˜„ì§ì˜,í™ê¸°í˜„ë³„ë„,í™ê¸°í˜„,í‰íƒì‚¬ë¬´ì‹¤,ì„ì¬ìš±ë³„ë„,ì„ì¬ìš±,ì´ì€ë¡,ì–‘ì§„ì˜ë³„ë„,ì–‘ì§„ì˜,ì´ë•ì œ,ê¹€ì¼í™˜,ê¹€ì¼í™˜ë³„ë„';
              console.log(`âš ï¸ [ì „ì²´ì¬ê³„ì‚°] ${sheetName}: ì •ì±…ê·¸ë£¹ ì •ë³´ ì—†ìŒ, ê¸°ë³¸ê°’ ì‚¬ìš©: ${policyGroupString}`);
            } else {
              console.log(`ğŸ“‹ [ì „ì²´ì¬ê³„ì‚°] ${sheetName}: ì •ì±…ê·¸ë£¹ ì •ë³´: ${policyGroupString}`);
            }
            const selectedPolicyGroups = policyGroupString.split(',').map(group => group.trim());
            console.log(`ğŸ” [ì „ì²´ì¬ê³„ì‚°] ${sheetName}: íŒŒì‹±ëœ ì •ì±…ê·¸ë£¹:`, selectedPolicyGroups);

            const calculationResult = await calculateUsageBudget(
              sheetId,
              selectedPolicyGroups,
              calculateDateRange,
              inputUserName,
              budgetType
            );

            console.log(`âœ… [ì „ì²´ì¬ê³„ì‚°] ${sheetName}: ì•¡ë©´ì˜ˆì‚° ê³„ì‚° ì™„ë£Œ`);

            // 9-1. ì•¡ë©´ì˜ˆì‚° ì‹œíŠ¸ ë¶€ë¶„ ì˜ì—­ ì´ˆê¸°í™” (ì˜¬ë°”ë¥¸ ìˆœì„œë¡œ ìˆ˜ì •)
            // calculateUsageBudget í˜¸ì¶œ í›„ ì´ˆê¸°í™”ëŠ” ë¶ˆí•„ìš” (ì´ë¯¸ ë°ì´í„° ì…ë ¥ë¨)
            console.log(`ğŸ§¹ [ì „ì²´ì¬ê³„ì‚°] ${sheetName}: ì•¡ë©´ì˜ˆì‚° ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì™„ë£Œ (calculateUsageBudgetì—ì„œ ì²˜ë¦¬ë¨)`);

            // 9-2. ê¸°ì¡´ ì €ì¥ ë²„íŠ¼ê³¼ ë™ì¼í•˜ê²Œ ì‚¬ìš©ì ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ìˆ˜í–‰
            console.log(`ğŸ”„ [ì „ì²´ì¬ê³„ì‚°] ${sheetName}: ì‚¬ìš©ì ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì‹œì‘`);

            // ì‚¬ìš©ì ì‹œíŠ¸ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì—…ë°ì´íŠ¸ìš©)
            const userSheetUpdateResponse = await sheets.spreadsheets.values.get({
              spreadsheetId: sheetId,
              range: `${sheetName}!A2:L`, // ì‚¬ìš©ì ì‹œíŠ¸ ë°ì´í„° ë²”ìœ„ (12ê°œ ì»¬ëŸ¼)
            });

            const userSheetUpdateRows = userSheetUpdateResponse.data.values || [];

            // 9-3. ê³„ì‚° ê²°ê³¼ë¥¼ ì‚¬ìš©ì ì‹œíŠ¸ ë©”íƒ€ë°ì´í„°ì— ëˆ„ì  ì €ì¥ (Oì—´~Xì—´)
            console.log(`ğŸ’¾ [ì „ì²´ì¬ê³„ì‚°] ${sheetName}: ê³„ì‚° ê²°ê³¼ ë©”íƒ€ë°ì´í„° ëˆ„ì  ì €ì¥ ì‹œì‘`);

            // ê¸°ì¡´ ë©”íƒ€ë°ì´í„° ì½ê¸° (Oì—´~Xì—´)
            let existingMetadataForCalculation = [];
            try {
              const metadataResponse = await sheets.spreadsheets.values.get({
                spreadsheetId: sheetId,
                range: `${sheetName}!O:X`
              });
              existingMetadataForCalculation = metadataResponse.data.values || [];
            } catch (error) {
              console.log(`ğŸ“‹ [ì „ì²´ì¬ê³„ì‚°] ${sheetName}: ê¸°ì¡´ ë©”íƒ€ë°ì´í„° ì—†ìŒ, ìƒˆë¡œ ìƒì„±`);
            }

            // í—¤ë” ì„¤ì • (Oì—´~Xì—´)
            const metadataHeader = [
              'ì €ì¥ì¼ì‹œ', 'ì ‘ìˆ˜ì¼ë²”ìœ„', 'ê°œí†µì¼ë²”ìœ„', 'ì ‘ìˆ˜ì¼ì ìš©ì—¬ë¶€',
              'ê³„ì‚°ì¼ì‹œ', 'ê³„ì‚°ì', 'ì •ì±…ê·¸ë£¹', 'ì”ì•¡', 'í™•ë³´', 'ì‚¬ìš©'
            ];

            // ìƒˆ ì •ì±… ë°ì´í„° í–‰ ìƒì„±
            const newPolicyRow = [
              new Date().toISOString(),           // Oì—´: ì €ì¥ì¼ì‹œ
              calculateDateRange.receiptStartDate && calculateDateRange.receiptEndDate
                ? `${calculateDateRange.receiptStartDate} ~ ${calculateDateRange.receiptEndDate}`
                : 'ë¯¸ì„¤ì •',                       // Pì—´: ì ‘ìˆ˜ì¼ë²”ìœ„
              `${calculateDateRange.activationStartDate} ~ ${calculateDateRange.activationEndDate}`, // Qì—´: ê°œí†µì¼ë²”ìœ„
              calculateDateRange.receiptStartDate && calculateDateRange.receiptEndDate
                ? 'ì ìš©'
                : 'ë¯¸ì ìš©',                       // Rì—´: ì ‘ìˆ˜ì¼ì ìš©ì—¬ë¶€
              new Date().toISOString(),           // Sì—´: ê³„ì‚°ì¼ì‹œ
              inputUserName,                      // Tì—´: ê³„ì‚°ì
              selectedPolicyGroups.join(','),     // Uì—´: ì •ì±…ê·¸ë£¹
              calculationResult.totalRemainingBudget, // Vì—´: ì”ì•¡
              calculationResult.totalSecuredBudget,   // Wì—´: í™•ë³´
              calculationResult.totalUsedBudget       // Xì—´: ì‚¬ìš©
            ];

            // ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸ (ê¸°ì¡´ ë°ì´í„° ìœ ì§€í•˜ê³  ìƒˆ í–‰ ì¶”ê°€)
            const metadataUpdateRequests = [];

            // í—¤ë”ê°€ ì—†ìœ¼ë©´ í—¤ë” ì¶”ê°€
            if (existingMetadataForCalculation.length === 0) {
              metadataUpdateRequests.push({
                range: `${sheetName}!O1:X1`,
                values: [metadataHeader]
              });
            }

            // ìƒˆ ì •ì±… ë°ì´í„° í–‰ ì¶”ê°€
            metadataUpdateRequests.push({
              range: `${sheetName}!O${existingMetadataForCalculation.length + 2}:X${existingMetadataForCalculation.length + 2}`,
              values: [newPolicyRow]
            });

            // ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸ ì‹¤í–‰
            if (metadataUpdateRequests.length > 0) {
              await sheets.spreadsheets.values.batchUpdate({
                spreadsheetId: sheetId,
                resource: {
                  valueInputOption: 'RAW',
                  data: metadataUpdateRequests
                }
              });
              console.log(`âœ… [ì „ì²´ì¬ê³„ì‚°] ${sheetName}: ë©”íƒ€ë°ì´í„° ëˆ„ì  ì €ì¥ ì™„ë£Œ (${existingMetadataForCalculation.length + 1}ë²ˆì§¸ ì •ì±…)`);
            }

            // ì•¡ë©´ì˜ˆì‚° íƒ€ì…ì— ë”°ë¥¸ ì•¡ë©´ì˜ˆì‚° ë§¤í•‘ ì»¬ëŸ¼ ê²°ì •
            const currentBudgetType = budgetType || 'â… ';
            let phoneklColumns = {};

            if (currentBudgetType === 'â… ') {
              // ì•¡ë©´ì˜ˆì‚°(â… ): Lì—´(ì˜ˆì‚°ì”ì•¡), Mì—´(í™•ë³´ì˜ˆì‚°), Nì—´(ì‚¬ìš©ì˜ˆì‚°)
              phoneklColumns = {
                remainingBudget: 'L', // ì˜ˆì‚°ì”ì•¡
                securedBudget: 'M',   // í™•ë³´ì˜ˆì‚°
                usedBudget: 'N'       // ì‚¬ìš©ì˜ˆì‚°
              };
            } else if (currentBudgetType === 'â…¡') {
              // ì•¡ë©´ì˜ˆì‚°(â…¡): Iì—´(ì˜ˆì‚°ì”ì•¡), Jì—´(í™•ë³´ì˜ˆì‚°), Kì—´(ì‚¬ìš©ì˜ˆì‚°)
              phoneklColumns = {
                remainingBudget: 'I', // ì˜ˆì‚°ì”ì•¡
                securedBudget: 'J',   // í™•ë³´ì˜ˆì‚°
                usedBudget: 'K'       // ì‚¬ìš©ì˜ˆì‚°
              };
            }

            // ì•¡ë©´ì˜ˆì‚°ì—ì„œ ê³„ì‚°ëœ ë°ì´í„°ë¥¼ ì‚¬ìš©ì ì‹œíŠ¸ì˜ ì‚¬ìš©ì˜ˆì‚°ì— ë°˜ì˜
            const updateRequests = [];

            // calculateUsageBudget ê²°ê³¼ì—ì„œ calculatedData í™•ì¸
            console.log(`ğŸ” [ì „ì²´ì¬ê³„ì‚°] ${sheetName}: calculationResult í™•ì¸:`, {
              calculatedDataLength: calculationResult.calculatedData?.length || 0,
              totalRemainingBudget: calculationResult.totalRemainingBudget,
              totalSecuredBudget: calculationResult.totalSecuredBudget,
              totalUsedBudget: calculationResult.totalUsedBudget
            });

            userSheetUpdateRows.forEach((row, index) => {
              if (row.length >= 12) {
                const armyType = row[6]; // êµ° (Gì—´)
                const categoryType = row[7]; // ìœ í˜• (Hì—´)

                // ì•¡ë©´ì˜ˆì‚°ì—ì„œ í•´ë‹¹ êµ°/ìœ í˜•ì— ë§ëŠ” ì‚¬ìš©ì˜ˆì‚° ì°¾ê¸°
                const matchingData = calculationResult.calculatedData?.find(data =>
                  data.armyType === armyType && data.categoryType === categoryType
                );

                if (matchingData) {
                  // ì‚¬ìš©ì˜ˆì‚° ì—…ë°ì´íŠ¸ (Jì—´)
                  updateRequests.push({
                    range: `${sheetName}!J${index + 2}`,
                    values: [[matchingData.budgetValue]]
                  });

                  // ì”ì•¡ ì—…ë°ì´íŠ¸ (Kì—´) - ì˜ˆì‚°íƒ€ì…ì— ë”°ë¥¸ í™•ë³´ì˜ˆì‚°
                  const defaultSecuredBudget = budgetType === 'â…¡' ? 0 : 40000;
                  const securedBudget = defaultSecuredBudget;
                  const remainingBudget = securedBudget - matchingData.budgetValue;
                  updateRequests.push({
                    range: `${sheetName}!K${index + 2}`,
                    values: [[remainingBudget]]
                  });

                  console.log(`ğŸ’¾ [ì „ì²´ì¬ê³„ì‚°] ${sheetName} Row ${index + 2} ì—…ë°ì´íŠ¸: ì‚¬ìš©ì˜ˆì‚°=${matchingData.budgetValue}, ì”ì•¡=${remainingBudget}`);
                } else {
                  console.log(`âš ï¸ [ì „ì²´ì¬ê³„ì‚°] ${sheetName} Row ${index + 2} ë§¤ì¹­ ì‹¤íŒ¨: êµ°=${armyType}, ìœ í˜•=${categoryType}`);
                }
              }
            });

            // ì‚¬ìš©ì ì‹œíŠ¸ ì—…ë°ì´íŠ¸
            if (updateRequests.length > 0) {
              console.log(`ğŸš€ [ì „ì²´ì¬ê³„ì‚°] ${sheetName} ë°°ì¹˜ ì—…ë°ì´íŠ¸ ì‹¤í–‰: ${updateRequests.length}ê°œ ì…€`);

              try {
                await sheets.spreadsheets.values.batchUpdate({
                  spreadsheetId: sheetId,
                  resource: {
                    valueInputOption: 'RAW',
                    data: updateRequests
                  }
                });

                console.log(`âœ… [ì „ì²´ì¬ê³„ì‚°] ${sheetName} ë°°ì¹˜ ì—…ë°ì´íŠ¸ ì„±ê³µ: ${updateRequests.length}ê°œ ì…€`);
              } catch (error) {
                console.error(`âŒ [ì „ì²´ì¬ê³„ì‚°] ${sheetName} ë°°ì¹˜ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:`, error);
                throw error;
              }
            }

            // 11. ê²°ê³¼ ì €ì¥ (ê¸°ì¡´ ì €ì¥ ë²„íŠ¼ê³¼ ë™ì¼í•œ ë°©ì‹)
            results.push({
              month: targetMonth,
              sheetName,
              budgetType,
              totalRemainingBudget: calculationResult.totalRemainingBudget,
              totalSecuredBudget: calculationResult.totalSecuredBudget,
              totalUsedBudget: calculationResult.totalUsedBudget,
              updatedRows: updateRequests.length,
              success: true
            });

            console.log(`âœ… [ì „ì²´ì¬ê³„ì‚°] ${sheetName} ì™„ë£Œ: ì”ì•¡=${calculationResult.totalRemainingBudget}, í™•ë³´=${calculationResult.totalSecuredBudget}, ì‚¬ìš©=${calculationResult.totalUsedBudget}, ë§¤ì¹­í–‰=${updateRequests.length}`);

          } catch (userSheetError) {
            console.error(`âŒ [ì „ì²´ì¬ê³„ì‚°] ${sheetName} ì²˜ë¦¬ ì‹¤íŒ¨:`, userSheetError.message);
            results.push({
              month: targetMonth,
              sheetName,
              budgetType,
              success: false,
              error: userSheetError.message
            });
          }
        }

      } catch (monthError) {
        console.error(`âŒ [ì „ì²´ì¬ê³„ì‚°] ${targetMonth}ì›” ì²˜ë¦¬ ì‹¤íŒ¨:`, monthError.message);
        results.push({
          month: targetMonth,
          success: false,
          error: monthError.message
        });
      }
    }

    console.log(`ğŸ”„ [ì „ì²´ì¬ê³„ì‚°] ì™„ë£Œ - ì´ ${results.length}ê°œ ì‹œíŠ¸ ì²˜ë¦¬`);

    res.json({
      success: true,
      message: 'ì „ì²´ ì¬ê³„ì‚°ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.',
      results
    });

  } catch (error) {
    console.error('âŒ [ì „ì²´ì¬ê³„ì‚°] ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: 'ì „ì²´ ì¬ê³„ì‚° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
      message: error.message
    });
  }
});

// ìŠ¤ì¼€ì¤„ëŸ¬ ì„¤ì • - ë§¤ì¼ ìƒˆë²½ 2ì‹œì— ìë™ ì¬ê³„ì‚° (í´ë¼ìš°ë“œíƒ€ì… íŒ¨í‚¤ì§€ ë¬¸ì œë¡œ ì„ì‹œ ë¹„í™œì„±í™”)
// cron.schedule('0 2 * * *', async () => {
//   try {
//     console.log('ğŸ• [ìŠ¤ì¼€ì¤„ëŸ¬] ìë™ ì¬ê³„ì‚° ì‹œì‘');
//     
//     // ì „ì²´ ì¬ê³„ì‚° API í˜¸ì¶œ
//     const response = await fetch('http://localhost:4000/api/budget/recalculate-all', {
//       method: 'POST',
//       headers: {
//         'Content-Type': 'application/json'
//       }
//     });
//     
//     if (response.ok) {
//       const result = await response.json();
//       console.log('âœ… [ìŠ¤ì¼€ì¤„ëŸ¬] ìë™ ì¬ê³„ì‚° ì™„ë£Œ:', result.message);
//     } else {
//       console.error('âŒ [ìŠ¤ì¼€ì¤„ëŸ¬] ìë™ ì¬ê³„ì‚° ì‹¤íŒ¨:', response.status);
//     }
//     
//   } catch (error) {
//     console.error('âŒ [ìŠ¤ì¼€ì¤„ëŸ¬] ìë™ ì¬ê³„ì‚° ì˜¤ë¥˜:', error);
//   }
// }, {
//   timezone: 'Asia/Seoul'
// });

// console.log('ğŸ• [ìŠ¤ì¼€ì¤„ëŸ¬] ë§¤ì¼ ìƒˆë²½ 2ì‹œ ìë™ ì¬ê³„ì‚° ì„¤ì • ì™„ë£Œ');

// ===== ì¬ê³ íšŒìˆ˜ëª¨ë“œ API =====

// ì¬ê³ íšŒìˆ˜ ë°ì´í„° ì¡°íšŒ API
app.get('/api/inventory-recovery/data', async (req, res) => {
  console.log('ğŸ” [ì¬ê³ íšŒìˆ˜ API] ìš”ì²­ ë°›ìŒ - ì‹œì‘');
  console.log('ğŸ” [ì¬ê³ íšŒìˆ˜ API] ìš”ì²­ í—¤ë”:', req.headers);
  console.log('ğŸ” [ì¬ê³ íšŒìˆ˜ API] ìš”ì²­ URL:', req.url);
  console.log('ğŸ” [ì¬ê³ íšŒìˆ˜ API] ìš”ì²­ ë©”ì„œë“œ:', req.method);

  // CORS í—¤ë” ì„¤ì •
  const allowedOrigins = [
    'https://vipmobile.vercel.app',
    'https://vipmobile.vercel.app/',
    'http://localhost:3000',
    'http://localhost:3001',
    'http://localhost:4000'
  ];

  const origin = req.headers.origin;
  console.log('ğŸ” [ì¬ê³ íšŒìˆ˜ API] Origin:', origin);

  if (origin && allowedOrigins.includes(origin)) {
    res.header('Access-Control-Allow-Origin', origin);
    console.log('ğŸ” [ì¬ê³ íšŒìˆ˜ API] CORS í—ˆìš©ëœ Origin ì‚¬ìš©:', origin);
  } else {
    res.header('Access-Control-Allow-Origin', '*');
    console.log('ğŸ” [ì¬ê³ íšŒìˆ˜ API] CORS * ì‚¬ìš©');
  }

  res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
  res.header('Access-Control-Allow-Headers', 'Origin, X-Requested-With, Content-Type, Accept, Authorization');
  res.header('Access-Control-Allow-Credentials', 'true');

  if (req.method === 'OPTIONS') {
    console.log('ğŸ” [ì¬ê³ íšŒìˆ˜ API] OPTIONS ìš”ì²­ - 200 ì‘ë‹µ');
    res.sendStatus(200);
    return;
  }

  try {
    console.log('ğŸ”„ [ì¬ê³ íšŒìˆ˜] ë°ì´í„° ì¡°íšŒ ì‹œì‘');

    // íšŒìˆ˜ëª©ë¡ ì‹œíŠ¸ë§Œ ê°€ì ¸ì˜¤ê¸° (ì¢Œí‘œëŠ” "íšŒìˆ˜ëª©ë¡" ì‹œíŠ¸ì—ì„œ ì§ì ‘ ì½ê¸°)
    console.log('ğŸ” [ì¬ê³ íšŒìˆ˜ API] Google Sheets API í˜¸ì¶œ ì‹œì‘');
    console.log('ğŸ” [ì¬ê³ íšŒìˆ˜ API] Spreadsheet ID:', process.env.INVENTORY_RECOVERY_SPREADSHEET_ID || '1soJE2C2svNCfLBSJsZBoXiBQIAglgefQpnehWqDUmuY');
    console.log('ğŸ” [ì¬ê³ íšŒìˆ˜ API] Sheet Name:', process.env.INVENTORY_RECOVERY_SHEET_NAME || 'íšŒìˆ˜ëª©ë¡');

    const recoveryListResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: process.env.INVENTORY_RECOVERY_SPREADSHEET_ID || '1soJE2C2svNCfLBSJsZBoXiBQIAglgefQpnehWqDUmuY',
      range: (process.env.INVENTORY_RECOVERY_SHEET_NAME || 'íšŒìˆ˜ëª©ë¡') + '!A:AA'
    });

    console.log('ğŸ” [ì¬ê³ íšŒìˆ˜ API] Google Sheets API ì‘ë‹µ ë°›ìŒ');
    console.log('ğŸ” [ì¬ê³ íšŒìˆ˜ API] ì‘ë‹µ ë°ì´í„° ì¡´ì¬ ì—¬ë¶€:', !!recoveryListResponse.data.values);
    console.log('ğŸ” [ì¬ê³ íšŒìˆ˜ API] ì‘ë‹µ ë°ì´í„° ê¸¸ì´:', recoveryListResponse.data.values?.length || 0);

    if (!recoveryListResponse.data.values) {
      console.error('âŒ [ì¬ê³ íšŒìˆ˜ API] ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      throw new Error('ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    // í—¤ë” ì œê±°
    const recoveryData = recoveryListResponse.data.values.slice(1);

    // íšŒìˆ˜ ë°ì´í„° ì²˜ë¦¬
    console.log(`ğŸ” [ì¬ê³ íšŒìˆ˜] ì›ë³¸ ë°ì´í„°: ${recoveryData.length}í–‰`);

    const processedData = recoveryData
      .filter(row => {
        const hasEnoughColumns = row.length > 25;
        if (!hasEnoughColumns) {
          console.log(`âš ï¸ [ì¬ê³ íšŒìˆ˜] ì»¬ëŸ¼ ë¶€ì¡±: ${row.length}ê°œ (í•„ìš”: 26ê°œ)`);
        }
        return hasEnoughColumns;
      })
      .map((row, index) => {
        const storeName = (row[25] || '').toString().trim(); // Zì—´(25ë²ˆì¸ë±ìŠ¤): ì¶œê³ ì²˜(ì—…ì²´ëª…)
        const latitude = parseFloat(row[8] || '0'); // Iì—´(8ë²ˆì¸ë±ìŠ¤): ìœ„ë„
        const longitude = parseFloat(row[9] || '0'); // Jì—´(9ë²ˆì¸ë±ìŠ¤): ê²½ë„

        const item = {
          recoveryCompleted: row[10] || '', // Kì—´(10ë²ˆì¸ë±ìŠ¤): íšŒìˆ˜ì™„ë£Œ
          recoveryTargetSelected: row[11] || '', // Lì—´(11ë²ˆì¸ë±ìŠ¤): íšŒìˆ˜ëŒ€ìƒì„ ì •
          manager: row[12] || '', // Mì—´(12ë²ˆì¸ë±ìŠ¤): ë‹´ë‹¹ì
          address: row[7] || '', // Hì—´(7ë²ˆì¸ë±ìŠ¤): ì£¼ì†Œ
          entryDate: row[13] || '', // Nì—´(13ë²ˆì¸ë±ìŠ¤): ì…ê³ ì¼
          status: row[14] || '', // Oì—´(14ë²ˆì¸ë±ìŠ¤): í˜„í™©
          serialNumber: row[15] || '', // Pì—´(15ë²ˆì¸ë±ìŠ¤): ì¼ë ¨ë²ˆí˜¸
          category: row[16] || '', // Qì—´(16ë²ˆì¸ë±ìŠ¤): ì¢…ë¥˜
          modelName: row[17] || '', // Rì—´(17ë²ˆì¸ë±ìŠ¤): ëª¨ë¸ëª…
          color: row[18] || '', // Sì—´(18ë²ˆì¸ë±ìŠ¤): ìƒ‰ìƒ
          deviceStatus: row[19] || '', // Tì—´(19ë²ˆì¸ë±ìŠ¤): ìƒíƒœ
          payment: row[20] || '', // Uì—´(20ë²ˆì¸ë±ìŠ¤): ê²°ì œ
          entryPrice: row[21] || '', // Vì—´(21ë²ˆì¸ë±ìŠ¤): ì…ê³ ê°€
          entrySource: row[22] || '', // Wì—´(22ë²ˆì¸ë±ìŠ¤): ì…ê³ ì²˜
          carrier: row[23] || '', // Xì—´(23ë²ˆì¸ë±ìŠ¤): í†µì‹ ì‚¬
          employee: row[24] || '', // Yì—´(24ë²ˆì¸ë±ìŠ¤): ë‹´ë‹¹ì‚¬ì›
          storeName, // Zì—´(25ë²ˆì¸ë±ìŠ¤): ì¶œê³ ì²˜(ì—…ì²´ëª…)
          recentShipmentDate: row[26] || '', // AAì—´(26ë²ˆì¸ë±ìŠ¤): ìµœê·¼ì¶œê³ ì¼
          latitude: latitude,
          longitude: longitude,
          hasCoordinates: latitude !== 0 && longitude !== 0,
          rowIndex: recoveryData.indexOf(row) + 2 // ì‹¤ì œ ì‹œíŠ¸ í–‰ ë²ˆí˜¸ (í—¤ë” ì œì™¸)
        };

        console.log(`ğŸ” [ì¬ê³ íšŒìˆ˜] í–‰${index + 1}: ${storeName} (${latitude}, ${longitude})`);
        return item;
      })
      .filter(item => {
        const hasStoreName = item.storeName && item.storeName.length > 0;

        if (!hasStoreName) {
          console.log(`âš ï¸ [ì¬ê³ íšŒìˆ˜] ì—…ì²´ëª… ëˆ„ë½: ${JSON.stringify(item)}`);
        }

        return hasStoreName; // ì¢Œí‘œê°€ ì—†ì–´ë„ ì—…ì²´ëª…ë§Œ ìˆìœ¼ë©´ í¬í•¨
      });

    console.log(`âœ… [ì¬ê³ íšŒìˆ˜] ë°ì´í„° ì¡°íšŒ ì™„ë£Œ: ${processedData.length}ê°œ í•­ëª©`);
    console.log('ğŸ” [ì¬ê³ íšŒìˆ˜ API] ì‘ë‹µ ë°ì´í„° ìƒ˜í”Œ:', processedData.slice(0, 2));

    res.json({
      success: true,
      data: processedData
    });

    console.log('ğŸ” [ì¬ê³ íšŒìˆ˜ API] ì‘ë‹µ ì „ì†¡ ì™„ë£Œ');

  } catch (error) {
    console.error('âŒ [ì¬ê³ íšŒìˆ˜] ë°ì´í„° ì¡°íšŒ ì˜¤ë¥˜:', error);
    console.error('âŒ [ì¬ê³ íšŒìˆ˜ API] ì—ëŸ¬ ìŠ¤íƒ:', error.stack);
    console.error('âŒ [ì¬ê³ íšŒìˆ˜ API] ì—ëŸ¬ ë©”ì‹œì§€:', error.message);

    res.status(500).json({
      success: false,
      error: 'ì¬ê³ íšŒìˆ˜ ë°ì´í„° ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
      message: error.message
    });
  }
});

// ì¬ê³ íšŒìˆ˜ ìƒíƒœ ì—…ë°ì´íŠ¸ API
app.post('/api/inventory-recovery/update-status', async (req, res) => {
  // CORS í—¤ë” ì„¤ì •
  const allowedOrigins = [
    'https://vipmobile.vercel.app',
    'https://vipmobile.vercel.app/',
    'http://localhost:3000',
    'http://localhost:3001',
    'http://localhost:4000'
  ];

  const origin = req.headers.origin;
  if (origin && allowedOrigins.includes(origin)) {
    res.header('Access-Control-Allow-Origin', origin);
  } else {
    res.header('Access-Control-Allow-Origin', '*');
  }

  res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
  res.header('Access-Control-Allow-Headers', 'Origin, X-Requested-With, Content-Type, Accept, Authorization');
  res.header('Access-Control-Allow-Credentials', 'true');

  if (req.method === 'OPTIONS') {
    res.sendStatus(200);
    return;
  }

  try {
    const { rowIndex, column, value } = req.body;

    if (!rowIndex || !column || value === undefined) {
      return res.status(400).json({
        success: false,
        error: 'í•„ìˆ˜ íŒŒë¼ë¯¸í„°ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤. (rowIndex, column, value)'
      });
    }

    console.log(`ğŸ”„ [ì¬ê³ íšŒìˆ˜] ìƒíƒœ ì—…ë°ì´íŠ¸: í–‰${rowIndex}, ì—´${column}, ê°’=${value}`);

    // êµ¬ê¸€ì‹œíŠ¸ ì—…ë°ì´íŠ¸
    let ranges = [];
    let values = [];

    if (column === 'recoveryCompleted') {
      ranges.push(`íšŒìˆ˜ëª©ë¡!K${rowIndex}`); // Kì—´(10ë²ˆì¸ë±ìŠ¤): íšŒìˆ˜ì™„ë£Œ
      values.push([value]);
    } else if (column === 'recoveryTargetSelected') {
      ranges.push(`íšŒìˆ˜ëª©ë¡!L${rowIndex}`); // Lì—´(11ë²ˆì¸ë±ìŠ¤): íšŒìˆ˜ëŒ€ìƒì„ ì •
      values.push([value]);

      // íšŒìˆ˜ëŒ€ìƒì„ ì •ì´ ì·¨ì†Œë˜ë©´ íšŒìˆ˜ì™„ë£Œë„ ìë™ìœ¼ë¡œ ì·¨ì†Œ
      if (!value || value === '') {
        ranges.push(`íšŒìˆ˜ëª©ë¡!K${rowIndex}`); // Kì—´(10ë²ˆì¸ë±ìŠ¤): íšŒìˆ˜ì™„ë£Œ
        values.push(['']); // ë¹ˆ ê°’ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ì·¨ì†Œ
        console.log(`ğŸ”„ [ì¬ê³ íšŒìˆ˜] íšŒìˆ˜ëŒ€ìƒì„ ì • ì·¨ì†Œë¡œ ì¸í•œ íšŒìˆ˜ì™„ë£Œ ìë™ ì·¨ì†Œ: í–‰${rowIndex}`);
      }
    } else {
      throw new Error('ìœ íš¨í•˜ì§€ ì•Šì€ ì»¬ëŸ¼ì…ë‹ˆë‹¤.');
    }

    // ê° ì…€ì„ ê°œë³„ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸
    for (let i = 0; i < ranges.length; i++) {
      await sheets.spreadsheets.values.update({
        spreadsheetId: process.env.INVENTORY_RECOVERY_SPREADSHEET_ID || '1soJE2C2svNCfLBSJsZBoXiBQIAglgefQpnehWqDUmuY',
        range: ranges[i],
        valueInputOption: 'RAW',
        requestBody: {
          values: [values[i]]
        }
      });
    }

    console.log(`âœ… [ì¬ê³ íšŒìˆ˜] ìƒíƒœ ì—…ë°ì´íŠ¸ ì™„ë£Œ: í–‰${rowIndex}, ì—´${column} = ${value}`);

    res.json({
      success: true,
      message: 'ìƒíƒœê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.'
    });

  } catch (error) {
    console.error('âŒ [ì¬ê³ íšŒìˆ˜] ìƒíƒœ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: 'ìƒíƒœ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
      message: error.message
    });
  }
});

// ìš°ì„ ìˆœìœ„ ëª¨ë¸ ì €ì¥ API
app.post('/api/inventory-recovery/priority-models', async (req, res) => {
  // CORS í—¤ë” ì„¤ì •
  const allowedOrigins = [
    'https://vipmobile.vercel.app',
    'https://vipmobile.vercel.app/',
    'http://localhost:3000',
    'http://localhost:3001',
    'http://localhost:4000'
  ];

  const origin = req.headers.origin;
  if (origin && allowedOrigins.includes(origin)) {
    res.header('Access-Control-Allow-Origin', origin);
  } else {
    res.header('Access-Control-Allow-Origin', '*');
  }

  res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
  res.header('Access-Control-Allow-Headers', 'Origin, X-Requested-With, Content-Type, Accept, Authorization');
  res.header('Access-Control-Allow-Credentials', 'true');

  if (req.method === 'OPTIONS') {
    res.sendStatus(200);
    return;
  }

  try {
    const { priorityModels } = req.body;

    if (!priorityModels || typeof priorityModels !== 'object') {
      return res.status(400).json({
        success: false,
        error: 'ìš°ì„ ìˆœìœ„ ëª¨ë¸ ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }

    console.log('ğŸ”„ [ìš°ì„ ìˆœìœ„ ëª¨ë¸] ì €ì¥ ìš”ì²­:', priorityModels);

    // êµ¬ê¸€ì‹œíŠ¸ì— ìš°ì„ ìˆœìœ„ ëª¨ë¸ ì €ì¥ (íšŒìˆ˜ëª©ë¡ ì‹œíŠ¸ì˜ íŠ¹ì • ì…€ì— ì €ì¥)
    const ranges = [];
    const values = [];

    // ìš°ì„ ìˆœìœ„ ëª¨ë¸ì„ JSON í˜•íƒœë¡œ ì €ì¥í•  ì…€ (ìš°ì„ ìˆœìœ„ ì‹œíŠ¸ì˜ A1 ì…€)
    ranges.push('ìš°ì„ ìˆœìœ„!A1');
    values.push([JSON.stringify(priorityModels)]);

    // ë°°ì¹˜ ì—…ë°ì´íŠ¸ ì‹¤í–‰
    await rateLimitedSheetsCall(async () => {
      await sheets.spreadsheets.values.batchUpdate({
        spreadsheetId: process.env.INVENTORY_RECOVERY_SPREADSHEET_ID || '1soJE2C2svNCfLBSJsZBoXiBQIAglgefQpnehWqDUmuY',
        resource: {
          valueInputOption: 'RAW',
          data: ranges.map((range, index) => ({
            range: range,
            values: [values[index]]
          }))
        }
      });
    });

    console.log('âœ… [ìš°ì„ ìˆœìœ„ ëª¨ë¸] ì €ì¥ ì™„ë£Œ');

    res.json({
      success: true,
      message: 'ìš°ì„ ìˆœìœ„ ëª¨ë¸ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.',
      data: priorityModels
    });

  } catch (error) {
    console.error('âŒ [ìš°ì„ ìˆœìœ„ ëª¨ë¸] ì €ì¥ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: 'ìš°ì„ ìˆœìœ„ ëª¨ë¸ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
      message: error.message
    });
  }
});

// ìš°ì„ ìˆœìœ„ ëª¨ë¸ ë¡œë“œ API
app.get('/api/inventory-recovery/priority-models', async (req, res) => {
  // CORS í—¤ë” ì„¤ì •
  const allowedOrigins = [
    'https://vipmobile.vercel.app',
    'https://vipmobile.vercel.app/',
    'http://localhost:3000',
    'http://localhost:3001',
    'http://localhost:4000'
  ];

  const origin = req.headers.origin;
  if (origin && allowedOrigins.includes(origin)) {
    res.header('Access-Control-Allow-Origin', origin);
  } else {
    res.header('Access-Control-Allow-Origin', '*');
  }

  res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
  res.header('Access-Control-Allow-Headers', 'Origin, X-Requested-With, Content-Type, Accept, Authorization');
  res.header('Access-Control-Allow-Credentials', 'true');

  if (req.method === 'OPTIONS') {
    res.sendStatus(200);
    return;
  }

  try {
    console.log('ğŸ”„ [ìš°ì„ ìˆœìœ„ ëª¨ë¸] ë¡œë“œ ìš”ì²­');

    // êµ¬ê¸€ì‹œíŠ¸ì—ì„œ ìš°ì„ ìˆœìœ„ ëª¨ë¸ ë°ì´í„° ë¡œë“œ (ìš°ì„ ìˆœìœ„ ì‹œíŠ¸ì˜ A1 ì…€)
    const response = await rateLimitedSheetsCall(async () => {
      return await sheets.spreadsheets.values.get({
        spreadsheetId: process.env.INVENTORY_RECOVERY_SPREADSHEET_ID || '1soJE2C2svNCfLBSJsZBoXiBQIAglgefQpnehWqDUmuY',
        range: 'ìš°ì„ ìˆœìœ„!A1'
      });
    });

    let priorityModels = {
      '1ìˆœìœ„': null,
      '2ìˆœìœ„': null,
      '3ìˆœìœ„': null,
      '4ìˆœìœ„': null,
      '5ìˆœìœ„': null,
      '6ìˆœìœ„': null,
      '7ìˆœìœ„': null,
      '8ìˆœìœ„': null,
      '9ìˆœìœ„': null,
      '10ìˆœìœ„': null
    };

    // ë°ì´í„°ê°€ ìˆìœ¼ë©´ íŒŒì‹±
    if (response.data.values && response.data.values[0] && response.data.values[0][0]) {
      try {
        const savedData = JSON.parse(response.data.values[0][0]);
        priorityModels = { ...priorityModels, ...savedData };
        console.log('âœ… [ìš°ì„ ìˆœìœ„ ëª¨ë¸] ë¡œë“œ ì™„ë£Œ:', priorityModels);
      } catch (parseError) {
        console.warn('âš ï¸ [ìš°ì„ ìˆœìœ„ ëª¨ë¸] íŒŒì‹± ì˜¤ë¥˜, ê¸°ë³¸ê°’ ì‚¬ìš©:', parseError.message);
      }
    } else {
      console.log('â„¹ï¸ [ìš°ì„ ìˆœìœ„ ëª¨ë¸] ì €ì¥ëœ ë°ì´í„° ì—†ìŒ, ê¸°ë³¸ê°’ ì‚¬ìš©');
    }

    res.json({
      success: true,
      data: priorityModels
    });

  } catch (error) {
    console.error('âŒ [ìš°ì„ ìˆœìœ„ ëª¨ë¸] ë¡œë“œ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: 'ìš°ì„ ìˆœìœ„ ëª¨ë¸ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
      message: error.message
    });
  }
});

// ë§ˆì§€ë§‰ ê°œí†µë‚ ì§œ ìºì‹œ ì´ˆê¸°í™” API
app.get('/api/last-activation-date/clear-cache', async (req, res) => {
  try {
    const cacheKey = 'last_activation_date';
    cache.delete(cacheKey);
    console.log('ë§ˆì§€ë§‰ ê°œí†µë‚ ì§œ ìºì‹œ ì´ˆê¸°í™” ì™„ë£Œ');
    res.json({ success: true, message: 'ìºì‹œê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.' });
  } catch (error) {
    console.error('ìºì‹œ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'ìºì‹œ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
  }
});

// ì—…ì²´ë³„ ì¬ê³  ìƒì„¸ ì¡°íšŒ API
app.get('/api/company-inventory-details', async (req, res) => {
  try {
    const { companyName } = req.query;

    if (!companyName) {
      return res.status(400).json({ error: 'ì—…ì²´ëª…ì´ í•„ìš”í•©ë‹ˆë‹¤.' });
    }

    console.log(`ì—…ì²´ë³„ ì¬ê³  ìƒì„¸ ì¡°íšŒ ì‹œì‘: ${companyName}`);

    // ìºì‹œ í‚¤ ìƒì„±
    const cacheKey = `company_inventory_${companyName}`;

    // ìºì‹œ í™•ì¸
    if (cache.has(cacheKey)) {
      console.log('ìºì‹œëœ ì—…ì²´ ì¬ê³  ë°ì´í„° ë°˜í™˜');
      return res.json(cache.get(cacheKey));
    }

    // í°í´ì¬ê³ ë°ì´í„° ë¡œë“œ
    const inventoryData = await getSheetValues('í°í´ì¬ê³ ë°ì´í„°');

    if (!inventoryData || inventoryData.length < 4) {
      return res.json({
        success: true,
        data: {
          companyName,
          defectiveDevices: [],
          defectiveSims: [],
          normalDevices: [],
          normalSims: []
        }
      });
    }

    // í—¤ë” 3í–‰ ì œì™¸í•˜ê³  ë°ì´í„° ì²˜ë¦¬
    const dataRows = inventoryData.slice(3);

    const result = {
      companyName,
      defectiveDevices: [], // ë¶ˆëŸ‰&ì´ë ¥ë‹¨ë§
      defectiveSims: [],    // ë¶ˆëŸ‰&ìœ ì‹¬
      normalDevices: [],    // ë³´ìœ ë‹¨ë§
      normalSims: []        // ë³´ìœ ìœ ì‹¬
    };

    dataRows.forEach(row => {
      if (row.length < 23) return; // í•„ìš”í•œ ì—´ì´ ì—†ìœ¼ë©´ ìŠ¤í‚µ

      const company = (row[21] || '').toString(); // Vì—´: ì—…ì²´ëª…
      const category = (row[12] || '').toString(); // Mì—´: ì¢…ë¥˜
      const status = (row[15] || '').toString(); // Pì—´: ìƒíƒœ
      const model = (row[13] || '').toString(); // Nì—´: ëª¨ë¸ëª…
      const color = (row[14] || '').toString(); // Oì—´: ìƒ‰ìƒ
      const serial = (row[11] || '').toString(); // Lì—´: ì¼ë ¨ë²ˆí˜¸
      const purchasePrice = (row[17] || '').toString(); // Rì—´: ì…ê³ ê°€
      const releaseDate = (row[22] || '').toString(); // Wì—´: ì¶œê³ ì¼

      // ì—…ì²´ëª…ì´ ì¼ì¹˜í•˜ëŠ” ê²½ìš°ë§Œ ì²˜ë¦¬
      if (company === companyName) {
        const item = {
          category,
          status,
          model,
          color,
          serial,
          purchasePrice,
          releaseDate
        };

        // ì¹´í…Œê³ ë¦¬ë³„, ìƒíƒœë³„ë¡œ ë¶„ë¥˜
        if (category !== 'ìœ ì‹¬' && status !== 'ì •ìƒ') {
          result.defectiveDevices.push(item); // ë¶ˆëŸ‰&ì´ë ¥ë‹¨ë§
        } else if (category === 'ìœ ì‹¬' && status !== 'ì •ìƒ') {
          result.defectiveSims.push(item); // ë¶ˆëŸ‰&ìœ ì‹¬
        } else if (category !== 'ìœ ì‹¬' && status === 'ì •ìƒ') {
          result.normalDevices.push(item); // ë³´ìœ ë‹¨ë§
        } else if (category === 'ìœ ì‹¬' && status === 'ì •ìƒ') {
          result.normalSims.push(item); // ë³´ìœ ìœ ì‹¬
        }
      }
    });

    // ìºì‹œ ì €ì¥ (5ë¶„)
    cache.set(cacheKey, { success: true, data: result }, 300);

    console.log(`ì—…ì²´ë³„ ì¬ê³  ìƒì„¸ ì¡°íšŒ ì™„ë£Œ: ${companyName}`);
    res.json({ success: true, data: result });

  } catch (error) {
    console.error('ì—…ì²´ë³„ ì¬ê³  ìƒì„¸ ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'ì—…ì²´ë³„ ì¬ê³  ìƒì„¸ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
  }
});

// ë§ˆì§€ë§‰ ê°œí†µë‚ ì§œ ì¡°íšŒ API
app.get('/api/last-activation-date', async (req, res) => {
  try {
    console.log('ë§ˆì§€ë§‰ ê°œí†µë‚ ì§œ ì¡°íšŒ ì‹œì‘');

    // ìºì‹œ í‚¤ ìƒì„±
    const cacheKey = 'last_activation_date';

    // ìºì‹œ í™•ì¸
    if (cache.has(cacheKey)) {
      console.log('ìºì‹œëœ ë§ˆì§€ë§‰ ê°œí†µë‚ ì§œ ë°˜í™˜');
      return res.json(cache.get(cacheKey));
    }

    // í°í´ê°œí†µë°ì´í„° ë¡œë“œ
    const phoneklData = await getSheetValues('í°í´ê°œí†µë°ì´í„°');

    if (!phoneklData || phoneklData.length < 4) {
      // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì˜¤ëŠ˜ ë‚ ì§œ ë°˜í™˜
      const today = new Date().toISOString().split('T')[0];
      return res.json({ success: true, lastActivationDate: today });
    }

    // í—¤ë” 3í–‰ ì œì™¸í•˜ê³  ë°ì´í„° ì²˜ë¦¬
    const dataRows = phoneklData.slice(3);

    let lastDate = null;

    dataRows.forEach(row => {
      if (row.length > 9) {
        const activationDate = (row[9] || '').toString(); // Jì—´: ê°œí†µì¼
        console.log(`ê°œí†µë‚ ì§œ ë°œê²¬: ${activationDate}`);

        // ë‚ ì§œ í˜•ì‹ ê²€ì¦ (YYYY-MM-DD)
        if (activationDate && /^\d{4}-\d{2}-\d{2}$/.test(activationDate)) {
          const date = new Date(activationDate);
          if (!isNaN(date.getTime())) {
            if (!lastDate || date > lastDate) {
              console.log(`ìƒˆë¡œìš´ ìµœì‹  ë‚ ì§œ: ${activationDate} (ì´ì „: ${lastDate ? lastDate.toISOString().split('T')[0] : 'ì—†ìŒ'})`);
              lastDate = date;
            }
          }
        }
      }
    });

    // ë§ˆì§€ë§‰ ë‚ ì§œê°€ ì—†ìœ¼ë©´ ì˜¤ëŠ˜ ë‚ ì§œ ë°˜í™˜
    const resultDate = lastDate ? lastDate.toISOString().split('T')[0] : new Date().toISOString().split('T')[0];

    // ìºì‹œ ì €ì¥ (1ë¶„)
    cache.set(cacheKey, { success: true, lastActivationDate: resultDate }, 60);

    console.log(`ë§ˆì§€ë§‰ ê°œí†µë‚ ì§œ ì¡°íšŒ ì™„ë£Œ: ${resultDate}`);
    res.json({ success: true, lastActivationDate: resultDate });

  } catch (error) {
    console.error('ë§ˆì§€ë§‰ ê°œí†µë‚ ì§œ ì¡°íšŒ ì˜¤ë¥˜:', error);
    // ì˜¤ë¥˜ ì‹œ ì˜¤ëŠ˜ ë‚ ì§œ ë°˜í™˜
    const today = new Date().toISOString().split('T')[0];
    res.json({ success: true, lastActivationDate: today });
  }
});

// ì˜ì—…ì‚¬ì›ë³„ë§ˆê° ë°ì´í„° ì¡°íšŒ API
app.get('/api/agent-closing-chart', async (req, res) => {
  try {
    const { date, agent } = req.query;
    const targetDate = date || new Date().toISOString().split('T')[0];

    console.log(`ë‹´ë‹¹ìë³„ë§ˆê° ë°ì´í„° ì¡°íšŒ ì‹œì‘: ${targetDate}, ë‹´ë‹¹ì: ${agent || 'ì „ì²´'}`);

    // ìºì‹œ í‚¤ ìƒì„±
    const cacheKey = `agent_closing_chart_${targetDate}_${agent || 'all'}`;

    // ìºì‹œ í™•ì¸
    if (cache.has(cacheKey)) {
      console.log('ìºì‹œëœ ë‹´ë‹¹ìë³„ë§ˆê° ë°ì´í„° ë°˜í™˜');
      return res.json(cache.get(cacheKey));
    }

    // í•„ìš”í•œ ì‹œíŠ¸ ë°ì´í„° ë¡œë“œ (ë³‘ë ¬ ì²˜ë¦¬)
    const [
      phoneklStoreData,
      phoneklInventoryData,
      phoneklActivationData
    ] = await Promise.all([
      getSheetValues('í°í´ì¶œê³ ì²˜ë°ì´í„°'),
      getSheetValues('í°í´ì¬ê³ ë°ì´í„°'),
      getSheetValues('í°í´ê°œí†µë°ì´í„°')
    ]);

    if (!phoneklStoreData || !phoneklInventoryData || !phoneklActivationData) {
      throw new Error('í•„ìš”í•œ ì‹œíŠ¸ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    // ì˜ì—…ì‚¬ì›ë³„ ë°ì´í„° ì²˜ë¦¬
    const agentData = processAgentClosingData({
      phoneklStoreData,
      phoneklInventoryData,
      phoneklActivationData,
      targetDate,
      selectedAgent: agent
    });

    const result = {
      success: true,
      agentData,
      totalCount: agentData.length,
      targetDate,
      selectedAgent: agent || 'ì „ì²´'
    };

    // ìºì‹œ ì €ì¥ (5ë¶„)
    cache.set(cacheKey, result, 300);

    console.log(`ë‹´ë‹¹ìë³„ë§ˆê° ë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ: ${agentData.length}ê±´`);
    res.json(result);

  } catch (error) {
    console.error('ë‹´ë‹¹ìë³„ë§ˆê° ë°ì´í„° ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: 'ë‹´ë‹¹ìë³„ë§ˆê° ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
      details: error.message
    });
  }
});

// ì˜ì—…ì‚¬ì›ë³„ë§ˆê° ì´ˆê¸° ë°ì´í„° ì¡°íšŒ API (ë§ˆì§€ë§‰ ê°œí†µë‚ ì§œ + ì˜ì—…ì‚¬ì› ëª©ë¡)
app.get('/api/agent-closing-initial', async (req, res) => {
  try {
    const cacheKey = 'agent_closing_initial_data';

    // ìºì‹œ í™•ì¸
    if (cache.has(cacheKey)) {
      return res.json(cache.get(cacheKey));
    }

    // ë§ˆì§€ë§‰ ê°œí†µë‚ ì§œ ì¡°íšŒ
    const phoneklActivationList = await getSheetValues('í°í´ê°œí†µë¦¬ìŠ¤íŠ¸');
    let lastActivationDate = new Date().toISOString().split('T')[0];

    if (phoneklActivationList && phoneklActivationList.length > 1) {
      const dateColumn = phoneklActivationList[0].indexOf('ê°œí†µë‚ ì§œ');
      if (dateColumn !== -1) {
        const dates = phoneklActivationList.slice(1)
          .map(row => row[dateColumn])
          .filter(date => date && typeof date === 'string' && date.includes('-'))
          .map(dateStr => {
            try {
              const date = new Date(dateStr);
              return isNaN(date.getTime()) ? null : date;
            } catch {
              return null;
            }
          })
          .filter(date => date !== null);

        if (dates.length > 0) {
          const latestDate = new Date(Math.max(...dates));
          lastActivationDate = latestDate.toISOString().split('T')[0];
        }
      }
    }

    // ì˜ì—…ì‚¬ì› ëª©ë¡ ì¡°íšŒ
    const [phoneklStoreData, phoneklActivationData] = await Promise.all([
      getSheetValues('í°í´ì¶œê³ ì²˜ë°ì´í„°'),
      getSheetValues('í°í´ê°œí†µë°ì´í„°')
    ]);

    if (!phoneklStoreData || phoneklStoreData.length < 2) {
      throw new Error('í°í´ì¶œê³ ì²˜ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    if (!phoneklActivationData || phoneklActivationData.length < 4) {
      throw new Error('í°í´ê°œí†µë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    // ì´ë²ˆë‹¬ ê°œí†µì‹¤ì ì´ ìˆëŠ” ë‹´ë‹¹ì ì¶”ì¶œ
    const currentMonth = new Date().getMonth() + 1;
    const currentYear = new Date().getFullYear();
    const currentYearMonth = `${currentYear}-${currentMonth.toString().padStart(2, '0')}`;

    const agentsWithActivation = new Set();
    let activationCount = 0;

    phoneklActivationData.slice(3).forEach(row => {
      if (row[1] && row[9]) {
        const activationDate = row[9];
        const agent = row[1];

        if (typeof activationDate === 'string' && activationDate.includes('-')) {
          const [year, month] = activationDate.split('-');
          if (year === currentYear.toString() && month === currentMonth.toString().padStart(2, '0')) {
            agentsWithActivation.add(agent);
            activationCount++;
          }
        }
      }
    });

    // í°í´ì¶œê³ ì²˜ë°ì´í„°ì—ì„œ í•´ë‹¹ ë‹´ë‹¹ìë“¤ì˜ ì „ì²´ ëª©ë¡ ì¶”ì¶œ
    const allAgents = new Set();
    phoneklStoreData.slice(3).forEach(row => {
      if (row[21] && row[12] !== 'ë¯¸ì‚¬ìš©') {
        allAgents.add(row[21]);
      }
    });

    // ì´ë²ˆë‹¬ ê°œí†µì‹¤ì ì´ ìˆëŠ” ë‹´ë‹¹ìë§Œ í•„í„°ë§
    const filteredAgents = Array.from(allAgents).filter(agent =>
      agentsWithActivation.has(agent)
    ).sort();

    const result = {
      success: true,
      lastActivationDate,
      agents: filteredAgents,
      agentsWithActivation: filteredAgents.length,
      totalAgents: allAgents.size,
      activationCount
    };

    // ìºì‹œ ì €ì¥ (2ë¶„)
    cache.set(cacheKey, result, 120);

    console.log(`ì˜ì—…ì‚¬ì›ë³„ë§ˆê° ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ë§ˆì§€ë§‰ ê°œí†µë‚ ì§œ=${lastActivationDate}, ë‹´ë‹¹ì=${filteredAgents.length}ëª…`);
    res.json(result);

  } catch (error) {
    console.error('ì˜ì—…ì‚¬ì›ë³„ë§ˆê° ì´ˆê¸° ë°ì´í„° ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: 'ì˜ì—…ì‚¬ì›ë³„ë§ˆê° ì´ˆê¸° ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
      details: error.message
    });
  }
});

// ì˜ì—…ì‚¬ì›ë³„ë§ˆê°ìš© ì˜ì—…ì‚¬ì› ëª©ë¡ ì¡°íšŒ API (ì´ë²ˆë‹¬ ê°œí†µì‹¤ì  ìˆëŠ” ë‹´ë‹¹ìë§Œ)
app.get('/api/agent-closing-agents', async (req, res) => {
  try {
    const cacheKey = 'agent_closing_agents_list_with_activation';

    // ìºì‹œ í™•ì¸
    if (cache.has(cacheKey)) {
      return res.json(cache.get(cacheKey));
    }

    // í•„ìš”í•œ ì‹œíŠ¸ ë°ì´í„° ë³‘ë ¬ ë¡œë“œ
    const [phoneklStoreData, phoneklActivationData] = await Promise.all([
      getSheetValues('í°í´ì¶œê³ ì²˜ë°ì´í„°'),
      getSheetValues('í°í´ê°œí†µë°ì´í„°')
    ]);

    if (!phoneklStoreData || phoneklStoreData.length < 2) {
      throw new Error('í°í´ì¶œê³ ì²˜ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    if (!phoneklActivationData || phoneklActivationData.length < 4) {
      throw new Error('í°í´ê°œí†µë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    // ì´ë²ˆë‹¬ ê°œí†µì‹¤ì ì´ ìˆëŠ” ë‹´ë‹¹ì ì¶”ì¶œ
    const currentMonth = new Date().getMonth() + 1;
    const currentYear = new Date().getFullYear();
    const currentYearMonth = `${currentYear}-${currentMonth.toString().padStart(2, '0')}`;

    console.log(`ì´ë²ˆë‹¬ ê°œí†µì‹¤ì  ì¡°íšŒ: ${currentYearMonth}`);

    // í°í´ê°œí†µë°ì´í„°ì—ì„œ ì´ë²ˆë‹¬ ê°œí†µì‹¤ì ì´ ìˆëŠ” ë‹´ë‹¹ì ì°¾ê¸°
    const agentsWithActivation = new Set();
    let activationCount = 0;

    phoneklActivationData.slice(3).forEach(row => {
      if (row.length < 2) return; // Bì—´(1ì¸ë±ìŠ¤)ê¹Œì§€ í•„ìš”

      const category = row[2] || ''; // Cì—´: íœ´ëŒ€í°
      const activationDate = row[9] || ''; // Jì—´: ê°œí†µì¼
      const assignedAgent = row[1] || ''; // Bì—´: ë‹´ë‹¹ì (ê´„í˜¸ í¬í•¨)

      if (category !== 'íœ´ëŒ€í°') return;

      // ë‚ ì§œ íŒŒì‹± (Jì—´ í˜•ì‹: 2025-09-27)
      if (activationDate.length >= 10) {
        const dateStr = activationDate.substring(0, 10);
        const dateObj = new Date(dateStr);

        if (isNaN(dateObj.getTime())) return;

        const yearMonth = dateStr.substring(0, 7); // YYYY-MM

        // ì´ë²ˆë‹¬ ê°œí†µì‹¤ì ì´ ìˆëŠ” ê²½ìš°
        if (yearMonth === currentYearMonth && assignedAgent) {
          const agentName = assignedAgent.toString().trim();
          if (agentName) {
            agentsWithActivation.add(agentName);
            activationCount++;
          }
        }
      }
    });

    console.log(`ì´ë²ˆë‹¬ ê°œí†µì‹¤ì  ìˆëŠ” ë‹´ë‹¹ì: ${agentsWithActivation.size}ëª…, ì´ ê°œí†µê±´ìˆ˜: ${activationCount}ê±´`);

    // í°í´ì¶œê³ ì²˜ë°ì´í„°ì—ì„œ ëª¨ë“  ë‹´ë‹¹ìëª… ì¶”ì¶œ (ì°¸ê³ ìš©)
    const allAgents = new Set();
    phoneklStoreData.slice(3).forEach(row => {
      if (row.length > 21 && row[21]) {
        const agentName = row[21].toString().trim();
        if (agentName) {
          allAgents.add(agentName);
        }
      }
    });

    // ì´ë²ˆë‹¬ ê°œí†µì‹¤ì ì´ ìˆëŠ” ë‹´ë‹¹ìë§Œ í•„í„°ë§
    const filteredAgents = Array.from(agentsWithActivation).sort();

    const result = {
      success: true,
      agents: filteredAgents,
      currentMonth: currentYearMonth,
      totalAgents: allAgents.size,
      agentsWithActivation: agentsWithActivation.size,
      activationCount: activationCount,
      note: `ì´ë²ˆë‹¬(${currentYearMonth}) ê°œí†µì‹¤ì ì´ ìˆëŠ” ë‹´ë‹¹ìë§Œ í•„í„°ë§`
    };

    // ìºì‹œ ì €ì¥ (10ë¶„)
    cache.set(cacheKey, result, 600);

    console.log(`ì´ë²ˆë‹¬ ê°œí†µì‹¤ì  ìˆëŠ” ë‹´ë‹¹ì ëª©ë¡ ì¡°íšŒ ì™„ë£Œ: ${result.agents.length}ëª… (ì „ì²´ ${allAgents.size}ëª… ì¤‘)`);
    res.json(result);

  } catch (error) {
    console.error('ë‹´ë‹¹ì ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: 'ë‹´ë‹¹ì ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
      details: error.message
    });
  }
});

// ì˜ì—…ì‚¬ì›ë³„ë§ˆê° ë°ì´í„° ì²˜ë¦¬ í•¨ìˆ˜
function processAgentClosingData({ phoneklStoreData, phoneklInventoryData, phoneklActivationData, targetDate, selectedAgent }) {
  const agentMap = new Map();

  // 1. í°í´ì¶œê³ ì²˜ë°ì´í„°ì—ì„œ ê¸°ë³¸ ì •ë³´ ìˆ˜ì§‘
  phoneklStoreData.slice(3).forEach(row => {
    if (row.length < 22) return;

    const status = row[12] || ''; // Mì—´: ì‚¬ìš©/ë¯¸ì‚¬ìš© ìƒíƒœ
    const policyGroup = row[18] || ''; // Sì—´
    const pCode = row[15] || ''; // Pì—´
    const companyName = row[14] || ''; // Oì—´
    const agent = row[21] || ''; // Vì—´

    // Mì—´ì´ "ë¯¸ì‚¬ìš©"ì¸ ê²½ìš° ì œì™¸
    if (status === 'ë¯¸ì‚¬ìš©') return;

    // ì˜ì—…ì‚¬ì› í•„í„°ë§ (ê¸°ë³¸ ì´ë¦„ìœ¼ë¡œ ê·¸ë£¹í•‘)
    if (selectedAgent) {
      const baseAgentName = agent.replace(/\([^)]*\)/g, '').trim();
      if (baseAgentName !== selectedAgent) return;
    }

    if (!agent || !companyName) return;

    const key = `${agent}_${companyName}`;
    if (!agentMap.has(key)) {
      agentMap.set(key, {
        policyGroup,
        pCode,
        companyName,
        agent,
        turnoverRate: 0,
        defectiveDevices: 0,
        historyDevices: 0,
        defectiveSims: 0,
        historySims: 0,
        totalInventory: 0,
        remainingSims: 0,
        dailyPerformance: 0,
        monthlyPerformance: 0,
        expectedClosing: 0,
        noPerformanceStores: 0
      });
    }
  });

  // 2. í°í´ì¬ê³ ë°ì´í„°ì—ì„œ ì¬ê³  ì •ë³´ ìˆ˜ì§‘
  phoneklInventoryData.slice(3).forEach(row => {
    if (row.length < 22) return;

    const category = row[12] || ''; // Mì—´: íœ´ëŒ€í°/ìœ ì‹¬/ì›¨ì–´ëŸ¬ë¸”/íƒœë¸”ë¦¿
    const status = row[15] || ''; // Pì—´: ì •ìƒ/ë¶ˆëŸ‰/ì´ë ¥
    const companyName = row[21] || ''; // Vì—´: ì—…ì²´ëª…

    // agentMapì—ì„œ í•´ë‹¹ ì—…ì²´ëª… ì°¾ê¸° (ë¯¸ì‚¬ìš© ì—…ì²´ëŠ” ì´ë¯¸ agentMapì—ì„œ ì œì™¸ë¨)
    for (const [key, data] of agentMap) {
      if (data.companyName === companyName) {
        if (category === 'íœ´ëŒ€í°' && status === 'ë¶ˆëŸ‰') {
          data.defectiveDevices++;
        } else if (category === 'íœ´ëŒ€í°' && status === 'ì´ë ¥') {
          data.historyDevices++;
        } else if (category === 'ìœ ì‹¬' && status === 'ë¶ˆëŸ‰') {
          data.defectiveSims++;
        } else if (category === 'ìœ ì‹¬' && status === 'ì´ë ¥') {
          data.historySims++;
        } else if ((category === 'íœ´ëŒ€í°' || category === 'ì›¨ì–´ëŸ¬ë¸”' || category === 'íƒœë¸”ë¦¿') && status === 'ì •ìƒ') {
          data.totalInventory++;
        } else if (category === 'ìœ ì‹¬' && status === 'ì •ìƒ') {
          data.remainingSims++;
        }
        break;
      }
    }
  });

  // 3. í°í´ê°œí†µë°ì´í„°ì—ì„œ ì‹¤ì  ì •ë³´ ìˆ˜ì§‘
  const targetYearMonth = targetDate.substring(0, 7); // YYYY-MM
  const targetDay = targetDate.substring(8, 10); // DD

  phoneklActivationData.slice(3).forEach(row => {
    if (row.length < 15) return; // Oì—´(14ì¸ë±ìŠ¤)ê¹Œì§€ í•„ìš”

    const category = row[2] || ''; // Cì—´: íœ´ëŒ€í°
    const activationDate = row[9] || ''; // Jì—´: ê°œí†µì¼
    const assignedAgent = row[1] || ''; // Bì—´: ë‹´ë‹¹ì (ê´„í˜¸ í¬í•¨)
    const companyName = row[14] || ''; // Oì—´: ì—…ì²´ëª…

    if (category !== 'íœ´ëŒ€í°') return;

    // ë‚ ì§œ íŒŒì‹± (Jì—´ í˜•ì‹: 2025-09-27)
    if (activationDate.length >= 10) {
      const dateStr = activationDate.substring(0, 10);
      const dateObj = new Date(dateStr);

      if (isNaN(dateObj.getTime())) return;

      const yearMonth = dateStr.substring(0, 7);
      const day = dateStr.substring(8, 10);

      // ë‹´ë‹¹ìì™€ ì—…ì²´ëª…ìœ¼ë¡œ ì •í™•í•œ ì‹¤ì  ê³„ì‚°
      const agentName = assignedAgent.toString().trim();
      const activationCompanyName = companyName.toString().trim();

      if (agentName && activationCompanyName) {
        // ê¸ˆì¼ì‹¤ì : ì„ íƒëœ ë‚ ì§œì™€ ì •í™•íˆ ì¼ì¹˜
        if (day === targetDay && yearMonth === targetYearMonth) {
          for (const [key, data] of agentMap) {
            if (data.agent === agentName && data.companyName === activationCompanyName) {
              data.dailyPerformance++;
            }
          }
        }

        // ë‹¹ì›”ì‹¤ì : ì„ íƒëœ ì›”ì˜ ëª¨ë“  ë‚ ì§œ
        if (yearMonth === targetYearMonth) {
          for (const [key, data] of agentMap) {
            if (data.agent === agentName && data.companyName === activationCompanyName) {
              data.monthlyPerformance++;
            }
          }
        }
      }
    }
  });

  // 4. ì˜ˆìƒë§ˆê° ê³„ì‚° (ì „ì²´ì´ë§ˆê°ê³¼ ë™ì¼í•œ ë¡œì§)
  const targetDateObj = new Date(targetDate);
  const currentDay = targetDateObj.getDate(); // 1ì¼ë¶€í„° ì„ íƒëœ ë‚ ì§œê¹Œì§€ì˜ ê¸°ê°„ (ì˜ˆ: 15ì¼ ì„ íƒ ì‹œ 15ì¼ê°„)
  const daysInMonth = new Date(targetDateObj.getFullYear(), targetDateObj.getMonth() + 1, 0).getDate(); // í•´ë‹¹ì›” ì´ ì¼ìˆ˜

  for (const [key, data] of agentMap) {
    if (currentDay > 0 && data.monthlyPerformance > 0) {
      // ë‹¹ì›”ì‹¤ì (1ì¼~ì„ íƒëœë‚ ì§œê¹Œì§€)ì„ ì„ íƒëœ ê¸°ê°„ìœ¼ë¡œ ë‚˜ëˆ„ì–´ ì¼í‰ê·  ê³„ì‚° í›„ ì›” ì´ ì¼ìˆ˜ ê³±í•˜ê¸°
      data.expectedClosing = Math.round((data.monthlyPerformance / currentDay) * daysInMonth);
    } else {
      data.expectedClosing = 0;
    }
  }

  // 5. íšŒì „ìœ¨ ê³„ì‚° (ì˜ˆìƒë§ˆê° / (ì˜ˆìƒë§ˆê° + ë³´ìœ ì¬ê³ ) * 100) - ì „ì²´ì´ë§ˆê° íƒ­ê³¼ ë™ì¼í•œ ë°©ì‹
  for (const [key, data] of agentMap) {
    if ((data.expectedClosing + data.totalInventory) > 0) {
      data.turnoverRate = Math.round((data.expectedClosing / (data.expectedClosing + data.totalInventory)) * 100);
    }
  }

  // 6. ë¬´ì‹¤ì ì  ê³„ì‚° (ë‹¹ì›”ì‹¤ì ì´ ì—†ëŠ” ê³³ì€ "ë¬´ì‹¤ì ì "ìœ¼ë¡œ í‘œê¸°)
  for (const [key, data] of agentMap) {
    if (data.monthlyPerformance === 0) {
      data.noPerformanceStores = "ë¬´ì‹¤ì ì ";
    } else {
      data.noPerformanceStores = "";
    }
  }

  // ë‹´ë‹¹ìë³„ë¡œ ë¨¼ì € ê·¸ë£¹í•‘í•˜ê³ , ê° ê·¸ë£¹ ë‚´ì—ì„œ ë‹¹ì›”ì‹¤ì  ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
  const sortedData = Array.from(agentMap.values()).sort((a, b) => {
    // 1. ë‹´ë‹¹ìëª…ìœ¼ë¡œ ë¨¼ì € ì •ë ¬ (ê°™ì€ ë‹´ë‹¹ìëŠ” í•¨ê»˜ ê·¸ë£¹í•‘)
    const agentA = a.agent || '';
    const agentB = b.agent || '';

    if (agentA !== agentB) {
      return agentA.localeCompare(agentB);
    }

    // 2. ê°™ì€ ë‹´ë‹¹ì ë‚´ì—ì„œëŠ” ë‹¹ì›”ì‹¤ì  ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
    return (b.monthlyPerformance || 0) - (a.monthlyPerformance || 0);
  });

  return sortedData;
}

// í°í´ì¤‘ë³µê°’ API ì—”ë“œí¬ì¸íŠ¸ë“¤
app.get('/api/phone-duplicates', async (req, res) => {
  try {
    console.log('ğŸ“± í°í´ì¤‘ë³µê°’ API í˜¸ì¶œ ì‹œì‘');

    // í°í´ê°œí†µë°ì´í„°ì™€ í°í´ì¬ê³ ë°ì´í„° ì‹œíŠ¸ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const activationData = await sheets.spreadsheets.values.get({
      spreadsheetId: process.env.SHEET_ID,
      range: 'í°í´ê°œí†µë°ì´í„°!A4:BZ',
    });

    const inventoryData = await sheets.spreadsheets.values.get({
      spreadsheetId: process.env.SHEET_ID,
      range: 'í°í´ì¬ê³ ë°ì´í„°!A4:AC',
    });

    const activationRows = activationData.data.values || [];
    const inventoryRows = inventoryData.data.values || [];

    // íœ´ëŒ€í° ë°ì´í„° í†µí•© (ê°œí†µ + ì¬ê³ )
    const phoneData = [];

    // ê°œí†µë°ì´í„°ì—ì„œ íœ´ëŒ€í° ì •ë³´ ì¶”ì¶œ
    console.log(`ğŸ“± ê°œí†µ ë°ì´í„° í–‰ ìˆ˜: ${activationRows.length}`);

    activationRows.forEach((row, index) => {
      if (row[12] && row[12] !== 'ìœ ì‹¬') { // Mì—´(12)ì´ ìœ ì‹¬ì´ ì•„ë‹Œ ê²½ìš°
        const serial = row[23] || '';
        const cleanSerial = serial.replace(/\s/g, '');

        // ë””ë²„ê¹…: ì²˜ìŒ 5ê°œ ì¼ë ¨ë²ˆí˜¸ ë¡œê·¸
        if (index < 5) {
          console.log(`ê°œí†µ ì¼ë ¨ë²ˆí˜¸ ${index}: ì›ë³¸="${row[23]}", ê³µë°±ì œê±°="${cleanSerial}", ê¸¸ì´=${cleanSerial.length}`);
        }

        phoneData.push({
          store: row[14] || '', // Oì—´(14) - ì—…ì²´ëª…
          model: row[21] || '', // Vì—´(21) - ëª¨ë¸ëª…
          color: row[22] || '', // Wì—´(22) - ìƒ‰ìƒ
          serial: serial, // Xì—´(23) - ì¼ë ¨ë²ˆí˜¸ (RIGHT í•¨ìˆ˜ë¡œ 6ìë¦¬)
          employee: row[77] || '', // BZì—´(77) - ë“±ë¡ì§ì›
          inputStore: row[12] || '', // Mì—´(12) - ì…ê³ ì²˜
          outputDate: row[9] || '', // Jì—´(9) - ì¶œê³ ì¼
          type: 'ê°œí†µ'
        });
      }
    });

    // ì¬ê³ ë°ì´í„°ì—ì„œ íœ´ëŒ€í° ì •ë³´ ì¶”ì¶œ
    console.log(`ğŸ“± ì¬ê³  ë°ì´í„° í–‰ ìˆ˜: ${inventoryRows.length}`);

    inventoryRows.forEach((row, index) => {
      if (row[12] && row[12] !== 'ìœ ì‹¬') { // Mì—´(12)ì´ ìœ ì‹¬ì´ ì•„ë‹Œ ê²½ìš°
        const serial = row[11] || '';
        const cleanSerial = serial.replace(/\s/g, '');

        // ë””ë²„ê¹…: ì²˜ìŒ 5ê°œ ì¼ë ¨ë²ˆí˜¸ ë¡œê·¸
        if (index < 5) {
          console.log(`ì¬ê³  ì¼ë ¨ë²ˆí˜¸ ${index}: ì›ë³¸="${row[11]}", ê³µë°±ì œê±°="${cleanSerial}", ê¸¸ì´=${cleanSerial.length}`);
        }

        phoneData.push({
          store: row[21] || '', // Vì—´(21) - ì—…ì²´ëª…
          model: row[13] || '', // Nì—´(13) - ëª¨ë¸ëª…
          color: row[14] || '', // Oì—´(14) - ìƒ‰ìƒ
          serial: serial, // Lì—´(11) - ì¼ë ¨ë²ˆí˜¸
          employee: row[28] || '', // ACì—´(28) - ë“±ë¡ì§ì›
          inputStore: row[18] || '', // Sì—´(18) - ì…ê³ ì²˜
          outputDate: row[22] || '', // Wì—´(22) - ì¶œê³ ì¼
          type: 'ì¬ê³ '
        });
      }
    });

    // ì¤‘ë³µ ê²€ì‚¬: ëª¨ë¸ëª… + ì¼ë ¨ë²ˆí˜¸(ë§ˆì§€ë§‰ 6ìë¦¬) ì¡°í•©
    const duplicateMap = new Map();
    phoneData.forEach(item => {
      // ì¼ë ¨ë²ˆí˜¸ ìœ íš¨ì„± ê²€ì‚¬: ê³µë°± ì œê±° í›„ ìµœì†Œ 6ìë¦¬ ì´ìƒ
      const cleanSerial = item.serial ? item.serial.replace(/\s/g, '') : '';
      if (!cleanSerial || cleanSerial.length < 6) {
        return; // ìœ íš¨í•˜ì§€ ì•Šì€ ì¼ë ¨ë²ˆí˜¸ëŠ” ê±´ë„ˆë›°ê¸°
      }

      const serialKey = cleanSerial.slice(-6); // ë§ˆì§€ë§‰ 6ìë¦¬ (ê³µë°± ì œê±° í›„)
      const key = `${item.model}|${serialKey}`;

      if (!duplicateMap.has(key)) {
        duplicateMap.set(key, []);
      }
      duplicateMap.get(key).push(item);
    });

    // ì¤‘ë³µëœ í•­ëª©ë§Œ í•„í„°ë§
    const duplicates = Array.from(duplicateMap.entries())
      .filter(([key, items]) => items.length > 1)
      .map(([key, items]) => ({
        key,
        count: items.length,
        items: items.sort((a, b) => a.store.localeCompare(b.store))
      }));

    // ë“±ë¡ì§ì› ë¹ˆë„ ê³„ì‚°
    const employeeFrequency = {};
    duplicates.forEach(duplicate => {
      duplicate.items.forEach(item => {
        if (item.employee) {
          employeeFrequency[item.employee] = (employeeFrequency[item.employee] || 0) + 1;
        }
      });
    });

    console.log(`ğŸ“± íœ´ëŒ€í° ì¤‘ë³µ ê²€ì‚¬ ì™„ë£Œ: ${duplicates.length}ê°œ ì¤‘ë³µ ê·¸ë£¹ ë°œê²¬`);

    res.json({
      success: true,
      data: {
        duplicates,
        employeeFrequency,
        totalDuplicates: duplicates.reduce((sum, dup) => sum + dup.count, 0)
      }
    });

  } catch (error) {
    console.error('âŒ í°í´ì¤‘ë³µê°’ API ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

app.get('/api/sim-duplicates', async (req, res) => {
  try {
    console.log('ğŸ“² ìœ ì‹¬ì¤‘ë³µê°’ API í˜¸ì¶œ ì‹œì‘');

    // í°í´ê°œí†µë°ì´í„°ì™€ í°í´ì¬ê³ ë°ì´í„° ì‹œíŠ¸ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const activationData = await sheets.spreadsheets.values.get({
      spreadsheetId: process.env.SHEET_ID,
      range: 'í°í´ê°œí†µë°ì´í„°!A4:BZ',
    });

    const inventoryData = await sheets.spreadsheets.values.get({
      spreadsheetId: process.env.SHEET_ID,
      range: 'í°í´ì¬ê³ ë°ì´í„°!A4:AC',
    });

    const activationRows = activationData.data.values || [];
    const inventoryRows = inventoryData.data.values || [];

    // ìœ ì‹¬ ë°ì´í„° í†µí•© (ê°œí†µ + ì¬ê³ )
    const simData = [];

    // ê°œí†µë°ì´í„°ì—ì„œ ìœ ì‹¬ ì •ë³´ ì¶”ì¶œ
    console.log(`ğŸ“² ê°œí†µ ë°ì´í„°ì—ì„œ ìœ ì‹¬ ê²€ìƒ‰ ì¤‘...`);
    let simCount = 0;

    activationRows.forEach((row, index) => {
      if (row[12] && row[12].includes('ìœ ì‹¬')) { // Mì—´(12)ì— ìœ ì‹¬ì´ í¬í•¨ëœ ê²½ìš°
        simCount++;
        if (simCount <= 5) {
          console.log(`ê°œí†µ ìœ ì‹¬ ${simCount}: Mì—´="${row[12]}", ëª¨ë¸="${row[24]}", ì¼ë ¨ë²ˆí˜¸="${row[25]}"`);
        }

        simData.push({
          store: row[14] || '', // Oì—´(14) - ì—…ì²´ëª…
          model: row[24] || '', // Yì—´(24) - ìœ ì‹¬ëª¨ë¸ëª…
          serial: row[25] || '', // Zì—´(25) - ìœ ì‹¬ì¼ë ¨ë²ˆí˜¸
          employee: row[77] || '', // BZì—´(77) - ë“±ë¡ì§ì›
          inputStore: row[12] || '', // Mì—´(12) - ì…ê³ ì²˜
          outputDate: row[9] || '', // Jì—´(9) - ì¶œê³ ì¼
          type: 'ê°œí†µ'
        });
      }
    });

    console.log(`ğŸ“² ê°œí†µì—ì„œ ìœ ì‹¬ ë°ì´í„° ${simCount}ê°œ ë°œê²¬`);

    // ì¬ê³ ë°ì´í„°ì—ì„œ ìœ ì‹¬ ì •ë³´ ì¶”ì¶œ
    console.log(`ğŸ“² ì¬ê³  ë°ì´í„°ì—ì„œ ìœ ì‹¬ ê²€ìƒ‰ ì¤‘...`);
    let inventorySimCount = 0;

    inventoryRows.forEach((row, index) => {
      if (row[12] && row[12].includes('ìœ ì‹¬')) { // Mì—´(12)ì— ìœ ì‹¬ì´ í¬í•¨ëœ ê²½ìš°
        inventorySimCount++;
        if (inventorySimCount <= 5) {
          console.log(`ì¬ê³  ìœ ì‹¬ ${inventorySimCount}: Mì—´="${row[12]}", ëª¨ë¸="${row[13]}", ì¼ë ¨ë²ˆí˜¸="${row[11]}"`);
        }

        simData.push({
          store: row[21] || '', // Vì—´(21) - ì—…ì²´ëª…
          model: row[13] || '', // Nì—´(13) - ìœ ì‹¬ëª¨ë¸ëª…
          serial: row[11] || '', // Lì—´(11) - ìœ ì‹¬ì¼ë ¨ë²ˆí˜¸
          employee: row[28] || '', // ACì—´(28) - ë“±ë¡ì§ì›
          inputStore: row[18] || '', // Sì—´(18) - ì…ê³ ì²˜
          outputDate: row[22] || '', // Wì—´(22) - ì¶œê³ ì¼
          type: 'ì¬ê³ '
        });
      }
    });

    console.log(`ğŸ“² ì¬ê³ ì—ì„œ ìœ ì‹¬ ë°ì´í„° ${inventorySimCount}ê°œ ë°œê²¬`);

    // ì¤‘ë³µ ê²€ì‚¬: ìœ ì‹¬ëª¨ë¸ëª… + ìœ ì‹¬ì¼ë ¨ë²ˆí˜¸(ë§ˆì§€ë§‰ 6ìë¦¬) ì¡°í•©
    const duplicateMap = new Map();
    simData.forEach(item => {
      // ìœ ì‹¬ ì¼ë ¨ë²ˆí˜¸ ìœ íš¨ì„± ê²€ì‚¬: ê³µë°± ì œê±° í›„ ìµœì†Œ 6ìë¦¬ ì´ìƒ
      const cleanSerial = item.serial ? item.serial.replace(/\s/g, '') : '';
      if (!cleanSerial || cleanSerial.length < 6) {
        return; // ìœ íš¨í•˜ì§€ ì•Šì€ ì¼ë ¨ë²ˆí˜¸ëŠ” ê±´ë„ˆë›°ê¸°
      }

      const serialKey = cleanSerial.slice(-6); // ë§ˆì§€ë§‰ 6ìë¦¬ (ê³µë°± ì œê±° í›„)
      const key = `${item.model}|${serialKey}`;

      if (!duplicateMap.has(key)) {
        duplicateMap.set(key, []);
      }
      duplicateMap.get(key).push(item);
    });

    // ì¤‘ë³µëœ í•­ëª©ë§Œ í•„í„°ë§
    const duplicates = Array.from(duplicateMap.entries())
      .filter(([key, items]) => items.length > 1)
      .map(([key, items]) => ({
        key,
        count: items.length,
        items: items.sort((a, b) => a.store.localeCompare(b.store))
      }));

    // ë“±ë¡ì§ì› ë¹ˆë„ ê³„ì‚°
    const employeeFrequency = {};
    duplicates.forEach(duplicate => {
      duplicate.items.forEach(item => {
        if (item.employee) {
          employeeFrequency[item.employee] = (employeeFrequency[item.employee] || 0) + 1;
        }
      });
    });

    console.log(`ğŸ“² ìœ ì‹¬ ë°ì´í„° í†µí•© ì™„ë£Œ: ${simData.length}ê°œ ìœ ì‹¬ ë°ì´í„° ë°œê²¬`);
    console.log(`ğŸ“² ìœ ì‹¬ ì¤‘ë³µ ê²€ì‚¬ ì™„ë£Œ: ${duplicates.length}ê°œ ì¤‘ë³µ ê·¸ë£¹ ë°œê²¬`);

    res.json({
      success: true,
      data: {
        duplicates,
        employeeFrequency,
        totalDuplicates: duplicates.reduce((sum, dup) => sum + dup.count, 0)
      }
    });

  } catch (error) {
    console.error('âŒ ìœ ì‹¬ì¤‘ë³µê°’ API ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

// í°í´ì…ê³ ê°€ìƒì´ê°’ API
app.get('/api/price-discrepancies', async (req, res) => {
  try {
    console.log('ğŸ’° í°í´ì…ê³ ê°€ìƒì´ê°’ API í˜¸ì¶œ ì‹œì‘');

    // ìºì‹±ëœ getSheetValues í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const [inventoryValues, activationValues] = await Promise.all([
      getSheetValues('í°í´ì¬ê³ ë°ì´í„°'),
      getSheetValues('í°í´ê°œí†µë°ì´í„°')
    ]);

    if (!inventoryValues || inventoryValues.length === 0) {
      throw new Error('í°í´ì¬ê³ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    if (!activationValues || activationValues.length === 0) {
      throw new Error('í°í´ê°œí†µë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    // í—¤ë” ì œê±° (í°í´ì¬ê³ ë°ì´í„°: 3í–‰ í—¤ë”, í°í´ê°œí†µë°ì´í„°: 3í–‰ í—¤ë”)
    const inventoryRows = inventoryValues.slice(3);
    const activationRows = activationValues.slice(3);

    console.log(`ğŸ’° í°í´ì¬ê³ ë°ì´í„° í–‰ ìˆ˜: ${inventoryRows.length} (ìºì‹œ ì‚¬ìš©)`);
    console.log(`ğŸ’° í°í´ê°œí†µë°ì´í„° í–‰ ìˆ˜: ${activationRows.length} (ìºì‹œ ì‚¬ìš©)`);

    // ëª¨ë¸ëª…ë³„ ì…ê³ ê°€ ë°ì´í„° ìˆ˜ì§‘
    const modelPriceMap = new Map();

    // í°í´ì¬ê³ ë°ì´í„°ì—ì„œ ë°ì´í„° ì¶”ì¶œ
    inventoryRows.forEach((row, index) => {
      const modelName = (row[13] || '').toString().trim(); // Nì—´(13) - ëª¨ë¸ëª…
      const inPrice = (row[17] || '').toString().trim(); // Rì—´(17) - ì…ê³ ê°€

      // ëª¨ë¸ëª…ê³¼ ì…ê³ ê°€ê°€ ëª¨ë‘ ìˆëŠ” ê²½ìš°ë§Œ ì²˜ë¦¬
      if (modelName && inPrice) {
        if (!modelPriceMap.has(modelName)) {
          modelPriceMap.set(modelName, []);
        }

        modelPriceMap.get(modelName).push({
          sheetName: 'í°í´ì¬ê³ ë°ì´í„°',
          rowIndex: index + 4, // 4í–‰ë¶€í„° ì‹œì‘
          modelName: modelName,
          inPrice: inPrice,
          outStore: (row[21] || '').toString().trim(), // Vì—´(21) - ì¶œê³ ì²˜
          serial: (row[11] || '').toString().trim(), // Lì—´(11) - ì¼ë ¨ë²ˆí˜¸
          processDate: (row[22] || '').toString().trim(), // Wì—´(22) - ìµœì¢…ì²˜ë¦¬ì¼
          employee: (row[28] || '').toString().trim() // ACì—´(28) - ìµœì¢…ì‘ì—…ì
        });
      }
    });

    // í°í´ê°œí†µë°ì´í„°ì—ì„œ ë°ì´í„° ì¶”ì¶œ
    activationRows.forEach((row, index) => {
      const modelName = (row[21] || '').toString().trim(); // Vì—´(21) - ëª¨ë¸ëª…
      const inPrice = (row[35] || '').toString().trim(); // AJì—´(35) - ì…ê³ ê°€

      // ëª¨ë¸ëª…ê³¼ ì…ê³ ê°€ê°€ ëª¨ë‘ ìˆëŠ” ê²½ìš°ë§Œ ì²˜ë¦¬
      if (modelName && inPrice) {
        if (!modelPriceMap.has(modelName)) {
          modelPriceMap.set(modelName, []);
        }

        modelPriceMap.get(modelName).push({
          sheetName: 'í°í´ê°œí†µë°ì´í„°',
          rowIndex: index + 4, // 4í–‰ë¶€í„° ì‹œì‘
          modelName: modelName,
          inPrice: inPrice,
          outStore: (row[14] || '').toString().trim(), // Oì—´(14) - ì¶œê³ ì²˜
          serial: (row[23] || '').toString().trim(), // Xì—´(23) - ì¼ë ¨ë²ˆí˜¸
          processDate: (row[9] || '').toString().trim(), // Jì—´(9) - ìµœì¢…ì²˜ë¦¬ì¼
          employee: (row[77] || '').toString().trim() // BZì—´(77) - ìµœì¢…ì‘ì—…ì
        });
      }
    });

    console.log(`ğŸ’° ëª¨ë¸ëª… ì¢…ë¥˜: ${modelPriceMap.size}ê°œ`);

    // ì…ê³ ê°€ê°€ ìƒì´í•œ ëª¨ë¸ëª…ë§Œ í•„í„°ë§
    const discrepancies = [];

    modelPriceMap.forEach((items, modelName) => {
      // ì…ê³ ê°€ë³„ë¡œ ê·¸ë£¹í™”
      const priceGroups = new Map();

      items.forEach(item => {
        // ì…ê³ ê°€ ì •ê·œí™” (ìˆ«ìë§Œ ì¶”ì¶œ, ì½¤ë§ˆ ë° ê³µë°± ì œê±°)
        const normalizedPrice = item.inPrice.replace(/[,\s]/g, '');

        if (!priceGroups.has(normalizedPrice)) {
          priceGroups.set(normalizedPrice, []);
        }
        priceGroups.get(normalizedPrice).push(item);
      });

      // ì…ê³ ê°€ê°€ 2ê°œ ì´ìƒì¸ ê²½ìš°ë§Œ ìƒì´ê°’ìœ¼ë¡œ íŒë‹¨
      if (priceGroups.size > 1) {
        // ì…ê³ ê°€ë³„ ê±´ìˆ˜ ì§‘ê³„
        const priceBreakdown = Array.from(priceGroups.entries())
          .map(([price, items]) => ({
            price: price,
            count: items.length
          }))
          .sort((a, b) => b.count - a.count); // ê±´ìˆ˜ ë§ì€ ìˆœìœ¼ë¡œ ì •ë ¬

        // ê°€ì¥ ë§ì´ ë‚˜ì˜¤ëŠ” ì…ê³ ê°€ë¥¼ ì¶”ì²œ ì…ê³ ê°€ë¡œ ì„¤ì •
        const recommendedPrice = priceBreakdown[0].price;
        const totalCount = items.length;
        const recommendedCount = priceBreakdown[0].count;
        const confidence = ((recommendedCount / totalCount) * 100).toFixed(1);

        discrepancies.push({
          modelName: modelName,
          recommendedPrice: recommendedPrice,
          confidence: parseFloat(confidence),
          priceBreakdown: priceBreakdown,
          items: items.sort((a, b) => {
            // ì¶”ì²œ ì…ê³ ê°€ê°€ ì•„ë‹Œ í•­ëª©ì„ ë¨¼ì € í‘œì‹œ
            const aNormalized = a.inPrice.replace(/[,\s]/g, '');
            const bNormalized = b.inPrice.replace(/[,\s]/g, '');
            if (aNormalized !== recommendedPrice && bNormalized === recommendedPrice) return -1;
            if (aNormalized === recommendedPrice && bNormalized !== recommendedPrice) return 1;
            return a.sheetName.localeCompare(b.sheetName);
          })
        });
      }
    });

    // ëª¨ë¸ëª… ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
    discrepancies.sort((a, b) => a.modelName.localeCompare(b.modelName));

    console.log(`ğŸ’° ì…ê³ ê°€ ìƒì´ê°’ ë°œê²¬: ${discrepancies.length}ê°œ ëª¨ë¸ëª…`);
    console.log(`ğŸ’° ì´ ìƒì´ê°’ í•­ëª© ìˆ˜: ${discrepancies.reduce((sum, d) => sum + d.items.length, 0)}ê°œ`);

    res.json({
      success: true,
      data: {
        discrepancies: discrepancies,
        totalDiscrepancies: discrepancies.length,
        totalItems: discrepancies.reduce((sum, d) => sum + d.items.length, 0)
      }
    });

  } catch (error) {
    console.error('âŒ í°í´ì…ê³ ê°€ìƒì´ê°’ API ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

// ============================================================
// ë¬´ì„ ë‹¨ë§ê²€ìˆ˜ ê´€ë ¨ API
// ============================================================

// ì¼ë ¨ë²ˆí˜¸ ì •ê·œí™” í•¨ìˆ˜ (ê³µë°± ì œê±°, ì•ë¶€ë¶„ ì—°ì†ëœ 0 ì œê±°)
function normalizeSerialNumber(serial) {
  if (!serial) return '';

  // ê³µë°± ì œê±°
  let normalized = serial.toString().trim().replace(/\s+/g, '');

  // ì•ŒíŒŒë²³ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ê²½ìš°, ì•ë¶€ë¶„ ì—°ì†ëœ 0 ì œê±°
  // ì˜ˆ: "000000ABC123" -> "ABC123", "00123ABC" -> "123ABC"
  normalized = normalized.replace(/^0+(?=\w)/, '');

  return normalized.toUpperCase(); // ëŒ€ì†Œë¬¸ì í†µì¼
}

// ë§ˆìŠ¤í„°ì¬ê³  ë°ì´í„° ì¡°íšŒ API
app.get('/api/master-inventory', async (req, res) => {
  try {
    console.log('ğŸ“¦ ë§ˆìŠ¤í„°ì¬ê³  ë°ì´í„° ì¡°íšŒ ì‹œì‘...');

    // ë§ˆìŠ¤í„°ì¬ê³  ì‹œíŠ¸ IDëŠ” í™˜ê²½ë³€ìˆ˜ì—ì„œ ê°€ì ¸ì˜´
    const masterSpreadsheetId = '12_oC7c2xqHlDCppUvWL2EFesszA3oDU5JBdrYccYT7Q';
    const sheetData = await fetchSheetValuesDirectly('ë§ˆìŠ¤í„°ì¬ê³ ', masterSpreadsheetId);

    if (!sheetData || sheetData.length === 0) {
      return res.json({ success: true, data: [] });
    }

    // í—¤ë” ì œì™¸í•˜ê³  ë°ì´í„° íŒŒì‹±
    const rows = sheetData.slice(1);
    const inventory = rows.map(row => ({
      modelCode: row[9] || '',           // ëª¨ë¸ì½”ë“œ (10ë²ˆì§¸ ì»¬ëŸ¼)
      color: row[11] || '',              // ìƒ‰ìƒ (12ë²ˆì§¸ ì»¬ëŸ¼)
      serialNumber: row[12] || '',       // ì¼ë ¨ë²ˆí˜¸ (13ë²ˆì§¸ ì»¬ëŸ¼)
      normalizedSerial: normalizeSerialNumber(row[12]), // ì •ê·œí™”ëœ ì¼ë ¨ë²ˆí˜¸
      outletCode: row[17] || '',         // ì¶œê³ ì ì½”ë“œ (18ë²ˆì§¸ ì»¬ëŸ¼)
      firstInDate: row[23] || '',        // ìµœì´ˆì…ê³ ì¼ì (24ë²ˆì§¸ ì»¬ëŸ¼)
      dealerInDate: row[26] || ''        // ëŒ€ë¦¬ì ì…ê³ ì¼ì (27ë²ˆì§¸ ì»¬ëŸ¼)
    })).filter(item => item.serialNumber); // ì¼ë ¨ë²ˆí˜¸ê°€ ìˆëŠ” ê²ƒë§Œ

    console.log(`âœ… ë§ˆìŠ¤í„°ì¬ê³  ë°ì´í„° ì¡°íšŒ ì™„ë£Œ: ${inventory.length}ê°œ`);

    res.json({
      success: true,
      data: inventory
    });

  } catch (error) {
    console.error('âŒ ë§ˆìŠ¤í„°ì¬ê³  ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

// í°í´ì¬ê³  ë°ì´í„° ì¡°íšŒ API
app.get('/api/phonekl-inventory', async (req, res) => {
  try {
    console.log('ğŸ“± í°í´ì¬ê³  ë°ì´í„° ì¡°íšŒ ì‹œì‘...');

    const phoneklSpreadsheetId = '12_oC7c2xqHlDCppUvWL2EFesszA3oDU5JBdrYccYT7Q';
    const sheetData = await fetchSheetValuesDirectly('í°í´ì¬ê³ ', phoneklSpreadsheetId);

    if (!sheetData || sheetData.length === 0) {
      return res.json({ success: true, data: [] });
    }

    // í—¤ë” ì œì™¸í•˜ê³  ë°ì´í„° íŒŒì‹±
    const rows = sheetData.slice(1);
    const inventory = rows.map(row => ({
      inDate: row[8] || '',              // ì…ê³ ì¼ (9ë²ˆì§¸ ì»¬ëŸ¼)
      serialNumber: row[10] || '',       // ì¼ë ¨ë²ˆí˜¸ (11ë²ˆì§¸ ì»¬ëŸ¼)
      normalizedSerial: normalizeSerialNumber(row[10]), // ì •ê·œí™”ëœ ì¼ë ¨ë²ˆí˜¸
      type: row[11] || '',               // ì¢…ë¥˜ (12ë²ˆì§¸ ì»¬ëŸ¼)
      modelName: row[12] || '',          // ëª¨ë¸ëª… (13ë²ˆì§¸ ì»¬ëŸ¼)
      color: row[13] || '',              // ìƒ‰ìƒ (14ë²ˆì§¸ ì»¬ëŸ¼)
      status: row[14] || '',             // ìƒíƒœ (15ë²ˆì§¸ ì»¬ëŸ¼)
      inPrice: row[16] || ''             // ì…ê³ ê°€ (17ë²ˆì§¸ ì»¬ëŸ¼)
    })).filter(item => item.serialNumber); // ì¼ë ¨ë²ˆí˜¸ê°€ ìˆëŠ” ê²ƒë§Œ

    console.log(`âœ… í°í´ì¬ê³  ë°ì´í„° ì¡°íšŒ ì™„ë£Œ: ${inventory.length}ê°œ`);

    res.json({
      success: true,
      data: inventory
    });

  } catch (error) {
    console.error('âŒ í°í´ì¬ê³  ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

// ëª¨ë¸ëª…ì •ê·œí™” ë°ì´í„° ì¡°íšŒ API
app.get('/api/model-normalization', async (req, res) => {
  try {
    console.log('ğŸ”„ ëª¨ë¸ëª…ì •ê·œí™” ë°ì´í„° ì¡°íšŒ ì‹œì‘...');

    const spreadsheetId = '12_oC7c2xqHlDCppUvWL2EFesszA3oDU5JBdrYccYT7Q';
    const sheetData = await fetchSheetValuesDirectly('ëª¨ë¸ëª…ì •ê·œí™”', spreadsheetId);

    if (!sheetData || sheetData.length === 0) {
      return res.json({ success: true, data: {} });
    }

    // í—¤ë” ì œì™¸í•˜ê³  ë°ì´í„° íŒŒì‹±
    const rows = sheetData.slice(1);
    const normalizationMap = {};

    rows.forEach(row => {
      const modelCode = row[0] || '';           // ì›ë³¸ ëª¨ë¸ì½”ë“œ
      const normalizedName = row[1] || '';      // ì •ê·œí™”ëœ ëª¨ë¸ëª…

      if (modelCode && normalizedName) {
        normalizationMap[modelCode] = normalizedName;
      }
    });

    console.log(`âœ… ëª¨ë¸ëª…ì •ê·œí™” ë°ì´í„° ì¡°íšŒ ì™„ë£Œ: ${Object.keys(normalizationMap).length}ê°œ`);

    res.json({
      success: true,
      data: normalizationMap
    });

  } catch (error) {
    console.error('âŒ ëª¨ë¸ëª…ì •ê·œí™” ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

// ëª¨ë¸ëª…ì •ê·œí™” ë°ì´í„° ì €ì¥ API
app.post('/api/model-normalization', async (req, res) => {
  try {
    console.log('ğŸ’¾ ëª¨ë¸ëª…ì •ê·œí™” ë°ì´í„° ì €ì¥ ì‹œì‘...');

    const { normalizationMap } = req.body;

    if (!normalizationMap || typeof normalizationMap !== 'object') {
      return res.status(400).json({
        success: false,
        error: 'ì •ê·œí™” ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'
      });
    }

    const spreadsheetId = '12_oC7c2xqHlDCppUvWL2EFesszA3oDU5JBdrYccYT7Q';

    // í—¤ë” + ë°ì´í„° í–‰ ìƒì„±
    const rows = [
      ['ëª¨ë¸ì½”ë“œ', 'ì •ê·œí™”ëª¨ë¸ëª…', 'ë“±ë¡ì¼ì‹œ']
    ];

    Object.entries(normalizationMap).forEach(([modelCode, normalizedName]) => {
      if (normalizedName) { // ì •ê·œí™”ëª…ì´ ì…ë ¥ëœ ê²ƒë§Œ ì €ì¥
        rows.push([
          modelCode,
          normalizedName,
          new Date().toISOString()
        ]);
      }
    });

    // ì‹œíŠ¸ ì—…ë°ì´íŠ¸
    await sheets.spreadsheets.values.update({
      spreadsheetId: spreadsheetId,
      range: 'ëª¨ë¸ëª…ì •ê·œí™”!A:C',
      valueInputOption: 'USER_ENTERED',
      resource: {
        values: rows
      }
    });

    console.log(`âœ… ëª¨ë¸ëª…ì •ê·œí™” ë°ì´í„° ì €ì¥ ì™„ë£Œ: ${rows.length - 1}ê°œ`);

    res.json({
      success: true,
      message: `${rows.length - 1}ê°œì˜ ì •ê·œí™” ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`
    });

  } catch (error) {
    console.error('âŒ ëª¨ë¸ëª…ì •ê·œí™” ì €ì¥ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

// í™•ì¸ëœë¯¸í™•ì¸ì¬ê³  ë°ì´í„° ì¡°íšŒ API
app.get('/api/confirmed-unconfirmed-inventory', async (req, res) => {
  try {
    console.log('âœ”ï¸ í™•ì¸ëœë¯¸í™•ì¸ì¬ê³  ë°ì´í„° ì¡°íšŒ ì‹œì‘...');

    const spreadsheetId = '12_oC7c2xqHlDCppUvWL2EFesszA3oDU5JBdrYccYT7Q';
    const sheetData = await fetchSheetValuesDirectly('í™•ì¸ëœë¯¸í™•ì¸ì¬ê³ ', spreadsheetId);

    if (!sheetData || sheetData.length === 0) {
      return res.json({ success: true, data: [] });
    }

    // í—¤ë” ì œì™¸í•˜ê³  ë°ì´í„° íŒŒì‹±
    const rows = sheetData.slice(1);
    const confirmedItems = rows.map(row => ({
      outletCode: row[0] || '',          // ì¶œê³ ì ì½”ë“œ
      inPrice: row[1] || '',             // ì…ê³ ê°€
      modelCode: row[2] || '',           // ëª¨ë¸ì½”ë“œ
      color: row[3] || '',               // ìƒ‰ìƒ
      serialNumber: row[4] || '',        // ì¼ë ¨ë²ˆí˜¸
      normalizedSerial: normalizeSerialNumber(row[4]), // ì •ê·œí™”ëœ ì¼ë ¨ë²ˆí˜¸
      inDate: row[5] || '',              // ì…ê³ ì¼ì
      confirmNote: row[6] || '',         // í™•ì¸ë‚´ìš©
      status: row[7] || ''               // ì§„í–‰ìƒí™©
    })).filter(item => item.serialNumber); // ì¼ë ¨ë²ˆí˜¸ê°€ ìˆëŠ” ê²ƒë§Œ

    console.log(`âœ… í™•ì¸ëœë¯¸í™•ì¸ì¬ê³  ë°ì´í„° ì¡°íšŒ ì™„ë£Œ: ${confirmedItems.length}ê°œ`);

    res.json({
      success: true,
      data: confirmedItems
    });

  } catch (error) {
    console.error('âŒ í™•ì¸ëœë¯¸í™•ì¸ì¬ê³  ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

// í™•ì¸ëœë¯¸í™•ì¸ì¬ê³  ë°ì´í„° ì¶”ê°€ API
app.post('/api/confirmed-unconfirmed-inventory', async (req, res) => {
  try {
    console.log('ğŸ’¾ í™•ì¸ëœë¯¸í™•ì¸ì¬ê³  ë°ì´í„° ì¶”ê°€ ì‹œì‘...');

    const { items } = req.body;

    if (!items || !Array.isArray(items) || items.length === 0) {
      return res.status(400).json({
        success: false,
        error: 'ì¶”ê°€í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.'
      });
    }

    const spreadsheetId = '12_oC7c2xqHlDCppUvWL2EFesszA3oDU5JBdrYccYT7Q';

    // ê¸°ì¡´ ë°ì´í„° ì¡°íšŒ
    const existingData = await fetchSheetValuesDirectly('í™•ì¸ëœë¯¸í™•ì¸ì¬ê³ ', spreadsheetId);

    // ìƒˆë¡œìš´ í•­ëª© ì¶”ê°€
    const newRows = items.map(item => [
      item.outletCode || '',
      item.inPrice || '',
      item.modelCode || '',
      item.color || '',
      item.serialNumber || '',
      item.inDate || '',
      item.confirmNote || '',
      item.status || 'ì²˜ë¦¬ì¤‘'
    ]);

    // í—¤ë”ê°€ ì—†ìœ¼ë©´ ìƒì„±
    let allRows;
    if (!existingData || existingData.length === 0) {
      allRows = [
        ['ì¶œê³ ì ì½”ë“œ', 'ì…ê³ ê°€', 'ëª¨ë¸ì½”ë“œ', 'ìƒ‰ìƒ', 'ì¼ë ¨ë²ˆí˜¸', 'ì…ê³ ì¼ì', 'í™•ì¸ë‚´ìš©', 'ì§„í–‰ìƒí™©'],
        ...newRows
      ];
    } else {
      allRows = [
        ...existingData,
        ...newRows
      ];
    }

    // ì‹œíŠ¸ ì—…ë°ì´íŠ¸
    await sheets.spreadsheets.values.update({
      spreadsheetId: spreadsheetId,
      range: 'í™•ì¸ëœë¯¸í™•ì¸ì¬ê³ !A:H',
      valueInputOption: 'USER_ENTERED',
      resource: {
        values: allRows
      }
    });

    console.log(`âœ… í™•ì¸ëœë¯¸í™•ì¸ì¬ê³  ë°ì´í„° ì¶”ê°€ ì™„ë£Œ: ${newRows.length}ê°œ`);

    res.json({
      success: true,
      message: `${newRows.length}ê°œì˜ í•­ëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`
    });

  } catch (error) {
    console.error('âŒ í™•ì¸ëœë¯¸í™•ì¸ì¬ê³  ì¶”ê°€ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

// ì¬ê³  ë¹„êµ ê²€ìˆ˜ API
app.post('/api/inventory-inspection', async (req, res) => {
  try {
    console.log('ğŸ” ì¬ê³  ë¹„êµ ê²€ìˆ˜ ì‹œì‘...');

    const spreadsheetId = '12_oC7c2xqHlDCppUvWL2EFesszA3oDU5JBdrYccYT7Q';

    // 1. ë§ˆìŠ¤í„°ì¬ê³  ì¡°íšŒ
    const masterData = await fetchSheetValuesDirectly('ë§ˆìŠ¤í„°ì¬ê³ ', spreadsheetId);
    const masterRows = masterData.slice(1);
    const masterInventory = masterRows.map(row => ({
      modelCode: row[9] || '',
      color: row[11] || '',
      serialNumber: row[12] || '',
      normalizedSerial: normalizeSerialNumber(row[12]),
      outletCode: row[17] || '',
      firstInDate: row[23] || '',
      dealerInDate: row[26] || ''
    })).filter(item => item.serialNumber);

    // 2. í°í´ì¬ê³  ì¡°íšŒ
    const phoneklData = await fetchSheetValuesDirectly('í°í´ì¬ê³ ', spreadsheetId);
    const phoneklRows = phoneklData.slice(1);
    const phoneklInventory = phoneklRows.map(row => ({
      inDate: row[8] || '',
      serialNumber: row[10] || '',
      normalizedSerial: normalizeSerialNumber(row[10]),
      type: row[11] || '',
      modelName: row[12] || '',
      color: row[13] || '',
      status: row[14] || '',
      inPrice: row[16] || '',
      inStore: row[17] || '',    // ì…ê³ ì²˜ (18ë²ˆì§¸ ì»¬ëŸ¼)
      outStore: row[20] || ''    // ì¶œê³ ì²˜ (21ë²ˆì§¸ ì»¬ëŸ¼)
    })).filter(item => item.serialNumber);

    // 3. ëª¨ë¸ëª…ì •ê·œí™” ë§µ ì¡°íšŒ
    const normData = await fetchSheetValuesDirectly('ëª¨ë¸ëª…ì •ê·œí™”', spreadsheetId);
    const normalizationMap = {};
    if (normData && normData.length > 1) {
      normData.slice(1).forEach(row => {
        const modelCode = row[0] || '';
        const normalizedName = row[1] || '';
        if (modelCode && normalizedName) {
          normalizationMap[modelCode] = normalizedName;
        }
      });
    }

    // 4. í™•ì¸ëœë¯¸í™•ì¸ì¬ê³  ì¡°íšŒ
    const confirmedData = await fetchSheetValuesDirectly('í™•ì¸ëœë¯¸í™•ì¸ì¬ê³ ', spreadsheetId);
    const confirmedSet = new Set();
    if (confirmedData && confirmedData.length > 1) {
      confirmedData.slice(1).forEach(row => {
        const serial = normalizeSerialNumber(row[4] || '');
        if (serial) {
          confirmedSet.add(serial);
        }
      });
    }

    // 5. í°í´ì¬ê³ ë¥¼ Mapìœ¼ë¡œ ë³€í™˜ (ë¹ ë¥¸ ê²€ìƒ‰ì„ ìœ„í•´)
    const phoneklMap = new Map();
    phoneklInventory.forEach(item => {
      phoneklMap.set(item.normalizedSerial, item);
    });

    // 6. ë§ˆìŠ¤í„°ì¬ê³  ê¸°ì¤€ìœ¼ë¡œ ë¹„êµ
    const matchedItems = [];
    const unmatchedItems = [];
    const needsNormalization = new Set();

    masterInventory.forEach(masterItem => {
      const phoneklItem = phoneklMap.get(masterItem.normalizedSerial);

      if (phoneklItem) {
        // ì¼ë ¨ë²ˆí˜¸ ì¼ì¹˜
        matchedItems.push({
          ...masterItem,
          phoneklData: phoneklItem,
          matched: true
        });
      } else {
        // ì¼ë ¨ë²ˆí˜¸ ë¶ˆì¼ì¹˜ - í™•ì¸ëœë¯¸í™•ì¸ì¬ê³ ì— ìˆëŠ”ì§€ í™•ì¸
        const isConfirmed = confirmedSet.has(masterItem.normalizedSerial);

        if (!isConfirmed) {
          // í™•ì¸ë˜ì§€ ì•Šì€ ë¯¸í™•ì¸ ì¬ê³ 
          unmatchedItems.push({
            ...masterItem,
            matched: false,
            isConfirmed: false
          });
        } else {
          // ì´ë¯¸ í™•ì¸ëœ ì¬ê³ 
          unmatchedItems.push({
            ...masterItem,
            matched: false,
            isConfirmed: true
          });
        }
      }

      // ëª¨ë¸ì½”ë“œê°€ ì •ê·œí™”ë˜ì§€ ì•Šì€ ê²½ìš° ì¶”ê°€
      if (masterItem.modelCode && !normalizationMap[masterItem.modelCode]) {
        needsNormalization.add(masterItem.modelCode);
      }
    });

    console.log(`âœ… ì¬ê³  ë¹„êµ ê²€ìˆ˜ ì™„ë£Œ`);
    console.log(`   - ì „ì²´: ${masterInventory.length}ê°œ`);
    console.log(`   - ì¼ì¹˜: ${matchedItems.length}ê°œ`);
    console.log(`   - ë¯¸í™•ì¸: ${unmatchedItems.filter(i => !i.isConfirmed).length}ê°œ`);
    console.log(`   - í™•ì¸ë¨: ${unmatchedItems.filter(i => i.isConfirmed).length}ê°œ`);
    console.log(`   - ì •ê·œí™” í•„ìš”: ${needsNormalization.size}ê°œ`);

    res.json({
      success: true,
      data: {
        total: masterInventory.length,
        matched: matchedItems,
        unmatched: unmatchedItems.filter(i => !i.isConfirmed), // ë¯¸í™•ì¸ë§Œ
        confirmed: unmatchedItems.filter(i => i.isConfirmed),  // í™•ì¸ëœ ê²ƒë“¤
        needsNormalization: Array.from(needsNormalization),
        normalizationMap: normalizationMap,
        statistics: {
          totalCount: masterInventory.length,
          matchedCount: matchedItems.length,
          unmatchedCount: unmatchedItems.filter(i => !i.isConfirmed).length,
          confirmedCount: unmatchedItems.filter(i => i.isConfirmed).length,
          needsNormalizationCount: needsNormalization.size
        }
      }
    });

  } catch (error) {
    console.error('âŒ ì¬ê³  ë¹„êµ ê²€ìˆ˜ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

// ì •ë³´ìˆ˜ì§‘ëª¨ë“œ ì•± ì—…ë°ì´íŠ¸ API
app.get('/api/data-collection-updates', async (req, res) => {
  try {
    console.log('ì •ë³´ìˆ˜ì§‘ëª¨ë“œ ì•± ì—…ë°ì´íŠ¸ ë°ì´í„° ìš”ì²­');

    const values = await getSheetValues('ì–´í”Œì—…ë°ì´íŠ¸');

    if (!values || values.length === 0) {
      console.log('ì •ë³´ìˆ˜ì§‘ëª¨ë“œ ì•± ì—…ë°ì´íŠ¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return res.json({ success: true, data: [] });
    }

    // í—¤ë” 2í–‰ ì œê±°í•˜ê³  ë°ì´í„° ë°˜í™˜ (3í–‰ë¶€í„° ì‹œì‘)
    const dataRows = values.slice(2);

    // ì •ë³´ìˆ˜ì§‘ëª¨ë“œ ê´€ë ¨ ì—…ë°ì´íŠ¸ë§Œ í•„í„°ë§ (Oì—´ 14ì¸ë±ìŠ¤)
    const dataCollectionUpdates = dataRows.filter(row => {
      const mode = row[14] || ''; // Oì—´
      return mode.toString().toLowerCase().includes('ì •ë³´ìˆ˜ì§‘') ||
        mode.toString().toLowerCase().includes('ë°ì´í„°ìˆ˜ì§‘');
    });

    // ë¹ˆ í–‰ ì œê±°
    const filteredData = dataCollectionUpdates.filter(row =>
      row.length > 0 && row.some(cell => cell && cell.toString().trim() !== '')
    );

    console.log(`ì •ë³´ìˆ˜ì§‘ëª¨ë“œ ì•± ì—…ë°ì´íŠ¸ ë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ: ${filteredData.length}ê±´`);

    res.json({ success: true, data: filteredData });

  } catch (error) {
    console.error('ì •ë³´ìˆ˜ì§‘ëª¨ë“œ ì•± ì—…ë°ì´íŠ¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// ============================================
// SMS ê´€ë¦¬ API
// ============================================

// SMS ìë™ì‘ë‹µ ì‹œíŠ¸ í—¤ë” ì´ˆê¸°í™” í•¨ìˆ˜
async function ensureAutoReplySheetHeaders() {
  try {
    // SMSìë™ì‘ë‹µê·œì¹™ ì‹œíŠ¸ í—¤ë” ì²´í¬
    try {
      const rulesResponse = await sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: `${SMS_AUTO_REPLY_RULES_SHEET_NAME}!A1:K1`,
      });

      if (!rulesResponse.data.values || rulesResponse.data.values.length === 0) {
        console.log('SMSìë™ì‘ë‹µê·œì¹™ ì‹œíŠ¸ í—¤ë” ì¶”ê°€ ì¤‘...');
        await sheets.spreadsheets.values.update({
          spreadsheetId: SPREADSHEET_ID,
          range: `${SMS_AUTO_REPLY_RULES_SHEET_NAME}!A1:K1`,
          valueInputOption: 'RAW',
          resource: {
            values: [['ê·œì¹™ID', 'ê·œì¹™ëª…', 'í‚¤ì›Œë“œ', 'ë‹µë³€ìœ í˜•', 'ë‹µë³€í…œí”Œë¦¿', 'ê°€ê²©ì¡°íšŒì„¤ì •', 'í™œì„±í™”ì—¬ë¶€', 'ìš°ì„ ìˆœìœ„', 'ìƒì„±ì¼ì‹œ', 'ìˆ˜ì •ì¼ì‹œ', 'ë©”ëª¨']]
          }
        });
      }
    } catch (rulesError) {
      if (rulesError.code === 429) {
        console.log('âš ï¸ [AUTO-REPLY-HEADER] API í• ë‹¹ëŸ‰ ì´ˆê³¼ - í—¤ë” ì²´í¬ ìŠ¤í‚µ');
      } else {
        throw rulesError;
      }
    }

    // SMSìë™ì‘ë‹µê±°ë˜ì²˜ ì‹œíŠ¸ í—¤ë” ì²´í¬
    try {
      const contactsResponse = await sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: `${SMS_AUTO_REPLY_CONTACTS_SHEET_NAME}!A1:H1`,
      });

      if (!contactsResponse.data.values || contactsResponse.data.values.length === 0) {
        console.log('SMSìë™ì‘ë‹µê±°ë˜ì²˜ ì‹œíŠ¸ í—¤ë” ì¶”ê°€ ì¤‘...');
        await sheets.spreadsheets.values.update({
          spreadsheetId: SPREADSHEET_ID,
          range: `${SMS_AUTO_REPLY_CONTACTS_SHEET_NAME}!A1:H1`,
          valueInputOption: 'RAW',
          resource: {
            values: [['ID', 'ìœ í˜•', 'ë‹´ë‹¹ì˜ì—…ì‚¬ì›ID', 'ì´ë¦„', 'ì—°ë½ì²˜', 'ë“±ë¡ë°©ì‹', 'ë“±ë¡ì¼ì‹œ', 'ë©”ëª¨']]
          }
        });
      }
    } catch (contactsError) {
      if (contactsError.code === 429) {
        console.log('âš ï¸ [AUTO-REPLY-HEADER] API í• ë‹¹ëŸ‰ ì´ˆê³¼ - í—¤ë” ì²´í¬ ìŠ¤í‚µ');
      } else {
        throw contactsError;
      }
    }

    // SMSìë™ì‘ë‹µì´ë ¥ ì‹œíŠ¸ í—¤ë” ì²´í¬
    try {
      const historyResponse = await sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: `${SMS_AUTO_REPLY_HISTORY_SHEET_NAME}!A1:J1`,
      });

      if (!historyResponse.data.values || historyResponse.data.values.length === 0) {
        console.log('SMSìë™ì‘ë‹µì´ë ¥ ì‹œíŠ¸ í—¤ë” ì¶”ê°€ ì¤‘...');
        await sheets.spreadsheets.values.update({
          spreadsheetId: SPREADSHEET_ID,
          range: `${SMS_AUTO_REPLY_HISTORY_SHEET_NAME}!A1:J1`,
          valueInputOption: 'RAW',
          resource: {
            values: [['ì´ë ¥ID', 'ìˆ˜ì‹ ì¼ì‹œ', 'ë°œì‹ ë²ˆí˜¸', 'ê±°ë˜ì²˜ëª…', 'ë¬¸ì˜ë‚´ìš©', 'ë§¤ì¹­ëœê·œì¹™', 'ë‹µë³€ë‚´ìš©', 'ë°œì†¡ë²ˆí˜¸', 'ë°œì†¡ìƒíƒœ', 'ë°œì†¡ì¼ì‹œ']]
          }
        });
      }
    } catch (historyError) {
      if (historyError.code === 429) {
        console.log('âš ï¸ [AUTO-REPLY-HEADER] API í• ë‹¹ëŸ‰ ì´ˆê³¼ - í—¤ë” ì²´í¬ ìŠ¤í‚µ');
      } else {
        throw historyError;
      }
    }

    console.log('SMS ìë™ì‘ë‹µ ì‹œíŠ¸ í—¤ë” ì²´í¬ ì™„ë£Œ');
  } catch (error) {
    if (error.code !== 429) {
      console.error('SMS ìë™ì‘ë‹µ ì‹œíŠ¸ í—¤ë” ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
    }
  }
}

// SMS ì‹œíŠ¸ í—¤ë” ìë™ ì´ˆê¸°í™” í•¨ìˆ˜
async function ensureSmsSheetHeaders() {
  try {
    // SMSê´€ë¦¬ ì‹œíŠ¸ í—¤ë” ì²´í¬ (429 ì—ëŸ¬ ì‹œ ë¬´ì‹œ)
    try {
      const smsResponse = await sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: `${SMS_SHEET_NAME}!A1:I1`,
      });

      if (!smsResponse.data.values || smsResponse.data.values.length === 0) {
        console.log('SMSê´€ë¦¬ ì‹œíŠ¸ í—¤ë” ì¶”ê°€ ì¤‘...');
        await sheets.spreadsheets.values.update({
          spreadsheetId: SPREADSHEET_ID,
          range: `${SMS_SHEET_NAME}!A1:I1`,
          valueInputOption: 'RAW',
          resource: {
            values: [['ID', 'ìˆ˜ì‹ ì¼ì‹œ', 'ë°œì‹ ë²ˆí˜¸', 'ìˆ˜ì‹ ë²ˆí˜¸', 'ë©”ì‹œì§€ë‚´ìš©', 'ì „ë‹¬ìƒíƒœ', 'ì „ë‹¬ì¼ì‹œ', 'ì „ë‹¬ëŒ€ìƒë²ˆí˜¸ë“¤', 'ì²˜ë¦¬ë©”ëª¨']]
          }
        });
      }
    } catch (smsError) {
      if (smsError.code === 429) {
        console.log('âš ï¸ [SMS-HEADER] API í• ë‹¹ëŸ‰ ì´ˆê³¼ - í—¤ë” ì²´í¬ ìŠ¤í‚µ (ì´ë¯¸ ìˆì„ ê°€ëŠ¥ì„± ë†’ìŒ)');
      } else {
        throw smsError;
      }
    }

    // SMSì „ë‹¬ê·œì¹™ ì‹œíŠ¸ í—¤ë” ì²´í¬ (429 ì—ëŸ¬ ì‹œ ë¬´ì‹œ)
    try {
      const rulesResponse = await sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: `${SMS_RULES_SHEET_NAME}!A1:J1`,
      });

      if (!rulesResponse.data.values || rulesResponse.data.values.length === 0) {
        console.log('SMSì „ë‹¬ê·œì¹™ ì‹œíŠ¸ í—¤ë” ì¶”ê°€ ì¤‘...');
        await sheets.spreadsheets.values.update({
          spreadsheetId: SPREADSHEET_ID,
          range: `${SMS_RULES_SHEET_NAME}!A1:K1`,
          valueInputOption: 'RAW',
          resource: {
            values: [['ê·œì¹™ID', 'ê·œì¹™ëª…', 'ìˆ˜ì‹ ë²ˆí˜¸í•„í„°', 'ë°œì‹ ë²ˆí˜¸í•„í„°', 'í‚¤ì›Œë“œí•„í„°', 'ì „ë‹¬ëŒ€ìƒë²ˆí˜¸ë“¤', 'ìë™ì „ë‹¬ì—¬ë¶€', 'í™œì„±í™”ì—¬ë¶€', 'ìƒì„±ì¼ì‹œ', 'ìˆ˜ì •ì¼ì‹œ', 'ë©”ëª¨']]
          }
        });
      }
    } catch (rulesError) {
      if (rulesError.code === 429) {
        console.log('âš ï¸ [SMS-HEADER] API í• ë‹¹ëŸ‰ ì´ˆê³¼ - í—¤ë” ì²´í¬ ìŠ¤í‚µ (ì´ë¯¸ ìˆì„ ê°€ëŠ¥ì„± ë†’ìŒ)');
      } else {
        throw rulesError;
      }
    }

    // SMSì „ë‹¬ì´ë ¥ ì‹œíŠ¸ í—¤ë” ì²´í¬ (429 ì—ëŸ¬ ì‹œ ë¬´ì‹œ)
    try {
      const historyResponse = await sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: `${SMS_HISTORY_SHEET_NAME}!A1:H1`,
      });

      if (!historyResponse.data.values || historyResponse.data.values.length === 0) {
        console.log('SMSì „ë‹¬ì´ë ¥ ì‹œíŠ¸ í—¤ë” ì¶”ê°€ ì¤‘...');
        await sheets.spreadsheets.values.update({
          spreadsheetId: SPREADSHEET_ID,
          range: `${SMS_HISTORY_SHEET_NAME}!A1:H1`,
          valueInputOption: 'RAW',
          resource: {
            values: [['ì´ë ¥ID', 'SMS ID', 'ì „ë‹¬ì¼ì‹œ', 'ì „ë‹¬ë²ˆí˜¸', 'ì „ë‹¬ìƒíƒœ', 'ì˜¤ë¥˜ë©”ì‹œì§€', 'ì²˜ë¦¬ë°©ì‹', 'ê·œì¹™ID']]
          }
        });
      }
    } catch (historyError) {
      if (historyError.code === 429) {
        console.log('âš ï¸ [SMS-HEADER] API í• ë‹¹ëŸ‰ ì´ˆê³¼ - í—¤ë” ì²´í¬ ìŠ¤í‚µ (ì´ë¯¸ ìˆì„ ê°€ëŠ¥ì„± ë†’ìŒ)');
      } else {
        throw historyError;
      }
    }

    console.log('SMS ì‹œíŠ¸ í—¤ë” ì²´í¬ ì™„ë£Œ');
  } catch (error) {
    // 429 ì—ëŸ¬ê°€ ì•„ë‹Œ ê²½ìš°ë§Œ ë¡œê·¸ ì¶œë ¥
    if (error.code !== 429) {
      console.error('SMS ì‹œíŠ¸ í—¤ë” ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
    }
  }
}

// SMS ìˆ˜ì‹  ë°ì´í„° ì¡°íšŒ API
app.get('/api/sms/received', async (req, res) => {
  try {
    const { limit = 100, status = 'all', receiver = '' } = req.query;

    console.log(`SMS ìˆ˜ì‹  ë°ì´í„° ì¡°íšŒ: limit=${limit}, status=${status}, receiver=${receiver}`);

    // ìºì‹œ í‚¤ ìƒì„± (ìƒíƒœì™€ ìˆ˜ì‹ ë²ˆí˜¸ë¡œ êµ¬ë¶„)
    const cacheKey = `${status}_${receiver}`;

    // ìºì‹œ í™•ì¸ (ëŒ€ê¸°ì¤‘ ìƒíƒœë§Œ ìºì‹± - ê°€ì¥ ìì£¼ ì¡°íšŒë¨)
    if (status === 'ëŒ€ê¸°ì¤‘' && receiver) {
      const cached = getCachedData(smsApiCache.pendingForwards, cacheKey);
      if (cached) {
        return res.json({ success: true, data: cached });
      }
    }

    // SMSê´€ë¦¬ ì‹œíŠ¸ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const response = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${SMS_SHEET_NAME}!A:I`,
    });

    const rows = response.data.values || [];
    if (rows.length <= 1) {
      return res.json({ success: true, data: [] });
    }

    // í—¤ë” ì œì™¸í•˜ê³  ë°ì´í„°ë§Œ íŒŒì‹±
    const header = rows[0];
    const dataRows = rows.slice(1);

    // ë°ì´í„°ë¥¼ ê°ì²´ ë°°ì—´ë¡œ ë³€í™˜
    let smsData = dataRows.map(row => ({
      id: row[0] || '',
      receivedAt: row[1] || '',
      sender: row[2] || '',
      receiver: row[3] || '',
      message: row[4] || '',
      forwardStatus: row[5] || 'ëŒ€ê¸°ì¤‘',
      forwardedAt: row[6] || '',
      forwardTargets: row[7] || '',
      memo: row[8] || ''
    }));

    // ìƒíƒœ í•„í„°ë§ (ìƒì„¸ ìƒíƒœë„ ì§€ì›: "ëŒ€ê¸°ì¤‘ (ê·œì¹™: xxx)" â†’ "ëŒ€ê¸°ì¤‘"ìœ¼ë¡œ í•„í„°ë§)
    if (status !== 'all') {
      smsData = smsData.filter(sms => (sms.forwardStatus || '').startsWith(status));
    }

    // ìˆ˜ì‹ ë²ˆí˜¸ í•„í„°ë§ (ì•±ì´ ìê¸° í°ì—ì„œ ë°›ì€ SMSë§Œ ê°€ì ¸ì˜¤ê¸°)
    if (receiver) {
      smsData = smsData.filter(sms => sms.receiver === receiver);
      console.log(`  â†’ ìˆ˜ì‹ ë²ˆí˜¸ í•„í„°ë§ ì ìš©: ${receiver}, ê²°ê³¼: ${smsData.length}ê±´`);
    }

    // ìµœì‹ ìˆœ ì •ë ¬ (ID ë‚´ë¦¼ì°¨ìˆœ)
    smsData.sort((a, b) => parseInt(b.id) - parseInt(a.id));

    // ì œí•œ ì ìš©
    smsData = smsData.slice(0, parseInt(limit));

    // ìºì‹œ ì €ì¥ (ëŒ€ê¸°ì¤‘ ìƒíƒœë§Œ)
    if (status === 'ëŒ€ê¸°ì¤‘' && receiver) {
      setCachedData(smsApiCache.pendingForwards, cacheKey, smsData);
    }

    res.json({ success: true, data: smsData });

  } catch (error) {
    console.error('SMS ìˆ˜ì‹  ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// SMS ì „ë‹¬ ê·œì¹™ ì¡°íšŒ API
app.get('/api/sms/rules', async (req, res) => {
  try {
    console.log('SMS ì „ë‹¬ ê·œì¹™ ì¡°íšŒ');

    const response = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${SMS_RULES_SHEET_NAME}!A:K`,
    });

    const rows = response.data.values || [];
    if (rows.length <= 1) {
      return res.json({ success: true, data: [] });
    }

    const dataRows = rows.slice(1);
    const rules = dataRows.map(row => ({
      id: row[0] || '',
      name: row[1] || '',
      receiverFilter: row[2] || '',
      senderFilter: row[3] || '',
      keywordFilter: row[4] || '',
      targetNumbers: row[5] || '',
      autoForward: row[6] === 'O',
      active: row[7] === 'O',
      createdAt: row[8] || '',
      updatedAt: row[9] || '',
      memo: row[10] || ''
    }));

    res.json({ success: true, data: rules });

  } catch (error) {
    console.error('SMS ì „ë‹¬ ê·œì¹™ ì¡°íšŒ ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// SMS ì „ë‹¬ ê·œì¹™ ì¶”ê°€ API
app.post('/api/sms/rules', async (req, res) => {
  try {
    const { name, receiverFilter, senderFilter, keywordFilter, targetNumbers, autoForward, active, memo } = req.body;

    console.log('SMS ì „ë‹¬ ê·œì¹™ ì¶”ê°€:', name);

    // ê¸°ì¡´ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ID ìƒì„±ìš©)
    const response = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${SMS_RULES_SHEET_NAME}!A:A`,
    });

    const rows = response.data.values || [];
    const newId = rows.length; // í—¤ë” í¬í•¨ì´ë¯€ë¡œ lengthê°€ ê³§ ìƒˆ ID

    const now = new Date().toISOString().replace('T', ' ').substring(0, 19);
    const targetNumbersStr = Array.isArray(targetNumbers) ? targetNumbers.join(',') : targetNumbers;

    const newRow = [
      newId,
      name,
      receiverFilter || '',
      senderFilter || '',
      keywordFilter || '',
      targetNumbersStr,
      autoForward ? 'O' : 'X',
      active ? 'O' : 'X',
      now,
      now,
      memo || ''
    ];

    await sheets.spreadsheets.values.append({
      spreadsheetId: SPREADSHEET_ID,
      range: `${SMS_RULES_SHEET_NAME}!A:K`,
      valueInputOption: 'RAW',
      insertDataOption: 'INSERT_ROWS',
      resource: {
        values: [newRow]
      }
    });

    res.json({ success: true, id: newId });

  } catch (error) {
    console.error('SMS ì „ë‹¬ ê·œì¹™ ì¶”ê°€ ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// SMS ì „ë‹¬ ê·œì¹™ ìˆ˜ì • API
app.put('/api/sms/rules/:id', async (req, res) => {
  try {
    const { id } = req.params;
    const { name, receiverFilter, senderFilter, keywordFilter, targetNumbers, autoForward, active, memo } = req.body;

    console.log(`SMS ì „ë‹¬ ê·œì¹™ ìˆ˜ì •: ID=${id}`);

    // ê¸°ì¡´ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const response = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${SMS_RULES_SHEET_NAME}!A:K`,
    });

    const rows = response.data.values || [];
    const rowIndex = rows.findIndex(row => row[0] === id);

    if (rowIndex === -1) {
      return res.status(404).json({ success: false, error: 'ê·œì¹™ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
    }

    const now = new Date().toISOString().replace('T', ' ').substring(0, 19);
    const targetNumbersStr = Array.isArray(targetNumbers) ? targetNumbers.join(',') : targetNumbers;
    const createdAt = rows[rowIndex][8] || now; // createdAtì€ ì´ì œ 8ë²ˆ ì¸ë±ìŠ¤

    const updatedRow = [
      id,
      name,
      receiverFilter || '',
      senderFilter || '',
      keywordFilter || '',
      targetNumbersStr,
      autoForward ? 'O' : 'X',
      active ? 'O' : 'X',
      createdAt,
      now,
      memo || ''
    ];

    await sheets.spreadsheets.values.update({
      spreadsheetId: SPREADSHEET_ID,
      range: `${SMS_RULES_SHEET_NAME}!A${rowIndex + 1}:K${rowIndex + 1}`,
      valueInputOption: 'RAW',
      resource: {
        values: [updatedRow]
      }
    });

    res.json({ success: true });

  } catch (error) {
    console.error('SMS ì „ë‹¬ ê·œì¹™ ìˆ˜ì • ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// SMS ì „ë‹¬ ê·œì¹™ ì‚­ì œ API
app.delete('/api/sms/rules/:id', async (req, res) => {
  try {
    const { id } = req.params;

    console.log(`SMS ì „ë‹¬ ê·œì¹™ ì‚­ì œ: ID=${id}`);

    // êµ¬ê¸€ ì‹œíŠ¸ëŠ” í–‰ ì‚­ì œê°€ ë³µì¡í•˜ë¯€ë¡œ, í™œì„±í™”ë¥¼ Xë¡œ ë³€ê²½í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ì²˜ë¦¬
    const response = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${SMS_RULES_SHEET_NAME}!A:K`,
    });

    const rows = response.data.values || [];
    const rowIndex = rows.findIndex(row => row[0] === id);

    if (rowIndex === -1) {
      return res.status(404).json({ success: false, error: 'ê·œì¹™ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
    }

    // í™œì„±í™”ë¥¼ Xë¡œ ë³€ê²½
    await sheets.spreadsheets.values.update({
      spreadsheetId: SPREADSHEET_ID,
      range: `${SMS_RULES_SHEET_NAME}!G${rowIndex + 1}`,
      valueInputOption: 'RAW',
      resource: {
        values: [['X']]
      }
    });

    res.json({ success: true });

  } catch (error) {
    console.error('SMS ì „ë‹¬ ê·œì¹™ ì‚­ì œ ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// SMS ì „ë‹¬ ì´ë ¥ ì¡°íšŒ API
app.get('/api/sms/history', async (req, res) => {
  try {
    const { smsId } = req.query;

    console.log(`SMS ì „ë‹¬ ì´ë ¥ ì¡°íšŒ: smsId=${smsId}`);

    const response = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${SMS_HISTORY_SHEET_NAME}!A:H`,
    });

    const rows = response.data.values || [];
    if (rows.length <= 1) {
      return res.json({ success: true, data: [] });
    }

    const dataRows = rows.slice(1);
    let history = dataRows.map(row => ({
      id: row[0] || '',
      smsId: row[1] || '',
      forwardedAt: row[2] || '',
      targetNumber: row[3] || '',
      status: row[4] || '',
      errorMessage: row[5] || '',
      processType: row[6] || '',
      ruleId: row[7] || ''
    }));

    // SMS IDë¡œ í•„í„°ë§
    if (smsId) {
      history = history.filter(h => h.smsId === smsId);
    }

    // ìµœì‹ ìˆœ ì •ë ¬
    history.sort((a, b) => parseInt(b.id) - parseInt(a.id));

    res.json({ success: true, data: history });

  } catch (error) {
    console.error('SMS ì „ë‹¬ ì´ë ¥ ì¡°íšŒ ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// SMS ìˆ˜ë™ ì „ë‹¬ API
app.post('/api/sms/forward', async (req, res) => {
  try {
    const { smsId, targetNumbers, memo } = req.body;

    console.log(`SMS ìˆ˜ë™ ì „ë‹¬: ID=${smsId}, ëŒ€ìƒ=${targetNumbers.length}ê°œ`);

    if (!smsId || !targetNumbers || targetNumbers.length === 0) {
      return res.status(400).json({ success: false, error: 'í•„ìˆ˜ íŒŒë¼ë¯¸í„°ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.' });
    }

    const now = new Date().toISOString().replace('T', ' ').substring(0, 19);

    // ì´ë ¥ ID ìƒì„±ìš©
    const historyResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${SMS_HISTORY_SHEET_NAME}!A:A`,
    });

    let historyId = (historyResponse.data.values || []).length;

    // ê° ëŒ€ìƒ ë²ˆí˜¸ë³„ë¡œ ì´ë ¥ ì¶”ê°€
    const historyRows = [];
    let successCount = 0;

    for (const targetNumber of targetNumbers) {
      const historyRow = [
        historyId++,
        smsId,
        now,
        targetNumber,
        'ì„±ê³µ', // ì‹¤ì œë¡œëŠ” ì „ì†¡ ê²°ê³¼ì— ë”°ë¼ ë‹¬ë¼ì§
        '',
        'ìˆ˜ë™',
        ''
      ];

      historyRows.push(historyRow);
      successCount++;
    }

    // ì´ë ¥ ì‹œíŠ¸ì— ì¶”ê°€
    if (historyRows.length > 0) {
      await sheets.spreadsheets.values.append({
        spreadsheetId: SPREADSHEET_ID,
        range: `${SMS_HISTORY_SHEET_NAME}!A:H`,
        valueInputOption: 'RAW',
        insertDataOption: 'INSERT_ROWS',
        resource: {
          values: historyRows
        }
      });
    }

    // SMSê´€ë¦¬ ì‹œíŠ¸ ì—…ë°ì´íŠ¸
    const smsResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${SMS_SHEET_NAME}!A:I`,
    });

    const smsRows = smsResponse.data.values || [];
    const smsRowIndex = smsRows.findIndex(row => row[0] === smsId);

    if (smsRowIndex !== -1) {
      const forwardStatus = successCount === targetNumbers.length ? 'ì „ë‹¬ì™„ë£Œ' :
        successCount > 0 ? 'ë¶€ë¶„ì‹¤íŒ¨' : 'ì‹¤íŒ¨';
      const targetNumbersStr = targetNumbers.join(',');

      await sheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: `${SMS_SHEET_NAME}!F${smsRowIndex + 1}:I${smsRowIndex + 1}`,
        valueInputOption: 'RAW',
        resource: {
          values: [[forwardStatus, now, targetNumbersStr, memo || '']]
        }
      });
    }

    res.json({
      success: true,
      successCount,
      totalCount: targetNumbers.length
    });

  } catch (error) {
    console.error('SMS ìˆ˜ë™ ì „ë‹¬ ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// ì•ˆë“œë¡œì´ë“œ ì•±ìš© SMS ë“±ë¡ API
app.post('/api/sms/register', async (req, res) => {
  try {
    const { sender, receiver, message, timestamp } = req.body;

    console.log(`SMS ë“±ë¡: ë°œì‹ =${sender}, ìˆ˜ì‹ =${receiver}`);

    if (!sender || !receiver || !message) {
      return res.status(400).json({ success: false, error: 'í•„ìˆ˜ íŒŒë¼ë¯¸í„°ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.' });
    }

    // ì¤‘ë³µ ì²´í¬: ë°œì‹ ë²ˆí˜¸ + ìˆ˜ì‹ ë²ˆí˜¸ + ë©”ì‹œì§€ ë‚´ìš©ìœ¼ë¡œ í™•ì¸
    const existingResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${SMS_SHEET_NAME}!A:E`,
    });

    const existingRows = existingResponse.data.values || [];

    // í—¤ë” ì œì™¸í•˜ê³  ë°ì´í„°ë§Œ
    if (existingRows.length > 1) {
      const dataRows = existingRows.slice(1);

      // ê°™ì€ ë°œì‹ ë²ˆí˜¸, ìˆ˜ì‹ ë²ˆí˜¸, ë©”ì‹œì§€ê°€ ì´ë¯¸ ìˆëŠ”ì§€ í™•ì¸
      const isDuplicate = dataRows.some(row => {
        const existingSender = row[2] || '';
        const existingReceiver = row[3] || '';
        const existingMessage = row[4] || '';

        return existingSender === sender &&
          existingReceiver === receiver &&
          existingMessage === message;
      });

      if (isDuplicate) {
        console.log('âš ï¸ ì¤‘ë³µëœ SMS - ë“±ë¡ ìŠ¤í‚µ');
        return res.json({ success: true, duplicate: true, message: 'ì´ë¯¸ ë“±ë¡ëœ SMSì…ë‹ˆë‹¤.' });
      }
    }

    console.log('âœ… ì¤‘ë³µ ì•„ë‹˜ - ìë™ì‘ë‹µ ë¨¼ì € ì²´í¬...');

    // ============================================
    // ğŸ¤– ìë™ì‘ë‹µ ë¡œì§ (ì „ë‹¬ ê·œì¹™ê³¼ ë…ë¦½ì ìœ¼ë¡œ ë¨¼ì € ì‹¤í–‰)
    // ============================================
    console.log('ğŸ¤– ìë™ì‘ë‹µ ê·œì¹™ í™•ì¸ ì‹œì‘...');
    try {
      // ğŸš« ë£¨í”„ ë°©ì§€ 1: ìë™ì‘ë‹µ í‘œì‹œê°€ í¬í•¨ëœ ë©”ì‹œì§€ëŠ” ì¬ë§¤ì¹­ ê¸ˆì§€
      if ((message || '').includes('[ìë™ì‘ë‹µ]')) {
        console.log('âš ï¸ ìë™ì‘ë‹µ í‘œì‹œê°€ í¬í•¨ëœ ë©”ì‹œì§€ - ìë™ì‘ë‹µ ìŠ¤í‚µ');
      }
      // ğŸš« ë£¨í”„ ë°©ì§€ 2: ìê¸° ìì‹ ì—ê²Œ ë³´ë‚¸ ë©”ì‹œì§€ëŠ” ìë™ì‘ë‹µ ê¸ˆì§€
      else if (sender === receiver) {
        console.log('âš ï¸ ìê¸° ìì‹ ì—ê²Œ ë³´ë‚¸ ë©”ì‹œì§€ - ìë™ì‘ë‹µ ìŠ¤í‚µ');
      }
      else {
        // ========== ìë™ì‘ë‹µ ì²˜ë¦¬ ì‹œì‘ ==========
        // 1. ë°œì‹ ë²ˆí˜¸ê°€ ë“±ë¡ëœ ê±°ë˜ì²˜/ì˜ì—…ì‚¬ì›ì¸ì§€ í™•ì¸
        let isRegistered = false;
        let clientName = '';
        let responsibleSalesPhone = '';

        // 1-1. í°í´ì¶œê³ ì²˜ë°ì´í„°ì—ì„œ í™•ì¸ (W-AAì—´: 22-26)
        const storeCheckResponse = await sheets.spreadsheets.values.get({
          spreadsheetId: SPREADSHEET_ID,
          range: `${STORE_SHEET_NAME}!A:AA`,
        });

        const storeRows = storeCheckResponse.data.values || [];
        const salesPhoneSet = new Set();
        if (storeRows.length > 1) {
          for (const row of storeRows.slice(1)) {
            const storeName = row[14] || '';  // Oì—´(14): ì—…ì²´ëª…
            const salesPerson = row[5] || '';  // Fì—´(5): ë‹´ë‹¹ì ì—°ë½ì²˜
            if (salesPerson) salesPhoneSet.add(salesPerson.trim());

            // W-AAì—´(22-26): íœ´ëŒ€í°ë²ˆí˜¸ 1-5 í™•ì¸
            for (let i = 22; i <= 26; i++) {
              const phone = row[i] || '';
              if (phone && phone.trim() === sender) {
                isRegistered = true;
                clientName = storeName;
                responsibleSalesPhone = salesPerson;
                console.log(`âœ… ì‹œíŠ¸ì—ì„œ ê±°ë˜ì²˜ í™•ì¸: ${clientName} (ë‹´ë‹¹: ${salesPerson})`);
                break;
              }
            }
            if (isRegistered) break;
          }
        }

        // 1-2. SMSìë™ì‘ë‹µê±°ë˜ì²˜ ì‹œíŠ¸ì—ì„œ í™•ì¸ (ì•± ë“±ë¡)
        if (!isRegistered) {
          const contactsCheckResponse = await sheets.spreadsheets.values.get({
            spreadsheetId: SPREADSHEET_ID,
            range: `${SMS_AUTO_REPLY_CONTACTS_SHEET_NAME}!A:H`,
          });

          const contactRows = contactsCheckResponse.data.values || [];

          // ë¨¼ì € ì˜ì—…ì‚¬ì› ë§µ ìƒì„± (ì´ë¦„ â†’ ì—°ë½ì²˜)
          const salesPersonMap = new Map();
          if (contactRows.length > 1) {
            contactRows.slice(1).forEach(row => {
              if (row[1] === 'ì˜ì—…ì‚¬ì›') {
                const salesName = row[3] || ''; // ì´ë¦„
                const salesContact = row[4] || ''; // ì—°ë½ì²˜
                if (salesName && salesContact) {
                  salesPersonMap.set(salesName.trim(), salesContact.trim());
                }
                if (salesContact) {
                  salesPhoneSet.add(salesContact.trim());
                }
              }
            });
          }

          if (contactRows.length > 1) {
            for (const row of contactRows.slice(1)) {
              const contact = row[4] || '';
              if (contact && contact.trim() === sender) {
                isRegistered = true;
                clientName = row[3] || '';
                const salesPersonId = row[2] || '';

                // ë‹´ë‹¹ ì˜ì—…ì‚¬ì› í° ë²ˆí˜¸ ì°¾ê¸°
                if (row[1] === 'ì˜ì—…ì‚¬ì›') {
                  // ìœ í˜•ì´ ì˜ì—…ì‚¬ì›ì´ë©´ ë³¸ì¸ ì—°ë½ì²˜ê°€ ë°œì†¡ ë²ˆí˜¸
                  responsibleSalesPhone = contact;
                } else {
                  // ê±°ë˜ì²˜ë©´ ë‹´ë‹¹ ì˜ì—…ì‚¬ì›ì˜ ì—°ë½ì²˜ ì°¾ê¸°
                  // salesPersonIdê°€ í°ë²ˆí˜¸ í˜•ì‹ì´ë©´ ê·¸ëŒ€ë¡œ, ì•„ë‹ˆë©´ ì´ë¦„ìœ¼ë¡œ ì¡°íšŒ
                  if (salesPersonId && /^0\d{9,10}$/.test(salesPersonId.trim())) {
                    // í°ë²ˆí˜¸ í˜•ì‹
                    responsibleSalesPhone = salesPersonId.trim();
                  } else if (salesPersonId && salesPersonMap.has(salesPersonId.trim())) {
                    // ì´ë¦„ìœ¼ë¡œ ì˜ì—…ì‚¬ì› ì°¾ê¸°
                    responsibleSalesPhone = salesPersonMap.get(salesPersonId.trim());
                    console.log(`âœ… ë‹´ë‹¹ì˜ì—…ì‚¬ì› ì´ë¦„(${salesPersonId})ìœ¼ë¡œ ì—°ë½ì²˜ ì°¾ìŒ: ${responsibleSalesPhone}`);
                  } else {
                    // ëª» ì°¾ìœ¼ë©´ ì¼ë‹¨ ê·¸ëŒ€ë¡œ
                    responsibleSalesPhone = salesPersonId;
                  }
                }

                console.log(`âœ… ì•±ì—ì„œ ë“±ë¡ëœ ì—°ë½ì²˜ í™•ì¸: ${clientName} (ë‹´ë‹¹: ${responsibleSalesPhone})`);
                break;
              }
            }
          }
        }

        // 1-3. ë°œì‹ ìê°€ ë¯¸ë“±ë¡ì´ì–´ë„, ìˆ˜ì‹ ë²ˆí˜¸ê°€ ë“±ë¡ëœ ì˜ì—…ì‚¬ì› í°ì´ë©´ ìë™ì‘ë‹µ í—ˆìš©
        if (!isRegistered && salesPhoneSet.has((receiver || '').trim())) {
          isRegistered = true;
          clientName = 'ë¯¸ë“±ë¡';
          responsibleSalesPhone = (receiver || '').trim();
          console.log(`âœ… ìˆ˜ì‹ ë²ˆí˜¸ê°€ ì˜ì—…ì‚¬ì›í°ì´ë¯€ë¡œ ìë™ì‘ë‹µ í—ˆìš©: ë°œì†¡ë²ˆí˜¸=${responsibleSalesPhone}`);
        }

        // ğŸš« ë£¨í”„ ë°©ì§€ 3: ë¯¸ë“±ë¡ ë²ˆí˜¸ëŠ” ìŠ¤í‚µ
        if (!isRegistered) {
          console.log('ë¯¸ë“±ë¡ ë²ˆí˜¸ - ìë™ì‘ë‹µ ìŠ¤í‚µ:', sender);
        }
        // ğŸš« ë£¨í”„ ë°©ì§€ 4: ë°œì‹ ìê°€ ë°œì†¡ë²ˆí˜¸(ì˜ì—…ì‚¬ì›)ì™€ ê°™ìœ¼ë©´ ìŠ¤í‚µ (ìê¸°ê°€ ë³´ë‚¸ ìë™ì‘ë‹µ ì¬ìˆ˜ì‹ )
        else if (sender === responsibleSalesPhone) {
          console.log('âš ï¸ ë°œì‹ ìê°€ ë°œì†¡ë²ˆí˜¸ì™€ ë™ì¼ - ìë™ì‘ë‹µ ìŠ¤í‚µ (ìê¸° ìì‹ ì—ê²Œ ë³´ë‚¸ ë©”ì‹œì§€):', sender);
        }
        else {
          // ğŸš« ë£¨í”„ ë°©ì§€ 5: ìµœê·¼ 1ë¶„ ë‚´ ê°™ì€ ë°œì‹ ìì—ê²Œ ë‹µë³€í–ˆìœ¼ë©´ ìŠ¤í‚µ (ë©€í‹°íŒŒíŠ¸ ì¬ë§¤ì¹­ ë°©ì§€)
          const historyCheckResponse = await sheets.spreadsheets.values.get({
            spreadsheetId: SPREADSHEET_ID,
            range: `${SMS_AUTO_REPLY_HISTORY_SHEET_NAME}!A:J`,
          });

          const historyRows = historyCheckResponse.data.values || [];
          let hasRecentReply = false;

          if (historyRows.length > 1) {
            const recentHistory = historyRows.slice(1).reverse(); // ìµœì‹ ìˆœ
            const oneMinuteAgo = new Date(Date.now() - 60000).toISOString().replace('T', ' ').substring(0, 19);

            const recentReply = recentHistory.find(row => {
              const historyTime = row[1] || '';
              const historySender = row[2] || '';
              const historySalesPhone = row[7] || '';

              return historyTime > oneMinuteAgo &&
                historySender === sender &&
                historySalesPhone === responsibleSalesPhone;
            });

            if (recentReply) {
              hasRecentReply = true;
              console.log(`âš ï¸ ìµœê·¼ 1ë¶„ ë‚´ ê°™ì€ ë°œì‹ ì(${sender})ì—ê²Œ ë‹µë³€í•¨ - ìë™ì‘ë‹µ ìŠ¤í‚µ (ë©€í‹°íŒŒíŠ¸ ì¬ë§¤ì¹­ ë°©ì§€)`);
            }
          }

          if (!hasRecentReply) {
            // 2. ìë™ì‘ë‹µ ê·œì¹™ í™•ì¸
            const rulesResponse = await sheets.spreadsheets.values.get({
              spreadsheetId: SPREADSHEET_ID,
              range: `${SMS_AUTO_REPLY_RULES_SHEET_NAME}!A:K`,
            });

            const rulesRows = rulesResponse.data.values || [];

            if (rulesRows.length > 1) {
              const rulesData = rulesRows.slice(1);

              // í™œì„±í™”ëœ ê·œì¹™ë§Œ í•„í„°ë§í•˜ê³  ìš°ì„ ìˆœìœ„ ì •ë ¬
              const activeRules = rulesData
                .filter(rule => rule[6] === 'O')
                .sort((a, b) => (parseInt(a[7]) || 999) - (parseInt(b[7]) || 999));

              console.log(`í™œì„±í™”ëœ ìë™ì‘ë‹µ ê·œì¹™: ${activeRules.length}ê°œ`);

              let matchedAutoReplyRule = null;

              // ìš°ì„ ìˆœìœ„ ìˆœìœ¼ë¡œ ê·œì¹™ ì²´í¬
              for (const rule of activeRules) {
                const ruleKeywords = rule[2] || '';
                const keywords = ruleKeywords.split(',').map(k => k.trim()).filter(k => k);

                // í‚¤ì›Œë“œ ë§¤ì¹­
                const hasKeyword = keywords.some(keyword => message.includes(keyword));

                if (hasKeyword) {
                  matchedAutoReplyRule = rule;
                  console.log(`âœ… ìë™ì‘ë‹µ ê·œì¹™ ë§¤ì¹­: ${rule[1]} (ìš°ì„ ìˆœìœ„: ${rule[7]})`);
                  break;
                }
              }

              if (matchedAutoReplyRule) {
                // 3. ë‹µë³€ ìƒì„±
                const ruleName = matchedAutoReplyRule[1];
                const answerType = matchedAutoReplyRule[3] || 'í…œí”Œë¦¿';
                const answerTemplate = matchedAutoReplyRule[4] || '';

                // ë£¨í”„ ë°©ì§€ìš© íƒœê·¸ë¥¼ ì•ì— ë¶€ì°©
                let replyMessage = `[ìë™ì‘ë‹µ] ${answerTemplate}`;

                // TODO: Phase 2ì—ì„œ ì‹¤ì‹œê°„ê°€ê²© ì²˜ë¦¬ ì¶”ê°€

                // 4. ìë™ì‘ë‹µì´ë ¥ì— ê¸°ë¡ (ëŒ€ê¸°ì¤‘ ìƒíƒœ)
                const historyResponse = await sheets.spreadsheets.values.get({
                  spreadsheetId: SPREADSHEET_ID,
                  range: `${SMS_AUTO_REPLY_HISTORY_SHEET_NAME}!A:A`,
                });

                const historyRows = historyResponse.data.values || [];
                const historyId = historyRows.length;
                const now = new Date().toISOString().replace('T', ' ').substring(0, 19);

                const historyRow = [
                  historyId,
                  now,
                  sender,
                  clientName,
                  message, // ë¬¸ì˜ë‚´ìš© ì „ì²´ ì €ì¥
                  ruleName,
                  replyMessage,
                  responsibleSalesPhone,
                  'ëŒ€ê¸°ì¤‘',
                  ''
                ];

                await sheets.spreadsheets.values.append({
                  spreadsheetId: SPREADSHEET_ID,
                  range: `${SMS_AUTO_REPLY_HISTORY_SHEET_NAME}!A:J`,
                  valueInputOption: 'RAW',
                  insertDataOption: 'INSERT_ROWS',
                  resource: {
                    values: [historyRow]
                  }
                });

                console.log(`âœ… ìë™ì‘ë‹µ ì¤€ë¹„ ì™„ë£Œ: ${sender}ì—ê²Œ "${replyMessage.substring(0, 30)}..." ë°œì†¡ ì˜ˆì • (ë°œì†¡ë²ˆí˜¸: ${responsibleSalesPhone})`);
              } else {
                console.log('ë§¤ì¹­ëœ ìë™ì‘ë‹µ ê·œì¹™ ì—†ìŒ');
              }
            }
          } // if (!hasRecentReply)
        } // else (ë£¨í”„ë°©ì§€ 4, 5)
      } // else (ìë™ì‘ë‹µ ì²˜ë¦¬ ì‹œì‘)
    } catch (autoReplyError) {
      console.error('ìë™ì‘ë‹µ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', autoReplyError);
      // ìë™ì‘ë‹µ ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰
    }

    // âš ï¸ ì¤‘ìš”: ë°œì‹ ë²ˆí˜¸ = ìˆ˜ì‹ ë²ˆí˜¸ì¸ ê²½ìš° ë°”ë¡œ ìŠ¤í‚µ (ë¬´í•œ ë£¨í”„ ë°©ì§€)
    if (sender === receiver) {
      console.log('âš ï¸ ìê°€ ì „ì†¡ ê°ì§€ (ë°œì‹ =ìˆ˜ì‹ ) - ì‹œíŠ¸ ì €ì¥ ìŠ¤í‚µ:', sender);
      return res.json({ success: true, skipped: true, reason: 'self-send' });
    }

    // ==================================================
    // ğŸ“‹ 1ë‹¨ê³„: ê·œì¹™ ë§¤ì¹­ ì²´í¬ (ì‹œíŠ¸ ì €ì¥ ì „)
    // ==================================================
    let matchedRule = null;
    let matchedFilters = [];
    let matchInfo = '';

    try {
      // ì „ë‹¬ ê·œì¹™ ì¡°íšŒ
      const rulesResponse = await sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: `${SMS_RULES_SHEET_NAME}!A:K`,
      });

      const rulesRows = rulesResponse.data.values || [];

      if (rulesRows.length > 1) {
        const rulesData = rulesRows.slice(1);

        // í™œì„±í™”ë˜ê³  ìë™ì „ë‹¬ì´ ONì¸ ê·œì¹™ë§Œ í•„í„°ë§
        const activeRules = rulesData.filter(rule => {
          const autoForward = rule[6] === 'O'; // Gì—´: ìë™ì „ë‹¬ì—¬ë¶€
          const active = rule[7] === 'O'; // Hì—´: í™œì„±í™”ì—¬ë¶€
          return autoForward && active;
        });

        console.log(`í™œì„±í™”ëœ ìë™ì „ë‹¬ ê·œì¹™: ${activeRules.length}ê°œ`);

        // ê·œì¹™ì´ ì—†ìœ¼ë©´ ë°”ë¡œ ìŠ¤í‚µ
        if (activeRules.length === 0) {
          console.log('âŒ í™œì„±í™”ëœ ê·œì¹™ ì—†ìŒ - ì‹œíŠ¸ ì €ì¥ ìŠ¤í‚µ');
          return res.json({ success: true, skipped: true, reason: 'no-active-rules' });
        }

        // ê° ê·œì¹™ ì²´í¬ (3ë‹¨ê³„ í•„í„°ë§)
        for (const rule of activeRules) {
          const ruleId = rule[0];
          const ruleName = rule[1];
          const receiverFilter = rule[2] || ''; // Cì—´: ìˆ˜ì‹ ë²ˆí˜¸ í•„í„°
          const senderFilter = rule[3] || '';   // Dì—´: ë°œì‹ ë²ˆí˜¸ í•„í„°
          const keywordFilter = rule[4] || '';  // Eì—´: í‚¤ì›Œë“œ í•„í„°

          let isMatch = true;

          // 1ë‹¨ê³„: ìˆ˜ì‹ ë²ˆí˜¸ í•„í„° ì²´í¬
          if (receiverFilter && !receiver.includes(receiverFilter)) {
            console.log(`  âœ— ìˆ˜ì‹ ë²ˆí˜¸ ë¶ˆì¼ì¹˜: ê·œì¹™=${receiverFilter}, ì‹¤ì œ=${receiver}`);
            isMatch = false;
          }

          // 2ë‹¨ê³„: ë°œì‹ ë²ˆí˜¸ í•„í„° ì²´í¬
          if (isMatch && senderFilter && !sender.includes(senderFilter)) {
            console.log(`  âœ— ë°œì‹ ë²ˆí˜¸ ë¶ˆì¼ì¹˜: ê·œì¹™=${senderFilter}, ì‹¤ì œ=${sender}`);
            isMatch = false;
          }

          // 3ë‹¨ê³„: í‚¤ì›Œë“œ í•„í„° ì²´í¬ (ì‰¼í‘œë¡œ êµ¬ë¶„ëœ í‚¤ì›Œë“œ ì¤‘ í•˜ë‚˜ë¼ë„ í¬í•¨ë˜ë©´ OK)
          if (isMatch && keywordFilter) {
            const keywords = keywordFilter.split(',').map(k => k.trim());
            const hasKeyword = keywords.some(keyword => message.includes(keyword));
            if (!hasKeyword) {
              console.log(`  âœ— í‚¤ì›Œë“œ ë¶ˆì¼ì¹˜: ê·œì¹™=[${keywords.join(',')}], ë©”ì‹œì§€=${message.substring(0, 30)}...`);
              isMatch = false;
            }
          }

          if (isMatch) {
            matchedRule = rule;
            console.log(`âœ… ê·œì¹™ ë§¤ì¹­ ì„±ê³µ: ${ruleName} (ID: ${ruleId})`);
            console.log(`   ìˆ˜ì‹ ë²ˆí˜¸: ${receiver} âœ“`);
            console.log(`   ë°œì‹ ë²ˆí˜¸: ${sender} âœ“`);
            console.log(`   í‚¤ì›Œë“œ: ${keywordFilter || '(í•„í„° ì—†ìŒ)'} âœ“`);

            // ë§¤ì¹­ ì •ë³´ ìˆ˜ì§‘
            if (receiverFilter) matchedFilters.push(`ìˆ˜ì‹ ë²ˆí˜¸:${receiverFilter}`);
            if (senderFilter) matchedFilters.push(`ë°œì‹ ë²ˆí˜¸:${senderFilter}`);
            if (keywordFilter) {
              const keywords = keywordFilter.split(',').map(k => k.trim());
              matchedFilters.push(`í‚¤ì›Œë“œ:${keywords.join(',')}`);
            }
            matchInfo = matchedFilters.length > 0
              ? ` | ì¼ì¹˜: ${matchedFilters.join(', ')}`
              : '';

            break;
          }
        }

        // ë§¤ì¹­ ì‹¤íŒ¨ ì‹œ ë°”ë¡œ ë¦¬í„´ (ì‹œíŠ¸ì— ì €ì¥ ì•ˆ í•¨)
        if (!matchedRule) {
          console.log('âŒ ë§¤ì¹­ëœ ê·œì¹™ ì—†ìŒ - ì‹œíŠ¸ ì €ì¥ ìŠ¤í‚µ');
          return res.json({ success: true, skipped: true, reason: 'no-match' });
        }
      } else {
        console.log('âŒ ê·œì¹™ ì—†ìŒ - ì‹œíŠ¸ ì €ì¥ ìŠ¤í‚µ');
        return res.json({ success: true, skipped: true, reason: 'no-rules' });
      }
    } catch (ruleError) {
      console.error('ê·œì¹™ ì¡°íšŒ ì‹¤íŒ¨:', ruleError);
      return res.json({ success: true, skipped: true, reason: 'rule-check-error' });
    }

    // ==================================================
    // ğŸ“ 2ë‹¨ê³„: ë§¤ì¹­ ì„±ê³µ - ì‹œíŠ¸ì— ì €ì¥
    // ==================================================
    console.log('âœ… ê·œì¹™ ë§¤ì¹­ ì„±ê³µ - ì‹œíŠ¸ì— ì €ì¥ ì‹œì‘');

    // ID ìƒì„±
    const response = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${SMS_SHEET_NAME}!A:A`,
    });

    const newId = (response.data.values || []).length;
    const receivedAt = timestamp || new Date().toISOString().replace('T', ' ').substring(0, 19);

    // ë§¤ì¹­ëœ ê·œì¹™ ì •ë³´ ì¶”ì¶œ
    const ruleId = matchedRule[0];
    const ruleName = matchedRule[1];
    const targetNumbersStr = matchedRule[5] || ''; // Fì—´: ì „ë‹¬ëŒ€ìƒë²ˆí˜¸ë“¤
    const targetNumbers = targetNumbersStr.split(',').map(n => n.trim()).filter(n => n);

    // SMSê´€ë¦¬ ì‹œíŠ¸ì— ì¶”ê°€ (ë°”ë¡œ "ëŒ€ê¸°ì¤‘" ìƒíƒœë¡œ)
    const matchInfoForStatus = matchInfo.replace(/^ \| /, '').trim();
    const newRow = [
      newId,
      receivedAt,
      sender,
      receiver,
      message,
      `ëŒ€ê¸°ì¤‘ (ê·œì¹™: ${ruleName}, ${matchInfoForStatus})`,
      '',
      targetNumbersStr,
      `ìë™ì „ë‹¬ ì¤€ë¹„`
    ];

    await sheets.spreadsheets.values.append({
      spreadsheetId: SPREADSHEET_ID,
      range: `${SMS_SHEET_NAME}!A:I`,
      valueInputOption: 'RAW',
      insertDataOption: 'INSERT_ROWS',
      resource: {
        values: [newRow]
      }
    });

    console.log(`âœ… ì‹œíŠ¸ ì €ì¥ ì™„ë£Œ (ID: ${newId}) - ìë™ ì „ë‹¬ ëŒ€ê¸°ì¤‘`);

    // ==================================================
    // ğŸš€ 3ë‹¨ê³„: ìë™ ì „ë‹¬ ì¤€ë¹„ ì™„ë£Œ
    // ==================================================
    console.log(`âœ… ìë™ ì „ë‹¬ ì¤€ë¹„ ì™„ë£Œ: ${targetNumbers.length}ê°œ ë²ˆí˜¸ (ì•±ì´ ì‹¤ì œ ì „ì†¡í•  ì˜ˆì •)`);

    // ìºì‹œ ë¬´íš¨í™” (ìƒˆ SMS ë“±ë¡ ì‹œ í•´ë‹¹ ìˆ˜ì‹ ë²ˆí˜¸ì˜ ìºì‹œ ì‚­ì œ)
    const cacheKey = `ëŒ€ê¸°ì¤‘_${receiver}`;
    if (smsApiCache.pendingForwards.has(cacheKey)) {
      smsApiCache.pendingForwards.delete(cacheKey);
      console.log(`  ğŸ—‘ï¸ ìºì‹œ ë¬´íš¨í™” (${cacheKey})`);
    }

    res.json({ success: true, id: newId });

  } catch (error) {
    console.error('SMS ë“±ë¡ ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// SMS í†µê³„ API (ì„ íƒ)
app.get('/api/sms/stats', async (req, res) => {
  try {
    console.log('SMS í†µê³„ ì¡°íšŒ');

    const response = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${SMS_SHEET_NAME}!A:I`,
    });

    const rows = response.data.values || [];
    if (rows.length <= 1) {
      return res.json({ success: true, stats: { total: 0, pending: 0, forwarded: 0, failed: 0, receiveOnly: 0 } });
    }

    const dataRows = rows.slice(1);

    const stats = {
      total: dataRows.length,
      pending: dataRows.filter(row => (row[5] || '').startsWith('ëŒ€ê¸°ì¤‘')).length,
      forwarded: dataRows.filter(row => (row[5] || '').startsWith('ì „ë‹¬ì™„ë£Œ')).length,
      failed: dataRows.filter(row => {
        const status = row[5] || '';
        return status.startsWith('ì‹¤íŒ¨') || status.startsWith('ë¶€ë¶„ì‹¤íŒ¨');
      }).length,
      receiveOnly: dataRows.filter(row => (row[5] || '').startsWith('ìˆ˜ì‹ ë§Œ')).length
    };

    res.json({ success: true, stats });

  } catch (error) {
    console.error('SMS í†µê³„ ì¡°íšŒ ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// SMS ì „ë‹¬ ìƒíƒœ ì—…ë°ì´íŠ¸ API (ì•ˆë“œë¡œì´ë“œ ì•±ìš©)
app.post('/api/sms/update-forward-status', async (req, res) => {
  try {
    const { smsId, results } = req.body;

    console.log(`SMS ì „ë‹¬ ìƒíƒœ ì—…ë°ì´íŠ¸: SMS ID=${smsId}, ê²°ê³¼=${results.length}ê°œ`);

    if (!smsId || !results || results.length === 0) {
      return res.status(400).json({ success: false, error: 'í•„ìˆ˜ íŒŒë¼ë¯¸í„°ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.' });
    }

    const now = new Date().toISOString().replace('T', ' ').substring(0, 19);

    // ì´ë ¥ ID ìƒì„±ìš©
    const historyResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${SMS_HISTORY_SHEET_NAME}!A:A`,
    });

    let historyId = (historyResponse.data.values || []).length;

    // ê° ì „ë‹¬ ê²°ê³¼ë³„ë¡œ ì´ë ¥ ì¶”ê°€
    const historyRows = [];
    let successCount = 0;
    let failCount = 0;
    const targetNumbers = [];

    for (const result of results) {
      const historyRow = [
        historyId++,
        smsId,
        now,
        result.targetNumber,
        result.success ? 'ì„±ê³µ' : 'ì‹¤íŒ¨',
        result.errorMessage || '',
        'ì•±ì „ì†¡',
        ''
      ];

      historyRows.push(historyRow);
      targetNumbers.push(result.targetNumber);

      if (result.success) {
        successCount++;
      } else {
        failCount++;
      }
    }

    // ì´ë ¥ ì‹œíŠ¸ì— ì¶”ê°€
    if (historyRows.length > 0) {
      await sheets.spreadsheets.values.append({
        spreadsheetId: SPREADSHEET_ID,
        range: `${SMS_HISTORY_SHEET_NAME}!A:H`,
        valueInputOption: 'RAW',
        insertDataOption: 'INSERT_ROWS',
        resource: {
          values: historyRows
        }
      });
    }

    // SMSê´€ë¦¬ ì‹œíŠ¸ ì—…ë°ì´íŠ¸
    const smsResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${SMS_SHEET_NAME}!A:I`,
    });

    const smsRows = smsResponse.data.values || [];
    const smsRowIndex = smsRows.findIndex(row => row[0] === smsId);

    if (smsRowIndex !== -1) {
      // ì „ë‹¬ìƒíƒœì— ìƒì„¸ ì •ë³´ + ë§¤ì¹­ ì •ë³´ í¬í•¨
      const existingStatus = smsRows[smsRowIndex][5] || ''; // Fì—´: ì „ë‹¬ìƒíƒœ
      const matchInfoRaw = existingStatus.includes('ì¼ì¹˜:')
        ? existingStatus.split('ì¼ì¹˜:')[1].trim()
        : '';
      const matchInfoForStatus = matchInfoRaw ? `, ì¼ì¹˜: ${matchInfoRaw}` : '';
      const forwardStatus = failCount === 0
        ? `ì „ë‹¬ì™„ë£Œ (ì„±ê³µ:${successCount}, ì‹¤íŒ¨:0${matchInfoForStatus})`
        : successCount > 0
          ? `ë¶€ë¶„ì‹¤íŒ¨ (ì„±ê³µ:${successCount}, ì‹¤íŒ¨:${failCount}${matchInfoForStatus})`
          : `ì‹¤íŒ¨ (ì„±ê³µ:0, ì‹¤íŒ¨:${failCount}${matchInfoForStatus})`;
      const targetNumbersStr = targetNumbers.join(',');

      // ì²˜ë¦¬ë©”ëª¨ëŠ” ê°„ë‹¨ ìœ ì§€
      const memo = 'ì „ì†¡ ì™„ë£Œ';

      await sheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: `${SMS_SHEET_NAME}!F${smsRowIndex + 1}:I${smsRowIndex + 1}`,
        valueInputOption: 'RAW',
        resource: {
          values: [[forwardStatus, now, targetNumbersStr, memo]]
        }
      });
    }

    console.log(`âœ… ì „ë‹¬ ìƒíƒœ ì—…ë°ì´íŠ¸ ì™„ë£Œ: ì„±ê³µ=${successCount}, ì‹¤íŒ¨=${failCount}`);

    res.json({
      success: true,
      successCount,
      failCount
    });

  } catch (error) {
    console.error('SMS ì „ë‹¬ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// SMS ë°ì´í„° ì •ë¦¬ API
app.post('/api/sms/cleanup', async (req, res) => {
  try {
    const { days, target } = req.body; // days: ë©°ì¹  ì´ì „ ë°ì´í„° ì‚­ì œ, target: 'sms' | 'history' | 'all'

    console.log(`SMS ë°ì´í„° ì •ë¦¬: ${days}ì¼ ì´ì „, ëŒ€ìƒ=${target}`);

    if (days === undefined || days === null || !target) {
      return res.status(400).json({ success: false, error: 'í•„ìˆ˜ íŒŒë¼ë¯¸í„°ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.' });
    }

    const cutoffDate = new Date();
    cutoffDate.setDate(cutoffDate.getDate() - days);
    const cutoffDateStr = cutoffDate.toISOString().substring(0, 10);

    let deletedCount = 0;

    // daysê°€ 0ì´ë©´ ì „ì²´ ì‚­ì œ
    const isDeleteAll = days === 0;
    console.log(`ì‚­ì œ ëª¨ë“œ: ${isDeleteAll ? 'ì „ì²´ ì‚­ì œ' : `${days}ì¼ ì´ì „ ì‚­ì œ`}`);

    // SMS ë°ì´í„° ì •ë¦¬
    if (target === 'sms' || target === 'all') {
      const response = await sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: `${SMS_SHEET_NAME}!A:I`,
      });

      const rows = response.data.values || [];
      if (rows.length > 1) {
        const header = rows[0];
        const dataRows = rows.slice(1);

        console.log(`SMS ë°ì´í„° ì •ë¦¬ ì „: ${dataRows.length}ê°œ`);

        // ë‚ ì§œê°€ cutoffDate ì´í›„ì¸ ë°ì´í„°ë§Œ ìœ ì§€ (0ì¼ì´ë©´ ëª¨ë‘ ì‚­ì œ)
        const filteredRows = isDeleteAll ? [] : dataRows.filter(row => {
          const receivedAt = row[1] || '';
          const receivedDate = receivedAt.substring(0, 10);
          return receivedDate >= cutoffDateStr;
        });

        deletedCount += dataRows.length - filteredRows.length;
        console.log(`SMS ë°ì´í„° ì •ë¦¬ í›„: ${filteredRows.length}ê°œ, ì‚­ì œ: ${deletedCount}ê°œ`);

        // ì „ì²´ ë²”ìœ„ë¥¼ ë¨¼ì € ë¹ˆ ê°’ìœ¼ë¡œ ë®ì–´ì“°ê¸° (ê¸°ì¡´ ë°ì´í„° ì™„ì „ ì œê±°)
        const totalRows = Math.max(rows.length + 100, 1000); // ì¶©ë¶„íˆ í° ë²”ìœ„
        const emptyRows = Array(totalRows).fill(null).map(() => Array(9).fill(''));

        await sheets.spreadsheets.values.update({
          spreadsheetId: SPREADSHEET_ID,
          range: `${SMS_SHEET_NAME}!A1:I${totalRows}`,
          valueInputOption: 'RAW',
          resource: {
            values: emptyRows
          }
        });

        // í—¤ë” + í•„í„°ë§ëœ ë°ì´í„°ë§Œ ë‹¤ì‹œ ì“°ê¸°
        if (filteredRows.length > 0 || header) {
          await sheets.spreadsheets.values.update({
            spreadsheetId: SPREADSHEET_ID,
            range: `${SMS_SHEET_NAME}!A1:I${filteredRows.length + 1}`,
            valueInputOption: 'RAW',
            resource: {
              values: [header, ...filteredRows]
            }
          });
        } else {
          // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ í—¤ë”ë§Œ
          await sheets.spreadsheets.values.update({
            spreadsheetId: SPREADSHEET_ID,
            range: `${SMS_SHEET_NAME}!A1:I1`,
            valueInputOption: 'RAW',
            resource: {
              values: [header]
            }
          });
        }
      }
    }

    // ì´ë ¥ ë°ì´í„° ì •ë¦¬
    if (target === 'history' || target === 'all') {
      const response = await sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: `${SMS_HISTORY_SHEET_NAME}!A:H`,
      });

      const rows = response.data.values || [];
      if (rows.length > 1) {
        const header = rows[0];
        const dataRows = rows.slice(1);

        console.log(`ì´ë ¥ ë°ì´í„° ì •ë¦¬ ì „: ${dataRows.length}ê°œ`);

        // ë‚ ì§œê°€ cutoffDate ì´í›„ì¸ ë°ì´í„°ë§Œ ìœ ì§€ (0ì¼ì´ë©´ ëª¨ë‘ ì‚­ì œ)
        const filteredRows = isDeleteAll ? [] : dataRows.filter(row => {
          const forwardedAt = row[2] || '';
          const forwardedDate = forwardedAt.substring(0, 10);
          return forwardedDate >= cutoffDateStr;
        });

        const historyDeletedCount = dataRows.length - filteredRows.length;
        deletedCount += historyDeletedCount;
        console.log(`ì´ë ¥ ë°ì´í„° ì •ë¦¬ í›„: ${filteredRows.length}ê°œ, ì‚­ì œ: ${historyDeletedCount}ê°œ`);

        // ì „ì²´ ë²”ìœ„ë¥¼ ë¨¼ì € ë¹ˆ ê°’ìœ¼ë¡œ ë®ì–´ì“°ê¸° (ê¸°ì¡´ ë°ì´í„° ì™„ì „ ì œê±°)
        const totalRows = Math.max(rows.length + 100, 1000); // ì¶©ë¶„íˆ í° ë²”ìœ„
        const emptyRows = Array(totalRows).fill(null).map(() => Array(8).fill(''));

        await sheets.spreadsheets.values.update({
          spreadsheetId: SPREADSHEET_ID,
          range: `${SMS_HISTORY_SHEET_NAME}!A1:H${totalRows}`,
          valueInputOption: 'RAW',
          resource: {
            values: emptyRows
          }
        });

        // í—¤ë” + í•„í„°ë§ëœ ë°ì´í„°ë§Œ ë‹¤ì‹œ ì“°ê¸°
        if (filteredRows.length > 0 || header) {
          await sheets.spreadsheets.values.update({
            spreadsheetId: SPREADSHEET_ID,
            range: `${SMS_HISTORY_SHEET_NAME}!A1:H${filteredRows.length + 1}`,
            valueInputOption: 'RAW',
            resource: {
              values: [header, ...filteredRows]
            }
          });
        } else {
          // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ í—¤ë”ë§Œ
          await sheets.spreadsheets.values.update({
            spreadsheetId: SPREADSHEET_ID,
            range: `${SMS_HISTORY_SHEET_NAME}!A1:H1`,
            valueInputOption: 'RAW',
            resource: {
              values: [header]
            }
          });
        }
      }
    }

    res.json({ success: true, deletedCount });

  } catch (error) {
    console.error('SMS ë°ì´í„° ì •ë¦¬ ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// ============================================
// SMS ìë™ì‘ë‹µ API
// ============================================

// ìë™ì‘ë‹µ ê·œì¹™ ì¡°íšŒ API
app.get('/api/sms/auto-reply/rules', async (req, res) => {
  try {
    console.log('ìë™ì‘ë‹µ ê·œì¹™ ì¡°íšŒ');

    const response = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${SMS_AUTO_REPLY_RULES_SHEET_NAME}!A:K`,
    });

    const rows = response.data.values || [];
    if (rows.length <= 1) {
      return res.json({ success: true, data: [] });
    }

    const dataRows = rows.slice(1);
    const rules = dataRows.map(row => ({
      id: row[0] || '',
      name: row[1] || '',
      keywords: row[2] || '',
      answerType: row[3] || 'í…œí”Œë¦¿',
      answerTemplate: row[4] || '',
      priceConfig: row[5] || '',
      active: row[6] === 'O',
      priority: parseInt(row[7]) || 999,
      createdAt: row[8] || '',
      updatedAt: row[9] || '',
      memo: row[10] || ''
    }));

    res.json({ success: true, data: rules });

  } catch (error) {
    console.error('ìë™ì‘ë‹µ ê·œì¹™ ì¡°íšŒ ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// ìë™ì‘ë‹µ ê·œì¹™ ì¶”ê°€ API
app.post('/api/sms/auto-reply/rules', async (req, res) => {
  try {
    const { name, keywords, answerType, answerTemplate, priceConfig, active, priority, memo } = req.body;

    console.log('ìë™ì‘ë‹µ ê·œì¹™ ì¶”ê°€:', name);

    const response = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${SMS_AUTO_REPLY_RULES_SHEET_NAME}!A:A`,
    });

    const rows = response.data.values || [];
    const newId = rows.length;

    const now = new Date().toISOString().replace('T', ' ').substring(0, 19);

    const newRow = [
      newId,
      name,
      keywords,
      answerType || 'í…œí”Œë¦¿',
      answerTemplate || '',
      priceConfig || '',
      active ? 'O' : 'X',
      priority || 999,
      now,
      now,
      memo || ''
    ];

    await sheets.spreadsheets.values.append({
      spreadsheetId: SPREADSHEET_ID,
      range: `${SMS_AUTO_REPLY_RULES_SHEET_NAME}!A:K`,
      valueInputOption: 'RAW',
      insertDataOption: 'INSERT_ROWS',
      resource: {
        values: [newRow]
      }
    });

    res.json({ success: true, id: newId });

  } catch (error) {
    console.error('ìë™ì‘ë‹µ ê·œì¹™ ì¶”ê°€ ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// ìë™ì‘ë‹µ ê·œì¹™ ìˆ˜ì • API
app.put('/api/sms/auto-reply/rules/:id', async (req, res) => {
  try {
    const { id } = req.params;
    const { name, keywords, answerType, answerTemplate, priceConfig, active, priority, memo } = req.body;

    console.log(`ìë™ì‘ë‹µ ê·œì¹™ ìˆ˜ì •: ID=${id}`);

    const response = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${SMS_AUTO_REPLY_RULES_SHEET_NAME}!A:K`,
    });

    const rows = response.data.values || [];
    const rowIndex = rows.findIndex(row => row[0] === id);

    if (rowIndex === -1) {
      return res.status(404).json({ success: false, error: 'ê·œì¹™ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
    }

    const now = new Date().toISOString().replace('T', ' ').substring(0, 19);
    const createdAt = rows[rowIndex][8] || now;

    const updatedRow = [
      id,
      name,
      keywords,
      answerType || 'í…œí”Œë¦¿',
      answerTemplate || '',
      priceConfig || '',
      active ? 'O' : 'X',
      priority || 999,
      createdAt,
      now,
      memo || ''
    ];

    await sheets.spreadsheets.values.update({
      spreadsheetId: SPREADSHEET_ID,
      range: `${SMS_AUTO_REPLY_RULES_SHEET_NAME}!A${rowIndex + 1}:K${rowIndex + 1}`,
      valueInputOption: 'RAW',
      resource: {
        values: [updatedRow]
      }
    });

    res.json({ success: true });

  } catch (error) {
    console.error('ìë™ì‘ë‹µ ê·œì¹™ ìˆ˜ì • ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// ìë™ì‘ë‹µ ê·œì¹™ ì‚­ì œ API
app.delete('/api/sms/auto-reply/rules/:id', async (req, res) => {
  try {
    const { id } = req.params;

    console.log(`ìë™ì‘ë‹µ ê·œì¹™ ì‚­ì œ: ID=${id}`);

    const response = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${SMS_AUTO_REPLY_RULES_SHEET_NAME}!A:K`,
    });

    const rows = response.data.values || [];
    const rowIndex = rows.findIndex(row => row[0] === id);

    if (rowIndex === -1) {
      return res.status(404).json({ success: false, error: 'ê·œì¹™ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
    }

    // í™œì„±í™”ë¥¼ Xë¡œ ë³€ê²½
    await sheets.spreadsheets.values.update({
      spreadsheetId: SPREADSHEET_ID,
      range: `${SMS_AUTO_REPLY_RULES_SHEET_NAME}!G${rowIndex + 1}`,
      valueInputOption: 'RAW',
      resource: {
        values: [['X']]
      }
    });

    res.json({ success: true });

  } catch (error) {
    console.error('ìë™ì‘ë‹µ ê·œì¹™ ì‚­ì œ ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// ê±°ë˜ì²˜ ì—°ë½ì²˜ ì¡°íšŒ API
app.get('/api/sms/auto-reply/contacts', async (req, res) => {
  try {
    console.log('ìë™ì‘ë‹µ ê±°ë˜ì²˜ ì—°ë½ì²˜ ì¡°íšŒ');

    // 1. í°í´ì¶œê³ ì²˜ë°ì´í„°ì—ì„œ ê±°ë˜ì²˜ ì—°ë½ì²˜ ë¡œë“œ (W-AAì—´: 22-26ì¸ë±ìŠ¤)
    const storeResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${STORE_SHEET_NAME}!A:AA`,
    });

    const storeRows = storeResponse.data.values || [];
    const storeContacts = [];

    if (storeRows.length > 1) {
      storeRows.slice(1).forEach((row, index) => {
        const storeName = row[14] || '';  // Oì—´(14): ì—…ì²´ëª…
        const salesPerson = row[5] || ''; // Fì—´(5): ë‹´ë‹¹ì

        // W-AAì—´(22-26): íœ´ëŒ€í°ë²ˆí˜¸ 1-5
        for (let i = 22; i <= 26; i++) {
          const phone = row[i] || '';
          if (phone && phone.trim()) {
            storeContacts.push({
              id: `store_${index}_${i}`,
              type: 'ê±°ë˜ì²˜',
              salesPersonId: salesPerson,
              name: storeName,
              contact: phone.trim(),
              source: 'ì‹œíŠ¸'
            });
          }
        }
      });
    }

    // 2. SMSìë™ì‘ë‹µê±°ë˜ì²˜ ì‹œíŠ¸ì—ì„œ ì•± ë“±ë¡ ì—°ë½ì²˜ ë¡œë“œ
    const appContactsResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${SMS_AUTO_REPLY_CONTACTS_SHEET_NAME}!A:H`,
    });

    const appRows = appContactsResponse.data.values || [];
    const appContacts = [];

    if (appRows.length > 1) {
      appRows.slice(1).forEach(row => {
        appContacts.push({
          id: row[0] || '',
          type: row[1] || '',
          salesPersonId: row[2] || '',
          name: row[3] || '',
          contact: row[4] || '',
          source: row[5] || 'ì•±',
          createdAt: row[6] || '',
          memo: row[7] || ''
        });
      });
    }

    // 3. í•©ì¹˜ê¸°
    const allContacts = [...storeContacts, ...appContacts];

    res.json({ success: true, data: allContacts });

  } catch (error) {
    console.error('ìë™ì‘ë‹µ ê±°ë˜ì²˜ ì—°ë½ì²˜ ì¡°íšŒ ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// ê±°ë˜ì²˜ ì—°ë½ì²˜ ì¶”ê°€ API (ì•±ì—ì„œ ì¶”ê°€ ë“±ë¡)
app.post('/api/sms/auto-reply/contacts', async (req, res) => {
  try {
    const { type, salesPersonId, name, contact, memo } = req.body;

    console.log('ìë™ì‘ë‹µ ê±°ë˜ì²˜ ì¶”ê°€:', name);

    const response = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${SMS_AUTO_REPLY_CONTACTS_SHEET_NAME}!A:A`,
    });

    const rows = response.data.values || [];
    const newId = rows.length;

    const now = new Date().toISOString().replace('T', ' ').substring(0, 19);

    const newRow = [
      newId,
      type || 'ê±°ë˜ì²˜',
      salesPersonId || '',
      name || '',
      contact || '',
      'ì•±',
      now,
      memo || ''
    ];

    await sheets.spreadsheets.values.append({
      spreadsheetId: SPREADSHEET_ID,
      range: `${SMS_AUTO_REPLY_CONTACTS_SHEET_NAME}!A:H`,
      valueInputOption: 'RAW',
      insertDataOption: 'INSERT_ROWS',
      resource: {
        values: [newRow]
      }
    });

    res.json({ success: true, id: newId });

  } catch (error) {
    console.error('ìë™ì‘ë‹µ ê±°ë˜ì²˜ ì¶”ê°€ ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// ê±°ë˜ì²˜ ì—°ë½ì²˜ ì‚­ì œ API
app.delete('/api/sms/auto-reply/contacts/:id', async (req, res) => {
  try {
    const { id } = req.params;

    console.log(`ìë™ì‘ë‹µ ê±°ë˜ì²˜ ì‚­ì œ: ID=${id}`);

    const response = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${SMS_AUTO_REPLY_CONTACTS_SHEET_NAME}!A:H`,
    });

    const rows = response.data.values || [];
    const rowIndex = rows.findIndex(row => row[0] === id);

    if (rowIndex === -1) {
      return res.status(404).json({ success: false, error: 'ê±°ë˜ì²˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
    }

    // í•´ë‹¹ í–‰ ì‚­ì œ (ë¹ˆ ê°’ìœ¼ë¡œ ë®ì–´ì“°ê¸°)
    await sheets.spreadsheets.values.update({
      spreadsheetId: SPREADSHEET_ID,
      range: `${SMS_AUTO_REPLY_CONTACTS_SHEET_NAME}!A${rowIndex + 1}:H${rowIndex + 1}`,
      valueInputOption: 'RAW',
      resource: {
        values: [['', '', '', '', '', '', '', '']]
      }
    });

    res.json({ success: true });

  } catch (error) {
    console.error('ìë™ì‘ë‹µ ê±°ë˜ì²˜ ì‚­ì œ ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// ìë™ì‘ë‹µ ì´ë ¥ ì¡°íšŒ API
app.get('/api/sms/auto-reply/history', async (req, res) => {
  try {
    const { limit = 100, status = 'all' } = req.query;

    console.log(`ìë™ì‘ë‹µ ì´ë ¥ ì¡°íšŒ: limit=${limit}, status=${status}`);

    const response = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${SMS_AUTO_REPLY_HISTORY_SHEET_NAME}!A:J`,
    });

    const rows = response.data.values || [];
    if (rows.length <= 1) {
      return res.json({ success: true, data: [] });
    }

    const dataRows = rows.slice(1);

    let historyData = dataRows.map(row => ({
      id: row[0] || '',
      receivedAt: row[1] || '',
      sender: row[2] || '',
      clientName: row[3] || '',
      inquiry: row[4] || '',
      matchedRule: row[5] || '',
      reply: row[6] || '',
      senderPhone: row[7] || '',
      status: row[8] || '',
      sentAt: row[9] || ''
    }));

    // ìƒíƒœ í•„í„°ë§
    if (status !== 'all') {
      historyData = historyData.filter(h => (h.status || '').startsWith(status));
    }

    // ìµœì‹ ìˆœ ì •ë ¬
    historyData.sort((a, b) => {
      if (b.receivedAt > a.receivedAt) return 1;
      if (b.receivedAt < a.receivedAt) return -1;
      return 0;
    });

    // ì œí•œ ì ìš©
    historyData = historyData.slice(0, parseInt(limit));

    res.json({ success: true, data: historyData });

  } catch (error) {
    console.error('ìë™ì‘ë‹µ ì´ë ¥ ì¡°íšŒ ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// ìë™ì‘ë‹µ ë°œì†¡ ëŒ€ê¸° ëª©ë¡ API (ì•ˆë“œë¡œì´ë“œ ì•±ìš©)
app.get('/api/sms/auto-reply/pending', async (req, res) => {
  try {
    const { salesPhone } = req.query;

    console.log(`ìë™ì‘ë‹µ ë°œì†¡ ëŒ€ê¸° ëª©ë¡ ì¡°íšŒ: salesPhone=${salesPhone}`);

    // ìºì‹œ í™•ì¸
    if (salesPhone) {
      const cached = getCachedData(smsApiCache.pendingReplies, salesPhone);
      if (cached) {
        return res.json({ success: true, data: cached });
      }
    }

    const response = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${SMS_AUTO_REPLY_HISTORY_SHEET_NAME}!A:J`,
    });

    const rows = response.data.values || [];
    if (rows.length <= 1) {
      return res.json({ success: true, data: [] });
    }

    const dataRows = rows.slice(1);

    // ëŒ€ê¸°ì¤‘ ìƒíƒœì´ê³  ë°œì†¡ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ëŠ” ê²ƒë§Œ í•„í„°ë§
    const pendingReplies = dataRows
      .map((row, index) => ({
        id: row[0] || '',
        sender: row[2] || '',
        reply: row[6] || '',
        senderPhone: row[7] || '',
        status: row[8] || '',
        rowIndex: index + 2
      }))
      .filter(r => r.status === 'ëŒ€ê¸°ì¤‘' && r.senderPhone === salesPhone);

    // ìºì‹œ ì €ì¥
    if (salesPhone) {
      setCachedData(smsApiCache.pendingReplies, salesPhone, pendingReplies);
    }

    res.json({ success: true, data: pendingReplies });

  } catch (error) {
    console.error('ìë™ì‘ë‹µ ë°œì†¡ ëŒ€ê¸° ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// ìë™ì‘ë‹µ ë°œì†¡ ìƒíƒœ ì—…ë°ì´íŠ¸ API (ì•ˆë“œë¡œì´ë“œ ì•±ìš©)
app.post('/api/sms/auto-reply/update-status', async (req, res) => {
  try {
    const { replyId, success, errorMessage } = req.body;

    console.log(`ìë™ì‘ë‹µ ë°œì†¡ ìƒíƒœ ì—…ë°ì´íŠ¸: ID=${replyId}, success=${success}`);

    const response = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${SMS_AUTO_REPLY_HISTORY_SHEET_NAME}!A:J`,
    });

    const rows = response.data.values || [];
    const rowIndex = rows.findIndex(row => row[0] === replyId);

    if (rowIndex === -1) {
      return res.status(404).json({ success: false, error: 'ì´ë ¥ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
    }

    // ë°œì†¡ë²ˆí˜¸ ì¶”ì¶œ (ìºì‹œ ë¬´íš¨í™”ìš©)
    const salesPhone = rows[rowIndex][7] || '';

    const now = new Date().toISOString().replace('T', ' ').substring(0, 19);
    const status = success ? 'ë°œì†¡ì™„ë£Œ' : 'ì‹¤íŒ¨';

    await sheets.spreadsheets.values.update({
      spreadsheetId: SPREADSHEET_ID,
      range: `${SMS_AUTO_REPLY_HISTORY_SHEET_NAME}!I${rowIndex + 1}:J${rowIndex + 1}`,
      valueInputOption: 'RAW',
      resource: {
        values: [[status, now]]
      }
    });

    // ìºì‹œ ë¬´íš¨í™” (ìƒíƒœ ë³€ê²½ ì‹œ í•´ë‹¹ ë°œì†¡ë²ˆí˜¸ì˜ ìºì‹œ ì‚­ì œ)
    if (salesPhone && smsApiCache.pendingReplies.has(salesPhone)) {
      smsApiCache.pendingReplies.delete(salesPhone);
      console.log(`  ğŸ—‘ï¸ ìë™ì‘ë‹µ ìºì‹œ ë¬´íš¨í™” (${salesPhone})`);
    }

    res.json({ success: true });

  } catch (error) {
    console.error('ìë™ì‘ë‹µ ë°œì†¡ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

// ===== í€µë¹„ìš© ê´€ë¦¬ API =====

// ë°ì´í„° ì •ê·œí™” ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
const normalizeCompanyName = (name) => {
  if (!name) return '';
  return name.replace(/\s+/g, '').toLowerCase().trim();
};

const normalizePhoneNumber = (phone) => {
  if (!phone) return '';
  return phone.replace(/[-\s]/g, '').replace(/\D/g, '');
};

const QUICK_COST_MAX_COMPANIES = 5;
const QUICK_COST_COMPANY_FIELD_COUNT = 6;
const QUICK_COST_BASE_COLUMN_COUNT = 8;
const QUICK_COST_TOTAL_COLUMN_COUNT =
  QUICK_COST_BASE_COLUMN_COUNT + QUICK_COST_MAX_COMPANIES * QUICK_COST_COMPANY_FIELD_COUNT;
const QUICK_COST_VALID_SPEEDS = new Set(['ë¹ ë¦„', 'ì¤‘ê°„', 'ëŠë¦¼']);
const SECONDS_IN_DAY = 24 * 60 * 60;
const MILLIS_IN_DAY = SECONDS_IN_DAY * 1000;

const formatDateTimeForSheet = (date) => {
  if (!(date instanceof Date) || Number.isNaN(date.getTime())) {
    return '';
  }
  const pad = (value) => String(value).padStart(2, '0');
  const year = date.getUTCFullYear();
  const month = pad(date.getUTCMonth() + 1);
  const day = pad(date.getUTCDate());
  const hours = pad(date.getUTCHours());
  const minutes = pad(date.getUTCMinutes());
  const seconds = pad(date.getUTCSeconds());
  return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
};

const parseSheetDate = (value) => {
  if (value === null || value === undefined) return null;
  if (value instanceof Date && !Number.isNaN(value.getTime())) {
    return value;
  }

  if (typeof value === 'number' && !Number.isNaN(value)) {
    const excelEpoch = Date.UTC(1899, 11, 30);
    const milliseconds = Math.round(value * 24 * 60 * 60 * 1000);
    const computed = new Date(excelEpoch + milliseconds);
    return Number.isNaN(computed.getTime()) ? null : computed;
  }

  const stringValue = value.toString().trim();
  if (!stringValue) return null;

  const normalized = stringValue
    .replace(/ë…„|\.|\/|ì›”/g, '-')
    .replace(/ì¼/g, '')
    .replace(/\s+/g, ' ')
    .trim();

  const parsed = new Date(normalized);
  if (!Number.isNaN(parsed.getTime())) {
    return parsed;
  }

  const compactMatch = normalized.match(/^(\d{4})(\d{2})(\d{2})/);
  if (compactMatch) {
    const [, yyyy, mm, dd] = compactMatch;
    const compactDate = new Date(`${yyyy}-${mm}-${dd}`);
    return Number.isNaN(compactDate.getTime()) ? null : compactDate;
  }

  return null;
};

const createRegisteredAtResolver = () => {
  let lastKnownDate = null;
  let currentFallback = null;

  return (rawValue, options = {}) => {
    const {
      rowIndex,
      missingRows,
      recordMissing = false,
      updateOnFallback = false
    } = options;

    const trimmed =
      rawValue === null || rawValue === undefined
        ? ''
        : rawValue.toString().trim();

    const parsed = parseSheetDate(trimmed);
    if (parsed) {
      lastKnownDate = parsed;
      currentFallback = parsed;
      return {
        date: parsed,
        label: formatDateTimeForSheet(parsed),
        wasFallback: false
      };
    }

    const fallbackBase = lastKnownDate || currentFallback;
    const fallbackDate = fallbackBase
      ? new Date(fallbackBase.getTime())
      : new Date();
    fallbackDate.setUTCHours(0, 0, 0, 0);
    lastKnownDate = fallbackDate;
    currentFallback = fallbackDate;
    const fallbackLabel = formatDateTimeForSheet(fallbackDate);

    if (
      missingRows &&
      typeof rowIndex === 'number' &&
      ((recordMissing && !trimmed) || updateOnFallback)
    ) {
      missingRows.push({
        rowIndex,
        value: fallbackLabel
      });
    }

    return {
      date: fallbackDate,
      label: fallbackLabel,
      wasFallback: true
    };
  };
};

const getMonthlyTrendInfo = (date) => {
  if (!(date instanceof Date) || Number.isNaN(date.getTime())) {
    return null;
  }
  const year = date.getUTCFullYear();
  const month = date.getUTCMonth();
  const label = `${year}-${String(month + 1).padStart(2, '0')}`;
  const startTimestamp = Date.UTC(year, month, 1);
  const endTimestamp = Date.UTC(year, month + 1, 1) - 1;
  return {
    key: label,
    label,
    displayLabel: `${year}.${String(month + 1).padStart(2, '0')}`,
    startTimestamp,
    endTimestamp
  };
};

const getISOWeekInfo = (date) => {
  const target = new Date(
    Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate())
  );
  let day = target.getUTCDay();
  if (day === 0) day = 7;
  target.setUTCDate(target.getUTCDate() + (4 - day));
  const isoYear = target.getUTCFullYear();

  const isoYearStart = new Date(Date.UTC(isoYear, 0, 1));
  let isoYearStartDay = isoYearStart.getUTCDay();
  if (isoYearStartDay === 0) isoYearStartDay = 7;
  if (isoYearStartDay > 4) {
    isoYearStart.setUTCDate(isoYearStart.getUTCDate() + (8 - isoYearStartDay));
  } else {
    isoYearStart.setUTCDate(isoYearStart.getUTCDate() - (isoYearStartDay - 1));
  }

  const weekNumber =
    Math.floor((target - isoYearStart) / (7 * MILLIS_IN_DAY)) + 1;

  const weekStart = new Date(target);
  weekStart.setUTCDate(target.getUTCDate() - 3);
  weekStart.setUTCHours(0, 0, 0, 0);

  const weekEnd = new Date(weekStart);
  weekEnd.setUTCDate(weekEnd.getUTCDate() + 6);
  weekEnd.setUTCHours(23, 59, 59, 999);

  return { isoYear, weekNumber, weekStart, weekEnd };
};

const getWeeklyTrendInfo = (date) => {
  if (!(date instanceof Date) || Number.isNaN(date.getTime())) {
    return null;
  }
  const { isoYear, weekNumber, weekStart, weekEnd } = getISOWeekInfo(date);
  const label = `${isoYear}-W${String(weekNumber).padStart(2, '0')}`;
  return {
    key: label,
    label,
    displayLabel: `${isoYear}.W${String(weekNumber).padStart(2, '0')}`,
    startTimestamp: weekStart.getTime(),
    endTimestamp: weekEnd.getTime(),
    isoYear,
    weekNumber
  };
};

const ensureTrendBucket = (map, info) => {
  if (!info) return null;
  if (!map.has(info.key)) {
    map.set(info.key, {
      key: info.key,
      label: info.label,
      displayLabel: info.displayLabel,
      startTimestamp: info.startTimestamp,
      endTimestamp: info.endTimestamp,
      isoYear: info.isoYear,
      weekNumber: info.weekNumber,
      entryCount: 0,
      totalCost: 0,
      companyKeys: new Set(),
      totalDistance: 0,
      totalCostWithDistance: 0,
      distanceCount: 0
    });
  }
  return map.get(info.key);
};

const updateTrendBucket = (bucket, costNum, distanceKm, companyKey) => {
  if (!bucket) return;
  bucket.entryCount += 1;
  bucket.totalCost += costNum;
  if (companyKey) {
    bucket.companyKeys.add(companyKey);
  }
  if (typeof distanceKm === 'number') {
    bucket.totalDistance += distanceKm;
    bucket.totalCostWithDistance += costNum;
    bucket.distanceCount += 1;
  }
};

const buildTrendResult = (map, type) => {
  const buckets = Array.from(map.values()).sort(
    (a, b) => (a.startTimestamp || 0) - (b.startTimestamp || 0)
  );

  return buckets.map((bucket) => {
    const averageCost =
      bucket.entryCount > 0
        ? Math.round(bucket.totalCost / bucket.entryCount)
        : null;
    const averageCostPerKm =
      bucket.totalDistance > 0
        ? Math.round(
          (bucket.totalCostWithDistance / bucket.totalDistance) * 10
        ) / 10
        : null;
    const distanceCoverage =
      bucket.entryCount > 0
        ? Math.round((bucket.distanceCount / bucket.entryCount) * 100)
        : 0;

    return {
      type,
      label: bucket.label,
      displayLabel: bucket.displayLabel,
      timestamp: bucket.startTimestamp,
      startTimestamp: bucket.startTimestamp,
      endTimestamp: bucket.endTimestamp,
      entryCount: bucket.entryCount,
      averageCost,
      averageCostPerKm,
      companyCount: bucket.companyKeys.size,
      distanceCoverage
    };
  });
};

const normalizeQuickCostCompanies = (companies = []) => {
  if (!Array.isArray(companies) || companies.length === 0) {
    throw new Error('ì €ì¥í•  ì—…ì²´ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
  }

  if (companies.length > QUICK_COST_MAX_COMPANIES) {
    throw new Error(`ìµœëŒ€ ${QUICK_COST_MAX_COMPANIES}ê°œ ì—…ì²´ê¹Œì§€ë§Œ ë“±ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
  }

  return companies.map((company, index) => {
    const companyNumber = index + 1;
    const originalName = (company?.name || '').toString().trim();
    if (!originalName) {
      throw new Error(`ì—…ì²´${companyNumber}ì˜ ì—…ì²´ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.`);
    }
    if (originalName.length > 50) {
      throw new Error(`ì—…ì²´${companyNumber}ì˜ ì—…ì²´ëª…ì´ ë„ˆë¬´ ê¹ë‹ˆë‹¤. (ìµœëŒ€ 50ì)`);
    }

    const normalizedName = normalizeCompanyName(originalName);
    if (!normalizedName) {
      throw new Error(`ì—…ì²´${companyNumber}ì˜ ì—…ì²´ëª…ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`);
    }

    const originalPhone = (company?.phone || '').toString().trim();
    if (!originalPhone) {
      throw new Error(`ì—…ì²´${companyNumber}ì˜ ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.`);
    }
    const normalizedPhone = normalizePhoneNumber(originalPhone);
    if (!normalizedPhone || normalizedPhone.length < 8) {
      throw new Error(`ì—…ì²´${companyNumber}ì˜ ì „í™”ë²ˆí˜¸ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`);
    }

    const rawCost = (company?.cost !== undefined && company?.cost !== null)
      ? company.cost.toString().replace(/,/g, '').trim()
      : '';
    if (!rawCost) {
      throw new Error(`ì—…ì²´${companyNumber}ì˜ ë¹„ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.`);
    }
    const cost = parseInt(rawCost, 10);
    if (!Number.isInteger(cost) || cost <= 0 || cost > 1_000_000) {
      throw new Error(`ì—…ì²´${companyNumber}ì˜ ë¹„ìš©ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (1ì› ~ 1,000,000ì›)`);
    }

    const dispatchSpeed = (company?.dispatchSpeed || '').toString().trim();
    const pickupSpeed = (company?.pickupSpeed || '').toString().trim();
    const arrivalSpeed = (company?.arrivalSpeed || '').toString().trim();

    if (!QUICK_COST_VALID_SPEEDS.has(dispatchSpeed)) {
      throw new Error(`ì—…ì²´${companyNumber}ì˜ ë°°ì°¨ì†ë„ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (ë¹ ë¦„/ì¤‘ê°„/ëŠë¦¼)`);
    }
    if (!QUICK_COST_VALID_SPEEDS.has(pickupSpeed)) {
      throw new Error(`ì—…ì²´${companyNumber}ì˜ í”½ì—…ì†ë„ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (ë¹ ë¦„/ì¤‘ê°„/ëŠë¦¼)`);
    }
    if (!QUICK_COST_VALID_SPEEDS.has(arrivalSpeed)) {
      throw new Error(`ì—…ì²´${companyNumber}ì˜ ë„ì°©ì†ë„ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (ë¹ ë¦„/ì¤‘ê°„/ëŠë¦¼)`);
    }

    return {
      originalName,
      normalizedName,
      originalPhone,
      normalizedPhone,
      cost,
      dispatchSpeed,
      pickupSpeed,
      arrivalSpeed
    };
  });
};

const buildQuickCostRow = ({
  timestamp,
  registrantStoreName,
  registrantStoreId,
  fromStoreName,
  fromStoreId,
  toStoreName,
  toStoreId,
  modeType,
  companies = []
}) => {
  const row = [
    timestamp || '',
    registrantStoreName || '',
    registrantStoreId || '',
    fromStoreName || '',
    fromStoreId || '',
    toStoreName || '',
    toStoreId || '',
    modeType || ''
  ];

  for (let i = 0; i < QUICK_COST_MAX_COMPANIES; i++) {
    if (i < companies.length) {
      const company = companies[i];
      row.push(
        company.originalName || '',
        company.originalPhone || '',
        company.cost ?? '',
        company.dispatchSpeed || '',
        company.pickupSpeed || '',
        company.arrivalSpeed || ''
      );
    } else {
      row.push('', '', '', '', '', '');
    }
  }

  return row;
};

const buildEmptyQuickCostRow = () =>
  Array.from({ length: QUICK_COST_TOTAL_COLUMN_COUNT }, () => '');

const invalidateQuickCostCache = (fromStoreId, toStoreId, companies = []) => {
  if (fromStoreId && toStoreId) {
    cache.delete(`quick-cost-estimate-${fromStoreId}-${toStoreId}`);
    cache.delete(`quick-cost-estimate-${toStoreId}-${fromStoreId}`);
  }

  cache.delete('quick-cost-companies');
  cache.delete('quick-cost-quality');

  for (const [key] of cache.entries()) {
    if (key.startsWith('quick-cost-statistics-')) {
      cache.delete(key);
    }
  }

  companies.forEach((company) => {
    if (!company) return;
    const nameVariants = new Set();
    if (company.originalName) nameVariants.add(company.originalName);
    if (company.normalizedName) nameVariants.add(company.normalizedName);

    nameVariants.forEach((variant) => {
      cache.delete(`quick-cost-phone-${variant}`);
    });

    nameVariants.forEach((nameVariant) => {
      if (company.originalPhone) {
        cache.delete(`quick-cost-cost-${nameVariant}-${company.originalPhone}`);
      }
      if (company.normalizedPhone) {
        cache.delete(`quick-cost-cost-${nameVariant}-${company.normalizedPhone}`);
      }
    });
  });
};

// í€µë¹„ìš© ë°ì´í„° ì €ì¥ API
app.post('/api/quick-cost/save', async (req, res) => {
  try {
    const {
      registrantStoreName,
      registrantStoreId,
      fromStoreName,
      fromStoreId,
      toStoreName,
      toStoreId,
      modeType,
      companies // ë°°ì—´: [{name, phone, cost, dispatchSpeed, pickupSpeed, arrivalSpeed}, ...]
    } = req.body;

    // ì…ë ¥ê°’ ê²€ì¦
    if (!registrantStoreName || !registrantStoreId || !fromStoreName || !fromStoreId ||
      !toStoreName || !toStoreId || !modeType || !companies || companies.length === 0) {
      return res.status(400).json({
        success: false,
        error: 'í•„ìˆ˜ í•„ë“œê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.'
      });
    }

    // ìµœëŒ€ 5ê°œ ì—…ì²´ê¹Œì§€ë§Œ í—ˆìš©
    if (companies.length > 5) {
      return res.status(400).json({
        success: false,
        error: 'ìµœëŒ€ 5ê°œ ì—…ì²´ê¹Œì§€ë§Œ ë“±ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤.'
      });
    }

    const normalizedCompanies = normalizeQuickCostCompanies(companies);

    // êµ¬ê¸€ì‹œíŠ¸ì— ì €ì¥í•  ë°ì´í„° ì¤€ë¹„
    const now = new Date().toISOString().replace('T', ' ').substring(0, 19);
    const row = buildQuickCostRow({
      timestamp: now,
      registrantStoreName,
      registrantStoreId,
      fromStoreName,
      fromStoreId,
      toStoreName,
      toStoreId,
      modeType,
      companies: normalizedCompanies
    });

    // êµ¬ê¸€ì‹œíŠ¸ì— ì¶”ê°€
    await sheets.spreadsheets.values.append({
      spreadsheetId: SPREADSHEET_ID,
      range: `${QUICK_COST_SHEET_NAME}!A:AL`,
      valueInputOption: 'USER_ENTERED',
      insertDataOption: 'INSERT_ROWS',
      resource: {
        values: [row]
      }
    });

    invalidateQuickCostCache(fromStoreId, toStoreId, normalizedCompanies);

    res.json({
      success: true,
      message: 'í€µë¹„ìš© ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'
    });

  } catch (error) {
    console.error('í€µë¹„ìš© ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:', error);
    res.status(500).json({
      success: false,
      error: error.message || 'í€µë¹„ìš© ë°ì´í„° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
    });
  }
});

// í€µë¹„ìš© ë°ì´í„° ìˆ˜ì • API
app.put('/api/quick-cost/update', async (req, res) => {
  try {
    let {
      rowIndex,
      reverseRowIndex,
      registrantStoreName,
      registrantStoreId,
      fromStoreName,
      fromStoreId,
      toStoreName,
      toStoreId,
      modeType,
      companies
    } = req.body || {};

    const parsedRowIndex = parseInt(rowIndex, 10);
    if (!parsedRowIndex || Number.isNaN(parsedRowIndex) || parsedRowIndex < 2) {
      return res.status(400).json({
        success: false,
        error: 'ìœ íš¨í•œ rowIndexê°€ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }

    const getRowByIndex = async (index) => {
      const response = await sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: `${QUICK_COST_SHEET_NAME}!A${index}:AL${index}`
      });
      return response.data.values?.[0] || null;
    };

    const existingRow = await getRowByIndex(parsedRowIndex);
    if (!existingRow) {
      return res.status(404).json({
        success: false,
        error: 'ìˆ˜ì •í•  ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }

    registrantStoreName = (registrantStoreName || existingRow[1] || '').toString().trim();
    registrantStoreId = (registrantStoreId || existingRow[2] || '').toString().trim();
    fromStoreName = (fromStoreName || existingRow[3] || '').toString().trim();
    fromStoreId = (fromStoreId || existingRow[4] || '').toString().trim();
    toStoreName = (toStoreName || existingRow[5] || '').toString().trim();
    toStoreId = (toStoreId || existingRow[6] || '').toString().trim();
    modeType = (modeType || existingRow[7] || 'ì¼ë°˜ëª¨ë“œ').toString().trim() || 'ì¼ë°˜ëª¨ë“œ';

    const normalizedCompanies = normalizeQuickCostCompanies(companies || []);

    const now = new Date().toISOString().replace('T', ' ').substring(0, 19);
    const updatedRow = buildQuickCostRow({
      timestamp: now,
      registrantStoreName,
      registrantStoreId,
      fromStoreName,
      fromStoreId,
      toStoreName,
      toStoreId,
      modeType,
      companies: normalizedCompanies
    });

    await sheets.spreadsheets.values.update({
      spreadsheetId: SPREADSHEET_ID,
      range: `${QUICK_COST_SHEET_NAME}!A${parsedRowIndex}:AL${parsedRowIndex}`,
      valueInputOption: 'USER_ENTERED',
      resource: {
        values: [updatedRow]
      }
    });

    const updatedRows = [parsedRowIndex];

    const parsedReverseRowIndex = reverseRowIndex
      ? parseInt(reverseRowIndex, 10)
      : null;

    if (parsedReverseRowIndex && !Number.isNaN(parsedReverseRowIndex) && parsedReverseRowIndex >= 2) {
      const reverseRow = await getRowByIndex(parsedReverseRowIndex);

      const reverseFromStoreName = (reverseRow?.[3] || toStoreName).toString().trim();
      const reverseFromStoreId = (reverseRow?.[4] || toStoreId).toString().trim();
      const reverseToStoreName = (reverseRow?.[5] || fromStoreName).toString().trim();
      const reverseToStoreId = (reverseRow?.[6] || fromStoreId).toString().trim();
      const reverseModeType = (reverseRow?.[7] || modeType).toString().trim() || modeType;

      const reverseRowValues = buildQuickCostRow({
        timestamp: now,
        registrantStoreName,
        registrantStoreId,
        fromStoreName: reverseFromStoreName,
        fromStoreId: reverseFromStoreId,
        toStoreName: reverseToStoreName,
        toStoreId: reverseToStoreId,
        modeType: reverseModeType,
        companies: normalizedCompanies
      });

      await sheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: `${QUICK_COST_SHEET_NAME}!A${parsedReverseRowIndex}:AL${parsedReverseRowIndex}`,
        valueInputOption: 'USER_ENTERED',
        resource: {
          values: [reverseRowValues]
        }
      });

      updatedRows.push(parsedReverseRowIndex);
    }

    invalidateQuickCostCache(fromStoreId, toStoreId, normalizedCompanies);

    res.json({
      success: true,
      message: 'í€µë¹„ìš© ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.',
      updatedRows
    });

  } catch (error) {
    console.error('í€µë¹„ìš© ë°ì´í„° ìˆ˜ì • ì‹¤íŒ¨:', error);
    res.status(500).json({
      success: false,
      error: error.message || 'í€µë¹„ìš© ë°ì´í„° ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
    });
  }
});

// í€µë¹„ìš© ë°ì´í„° ì‚­ì œ API
app.delete('/api/quick-cost/delete', async (req, res) => {
  try {
    const { rowIndex, reverseRowIndex } = req.body || {};

    const parsedRowIndex = parseInt(rowIndex, 10);
    if (!parsedRowIndex || Number.isNaN(parsedRowIndex) || parsedRowIndex < 2) {
      return res.status(400).json({
        success: false,
        error: 'ìœ íš¨í•œ rowIndexê°€ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }

    const getRowByIndex = async (index) => {
      const response = await sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: `${QUICK_COST_SHEET_NAME}!A${index}:AL${index}`
      });
      return response.data.values?.[0] || null;
    };

    const existingRow = await getRowByIndex(parsedRowIndex);
    if (!existingRow) {
      return res.status(404).json({
        success: false,
        error: 'ì‚­ì œí•  ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }

    const fromStoreId = (existingRow[4] || '').toString().trim();
    const toStoreId = (existingRow[6] || '').toString().trim();

    await sheets.spreadsheets.values.update({
      spreadsheetId: SPREADSHEET_ID,
      range: `${QUICK_COST_SHEET_NAME}!A${parsedRowIndex}:AL${parsedRowIndex}`,
      valueInputOption: 'USER_ENTERED',
      resource: {
        values: [buildEmptyQuickCostRow()]
      }
    });

    const deletedRows = [parsedRowIndex];

    const parsedReverseRowIndex = reverseRowIndex
      ? parseInt(reverseRowIndex, 10)
      : null;

    if (parsedReverseRowIndex && !Number.isNaN(parsedReverseRowIndex) && parsedReverseRowIndex >= 2) {
      await sheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: `${QUICK_COST_SHEET_NAME}!A${parsedReverseRowIndex}:AL${parsedReverseRowIndex}`,
        valueInputOption: 'USER_ENTERED',
        resource: {
          values: [buildEmptyQuickCostRow()]
        }
      });

      deletedRows.push(parsedReverseRowIndex);
    }

    invalidateQuickCostCache(fromStoreId, toStoreId, []);

    res.json({
      success: true,
      message: 'í€µë¹„ìš© ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.',
      deletedRows
    });

  } catch (error) {
    console.error('í€µë¹„ìš© ë°ì´í„° ì‚­ì œ ì‹¤íŒ¨:', error);
    res.status(500).json({
      success: false,
      error: error.message || 'í€µë¹„ìš© ë°ì´í„° ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
    });
  }
});

// ì˜ˆìƒí€µë¹„ ì¡°íšŒ API
// Quick Cost APIë¥¼ ìœ„í•œ ìš”ì²­ ì¤‘ë³µ ë°©ì§€ ë§µ
const quickCostPendingRequests = new Map();

// Google Sheets API í˜¸ì¶œ ê°„ ìµœì†Œ ê°„ê²© (rate limiting)
let lastQuickCostApiCallTime = 0;
const MIN_QUICK_COST_API_INTERVAL_MS = 1000; // 1ì´ˆ

app.get('/api/quick-cost/estimate', async (req, res) => {
  try {
    const { fromStoreId, toStoreId } = req.query;

    if (!fromStoreId || !toStoreId) {
      return res.status(400).json({
        success: false,
        error: 'ì¶œë°œë§¤ì¥IDì™€ ë„ì°©ë§¤ì¥IDê°€ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }

    // ìºì‹œ í™•ì¸
    const cacheKey = `quick-cost-estimate-${fromStoreId}-${toStoreId}`;
    const cached = cacheUtils.get(cacheKey);
    if (cached) {
      return res.json({ success: true, data: cached });
    }

    // ë™ì‹œ ìš”ì²­ ë°©ì§€: ì´ë¯¸ ì§„í–‰ ì¤‘ì¸ ìš”ì²­ì´ ìˆìœ¼ë©´ ëŒ€ê¸°
    if (quickCostPendingRequests.has(cacheKey)) {
      try {
        const pendingResult = await quickCostPendingRequests.get(cacheKey);
        return res.json({ success: true, data: pendingResult });
      } catch (pendingError) {
        // ëŒ€ê¸° ì¤‘ì¸ ìš”ì²­ì´ ì‹¤íŒ¨í•œ ê²½ìš° ìƒˆë¡œ ì‹œë„
        quickCostPendingRequests.delete(cacheKey);
      }
    }

    // ìƒˆë¡œìš´ ìš”ì²­ ì‹œì‘
    const requestPromise = (async () => {
      try {
        // êµ¬ê¸€ì‹œíŠ¸ì—ì„œ ë°ì´í„° ì¡°íšŒ (429 ì—ëŸ¬ ì¬ì‹œë„ ë¡œì§ í¬í•¨)
        let response;
        const maxRetries = 5; // ì¬ì‹œë„ íšŸìˆ˜ ì¦ê°€ (3 -> 5)
        const baseDelay = 5000; // 5ì´ˆ ê¸°ë³¸ ì§€ì—°

        for (let attempt = 0; attempt < maxRetries; attempt++) {
          try {
            // Rate limiting: ìµœì†Œ ê°„ê²© ìœ ì§€
            const now = Date.now();
            const timeSinceLastCall = now - lastQuickCostApiCallTime;
            if (timeSinceLastCall < MIN_QUICK_COST_API_INTERVAL_MS) {
              await new Promise(resolve => setTimeout(resolve, MIN_QUICK_COST_API_INTERVAL_MS - timeSinceLastCall));
            }
            lastQuickCostApiCallTime = Date.now();

            response = await sheets.spreadsheets.values.get({
              spreadsheetId: SPREADSHEET_ID,
              range: `${QUICK_COST_SHEET_NAME}!A:AL`,
            });
            break; // ì„±ê³µ ì‹œ ë£¨í”„ ì¢…ë£Œ
          } catch (error) {
            // Rate limit ì—ëŸ¬ ê°ì§€ ê°œì„  (ë” ë§ì€ ì¼€ì´ìŠ¤ ì²˜ë¦¬)
            const isRateLimitError =
              error.code === 429 ||
              (error.response && error.response.status === 429) ||
              (error.response && error.response.data && error.response.data.error &&
                (error.response.data.error.status === 'RESOURCE_EXHAUSTED' ||
                  error.response.data.error.message && error.response.data.error.message.includes('Quota exceeded'))) ||
              (error.message && (
                error.message.includes('Quota exceeded') ||
                error.message.includes('RESOURCE_EXHAUSTED') ||
                error.message.includes('429')
              ));

            if (isRateLimitError && attempt < maxRetries - 1) {
              // Exponential backoff with jitter (ëœë¤ ì§€ì—° ì¶”ê°€ë¡œ ë™ì‹œ ìš”ì²­ ë¶„ì‚°)
              const jitter = Math.random() * 2000; // 0~2ì´ˆ ëœë¤
              const delay = baseDelay * Math.pow(2, attempt) + jitter;
              console.warn(`[QuickCost] Rate limit ì—ëŸ¬ ë°œìƒ (ì‹œë„ ${attempt + 1}/${maxRetries}), ${Math.round(delay)}ms í›„ ì¬ì‹œë„`);
              console.warn(`[QuickCost] ì—ëŸ¬ ìƒì„¸:`, {
                code: error.code,
                status: error.response?.status,
                message: error.message,
                errorDetails: error.response?.data?.error
              });
              await new Promise(resolve => setTimeout(resolve, delay));
              continue;
            }
            // Rate limit ì—ëŸ¬ê°€ ì•„ë‹ˆê±°ë‚˜ ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ì— ë„ë‹¬í•˜ë©´ ì—ëŸ¬ throw
            console.error(`[QuickCost] API í˜¸ì¶œ ì‹¤íŒ¨ (ìµœì¢… ì‹œë„ ${attempt + 1}/${maxRetries}):`, {
              code: error.code,
              status: error.response?.status,
              message: error.message,
              errorDetails: error.response?.data?.error
            });
            throw error;
          }
        }

        const rows = response.data.values || [];
        if (rows.length <= 1) {
          // í—¤ë”ë§Œ ìˆëŠ” ê²½ìš°
          const emptyResult = [];
          cacheUtils.set(cacheKey, emptyResult, 5 * 60 * 1000); // 5ë¶„ ìºì‹±
          quickCostPendingRequests.delete(cacheKey);
          return emptyResult;
        }

        // í—¤ë” ì œì™¸í•˜ê³  ë°ì´í„° ì²˜ë¦¬
        const dataRows = rows.slice(1);

        // í•´ë‹¹ ë§¤ì¥ê°„ ë°ì´í„° í•„í„°ë§
        const filteredData = dataRows.filter(row => {
          const rowFromStoreId = row[4]?.toString().trim(); // ì¶œë°œë§¤ì¥ID (Eì—´, ì¸ë±ìŠ¤ 4)
          const rowToStoreId = row[6]?.toString().trim(); // ë„ì°©ë§¤ì¥ID (Gì—´, ì¸ë±ìŠ¤ 6)
          return rowFromStoreId === fromStoreId.toString() && rowToStoreId === toStoreId.toString();
        });

        if (filteredData.length === 0) {
          const emptyResult = [];
          cacheUtils.set(cacheKey, emptyResult, 5 * 60 * 1000); // 5ë¶„ ìºì‹±
          quickCostPendingRequests.delete(cacheKey);
          return emptyResult;
        }

        // ì—…ì²´ë³„ ë°ì´í„° ìˆ˜ì§‘ (ì—…ì²´1~5)
        const companyDataMap = new Map(); // key: normalizedCompanyName-normalizedPhone

        filteredData.forEach(row => {
          // ê° ì—…ì²´ ìŠ¬ë¡¯ ì²˜ë¦¬ (ì—…ì²´1~5)
          for (let i = 0; i < 5; i++) {
            const baseIndex = 8 + (i * 6); // Iì—´ë¶€í„° ì‹œì‘, ê° ì—…ì²´ë‹¹ 6ì—´
            const companyName = row[baseIndex]?.toString().trim();
            const phoneNumber = row[baseIndex + 1]?.toString().trim();
            const cost = row[baseIndex + 2]?.toString().trim();
            const dispatchSpeed = row[baseIndex + 3]?.toString().trim();
            const pickupSpeed = row[baseIndex + 4]?.toString().trim();
            const arrivalSpeed = row[baseIndex + 5]?.toString().trim();

            if (!companyName || !phoneNumber || !cost) continue;

            const normalizedName = normalizeCompanyName(companyName);
            const normalizedPhone = normalizePhoneNumber(phoneNumber);
            const costNum = parseInt(cost);

            if (!normalizedName || !normalizedPhone || isNaN(costNum)) continue;

            const key = `${normalizedName}-${normalizedPhone}`;

            if (!companyDataMap.has(key)) {
              companyDataMap.set(key, {
                companyName: companyName, // ì›ë³¸ ì—…ì²´ëª…
                phoneNumber: phoneNumber, // ì›ë³¸ ì „í™”ë²ˆí˜¸
                normalizedName: normalizedName,
                normalizedPhone: normalizedPhone,
                costs: [],
                dispatchSpeeds: [],
                pickupSpeeds: [],
                arrivalSpeeds: []
              });
            }

            const companyData = companyDataMap.get(key);
            companyData.costs.push(costNum);
            if (dispatchSpeed) companyData.dispatchSpeeds.push(dispatchSpeed);
            if (pickupSpeed) companyData.pickupSpeeds.push(pickupSpeed);
            if (arrivalSpeed) companyData.arrivalSpeeds.push(arrivalSpeed);
          }
        });

        // ì—…ì²´ë³„ í†µê³„ ê³„ì‚°
        const results = Array.from(companyDataMap.values()).map(companyData => {
          const costs = companyData.costs;
          const avgCost = costs.reduce((sum, cost) => sum + cost, 0) / costs.length;

          // ì´ìƒì¹˜ íƒì§€ (í‰ê·  ëŒ€ë¹„ 20% ì´ìƒ ì°¨ì´)
          const threshold = avgCost * 0.2;
          const outliers = costs.filter(cost => Math.abs(cost - avgCost) > threshold);
          const hasOutliers = outliers.length > 0;

          // ì´ìƒì¹˜ ì œì™¸í•œ í‰ê·  ì¬ê³„ì‚°
          const validCosts = costs.filter(cost => Math.abs(cost - avgCost) <= threshold);
          const finalAvgCost = validCosts.length > 0
            ? validCosts.reduce((sum, cost) => sum + cost, 0) / validCosts.length
            : avgCost;

          // ì„œë¹„ìŠ¤ í’ˆì§ˆ ì •ë³´ ê³„ì‚° (ìµœë¹ˆê°’)
          const getMostFrequent = (arr) => {
            if (arr.length === 0) return null;
            const counts = {};
            arr.forEach(item => {
              counts[item] = (counts[item] || 0) + 1;
            });
            return Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
          };

          const dispatchSpeed = getMostFrequent(companyData.dispatchSpeeds) || 'ì¤‘ê°„';
          const pickupSpeed = getMostFrequent(companyData.pickupSpeeds) || 'ì¤‘ê°„';
          const arrivalSpeed = getMostFrequent(companyData.arrivalSpeeds) || 'ì¤‘ê°„';

          return {
            companyName: companyData.companyName,
            phoneNumber: companyData.phoneNumber,
            averageCost: Math.round(finalAvgCost),
            entryCount: costs.length,
            hasOutliers: hasOutliers,
            outlierCount: outliers.length,
            dispatchSpeed: dispatchSpeed,
            pickupSpeed: pickupSpeed,
            arrivalSpeed: arrivalSpeed
          };
        });

        // ê°€ê²© ìˆœìœ¼ë¡œ ì •ë ¬
        results.sort((a, b) => a.averageCost - b.averageCost);

        // ìºì‹± (5ë¶„)
        cacheUtils.set(cacheKey, results, 5 * 60 * 1000);

        // ìš”ì²­ ì™„ë£Œ í›„ ë§µì—ì„œ ì œê±°
        quickCostPendingRequests.delete(cacheKey);

        return results;
      } catch (error) {
        // ì—ëŸ¬ ë°œìƒ ì‹œ ë§µì—ì„œ ì œê±°
        quickCostPendingRequests.delete(cacheKey);
        throw error;
      }
    })();

    // ì§„í–‰ ì¤‘ì¸ ìš”ì²­ì„ ë§µì— ì €ì¥
    quickCostPendingRequests.set(cacheKey, requestPromise);

    // ìš”ì²­ ì™„ë£Œ ëŒ€ê¸° ë° ì‘ë‹µ
    const results = await requestPromise;
    res.json({ success: true, data: results });

  } catch (error) {
    console.error('ì˜ˆìƒí€µë¹„ ì¡°íšŒ ì‹¤íŒ¨:', error);
    res.status(500).json({
      success: false,
      error: error.message || 'ì˜ˆìƒí€µë¹„ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
    });
  }
});

// ì—…ì²´ëª… ëª©ë¡ ì¡°íšŒ API
app.get('/api/quick-cost/companies', async (req, res) => {
  try {
    // ìºì‹œ í™•ì¸
    const cacheKey = 'quick-cost-companies';
    const cached = cacheUtils.get(cacheKey);
    if (cached) {
      return res.json({ success: true, data: cached });
    }

    // êµ¬ê¸€ì‹œíŠ¸ì—ì„œ ë°ì´í„° ì¡°íšŒ
    const response = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${QUICK_COST_SHEET_NAME}!A:AL`,
    });

    const rows = response.data.values || [];
    if (rows.length <= 1) {
      const emptyResult = [];
      cacheUtils.set(cacheKey, emptyResult, 10 * 60 * 1000); // 10ë¶„ ìºì‹±
      return res.json({ success: true, data: emptyResult });
    }

    const dataRows = rows.slice(1);
    const companySet = new Set();

    // ëª¨ë“  ì—…ì²´ëª… ìˆ˜ì§‘ (ì—…ì²´1~5)
    dataRows.forEach(row => {
      for (let i = 0; i < 5; i++) {
        const baseIndex = 8 + (i * 6); // Iì—´ë¶€í„° ì‹œì‘
        const companyName = row[baseIndex]?.toString().trim();
        if (companyName) {
          const normalizedName = normalizeCompanyName(companyName);
          if (normalizedName) {
            companySet.add(companyName); // ì›ë³¸ ì—…ì²´ëª… ì €ì¥
          }
        }
      }
    });

    const companies = Array.from(companySet).sort();
    cacheUtils.set(cacheKey, companies, 10 * 60 * 1000); // 10ë¶„ ìºì‹±

    res.json({ success: true, data: companies });

  } catch (error) {
    console.error('ì—…ì²´ëª… ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
    res.status(500).json({
      success: false,
      error: error.message || 'ì—…ì²´ëª… ëª©ë¡ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
    });
  }
});

// ì „í™”ë²ˆí˜¸ ëª©ë¡ ì¡°íšŒ API
app.get('/api/quick-cost/phone-numbers', async (req, res) => {
  try {
    const { companyName } = req.query;

    if (!companyName) {
      return res.status(400).json({
        success: false,
        error: 'ì—…ì²´ëª…ì´ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }

    const normalizedCompanyName = normalizeCompanyName(companyName);
    const cacheKey = `quick-cost-phone-${normalizedCompanyName}`;

    // ìºì‹œ í™•ì¸
    const cached = cacheUtils.get(cacheKey);
    if (cached) {
      return res.json({ success: true, data: cached });
    }

    // êµ¬ê¸€ì‹œíŠ¸ì—ì„œ ë°ì´í„° ì¡°íšŒ
    const response = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${QUICK_COST_SHEET_NAME}!A:AL`,
    });

    const rows = response.data.values || [];
    if (rows.length <= 1) {
      const emptyResult = [];
      cacheUtils.set(cacheKey, emptyResult, 10 * 60 * 1000);
      return res.json({ success: true, data: emptyResult });
    }

    const dataRows = rows.slice(1);
    const phoneSet = new Set();

    // í•´ë‹¹ ì—…ì²´ëª…ì˜ ì „í™”ë²ˆí˜¸ ìˆ˜ì§‘
    dataRows.forEach(row => {
      for (let i = 0; i < 5; i++) {
        const baseIndex = 8 + (i * 6);
        const rowCompanyName = row[baseIndex]?.toString().trim();
        const phoneNumber = row[baseIndex + 1]?.toString().trim();

        if (rowCompanyName && phoneNumber) {
          const rowNormalizedName = normalizeCompanyName(rowCompanyName);
          if (rowNormalizedName === normalizedCompanyName) {
            phoneSet.add(phoneNumber); // ì›ë³¸ ì „í™”ë²ˆí˜¸ ì €ì¥
          }
        }
      }
    });

    const phones = Array.from(phoneSet).sort();
    cacheUtils.set(cacheKey, phones, 10 * 60 * 1000); // 10ë¶„ ìºì‹±

    res.json({ success: true, data: phones });

  } catch (error) {
    console.error('ì „í™”ë²ˆí˜¸ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
    res.status(500).json({
      success: false,
      error: error.message || 'ì „í™”ë²ˆí˜¸ ëª©ë¡ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
    });
  }
});

// ë¹„ìš© ëª©ë¡ ì¡°íšŒ API
app.get('/api/quick-cost/costs', async (req, res) => {
  try {
    const { companyName, phoneNumber } = req.query;

    if (!companyName || !phoneNumber) {
      return res.status(400).json({
        success: false,
        error: 'ì—…ì²´ëª…ê³¼ ì „í™”ë²ˆí˜¸ê°€ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }

    const normalizedCompanyName = normalizeCompanyName(companyName);
    const normalizedPhone = normalizePhoneNumber(phoneNumber);
    const cacheKey = `quick-cost-cost-${normalizedCompanyName}-${normalizedPhone}`;

    // ìºì‹œ í™•ì¸
    const cached = cacheUtils.get(cacheKey);
    if (cached) {
      return res.json({ success: true, data: cached });
    }

    // êµ¬ê¸€ì‹œíŠ¸ì—ì„œ ë°ì´í„° ì¡°íšŒ
    const response = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${QUICK_COST_SHEET_NAME}!A:AL`,
    });

    const rows = response.data.values || [];
    if (rows.length <= 1) {
      const emptyResult = [];
      cacheUtils.set(cacheKey, emptyResult, 10 * 60 * 1000);
      return res.json({ success: true, data: emptyResult });
    }

    const dataRows = rows.slice(1);
    const costSet = new Set();

    // í•´ë‹¹ ì—…ì²´ëª…+ì „í™”ë²ˆí˜¸ ì¡°í•©ì˜ ë¹„ìš© ìˆ˜ì§‘
    dataRows.forEach(row => {
      for (let i = 0; i < 5; i++) {
        const baseIndex = 8 + (i * 6);
        const rowCompanyName = row[baseIndex]?.toString().trim();
        const rowPhoneNumber = row[baseIndex + 1]?.toString().trim();
        const cost = row[baseIndex + 2]?.toString().trim();

        if (rowCompanyName && rowPhoneNumber && cost) {
          const rowNormalizedName = normalizeCompanyName(rowCompanyName);
          const rowNormalizedPhone = normalizePhoneNumber(rowPhoneNumber);

          if (rowNormalizedName === normalizedCompanyName &&
            rowNormalizedPhone === normalizedPhone) {
            const costNum = parseInt(cost);
            if (!isNaN(costNum)) {
              costSet.add(costNum);
            }
          }
        }
      }
    });

    const costs = Array.from(costSet).sort((a, b) => a - b);
    cacheUtils.set(cacheKey, costs, 10 * 60 * 1000); // 10ë¶„ ìºì‹±

    res.json({ success: true, data: costs });

  } catch (error) {
    console.error('ë¹„ìš© ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
    res.status(500).json({
      success: false,
      error: error.message || 'ë¹„ìš© ëª©ë¡ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
    });
  }
});

// ì‚¬ìš©ì ë“±ë¡ ì´ë ¥ ì¡°íšŒ API
app.get('/api/quick-cost/history', async (req, res) => {
  try {
    const { userId, storeId, fromStoreId, toStoreId, limit } = req.query;

    if (!userId && !storeId && !fromStoreId && !toStoreId) {
      return res.status(400).json({
        success: false,
        error: 'userId, storeId, fromStoreId, toStoreId ì¤‘ ìµœì†Œ í•˜ë‚˜ëŠ” í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }

    const response = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${QUICK_COST_SHEET_NAME}!A:AL`
    });

    const rows = response.data.values || [];
    if (rows.length <= 1) {
      return res.json({ success: true, data: [] });
    }

    const dataRows = rows.slice(1);

    const missingRegisteredAtRows = [];
    const resolveRegisteredAt = createRegisteredAtResolver();

    const entries = dataRows.map((row, index) => {
      const registeredAtInfo = resolveRegisteredAt(row[0], {
        rowIndex: index + 2,
        missingRows: missingRegisteredAtRows,
        recordMissing: true,
        updateOnFallback: true
      });
      const registeredAt = registeredAtInfo.label;
      const registrantStoreName = (row[1] || '').toString().trim();
      const registrantStoreId = (row[2] || '').toString().trim();
      const fromName = (row[3] || '').toString().trim();
      const fromId = (row[4] || '').toString().trim();
      const toName = (row[5] || '').toString().trim();
      const toId = (row[6] || '').toString().trim();
      const mode = (row[7] || '').toString().trim();

      const companies = [];
      for (let i = 0; i < QUICK_COST_MAX_COMPANIES; i++) {
        const baseIndex = QUICK_COST_BASE_COLUMN_COUNT + i * QUICK_COST_COMPANY_FIELD_COUNT;
        const companyName = (row[baseIndex] || '').toString().trim();
        const phone = (row[baseIndex + 1] || '').toString().trim();
        const costRaw = (row[baseIndex + 2] || '').toString().trim();
        if (!companyName || !phone || !costRaw) continue;

        companies.push({
          name: companyName,
          phone,
          cost: parseInt(costRaw, 10) || 0,
          dispatchSpeed: (row[baseIndex + 3] || '').toString().trim(),
          pickupSpeed: (row[baseIndex + 4] || '').toString().trim(),
          arrivalSpeed: (row[baseIndex + 5] || '').toString().trim()
        });
      }

      return {
        rowIndex: index + 2,
        registeredAt,
        registrantStoreName,
        registrantStoreId,
        fromStoreName: fromName,
        fromStoreId: fromId,
        toStoreName: toName,
        toStoreId: toId,
        modeType: mode,
        companies,
        reverseRowIndex: null
      };
    });

    const validEntries = entries.filter(
      (entry) =>
        entry &&
        entry.fromStoreId &&
        entry.toStoreId &&
        entry.companies.length > 0
    );

    if (missingRegisteredAtRows.length > 0) {
      try {
        await sheets.spreadsheets.values.batchUpdate({
          spreadsheetId: SPREADSHEET_ID,
          resource: {
            valueInputOption: 'USER_ENTERED',
            data: missingRegisteredAtRows.map(({ rowIndex, value }) => ({
              range: `${QUICK_COST_SHEET_NAME}!A${rowIndex}`,
              values: [[value]]
            }))
          }
        });
      } catch (timestampError) {
        console.warn(
          '[QuickCost] history registeredAt backfill failed:',
          timestampError?.message || timestampError
        );
      }
    }

    const entryMap = new Map();
    validEntries.forEach((entry) => {
      const key = `${entry.fromStoreId}__${entry.toStoreId}__${entry.registeredAt}__${entry.registrantStoreId}`;
      if (!entryMap.has(key)) {
        entryMap.set(key, []);
      }
      entryMap.get(key).push(entry);
    });

    validEntries.forEach((entry) => {
      const reverseKey = `${entry.toStoreId}__${entry.fromStoreId}__${entry.registeredAt}__${entry.registrantStoreId}`;
      const candidates = entryMap.get(reverseKey);
      if (candidates && candidates.length > 0) {
        const reverse = candidates.find((candidate) => candidate.rowIndex !== entry.rowIndex);
        if (reverse) {
          entry.reverseRowIndex = reverse.rowIndex;
        }
      }
    });

    let filtered = validEntries;

    if (userId) {
      const userIdStr = userId.toString().trim();
      filtered = filtered.filter(
        (entry) =>
          entry.registrantStoreName === userIdStr ||
          entry.registrantStoreId === userIdStr
      );
    }

    if (storeId) {
      const storeIdStr = storeId.toString().trim();
      filtered = filtered.filter(
        (entry) => entry.registrantStoreId === storeIdStr
      );
    }

    if (fromStoreId) {
      const fromIdStr = fromStoreId.toString().trim();
      filtered = filtered.filter((entry) => entry.fromStoreId === fromIdStr);
    }

    if (toStoreId) {
      const toIdStr = toStoreId.toString().trim();
      filtered = filtered.filter((entry) => entry.toStoreId === toIdStr);
    }

    filtered.sort((a, b) => {
      const dateA = new Date(a.registeredAt);
      const dateB = new Date(b.registeredAt);
      if (!Number.isFinite(dateA.getTime()) || !Number.isFinite(dateB.getTime())) {
        return (b.rowIndex || 0) - (a.rowIndex || 0);
      }
      return dateB - dateA;
    });

    const parsedLimit = limit ? parseInt(limit, 10) : null;
    if (parsedLimit && !Number.isNaN(parsedLimit) && parsedLimit > 0) {
      filtered = filtered.slice(0, parsedLimit);
    }

    res.json({ success: true, data: filtered });
  } catch (error) {
    console.error('ë“±ë¡ ì´ë ¥ ì¡°íšŒ ì‹¤íŒ¨:', error);
    res.status(500).json({
      success: false,
      error: error.message || 'ë“±ë¡ ì´ë ¥ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
    });
  }
});

// í†µê³„ ë°ì´í„° ì¡°íšŒ API (ê´€ë¦¬ì ì „ìš©)
app.get('/api/quick-cost/statistics', async (req, res) => {
  try {
    const { region } = req.query;

    // ìºì‹œ í™•ì¸
    const cacheKey = `quick-cost-statistics-${region || 'all'}`;
    const cached = cacheUtils.get(cacheKey);
    if (cached) {
      return res.json({ success: true, data: cached });
    }

    // êµ¬ê¸€ì‹œíŠ¸ì—ì„œ ë°ì´í„° ì¡°íšŒ
    const response = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${QUICK_COST_SHEET_NAME}!A:AL`,
    });

    const rows = response.data.values || [];
    if (rows.length <= 1) {
      const emptyResult = {
        companyStats: [],
        popularCompanies: [],
        excellentCompanies: [],
        distanceCostAnalysis: [],
        timeTrends: { monthly: [], weekly: [] }
      };
      cacheUtils.set(cacheKey, emptyResult, 30 * 60 * 1000);
      return res.json({ success: true, data: emptyResult });
    }

    const dataRows = rows.slice(1);

    // ë§¤ì¥ ë°ì´í„° ì¡°íšŒ (ì§€ì—­ ì •ë³´ í•„ìš”)
    const storeResponse = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${STORE_SHEET_NAME}!A:AG`,
    });

    const storeRows = storeResponse.data.values || [];
    const storeMap = new Map();

    const extractRegionFromAddress = (address = '') => {
      const trimmed = address.trim();
      if (!trimmed) return 'ê¸°íƒ€';

      const normalized = trimmed.replace(/\s+/g, '');

      const cityPatterns = {
        'ìˆ˜ì›ì‹œ': 'ê²½ê¸°', 'ìš©ì¸ì‹œ': 'ê²½ê¸°', 'ì„±ë‚¨ì‹œ': 'ê²½ê¸°', 'ì˜ì •ë¶€ì‹œ': 'ê²½ê¸°',
        'ì•ˆì–‘ì‹œ': 'ê²½ê¸°', 'ë¶€ì²œì‹œ': 'ê²½ê¸°', 'ê³ ì–‘ì‹œ': 'ê²½ê¸°', 'ê³¼ì²œì‹œ': 'ê²½ê¸°',
        'ê´‘ëª…ì‹œ': 'ê²½ê¸°', 'êµ¬ë¦¬ì‹œ': 'ê²½ê¸°', 'ë‚¨ì–‘ì£¼ì‹œ': 'ê²½ê¸°', 'ë™ë‘ì²œì‹œ': 'ê²½ê¸°',
        'ì‹œí¥ì‹œ': 'ê²½ê¸°', 'íŒŒì£¼ì‹œ': 'ê²½ê¸°', 'í‰íƒì‹œ': 'ê²½ê¸°', 'í¬ì²œì‹œ': 'ê²½ê¸°',
        'í•˜ë‚¨ì‹œ': 'ê²½ê¸°', 'êµ°í¬ì‹œ': 'ê²½ê¸°', 'ì˜ì™•ì‹œ': 'ê²½ê¸°', 'ì˜¤ì‚°ì‹œ': 'ê²½ê¸°',
        'ì´ì²œì‹œ': 'ê²½ê¸°', 'ì•ˆì‚°ì‹œ': 'ê²½ê¸°', 'ì–‘ì£¼ì‹œ': 'ê²½ê¸°', 'ì—¬ì£¼ì‹œ': 'ê²½ê¸°',
        'ê¹€í¬ì‹œ': 'ê²½ê¸°', 'í™”ì„±ì‹œ': 'ê²½ê¸°',
        'ì²œì•ˆì‹œ': 'ì¶©ë‚¨', 'ì•„ì‚°ì‹œ': 'ì¶©ë‚¨', 'ê³µì£¼ì‹œ': 'ì¶©ë‚¨', 'ë³´ë ¹ì‹œ': 'ì¶©ë‚¨',
        'ì„œì‚°ì‹œ': 'ì¶©ë‚¨', 'ë…¼ì‚°ì‹œ': 'ì¶©ë‚¨', 'ê³„ë£¡ì‹œ': 'ì¶©ë‚¨', 'ë‹¹ì§„ì‹œ': 'ì¶©ë‚¨',
        'ì¶˜ì²œì‹œ': 'ê°•ì›', 'ì›ì£¼ì‹œ': 'ê°•ì›', 'ê°•ë¦‰ì‹œ': 'ê°•ì›', 'ë™í•´ì‹œ': 'ê°•ì›',
        'íƒœë°±ì‹œ': 'ê°•ì›', 'ì†ì´ˆì‹œ': 'ê°•ì›', 'ì‚¼ì²™ì‹œ': 'ê°•ì›',
        'ì¶©ì£¼ì‹œ': 'ì¶©ë¶', 'ì œì²œì‹œ': 'ì¶©ë¶', 'ì²­ì£¼ì‹œ': 'ì¶©ë¶',
        'ì „ì£¼ì‹œ': 'ì „ë¶', 'êµ°ì‚°ì‹œ': 'ì „ë¶', 'ìµì‚°ì‹œ': 'ì „ë¶', 'ë‚¨ì›ì‹œ': 'ì „ë¶', 'ê¹€ì œì‹œ': 'ì „ë¶',
        'ëª©í¬ì‹œ': 'ì „ë‚¨', 'ì—¬ìˆ˜ì‹œ': 'ì „ë‚¨', 'ìˆœì²œì‹œ': 'ì „ë‚¨', 'ë‚˜ì£¼ì‹œ': 'ì „ë‚¨', 'ê´‘ì–‘ì‹œ': 'ì „ë‚¨',
        'í¬í•­ì‹œ': 'ê²½ë¶', 'ê²½ì£¼ì‹œ': 'ê²½ë¶', 'ì•ˆë™ì‹œ': 'ê²½ë¶', 'ê¹€ì²œì‹œ': 'ê²½ë¶',
        'êµ¬ë¯¸ì‹œ': 'ê²½ë¶', 'ì˜ì£¼ì‹œ': 'ê²½ë¶', 'ì˜ì²œì‹œ': 'ê²½ë¶', 'ìƒì£¼ì‹œ': 'ê²½ë¶',
        'ë¬¸ê²½ì‹œ': 'ê²½ë¶', 'ê²½ì‚°ì‹œ': 'ê²½ë¶',
        'ì°½ì›ì‹œ': 'ê²½ë‚¨', 'ê¹€í•´ì‹œ': 'ê²½ë‚¨', 'ì§„ì£¼ì‹œ': 'ê²½ë‚¨', 'í†µì˜ì‹œ': 'ê²½ë‚¨',
        'ì‚¬ì²œì‹œ': 'ê²½ë‚¨', 'ë°€ì–‘ì‹œ': 'ê²½ë‚¨', 'ê±°ì œì‹œ': 'ê²½ë‚¨', 'ì–‘ì‚°ì‹œ': 'ê²½ë‚¨',
        'ì œì£¼ì‹œ': 'ì œì£¼', 'ì„œê·€í¬ì‹œ': 'ì œì£¼'
      };

      for (const city of Object.keys(cityPatterns)) {
        if (normalized.includes(city)) {
          return city;
        }
      }

      const regionPatterns = {
        'ì„œìš¸': ['ì„œìš¸íŠ¹ë³„ì‹œ', 'ì„œìš¸ì‹œ', 'ì„œìš¸'],
        'ë¶€ì‚°': ['ë¶€ì‚°ê´‘ì—­ì‹œ', 'ë¶€ì‚°ì‹œ', 'ë¶€ì‚°'],
        'ëŒ€êµ¬': ['ëŒ€êµ¬ê´‘ì—­ì‹œ', 'ëŒ€êµ¬ì‹œ', 'ëŒ€êµ¬'],
        'ì¸ì²œ': ['ì¸ì²œê´‘ì—­ì‹œ', 'ì¸ì²œì‹œ', 'ì¸ì²œ'],
        'ê´‘ì£¼': ['ê´‘ì£¼ê´‘ì—­ì‹œ', 'ê´‘ì£¼ì‹œ', 'ê´‘ì£¼'],
        'ëŒ€ì „': ['ëŒ€ì „ê´‘ì—­ì‹œ', 'ëŒ€ì „ì‹œ', 'ëŒ€ì „'],
        'ìš¸ì‚°': ['ìš¸ì‚°ê´‘ì—­ì‹œ', 'ìš¸ì‚°ì‹œ', 'ìš¸ì‚°'],
        'ì„¸ì¢…': ['ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ', 'ì„¸ì¢…ì‹œ', 'ì„¸ì¢…'],
        'ê²½ê¸°': ['ê²½ê¸°ë„', 'ê²½ê¸°'],
        'ê°•ì›': ['ê°•ì›íŠ¹ë³„ìì¹˜ë„', 'ê°•ì›ë„', 'ê°•ì›'],
        'ì¶©ë¶': ['ì¶©ì²­ë¶ë„', 'ì¶©ë¶'],
        'ì¶©ë‚¨': ['ì¶©ì²­ë‚¨ë„', 'ì¶©ë‚¨'],
        'ì „ë¶': ['ì „ë¼ë¶ë„', 'ì „ë¶íŠ¹ë³„ìì¹˜ë„', 'ì „ë¶'],
        'ì „ë‚¨': ['ì „ë¼ë‚¨ë„', 'ì „ë‚¨'],
        'ê²½ë¶': ['ê²½ìƒë¶ë„', 'ê²½ë¶'],
        'ê²½ë‚¨': ['ê²½ìƒë‚¨ë„', 'ê²½ë‚¨'],
        'ì œì£¼': ['ì œì£¼íŠ¹ë³„ìì¹˜ë„', 'ì œì£¼ì‹œ', 'ì œì£¼']
      };

      for (const [regionName, patterns] of Object.entries(regionPatterns)) {
        if (patterns.some(pattern => normalized.includes(pattern))) {
          return regionName;
        }
      }
      const tokens = trimmed.split(/\s+/);
      for (const token of tokens) {
        if (cityPatterns[token]) {
          return token;
        }
      }

      const token = tokens[0];
      if (token && token.length >= 2) {
        const twoChar = token.slice(0, 2);
        if (regionPatterns[twoChar]) return twoChar;
      }
      return 'ê¸°íƒ€';
    };

    if (storeRows.length > 1) {
      storeRows.slice(1).forEach(row => {
        const storeId = row[15]?.toString().trim(); // Pì—´: POSì½”ë“œ
        if (!storeId) return;

        const storeName = row[14]?.toString().trim() || ''; // Oì—´: ë§¤ì¥ëª…
        const addressCandidates = [
          row[32], // AGì—´: ìƒì„¸ ì£¼ì†Œ
          row[11]  // Lì—´: ì˜ˆë¹„ ì£¼ì†Œ
        ];

        const address =
          addressCandidates
            .map((value) => value?.toString().trim())
            .find((value) => value && value !== 'ì£¼ì†Œí™•ì¸í•„ìš”') || '';

        let storeRegion = extractRegionFromAddress(address);
        if (storeRegion === 'ê¸°íƒ€' && storeName) {
          storeRegion = extractRegionFromAddress(storeName);
        }

        const lat = parseFloat(row[8]?.toString() || '');
        const lng = parseFloat(row[9]?.toString() || '');
        const hasValidCoords =
          !Number.isNaN(lat) &&
          !Number.isNaN(lng) &&
          Math.abs(lat) <= 90 &&
          Math.abs(lng) <= 180;

        storeMap.set(storeId, {
          address,
          region: storeRegion,
          name: storeName,
          coordinates: hasValidCoords ? { lat, lng } : null
        });
      });
    }

    // ì—…ì²´ë³„ í†µê³„ ìˆ˜ì§‘
    const companyStatsMap = new Map();
    const regionCompanyMap = new Map(); // ì§€ì—­ë³„ ì—…ì²´ í†µê³„
    const regionMetricsMap = new Map();
    const routeMetrics = [];
    const monthlyTrendMap = new Map();
    const weeklyTrendMap = new Map();
    const missingRegisteredAtRows = [];
    const resolveRegisteredAt = createRegisteredAtResolver();

    dataRows.forEach((row, index) => {
      const registeredAtInfo = resolveRegisteredAt(row[0], {
        rowIndex: index + 2,
        missingRows: missingRegisteredAtRows,
        recordMissing: true,
        updateOnFallback: true
      });
      const monthlyBucketInfo = getMonthlyTrendInfo(registeredAtInfo.date);
      const weeklyBucketInfo = getWeeklyTrendInfo(registeredAtInfo.date);
      row[0] = registeredAtInfo.label;

      const fromStoreId = row[4]?.toString().trim();
      const toStoreId = row[6]?.toString().trim();

      const fromStoreInfo = storeMap.get(fromStoreId);
      const toStoreInfo = storeMap.get(toStoreId);
      let storeRegion = fromStoreInfo?.region || toStoreInfo?.region || 'ê¸°íƒ€';
      if (storeRegion === 'ê¸°íƒ€') {
        const regionCandidates = [
          extractRegionFromAddress(row[3]?.toString() || ''), // fromStoreName
          extractRegionFromAddress(row[5]?.toString() || ''), // toStoreName
          extractRegionFromAddress(fromStoreInfo?.address || ''),
          extractRegionFromAddress(toStoreInfo?.address || '')
        ].filter((value) => value && value !== 'ê¸°íƒ€');
        if (regionCandidates.length > 0) {
          storeRegion = regionCandidates[0];
        }
      }

      // ì§€ì—­ í•„í„°ë§
      if (region && storeRegion !== region) return;

      const fromCoords = fromStoreInfo?.coordinates;
      const toCoords = toStoreInfo?.coordinates;
      let distanceKm = null;
      if (fromCoords && toCoords) {
        distanceKm = calculateDistance(fromCoords.lat, fromCoords.lng, toCoords.lat, toCoords.lng);
      }

      for (let i = 0; i < 5; i++) {
        const baseIndex = 8 + i * 6;
        const companyName = row[baseIndex]?.toString().trim();
        const phoneNumber = row[baseIndex + 1]?.toString().trim();
        const cost = row[baseIndex + 2]?.toString().trim();
        const dispatchSpeed = row[baseIndex + 3]?.toString().trim();
        const pickupSpeed = row[baseIndex + 4]?.toString().trim();
        const arrivalSpeed = row[baseIndex + 5]?.toString().trim();

        if (!companyName || !phoneNumber || !cost) continue;

        const normalizedName = normalizeCompanyName(companyName);
        const normalizedPhone = normalizePhoneNumber(phoneNumber);
        const key = `${normalizedName}-${normalizedPhone}`;
        const costNum = parseInt(cost);

        if (!companyStatsMap.has(key)) {
          companyStatsMap.set(key, {
            companyName: companyName,
            phoneNumber: phoneNumber,
            costs: [],
            speeds: { dispatch: [], pickup: [], arrival: [] },
            entryCount: 0
          });
        }

        const stats = companyStatsMap.get(key);
        stats.costs.push(costNum);
        if (dispatchSpeed) stats.speeds.dispatch.push(dispatchSpeed);
        if (pickupSpeed) stats.speeds.pickup.push(pickupSpeed);
        if (arrivalSpeed) stats.speeds.arrival.push(arrivalSpeed);
        stats.entryCount++;

        if (typeof distanceKm === 'number') {
          stats.routeDistances = stats.routeDistances || [];
          stats.routeDistances.push(distanceKm);
          stats.routeCosts = stats.routeCosts || [];
          stats.routeCosts.push(costNum);
          routeMetrics.push({
            region: storeRegion,
            distance: distanceKm,
            cost: costNum
          });
        }

        if (!regionMetricsMap.has(storeRegion)) {
          regionMetricsMap.set(storeRegion, {
            region: storeRegion,
            totalEntries: 0,
            totalCost: 0,
            companyKeys: new Set(),
            totalDistance: 0,
            totalCostWithDistance: 0,
            distanceCount: 0
          });
        }
        const regionMetric = regionMetricsMap.get(storeRegion);
        regionMetric.totalEntries += 1;
        regionMetric.totalCost += costNum;
        regionMetric.companyKeys.add(key);
        if (typeof distanceKm === 'number') {
          regionMetric.totalDistance += distanceKm;
          regionMetric.totalCostWithDistance += costNum;
          regionMetric.distanceCount += 1;
        }

        updateTrendBucket(
          ensureTrendBucket(monthlyTrendMap, monthlyBucketInfo),
          costNum,
          distanceKm,
          key
        );
        updateTrendBucket(
          ensureTrendBucket(weeklyTrendMap, weeklyBucketInfo),
          costNum,
          distanceKm,
          key
        );

        // ì§€ì—­ë³„ í†µê³„
        const regionKey = `${storeRegion}-${key}`;
        if (!regionCompanyMap.has(regionKey)) {
          regionCompanyMap.set(regionKey, {
            region: storeRegion,
            companyName: companyName,
            phoneNumber: phoneNumber,
            entryCount: 0,
            speeds: { dispatch: [], pickup: [], arrival: [] }
          });
        }
        const regionStats = regionCompanyMap.get(regionKey);
        regionStats.entryCount++;
        if (dispatchSpeed) regionStats.speeds.dispatch.push(dispatchSpeed);
        if (pickupSpeed) regionStats.speeds.pickup.push(pickupSpeed);
        if (arrivalSpeed) regionStats.speeds.arrival.push(arrivalSpeed);
      }
    });

    // ì—…ì²´ë³„ í†µê³„ ê³„ì‚°
    const companyStats = Array.from(companyStatsMap.values()).map(stats => {
      const avgCost = stats.costs.reduce((sum, cost) => sum + cost, 0) / stats.costs.length;
      const variance = stats.costs.reduce((sum, cost) => sum + Math.pow(cost - avgCost, 2), 0) / stats.costs.length;
      const stdDev = Math.sqrt(variance);

      // ì†ë„ ì ìˆ˜ ê³„ì‚° (ë¹ ë¦„=3, ì¤‘ê°„=2, ëŠë¦¼=1)
      const getSpeedScore = (speed) => {
        if (speed === 'ë¹ ë¦„') return 3;
        if (speed === 'ì¤‘ê°„') return 2;
        return 1;
      };

      const getMostFrequent = (arr) => {
        if (arr.length === 0) return 'ì¤‘ê°„';
        const counts = {};
        arr.forEach(item => { counts[item] = (counts[item] || 0) + 1; });
        return Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
      };

      const avgDispatchSpeed = getMostFrequent(stats.speeds.dispatch);
      const avgPickupSpeed = getMostFrequent(stats.speeds.pickup);
      const avgArrivalSpeed = getMostFrequent(stats.speeds.arrival);

      const avgSpeedScore = (
        getSpeedScore(avgDispatchSpeed) +
        getSpeedScore(avgPickupSpeed) +
        getSpeedScore(avgArrivalSpeed)
      ) / 3;

      // ì‹ ë¢°ë„ ì ìˆ˜ ê³„ì‚° (0~100)
      const entryScore = Math.min(stats.entryCount * 10, 50); // ìµœëŒ€ 50ì 
      const consistencyScore = Math.max(0, 50 - (stdDev / avgCost) * 100); // ìµœëŒ€ 50ì 
      const reliabilityScore = Math.round(entryScore + consistencyScore);

      let averageDistance = null;
      let averageCostPerKm = null;
      if (stats.routeDistances?.length) {
        const totalDistance = stats.routeDistances.reduce((sum, value) => sum + value, 0);
        averageDistance = Math.round((totalDistance / stats.routeDistances.length) * 10) / 10;
        const totalCost = stats.routeCosts?.reduce((sum, value) => sum + value, 0) || 0;
        if (averageDistance > 0 && totalCost > 0) {
          averageCostPerKm = Math.round((totalCost / stats.routeDistances.length) / (averageDistance || 1));
        }
      }

      return {
        companyName: stats.companyName,
        phoneNumber: stats.phoneNumber,
        averageCost: Math.round(avgCost),
        averageSpeedScore: Math.round(avgSpeedScore * 100) / 100,
        entryCount: stats.entryCount,
        reliabilityScore: reliabilityScore,
        dispatchSpeed: avgDispatchSpeed,
        pickupSpeed: avgPickupSpeed,
        arrivalSpeed: avgArrivalSpeed,
        averageDistance,
        averageCostPerKm
      };
    });

    // ì§€ì—­ë³„ ì¸ê¸° ì—…ì²´ ìˆœìœ„ (ë“±ë¡ ê±´ìˆ˜ ê¸°ì¤€)
    const popularCompanies = Array.from(regionCompanyMap.values())
      .sort((a, b) => b.entryCount - a.entryCount)
      .slice(0, 20)
      .map(stats => ({
        region: stats.region,
        companyName: stats.companyName,
        phoneNumber: stats.phoneNumber,
        entryCount: stats.entryCount
      }));

    // ì§€ì—­ë³„ ìš°ìˆ˜ ì—…ì²´ ìˆœìœ„ (í‰ê·  ì†ë„ ì ìˆ˜ ê¸°ì¤€)
    const excellentCompanies = Array.from(regionCompanyMap.values())
      .map(stats => {
        const getSpeedScore = (speed) => {
          if (speed === 'ë¹ ë¦„') return 3;
          if (speed === 'ì¤‘ê°„') return 2;
          return 1;
        };
        const getMostFrequent = (arr) => {
          if (arr.length === 0) return 'ì¤‘ê°„';
          const counts = {};
          arr.forEach(item => { counts[item] = (counts[item] || 0) + 1; });
          return Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
        };
        const avgSpeedScore = (
          getSpeedScore(getMostFrequent(stats.speeds.dispatch)) +
          getSpeedScore(getMostFrequent(stats.speeds.pickup)) +
          getSpeedScore(getMostFrequent(stats.speeds.arrival))
        ) / 3;
        return {
          region: stats.region,
          companyName: stats.companyName,
          phoneNumber: stats.phoneNumber,
          averageSpeedScore: Math.round(avgSpeedScore * 100) / 100,
          entryCount: stats.entryCount
        };
      })
      .sort((a, b) => b.averageSpeedScore - a.averageSpeedScore)
      .slice(0, 20);

    const regionAggregates = Array.from(regionMetricsMap.values()).map(
      (metrics) => {
        const averageCost =
          metrics.totalEntries > 0
            ? Math.round(metrics.totalCost / metrics.totalEntries)
            : null;
        const averageDistance =
          metrics.distanceCount > 0
            ? Math.round(
              (metrics.totalDistance / metrics.distanceCount) * 10
            ) / 10
            : null;
        const averageCostPerKm =
          metrics.totalDistance > 0
            ? Math.round(
              (metrics.totalCostWithDistance / metrics.totalDistance) * 10
            ) / 10
            : null;
        const distanceCoverage =
          metrics.totalEntries > 0
            ? Math.round((metrics.distanceCount / metrics.totalEntries) * 100)
            : 0;

        return {
          region: metrics.region,
          totalEntries: metrics.totalEntries,
          companyCount: metrics.companyKeys.size,
          averageCost,
          averageDistance,
          averageCostPerKm,
          distanceCoverage
        };
      }
    );

    const distanceBucketDefinitions = [
      { label: '0~5km', min: 0, max: 5 },
      { label: '5~10km', min: 5, max: 10 },
      { label: '10~20km', min: 10, max: 20 },
      { label: '20~50km', min: 20, max: 50 },
      { label: '50~100km', min: 50, max: 100 },
      { label: '100km ì´ìƒ', min: 100, max: Infinity }
    ];

    const distanceBucketStats = distanceBucketDefinitions.map(() => ({
      count: 0,
      totalCost: 0,
      totalDistance: 0
    }));

    routeMetrics.forEach((route) => {
      const { distance, cost } = route;
      const bucketIndex = distanceBucketDefinitions.findIndex(
        (bucket) => distance >= bucket.min && distance < bucket.max
      );
      if (bucketIndex === -1) return;
      const bucket = distanceBucketStats[bucketIndex];
      bucket.count += 1;
      bucket.totalCost += cost;
      bucket.totalDistance += distance;
    });

    const distanceCostAnalysis = distanceBucketDefinitions.map(
      (bucket, index) => {
        const stats = distanceBucketStats[index];
        if (stats.count === 0) {
          return {
            label: bucket.label,
            count: 0,
            averageCost: null,
            averageCostPerKm: null
          };
        }
        const averageCost = Math.round(stats.totalCost / stats.count);
        const averageCostPerKm =
          stats.totalDistance > 0
            ? Math.round((stats.totalCost / stats.totalDistance) * 10) / 10
            : null;
        return {
          label: bucket.label,
          count: stats.count,
          averageCost,
          averageCostPerKm
        };
      }
    );

    if (missingRegisteredAtRows.length > 0) {
      try {
        await sheets.spreadsheets.values.batchUpdate({
          spreadsheetId: SPREADSHEET_ID,
          resource: {
            valueInputOption: 'USER_ENTERED',
            data: missingRegisteredAtRows.map(({ rowIndex, value }) => ({
              range: `${QUICK_COST_SHEET_NAME}!A${rowIndex}`,
              values: [[value]]
            }))
          }
        });
      } catch (timestampError) {
        console.warn(
          '[QuickCost] registeredAt backfill failed:',
          timestampError?.message || timestampError
        );
      }
    }

    const timeTrends = {
      monthly: buildTrendResult(monthlyTrendMap, 'monthly'),
      weekly: buildTrendResult(weeklyTrendMap, 'weekly')
    };

    const result = {
      companyStats: companyStats,
      popularCompanies: popularCompanies,
      excellentCompanies: excellentCompanies,
      regionAggregates,
      distanceCostAnalysis,
      timeTrends
    };

    cacheUtils.set(cacheKey, result, 30 * 60 * 1000); // 30ë¶„ ìºì‹±

    res.json({ success: true, data: result });

  } catch (error) {
    console.error('í†µê³„ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨:', error);
    res.status(500).json({
      success: false,
      error: error.message || 'í†µê³„ ë°ì´í„° ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
    });
  }
});

// ë°ì´í„° í’ˆì§ˆ ì •ë³´ ì¡°íšŒ API (ê´€ë¦¬ì ì „ìš©)
app.get('/api/quick-cost/quality', async (req, res) => {
  try {
    // ìºì‹œ í™•ì¸
    const cacheKey = 'quick-cost-quality';
    const cached = cacheUtils.get(cacheKey);
    if (cached) {
      return res.json({ success: true, data: cached });
    }

    // êµ¬ê¸€ì‹œíŠ¸ì—ì„œ ë°ì´í„° ì¡°íšŒ
    const response = await sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${QUICK_COST_SHEET_NAME}!A:AL`,
    });

    const rows = response.data.values || [];
    if (rows.length <= 1) {
      const emptyResult = {
        outliers: [],
        normalizationStatus: { total: 0, normalized: 0 },
        duplicateRate: 0,
        reliabilityScores: []
      };
      cacheUtils.set(cacheKey, emptyResult, 30 * 60 * 1000);
      return res.json({ success: true, data: emptyResult });
    }

    const dataRows = rows.slice(1);

    // ì´ìƒì¹˜ ë°ì´í„° ìˆ˜ì§‘
    const outliers = [];
    const outlierCountMap = new Map();
    const companyStatsMap = new Map();
    const routeStatsMap = new Map();
    let totalEntries = 0;

    const parseCost = (value) => {
      if (!value) return null;
      const cleaned = value.toString().replace(/[^0-9.-]/g, '');
      const parsed = parseInt(cleaned, 10);
      return Number.isFinite(parsed) ? parsed : null;
    };

    const addVariant = (map, key) => {
      map.set(key, (map.get(key) || 0) + 1);
    };

    dataRows.forEach((row, rowIndex) => {
      const fromStoreName = row[3]?.toString().trim() || '';
      const toStoreName = row[5]?.toString().trim() || '';
      const modeType = row[7]?.toString().trim() || '';

      for (let i = 0; i < 5; i++) {
        const baseIndex = 8 + i * 6;
        const companyName = row[baseIndex]?.toString().trim();
        const phoneNumber = row[baseIndex + 1]?.toString().trim();
        const costValue = parseCost(row[baseIndex + 2]);
        const dispatchSpeed = row[baseIndex + 3]?.toString().trim();
        const pickupSpeed = row[baseIndex + 4]?.toString().trim();
        const arrivalSpeed = row[baseIndex + 5]?.toString().trim();

        if (!companyName || costValue === null) continue;

        totalEntries += 1;
        const normalizedName = normalizeCompanyName(companyName);

        if (!companyStatsMap.has(normalizedName)) {
          companyStatsMap.set(normalizedName, {
            normalizedName,
            variants: new Map(),
            phoneNumbers: new Map(),
            costs: [],
            entries: []
          });
        }

        const companyStats = companyStatsMap.get(normalizedName);
        addVariant(companyStats.variants, companyName);
        if (phoneNumber) {
          addVariant(companyStats.phoneNumbers, phoneNumber);
        }

        const entry = {
          rowNumber: rowIndex + 2,
          companyName,
          normalizedName,
          phoneNumber,
          cost: costValue,
          dispatchSpeed,
          pickupSpeed,
          arrivalSpeed,
          fromStoreName,
          toStoreName,
          fromStoreId: row[4]?.toString().trim() || '',
          toStoreId: row[6]?.toString().trim() || '',
          modeType
        };

        companyStats.costs.push(costValue);
        companyStats.entries.push(entry);

        const routeKey = `${entry.fromStoreId || entry.fromStoreName}__${entry.toStoreId || entry.toStoreName}`;
        if (!routeStatsMap.has(routeKey)) {
          routeStatsMap.set(routeKey, {
            routeKey,
            fromStoreName: entry.fromStoreName,
            toStoreName: entry.toStoreName,
            fromStoreId: entry.fromStoreId,
            toStoreId: entry.toStoreId,
            costs: [],
            entries: []
          });
        }

        const routeStats = routeStatsMap.get(routeKey);
        routeStats.costs.push(costValue);
        routeStats.entries.push(entry);
      }
    });

    const normalizedNameSet = new Set(companyStatsMap.keys());

    const duplicateGroups = [];
    const mergeSuggestions = [];
    const reliabilityScores = [];
    let mergeCandidateCount = 0;
    let totalDuplicateEntries = 0;

    const detectOutliersForSet = (entries, label) => {
      const entryCount = entries.length;
      if (entryCount < 3) return;

      const costs = entries.map((entry) => entry.cost);
      const mean = costs.reduce((sum, value) => sum + value, 0) / entryCount;
      const variance =
        entryCount > 1
          ? costs.reduce(
            (sum, value) => sum + Math.pow(value - mean, 2),
            0
          ) / entryCount
          : 0;
      const stdDev = Math.sqrt(variance);

      entries.forEach((entry) => {
        const deviation = Math.abs(entry.cost - mean);
        const deviationRatio = mean === 0 ? 0 : deviation / mean;

        if (
          (stdDev > 0 && deviation > stdDev * 2) ||
          deviationRatio >= 0.3
        ) {
          outliers.push({
            companyName: entry.companyName,
            normalizedName: entry.normalizedName,
            phoneNumber: entry.phoneNumber,
            cost: entry.cost,
            meanCost: Math.round(mean),
            deviation: Math.round(deviation),
            deviationRatio: Math.round(deviationRatio * 100),
            rowNumber: entry.rowNumber,
            fromStoreName: entry.fromStoreName,
            toStoreName: entry.toStoreName,
            fromStoreId: entry.fromStoreId,
            toStoreId: entry.toStoreId,
            routeKey: label.key || label.routeKey || '',
            routeLabel: label.display || label.routeLabel || '',
            modeType: entry.modeType,
            speeds: {
              dispatch: entry.dispatchSpeed,
              pickup: entry.pickupSpeed,
              arrival: entry.arrivalSpeed
            }
          });

          outlierCountMap.set(
            entry.normalizedName,
            (outlierCountMap.get(entry.normalizedName) || 0) + 1
          );
        }
      });
    };

    routeStatsMap.forEach((routeStats) => {
      detectOutliersForSet(routeStats.entries, {
        key: routeStats.routeKey,
        display: `${routeStats.fromStoreName} â†’ ${routeStats.toStoreName}`,
        routeLabel: `${routeStats.fromStoreName} â†’ ${routeStats.toStoreName}`
      });
    });

    const companyRouteMap = new Map();
    routeStatsMap.forEach((routeStats) => {
      routeStats.entries.forEach((entry) => {
        const companyRouteKey = `${entry.normalizedName}__${routeStats.routeKey}`;
        if (!companyRouteMap.has(companyRouteKey)) {
          companyRouteMap.set(companyRouteKey, {
            companyRouteKey,
            normalizedName: entry.normalizedName,
            displayName: entry.companyName,
            routeKey: routeStats.routeKey,
            fromStoreName: routeStats.fromStoreName,
            toStoreName: routeStats.toStoreName,
            entries: []
          });
        }
        companyRouteMap.get(companyRouteKey).entries.push(entry);
      });
    });

    companyRouteMap.forEach((companyRoute) => {
      detectOutliersForSet(companyRoute.entries, {
        key: companyRoute.companyRouteKey,
        display: `${companyRoute.displayName} (${companyRoute.fromStoreName} â†’ ${companyRoute.toStoreName})`,
        routeLabel: `${companyRoute.fromStoreName} â†’ ${companyRoute.toStoreName}`
      });
    });

    companyStatsMap.forEach((stats) => {
      const variants = Array.from(stats.variants.entries())
        .map(([name, count]) => ({ name, count }))
        .sort((a, b) => b.count - a.count);

      const canonicalName = variants[0]?.name || stats.normalizedName;
      const mergeCandidates = variants.filter(
        (variant) =>
          variant.name !== canonicalName &&
          variant.count < variants[0].count
      );

      if (mergeCandidates.length > 0) {
        mergeCandidateCount += mergeCandidates.reduce(
          (sum, item) => sum + item.count,
          0
        );
        totalDuplicateEntries += mergeCandidates.reduce(
          (sum, item) => sum + item.count,
          0
        );
        duplicateGroups.push({
          normalizedName: stats.normalizedName,
          totalCount: variants.reduce((sum, item) => sum + item.count, 0),
          variants
        });

        mergeSuggestions.push({
          normalizedName: stats.normalizedName,
          canonicalName,
          candidates: mergeCandidates
            .slice(0, 5)
            .map((candidate) => ({
              name: candidate.name,
              count: candidate.count
            }))
        });
      }

      const entryCount = stats.costs.length;
      const mean =
        entryCount > 0
          ? stats.costs.reduce((sum, value) => sum + value, 0) / entryCount
          : 0;
      const variance =
        entryCount > 1
          ? stats.costs.reduce(
            (sum, value) => sum + Math.pow(value - mean, 2),
            0
          ) / entryCount
          : 0;
      const stdDev = Math.sqrt(variance);

      if (entryCount > 0) {
        const entryScore =
          entryCount >= 10
            ? 50
            : Math.round((Math.min(entryCount, 10) / 10) * 50);

        const dispersion =
          mean > 0 && Number.isFinite(stdDev) ? Math.min(stdDev / mean, 1) : 0;
        const varianceScore = Math.round(30 * Math.max(0, 1 - dispersion));

        const outlierCount = outlierCountMap.get(stats.normalizedName) || 0;
        const outlierRatio =
          entryCount > 0 ? Math.min(outlierCount / entryCount, 1) : 0;
        const outlierScore = Math.round(
          20 * Math.max(0, 1 - Math.min(outlierRatio * 2, 1))
        );

        const totalScore = Math.max(
          0,
          Math.min(100, entryScore + varianceScore + outlierScore)
        );

        const variants = Array.from(stats.variants.entries()).sort(
          (a, b) => b[1] - a[1]
        );
        const displayName = variants[0]?.[0] || stats.normalizedName;

        reliabilityScores.push({
          normalizedName: stats.normalizedName,
          displayName,
          score: totalScore,
          entryCount,
          meanCost: Math.round(mean),
          stdDev: Math.round(stdDev),
          outlierRatio: parseFloat((outlierRatio * 100).toFixed(2))
        });
      }
    });

    duplicateGroups.sort((a, b) => b.totalCount - a.totalCount);
    reliabilityScores.sort((a, b) => b.score - a.score);

    const result = {
      outliers: outliers,
      normalizationStatus: {
        total: totalEntries,
        normalized: totalEntries - mergeCandidateCount,
        rate:
          totalEntries > 0
            ? (((totalEntries - mergeCandidateCount) / totalEntries) * 100).toFixed(2)
            : 0
      },
      duplicateRate:
        totalEntries > 0
          ? parseFloat(((totalDuplicateEntries / totalEntries) * 100).toFixed(2))
          : 0,
      duplicateGroups: duplicateGroups.slice(0, 25),
      mergeSuggestions: mergeSuggestions.slice(0, 25),
      reliabilityScores: reliabilityScores.slice(0, 100)
    };

    cacheUtils.set(cacheKey, result, 30 * 60 * 1000); // 30ë¶„ ìºì‹±

    res.json({ success: true, data: result });

  } catch (error) {
    console.error('ë°ì´í„° í’ˆì§ˆ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error);
    res.status(500).json({
      success: false,
      error: error.message || 'ë°ì´í„° í’ˆì§ˆ ì •ë³´ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
    });
  }
});

// ì£¼ì†Œë¥¼ ìœ„ë„/ê²½ë„ë¡œ ë³€í™˜í•˜ëŠ” API (ì¹´ì¹´ì˜¤ API ì‚¬ìš©)
app.get('/api/geocode-address', async (req, res) => {
  setCORSHeaders(req, res);
  
  try {
    const { address } = req.query;
    
    if (!address) {
      return res.status(400).json({
        success: false,
        error: 'ì£¼ì†Œê°€ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }
    
    const coords = await geocodeAddressWithKakao(address);
    
    if (coords) {
      res.json({
        success: true,
        latitude: coords.latitude,
        longitude: coords.longitude
      });
    } else {
      res.status(404).json({
        success: false,
        error: 'ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }
  } catch (error) {
    console.error('ì£¼ì†Œ ë³€í™˜ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: error.message || 'ì£¼ì†Œ ë³€í™˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
    });
  }
});

// ëŒ€ì¤‘êµí†µ ìœ„ì¹˜ ì¡°íšŒ API (ë§¤ì¥ë³„, ìºì‹± í¬í•¨) - ID ê¸°ë°˜ìœ¼ë¡œ ì‹¤ì œ ìœ„ì¹˜ ì •ë³´ ì¡°íšŒ
// ëŒ€ì¤‘êµí†µ ìœ„ì¹˜ ê´€ë ¨ ì—”ë“œí¬ì¸íŠ¸ëŠ” server/directRoutes.jsë¡œ ì´ë™ë¨
// ì¤‘ë³µ ë°©ì§€ë¥¼ ìœ„í•´ ì—¬ê¸°ì„œëŠ” ì œê±° (directRoutes.jsì˜ ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš©)
// ì•„ë˜ ì½”ë“œëŠ” ì£¼ì„ ì²˜ë¦¬ë¨ - directRoutes.jsì˜ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”
/*
const transitLocationCache = new Map();
const TRANSIT_CACHE_TTL = 5 * 60 * 1000; // 5ë¶„

app.get('/api/direct/transit-location/list', async (req, res) => {
  setCORSHeaders(req, res);
  
  try {
    // ìºì‹œ í™•ì¸
    const cacheKey = 'transit_locations_by_store';
    const cached = transitLocationCache.get(cacheKey);
    if (cached && (Date.now() - cached.timestamp) < TRANSIT_CACHE_TTL) {
      return res.json({
        success: true,
        data: cached.data,
        fromCache: true
      });
    }
    
    // ëª¨ë“  ëŒ€ì¤‘êµí†µ ìœ„ì¹˜ ì¡°íšŒ
    await ensureTransitLocationSheetHeaders();
    const transitValues = await getSheetValues(TRANSIT_LOCATION_SHEET_NAME);
    const transitMap = new Map();
    
    if (transitValues && transitValues.length > 1) {
      const transitRows = transitValues.slice(1);
      for (const row of transitRows) {
        if (!row[0]) continue;
        transitMap.set(row[0], {
          id: row[0],
          type: row[1] || '',
          name: row[2] || '',
          address: row[3] || '',
          lat: row[4] ? parseFloat(row[4]) : null,
          lng: row[5] ? parseFloat(row[5]) : null,
          updatedAt: row[6] || ''
        });
      }
    }
    
    // ë§¤ì¥ë³„ ëŒ€ì¤‘êµí†µ ìœ„ì¹˜ ì¡°íšŒ
    const values = await getSheetValues(CUSTOMER_STORE_PHOTO_SHEET_NAME);
    if (!values || values.length <= 1) {
      return res.json({
        success: true,
        data: []
      });
    }
    
    const rows = values.slice(1);
    const transitLocations = [];
    
    for (const row of rows) {
      if (!row[0]) continue; // ë§¤ì¥ëª…ì´ ì—†ìœ¼ë©´ ê±´ë„ˆë›°ê¸°
      
      const storeName = row[0];
      const busTerminals = [];
      const subwayStations = [];
      
      // ë²„ìŠ¤í„°ë¯¸ë„ ID ëª©ë¡ íŒŒì‹±
      if (row[34]) {
        try {
          const busIds = JSON.parse(row[34]);
          if (Array.isArray(busIds)) {
            for (const id of busIds) {
              const location = transitMap.get(id);
              if (location) {
                busTerminals.push(location);
              }
            }
          }
        } catch (error) {
          console.error(`ë²„ìŠ¤í„°ë¯¸ë„ ID ëª©ë¡ JSON íŒŒì‹± ì‹¤íŒ¨ (${storeName}):`, error);
        }
      }
      
      // ì§€í•˜ì² ì—­ ID ëª©ë¡ íŒŒì‹±
      if (row[35]) {
        try {
          const subwayIds = JSON.parse(row[35]);
          if (Array.isArray(subwayIds)) {
            for (const id of subwayIds) {
              const location = transitMap.get(id);
              if (location) {
                subwayStations.push(location);
              }
            }
          }
        } catch (error) {
          console.error(`ì§€í•˜ì² ì—­ ID ëª©ë¡ JSON íŒŒì‹± ì‹¤íŒ¨ (${storeName}):`, error);
        }
      }
      
      if (busTerminals.length > 0 || subwayStations.length > 0) {
        transitLocations.push({
          storeName,
          busTerminals,
          subwayStations
        });
      }
    }
    
    // ìºì‹œ ì €ì¥
    transitLocationCache.set(cacheKey, {
      data: transitLocations,
      timestamp: Date.now()
    });
    
    res.json({
      success: true,
      data: transitLocations,
      fromCache: false
    });
  } catch (error) {
    console.error('ëŒ€ì¤‘êµí†µ ìœ„ì¹˜ ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: error.message || 'ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
    });
  }
});
*/

// ëŒ€ì¤‘êµí†µ ìœ„ì¹˜ ì €ì¥ API (ì£¼ì„ ì²˜ë¦¬ë¨ - directRoutes.jsì˜ ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš©)
/*
app.post('/api/direct/transit-location/save', express.json(), async (req, res) => {
  setCORSHeaders(req, res);
  
  try {
    const { storeName, busTerminals, subwayStations } = req.body;
    
    if (!storeName) {
      return res.status(400).json({
        success: false,
        error: 'ë§¤ì¥ëª…ì´ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }
    
    // í—¤ë” í™•ì¸ ë° ìƒì„±
    const { ensureSheetHeaders } = require('./directRoutes');
    await ensureSheetHeaders(sheets, SPREADSHEET_ID, CUSTOMER_STORE_PHOTO_SHEET_NAME, HEADERS_STORE_PHOTO);
    
    const values = await getSheetValues(CUSTOMER_STORE_PHOTO_SHEET_NAME);
    const rowIndex = values ? values.findIndex(row => row[0] === storeName) : -1;
    const existingRow = rowIndex !== -1 && values ? values[rowIndex] : null;
    
    // ë²„ìŠ¤í„°ë¯¸ë„ ì •ë³´ ì²˜ë¦¬
    let busTerminalsJson = '[]';
    if (busTerminals && Array.isArray(busTerminals) && busTerminals.length > 0) {
      const processedBusTerminals = [];
      for (const terminal of busTerminals) {
        if (!terminal.name || !terminal.address) {
          continue; // ì´ë¦„ì´ë‚˜ ì£¼ì†Œê°€ ì—†ìœ¼ë©´ ê±´ë„ˆë›°ê¸°
        }
        
        try {
          const coords = await geocodeAddressWithKakao(terminal.address);
          if (coords) {
            processedBusTerminals.push({
              name: terminal.name,
              address: terminal.address,
              lat: coords.latitude,
              lng: coords.longitude
            });
          } else {
            // ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨ ì‹œì—ë„ ì €ì¥ (ìœ„ë„/ê²½ë„ ì—†ì´)
            processedBusTerminals.push({
              name: terminal.name,
              address: terminal.address,
              lat: null,
              lng: null
            });
          }
        } catch (error) {
          console.error(`ë²„ìŠ¤í„°ë¯¸ë„ ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨: ${terminal.address}`, error);
          // ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨ ì‹œì—ë„ ì €ì¥
          processedBusTerminals.push({
            name: terminal.name,
            address: terminal.address,
            lat: null,
            lng: null
          });
        }
      }
      busTerminalsJson = JSON.stringify(processedBusTerminals);
    }
    
    // ì§€í•˜ì² ì—­ ì •ë³´ ì²˜ë¦¬
    let subwayStationsJson = '[]';
    if (subwayStations && Array.isArray(subwayStations) && subwayStations.length > 0) {
      const processedSubwayStations = [];
      for (const station of subwayStations) {
        if (!station.name || !station.address) {
          continue; // ì´ë¦„ì´ë‚˜ ì£¼ì†Œê°€ ì—†ìœ¼ë©´ ê±´ë„ˆë›°ê¸°
        }
        
        try {
          const coords = await geocodeAddressWithKakao(station.address);
          if (coords) {
            processedSubwayStations.push({
              name: station.name,
              address: station.address,
              lat: coords.latitude,
              lng: coords.longitude
            });
          } else {
            // ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨ ì‹œì—ë„ ì €ì¥ (ìœ„ë„/ê²½ë„ ì—†ì´)
            processedSubwayStations.push({
              name: station.name,
              address: station.address,
              lat: null,
              lng: null
            });
          }
        } catch (error) {
          console.error(`ì§€í•˜ì² ì—­ ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨: ${station.address}`, error);
          // ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨ ì‹œì—ë„ ì €ì¥
          processedSubwayStations.push({
            name: station.name,
            address: station.address,
            lat: null,
            lng: null
          });
        }
      }
      subwayStationsJson = JSON.stringify(processedSubwayStations);
    }
    
    // ê¸°ì¡´ í–‰ì´ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸, ì—†ìœ¼ë©´ ìƒˆë¡œ ì¶”ê°€
    if (rowIndex === -1) {
      // ìƒˆ í–‰ ìƒì„± (ê¸°ë³¸ê°’ìœ¼ë¡œ ì±„ì›€)
      const newRow = new Array(36).fill('');
      newRow[0] = storeName;
      newRow[34] = busTerminalsJson;
      newRow[35] = subwayStationsJson;
      
      await rateLimitedSheetsCall(() =>
        sheets.spreadsheets.values.append({
          spreadsheetId: SPREADSHEET_ID,
          range: `${CUSTOMER_STORE_PHOTO_SHEET_NAME}!A:AJ`,
          valueInputOption: 'USER_ENTERED',
          insertDataOption: 'INSERT_ROWS',
          resource: { values: [newRow] }
        })
      );
    } else {
      // ê¸°ì¡´ í–‰ ì—…ë°ì´íŠ¸
      const updatedRow = [...existingRow];
      // ë°°ì—´ ê¸¸ì´ê°€ ë¶€ì¡±í•˜ë©´ í™•ì¥
      while (updatedRow.length < 36) {
        updatedRow.push('');
      }
      updatedRow[34] = busTerminalsJson;
      updatedRow[35] = subwayStationsJson;
      
      await rateLimitedSheetsCall(() =>
        sheets.spreadsheets.values.update({
          spreadsheetId: SPREADSHEET_ID,
          range: `${CUSTOMER_STORE_PHOTO_SHEET_NAME}!A${rowIndex + 1}:AJ${rowIndex + 1}`,
          valueInputOption: 'USER_ENTERED',
          resource: { values: [updatedRow] }
        })
      );
    }
    
    // ìºì‹œ ë¬´íš¨í™”
    const cacheKey = `sheet_${CUSTOMER_STORE_PHOTO_SHEET_NAME}_${SPREADSHEET_ID}`;
    if (cacheManager && cacheManager.clear) {
      cacheManager.clear(cacheKey);
    }
    // ëŒ€ì¤‘êµí†µ ìœ„ì¹˜ ìºì‹œë„ ë¬´íš¨í™”
    transitLocationCache.delete('transit_locations');
    
    res.json({
      success: true,
      data: {
        storeName,
        busTerminals: JSON.parse(busTerminalsJson),
        subwayStations: JSON.parse(subwayStationsJson)
      }
    });
  } catch (error) {
    console.error('ëŒ€ì¤‘êµí†µ ìœ„ì¹˜ ì €ì¥ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: error.message || 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
    });
  }
});
*/

// ì—…ì²´ëª… ì •ê·œí™” ì œì•ˆ API (ê´€ë¦¬ì ì „ìš©)
app.post('/api/quick-cost/normalize', async (req, res) => {
  try {
    const { companyName1, companyName2 } = req.body;

    if (!companyName1 || !companyName2) {
      return res.status(400).json({
        success: false,
        error: 'ë‘ ê°œì˜ ì—…ì²´ëª…ì´ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }

    const normalized1 = normalizeCompanyName(companyName1);
    const normalized2 = normalizeCompanyName(companyName2);

    // ìœ ì‚¬ë„ ê³„ì‚° (ê°„ë‹¨í•œ êµ¬í˜„)
    const similarity = normalized1 === normalized2 ? 100 : 0;

    res.json({
      success: true,
      data: {
        companyName1: companyName1,
        companyName2: companyName2,
        normalized1: normalized1,
        normalized2: normalized2,
        similarity: similarity,
        shouldMerge: similarity >= 80 // 80% ì´ìƒ ìœ ì‚¬í•˜ë©´ ë³‘í•© ì œì•ˆ
      }
    });

  } catch (error) {
    console.error('ì •ê·œí™” ì œì•ˆ ì‹¤íŒ¨:', error);
    res.status(500).json({
      success: false,
      error: error.message || 'ì •ê·œí™” ì œì•ˆì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
    });
  }
});