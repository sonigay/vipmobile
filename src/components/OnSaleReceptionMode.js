import React, { useState, useEffect } from 'react';
import {
  Box,
  Paper,
  Typography,
  AppBar,
  Toolbar,
  Button,
  CircularProgress,
  Alert,
  TextField,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Card,
  CardContent,
  CardActions,
  Grid,
  IconButton,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Chip,
  TablePagination,
  InputAdornment,
  Tabs,
  Tab,
  FormControl,
  InputLabel,
  Select,
  MenuItem
} from '@mui/material';
import {
  Lock as LockIcon,
  Link as LinkIcon,
  OpenInNew as OpenInNewIcon,
  Close as CloseIcon,
  Update as UpdateIcon,
  Refresh as RefreshIcon,
  Edit as EditIcon,
  Cancel as CancelIcon,
  Search as SearchIcon
} from '@mui/icons-material';
import AppUpdatePopup from './AppUpdatePopup';

// TabPanel Ïª¥Ìè¨ÎÑåÌä∏
function TabPanel(props) {
  const { children, value, index, ...other } = props;
  return (
    <div
      role="tabpanel"
      hidden={value !== index}
      id={`simple-tabpanel-${index}`}
      aria-labelledby={`simple-tab-${index}`}
      {...other}
    >
      {value === index && <Box sx={{ p: 3 }}>{children}</Box>}
    </div>
  );
}

const OnSaleReceptionMode = ({ 
  loggedInStore, 
  onLogout,
  onModeChange,
  availableModes
}) => {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [success, setSuccess] = useState(null);
  const [showUpdatePopup, setShowUpdatePopup] = useState(false);
  
  // Ïù∏Ï¶ù ÏÉÅÌÉú
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [password, setPassword] = useState('');
  const [showPasswordDialog, setShowPasswordDialog] = useState(false);
  
  // ÌôúÏÑ±ÌôîÎêú ÎßÅÌÅ¨ Î™©Î°ù
  const [activeLinks, setActiveLinks] = useState([]);
  
  // ÌîÑÎ°ùÏãú ÌéòÏù¥ÏßÄ ÌëúÏãú
  const [showProxyPage, setShowProxyPage] = useState(false);
  const [proxyHtml, setProxyHtml] = useState('');
  const [currentLink, setCurrentLink] = useState(null);
  
  // Í∞úÌÜµÏ†ïÎ≥¥ Î™©Î°ù Í¥ÄÎ†® ÏÉÅÌÉú
  const [activationList, setActivationList] = useState([]);
  const [activationLoading, setActivationLoading] = useState(false);
  const [searchTerm, setSearchTerm] = useState('');
  const [page, setPage] = useState(0);
  const [rowsPerPage, setRowsPerPage] = useState(10);

  // ÌÉ≠ ÏÉÅÌÉú Í¥ÄÎ¶¨
  const [tabValue, setTabValue] = useState(0);
  
  // ÏõîÎ≥Ñ ÌïÑÌÑ∞ÎßÅ (Ï†ëÏàòÎ™®ÎìúÏóêÏÑúÎäî Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ ÌëúÏãú)
  const [selectedMonth, setSelectedMonth] = useState(null); // null = Ï†ÑÏ≤¥
  
  const API_URL = process.env.REACT_APP_API_URL;

  // ÌÉ≠ Ìï∏Îì§Îü¨ Ìï®ÏàòÎì§
  const handleTabChange = (event, newValue) => {
    setTabValue(newValue);
  };

  const handleMonthChange = (event) => {
    const value = event.target.value;
    if (value === 'all') {
      setSelectedMonth(null); // Ï†ÑÏ≤¥ ÏÑ†ÌÉù Ïãú nullÎ°ú ÏÑ§Ï†ï
    } else {
      setSelectedMonth(value);
    }
  };

  // ÏóÖÎç∞Ïù¥Ìä∏ ÌåùÏóÖ ÏûêÎèô ÌëúÏãú (Ïù∏Ï¶ù ÏÑ±Í≥µ Ïãú)
  useEffect(() => {
    if (isAuthenticated) {
      setShowUpdatePopup(true);
      fetchActivationList(); // Í∞úÌÜµÏ†ïÎ≥¥ Î™©Î°ùÎèÑ Ìï®Íªò Î∂àÎü¨Ïò§Í∏∞
    }
  }, [isAuthenticated]);

  // ÏõîÎ≥Ñ ÌïÑÌÑ∞ÎßÅ Î≥ÄÍ≤Ω Ïãú Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
  useEffect(() => {
    if (selectedMonth && isAuthenticated) {
      fetchActivationList();
    }
  }, [selectedMonth]);

  // Ïª¥Ìè¨ÎÑåÌä∏ ÎßàÏö¥Ìä∏ Ïãú ÌôúÏÑ±ÌôîÎêú ÎßÅÌÅ¨ Î∂àÎü¨Ïò§Í∏∞
  useEffect(() => {
    fetchActiveLinks();
  }, []);

  // ÏàòÏ†ï ÏôÑÎ£å Î©îÏãúÏßÄ Î¶¨Ïä§ÎÑà
  useEffect(() => {
    const handleMessage = (event) => {
      if (event.data && event.data.type === 'ACTIVATION_UPDATED') {
        console.log('üîÑ ÏàòÏ†ï ÏôÑÎ£å ÏïåÎ¶º Î∞õÏùå, Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®');
        fetchActivationList();
      }
      if (event.data && event.data.type === 'ACTIVATION_COMPLETED') {
        console.log('üîÑ Í∞úÌÜµÏôÑÎ£å ÏïåÎ¶º Î∞õÏùå, Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®');
        fetchActivationList();
      }
    };

    window.addEventListener('message', handleMessage);
    return () => window.removeEventListener('message', handleMessage);
  }, []);

  const fetchActiveLinks = async () => {
    try {
      setLoading(true);
      const response = await fetch(`${API_URL}/api/onsale/active-links`);
      const data = await response.json();
      
      if (data.success) {
        setActiveLinks(data.links);
      }
    } catch (error) {
      console.error('ÎßÅÌÅ¨ Ï°∞Ìöå Ïã§Ìå®:', error);
    } finally {
      setLoading(false);
    }
  };

  const handlePasswordSubmit = async () => {
    try {
      if (!password) {
        setError('ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
        return;
      }

      setLoading(true);
      setError(null);

      const response = await fetch(`${API_URL}/api/check-onsale-permission`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          userId: loggedInStore.id,
          password: password
        }),
      });

      const data = await response.json();

      if (data.success && data.hasPermission) {
        setIsAuthenticated(true);
        setShowPasswordDialog(false);
        setPassword('');
      } else {
        setError(data.error || 'Í∂åÌïúÏù¥ ÏóÜÍ±∞ÎÇò ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§.');
      }
    } catch (error) {
      console.error('Í∂åÌïú ÌôïÏù∏ Ïã§Ìå®:', error);
      setError('Í∂åÌïú ÌôïÏù∏Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
    } finally {
      setLoading(false);
    }
  };

  const handleLinkClick = async (link) => {
    try {
      // Í∞úÌÜµÏñëÏãù ÏÇ¨Ïö© Ïó¨Î∂Ä ÌôïÏù∏
      if (link.useActivationForm && link.activationSheetId && link.activationSheetName) {
        // targetUrlÏóê vipCompany ÌååÎùºÎØ∏ÌÑ∞ Ï∂îÍ∞Ä
        let targetUrl = link.url;
        if (loggedInStore && loggedInStore.name) {
          const separator = targetUrl.includes('?') ? '&' : '?';
          targetUrl = `${targetUrl}${separator}vipCompany=${encodeURIComponent(loggedInStore.name)}`;
        }
        
        // Í∞úÌÜµÏ†ïÎ≥¥ ÏûÖÎ†• ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
        const params = new URLSearchParams({
          vipCompany: encodeURIComponent(loggedInStore.name),
          activationSheetId: link.activationSheetId,
          activationSheetName: link.activationSheetName,
          targetUrl: targetUrl,
          storeId: loggedInStore.id
        });
        window.location.href = `/?${params.toString()}`;
        return;
      }
      
      // Í∞úÌÜµÏñëÏãù ÏÇ¨Ïö©ÌïòÏßÄ ÏïäÎäî Í≤ΩÏö∞: Í∏∞Ï°¥ Î°úÏßÅ (U+ ÌéòÏù¥ÏßÄÎ°ú Î∞îÎ°ú Ïù¥Îèô)
      let targetUrl = link.url;
      
      if (loggedInStore && loggedInStore.name) {
        // URLÏóê vipCompany ÌååÎùºÎØ∏ÌÑ∞ Ï∂îÍ∞Ä
        const separator = targetUrl.includes('?') ? '&' : '?';
        targetUrl = `${targetUrl}${separator}vipCompany=${encodeURIComponent(loggedInStore.name)}`;
        console.log('üíæ ÏóÖÏ≤¥Î™Ö URLÏóê Ï∂îÍ∞Ä:', loggedInStore.name);
        console.log('üîó ÏµúÏ¢Ö URL:', targetUrl);
      }
      
      // Î™®Îì† ÎßÅÌÅ¨Î•º ÏßÅÏ†ë ÏÉà Ï∞ΩÏóêÏÑú Ïó¥Í∏∞ (ÌôïÏû• ÌîÑÎ°úÍ∑∏Îû®Ïù¥ Ï≤òÎ¶¨)
      window.open(targetUrl, '_blank');
    } catch (error) {
      console.error('ÎßÅÌÅ¨ Ïó¥Í∏∞ Ïã§Ìå®:', error);
      setError('ÌéòÏù¥ÏßÄÎ•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
      
      // ÏóêÎü¨ Î∞úÏÉù Ïãú ÏõêÎ≥∏ ÎßÅÌÅ¨Î°ú ÏßÅÏ†ë Ïó¥Í∏∞
      window.open(link.url, '_blank');
    } finally {
      setLoading(false);
    }
  };

  const handleCloseProxy = () => {
    setShowProxyPage(false);
    setProxyHtml('');
    setCurrentLink(null);
  };

  // Í∞úÌÜµÏ†ïÎ≥¥ Î™©Î°ù Î∂àÎü¨Ïò§Í∏∞
  const fetchActivationList = async () => {
    try {
      setActivationLoading(true);
      const params = new URLSearchParams();
      params.append('storeName', loggedInStore.name);
      params.append('allSheets', 'true');
      
      // ÏõîÎ≥Ñ ÌïÑÌÑ∞ÎßÅ Ï∂îÍ∞Ä
      if (selectedMonth) {
        params.append('month', selectedMonth);
      }
      
      const url = `${API_URL}/api/onsale/activation-list?${params.toString()}`;
      console.log('üîç Ïò®ÏÑ∏ÏùºÏ†ëÏàò Î™®Îìú - Í∞úÌÜµÏ†ïÎ≥¥ Î™©Î°ù ÏöîÏ≤≠:', url);
      console.log('üîç Îß§Ïû•Î™Ö:', loggedInStore.name);
      
      const response = await fetch(url);
      const result = await response.json();
      
      console.log('üîç Ïò®ÏÑ∏ÏùºÏ†ëÏàò Î™®Îìú - API ÏùëÎãµ:', result);
      console.log('üîç Ïò®ÏÑ∏ÏùºÏ†ëÏàò Î™®Îìú - ÏùëÎãµ ÏÉÅÌÉú:', response.status);
      console.log('üîç Ïò®ÏÑ∏ÏùºÏ†ëÏàò Î™®Îìú - ÏùëÎãµ Ìó§Îçî:', response.headers);
      
      if (result.success) {
        console.log('üîç Ïò®ÏÑ∏ÏùºÏ†ëÏàò Î™®Îìú - Í∞úÌÜµÏ†ïÎ≥¥ Í∞úÏàò:', result.data.length);
        console.log('üîç Ïò®ÏÑ∏ÏùºÏ†ëÏàò Î™®Îìú - Ï≤´ Î≤àÏß∏ Îç∞Ïù¥ÌÑ∞:', result.data[0]);
        setActivationList(result.data);
      } else {
        console.error('üîç Ïò®ÏÑ∏ÏùºÏ†ëÏàò Î™®Îìú - API ÏóêÎü¨:', result.error);
        setError('Í∞úÌÜµÏ†ïÎ≥¥ Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
      }
    } catch (error) {
      console.error('Í∞úÌÜµÏ†ïÎ≥¥ Î™©Î°ù Î°úÎìú Ïã§Ìå®:', error);
      setError('Í∞úÌÜµÏ†ïÎ≥¥ Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
    } finally {
      setActivationLoading(false);
    }
  };

  // Í∞úÌÜµÏ†ïÎ≥¥ ÏàòÏ†ï
  const handleEditActivation = (activation) => {
    const editUrl = `/activation-info?editMode=true&sheetId=${activation.sheetId}&rowIndex=${activation.rowIndex}&vipCompany=${encodeURIComponent(loggedInStore.name)}&activationSheetId=${activation.sheetId}`;
    window.location.href = editUrl;
  };

  // Í∞úÌÜµÏ†ïÎ≥¥ Ï∑®ÏÜå
  const handleCancelActivation = async (activation) => {
    if (!window.confirm('Ïù¥ Í∞úÌÜµÏ†ïÎ≥¥Î•º Ï∑®ÏÜå Ï≤òÎ¶¨ÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
      return;
    }
    
    try {
      setActivationLoading(true);
      const response = await fetch(`${API_URL}/api/onsale/activation-info/${activation.sheetId}/${activation.rowIndex}/cancel`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          cancelledBy: loggedInStore.name
        })
      });
      
      const result = await response.json();
      
      if (result.success) {
        setSuccess('Í∞úÌÜµÏ†ïÎ≥¥Í∞Ä Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§.');
        fetchActivationList(); // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
      } else {
        setError(result.error || 'Í∞úÌÜµÏ†ïÎ≥¥ Ï∑®ÏÜåÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
      }
    } catch (error) {
      console.error('Í∞úÌÜµÏ†ïÎ≥¥ Ï∑®ÏÜå Ïã§Ìå®:', error);
      setError('Í∞úÌÜµÏ†ïÎ≥¥ Ï∑®ÏÜåÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
    } finally {
      setActivationLoading(false);
    }
  };

  // Í≤ÄÏÉâ ÌïÑÌÑ∞ÎßÅ (Ï†ëÏàòÎ™®ÎìúÏóêÏÑúÎäî Î™®Îì† Îç∞Ïù¥ÌÑ∞ ÌëúÏãú)
  const filteredActivations = activationList.filter(activation => {
    if (!searchTerm) return true;
    const searchLower = searchTerm.toLowerCase();
    return (
      activation.customerName?.toLowerCase().includes(searchLower) ||
      activation.phoneNumber?.includes(searchTerm) ||
      activation.modelName?.toLowerCase().includes(searchLower) ||
      activation.plan?.toLowerCase().includes(searchLower)
    );
  });

  // ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò
  const paginatedActivations = filteredActivations.slice(
    page * rowsPerPage,
    page * rowsPerPage + rowsPerPage
  );

  // Ïù∏Ï¶ùÎêòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞
  if (!isAuthenticated) {
    return (
      <Box sx={{ minHeight: '100vh', bgcolor: '#f5f5f5' }}>
        {/* Ìó§Îçî */}
        <AppBar position="static" sx={{ 
          bgcolor: 'transparent',
          background: 'linear-gradient(135deg, #8e24aa 0%, #5e35b1 100%)',
          boxShadow: '0 4px 20px rgba(0,0,0,0.1)'
        }}>
          <Toolbar>
            <LockIcon sx={{ mr: 2 }} />
            <Typography variant="h6" sx={{ flexGrow: 1 }}>
              Ïò®ÏÑ∏ÏùºÏ†ëÏàò Î™®Îìú
            </Typography>
            
            <Button
              color="inherit"
              startIcon={<UpdateIcon />}
              onClick={() => setShowUpdatePopup(true)}
              sx={{
                backgroundColor: 'rgba(255,255,255,0.1)',
                '&:hover': { backgroundColor: 'rgba(255,255,255,0.2)' }
              }}
            >
              ÏóÖÎç∞Ïù¥Ìä∏ ÌôïÏù∏
            </Button>
            
            {onModeChange && availableModes && availableModes.length > 1 && (
              <Button
                color="inherit"
                startIcon={<RefreshIcon />}
                onClick={onModeChange}
                sx={{
                  ml: 2,
                  backgroundColor: 'rgba(255,255,255,0.1)',
                  '&:hover': { backgroundColor: 'rgba(255,255,255,0.2)' }
                }}
              >
                Î™®Îìú Î≥ÄÍ≤Ω
              </Button>
            )}
            
            <Button color="inherit" onClick={onLogout} sx={{ ml: 2 }}>
              Î°úÍ∑∏ÏïÑÏõÉ
            </Button>
          </Toolbar>
        </AppBar>

        {/* Ïù∏Ï¶ù ÏöîÏ≤≠ ÌôîÎ©¥ */}
        <Box 
          sx={{ 
            display: 'flex', 
            justifyContent: 'center', 
            alignItems: 'center',
            minHeight: 'calc(100vh - 64px)',
            p: 3
          }}
        >
          <Paper sx={{ 
            p: 4, 
            maxWidth: 500, 
            width: '100%', 
            textAlign: 'center',
            background: 'linear-gradient(135deg, #f8f9ff 0%, #e8eaf6 100%)',
            border: '1px solid #e1bee7',
            boxShadow: '0 8px 32px rgba(142, 36, 170, 0.15)'
          }}>
            <LockIcon sx={{ fontSize: 60, color: '#8e24aa', mb: 2 }} />
            <Typography variant="h5" gutterBottom sx={{ color: '#5e35b1', fontWeight: 'bold' }}>
              üîê Ïò®ÏÑ∏ÏùºÏ†ëÏàò Î™®Îìú Ï†ëÍ∑º
            </Typography>
            <Typography variant="body2" sx={{ color: '#8e24aa', mb: 3 }}>
              Ïù¥ Î™®ÎìúÏóê Ï†ëÍ∑ºÌïòÎ†§Î©¥ ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÌïÑÏöîÌï©ÎãàÎã§.
            </Typography>
            <Button
              variant="contained"
              size="large"
              onClick={() => setShowPasswordDialog(true)}
              sx={{ 
                mt: 2,
                background: 'linear-gradient(135deg, #8e24aa 0%, #5e35b1 100%)',
                '&:hover': { 
                  background: 'linear-gradient(135deg, #7b1fa2 0%, #4a2c7a 100%)',
                  transform: 'translateY(-2px)'
                },
                boxShadow: '0 6px 20px rgba(142, 36, 170, 0.4)',
                transition: 'all 0.3s ease',
                px: 4,
                py: 1.5
              }}
            >
              üîë ÎπÑÎ∞ÄÎ≤àÌò∏ ÏûÖÎ†•
            </Button>
          </Paper>
        </Box>

        {/* ÎπÑÎ∞ÄÎ≤àÌò∏ ÏûÖÎ†• Îã§Ïù¥ÏñºÎ°úÍ∑∏ */}
        <Dialog 
          open={showPasswordDialog} 
          onClose={() => setShowPasswordDialog(false)}
          PaperProps={{
            sx: {
              background: 'linear-gradient(135deg, #f8f9ff 0%, #e8eaf6 100%)',
              border: '1px solid #e1bee7',
              boxShadow: '0 8px 32px rgba(142, 36, 170, 0.15)'
            }
          }}
        >
          <DialogTitle sx={{ color: '#5e35b1', fontWeight: 'bold', textAlign: 'center' }}>
            üîê ÎπÑÎ∞ÄÎ≤àÌò∏ ÏûÖÎ†•
          </DialogTitle>
          <DialogContent>
            <Box sx={{ pt: 1, minWidth: 300 }}>
              {error && (
                <Alert severity="error" sx={{ mb: 2, borderRadius: 2 }}>
                  {error}
                </Alert>
              )}
              <TextField
                fullWidth
                type="password"
                label="ÎπÑÎ∞ÄÎ≤àÌò∏"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                onKeyPress={(e) => {
                  if (e.key === 'Enter') {
                    handlePasswordSubmit();
                  }
                }}
                autoFocus
                disabled={loading}
                sx={{
                  '& .MuiOutlinedInput-root': {
                    '&:hover fieldset': { borderColor: '#8e24aa' },
                    '&.Mui-focused fieldset': { borderColor: '#8e24aa' }
                  },
                  '& .MuiInputLabel-root.Mui-focused': { color: '#8e24aa' }
                }}
              />
            </Box>
          </DialogContent>
          <DialogActions sx={{ p: 3, gap: 1 }}>
            <Button 
              onClick={() => setShowPasswordDialog(false)}
              sx={{ color: '#8e24aa' }}
            >
              Ï∑®ÏÜå
            </Button>
            <Button 
              onClick={handlePasswordSubmit}
              variant="contained"
              disabled={loading}
              sx={{ 
                background: 'linear-gradient(135deg, #8e24aa 0%, #5e35b1 100%)',
                '&:hover': { 
                  background: 'linear-gradient(135deg, #7b1fa2 0%, #4a2c7a 100%)'
                },
                boxShadow: '0 4px 15px rgba(142, 36, 170, 0.3)',
                px: 3
              }}
            >
              {loading ? <CircularProgress size={24} /> : 'ÌôïÏù∏'}
            </Button>
          </DialogActions>
        </Dialog>
      </Box>
    );
  }

  // ÌîÑÎ°ùÏãú ÌéòÏù¥ÏßÄ ÌëúÏãú
  if (showProxyPage) {
    return (
      <Box sx={{ minHeight: '100vh', bgcolor: '#f5f5f5' }}>
        {/* ÌîÑÎ°ùÏãú ÌéòÏù¥ÏßÄ Ìó§Îçî */}
        <AppBar position="static" sx={{ 
          bgcolor: 'transparent',
          background: 'linear-gradient(135deg, #8e24aa 0%, #5e35b1 100%)',
          boxShadow: '0 4px 20px rgba(0,0,0,0.1)'
        }}>
          <Toolbar>
            <Typography variant="h6" sx={{ flexGrow: 1 }}>
              {currentLink?.buttonName}
            </Typography>
            <Button 
              color="inherit" 
              onClick={handleCloseProxy}
              startIcon={<CloseIcon />}
            >
              Îã´Í∏∞
            </Button>
          </Toolbar>
        </AppBar>

        {/* iframeÏúºÎ°ú ÌîÑÎ°ùÏãúÎêú HTML ÌëúÏãú */}
        <Box sx={{ height: 'calc(100vh - 64px)' }}>
          <iframe
            srcDoc={proxyHtml}
            style={{
              width: '100%',
              height: '100%',
              border: 'none'
            }}
            title="Ïò®ÏÑ∏Ïùº Í∞ÄÏûÖ ÌéòÏù¥ÏßÄ"
          />
        </Box>
      </Box>
    );
  }

  // Ïù∏Ï¶ù ÏôÑÎ£å - ÎßÅÌÅ¨ Î™©Î°ù ÌëúÏãú
  return (
    <Box sx={{ minHeight: '100vh', bgcolor: '#f5f5f5' }}>
      {/* Ìó§Îçî */}
      <AppBar position="static" sx={{ 
          bgcolor: 'transparent',
          background: 'linear-gradient(135deg, #8e24aa 0%, #5e35b1 100%)',
          boxShadow: '0 4px 20px rgba(0,0,0,0.1)'
        }}>
        <Toolbar>
          <LinkIcon sx={{ mr: 2 }} />
          <Typography variant="h6" sx={{ flexGrow: 1 }}>
            Ïò®ÏÑ∏ÏùºÏ†ëÏàò Î™®Îìú
          </Typography>
          
          <Button
            color="inherit"
            startIcon={<RefreshIcon />}
            onClick={fetchActiveLinks}
            sx={{
              backgroundColor: 'rgba(255,255,255,0.1)',
              '&:hover': { backgroundColor: 'rgba(255,255,255,0.2)' }
            }}
          >
            ÏÉàÎ°úÍ≥†Ïπ®
          </Button>
          
          <Button
            color="inherit"
            startIcon={<UpdateIcon />}
            onClick={() => setShowUpdatePopup(true)}
            sx={{
              ml: 2,
              backgroundColor: 'rgba(255,255,255,0.1)',
              '&:hover': { backgroundColor: 'rgba(255,255,255,0.2)' }
            }}
          >
            ÏóÖÎç∞Ïù¥Ìä∏ ÌôïÏù∏
          </Button>
          
          {onModeChange && availableModes && availableModes.length > 1 && (
            <Button
              color="inherit"
              startIcon={<RefreshIcon />}
              onClick={onModeChange}
              sx={{
                ml: 2,
                backgroundColor: 'rgba(255,255,255,0.1)',
                '&:hover': { backgroundColor: 'rgba(255,255,255,0.2)' }
              }}
            >
              Î™®Îìú Î≥ÄÍ≤Ω
            </Button>
          )}
          
          <Button color="inherit" onClick={onLogout} sx={{ ml: 2 }}>
            Î°úÍ∑∏ÏïÑÏõÉ
          </Button>
        </Toolbar>
      </AppBar>

      {/* Î©îÏù∏ Ïª®ÌÖêÏ∏† */}
      <Box sx={{ p: 3 }}>
        {error && (
          <Alert severity="error" sx={{ mb: 2 }} onClose={() => setError(null)}>
            {error}
          </Alert>
        )}
        
        {success && (
          <Alert severity="success" sx={{ mb: 2 }} onClose={() => setSuccess(null)}>
            {success}
          </Alert>
        )}

        {/* Î©îÏù∏ ÌÉ≠ */}
        <Box sx={{ borderBottom: 1, borderColor: 'divider', mb: 3 }}>
          <Tabs value={tabValue} onChange={handleTabChange}>
            <Tab label="Í∞úÌÜµÏ†ïÎ≥¥ Î™©Î°ù" />
            <Tab label="Í∞ÄÏûÖ Ïã†Ï≤≠ ÎßÅÌÅ¨" />
          </Tabs>
        </Box>

        {/* Í∞úÌÜµÏ†ïÎ≥¥ Î™©Î°ù ÌÉ≠ */}
        <TabPanel value={tabValue} index={0}>
          {/* ÏõîÎ≥Ñ ÌïÑÌÑ∞ÎßÅ (Ï†ëÏàòÎ™®ÎìúÏóêÏÑúÎäî Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ ÌëúÏãú) */}
          <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', mb: 2 }}>
            <FormControl size="small" sx={{ minWidth: 120 }}>
              <InputLabel>ÏõîÎ≥Ñ ÌïÑÌÑ∞</InputLabel>
              <Select
                value={selectedMonth || 'all'}
                label="ÏõîÎ≥Ñ ÌïÑÌÑ∞"
                onChange={handleMonthChange}
              >
                <MenuItem value="all">Ï†ÑÏ≤¥</MenuItem>
                {Array.from({ length: 12 }, (_, i) => {
                  const date = new Date();
                  date.setMonth(date.getMonth() - i);
                  const value = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                  const label = `${date.getFullYear()}ÎÖÑ ${date.getMonth() + 1}Ïõî`;
                  return (
                    <MenuItem key={value} value={value}>
                      {label}
                    </MenuItem>
                  );
                })}
              </Select>
            </FormControl>
          </Box>

          {/* Í∞úÌÜµÏ†ïÎ≥¥ Î™©Î°ù ÌÖåÏù¥Î∏î */}
          <TableContainer 
            component={Paper} 
            sx={{ 
              mb: 2, 
              maxHeight: 600,
              overflow: 'auto'
            }}
          >
            <Table stickyHeader>
              <TableHead>
                <TableRow>
                  <TableCell>Ï†úÏ∂úÏùºÏãú</TableCell>
                  <TableCell>ÏûëÏóÖÏûê</TableCell>
                  <TableCell>Îß§Ïû•Î™Ö</TableCell>
                  <TableCell>Í∞úÌÜµÏú†Ìòï</TableCell>
                  <TableCell>Í≥†Í∞ùÎ™Ö</TableCell>
                  <TableCell>Í∞úÌÜµÎ≤àÌò∏</TableCell>
                  <TableCell>ÏÉùÎÖÑÏõîÏùº</TableCell>
                  <TableCell>Î™®Îç∏Î™Ö</TableCell>
                  <TableCell>ÏùºÎ†®Î≤àÌò∏</TableCell>
                  <TableCell>Ïú†Ïã¨Î™®Îç∏Î™Ö</TableCell>
                  <TableCell>Ïú†Ïã¨ÏùºÎ†®Î≤àÌò∏</TableCell>
                  <TableCell>ÏöîÍ∏àÏ†ú</TableCell>
                  <TableCell>Í∞úÌÜµÏôÑÎ£å</TableCell>
                  <TableCell>Í∞úÌÜµÏãúÍ∞Ñ</TableCell>
                  <TableCell>ÏÉÅÌÉú</TableCell>
                  <TableCell>ÏûëÏóÖ</TableCell>
                </TableRow>
              </TableHead>
              <TableBody>
                {activationLoading ? (
                  <TableRow>
                    <TableCell colSpan={16} align="center">
                      <CircularProgress />
                    </TableCell>
                  </TableRow>
                ) : filteredActivations.length === 0 ? (
                  <TableRow>
                    <TableCell colSpan={16} align="center">
                      Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.
                    </TableCell>
                  </TableRow>
                ) : (
                  filteredActivations
                    .slice(page * rowsPerPage, page * rowsPerPage + rowsPerPage)
                    .map((activation, index) => (
                      <TableRow
                        key={index}
                        sx={{ 
                          backgroundColor: activation.isCompleted ? '#e3f2fd' : 
                                         activation.isCancelled ? '#fce4ec' : 
                                         activation.lastEditor ? '#f1f8e9' : 'inherit',
                          opacity: activation.isCancelled ? 0.7 : 1,
                          cursor: 'default' // Ï†ëÏàòÎ™®ÎìúÏóêÏÑúÎäî ÏÑ†ÌÉù Î∂àÍ∞Ä
                        }}
                      >
                        <TableCell>{activation.submittedAt}</TableCell>
                        <TableCell>
                          {activation.completedBy ? (
                            <Box sx={{ fontSize: '0.8rem', color: 'success.main', fontWeight: 'bold' }}>
                              Í∞úÌÜµ: {activation.completedBy}
                            </Box>
                          ) : activation.cancelledBy ? (
                            <Box sx={{ fontSize: '0.8rem', color: 'error.main' }}>
                              Ï∑®ÏÜå: {activation.cancelledBy}
                            </Box>
                          ) : activation.lastEditor ? (
                            <Box sx={{ fontSize: '0.8rem', color: 'text.secondary' }}>
                              ÏàòÏ†ï: {activation.lastEditor}
                            </Box>
                          ) : (
                            '-'
                          )}
                        </TableCell>
                        <TableCell>{activation.storeName}</TableCell>
                        <TableCell>{activation.activationType}</TableCell>
                        <TableCell>{activation.customerName}</TableCell>
                        <TableCell>{activation.phoneNumber}</TableCell>
                        <TableCell>{activation.birthDate}</TableCell>
                        <TableCell>{activation.modelName}</TableCell>
                        <TableCell>{activation.deviceSerial}</TableCell>
                        <TableCell>{activation.simModel}</TableCell>
                        <TableCell>{activation.simSerial}</TableCell>
                        <TableCell>{activation.plan}</TableCell>
                        <TableCell>
                          {activation.isCompleted ? (
                            <Box>
                              <Box sx={{ fontSize: '0.8rem', color: 'success.main', fontWeight: 'bold' }}>
                                ÏôÑÎ£å: {activation.completedBy}
                              </Box>
                            </Box>
                          ) : (
                            <Box sx={{ fontSize: '0.8rem', color: 'text.secondary' }}>
                              ÎØ∏ÏôÑÎ£å
                            </Box>
                          )}
                        </TableCell>
                        <TableCell>
                          {activation.completedAt ? (
                            <Box sx={{ fontSize: '0.8rem', color: 'text.primary' }}>
                              {activation.completedAt}
                            </Box>
                          ) : (
                            <Box sx={{ fontSize: '0.8rem', color: 'text.secondary' }}>
                              -
                            </Box>
                          )}
                        </TableCell>
                        <TableCell>
                          {activation.isCancelled ? (
                            <Chip label="Ï∑®ÏÜåÎê®" color="error" size="small" />
                          ) : (
                            <Chip label="Ï†ïÏÉÅ" color="success" size="small" />
                          )}
                        </TableCell>
                        <TableCell>
                          <Box sx={{ display: 'flex', gap: 1 }}>
                            <Button
                              size="small"
                              variant="outlined"
                              startIcon={<EditIcon />}
                              onClick={(e) => {
                                e.stopPropagation();
                                handleEditActivation(activation);
                              }}
                            >
                              ÏàòÏ†ï
                            </Button>
                            <Button
                              size="small"
                              variant="outlined"
                              color="error"
                              startIcon={<CancelIcon />}
                              onClick={(e) => {
                                e.stopPropagation();
                                handleCancelActivation(activation);
                              }}
                            >
                              Ï∑®ÏÜå
                            </Button>
                          </Box>
                        </TableCell>
                      </TableRow>
                    ))
                )}
              </TableBody>
            </Table>
          </TableContainer>

          {/* ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò */}
          <TablePagination
            component="div"
            count={filteredActivations.length}
            page={page}
            onPageChange={(event, newPage) => setPage(newPage)}
            rowsPerPage={rowsPerPage}
            onRowsPerPageChange={(event) => {
              setRowsPerPage(parseInt(event.target.value, 10));
              setPage(0);
            }}
            labelRowsPerPage="ÌéòÏù¥ÏßÄÎãπ Ìñâ Ïàò:"
            labelDisplayedRows={({ from, to, count }) => `${from}-${to} / ${count}`}
          />
        </TabPanel>

        {/* Í∞ÄÏûÖ Ïã†Ï≤≠ ÎßÅÌÅ¨ ÌÉ≠ */}
        <TabPanel value={tabValue} index={1}>
          <Typography 
            variant="h5" 
            sx={{ 
              fontWeight: 'bold',
              background: 'linear-gradient(135deg, #8e24aa 0%, #5e35b1 100%)',
              WebkitBackgroundClip: 'text',
              WebkitTextFillColor: 'transparent',
              backgroundClip: 'text',
              textShadow: '0 2px 4px rgba(142, 36, 170, 0.2)',
              mb: 3
            }}
          >
            üîó Í∞ÄÏûÖ Ïã†Ï≤≠ ÎßÅÌÅ¨
          </Typography>

          {loading && activeLinks.length === 0 ? (
          <Box sx={{ textAlign: 'center', p: 4 }}>
            <CircularProgress />
          </Box>
        ) : activeLinks.length === 0 ? (
          <Paper sx={{ p: 4, textAlign: 'center' }}>
            <Typography color="textSecondary">
              ÌôúÏÑ±ÌôîÎêú Í∞ÄÏûÖ ÎßÅÌÅ¨Í∞Ä ÏóÜÏäµÎãàÎã§.
            </Typography>
          </Paper>
        ) : (
          <Grid container spacing={3}>
            {activeLinks.map((link, index) => (
              <Grid item xs={12} sm={6} md={4} key={index}>
                <Card sx={{ 
                  background: 'linear-gradient(135deg, #f8f9ff 0%, #e8eaf6 100%)',
                  border: '1px solid #e1bee7',
                  boxShadow: '0 4px 20px rgba(142, 36, 170, 0.1)',
                  '&:hover': { 
                    boxShadow: '0 8px 30px rgba(142, 36, 170, 0.2)',
                    transform: 'translateY(-2px)'
                  },
                  transition: 'all 0.3s ease'
                }}>
                  <CardContent>
                    <Typography variant="h6" gutterBottom sx={{ color: '#5e35b1', fontWeight: 'bold' }}>
                      {link.buttonName}
                    </Typography>
                    <Typography variant="body2" sx={{ color: '#8e24aa' }}>
                      {link.hideAgentInfo ? '(ÎåÄÎ¶¨Ï†ê Ï†ïÎ≥¥ Î≥¥Ìò∏)' : '(ÏùºÎ∞ò ÎßÅÌÅ¨)'}
                    </Typography>
                    {link.useActivationForm && (
                      <Typography variant="body2" sx={{ color: '#5e35b1', fontWeight: 'bold', mt: 0.5 }}>
                        (Í∞úÌÜµÏñëÏãù ÏÇ¨Ïö©)
                      </Typography>
                    )}
                  </CardContent>
                  <CardActions>
                    <Button
                      fullWidth
                      variant="contained"
                      endIcon={<OpenInNewIcon />}
                      onClick={() => handleLinkClick(link)}
                      disabled={loading}
                      sx={{ 
                        background: 'linear-gradient(135deg, #8e24aa 0%, #5e35b1 100%)',
                        '&:hover': { 
                          background: 'linear-gradient(135deg, #7b1fa2 0%, #4a2c7a 100%)',
                          transform: 'translateY(-1px)'
                        },
                        boxShadow: '0 4px 15px rgba(142, 36, 170, 0.3)',
                        transition: 'all 0.3s ease'
                      }}
                    >
                      Í∞ÄÏûÖ Ïã†Ï≤≠ÌïòÍ∏∞
                    </Button>
                  </CardActions>
                </Card>
              </Grid>
            ))}
          </Grid>
        )}
        </TabPanel>
      </Box>

      {/* ÏóÖÎç∞Ïù¥Ìä∏ ÌåùÏóÖ */}
      <AppUpdatePopup
        open={showUpdatePopup}
        onClose={() => setShowUpdatePopup(false)}
        mode="onSaleReception"
        loggedInStore={loggedInStore}
      />
    </Box>
  );
};

export default OnSaleReceptionMode;
