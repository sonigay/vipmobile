# 기본모드 지도 재고 코드별 표시 기능 구현 체크리스트

## 구현 상태 진단

### ✅ 완료된 항목

#### 1. 백엔드 구현
- [x] **일반모드 로그인 시 폰클출고처데이터에서 코드/사무실/소속/담당자 정보 추가**
  - 위치: `server/index.js` 라인 3690-3710, 4000-4006
  - 구현: `storeDetails`에 `code`, `office`, `department`, `manager` 필드 추가
  - 상태: ✅ 완료 (스프레드 연산자로 전개됨)

- [x] **권한 체크 로직 수정 (Z열에서 'M' 권한 추가)**
  - 위치: `server/index.js` 라인 3741-3742
  - 구현: `agentModePermissionRaw === 'O' || agentModePermissionRaw === 'M'`
  - 상태: ✅ 완료

- [x] **노출 옵션 조회 API 추가 (`/api/map-display-option`)**
  - 위치: `server/index.js` 라인 2373-2430
  - 구현: GET 엔드포인트, 사용자별 옵션 조회
  - 상태: ✅ 완료

- [x] **노출 옵션 저장 API 추가 (`/api/map-display-option`)**
  - 위치: `server/index.js` 라인 2432-2522
  - 구현: POST 엔드포인트, "M" 권한자만 저장 가능
  - 상태: ✅ 완료

- [x] **"O" 사용자 목록 조회 API 추가 (`/api/map-display-option/users`)**
  - 위치: `server/index.js` 라인 2524-2595
  - 구현: 모든 사용자의 옵션 설정을 한 번에 조회 (성능 최적화)
  - 상태: ✅ 완료

- [x] **`/api/stores` 엔드포인트에 코드/사무실/소속/담당자 정보 추가**
  - 위치: `server/index.js` 라인 2332-2355
  - 구현: store 객체에 `code`, `office`, `department`, `managerForFilter` 필드 추가
  - 상태: ✅ 완료

#### 2. 프론트엔드 구현
- [x] **`App.js`에 노출 옵션 상태 추가**
  - 위치: `src/App.js` 라인 172-174
  - 구현: `mapDisplayOption`, `mapDisplayOptionLoading` 상태
  - 상태: ✅ 완료

- [x] **노출 옵션 로드 함수 추가**
  - 위치: `src/App.js` 라인 1163-1202
  - 구현: `loadMapDisplayOption` 함수, 고객모드 제외
  - 상태: ✅ 완료

- [x] **필터링 로직에 노출 옵션 적용**
  - 위치: `src/App.js` 라인 1292-1336
  - 구현: 고객모드 제외, 일반모드/관리자모드 구분 필터링
  - 상태: ✅ 완료

- [x] **`Header.js`에 "M" 권한자용 노출 옵션 설정 모달 추가**
  - 위치: `src/components/Header.js` 라인 635-885
  - 구현: 지도 아이콘 버튼, 모달 UI, 관리자모드/일반모드 탭 구분
  - 상태: ✅ 완료

- [x] **관리자 로그인 시 `agentInfo` 전달**
  - 위치: `src/components/Login.js` 라인 301-314
  - 구현: `agentInfo` 전체 전달 (agentModePermission 포함)
  - 상태: ✅ 완료

- [x] **담당자 필드 불일치 문제 해결**
  - 위치: `server/index.js` 라인 2343, `src/App.js` 라인 1331
  - 구현: `managerForFilter` 필드 추가, 필터링 로직에서 우선 사용
  - 상태: ✅ 완료

## 발견된 문제점 및 개선 필요 사항

### 🟡 개선 권장 사항

#### 1. 관리자모드 옵션값 선택 UI 개선
- **위치**: `src/components/Header.js` 라인 882-895
- **현재 상태**: 텍스트 입력 (TextField)
- **문제점**: 
  - 코드별/사무실별/소속별/담당자별 선택 시 수동으로 입력해야 함
  - 오타나 잘못된 값 입력 가능
- **개선 제안**: 
  - 옵션이 코드별/사무실별/소속별/담당자별일 때 드롭다운으로 선택 가능하도록
  - `/api/stores`에서 고유값 목록을 가져와서 드롭다운으로 표시

#### 2. 일반모드 사용자 옵션 선택 UI 누락
- **요구사항**: "일반모드 사용자: 옵션만 선택 (자동으로 본인 속성값 적용)"
- **현재 상태**: 일반모드 사용자가 옵션을 선택할 수 있는 UI 없음
- **개선 필요**: 
  - 기본모드 화면에 옵션 선택 UI 추가 (Header 또는 지도 위에)
  - 옵션 선택 시 자동으로 본인 속성값으로 필터링
  - "M" 권한자가 아닌 일반 사용자도 자신의 옵션을 선택할 수 있어야 함

#### 3. 관리자모드 필터링 - 옵션값이 없을 때 처리
- **위치**: `src/App.js` 라인 1318-1336
- **현재 코드**: `optionValue`가 있을 때만 필터링
- **문제점**: 
  - 옵션이 "전체"가 아닌데 `optionValue`가 비어있으면 필터링이 적용되지 않음
  - 사용자가 옵션을 설정했지만 값이 없어서 필터링이 안 될 수 있음
- **개선 필요**: 
  - 옵션이 "전체"가 아닐 때는 경고 표시 또는 기본값 처리
  - 또는 옵션값이 필수인 경우 저장 시 검증

#### 4. 고객모드 체크 로직 확인
- **위치**: `src/App.js` 라인 1167, 1293
- **현재 코드**: `const isCustomerMode = loggedInStore?.modePermissions?.customerMode;`
- **확인 필요**: 
  - 실제 고객모드 권한이 `modePermissions.customerMode`로 설정되는지 확인
  - 다른 방식으로 체크해야 하는지 확인 (예: `isCustomerMode` 플래그)
- **개선 필요**: 
  - 고객모드 로그인 시 실제로 이 권한이 설정되는지 확인
  - 필요시 다른 방식으로 체크하도록 수정

#### 5. 일반모드 사용자 - 옵션 저장 권한 확인
- **요구사항**: "일반모드 사용자: 옵션만 선택 (자동으로 본인 속성값 적용)"
- **현재 상태**: 일반모드 사용자가 자신의 옵션을 저장할 수 있는지 불명확
- **확인 필요**: 
  - 일반모드 사용자가 자신의 옵션을 저장할 수 있는지
  - 아니면 "M" 권한자만 저장 가능한지
- **개선 필요**: 
  - 요구사항에 따라 일반모드 사용자도 자신의 옵션을 저장할 수 있도록 API 수정 필요할 수 있음

## 최종 체크리스트 요약

### ✅ 완전히 구현된 기능
1. ✅ 백엔드 API 구현 (조회, 저장, 사용자 목록)
2. ✅ 프론트엔드 필터링 로직
3. ✅ "M" 권한자용 옵션 설정 모달
4. ✅ 일반모드 로그인 시 정보 추가
5. ✅ 담당자 필드 불일치 문제 해결
6. ✅ 고객모드 제외 로직
7. ✅ 관리자모드/일반모드 구분 필터링

### 🟡 개선 가능한 기능 (선택 사항)
1. 관리자모드 옵션값 선택 UI (드롭다운)
2. 일반모드 사용자 옵션 선택 UI
3. 관리자모드 필터링 기본값 처리
4. 고객모드 체크 로직 확인

### 📝 테스트 필요 사항
1. 일반모드 로그인 후 필터링이 제대로 작동하는지
2. 관리자모드에서 옵션 설정 후 필터링이 제대로 작동하는지
3. 고객모드에서 필터링이 적용되지 않는지
4. 담당자별 필터링이 올바른 필드(F열)로 작동하는지
5. 코드별/사무실별/소속별 필터링이 올바르게 작동하는지

## 발견된 버그 및 수정 완료

### ✅ 수정 완료
1. **담당자 필드 불일치 문제** ✅
   - 문제: `/api/stores`의 `manager` 필드(V열)와 필터링 기준(F열) 불일치
   - 해결: `managerForFilter` 필드 추가 및 필터링 로직 수정

2. **일반모드 로그인 시 정보 전달** ✅
   - 확인: `store` 객체에 모든 필드 포함 확인 완료

## 개선 제안 우선순위

### 우선순위 높음 (기능 완성도 향상)
1. **일반모드 사용자 옵션 선택 UI 추가**
   - 요구사항에 명시된 기능이므로 구현 필요
   - 기본모드 화면에 옵션 선택 UI 추가

2. **관리자모드 옵션값 선택 UI 개선**
   - 사용성 향상을 위해 드롭다운으로 개선

### 우선순위 중간 (안정성 향상)
3. **관리자모드 필터링 기본값 처리**
   - 옵션값이 없을 때의 처리 로직 개선

4. **고객모드 체크 로직 확인**
   - 실제 고객모드 권한 체크 방식 확인 및 수정
