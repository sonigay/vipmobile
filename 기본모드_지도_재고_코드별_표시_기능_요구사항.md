# 기본모드 지도 재고 코드별 표시 기능 요구사항

## 개요
관리자모드와 일반모드의 기본모드에서 지도상에 재고를 코드별로만 확인할 수 있는 기능을 추가합니다.

## 기능 요구사항

### 1. 지도상 재고 표시 기능
- **대상 모드**: 관리자모드, 일반모드의 기본모드
- **제외 모드**: 고객모드 (노출 옵션 영향 없음, 항상 전체 표시)
- **기능**: 지도상에 재고를 필터링하여 확인하는 기능 추가
- **데이터 소스**: 폰클출고처데이터 시트
- **마커 좌표**:
  - 위도: 8인덱스 I열
  - 경도: 9인덱스 J열
- **중요**: 고객모드에서는 노출 옵션 설정과 관계없이 항상 전체 데이터 표시

### 2. 노출 옵션
- **옵션 종류**:
  1. **코드별**: 폰클출고처데이터 시트의 7인덱스 H열 기준
  2. **사무실별**: 폰클출고처데이터 시트의 3인덱스 D열 기준
  3. **소속별**: 폰클출고처데이터 시트의 4인덱스 E열 기준
  4. **담당자별**: 폰클출고처데이터 시트의 5인덱스 F열 기준
  5. **전체**: 모든 데이터 표시

### 3. 마커 표시 로직
- **현재 상태**: 폰클출고처데이터 시트의 위도(I열), 경도(J열)로 지도상에 마커 설정
- **필터링 로직**:
  - 선택한 옵션에 따라 해당 옵션 컬럼의 동일한 값만 지도상에 마커 표시
  - 예: 코드별 선택 시 → H열 값이 동일한 행들만 마커 표시
  - 예: 사무실별 선택 시 → D열 값이 동일한 행들만 마커 표시
  - 예: 소속별 선택 시 → E열 값이 동일한 행들만 마커 표시
  - 예: 담당자별 선택 시 → F열 값이 동일한 행들만 마커 표시
  - 예: 전체 선택 시 → 모든 행의 마커 표시
- **동일 행 기준**: 같은 시트의 같은 행 값이므로 해당 옵션 컬럼의 값으로 필터링

### 4. 표시 옵션 통제 기능
- **기능**: 노출 옵션 선택 및 변경 기능
- **권한**: "M" 권한자만 수정 가능
- **통제 대상**: 노출 옵션 선택 (코드별/사무실별/소속별/담당자별/전체)

### 5. 권한 설정
- **시트**: 대리점아이디관리 시트
- **컬럼**: 25인덱스 Z열 (관리자모드 접근 권한)
- **현재 권한**: "O"
- **추가 권한**: "M"
- **"M" 권한자 권한**:
  - 재고노출옵션에 대한 수정 권한 보유
  - 코드별로만 보일지, 전체 다 보일지 통제 가능

## 기존 코드 분석

### 1. 프론트엔드 구조
- **파일**: `src/App.js`
  - 기본모드 상태 관리 (`isAgentMode`, `loggedInStore`)
  - 데이터 로딩 (`loadData` 함수)
  - 매장 필터링 (`filteredStores` 상태)
  - 지도 컴포넌트 렌더링

- **파일**: `src/components/Map.js`
  - 지도 마커 표시 로직
  - `filteredStores`를 받아서 마커로 표시
  - 위도/경도 기반 마커 생성

### 2. 백엔드 구조
- **파일**: `server/index.js`
  - **엔드포인트**: `/api/stores` (라인 2198)
    - 폰클출고처데이터 시트 읽기 (`STORE_SHEET_NAME = '폰클출고처데이터'`)
    - 재고 데이터와 매장 정보 결합
    - 위도(I열, 8인덱스), 경도(J열, 9인덱스) 반환
  - **권한 체크**: 대리점아이디관리 시트의 Z열(25인덱스) 확인
    - 현재: `agent[25] === 'O'` (라인 3510)
    - 수정 필요: `agent[25] === 'O' || agent[25] === 'M'`

### 3. 폰클출고처데이터 시트 구조
- **D열 (3인덱스)**: 사무실
- **E열 (4인덱스)**: 소속
- **F열 (5인덱스)**: 담당자
- **H열 (7인덱스)**: 코드
- **I열 (8인덱스)**: 위도
- **J열 (9인덱스)**: 경도

## 구글시트 설정

### 시트 이름
**`지도재고노출옵션`**

### 컬럼 헤더 (자동 생성)
| 컬럼 | 인덱스 | 헤더명 | 설명 | 데이터 타입 |
|------|--------|--------|------|-------------|
| A | 0 | 사용자ID | 일반모드권한관리 시트의 A열(사용자ID/POS코드) 또는 대리점아이디관리 시트의 연락처ID | 텍스트 |
| B | 1 | 모드구분 | 관리자모드 또는 일반모드 | 텍스트 |
| C | 2 | 노출옵션 | 선택된 노출 옵션 (코드별/사무실별/소속별/담당자별/전체) | 텍스트 |
| D | 3 | 선택값 | 해당 옵션의 선택된 값 (일반모드는 자동으로 본인 속성값 사용, 관리자모드는 "M" 권한자가 설정) | 텍스트 |
| E | 4 | 수정일시 | 옵션 수정 일시 | 날짜/시간 |
| F | 5 | 수정자 | 수정한 사용자 이름 ("M" 권한자) | 텍스트 |

### 시트 생성 시 주의사항
1. 첫 번째 행에 헤더를 입력
2. A열부터 F열까지 헤더 설정
3. 데이터는 2행부터 입력
4. 모드구분(B열) 값: "관리자모드" 또는 "일반모드"

## 구현 계획

### 1. 백엔드 수정
- [ ] 일반모드 로그인 시 폰클출고처데이터에서 코드/사무실/소속/담당자 정보 추가
- [ ] `/api/stores` 엔드포인트에 필터링 로직 추가
  - 일반모드: 로그인한 사용자의 속성값으로 자동 필터링
  - 관리자모드: 저장된 옵션에 따라 필터링
- [ ] 노출 옵션 조회 API 추가 (`/api/map-display-option`)
  - 사용자별 옵션 조회
  - "M" 권한자: 모든 "O" 사용자 목록과 옵션 조회
  - 관리자모드/일반모드 구분하여 조회
- [ ] 노출 옵션 저장 API 추가 (`/api/map-display-option`)
  - "M" 권한자만 저장 가능
  - "O" 사용자별로 관리자모드/일반모드 구분하여 옵션 설정
- [ ] 권한 체크 로직 수정 (Z열에서 "M" 권한 추가)

### 2. 프론트엔드 수정
- [ ] `App.js`에 노출 옵션 상태 추가
- [ ] `Map.js`에 필터링된 마커 표시 로직 추가
  - 고객모드(`isCustomerMode`) 체크하여 필터링 로직 건너뛰기
  - 일반모드: 로그인한 사용자의 속성값으로 자동 필터링
  - 관리자모드: 저장된 옵션에 따라 필터링
- [ ] 노출 옵션 선택 UI 추가
  - "M" 권한자: 모달로 "O" 사용자 목록 표시, 각 사용자별로 관리자모드/일반모드 구분하여 옵션 설정
  - 일반모드 사용자: 옵션만 선택 (자동으로 본인 속성값 적용)
  - 고객모드에서는 표시 안 함
- [ ] 옵션 변경 시 API 호출하여 저장

### 3. 필터링 로직
- **적용 대상**: 관리자모드, 일반모드의 기본모드만 적용
- **고객모드**: 필터링 적용 안 함 (항상 전체 표시)
- **모드별 옵션 적용**:
  - 관리자모드: "M" 권한자가 설정한 옵션에 따라 필터링
  - 일반모드: "M" 권한자가 설정한 옵션에 따라 필터링 (본인 속성값 자동 적용)
- **필터링 옵션**:
  - 코드별: H열(7인덱스) 값이 동일한 행만 표시
  - 사무실별: D열(3인덱스) 값이 동일한 행만 표시
  - 소속별: E열(4인덱스) 값이 동일한 행만 표시
  - 담당자별: F열(5인덱스) 값이 동일한 행만 표시
  - 전체: 모든 행 표시

## 추가 요구사항

### 1. 노출 옵션 저장 범위
- **사용자별 저장**: 각 사용자별로 옵션 설정 저장
- **모드별 구분**: 관리자모드와 일반모드를 구분하여 옵션 설정
- **"M" 권한자만 설정 가능**: "M" 권한자가 "O" 사용자의 옵션을 설정
- **UI**: 모달로 "O" 사용자 목록 표시, 각 사용자별로 관리자모드/일반모드 구분하여 옵션 설정

### 2. "M" 권한자 권한
- **다른 사용자 옵션 설정**: "O" 사용자의 옵션을 설정할 수 있음
- **모달 UI**: "O" 사용자 목록과 각 사용자별 옵션 설정 UI 제공

### 3. 옵션 선택값
- **자동 매칭**: 현재 로그인한 사용자의 코드/사무실/소속/담당자와 동일한 값만 표시
- **코드별**: 사용자의 코드와 동일한 행만 표시
- **사무실별**: 사용자의 사무실과 동일한 행만 표시
- **소속별**: 사용자의 소속과 동일한 행만 표시
- **담당자별**: 사용자의 담당자와 동일한 행만 표시

### 4. 기본값
- **옵션 미설정 시**: 전체 표시 (기본값)

### 5. 관리자모드와 일반모드
- **동일한 옵션 사용**: 두 모드 모두 동일한 옵션 시스템 사용
- **일반모드 특수 처리**: 
  - 사용자가 많아 개별 설정 어려움
  - 코드/사무실/소속/담당자 옵션 선택 시, **본인이 속한 옵션값만 자동으로 표시**
  - 예: 코드별 선택 시 → 로그인한 사용자의 코드와 동일한 행만 표시

## 일반모드 사용자 정보 매칭 분석

### 현재 구조
1. **일반모드 로그인** (`server/index.js` 라인 3627-3779):
   - 일반모드권한관리 시트에서 사용자 검색
   - A열(0): 사용자ID(POS코드)
   - B열(1): 업체명
   - C열(2): 그룹

2. **폰클출고처데이터 매칭** (라인 3698-3709):
   - `row[15] === storeId`로 매칭 (H열: 매장 ID)
   - 현재 가져오는 정보: 위도, 경도, 주소, 전화번호
   - **추가 필요**: 코드, 사무실, 소속, 담당자

### 폰클출고처데이터 시트 구조
- **D열 (3인덱스)**: 사무실
- **E열 (4인덱스)**: 소속
- **F열 (5인덱스)**: 담당자
- **H열 (7인덱스)**: 코드
- **H열 (15인덱스)**: 매장 ID (일반모드 사용자ID와 매칭)

### 구현 필요 사항
1. **로그인 시 사용자 정보 확장**:
   - 일반모드 로그인 시 폰클출고처데이터에서 코드/사무실/소속/담당자 정보 추가
   - `loggedInStore` 객체에 `code`, `office`, `department`, `manager` 필드 추가

2. **필터링 로직**:
   - 일반모드: 로그인한 사용자의 코드/사무실/소속/담당자와 동일한 값만 표시
   - 관리자모드: "M" 권한자가 설정한 옵션에 따라 필터링

3. **옵션 저장 구조**:
   - 사용자ID별로 옵션 저장
   - 일반모드: 옵션 선택 시 자동으로 본인 속성값으로 필터링
   - 관리자모드: "M" 권한자가 "O" 사용자별로 옵션 설정

## 구현 상태
- [x] 요구사항 정리 완료
- [x] 기존 코드 분석 완료
- [x] 구글시트 구조 설계 완료
- [ ] 구현 시작 대기 중
