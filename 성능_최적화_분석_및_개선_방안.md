# 성능 최적화 분석 및 개선 방안

## 📅 작성 일시
2025-01-14

---

## 🔍 서버 로그 분석 결과

### 발견된 성능 문제

#### 1. **계산 시간이 과도하게 길음** 🔴

**로그 분석:**
- `/api/direct/todays-mobiles` - **11,899ms** (약 12초)
- 각 `/calculate` 호출 - **4-11초**씩 소요
- Rate limit 재시도로 인해 일부는 **58초**까지 소요

**예시:**
```
✅ [2025-12-14T11:17:08.271Z] GET /api/direct/todays-mobiles - 200 - 11899ms
✅ [2025-12-14T11:17:24.686Z] GET /api/direct/mobiles/mobile-LG-1/calculate?planGroup=115군&openingType=010신규 - 200 - 4697ms
✅ [2025-12-14T11:17:25.176Z] GET /api/direct/mobiles/mobile-LG-35/calculate?planGroup=33군&openingType=기변 - 200 - 58599ms (58초!)
```

#### 2. **Rate Limit 에러로 인한 재시도** 🔴

**로그 분석:**
- Google Sheets API 호출 빈도 제한으로 인한 재시도
- 최대 5회 재시도 (지수 백오프)
- 재시도 시간: 2003ms → 4026ms → 8544ms → 16262ms

**예시:**
```
[Direct] Rate limit 에러 발생, 2003ms 후 재시도 (1/5)
[Direct] Rate limit 에러 발생, 4026ms 후 재시도 (2/5)
[Direct] Rate limit 에러 발생, 8544ms 후 재시도 (3/5)
[Direct] Rate limit 에러 발생, 16262ms 후 재시도 (4/5)
```

#### 3. **프론트엔드 대기 로직 문제** ⚠️

**현재 구조:**
- `isInitializing` 상태로 **모든 계산이 완료될 때까지** 기다림
- 최대 **150초(2.5분)** 대기
- 모든 상품의 모든 유형(010신규, MNP, 기변)이 완료될 때까지 화면 표시 안 함

**코드 위치:**
```javascript
// src/components/direct/TodaysMobileTab.js:823
if (loading || isInitializing) {
  return (
    <Box>
      <CircularProgress />
      <Typography>
        {isInitializing ? '가격 정보를 계산하는 중...' : '데이터를 불러오는 중...'}
      </Typography>
    </Box>
  );
}
```

#### 4. **중복 계산 및 비효율적인 호출** ⚠️

**로그 분석:**
- 같은 모델에 대해 여러 개통유형(010신규, MNP, 기변)으로 각각 API 호출
- 여러 모델이 동시에 계산 요청됨
- 캐시 활용이 제한적

---

## 📊 성능 메트릭스

### 현재 성능 지표

| 항목 | 현재 값 | 목표 값 | 개선 필요도 |
|------|---------|---------|------------|
| 초기 로딩 시간 | 12초 | < 3초 | 🔴 높음 |
| 개별 계산 시간 | 4-11초 | < 2초 | 🔴 높음 |
| Rate limit 재시도 | 4-5회 | 0-1회 | 🔴 높음 |
| 최대 대기 시간 | 150초 | < 30초 | 🔴 높음 |
| 사용자 대기 화면 | 2.5분 | < 10초 | 🔴 높음 |

---

## 🎯 개선 방안

### 1. 프론트엔드: 점진적 로딩 (Progressive Loading) ✅ **즉시 적용 가능**

#### 문제점
- 현재: 모든 계산이 완료될 때까지 화면을 표시하지 않음
- 결과: 사용자가 2.5분 동안 "가격 정보를 계산하는 중..." 화면만 봄

#### 해결 방안
- **점진적 표시**: 계산이 완료된 상품부터 즉시 표시
- **부분 로딩**: 일부 상품의 가격이 계산되면 해당 상품만 표시
- **최대 대기 시간 단축**: 150초 → 30초로 단축

#### 예상 효과
- 사용자 대기 시간: **2.5분 → 10-30초**
- 사용자 경험: **크게 개선**

#### 구현 방법
```javascript
// 현재: 모든 계산 완료 대기
if (loading || isInitializing) {
  return <LoadingScreen />;
}

// 개선: 부분 로딩 허용
if (loading) {
  return <LoadingScreen />;
}

// isInitializing일 때도 상품 표시 (로딩 중인 가격은 스켈레톤 표시)
return (
  <ProductList>
    {products.map(product => (
      <ProductCard 
        product={product}
        priceData={calculatedPrices[product.id]} // 일부만 완료되어도 표시
        isLoading={priceData?.loading}
      />
    ))}
  </ProductList>
);
```

---

### 2. 서버: Rate Limit 최적화 ✅ **즉시 적용 가능**

#### 문제점
- Google Sheets API 호출 빈도 제한으로 인한 재시도
- 현재: 최대 5회 재시도, 지수 백오프로 인해 최대 58초 소요

#### 해결 방안
- **캐싱 강화**: 계산 결과를 더 오래 캐시 (현재 5분 → 30분)
- **배치 처리**: 여러 계산을 한 번에 처리
- **우선순위 큐**: 중요한 계산을 먼저 처리
- **Rate limit 예측**: API 호출 전에 대기 시간 계산

#### 예상 효과
- Rate limit 재시도: **4-5회 → 0-1회**
- 계산 시간: **4-11초 → 2-5초**

---

### 3. 서버: 계산 최적화 ✅ **즉시 적용 가능**

#### 문제점
- 각 계산마다 Google Sheets API 호출
- 중복 호출 발생 가능

#### 해결 방안
- **배치 API 호출**: 여러 계산을 한 번에 처리
- **캐싱 전략 개선**: 계산 결과를 더 오래 캐시
- **병렬 처리**: 여러 계산을 동시에 처리

#### 예상 효과
- 계산 시간: **4-11초 → 2-5초**
- API 호출 수: **30-50% 감소**

---

### 4. 프론트엔드: 계산 우선순위 조정 ✅ **즉시 적용 가능**

#### 문제점
- 모든 상품의 모든 유형을 동시에 계산
- 사용자가 보는 첫 화면의 상품 계산이 늦어질 수 있음

#### 해결 방안
- **우선순위 계산**: 첫 화면에 보이는 상품부터 계산
- **지연 로딩**: 보이지 않는 상품은 나중에 계산
- **점진적 계산**: 중요한 유형(010신규)부터 먼저 계산

#### 예상 효과
- 첫 화면 표시 시간: **12초 → 3-5초**
- 사용자 경험: **크게 개선**

---

### 5. 캐싱 전략 개선 ✅ **즉시 적용 가능**

#### 문제점
- 계산 결과 캐시가 짧음 (5분)
- 같은 계산을 반복 수행

#### 해결 방안
- **캐시 TTL 증가**: 5분 → 30분
- **브라우저 캐시 활용**: HTTP 캐싱 헤더 추가
- **서버 측 캐싱**: Redis 등 사용

#### 예상 효과
- 중복 계산: **50-70% 감소**
- 계산 시간: **30-50% 단축**

---

## 📋 우선순위별 개선 계획

### 🔴 최우선 (즉시 적용)

1. **프론트엔드 점진적 로딩**
   - 예상 소요 시간: 2-3시간
   - 예상 효과: 사용자 대기 시간 90% 감소
   - 구현 난이도: 중

2. **최대 대기 시간 단축**
   - 예상 소요 시간: 30분
   - 예상 효과: 최대 대기 시간 150초 → 30초
   - 구현 난이도: 낮음

### 🟡 높은 우선순위 (1주일 내)

3. **서버 Rate Limit 최적화**
   - 예상 소요 시간: 4-6시간
   - 예상 효과: Rate limit 재시도 80% 감소
   - 구현 난이도: 중

4. **캐싱 전략 개선**
   - 예상 소요 시간: 2-3시간
   - 예상 효과: 중복 계산 50-70% 감소
   - 구현 난이도: 낮음

### 🟢 중간 우선순위 (2주일 내)

5. **계산 우선순위 조정**
   - 예상 소요 시간: 3-4시간
   - 예상 효과: 첫 화면 표시 시간 60% 단축
   - 구현 난이도: 중

6. **배치 처리 도입**
   - 예상 소요 시간: 1-2일
   - 예상 효과: 계산 시간 30-50% 단축
   - 구현 난이도: 높음

---

## 📊 예상 개선 효과

### 사용자 경험 개선

| 항목 | 현재 | 개선 후 | 개선율 |
|------|------|---------|--------|
| 초기 로딩 시간 | 12초 | 3-5초 | **60-75% 감소** |
| 사용자 대기 시간 | 2.5분 | 10-30초 | **80-93% 감소** |
| 첫 화면 표시 시간 | 12초 | 3-5초 | **60-75% 감소** |

### 서버 성능 개선

| 항목 | 현재 | 개선 후 | 개선율 |
|------|------|---------|--------|
| 개별 계산 시간 | 4-11초 | 2-5초 | **50-55% 감소** |
| Rate limit 재시도 | 4-5회 | 0-1회 | **80-100% 감소** |
| API 호출 수 | 높음 | 중간 | **30-50% 감소** |

---

## ✅ 결론

**현재 상태:**
- ✅ 리팩토링은 정상적으로 완료됨
- ✅ 계산 로직은 정확하게 작동함
- ⚠️ **성능 최적화가 필요함**

**주요 문제:**
1. Rate limit으로 인한 지연 (서버 측)
2. 모든 계산 완료 대기 (프론트엔드)
3. 캐싱 전략 미흡

**개선 방안:**
1. 프론트엔드 점진적 로딩 (최우선)
2. 서버 Rate Limit 최적화
3. 캐싱 전략 개선

**예상 효과:**
- 사용자 대기 시간: **2.5분 → 10-30초** (80-93% 감소)
- 초기 로딩 시간: **12초 → 3-5초** (60-75% 감소)

---

## 🔄 다음 단계

1. **즉시 적용**: 프론트엔드 점진적 로딩 구현
2. **1주일 내**: 서버 Rate Limit 최적화
3. **2주일 내**: 캐싱 전략 개선 및 배치 처리 도입

