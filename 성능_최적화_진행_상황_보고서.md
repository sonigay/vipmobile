# 성능 최적화 진행 상황 보고서

## 📅 작성 일시
2025-01-14

---

## 🎯 목표

모든 탭의 성능 문제를 디버그 로그를 통해 파악하고, 개선 사항을 하나씩 해결해나가며, 최종적으로 남는 문제만 디버그 로그를 유지하여 완벽한 디버그를 완료하는 것.

---

## 📊 디버그 로그 추가 현황

### ✅ 완료된 작업

#### 1. 프론트엔드 디버그 로그 추가

##### 직영점 모드
- ✅ **TodaysMobileTab.js**
  - `handlePriceCalculated`: 가격 계산 완료 콜백 호출 시
  - `useEffect` (계산 상태 확인): 계산 완료 여부 체크 시
  - `useEffect` (초기화): 가격 계산 초기화 시작 시
  
- ✅ **TodaysProductCard.js**
  - `loadPrices`: API 호출 시작/완료/실패 시
  - 가격 데이터 로드 완료 시

- ✅ **MobileListTab.js**
  - `fetchMobileList`: 휴대폰 목록 로드 시작/완료 시
  - `calculatePriceInternal`: 가격 계산 시작/완료 시

- ✅ **DirectSalesReportTab.js**
  - `fetchSalesData`: 판매일보 로드 시작/완료/실패 시
  - `handleStatusUpdate`: 상태 업데이트 시작/완료 시

- ✅ **OpeningInfoPage.js**
  - `loadPlanGroups`: 요금제 그룹 로드 시작 시
  - 가격 계산 시작/완료 시

##### 직영점관리 모드
- ✅ **PolicySettingsTab.js**
  - `loadSettings`: 정책 설정 로드 시작/완료 시
  - `handleSave`: 정책 설정 저장 시작/완료 시

- ✅ **LinkSettingsTab.js**
  - `loadSettings`: 링크 설정 로드 시작/완료 시
  - `handleSave`: 링크 설정 저장 시작/완료 시

- ✅ **MainPageTextSettingsTab.js**
  - `loadData`: 문구 설정 로드 시작/완료 시
  - `handleSaveMainHeader`: 메인헤더 저장 시작/완료 시
  - `handleSaveTransition`: 전환 페이지 저장 시작/완료 시

#### 2. 서버 측 디버그 로그 추가

- ✅ **directRoutes.js** (`/calculate` 엔드포인트)
  - 요청 진입 시
  - 응답 반환 시
  - 에러 발생 시

---

## 🔍 발견된 문제 및 개선 현황

### 🔴 최우선 문제 (진행 중)

#### 1. 가격 계산 멈춤 문제
- **상태**: 🔄 휴대폰 목록 페이지 디버깅 중
- **증상**: "가격 정보를 계산하는 중..." 화면이 지속되고 서버 로그도 멈춤
- **원인 분석**:
  - `getPriceDataFromCache`가 캐시가 없을 때도 `loading: true`인 priceData 객체를 반환
  - 이 priceData가 `TodaysProductCard`에 propPriceData로 전달됨
  - `TodaysProductCard`의 useEffect에서 propPriceData가 있으면 스킵 조건이 있었지만, loading이 true인 경우에도 스킵될 수 있었음
  - 결과적으로 API 호출이 시작되지 않아 가격 계산이 멈춤
- **해결 방법**:
  1. `getPriceDataFromCache`가 캐시가 없을 때 null을 반환하도록 수정 (주석과 일치하도록)
  2. `calculatedPricesRef`에 데이터가 있지만 아직 로딩 중인 경우에도 null 반환하여 ProductCard에서 계속 로드하도록 함
  3. `TodaysProductCard`의 useEffect 스킵 조건을 개선하여 모든 유형이 로드 완료되었을 때만 스킵하도록 수정
- **수정 파일**:
  - `src/components/direct/TodaysMobileTab.js`: `getPriceDataFromCache` 함수 수정
  - `src/components/direct/TodaysProductCard.js`: useEffect 스킵 조건 개선
- **다음 단계**: 수정 사항 검증 및 추가 문제 확인

#### 2. 휴대폰 목록 페이지 가격 계산 완료 문제
- **상태**: ✅ 해결 완료
- **증상**: 가격 계산은 계속 이루어지지만 상품이 로드되지 않음 ("가격 정보를 계산하는 중..." 화면 지속)
- **원인 분석**:
  - `setDefaultValues`가 `mobileList`나 `planGroups` 변경 시마다 반복 호출되어 `expectedCalculationsRef`에 중복 추가
  - 초기화 완료 조건이 `queueEmpty && notProcessing && allCalculated`로 되어 있어, 큐가 비어있지 않으면 초기화가 완료되지 않음
  - 가격 계산은 정상적으로 진행되고 있었지만, 큐가 비어있지 않아 초기화가 완료되지 않음
- **해결 방법**:
  1. `setDefaultValues`에서 이미 초기화 중이면 스킵하도록 수정 (중복 호출 방지)
  2. 초기화 완료 조건을 `allCalculated && notProcessing`로 완화하여, 큐에 남은 항목이 있어도 모든 예상 모델의 계산이 완료되면 초기화 완료하도록 수정
  3. 초기화 완료 후 `isInitializing` 상태 동기화 로직 추가
- **수정 파일**:
  - `src/components/direct/MobileListTab.js`: `setDefaultValues` 중복 호출 방지 로직 추가
  - `src/components/direct/MobileListTab.js`: 초기화 완료 조건 완화
  - `src/components/direct/MobileListTab.js`: `isInitializing` 상태 동기화 로직 추가

#### 3. 이통사지원금 openingType별 값 표시 오류
- **상태**: ✅ 해결 완료
- **증상**: 
  - MNP 상태에서 010신규/기변의 금액이 표시됨
  - 기변을 선택하면 MNP 금액이 표시됨
- **원인 분석**:
  - `calculatedPrices`가 `modelId`만 키로 사용하여, 같은 모델의 다른 `openingType` 값들이 덮어씌워짐
  - 예: MNP로 계산한 값이 저장된 후, 기변으로 계산하면 기변 값이 MNP 값을 덮어씀
  - `getDisplayValue`가 현재 선택된 `openingType`을 고려하지 않고 `calculatedPrices[modelId]`에서 값을 가져옴
  - 캐시에서 값을 가져올 때도 `modelId`만 키로 사용하여 `openingType`별 값이 저장되지 않음
  - `mobileList`의 `publicSupport`가 `rowValue`로 사용되어 유형 변경 시 잘못된 값이 표시됨
  - `calculatedPrices`에 저장된 값의 `openingType`이 현재 선택된 `openingType`과 일치하지 않을 수 있음
- **해결 방법**:
  1. `calculatedPrices`의 키를 `modelId-openingType` 형식으로 변경하여 각 `openingType`별로 값을 별도 저장
  2. `getDisplayValue` 함수에 `selectedOpeningType` 파라미터 추가하여 현재 선택된 `openingType`에 맞는 값을 가져오도록 수정
  3. `MobileListRow`에서 `getDisplayValue` 호출 시 `selectedOpeningType` 전달 (모든 필드에 적용)
  4. 초기화 완료 체크 로직에서 `calculatedPrices` 키에서 `modelId`만 추출하도록 수정
  5. 캐시에서 값을 가져올 때도 `modelId-openingType` 형식으로 저장하도록 수정
  6. `mobileList` 업데이트 제거 (서버 초기값 유지, `calculatedPrices`에서만 값을 가져옴)
  7. `getDisplayValue`에서 `calculated.openingType`과 현재 `openingType` 일치 여부 확인
  8. `getDisplayValue`에서 `openingType`이 `null`일 때 기본값 'MNP' 사용 (초기 로드 시 `selectedOpeningTypes`가 빈 객체일 수 있음)
  9. `getDisplayValue`의 의존성 배열에 `selectedOpeningTypes` 추가
  10. `calculatedPrice` prop 전달 시에도 기본값 'MNP' 사용
- **수정 파일**:
  - `src/components/direct/MobileListTab.js`: `calculatedPrices` 키를 `modelId-openingType` 형식으로 변경
  - `src/components/direct/MobileListTab.js`: `getDisplayValue` 함수에 `selectedOpeningType` 파라미터 추가
  - `src/components/direct/MobileListTab.js`: 캐시에서 값을 가져올 때도 `openingType`별 키 사용
  - `src/components/direct/MobileListTab.js`: `mobileList` 업데이트 제거 및 `openingType` 일치 확인 추가
  - `src/components/direct/MobileListTab.js`: `getDisplayValue`에서 `openingType`이 `null`일 때 기본값 'MNP' 사용
  - `src/components/direct/MobileListTab.js`: `getDisplayValue`의 의존성 배열에 `selectedOpeningTypes` 추가
  - `src/components/direct/MobileListTab.js`: `calculatedPrice` prop 전달 시 기본값 'MNP' 사용
  - `src/components/direct/MobileListTab.js`: 이미지 업로드 후 서버 재로딩 시 이미지가 없으면 로컬 상태 유지
  - `src/components/direct/MobileListTab.js`: 성능 최적화 - `calculatedPrice` 계산 최적화 및 불필요한 재계산 방지
  - `src/components/direct/MobileListRow.js`: 모든 `getDisplayValue` 호출 시 `selectedOpeningType` 전달

#### 4. 상품 이미지 업로드 문제
- **상태**: ✅ 해결 완료
- **증상**: 
  - 이미지 업로드 후 Discord에 이미지가 파일 이름 형태로 업로드됨 (이미지로 표시되지 않음) → ✅ 해결됨 (Discord에는 정상 업로드 확인)
  - 앱 화면에도 상품 이미지가 로드되지 않음
- **원인 분석**:
  - Discord 업로드 시 파일 확장자가 올바르게 설정되지 않음 → ✅ 해결됨
  - Google Sheets 저장 후 서버에서 이미지 조회 시 매칭 실패
  - 서버에서 이미지 조회 시 모델 코드 정규화가 일치하지 않음
- **개선 사항**:
  1. 이미지 업로드 프로세스 전반에 디버그 로그 추가
  2. 즉시 로컬 상태 업데이트하여 UI 반영 개선
  3. Google Sheets 저장 대기 시간 2초 → 3초로 증가
  4. 에러 처리 강화 및 상세 로그 추가
  5. Discord 업로드 시 파일 확장자 보장 및 description 추가
  6. 파일명 생성 로직 개선 (확장자를 별도로 추가)
  7. 서버에서 이미지 조회 시 모델 코드 정규화하여 매칭 개선
  8. 이미지 업로드 후 서버 재로딩 시 이미지가 없으면 로컬 상태 유지 (서버 매칭 실패 시에도 UI에 이미지 표시)
- **추가된 디버그 로그**:
  - `MobileListTab.js:handleFileChange`: 이미지 업로드 시작, API 응답, 성공/실패, 로컬 상태 업데이트, 최신 데이터 재로딩
- **수정 파일**:
  - `src/components/direct/MobileListTab.js`: 이미지 업로드 로직 개선 및 디버그 로그 추가
  - `src/components/direct/MobileListTab.js`: 이미지 업로드 후 서버 재로딩 시 이미지가 없으면 로컬 상태 유지
  - `server/index.js`: Discord 이미지 업로드 시 파일 확장자 보장 및 description 추가
  - `server/index.js`: Google Sheets에서 이미지 조회 시 모델 코드 정규화하여 매칭 개선

### 🟡 추가 확인 필요 (모든 탭)

#### 2. 각 탭별 성능 문제
- **상태**: 🔍 디버그 로그 추가 완료, 로그 분석 대기 중
- **디버그 로그 위치**:
  - **MobileListTab.js**: 목록 로드, 가격 계산
  - **DirectSalesReportTab.js**: 판매일보 로드, 상태 업데이트
  - **OpeningInfoPage.js**: 요금제 그룹 로드, 가격 계산
  - **PolicySettingsTab.js**: 설정 로드, 설정 저장
  - **LinkSettingsTab.js**: 설정 로드, 설정 저장
  - **MainPageTextSettingsTab.js**: 문구 설정 로드, 저장
- **다음 단계**: 각 탭별 로그 분석 및 성능 문제 파악

---

## 📋 개선 계획 및 진행 방식

### Phase 1: 문제 파악 (현재 진행 중) ✅
1. ✅ 모든 탭에 디버그 로그 추가
2. 🔄 로그 분석을 통한 문제점 파악
3. ⏳ 문제별 우선순위 결정

### Phase 2: 개선 및 로그 정리 (반복 프로세스)
**각 개선 사항마다 다음 프로세스 반복:**

1. **문제 파악**
   - 로그 분석을 통한 원인 파악
   - 문제의 우선순위 결정

2. **개선 구현**
   - 문제 해결 코드 작성
   - 테스트 및 검증

3. **보고서 기록**
   - `성능_최적화_진행_상황_보고서.md`에 개선 사항 기록
   - 개선 전/후 성능 비교 기록
   - 개선 완료 날짜 기록

4. **디버그 로그 제거**
   - 개선 완료된 부분의 디버그 로그 제거
   - Git 커밋 및 푸시

5. **검증**
   - 개선 효과 확인
   - 추가 문제 없는지 확인

### Phase 3: 최종 정리
1. ⏳ 최종적으로 남는 문제만 디버그 로그 유지
2. ⏳ 최종 보고서 작성
3. ⏳ 완벽한 디버그 완료 상태 확인

---

## 📊 개선 완료 항목 (로그 제거 완료)

### 현재 상태
- **개선 완료 항목**: 없음 (아직 개선 시작 전)
- **디버그 로그 유지 항목**: 모든 탭 (문제 파악 중)

---

## 🔄 개선 진행 중 항목

### 현재 없음
- 로그 분석 후 문제점 파악되면 여기에 추가

---

## ⚠️ 최종 남은 문제 (디버그 로그 유지)

### 현재 상태
- **최종 남은 문제**: 없음 (아직 개선 시작 전)
- 로그 분석 및 개선 완료 후 최종적으로 남는 문제만 여기에 기록

---

## 📝 개선 이력

### 2025-01-14

#### ✅ 완료된 작업
- 모든 탭에 디버그 로그 추가 완료
  - 직영점 모드: TodaysMobileTab, TodaysProductCard, MobileListTab, DirectSalesReportTab, OpeningInfoPage
  - 직영점관리 모드: PolicySettingsTab, LinkSettingsTab, MainPageTextSettingsTab
  - 서버 측: `/calculate` 엔드포인트

#### 🔄 진행 중
- 로그 분석을 통한 문제점 파악 중
- **초기 로그 분석 결과**:
  - TodaysMobileTab에서 가격 계산 초기화 시작 확인 (3개 상품: mobile-LG-1, mobile-LG-8, mobile-LG-9)
  - 계산 상태 확인에서 allCalculated=false, 모든 상품의 loading=true 상태
  - **문제**: TodaysProductCard의 loadPrices 함수가 호출되지 않음 (로그에 없음)
  - **추가 로그 추가**: TodaysProductCard useEffect, getPriceDataFromCache에 상세 로그 추가 완료

#### 📋 다음 단계
1. 로그 분석 및 문제점 파악
2. 개선 사항 하나씩 해결
3. 개선 완료된 부분의 디버그 로그 제거
4. 보고서에 개선 사항 기록

---

## 🎯 최종 목표

- 모든 탭의 성능 문제 파악 및 해결
- 개선 완료된 부분의 디버그 로그 제거
- 최종적으로 남는 문제만 디버그 로그 유지
- 완벽한 디버그 완료 상태 달성
