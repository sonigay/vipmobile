# 이통사지원금 매핑 로직 개선 보고서

## 📋 문제 분석

### 핵심 문제
정책표 링크의 행값과 이통사지원금 행값이 서로 다르고, 모델명 순서도 다르기 때문에 **기준을 정하고 매핑이 어떻게 잘 되느냐가 핵심**인데, 자꾸 그 부분에서 놓쳐서 왔다갔다 코드가 바뀌는 문제가 발생했습니다.

### 발견된 문제점

1. **두 개의 다른 데이터 구조와 처리 로직**
   - `supportSheetData` (1209-1400 라인): 이통사지원금 시트 전체를 읽어서 모델명 기준으로 저장
   - `planGroupSupportData` (3400-3550 라인): planGroup별로 이통사지원금 시트를 다시 읽어서 처리
   - **문제**: 두 곳에서 서로 다른 방식으로 처리하여 일관성이 없음

2. **"번호이동" 처리 불일치**
   - `supportSheetData` 생성 시: `openingTypeRaw === '번호이동'`일 때 "번호이동" 키에만 설정
   - `planGroupSupportData` 생성 시: `parseOpeningTypes(openingTypeRaw)`가 `['MNP']`를 반환하므로 "MNP" 키에 설정됨
   - **문제**: 같은 데이터를 두 곳에서 다르게 처리하여 값이 섞임

3. **전유형 처리 불일치**
   - `supportSheetData`: 전유형 행은 기존 값이 있으면 덮어쓰지 않음
   - `planGroupSupportData`: 전유형 행 처리 로직이 다름
   - **문제**: "번호이동"이나 "010신규/기변" 값이 존재할 때 전유형 값은 무시해야 하는데 일관되지 않음

4. **모델명 매칭 기준 불일치**
   - 정책표의 모델명과 이통사지원금 시트의 모델명이 다를 수 있음
   - 모델명 순서가 다를 수 있음
   - 인덱스 기반 매칭이 아니라 모델명 기반 매칭을 해야 함
   - **문제**: 두 곳에서 다른 방식으로 매칭하여 일관성 없음

## 🔧 해결 방안

### 1. 일관된 매핑 규칙 정의

#### 규칙 1: "번호이동" 행 처리
- `openingTypeRaw === '번호이동'`일 때는 **"번호이동" 키에만** 값을 설정
- `parseOpeningTypes("번호이동")`이 `['MNP']`를 반환하더라도, `openingTypeRaw`를 직접 확인하여 "번호이동" 키에만 설정
- **이유**: 시트에 "번호이동" 행과 "MNP" 행이 모두 있을 수 있으므로, 정확한 키에만 값을 설정해야 함

#### 규칙 2: 전유형 처리
- 전유형 행은 **기존 값이 있으면 덮어쓰지 않음** (개별 유형 우선)
- "번호이동"이나 "010신규/기변" 값이 존재할 때 전유형 값은 무시
- **이유**: 개별 유형이 더 정확한 값이므로 우선해야 함

#### 규칙 3: 모델명 매칭
- 정책표 모델명과 이통사지원금 모델명은 **모델명 기준으로 매칭** (인덱스 기반이 아님)
- 모델명 정규화, 하이픈 변형 등을 고려하여 매칭
- **이유**: 시트의 모델명 순서가 다를 수 있으므로 인덱스 기반 매칭은 부정확함

#### 규칙 4: MNP/번호이동 상호 매핑
- MNP 요청 시: "MNP" 키를 먼저 찾고, 없으면 "번호이동" 키도 찾기
- 번호이동 요청 시: "번호이동" 키를 먼저 찾고, 없으면 "MNP" 키도 찾기
- **이유**: 시트에 "번호이동" 행만 있고 "MNP" 행이 없을 수 있으므로 폴백 필요

### 2. 코드 통일

`planGroupSupportData` 생성 로직을 `supportSheetData`와 **동일한 로직**으로 수정:

1. **모델별로 모든 개통유형 수집**: `modelOpeningTypesMap` 생성
2. **전유형 처리**: "번호이동"과 "010신규/기변"이 모두 있으면 전유형 무시
3. **"번호이동" 행 처리**: `openingTypeRaw === '번호이동'`일 때 "번호이동" 키에만 설정
4. **전유형 행 처리**: 기존 값이 있으면 덮어쓰지 않음

## 📝 수정 내용

### 수정된 파일
- `server/directRoutes.js`

### 주요 변경사항

1. **`planGroupSupportData` 생성 로직 통일** (3436-3549 라인)
   - 기존: 복잡한 `addKeys`/`setIfBetter` 로직으로 처리
   - 수정: `supportSheetData`와 동일한 로직으로 처리
     - 모델별로 모든 개통유형 수집
     - 전유형 처리 후 저장
     - "번호이동" 행은 "번호이동" 키에만 설정

2. **일관된 처리 규칙 적용**
   - "번호이동" 행: "번호이동" 키에만 설정
   - 전유형 행: 기존 값이 있으면 덮어쓰지 않음
   - "010신규/기변" 행: "010신규", "기변", "010신규/기변" 모두에 매핑

## ✅ 기대 효과

1. **일관성 확보**: 두 데이터 구조가 동일한 로직으로 처리되어 일관성 확보
2. **버그 감소**: "번호이동"과 "MNP" 값이 섞이는 문제 해결
3. **유지보수성 향상**: 단일 로직으로 통일하여 유지보수 용이
4. **정확성 향상**: 정확한 키에만 값을 설정하여 데이터 정확성 향상

## 🔍 검증 방법

1. **시트 데이터 확인**
   - 13행: SM-S928N256, 번호이동, 800,000
   - 14행: SM-S928N256, 010신규/기변, 600,000
   - 58행: SM-S928N256, 전유형, 빈값

2. **예상 동작**
   - MNP 요청 시: "번호이동" 키에서 800,000 반환
   - 010신규/기변 요청 시: "010신규/기변" 키에서 600,000 반환
   - 전유형 행은 무시됨 (개별 유형이 있으므로)

## 📌 향후 개선 사항

1. **단일 데이터 구조로 통일**: `supportSheetData`와 `planGroupSupportData`를 하나로 통일 고려
2. **매핑 규칙 문서화**: 명확한 매핑 규칙을 코드 주석으로 문서화
3. **테스트 케이스 추가**: 다양한 시나리오에 대한 테스트 케이스 추가

## 📅 작성일
2025-12-15
