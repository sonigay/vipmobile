# 이통사지원금 매핑 문제 진단 및 해결 보고서

## 📋 문제 진단

### 문제 1: SM-F761N256이 SM-F766N256으로 매핑되는 문제

**증상**:
- 로그: `[Direct] /calculate 같은 모델 찾기 실패: 요청=SM-F761N256, 정책표 인덱스 0의 모델명=SM-F766N256 (정규화 후도 다름, 원래 인덱스 사용)`
- `mobile-LG-0`의 인덱스가 0인데, 정책표 인덱스 0에 `SM-F766N256`이 있음
- 하지만 요청은 `SM-F761N256`임
- 정규화 후에도 다르므로 완전히 다른 모델임

**원인**:
- **근본 원인**: 이통사 시트와 정책표 시트의 모델 행이 다르고 값도 다르기 때문에 정책표 인덱스로 `modelRow`를 찾는 로직 자체가 문제
- 정규화 후에도 다른 모델인데도 불구하고 정책표 인덱스를 그대로 사용하고 있음
- `normalizeModelCode("SM-F761N256")` = `"SMF761N256"`
- `normalizeModelCode("SM-F766N256")` = `"SMF766N256"`
- 이 둘은 완전히 다른 모델이므로 정책표 인덱스를 사용하면 안 됨
- **핵심 문제**: 정책표 인덱스와 이통사 시트 인덱스가 다를 수 있음

**해결**:
- **근본 해결**: `modelRow`를 정책표 인덱스로 찾지 말고 모델명으로 직접 찾기
- 1순위: `req.query.modelName`으로 정확히 일치하는 모델명 찾기
- 2순위: 정규화된 모델명으로 찾기
- 3순위: 정책표 인덱스로 찾기 (폴백, 참고용)
- 이통사지원금 조회도 모델명으로 직접 찾기 (이미 구현됨)

### 문제 2: 이미지 404 에러 문제

**증상**:
- Discord CDN에서 404 에러 발생
- 프록시를 통해 접근하려고 하지만 404 발생
- 이미지 업로드는 성공했지만 표시되지 않음

**원인**:
- Discord CDN URL이 만료되었거나 잘못된 것
- 프록시가 404 에러를 제대로 처리하지 못함
- 클라이언트에서 프록시 실패 시 원본 URL로 폴백하는 로직이 있지만, Discord CDN URL 자체가 만료되었을 수 있음

**해결**:
- 프록시에서 404 에러를 명확히 처리하도록 이미 수정됨
- 클라이언트에서 프록시 실패 시 원본 URL로 폴백하는 로직이 이미 구현됨
- 하지만 Discord CDN URL이 만료된 경우에는 원본 URL로도 접근 불가
- **추가 조치 필요**: 이미지 업로드 시 URL 만료 시간을 확인하거나, 이미지 저장 방식을 변경해야 할 수 있음

### 문제 3: SM-S928N256의 MNP/기변 값이 반대로 표시되는 문제

**증상**:
- MNP 요청 시 600,000이 표시되어야 하는데 800,000이 표시됨
- 기변 요청 시 800,000이 표시되어야 하는데 600,000이 표시됨

**실제 시트 데이터**:
- 13행: SM-S928N256, 번호이동, 800,000
- 14행: SM-S928N256, 010신규/기변, 600,000
- 58행: SM-S928N256, 전유형, 빈값

**원인 분석**:
1. **"010신규/기변" 행 처리 문제**:
   - "010신규/기변" 행이 "기변" 키에도 값을 설정하고 있음
   - 하지만 "기변" 키에 개별 유형 행의 값이 있으면 덮어쓰지 않도록 로직이 있음
   - 문제는 처리 순서: "010신규/기변" 행이 먼저 처리되면 "기변" 키에 600,000이 설정되고, 이후 "기변" 행이 처리되어도 이미 값이 있어서 덮어쓰지 않음

2. **키 우선순위 문제**:
   - 기변 요청 시 "기변" 키를 먼저 찾고, 없으면 "010신규/기변" 키를 찾음
   - 하지만 "010신규/기변" 행이 "기변" 키에도 값을 설정하고 있어서 잘못된 값이 반환됨

**해결**:
1. **"010신규/기변" 행 처리 로직 수정**:
   - "010신규/기변" 행은 "010신규/기변" 키에만 값을 설정
   - "010신규"와 "기변" 키에는 설정하지 않음 (개별 유형 행이 우선)
   - 또는 "010신규"와 "기변" 키에 값을 설정하되, 기존 값이 있으면 덮어쓰지 않음

2. **키 우선순위 명확화**:
   - 기변 요청 시: "기변" 키를 먼저 찾고, 없으면 "010신규/기변" 키를 찾음
   - 하지만 "기변" 키에 값이 있으면 그것을 사용 (개별 유형 우선)

## 🔧 수정 내용

### 1. SM-F761N256 매핑 문제 해결 (근본 해결)

**파일**: `server/directRoutes.js` (3167-3278 라인)

**수정 내용**:
```javascript
// 🔥 핵심 수정: 이통사 시트와 정책표 시트의 모델 행이 다르고 값도 다르기 때문에
// 정책표 인덱스로 찾지 말고 모델명으로 직접 찾기
// 1순위: req.query.modelName으로 찾기 (가장 정확)
// 2순위: 정책표 인덱스로 찾기 (폴백, 참고용)

const targetModelName = req.query.modelName ? req.query.modelName.trim() : null;

if (targetModelName) {
  // 1순위: req.query.modelName으로 정확히 일치하는 모델명 찾기
  const targetModelNormalized = normalizeModelCode(targetModelName);
  
  // 1단계: 정확히 일치하는 모델명 찾기
  for (let i = 0; i < modelData.length; i++) {
    const rowModel = (modelData[i]?.[0] || '').toString().trim();
    if (!rowModel) continue;
    
    if (rowModel === targetModelName) {
      modelRow = modelData[i];
      actualModelIndex = i;
      break;
    }
  }
  
  // 2단계: 정규화된 모델명으로 찾기 (정확히 일치하지 않을 때만)
  if (!modelRow) {
    for (let i = 0; i < modelData.length; i++) {
      const rowModel = (modelData[i]?.[0] || '').toString().trim();
      if (!rowModel) continue;
      
      const normalized = normalizeModelCode(rowModel);
      if (normalized && targetModelNormalized && normalized === targetModelNormalized) {
        modelRow = modelData[i];
        actualModelIndex = i;
        break;
      }
    }
  }
}

// 2순위: 정책표 인덱스로 찾기 (폴백, 참고용)
// req.query.modelName으로 찾지 못했을 때만 사용
if (!modelRow && !isNaN(modelIndex) && modelIndex >= 0 && modelIndex < modelData.length) {
  const policyRow = modelData[modelIndex];
  if (policyRow && policyRow[0]) {
    modelRow = policyRow;
    actualModelIndex = modelIndex;
  }
}
```

**효과**:
- 정책표 인덱스에 의존하지 않고 모델명으로 직접 찾음
- 이통사 시트와 정책표 시트의 모델 순서가 달라도 정확한 모델을 찾음
- `req.query.modelName`이 있으면 그것을 우선 사용하여 가장 정확한 매칭 보장

### 2. 이미지 404 에러 문제

**현재 상태**:
- 프록시에서 404 에러를 명확히 처리하도록 이미 수정됨
- 클라이언트에서 프록시 실패 시 원본 URL로 폴백하는 로직이 이미 구현됨

**추가 조치 필요**:
- Discord CDN URL 만료 시간 확인
- 이미지 저장 방식 개선 검토

### 3. SM-S928N256 MNP/기변 값 반대로 표시 문제 해결

**파일**: `server/directRoutes.js`

**수정 내용**:

1. **`supportSheetData` 생성 로직** (1429-1460 라인):
   - "010신규/기변" 행이 "기변" 키에 값을 설정하려 할 때, 기존 값이 있으면 덮어쓰지 않도록 수정
   - 개별 유형 행이 우선하도록 보장

2. **`planGroupSupportData` 생성 로직** (3555-3614 라인):
   - "010신규/기변" 행은 "010신규", "기변", "010신규/기변" 모두에 매핑
   - 하지만 기존 값이 있으면 덮어쓰지 않음 (개별 유형 우선)
   - 개별 유형("010신규" 또는 "기변") 행은 자신의 키에만 설정

3. **키 우선순위 명확화** (3649-3698 라인):
   - 1순위: 정확한 키 (예: MNP 요청 → MNP 키, 기변 요청 → 기변 키)
   - 2순위: 폴백 키 (예: MNP 요청 → 번호이동 키, 기변 요청 → 010신규/기변 키)
   - 기변 요청 시 "기변" 키를 먼저 찾고, 없으면 "010신규/기변" 키를 찾음

**핵심 수정 사항**:
- "010신규/기변" 행이 "기변" 키에 값을 설정하려 할 때, 기존 값이 있으면 덮어쓰지 않음
- 개별 유형 행이 우선하도록 보장
- 키 우선순위를 명확히 하여 정확한 키를 먼저 찾도록 함

## ✅ 기대 효과

1. **SM-F761N256 매핑 문제 해결**: 다른 모델이면 정책표 인덱스를 사용하지 않아 정확한 모델을 찾음
2. **이미지 404 에러**: 프록시 실패 시 원본 URL로 폴백하는 로직이 작동 (단, Discord CDN URL이 만료된 경우 추가 조치 필요)
3. **SM-S928N256 MNP/기변 값 정확성**: 개별 유형 행이 우선하도록 보장하여 정확한 값이 표시됨

## 📌 핵심 원칙

1. **모델명 기반 매칭**: 정책표 인덱스에 의존하지 않고 모델명으로 직접 찾기
   - 이통사 시트와 정책표 시트의 모델 행이 다르고 값도 다르기 때문에 인덱스 기반 접근은 근본적으로 문제
   - `req.query.modelName`이 있으면 그것을 우선 사용하여 가장 정확한 매칭 보장
   - 정책표 인덱스는 폴백으로만 사용 (참고용)

2. **정확한 키 우선**: 정확한 키(예: "기변" 요청 → "기변" 키)를 먼저 찾고, 없으면 폴백 키를 찾음

3. **개별 유형 우선**: 개별 유형 행("기변", "010신규" 등)이 복합 유형 행("010신규/기변")보다 우선

4. **기존 값 보호**: 기존 값이 있으면 덮어쓰지 않음 (더 정확한 값이 우선)

## 🔍 전체 데이터 조회 로직 검토 및 개선

### 문제 4: 인덱스 기반 접근으로 인한 공백 행 처리 문제

**근본 원인**:
- **인덱스에 의존하면 공백이 있을 때 밀리고 당겨져서 계속 데이터가 잘못됨**
- 이통사 시트와 정책표 시트의 모델 행이 다르고 값도 다르기 때문에 인덱스 기반 접근은 근본적으로 문제
- 공백 행이 있으면 인덱스가 밀려서 잘못된 데이터를 가져오게 됨

**영향받는 데이터**:
1. **정책표 리베이트 (policyRebate)**: 대리점지원금 계산의 기반
2. **출고가 (factoryPrice)**: 구매가 계산의 기반
3. **이통사지원금 (publicSupport)**: 구매가 계산의 기반
4. **대리점지원금 (storeSupport)**: policyRebate 기반으로 계산
5. **구매가 (purchasePrice)**: factoryPrice, publicSupport, storeSupport 기반으로 계산

### 전체 데이터 조회 로직 개선

#### 1. modelRow 조회 (정책표)
- **이전**: 정책표 인덱스로 찾기
- **개선**: 모델명으로 직접 찾기
  - 1순위: `req.query.modelName`으로 정확히 일치하는 모델명 찾기
  - 2순위: 정규화된 모델명으로 찾기
  - 3순위: 정책표 인덱스로 찾기 (폴백, 참고용)

#### 2. 출고가 (factoryPrice) 조회 (이통사 시트)
- **이전**: 정책표 인덱스 기반 접근
- **개선**: 모델명으로 직접 찾기
  - 1순위: 요청 모델명으로 정확히 일치하는 행 찾기
  - 2순위: 정책표 모델명으로 찾기 (폴백)
- **상태**: ✅ 이미 모델명 기반으로 구현됨

#### 3. 정책표 리베이트 (policyRebate) 조회
- **이전**: `actualModelIndex` 사용 (인덱스 기반)
- **개선**: 모델명으로 직접 찾기
  - 1순위: 요청 모델명으로 정확히 일치하는 행 찾기
  - 2순위: 정책표 모델명으로 찾기 (폴백)
  - 3순위: `actualModelIndex` 사용 (최후의 폴백)
- **상태**: ✅ 모델명 기반으로 변경 완료

#### 4. 이통사지원금 (publicSupport) 조회
- **이전**: 인덱스 기반 접근 (일부)
- **개선**: 모델명 기반 키로 찾기
  - `planGroupSupportData`는 모델명 기반 키(`모델명|개통유형`)로 구성됨
  - 조회 시 `primaryModel`(요청 모델명 우선)을 사용하여 키 생성
- **상태**: ✅ 모델명 기반 키로 조회 (인덱스 의존 없음)

#### 5. 대리점지원금 (storeSupport) 계산
- **의존성**: `policyRebate` 기반으로 계산
- **상태**: ✅ `policyRebate`가 모델명 기반으로 조회되므로 정확함

#### 6. 구매가 (purchasePrice) 계산
- **의존성**: `factoryPrice`, `publicSupport`, `storeSupport` 기반으로 계산
- **상태**: ✅ 모든 의존 데이터가 모델명 기반으로 조회되므로 정확함

### 공백 행 처리 문제 해결

**문제점**:
- 공백 행을 건너뛰면 인덱스가 밀려서 잘못된 데이터를 가져오게 됨
- 예: 모델명 행이 0, 1, 2, 3인데 1행이 공백이면, 인덱스 2로 찾으면 실제로는 3행의 데이터를 가져오게 됨

**해결**:
- **모든 데이터 조회를 모델명 기반으로 변경**
- 인덱스는 참고용으로만 사용 (폴백)
- 공백 행을 건너뛰더라도 모델명으로 직접 찾으므로 정확한 데이터를 가져옴

### 수정 완료 사항

1. ✅ **modelRow 조회**: 정책표 인덱스 → 모델명 기반
2. ✅ **출고가 (factoryPrice)**: 이미 모델명 기반
3. ✅ **정책표 리베이트 (policyRebate)**: 인덱스 → 모델명 기반
4. ✅ **이통사지원금 (publicSupport)**: 모델명 기반 키로 조회
5. ✅ **대리점지원금 (storeSupport)**: policyRebate 기반 (정확함)
6. ✅ **구매가 (purchasePrice)**: 모든 의존 데이터 정확함

### 핵심 개선 사항

1. **인덱스 의존 제거**: 모든 데이터 조회를 모델명 기반으로 변경
2. **공백 행 안전성**: 공백 행이 있어도 모델명으로 직접 찾으므로 정확한 데이터 보장
3. **시트 간 불일치 대응**: 이통사 시트와 정책표 시트의 모델 순서가 달라도 정확한 매칭 보장
4. **우선순위 명확화**: 요청 모델명 → 정책표 모델명 → 인덱스 순서로 폴백

## 📅 작성일
2025-12-15
