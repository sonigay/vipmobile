# 일반정책모드 구현 참고사항

## 개요
일반정책모드를 구현하기 전에 기존 일반모드들의 구현 방식을 확인하여 일관성 있게 구현합니다.

---

## 1. 모드 설정 (modeConfig.js)

### 1.1 기존 일반모드 예시
```javascript
onSaleReception: {
  key: 'onSaleReception',
  title: '온세일접수 모드',
  description: '온세일 접수 건을 확인하고 안전하게 처리합니다.',
  features: [...],
  color: '#AB47BC',
  icon: PhoneIcon,
  category: 'general',
  sheetRefs: {
    general: '일반모드권한관리!E열',  // 권한 체크 컬럼
    updates: '어플업데이트!S열'      // 업데이트 컬럼
  }
}
```

### 1.2 일반정책모드 설정
```javascript
generalPolicy: {
  key: 'generalPolicy',
  title: '일반정책모드',
  description: '정책표를 확인하고 조회합니다.',
  features: [
    '정책표 목록 조회',
    '정책표 상세 보기',
    '검색 및 필터링'
  ],
  color: '#FF9800',  // TODO: 색상 결정 필요
  icon: PolicyIcon,  // TODO: 아이콘 결정 필요
  category: 'general',
  sheetRefs: {
    general: '일반모드권한관리!I열',  // I열 (인덱스 8) - 권한 체크
    updates: '어플업데이트!Z열'       // Z열 (인덱스 25) - 업데이트
  }
}
```

**확인 사항:**
- `일반모드권한관리!I열`이 맞는지 확인 필요 (요구사항에 따르면 I열 인덱스 8)
- `어플업데이트!Z열`이 맞는지 확인 필요 (요구사항에 따르면 Z열 인덱스 25)

---

## 2. 권한 체크 로직

### 2.1 일반모드권한관리 시트 구조 (확인 완료)
- **시트명:** `일반모드권한관리`
- **컬럼 구조 (확인됨):**
  - A열 (인덱스 0): 사용자ID(POS코드)
  - B열 (인덱스 1): 업체명
  - C열 (인덱스 2): 그룹/영업담당
  - D열 (인덱스 3): 기본 모드 권한 ('O' 권한 있음)
  - E열 (인덱스 4): 온세일접수 모드 권한 ('O' 또는 'M')
  - F열 (인덱스 5): 온세일접수 모드 비밀번호
  - G열 (인덱스 6): 직영점 모드 권한 ('O' 권한 있음)
  - H열 (인덱스 7): 직영점 모드 비밀번호
  - **I열 (인덱스 8): 일반정책모드 권한 ('O' 권한 있음) - 추가 필요**
  - **J열 (인덱스 9): 일반정책모드 비밀번호 - 추가 필요**
  - **K열 (인덱스 10): 담당자 아이디 - 추가 필요**

**중요:** 현재 코드는 A~H열만 읽고 있음. I, J, K열을 읽으려면 범위를 확장해야 함.

### 2.2 권한 체크 방식
기존 모드들은 `modePermissions` 객체에 권한 정보가 저장됨:
- `true` 또는 `'O'`: 권한 있음
- `false` 또는 빈 값: 권한 없음

**일반정책모드 권한 체크:**
```javascript
const generalPolicyPermission = loggedInStore?.modePermissions?.generalPolicy;
const hasPermission = generalPolicyPermission === true || 
                     generalPolicyPermission === 'O' || 
                     String(generalPolicyPermission || '').trim().toUpperCase() === 'O';
```

---

## 3. 비밀번호 입력 로직

### 3.1 온세일접수모드 비밀번호 확인 (참고)
**프론트엔드:** `src/components/OnSaleReceptionMode.js`
```javascript
const handlePasswordSubmit = async () => {
  const response = await fetch(`${API_URL}/api/check-onsale-permission`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      userId: loggedInStore.id,
      password: password
    }),
  });
  
  const data = await response.json();
  if (data.success && data.hasPermission) {
    setIsAuthenticated(true);
    setShowPasswordDialog(false);
  }
};
```

**백엔드:** `server/index.js` - `/api/check-onsale-permission`
- `일반모드권한관리` 시트에서 사용자 찾기 (A~F열 범위)
- E열 (인덱스 4): 온세일접수모드 권한 확인 ('O' 또는 'M')
- F열 (인덱스 5): 비밀번호 확인
- 헤더는 3행(인덱스 2), 데이터는 4행(인덱스 3)부터

### 3.2 일반정책모드 비밀번호 확인 (구현 필요)
**백엔드 API:** `/api/check-general-policy-permission`
- `일반모드권한관리` 시트에서 사용자 찾기 (A~K열 범위로 확장 필요)
- I열 (인덱스 8) 권한 확인 (값이 "O"인지)
- J열 (인덱스 9) 비밀번호 확인
- 헤더는 3행(인덱스 2), 데이터는 4행(인덱스 3)부터

**프론트엔드:** 온세일접수모드와 동일한 패턴으로 구현
- `src/components/GeneralPolicyMode.js` 생성
- 비밀번호 입력 다이얼로그
- 인증 상태 관리

---

## 4. 어플업데이트 인덱스

### 4.1 어플업데이트 시트 구조
**파일:** `src/utils/appUpdateService.js`

```javascript
const UPDATE_SHEET_COLUMNS = {
  DATE: 0,           // A열: 날짜
  ADMIN_IDS: 1,      // B열: 관리자아이디
  GENERAL: 2,        // C열: 일반모드
  AGENT: 3,          // D열: 관리자모드
  // ...
  ONSALE_RECEPTION: 18,    // S열: 온세일접수모드
  MEAL_ALLOWANCE: 19,      // T열: 식대 모드
  ATTENDANCE: 20,          // U열: 근퇴 모드
  RISK_MANAGEMENT: 21,     // V열: 리스크 관리 모드
  DIRECT_STORE_MANAGEMENT: 22, // W열: 직영점 관리 모드
  DIRECT_STORE: 23,         // X열: 직영점 모드
  QUICK_SERVICE_MANAGEMENT: 24 // Y열: 퀵서비스 관리 모드
  // Z열은 아직 정의되지 않음
};
```

### 4.2 일반정책모드 업데이트 인덱스 추가 필요
```javascript
const UPDATE_SHEET_COLUMNS = {
  // ...
  QUICK_SERVICE_MANAGEMENT: 24, // Y열: 퀵서비스 관리 모드
  GENERAL_POLICY: 25            // Z열: 일반정책모드 (추가 필요)
};

const MODE_COLUMN_MAP = {
  // ...
  'generalPolicy': UPDATE_SHEET_COLUMNS.GENERAL_POLICY,  // 추가 필요
  'general-policy': UPDATE_SHEET_COLUMNS.GENERAL_POLICY  // 별칭 추가 필요
};
```

---

## 5. 모드 라우팅 및 컴포넌트

### 5.1 App.js에서 모드 처리
기존 모드들은 다음과 같이 처리됨:
- `setIsOnSaleReceptionMode(true)`
- `setCurrentMode('onSaleReception')`
- `localStorage.setItem('loginState', ...)`

**일반정책모드 추가 필요:**
- `setIsGeneralPolicyMode(true)` (상태 추가 필요)
- `setCurrentMode('generalPolicy')`

### 5.2 모드 컴포넌트
**파일 구조:**
- `src/components/OnSaleReceptionMode.js` (참고)
- `src/components/GeneralPolicyMode.js` (생성 필요)

**컴포넌트 구조:**
- 비밀번호 입력 다이얼로그
- 인증 상태 관리
- 정책표 목록 탭 (정책모드의 PolicyTableListTab과 동일)

---

## 6. 확인 필요 사항

### 6.1 일반모드권한관리 시트 구조 (확인 완료)
- [x] 시트의 전체 컬럼 구조 확인 완료
- [x] I열이 일반정책모드 권한 컬럼 (요구사항 기준)
- [x] J열이 일반정책모드 비밀번호 컬럼 (요구사항 기준)
- [x] K열이 담당자 아이디 컬럼 (요구사항 기준)
- [ ] **중요:** 현재 코드는 A~H열만 읽음. I, J, K열을 읽으려면 범위 확장 필요

### 6.2 어플업데이트 시트 구조
- [ ] Z열이 실제로 사용 가능한지 확인
- [ ] Z열이 다른 용도로 사용되고 있지 않은지 확인

### 6.3 모드 색상 및 아이콘
- [ ] 일반정책모드 색상 결정
- [ ] 일반정책모드 아이콘 결정

### 6.4 백엔드 API 확인
- [ ] `/api/check-onsale-permission` 구현 방식 확인
- [ ] 일반모드권한관리 시트 읽기 로직 확인
- [ ] 비밀번호 확인 로직 확인

---

## 7. 구현 체크리스트

### 7.1 프론트엔드
- [ ] `src/config/modeConfig.js`에 일반정책모드 추가
- [ ] `src/utils/appUpdateService.js`에 Z열 인덱스 추가
- [ ] `src/components/GeneralPolicyMode.js` 생성
- [ ] `src/App.js`에 일반정책모드 라우팅 추가
- [ ] `src/components/meeting/ModeSelector.js`에 일반정책모드 추가

### 7.2 백엔드
- [ ] `/api/check-general-policy-permission` 엔드포인트 추가
- [ ] 일반모드권한관리 시트 읽기 범위를 A~K열로 확장 (현재 A~H열만 읽음)
- [ ] 로그인 API (`/api/login`)에서 I열 권한 체크 로직 추가
- [ ] 로그인 API에서 일반정책모드 권한 정보를 `modePermissions`에 포함
- [ ] `/api/check-general-policy-permission`에서 I열 권한 체크 및 J열 비밀번호 확인

### 7.3 정책표 목록 필터링
- [ ] 일반정책모드에서 정책표 목록 필터링 로직 추가
- [ ] 사용자 업체명 확인 로직 추가
- [ ] 정책영업그룹의 `companyNames` 필터링 로직 추가

---

**마지막 업데이트:** 2025-12-30
**상태:** 구현 전 참고사항 정리 완료

