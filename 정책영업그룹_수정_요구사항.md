# 정책영업그룹 수정 요구사항

## 개요
정책영업그룹 기능에 대한 대대적인 수정이 필요합니다. 이 문서는 수정 요구사항을 정리하고, 최종 정리가 완료되면 구현을 시작합니다.

## 수정 요구사항

### 1. 정책영업그룹 추가 모달 수정

#### 1.1 일반사용자 설정 → 업체명으로 변경
- **현재:** 정책영업그룹 추가 모달에서 "일반사용자" 선택
- **변경:** "일반사용자" 대신 "업체명" 선택으로 변경

#### 1.2 업체명 데이터 소스
- **시트:** `일반모드권한관리` 시트
- **업체명 위치:** 
  - B열 (인덱스 1)에 4행부터 존재하는 업체명
- **선택 가능한 업체명 조건:**
  - I열 (인덱스 8)에 "O" 권한이 있는 업체명만 선택 가능
- **담당자 아이디 위치:**
  - K열 (인덱스 10)에 담당자 아이디 데이터 존재

#### 1.3 자동 선택 로직
- **조건:** 현재 로그인한 사용자의 아이디가 K열에 있는 경우
- **동작:** 해당 사용자의 B열 업체명을 자동으로 선택된 상태로 표시
- **담당자 자동 추가:** 업체명을 선택하면 해당 업체의 K열 담당자 아이디를 자동으로 `managerIds`에 추가

### 2. 데이터 구조 변경사항

#### 2.1 기존 구조 (확인됨)
- **시트:** `정책모드_일반사용자그룹` (SHEET_USER_GROUPS)
- **헤더:** ['그룹ID', '그룹이름', '일반사용자목록', '등록일시', '등록자']
- **현재 저장 구조:**
  - row[0] = 그룹ID
  - row[1] = 그룹이름
  - row[2] = 일반사용자목록 (JSON 배열, `userIds` 배열로 저장)
  - row[3] = 등록일시
  - row[4] = 등록자

#### 2.2 변경 후 구조
- **저장 형식:** row[2]에 JSON 형식으로 저장
  - 예: `{"companyNames": ["업체1", "업체2"], "managerIds": ["01012345678", "01087654321"]}`
- **업체명 필드:** `companyNames` (배열) - B열 업체명 저장
- **담당자 필드:** `managerIds` (배열) - K열 담당자 아이디 저장
- **기존 `userIds` 데이터 처리:**
  - 권한 레벨("A", "B", "C")은 더 이상 사용하지 않음
  - 기존 그룹을 수정할 때 `userIds` 형식이면 새로운 형식으로 초기화
  - `companyNames`와 `managerIds`는 빈 배열로 시작 (사용자가 직접 선택)

### 3. 정책표 데이터 구조 (확인됨)

#### 3.1 정책표 저장 구조
- **시트:** `정책모드_정책표목록` (SHEET_POLICY_TABLE_LIST)
- **헤더:** ['정책표ID', '정책표ID_설정', '정책표이름', '정책적용일시', '정책적용내용', '접근권한', '생성자', '생성일시', '디스코드메시지ID', '디스코드스레드ID', '이미지URL', '등록여부', '등록일시']
- **주요 필드:**
  - row[5] = 접근권한 (그룹ID) - 정책영업그룹의 그룹ID 저장
  - row[6] = 생성자 (이름) - 정책표를 생성한 사람의 이름
- **중요:** 정책표에는 업체명이나 담당자 정보가 직접 저장되어 있지 않음
- **접근 권한:** 정책영업그룹의 그룹ID만 저장됨

#### 3.2 정책표와 정책영업그룹 연결
- **현재 로직:** 정책표 생성 시 `accessGroupId`를 선택하여 정책표의 '접근권한' 필드에 저장
- **정책영업그룹의 목적:** 정책 생성 시 매번 많은 업체를 선택하기 힘들어서 미리 그룹으로 묶어두는 기능
- **필터링 로직:** 
  - **일반정책모드:**
    1. 현재 로그인한 사용자의 업체명 확인 (일반모드권한관리 시트에서 K열 아이디로 B열 업체명 찾기)
    2. 정책표의 '접근권한' 필드에 저장된 그룹ID로 정책영업그룹 찾기
    3. 해당 그룹의 `companyNames`에 현재 사용자의 업체명이 포함되어 있으면 정책 표시
  - **정책모드:**
    1. 정책표의 '접근권한' 필드에 저장된 그룹ID로 정책영업그룹 찾기
    2. 해당 그룹의 `managerIds`에 현재 사용자 아이디가 포함되어 있으면 정책 표시

### 4. API 변경사항
- 정책영업그룹 API에서 `companyNames`와 `managerIds` 필드 추가/수정 필요
- 정책표목록 API에서 일반정책모드 필터링 로직 추가 필요

### 5. 일반모드에 "일반정책모드" 추가

#### 5.1 모드 추가
- **모드 이름:** "일반정책모드"
- **모드 위치:** 일반모드에 추가

#### 5.2 접근 권한 설정
- **권한 소스:** `일반모드권한관리` 시트
- **권한 조건:** I열 (인덱스 8)에 "O" 권한이 있는 사용자만 접근 가능
- **권한 체크:** 기존 모드 권한 체크 로직과 동일하게 구현

#### 5.3 접근 비밀번호
- **비밀번호 소스:** `일반모드권한관리` 시트
- **비밀번호 위치:** J열 (인덱스 9)
- **기능:** 일반정책모드 접근 시 비밀번호 확인

#### 5.4 어플업데이트 내용
- **저장 위치:** `어플업데이트` 시트
- **컬럼:** Z열 (인덱스 25)
- **기능:** 
  - 저장: 일반정책모드의 어플업데이트 내용을 Z열에 저장
  - 로드: Z열에서 일반정책모드의 어플업데이트 내용을 로드

#### 5.5 일반정책모드 페이지
- **페이지 구조:** 정책모드의 정책표목록과 동일한 페이지 로드
- **기능:**
  - 정책표 상세 보기(이미지 확인) 가능
  - 정책표 등록 기능은 없음 (등록된 정책표만 확인)
  - 검색/필터링 기능은 정책모드와 동일하게 제공
- **필터링 로직:**
  1. 현재 로그인한 사용자의 업체명 확인 (일반모드권한관리 시트에서 K열 아이디로 B열 업체명 찾기)
  2. 정책표의 '접근권한' 필드에 저장된 그룹ID로 정책영업그룹 찾기
  3. 해당 그룹의 `companyNames`에 현재 사용자의 업체명이 포함되어 있으면 정책 표시

### 6. 정책영업그룹 관리 권한 (확인됨)
- **현재 권한:** SS, AA, BB, CC, DD, EE, FF 권한자 모두 가능
- **변경 없음:** 기존과 동일하게 유지

### 7. UI/UX 개선사항
- (추가 요구사항 대기)

### 8. 기타 요구사항
- (추가 요구사항 대기)

---

## 구현 시작 전 체크리스트
- [x] 모든 요구사항이 문서화됨
- [x] 사용자 확인 완료
- [ ] 구현 시작 승인 대기

---

---

## 상세 구현 사항

### 업체명 데이터 로드 로직
1. `일반모드권한관리` 시트에서 데이터 가져오기
2. B열 (인덱스 1)에서 4행부터 데이터 읽기
3. I열 (인덱스 8)이 "O"인 행만 필터링
4. 중복 제거하여 업체명 목록 생성

### 자동 선택 로직
1. 현재 로그인한 사용자의 아이디 확인 (`loggedInStore?.contactId` 또는 `loggedInStore?.id`)
2. K열 (인덱스 10)에서 해당 아이디가 있는 행 찾기
3. 해당 행의 B열 업체명을 자동으로 선택된 상태로 표시

### 데이터 저장 구조
- (구체적인 저장 구조는 추가 요구사항 확인 후 결정)

### 일반정책모드 구현 사항

#### 모드 추가 위치
- 일반모드에 "일반정책모드" 추가
- 기존 모드 목록에 표시

#### 권한 체크 로직
1. `일반모드권한관리` 시트에서 현재 사용자 정보 확인
2. I열 (인덱스 8)에 "O" 권한이 있는지 확인
3. 권한이 있으면 일반정책모드 접근 가능

#### 어플업데이트 처리
1. **저장:**
   - 일반정책모드의 어플업데이트 내용을 `어플업데이트` 시트의 Z열 (인덱스 25)에 저장
   - 기존 어플업데이트 저장 로직과 유사하게 구현

2. **로드:**
   - `어플업데이트` 시트의 Z열 (인덱스 25)에서 일반정책모드의 어플업데이트 내용 로드
   - 기존 어플업데이트 로드 로직과 유사하게 구현

### 접근 비밀번호 처리
1. `일반모드권한관리` 시트의 J열 (인덱스 9)에서 비밀번호 확인
2. 일반정책모드 접근 시 비밀번호 입력 요구
3. 비밀번호 일치 여부 확인 후 접근 허용

### 일반정책모드 페이지 구현
1. 정책모드의 정책표목록 페이지와 동일한 구조 사용
2. 정책영업그룹 필터링 로직 추가:
   - 현재 로그인한 사용자가 속한 정책영업그룹 확인
   - 정책영업그룹에 설정된 업체명과 담당자 정보 가져오기
   - 정책표목록에서 해당 업체명 또는 담당자와 일치하는 정책만 표시

---

---

## 구현 전 확인 필요 사항

### 1. 정책영업그룹 데이터 구조 (확인 완료)
- **답변:** `companyNames` (배열) 사용
- **답변:** 기존 `userIds`는 담당자에 해당하므로 `managerIds`로 변환
- **추가 질문:** 
  - `companyNames`와 `managerIds`를 모두 저장할까요, 아니면 `companyNames`만 저장하고 담당자는 K열에서 동적으로 가져올까요?
  - 시트 구조: row[2]에 `companyNames`와 `managerIds`를 함께 JSON으로 저장할까요?
    - 예: `{"companyNames": ["업체1", "업체2"], "managerIds": ["01012345678", "01087654321"]}`

### 2. 정책표와 정책영업그룹 연결 관계 (확인 완료)
- **확인됨:** 정책표에는 업체명이나 담당자 정보가 직접 저장되어 있지 않음
- **확인됨:** 정책표의 '접근권한' 필드(row[5])에 정책영업그룹의 그룹ID가 저장됨
- **확인됨:** 정책표생성탭에서 이미 그룹을 선택할 수 있음 (`accessGroupId`)
- **추가 질문:**
  - **일반정책모드에서 필터링:** 
    - 정책표의 '접근권한' 필드에 저장된 그룹ID로 정책영업그룹을 찾고
    - 해당 그룹의 `companyNames`에 현재 사용자가 속한 업체명이 포함되어 있으면 표시하는 방식이 맞나요?
    - 현재 사용자가 속한 업체명은 어떻게 확인하나요? (일반모드권한관리 시트의 B열에서 K열의 아이디로 찾기?)
  - **정책모드에서 필터링:**
    - 현재는 정책영업그룹의 `userIds`에 사용자 권한 레벨이 포함되어 있으면 표시
    - 변경 후에는 정책영업그룹의 `managerIds`에 현재 사용자의 아이디가 포함되어 있으면 표시하는 방식이 맞나요?
    - 정책표의 '생성자' 필드(row[6])는 이름으로 저장되어 있는데, `managerIds`는 아이디로 저장되므로 어떻게 매칭하나요?

### 3. 담당자 필터링 로직 (확인 완료)
- **답변:** 담당자 아이디(K열)를 그대로 저장하되, 대리점아이디관리 시트에서 이름으로 변환하여 표시
- **답변:** 정책모드에서는 담당자 필터링, 일반정책모드에서는 업체명 필터링
- **추가 질문:**
  - **정책영업그룹에 담당자 저장:**
    - K열의 담당자 아이디를 `managerIds` 배열에 저장
    - 표시할 때는 대리점아이디관리 시트에서 아이디로 이름을 찾아서 표시
    - 이 방식이 맞나요?
  - **정책모드 필터링:**
    - 정책표의 '생성자' 필드(row[6])는 이름으로 저장되어 있음
    - 정책영업그룹의 `managerIds`에 현재 사용자의 아이디가 포함되어 있고
    - 해당 아이디를 대리점아이디관리 시트에서 이름으로 변환한 후
    - 정책표의 '생성자' 필드와 매칭하는 방식이 맞나요?
  - **일반정책모드 필터링:**
    - 정책영업그룹의 `companyNames`에 현재 사용자가 속한 업체명이 포함되어 있으면 표시
    - 현재 사용자가 속한 업체명은 어떻게 확인하나요? (일반모드권한관리 시트의 B열에서 K열의 아이디로 찾기?)

### 4. 정책영업그룹 멤버십 (확인 완료)
- **답변:** 업체는 한 그룹에만 속할 수 있음, 담당자는 여러 그룹에 속할 수 있음
- **추가 질문:**
  - **일반정책모드 필터링:**
    - 사용자가 속한 모든 정책영업그룹을 찾아서
    - 각 그룹의 `companyNames`를 합쳐서
    - 정책표의 '접근권한' 필드에 해당하는 그룹의 `companyNames`에 포함된 정책만 표시하는 방식이 맞나요?
    - 사용자가 속한 업체명은 어떻게 확인하나요? (일반모드권한관리 시트에서 K열의 아이디로 B열 업체명 찾기?)
  - **정책모드 필터링:**
    - 사용자의 아이디가 포함된 모든 정책영업그룹을 찾아서
    - 각 그룹의 `managerIds`에 사용자 아이디가 포함되어 있고
    - 정책표의 '접근권한' 필드에 해당하는 그룹의 `managerIds`에 사용자 아이디가 포함된 정책만 표시하는 방식이 맞나요?

### 5. 일반정책모드 기능 범위 (확인 완료)
- **답변:** 일반정책모드에서는 정책표목록만 제공 (생성/수정/삭제 불가)
- **답변:** 검색/필터링 기능은 정책모드와 동일하게 제공
- **추가 질문:**
  - 일반정책모드에서 정책표 상세 보기(이미지 확인)는 가능한가요?
  - 일반정책모드에서 정책표 등록 기능은 필요한가요? (현재 정책모드에는 등록 기능이 있음)

### 6. 정책영업그룹 관리 권한 (확인 완료)
- **답변:** SS, AA, BB, CC, DD, EE, FF 권한자 모두 가능 (기존과 동일)
- **변경 없음:** 기존 권한 구조 유지

### 7. 데이터 마이그레이션 (확인 완료)
- **답변:** 기존 `userIds`는 담당자에 해당하므로 `managerIds`로 변환
- **추가 질문:**
  - 기존 `userIds`에 저장된 값은 권한 레벨(예: "A", "B", "C")인데, 이를 담당자 아이디로 변환해야 하나요?
  - 아니면 기존 데이터는 그대로 두고, 새로운 그룹부터 `companyNames`와 `managerIds`를 사용할까요?
  - 기존 그룹의 `userIds`를 `managerIds`로 변환할 때, 권한 레벨을 어떻게 담당자 아이디로 매핑하나요?
    - 예: 권한 레벨 "A"를 가진 모든 사용자의 아이디를 찾아서 `managerIds`에 추가?

---

---

## 추가 확인 필요 사항 (상세 질문)

### 질문 1: 정책영업그룹 데이터 저장 구조 (확인 완료)
**현재 상황:**
- 기존: `userIds` 배열에 권한 레벨("A", "B", "C" 등) 저장
- 변경: `companyNames` 배열과 `managerIds` 배열 저장

**답변:**
1. 시트의 row[2]에 JSON 형식으로 저장: `{"companyNames": ["업체1", "업체2"], "managerIds": ["01012345678", "01087654321"]}`
2. 기존 `userIds` 데이터 처리:
   - 대리점아이디관리 시트에서 해당 권한 레벨을 가진 모든 사용자의 아이디를 찾아서 `managerIds`에 추가
   - 예: 권한 레벨 "A"를 가진 모든 사용자의 아이디를 찾아서 `managerIds`에 추가

### 질문 2: 일반정책모드 필터링 로직 (확인 완료)
**목적:**
- 정책영업그룹은 정책 생성 시 매번 많은 업체를 선택하기 힘들어서 미리 그룹으로 묶어두는 기능
- 정책 생성 시 해당 그룹을 선택하면, 해당 그룹에 있는 업체들과 담당자만 생성된 정책을 확인할 수 있게 함

**필터링 로직:**
1. **일반정책모드에서:**
   - 정책표의 '접근권한' 필드에 저장된 그룹ID로 정책영업그룹 찾기
   - 해당 그룹의 `companyNames`에 포함된 업체명과 연결된 정책만 표시
   - 현재 로그인한 사용자가 속한 업체명 확인:
     - 일반모드권한관리 시트에서 K열(인덱스 10)에 현재 사용자 아이디가 있는 행 찾기
     - 해당 행의 B열(인덱스 1) 업체명을 가져오기
   - 해당 업체명이 정책영업그룹의 `companyNames`에 포함되어 있으면 정책 표시

2. **정책모드에서:**
   - 정책표의 '접근권한' 필드에 저장된 그룹ID로 정책영업그룹 찾기
   - 해당 그룹의 `managerIds`에 현재 사용자 아이디가 포함되어 있으면 정책 표시

### 질문 3: 정책모드 필터링 로직 (확인 완료)
**현재 상황:**
- 정책표의 '생성자' 필드에 이름이 저장됨 (표시용)
- 정책영업그룹의 `managerIds`에 담당자 아이디가 저장됨

**답변:**
1. 필터링 로직:
   - 정책표의 '접근권한' 필드에 저장된 그룹ID로 정책영업그룹 찾기
   - 해당 그룹의 `managerIds`에 현재 사용자 아이디가 포함되어 있으면 표시
   - 이 방식이 맞음
2. 정책표의 '생성자' 필드:
   - '생성자' 필드는 필터링에 사용하지 않고, 단순히 표시용
   - 필터링은 `managerIds`와 현재 사용자 아이디로만 수행

### 질문 4: 담당자 저장 방식 (확인 완료)
**현재 상황:**
- K열에 담당자 아이디가 있음
- 대리점아이디관리 시트에서 아이디로 이름을 찾을 수 있음

**답변:**
1. 정책영업그룹에 담당자를 저장할 때:
   - K열의 담당자 아이디를 `managerIds` 배열에 저장
   - 표시할 때는 대리점아이디관리 시트에서 아이디로 이름을 찾아서 표시
   - 이 방식이 맞음
2. 정책영업그룹 추가 모달에서:
   - 업체명을 선택하면 해당 업체의 K열 담당자 아이디를 자동으로 `managerIds`에 추가
   - 담당자를 별도로 선택하는 기능은 없음

### 질문 5: 일반정책모드 기능 (확인 완료)
**답변:**
1. 일반정책모드에서 정책표 상세 보기(이미지 확인)는 가능함
   - 정책모드의 정책표목록과 동일하게 이미지로 확인 가능
2. 일반정책모드에서 정책표 등록 기능은 불필요함
   - 정책표 등록 기능은 정책모드의 정책표생성탭에 있는 기능
   - 일반정책모드에서는 정책표목록 탭만 제공 (등록된 정책표만 확인)

---

---

## 최종 확인 사항

### 데이터 마이그레이션 (확인 완료)

**중요:** 권한 레벨("A", "B", "C")은 더 이상 사용하지 않습니다.
- 이제는 업체명(`companyNames`)과 담당자 아이디(`managerIds`)만 사용합니다.

**기존 데이터 처리:**
- 기존 그룹의 `userIds` (권한 레벨 배열)는 무시합니다.
- 기존 그룹을 수정할 때:
  - `userIds` 형식이면 새로운 형식으로 초기화
  - `companyNames`는 빈 배열로 시작 (사용자가 직접 업체명 선택)
  - `managerIds`는 빈 배열로 시작 (업체명 선택 시 자동 추가)
- 또는 기존 그룹은 그대로 두고, 새로운 그룹부터만 새로운 형식 사용

**변환 시점:**
- 기존 그룹을 수정할 때 자동으로 새로운 형식으로 변환
- 사용자가 그룹을 열어서 수정하면, 기존 `userIds`는 무시하고 새로운 형식으로 저장

---

## 구현 요약

### 주요 변경사항
1. **정책영업그룹 데이터 구조 변경**
   - `userIds` (권한 레벨) → `companyNames` (업체명 배열) + `managerIds` (담당자 아이디 배열)
   - JSON 형식으로 저장: `{"companyNames": [...], "managerIds": [...]}`

2. **정책영업그룹 추가 모달 수정**
   - "일반사용자" 선택 → "업체명" 선택으로 변경
   - 업체명 선택 시 해당 업체의 K열 담당자 아이디 자동 추가
   - 로그인 사용자의 업체명 자동 선택

3. **필터링 로직 변경**
   - **일반정책모드:** 사용자 업체명이 그룹의 `companyNames`에 포함되어 있으면 표시
   - **정책모드:** 사용자 아이디가 그룹의 `managerIds`에 포함되어 있으면 표시

4. **일반정책모드 추가**
   - 일반모드에 "일반정책모드" 추가
   - 접근 권한: I열에 "O" 권한이 있는 사용자
   - 접근 비밀번호: J열에서 확인
   - 어플업데이트: Z열에 저장/로드
   - 페이지: 정책모드의 정책표목록과 동일 (이미지 확인 가능, 등록 기능 없음)

---

**마지막 업데이트:** 2025-12-30
**상태:** 요구사항 수집 완료 - 구현 준비 완료

