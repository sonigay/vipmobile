# 정책표 이미지 생성 워크플로우 상세 예시

## 전체 흐름도

```
[사용자] 정책표 생성 요청
    ↓
[클라우드 서버] 정책표 생성 API 호출
    ↓
[클라우드 서버] 디스코드 명령어 생성 및 전송
    ↓
[디스코드 채널] 메시지 전송: "!screenshot https://..."
    ↓
[로컬 PC 봇] 명령어 감지
    ↓
[로컬 PC 봇] Puppeteer로 Google Sheets 열기
    ↓
[로컬 PC 봇] 스크린샷 생성 (PNG)
    ↓
[로컬 PC 봇] 이미지를 디스코드에 업로드
    ↓
[디스코드 채널] 이미지 포함 메시지 전송
    ↓
[클라우드 서버] 이미지 URL 추출
    ↓
[클라우드 서버] 정책표 데이터에 이미지 URL 저장
    ↓
[사용자] 정책표 생성 완료 (이미지 포함)
```

---

## 단계별 상세 설명

### 1단계: 클라우드 서버에서 명령어 생성

**위치**: `server/policyTableRoutes.js` - `processPolicyTableGeneration` 함수

**상황**: 사용자가 정책표 생성 버튼 클릭

**입력 데이터**:
```javascript
{
  policyTableId: "PT_1234567890",
  applyDate: "2025-01-01",
  applyContent: "신규 정책 적용",
  creatorName: "홍길동"
}
```

**처리 과정**:
```javascript
// 1. 정책표 설정에서 Google Sheets URL 가져오기
const policyTableLink = "https://docs.google.com/spreadsheets/d/1abc123xyz/edit#gid=0";
const policyTableName = "경수일반";
const discordChannelId = "1234567890123456789";

// 2. 명령어 생성
const command = `!screenshot ${policyTableLink} policyTableName=${encodeURIComponent(policyTableName)} userName=${encodeURIComponent(creatorName)}`;

// 결과: "!screenshot https://docs.google.com/spreadsheets/d/1abc123xyz/edit#gid=0 policyTableName=%EA%B2%BD%EC%88%98%EC%9D%BC%EB%B0%98 userName=%ED%99%8D%EA%B8%B8%EB%8F%99"
```

**전송**:
```javascript
// 디스코드 채널에 메시지 전송
await channel.send(command);
```

---

### 2단계: 로컬 PC 봇이 명령어 감지

**위치**: `local-discord-bot/bot.js` - `messageCreate` 이벤트

**동작**:
```javascript
// 디스코드 채널의 모든 메시지를 모니터링
client.on('messageCreate', async (message) => {
  // "!screenshot "로 시작하는 메시지 감지
  if (message.content.startsWith('!screenshot ')) {
    console.log('명령어 감지!');
    // 명령어 처리 시작
  }
});
```

**로그 예시**:
```
📥 [로컬PC봇] 명령어 수신: !screenshot https://docs.google.com/spreadsheets/d/1abc123xyz/edit#gid=0 policyTableName=경수일반 userName=홍길동
📋 [로컬PC봇] 파싱된 정보:
   URL: https://docs.google.com/spreadsheets/d/1abc123xyz/edit#gid=0
   정책표: 경수일반
   사용자: 홍길동
```

---

### 3단계: 로컬 PC 봇이 스크린샷 생성

**위치**: `local-discord-bot/screenshot.js` - `captureSheetAsImage` 함수

**처리 과정**:

```javascript
// 1. Puppeteer로 브라우저 열기
const browser = await puppeteer.launch({ headless: true });
const page = await browser.newPage();

// 2. Google Sheets URL로 이동
await page.goto('https://docs.google.com/spreadsheets/d/1abc123xyz/edit#gid=0', {
  waitUntil: 'networkidle0'
});

// 3. 페이지 로딩 대기 (3초)
await page.waitForTimeout(3000);

// 4. Google Sheets 그리드 영역 찾기
const gridElement = await page.$('.grid-container');

// 5. 스크린샷 생성
const screenshot = await gridElement.screenshot({ type: 'png' });

// 6. 브라우저 종료
await browser.close();
```

**로그 예시**:
```
🖼️ [로컬PC봇] Puppeteer로 스크린샷 생성 시작...
📸 스크린샷 생성 중: https://docs.google.com/spreadsheets/d/1abc123xyz/edit#gid=0
✅ 그리드 영역 찾음: .grid-container
✅ 스크린샷 생성 완료
✅ [로컬PC봇] 스크린샷 생성 완료 (크기: 245678 bytes)
```

---

### 4단계: 로컬 PC 봇이 이미지를 디스코드에 업로드

**위치**: `local-discord-bot/bot.js` - `loadingMsg.edit()`

**처리 과정**:
```javascript
// 생성한 이미지 버퍼를 디스코드에 업로드
await loadingMsg.edit({
  content: '',
  embeds: [embed],  // 성공 메시지
  files: [{
    attachment: imageBuffer,  // PNG 이미지
    name: `정책표_경수일반_1704067200000.png`
  }]
});
```

**디스코드 채널에 표시되는 내용**:
```
✅ 스크린샷 생성 완료
📋 정책표: 경수일반
👤 생성자: 홍길동
[이미지 첨부: 정책표_경수일반_1704067200000.png]
```

**로그 예시**:
```
📤 [로컬PC봇] 이미지 디스코드 업로드 완료
✅ [로컬PC봇] 전체 작업 완료: 경수일반 (홍길동)
```

---

### 5단계: 클라우드 서버가 이미지 URL 추출

**위치**: `server/policyTableRoutes.js` - `captureSheetViaDiscordBot` 함수

**처리 과정**:
```javascript
// 1. 봇이 업로드한 메시지 감지
const collector = channel.createMessageCollector({
  filter: (msg) => {
    return msg.author.bot &&           // 봇이 보낸 메시지
           msg.attachments.size > 0 && // 이미지 포함
           msg.createdTimestamp > commandMessage.createdTimestamp; // 명령어 이후
  },
  time: 60000,  // 최대 60초 대기
  max: 1        // 1개만 수집
});

// 2. 이미지 URL 추출
collector.on('collect', (msg) => {
  const imageUrl = msg.attachments.first().url;
  // 결과: "https://cdn.discordapp.com/attachments/1234567890/1234567890/screenshot.png"
});
```

**로그 예시**:
```
⏳ [클라우드서버] 로컬 PC 봇의 응답 대기 중... (최대 60초)
📥 [클라우드서버] 봇 응답 메시지 수신 (메시지 ID: 987654321098765432)
✅ [클라우드서버] 스크린샷 이미지 URL 추출 성공:
   URL: https://cdn.discordapp.com/attachments/1234567890/1234567890/screenshot.png
```

---

### 6단계: 클라우드 서버가 이미지 URL 저장

**위치**: `server/policyTableRoutes.js` - `processPolicyTableGeneration` 함수

**처리 과정**:
```javascript
// 구글시트에 정책표 데이터 저장
const newRow = [
  newRowId,                    // 정책표ID
  policyTableId,               // 정책표ID (설정과 연결)
  policyTableName,             // 정책표이름: "경수일반"
  applyDate,                   // 정책적용일시: "2025-01-01"
  applyContent,                // 정책적용내용: "신규 정책 적용"
  accessGroupId || '',         // 접근권한
  creatorName,                 // 생성자: "홍길동"
  createdAt,                   // 생성일시
  messageId,                   // 디스코드메시지ID
  threadId,                    // 디스코드스레드ID
  imageUrl,                    // 이미지URL: "https://cdn.discordapp.com/..."
  'N',                         // 등록여부
  ''                           // 등록일시
];

await sheets.spreadsheets.values.append({
  spreadsheetId: SPREADSHEET_ID,
  range: '정책모드_정책표목록!A:M',
  valueInputOption: 'USER_ENTERED',
  resource: { values: [newRow] }
});
```

---

## 실제 명령어 예시

### 예시 1: 기본 명령어

**클라우드 서버가 전송**:
```
!screenshot https://docs.google.com/spreadsheets/d/1abc123xyz/edit#gid=0
```

**로컬 PC 봇이 처리**:
- URL만 추출하여 스크린샷 생성
- 정책표 이름: "정책표" (기본값)
- 사용자 이름: "Unknown" (기본값)

---

### 예시 2: 정책표 이름과 사용자 정보 포함

**클라우드 서버가 전송**:
```
!screenshot https://docs.google.com/spreadsheets/d/1abc123xyz/edit#gid=0 policyTableName=경수일반 userName=홍길동
```

**로컬 PC 봇이 처리**:
- URL: `https://docs.google.com/spreadsheets/d/1abc123xyz/edit#gid=0`
- 정책표 이름: "경수일반"
- 사용자 이름: "홍길동"
- 디스코드 메시지에 "경수일반", "홍길동" 표시

---

### 예시 3: 추가 옵션 포함

**클라우드 서버가 전송**:
```
!screenshot https://docs.google.com/spreadsheets/d/1abc123xyz/edit#gid=0 policyTableName=경수일반 userName=홍길동 waitTime=5000 viewportWidth=2560 viewportHeight=1440
```

**로컬 PC 봇이 처리**:
- 대기 시간: 5초 (기본 3초보다 길게)
- 뷰포트 크기: 2560x1440 (고해상도)

---

## 타임라인 예시

```
00:00.000 - [클라우드서버] 정책표 생성 요청 받음
00:00.100 - [클라우드서버] 명령어 생성: "!screenshot https://..."
00:00.200 - [클라우드서버] 디스코드 채널에 메시지 전송
00:00.300 - [로컬PC봇] 명령어 감지
00:00.400 - [로컬PC봇] 로딩 메시지 전송: "📸 스크린샷 생성 중..."
00:00.500 - [로컬PC봇] Puppeteer 브라우저 시작
00:01.000 - [로컬PC봇] Google Sheets URL로 이동
00:03.500 - [로컬PC봇] 페이지 로딩 완료 (3초 대기)
00:04.000 - [로컬PC봇] 그리드 영역 찾기
00:04.500 - [로컬PC봇] 스크린샷 생성 완료
00:05.000 - [로컬PC봇] 이미지 디스코드 업로드
00:05.200 - [클라우드서버] 봇 응답 메시지 감지
00:05.300 - [클라우드서버] 이미지 URL 추출
00:05.400 - [클라우드서버] 정책표 데이터에 이미지 URL 저장
00:05.500 - [클라우드서버] 정책표 생성 완료
```

**총 소요 시간**: 약 5-6초

---

## 에러 처리 예시

### 케이스 1: Google Sheets URL이 잘못된 경우

**로컬 PC 봇 로그**:
```
❌ [로컬PC봇] 스크린샷 생성 오류: Navigation timeout of 30000 ms exceeded
```

**디스코드 채널**:
```
❌ 스크린샷 생성 실패
오류: Navigation timeout of 30000 ms exceeded
```

**클라우드 서버**:
```
❌ [클라우드서버] 디스코드 봇 응답 시간 초과 (60초)
```

---

### 케이스 2: 로컬 PC 봇이 실행되지 않은 경우

**클라우드 서버 로그**:
```
⏳ [클라우드서버] 로컬 PC 봇의 응답 대기 중... (최대 60초)
❌ [클라우드서버] 디스코드 봇 응답 시간 초과 (60초)
```

**해결 방법**: 로컬 PC에서 봇 실행 확인 (`pm2 status`)

---

### 케이스 3: Chrome이 설치되지 않은 경우

**로컬 PC 봇 로그**:
```
❌ [로컬PC봇] 스크린샷 생성 오류: Could not find Chrome
```

**해결 방법**: 로컬 PC에 Chrome 설치

---

## 디버깅 팁

### 클라우드 서버에서 확인할 것

1. 명령어가 제대로 전송되었는지
2. 봇의 응답 메시지를 받았는지
3. 이미지 URL이 올바르게 추출되었는지

### 로컬 PC 봇에서 확인할 것

1. 명령어를 제대로 감지했는지
2. Google Sheets URL이 올바른지
3. Puppeteer가 정상 작동하는지
4. 이미지가 제대로 생성되었는지
5. 디스코드 업로드가 성공했는지

### 로그 확인 명령어

```bash
# 로컬 PC에서
pm2 logs discord-screenshot-bot --lines 50

# 클라우드 서버에서
# Cloudtype 로그 또는 서버 로그 확인
```

